"use strict";(self.webpackChunkjohnnyreilly_com=self.webpackChunkjohnnyreilly_com||[]).push([[2474],{23048:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>c});var n=s(85893),i=s(11151);const o={slug:"docusaurus-createfeeditems-api-git-commit-date",title:"Docusaurus blogs: using the createFeedItems API with git commit date",authors:"johnnyreilly",tags:["docusaurus"],image:"./title-image.png",description:"The Docusaurus createFeedItems API can be used to tweak RSS feeds for your blog. This post shows how to use it with the git commit date.",hide_table_of_contents:!1},a=void 0,r={permalink:"/docusaurus-createfeeditems-api-git-commit-date",editUrl:"https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2023-01-28-docusaurus-createfeeditems-api-git-commit-date/index.md",source:"@site/blog/2023-01-28-docusaurus-createfeeditems-api-git-commit-date/index.md",title:"Docusaurus blogs: using the createFeedItems API with git commit date",description:"The Docusaurus createFeedItems API can be used to tweak RSS feeds for your blog. This post shows how to use it with the git commit date.",date:"2023-01-28T00:00:00.000Z",formattedDate:"January 28, 2023",tags:[{label:"docusaurus",permalink:"/tags/docusaurus"}],readingTime:5.745,hasTruncateMarker:!0,authors:[{name:"John Reilly",title:"OSS Engineer - TypeScript, Azure, React, Node.js, .NET",url:"https://johnnyreilly.com/about",imageURL:"https://johnnyreilly.com/img/profile.jpg",key:"johnnyreilly"}],frontMatter:{slug:"docusaurus-createfeeditems-api-git-commit-date",title:"Docusaurus blogs: using the createFeedItems API with git commit date",authors:"johnnyreilly",tags:["docusaurus"],image:"./title-image.png",description:"The Docusaurus createFeedItems API can be used to tweak RSS feeds for your blog. This post shows how to use it with the git commit date.",hide_table_of_contents:!1},unlisted:!1,prevItem:{title:"Migrating from GitHub Pages to Azure Static Web Apps",permalink:"/migrating-from-github-pages-to-azure-static-web-apps"},nextItem:{title:"Image Optimisation with the TinyPNG API",permalink:"/image-optimisation-tinypng-api"}},d={image:s(88337).Z,authorsImageUrls:[void 0]},c=[{value:"Updated 27/11/2023 - Docusaurus 3",id:"updated-27112023---docusaurus-3",level:2},{value:"<code>createFeedItems</code> API",id:"createfeeditems-api",level:2},{value:"<code>createFeedItems</code> API usage",id:"createfeeditems-api-usage",level:2},{value:"Our implementation",id:"our-implementation",level:2},{value:"Conclusion",id:"conclusion",level:2}];function l(e){const t={a:"a",code:"code",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",...(0,i.a)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(t.p,{children:["A new API landed in Docusaurus 2.3.0 - it's called ",(0,n.jsx)(t.code,{children:"createFeedItems"}),". It's a great API that allows you to tweak the Atom / RSS / JSON feeds for your blog. This post shows how to use it with the git commit date."]}),"\n",(0,n.jsxs)(t.p,{children:["This post builds upon a technique we've previously used to drive the ",(0,n.jsx)(t.code,{children:"lastmod"})," properties of our sitemap. ",(0,n.jsxs)(t.a,{href:"/adding-lastmod-to-sitemap-git-commit-date",children:["You can read about driving ",(0,n.jsx)(t.code,{children:"lastmod"})," from git commit here"]}),"."]}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"title image reading &quot;Docusaurus: using the createFeedItems API with git commit date&quot; with the Docusaurus logo",src:s(15978).Z+"",width:"800",height:"450",loading:"eager",fetchpriority:"high"})}),"\n",(0,n.jsx)(t.h2,{id:"updated-27112023---docusaurus-3",children:"Updated 27/11/2023 - Docusaurus 3"}),"\n",(0,n.jsx)(t.p,{children:"This post was originally written targetting Docusaurus 2. Now Docusaurus 3 is landing, this post has been updated to cater for Docusaurus 3 usage."}),"\n",(0,n.jsxs)(t.h2,{id:"createfeeditems-api",children:[(0,n.jsx)(t.code,{children:"createFeedItems"})," API"]}),"\n",(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.a,{href:"https://github.com/facebook/docusaurus/pull/8378",children:"I worked on the createFeedItems API for Docusaurus"}),". When the ",(0,n.jsx)(t.a,{href:"https://twitter.com/docusaurus/status/1619019412610191379",children:"feature was announced"}),", there were a number of suggested use cases:"]}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.a,{href:"https://twitter.com/docusaurus/status/1619019412610191379",children:(0,n.jsx)(t.img,{alt:"screenshot of a tweet describing things you could do with the createFeedItems API",src:s(41283).Z+"",width:"589",height:"811",loading:"lazy"})})}),"\n",(0,n.jsx)(t.p,{children:"As someone who worked on the API, you naturally might imagine that I'd have some ideas for how to use it. I do!"}),"\n",(0,n.jsx)(t.p,{children:"There's two particular use cases that I've been thinking about:"}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsx)(t.li,{children:"Trimming the number of feed items"}),"\n",(0,n.jsx)(t.li,{children:"Using the latest git commit date for the feed item date"}),"\n"]}),"\n",(0,n.jsx)(t.p,{children:"The reason I want to trim the number of feed items is because I have written a lot of blog posts. I learned that some RSS readers were choking on the size of my feed and rendering it unusable. So I thought a decent approach would be to trim the number of feed items to a more manageable number."}),"\n",(0,n.jsxs)(t.p,{children:["The second use case is a lot more fun! I want to use the git commit date for the feed item date. Docusaurus uses the date of post itself to drive this by default. You can see this by looking at the ",(0,n.jsx)(t.a,{href:"https://docusaurus.io/blog/atom.xml",children:"Docusaurus atom feed"}),":"]}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"screenshot of Docusaurus atom feed",src:s(27352).Z+"",width:"494",height:"312",loading:"lazy"})}),"\n",(0,n.jsx)(t.p,{children:"That's not a bad default. However, I tend to go back and edit my posts, particularly in the recent weeks after publishing. I don't want the date of the feed item to be the date of the post. I want it to be the date of the most recent commit. That way, if I go back and edit a post, the feed item date will be updated."}),"\n",(0,n.jsx)(t.p,{children:"We're going to implement both of these."}),"\n",(0,n.jsxs)(t.h2,{id:"createfeeditems-api-usage",children:[(0,n.jsx)(t.code,{children:"createFeedItems"})," API usage"]}),"\n",(0,n.jsxs)(t.p,{children:["The ",(0,n.jsx)(t.code,{children:"createFeedItems"})," API is a function that takes a list of feed items and returns a list of feed items. I find looking at code easier than reading about code so let's look at ",(0,n.jsx)(t.a,{href:"https://docusaurus.io/docs/blog#feed",children:"the example code from the docs"}),":"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-js",children:"/** @type {import('@docusaurus/types').Config} */\nconst config = {\n  // ...\n  presets: [\n    [\n      '@docusaurus/preset-classic',\n      {\n        blog: {\n          feedOptions: {\n            type: 'all',\n            copyright: `Copyright \xa9 ${new Date().getFullYear()} Facebook, Inc.`,\n            createFeedItems: async (params) => {\n              const { blogPosts, defaultCreateFeedItems, ...rest } = params;\n              return defaultCreateFeedItems({\n                // keep only the 10 most recent blog posts in the feed\n                blogPosts: blogPosts.filter((item, index) => index < 10),\n                ...rest,\n              });\n            },\n          },\n        },\n      },\n    ],\n  ],\n};\n"})}),"\n",(0,n.jsxs)(t.p,{children:["As we can see - this is a function, which receives a single parameter. That parameter is an object with a number of properties. The most important of these is ",(0,n.jsx)(t.code,{children:"blogPosts"}),". This is a list of blog posts. We can filter this list and return a new list. We can also call ",(0,n.jsx)(t.code,{children:"defaultCreateFeedItems"})," to get the default behaviour. We can then tweak the result of that call."]}),"\n",(0,n.jsxs)(t.p,{children:["Importantly it's an ",(0,n.jsx)(t.code,{children:"async"})," function. This means that we can do async work in it. We're going to use that when we get the git commit date."]}),"\n",(0,n.jsx)(t.h2,{id:"our-implementation",children:"Our implementation"}),"\n",(0,n.jsxs)(t.p,{children:["Now we know how to use the API, let's implement it to handle our use cases. To get the git commit date, we're going to use a package called ",(0,n.jsx)(t.a,{href:"https://github.com/steveukx/git-js",children:(0,n.jsx)(t.code,{children:"simple-git"})}),". We'll add this as a dependency of our Docusaurus project:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"yarn add simple-git\n"})}),"\n",(0,n.jsxs)(t.p,{children:["We're going to create a new file to sit alongside our ",(0,n.jsx)(t.code,{children:"docusaurus.config.js"})," file. We'll call it ",(0,n.jsx)(t.code,{children:"createFeedItems.mjs"})," (as it's an ESM file):"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-js",children:"//@ts-check\nimport path from 'path';\nimport { simpleGit } from 'simple-git';\n\n/** @type {import('@docusaurus/plugin-content-blog').CreateFeedItemsFn} */\nexport async function createFeedItems(params) {\n  const { blogPosts, defaultCreateFeedItems, ...rest } = params;\n\n  const feedItems = await defaultCreateFeedItems({\n    blogPosts,\n    ...rest,\n  });\n\n  for (const feedItem of feedItems) {\n    // blogPost.metadata.permalink: '/2023/01/22/image-optimisation-tinypng-api',\n    // feedItem.link: 'https://johnnyreilly.com/2023/01/22/image-optimisation-tinypng-api',\n    const relatedBlogEntry = blogPosts.find((blogPost) =>\n      feedItem.link.endsWith(blogPost.metadata.permalink),\n    );\n    if (!relatedBlogEntry) {\n      console.log('blogFilePath not found', feedItem.link);\n      throw new Error(`blogFilePath not found ${feedItem.link}`);\n    }\n\n    // source: '@site/blog/2023-01-22-image-optimisation-tinypng-api/index.md',\n    const gitLatestCommitString = await getGitLatestCommitDateFromFilePath(\n      relatedBlogEntry.metadata.source.replace('@site/', 'blog-website/'),\n    );\n    const gitLatestCommitDate = gitLatestCommitString\n      ? new Date(gitLatestCommitString)\n      : undefined;\n    if (gitLatestCommitDate) {\n      feedItem.date = gitLatestCommitDate;\n    }\n  }\n\n  // keep only the 20 most recently updated blog posts in the feed\n  const latest20FeedItems = Array.from(feedItems)\n    .sort((a, b) => b.date.getDate() - a.date.getDate())\n    .slice(0, 20);\n\n  return latest20FeedItems;\n}\n\n/**\n * Given a file path, return the last commit date\n * @param {string} filePath\n * @returns\n */\nasync function getGitLatestCommitDateFromFilePath(filePath) {\n  const git = getSimpleGit();\n\n  const log = await git.log({\n    file: filePath,\n  });\n\n  const latestCommitDate = log.latest?.date;\n\n  return latestCommitDate;\n}\n\n/** @type {import('simple-git').SimpleGit | undefined} */\nlet git;\n\n/**\n * get a simple git instance\n * @returns SimpleGit\n */\nfunction getSimpleGit() {\n  if (!git) {\n    const baseDir = path.resolve(process.cwd(), '..');\n\n    /** @type {Partial<import('simple-git').SimpleGitOptions>} */\n    const options = {\n      baseDir,\n      binary: 'git',\n      maxConcurrentProcesses: 6,\n      trimmed: false,\n    };\n\n    git = simpleGit(options);\n  }\n\n  return git;\n}\n"})}),"\n",(0,n.jsxs)(t.p,{children:["What's happening here? Well, the ",(0,n.jsx)(t.code,{children:"createFeedItems"})," function is taking the blog posts that come in and then calling ",(0,n.jsx)(t.code,{children:"defaultCreateFeedItems"})," to get the default behaviour. We then iterate over the feed items and for each one we find the related blog post. We then use ",(0,n.jsx)(t.code,{children:"simple-git"})," to get the last commit date for the blog post. We then set the feed item's date to the last commit date. We then sort the feed items by date and take the first 20. We then return those 20 feed items."]}),"\n",(0,n.jsxs)(t.p,{children:["It's as simple as that. There's a few bits in there which are specific to my blog (like the ",(0,n.jsx)(t.code,{children:"blog-website"})," directory) but you can see how you can tweak this to suit your needs."]}),"\n",(0,n.jsxs)(t.p,{children:["With this implemented, we'll reference this in our ",(0,n.jsx)(t.code,{children:"docusaurus.config.js"})," file:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-js",children:"//@ts-check\nimport { createFeedItems } from './createFeedItems.mjs';\n\n/** @type {import('@docusaurus/types').Config} */\nconst config = {\n  // ...\n  presets: [\n    [\n      '@docusaurus/preset-classic',\n      /** @type {import('@docusaurus/preset-classic').Options} */\n      ({\n        // ...\n        feedOptions: {\n          // ...\n          createFeedItems,\n          // ...\n        },\n        // ...\n      }),\n    ],\n  ],\n  // ...\n};\n\nexport default config;\n"})}),"\n",(0,n.jsxs)(t.p,{children:["And we're done! We can now run ",(0,n.jsx)(t.code,{children:"yarn build"})," and see the results:"]}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"screenshot of Docusaurus atom feed for johnnyreilly",src:s(27122).Z+"",width:"883",height:"350",loading:"lazy"})}),"\n",(0,n.jsxs)(t.p,{children:["Look for yourself at ",(0,n.jsx)(t.a,{href:"https://johnnyreilly.com/atom.xml",children:"johnnyreilly.com/atom.xml"})," or ",(0,n.jsx)(t.a,{href:"https://johnnyreilly.com/rss.xml",children:"johnnyreilly.com/rss.xml"}),"."]}),"\n",(0,n.jsx)(t.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,n.jsxs)(t.p,{children:["Here we've learned how to use the ",(0,n.jsx)(t.code,{children:"createFeedItems"})," API to customise the feed items that are generated. We've also seen how to use ",(0,n.jsx)(t.code,{children:"simple-git"})," to get the last commit date for a file. We've then used that to set the date of the feed item to the last commit date."]})]})}function h(e={}){const{wrapper:t}={...(0,i.a)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(l,{...e})}):l(e)}},88337:(e,t,s)=>{s.d(t,{Z:()=>n});const n=s.p+"assets/images/title-image-e36109db4972b5cefaee9b5c417a3c39.png"},27352:(e,t,s)=>{s.d(t,{Z:()=>n});const n=s.p+"assets/images/screenshot-docusaurus-atom-feed-8d96893a0377d25aee230d6a0c32cc2a.webp"},27122:(e,t,s)=>{s.d(t,{Z:()=>n});const n=s.p+"assets/images/screenshot-johnnyreilly-atom-feed-e1f421f90437f743937c3ce15e88b718.webp"},41283:(e,t,s)=>{s.d(t,{Z:()=>n});const n=s.p+"assets/images/screenshot-tweet-createfeeditems-b20141fe97f47937eb9f59c63c8402f9.webp"},15978:(e,t,s)=>{s.d(t,{Z:()=>n});const n=s.p+"assets/images/title-image-e36109db4972b5cefaee9b5c417a3c39.png"},11151:(e,t,s)=>{s.d(t,{Z:()=>r,a:()=>a});var n=s(67294);const i={},o=n.createContext(i);function a(e){const t=n.useContext(o);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),n.createElement(o.Provider,{value:t},e.children)}}}]);