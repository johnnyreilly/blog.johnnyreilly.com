"use strict";(self.webpackChunkjohnnyreilly_com=self.webpackChunkjohnnyreilly_com||[]).push([["14039"],{8151:function(e,n,t){t.r(n),t.d(n,{assets:function(){return a},contentTitle:function(){return l},default:function(){return c},frontMatter:function(){return i},metadata:function(){return o},toc:function(){return d}});var o=t(71259),r=t(85893),s=t(50065);let i={slug:"azure-devops-set-user-story-column-api",title:"Azure DevOps API: Set User Story column with the Azure DevOps Client for Node.js",authors:"johnnyreilly",tags:["typescript","azure devops","node.js"],image:"./title-image.png",hide_table_of_contents:!1,description:"It is possible to set the column of a User Story in Azure DevOps with the Azure DevOps Client for Node.js, but the mechanism is surprising."},l=void 0,a={image:t(33374).Z,authorsImageUrls:[void 0]},d=[{value:"Getting the WorkItemTrackingApi",id:"getting-the-workitemtrackingapi",level:2},{value:"Getting the User Story",id:"getting-the-user-story",level:2},{value:"What columns can we set?",id:"what-columns-can-we-set",level:2},{value:"Setting the Column",id:"setting-the-column",level:2}];function u(e){let n={a:"a",blockquote:"blockquote",code:"code",h2:"h2",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.p,{children:["When I attempted to set the column of a User Story in Azure DevOps using the Azure DevOps Client for Node.js, I was surprised to find that the field ",(0,r.jsx)(n.code,{children:"System.BoardColumn"})," was read-only and I bumped into the error:"]}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"TF401326: Invalid field status 'ReadOnly' for field 'System.BoardColumn'."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"title image reading &quot;Azure DevOps API: Set User Story column with the Azure DevOps Client for Node.js&quot; with an Azure DevOps logo",src:t(10346).Z+"",width:"800",height:"450",loading:"eager",fetchpriority:"high"})}),"\n",(0,r.jsxs)(n.p,{children:["This post explains how to set the column of a User Story in Azure DevOps using the Azure DevOps Client for Node.js and it's based in part on a ",(0,r.jsx)(n.a,{href:"https://stackoverflow.com/questions/56165538/how-to-modify-boardcolumn-field-of-a-work-item-using-rest-api",children:"Stack Overflow question"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.a,{href:"https://github.com/microsoft/azure-devops-node-api",children:"Azure DevOps Client for Node.js"})," is a great way to interact with the Azure DevOps API if you're building with TypeScript. The library provides an API and the types. In this post, we'll use the client to set the column of a User Story in Azure DevOps rather than directly working with the API."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"A screenshot of a user story in Azure DevOps",src:t(69565).Z+"",width:"492",height:"402",loading:"lazy"})}),"\n",(0,r.jsx)(n.h2,{id:"getting-the-workitemtrackingapi",children:"Getting the WorkItemTrackingApi"}),"\n",(0,r.jsx)(n.p,{children:"Consider the following code:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import * as nodeApi from 'azure-devops-node-api';\nimport {\n  type WorkItem,\n  WorkItemExpand,\n} from 'azure-devops-node-api/interfaces/WorkItemTrackingInterfaces.js';\nimport type { IWorkItemTrackingApi } from 'azure-devops-node-api/WorkItemTrackingApi.js';\n\n// ...\n\nconst authHandler = pat // If running locally you will use a Personal Access Token\n  ? nodeApi.getPersonalAccessTokenHandler(\n      pat,\n      /** allowCrossOriginAuthentication */ true,\n    )\n  : // If running in Azure DevOps you will use the System.AccessToken\n    nodeApi.getHandlerFromToken(\n      sat,\n      /** allowCrossOriginAuthentication */ true,\n    );\n\nconst webApi = new nodeApi.WebApi(\n  'https://dev.azure.com/johnnyreilly/',\n  authHandler,\n);\nconst workItemTrackingApi = await webApi.getWorkItemTrackingApi();\n"})}),"\n",(0,r.jsxs)(n.p,{children:["This code sets up the Azure DevOps Client for Node.js and gets the ",(0,r.jsx)(n.code,{children:"WorkItemTrackingApi"}),". The ",(0,r.jsx)(n.code,{children:"WorkItemTrackingApi"})," is the API we'll use to set the column of a User Story. You'll need to replace ",(0,r.jsx)(n.code,{children:"pat"})," and ",(0,r.jsx)(n.code,{children:"sat"})," with your Personal Access Token and System Access Token, respectively (depending on where this code executes). And the organisation you use will likely be different from ",(0,r.jsx)(n.code,{children:"johnnyreilly"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"getting-the-user-story",children:"Getting the User Story"}),"\n",(0,r.jsx)(n.p,{children:"We can now load our user story, given its ID:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"const userStory = await workItemTrackingApi.getWorkItem(\n  userStoryId,\n  /** fields */ undefined,\n  /** asOf */ undefined,\n  /** expand */ WorkItemExpand.All,\n);\n"})}),"\n",(0,r.jsxs)(n.p,{children:["This code loads the User Story with the ID ",(0,r.jsx)(n.code,{children:"userStoryId"}),". We're using the ",(0,r.jsx)(n.code,{children:"WorkItemExpand.All"})," option to ensure we get all the fields of the User Story.When you look at the User Story, you'll see that the ",(0,r.jsx)(n.code,{children:"System.BoardColumn"})," field is there. This is the field we want to set, but we can't do it directly. If we try we'll encounter the notorious error:"]}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"TF401326: Invalid field status 'ReadOnly' for field 'System.BoardColumn'."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"However, if you look closely at the User Story you'll see two very similar fields:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'"System.BoardColumn": "Blocked",\n\n// ...\n\n"WEF_1D7E8E9B92454212B8A5E6DFBCED0D17_Kanban.Column": "Blocked",\n'})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"System.BoardColumn"})," field is read-only, but the ",(0,r.jsx)(n.code,{children:"WEF_1D7E8E9B92454212B8A5E6DFBCED0D17_Kanban.Column"})," field is not. This is the field we can set to change the column of the User Story. And that will, in turn, set the ",(0,r.jsx)(n.code,{children:"System.BoardColumn"})," field. Why this is the case is a mystery to me, but it works."]}),"\n",(0,r.jsx)(n.h2,{id:"what-columns-can-we-set",children:"What columns can we set?"}),"\n",(0,r.jsx)(n.p,{children:"This may be more than what you need, but as someone who has bumped into the error:"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"TF401320: Rule Error for field State. Error code: Required, HasValues, LimitedToValues, SetByRule, InvalidEmpty."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"You might want to know what columns you can set, in order that you can avoid this error happening. Or at least you might want to know what columns you can set so that you can provide a helpful error message to the user. Here's how you can get the columns for a board:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"const workApi = await webApi.getWorkApi();\n\nconst columns = await workApi.getBoardColumns(\n  {\n    project: 'my-project',\n    team: 'my-team',\n  },\n  'Stories',\n);\n\nconst validColumns = columns\n  .map((column) => column.name ?? '')\n  .filter((name) => name);\n"})}),"\n",(0,r.jsx)(n.p,{children:"This is optional, but I've found it useful."}),"\n",(0,r.jsx)(n.h2,{id:"setting-the-column",children:"Setting the Column"}),"\n",(0,r.jsx)(n.p,{children:"With all that taken care of, we can now set the column of the User Story with this code:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"async function updateUserStoryColumn({\n  userStory,\n  workItemTrackingApi,\n  columnName,\n  validColumns,\n  whatIf,\n}: {\n  userStory: WorkItem;\n  workItemTrackingApi: IWorkItemTrackingApi;\n  columnName: string;\n  validColumns: string[];\n  whatIf: boolean;\n}) {\n  const isAValidColumn = validColumns.includes(columnName);\n  if (!isAValidColumn) {\n    throw new Error(\n      `We cannot move a User Story to the column \"${columnName}\"; these are the columns that a User Story can be moved to: ${validColumns.map((column) => `\"${column}\"`).join(', ')}`,\n    );\n  }\n\n  if (!userStory.fields) {\n    throw new Error('No fields found');\n  }\n\n  // We are looking for a field like this:\n  // 'WEF_1D7E8E9B92454212B8A5E6DFBCED0D17_Kanban.Column': 'In-Progress',\n\n  const wefField = [...Object.entries(userStory?.fields)].find(\n    ([fieldName, _value]) => fieldName.includes('_Kanban.Column'),\n  );\n\n  if (!wefField) {\n    throw new Error('No WEF field found');\n  }\n  const fieldToUpdate = wefField[0];\n\n  // Define the update\n  const patchDocument = [\n    {\n      op: 'add', // surprisingly, this is the operation for updating a field - see https://learn.microsoft.com/en-us/rest/api/azure/devops/wit/work-items/update?view=azure-devops-rest-7.1&tabs=HTTP#update-a-field\n      path: `/fields/${fieldToUpdate}`,\n      value: columnName,\n    },\n    // COMMENTED OUT AS WILL NEVER WORK - LEFT FOR ILLUSTRATION\n    // {\n    //     op: \"add\",\n    //     path: `/fields/System.BoardColumn`,\n    //     value: columnName,\n    // },\n  ];\n\n  try {\n    if (whatIf) {\n      console.log(\n        `Would update User Story ${userStory.id} to column ${columnName}`,\n        patchDocument,\n      );\n      return;\n    }\n\n    // Update the work item\n    const updatedWorkItem = await workItemTrackingApi.updateWorkItem(\n      /** customHeaders */ undefined,\n      /** document */ patchDocument,\n      /** id */ userStory.id!,\n    );\n    console.log(`User Story ${updatedWorkItem.id} moved to ${columnName}`);\n  } catch (err) {\n    console.error(\n      `Error moving User Story ${userStory.id} to ${columnName}`,\n      err,\n    );\n  }\n}\n\nawait updateUserStoryColumn({\n  userStory,\n  workItemTrackingApi,\n  columnName: 'Prioritised',\n  validColumns,\n  whatIf: false,\n});\n"})}),"\n",(0,r.jsx)(n.p,{children:"The code above:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Checks that the column we want to move the User Story to is a valid column."}),"\n",(0,r.jsxs)(n.li,{children:["Finds the curiously named ",(0,r.jsx)(n.code,{children:"WEF_1D7E8E9B92454212B8A5E6DFBCED0D17_Kanban.Column"})," style field we need to update, purely by looking for a field that contains ",(0,r.jsx)(n.code,{children:"_Kanban.Column"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Defines the update using the ",(0,r.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/rest/api/azure/devops/wit/work-items/update?view=azure-devops-rest-7.1&tabs=HTTP#update-a-field",children:"mechanism documented here"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Updates the User Story."}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["You can also see there's a ",(0,r.jsx)(n.code,{children:"whatIf"})," option. If you set this to ",(0,r.jsx)(n.code,{children:"true"}),", the code will log what it would do without actually doing it. This is useful for testing."]}),"\n",(0,r.jsx)(n.p,{children:"And this mechanism works - the User Story is moved to the column you specify as desired."})]})}function c(e={}){let{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(u,{...e})}):u(e)}},33374:function(e,n,t){t.d(n,{Z:function(){return o}});let o=t.p+"assets/images/title-image-295933715c6803390e6d8ed282e77f0a.png"},69565:function(e,n,t){t.d(n,{Z:function(){return o}});let o=t.p+"assets/images/screenshot-azure-devops-column-c3309929828f810e7f0ef31b304905b6.webp"},10346:function(e,n,t){t.d(n,{Z:function(){return o}});let o=t.p+"assets/images/title-image-295933715c6803390e6d8ed282e77f0a.png"},50065:function(e,n,t){t.d(n,{Z:function(){return l},a:function(){return i}});var o=t(67294);let r={},s=o.createContext(r);function i(e){let n=o.useContext(s);return o.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),o.createElement(s.Provider,{value:n},e.children)}},71259:function(e){e.exports=JSON.parse('{"permalink":"/azure-devops-set-user-story-column-api","editUrl":"https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2024-11-01-azure-devops-set-user-story-column-api/index.md","source":"@site/blog/2024-11-01-azure-devops-set-user-story-column-api/index.md","title":"Azure DevOps API: Set User Story column with the Azure DevOps Client for Node.js","description":"It is possible to set the column of a User Story in Azure DevOps with the Azure DevOps Client for Node.js, but the mechanism is surprising.","date":"2024-11-01T00:00:00.000Z","tags":[{"inline":false,"label":"TypeScript","permalink":"/tags/typescript","description":"The TypeScript programming language."},{"inline":false,"label":"Azure DevOps","permalink":"/tags/azure-devops","description":"The Azure DevOps suite of tools."},{"inline":false,"label":"Node.js","permalink":"/tags/node-js","description":"The Node.js runtime."}],"readingTime":4.925,"hasTruncateMarker":true,"authors":[{"name":"John Reilly","title":"OSS Engineer - TypeScript, Azure, React, Node.js, .NET","url":"https://johnnyreilly.com/about","imageURL":"https://johnnyreilly.com/img/profile.jpg","key":"johnnyreilly","page":null}],"frontMatter":{"slug":"azure-devops-set-user-story-column-api","title":"Azure DevOps API: Set User Story column with the Azure DevOps Client for Node.js","authors":"johnnyreilly","tags":["typescript","azure devops","node.js"],"image":"./title-image.png","hide_table_of_contents":false,"description":"It is possible to set the column of a User Story in Azure DevOps with the Azure DevOps Client for Node.js, but the mechanism is surprising."},"unlisted":false,"prevItem":{"title":"Introducing azdo-npm-auth (Azure DevOps npm auth)","permalink":"/introducing-azdo-npm-auth"},"nextItem":{"title":"module ws does not provide an export named WebSocketServer","permalink":"/module-ws-does-not-provide-an-export-named-websocketserver"}}')}}]);