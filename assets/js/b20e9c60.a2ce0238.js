"use strict";(self.webpackChunkjohnnyreilly_com=self.webpackChunkjohnnyreilly_com||[]).push([[25436],{4294:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/title-image-09b4aad04d867b07bb095e561694e59d.png"},28091:e=>{e.exports=JSON.parse('{"permalink":"/nodejs-azure-appinsights-fastify","editUrl":"https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2025-02-17-nodejs-azure-appinsights-fastify/index.md","source":"@site/blog/2025-02-17-nodejs-azure-appinsights-fastify/index.md","title":"Node.js, Azure Application Insights, and Fastify","description":"Learn how to set up a Node.js with Azure Application Insights and Fastify.","date":"2025-02-17T00:00:00.000Z","tags":[{"inline":false,"label":"Azure","permalink":"/tags/azure","description":"The Microsoft cloud platform."},{"inline":false,"label":"Node.js","permalink":"/tags/node-js","description":"The Node.js runtime."},{"inline":false,"label":"TypeScript","permalink":"/tags/typescript","description":"The TypeScript programming language."}],"readingTime":4.7,"hasTruncateMarker":true,"authors":[{"name":"John Reilly","title":"OSS Engineer - TypeScript, Azure, React, Node.js, .NET","url":"https://johnnyreilly.com/about","imageURL":"https://johnnyreilly.com/img/profile-2025.jpg","key":"johnnyreilly","page":null}],"frontMatter":{"slug":"nodejs-azure-appinsights-fastify","title":"Node.js, Azure Application Insights, and Fastify","authors":"johnnyreilly","tags":["azure","node.js","typescript"],"image":"./title-image.png","hide_table_of_contents":false,"description":"Learn how to set up a Node.js with Azure Application Insights and Fastify."},"unlisted":false,"prevItem":{"title":"Static Web Apps CLI: local authentication emulation with ASP.NET","permalink":"/static-web-apps-cli-local-auth-emulator-with-dotnet-authentication"},"nextItem":{"title":"Get Service Connections with the Azure DevOps API (REST and TypeScript)","permalink":"/get-service-connections-with-azure-devops-api"}}')},28453:(e,t,n)=>{n.d(t,{R:()=>a,x:()=>r});var s=n(96540);const i={},o=s.createContext(i);function a(e){const t=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),s.createElement(o.Provider,{value:t},e.children)}},70284:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>p,frontMatter:()=>a,metadata:()=>s,toc:()=>c});var s=n(28091),i=n(74848),o=n(28453);const a={slug:"nodejs-azure-appinsights-fastify",title:"Node.js, Azure Application Insights, and Fastify",authors:"johnnyreilly",tags:["azure","node.js","typescript"],image:"./title-image.png",hide_table_of_contents:!1,description:"Learn how to set up a Node.js with Azure Application Insights and Fastify."},r=void 0,l={image:n(4294).A,authorsImageUrls:[void 0]},c=[{value:"Setting up Azure Application Insights with Node.js",id:"setting-up-azure-application-insights-with-nodejs",level:2},{value:"Setting up Fastify with Azure Application Insights",id:"setting-up-fastify-with-azure-application-insights",level:2},{value:"Conclusion",id:"conclusion",level:2}];function h(e){const t={a:"a",blockquote:"blockquote",code:"code",em:"em",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.p,{children:"If you deploy a Node.js application to Azure, you might want to use Azure Application Insights to monitor it. This post shows you how to set up a Node.js application with Azure Application Insights. It also includes a Fastify plugin to automatically track requests. (Given the out of the box mechanism for tracking requests does not work with Fastify.)"}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"title image reading &quot;Node.js, Azure Application Insights, and Fastify&quot; with the relevant logos",src:n(84297).A+"",width:"800",height:"450",loading:"eager",fetchpriority:"high"})}),"\n",(0,i.jsx)(t.p,{children:"This is one of those posts that gathers together information I found doing research and puts it in one place."}),"\n",(0,i.jsx)(t.h2,{id:"setting-up-azure-application-insights-with-nodejs",children:"Setting up Azure Application Insights with Node.js"}),"\n",(0,i.jsxs)(t.p,{children:["Setting up Azure Application Insights with Node.js is straightforward. You need to install the ",(0,i.jsx)(t.a,{href:"https://github.com/microsoft/ApplicationInsights-node.js",children:(0,i.jsx)(t.code,{children:"applicationinsights"})})," package which integrates Node.js and Azure Application Insights:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sh",children:"npm install applicationinsights --save\n"})}),"\n",(0,i.jsx)(t.p,{children:"Then configure it with your connection string. You want to do this as early as possible when your application starts, so if there are issues, you know as soon as possible. Here's how you can do this:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-ts",children:"import appInsights from 'applicationinsights';\n\nlet client: appInsights.TelemetryClient | undefined;\n\nif (process.env.APPLICATIONINSIGHTS_CONNECTION_STRING) {\n  // https://github.com/microsoft/applicationinsights-node.js?tab=readme-ov-file#configuration\n  appInsights\n    .setup(process.env.APPLICATIONINSIGHTS_CONNECTION_STRING)\n    .setAutoCollectRequests(true)\n    .setAutoCollectPerformance(true, true)\n    .setAutoCollectExceptions(true)\n    .setAutoCollectDependencies(true)\n    .setAutoCollectConsole(true, true) // this will enable console logging\n    .setAutoCollectPreAggregatedMetrics(true)\n    .setSendLiveMetrics(false)\n    .setInternalLogging(false, true)\n    .enableWebInstrumentation(false)\n    .start();\n\n  client = appInsights.defaultClient;\n}\n"})}),"\n",(0,i.jsx)(t.p,{children:"The above code does two things of interest:"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:["It sets up Azure Application Insights with the connection string you provide. For Node.js applications, the connection string tends to be stored in the environment variable ",(0,i.jsx)(t.code,{children:"APPLICATIONINSIGHTS_CONNECTION_STRING"})," and I see no reason to deviate from that."]}),"\n",(0,i.jsxs)(t.li,{children:["It configures the telemetry client to collect various types of telemetry data. You can see the full list of options ",(0,i.jsx)(t.a,{href:"https://github.com/microsoft/applicationinsights-node.js?tab=readme-ov-file#configuration",children:"here"}),". In the example above, all the defaults are used with one exception. That exception is ",(0,i.jsx)(t.code,{children:"setAutoCollectConsole(true, true)"})," which enables console logging. This is in response to this part of the docs:"]}),"\n"]}),"\n",(0,i.jsxs)(t.blockquote,{children:["\n",(0,i.jsxs)(t.p,{children:["Note that by default ",(0,i.jsx)(t.code,{children:"setAutoCollectConsole"})," is configured to ",(0,i.jsx)(t.em,{children:"exclude"})," calls to ",(0,i.jsx)(t.code,{children:"console.log"}),"\n(and other ",(0,i.jsx)(t.code,{children:"console"})," methods). By default, only calls to supported third-party loggers\n(e.g. ",(0,i.jsx)(t.code,{children:"winston"}),", ",(0,i.jsx)(t.code,{children:"bunyan"}),") will be collected. You can change this behavior to ",(0,i.jsx)(t.em,{children:"include"})," calls\nto ",(0,i.jsx)(t.code,{children:"console"})," methods by using ",(0,i.jsx)(t.code,{children:"setAutoCollectConsole(true, true)"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["I'm not using a third-party logger in this example, so I want to include calls to ",(0,i.jsx)(t.code,{children:"console"})," methods."]}),"\n",(0,i.jsx)(t.h2,{id:"setting-up-fastify-with-azure-application-insights",children:"Setting up Fastify with Azure Application Insights"}),"\n",(0,i.jsxs)(t.p,{children:["If you're not a ",(0,i.jsx)(t.a,{href:"https://fastify.dev/",children:"Fastify"})," user you can stop here. But if you are a Fastify user, you may have discovered that ",(0,i.jsx)(t.code,{children:"setAutoCollectRequests"})," appears not to be be working. There's a ",(0,i.jsx)(t.a,{href:"https://github.com/microsoft/ApplicationInsights-node.js/issues/627",children:"GitHub issue to track this"}),", but no discernible sign that it's going to be fixed soon. So, I've created a Fastify plugin to track requests manually based upon ",(0,i.jsx)(t.a,{href:"https://github.com/microsoft/ApplicationInsights-node.js/issues/627#issuecomment-2194527018",children:"@stefanpeer's comment"}),":"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-ts",children:"import { FastifyInstance, FastifyPluginOptions } from 'fastify';\nimport fp from 'fastify-plugin';\nimport appInsights from 'applicationinsights';\n\ndeclare module 'fastify' {\n  export interface FastifyRequest {\n    // here we augment FastifyRequest interface as advised here: https://fastify.dev/docs/latest/Reference/Hooks/#using-hooks-to-inject-custom-properties\n    app: { start: number };\n  }\n}\n\n// based on https://github.com/microsoft/ApplicationInsights-node.js/issues/627#issuecomment-2194527018\nexport const appInsightsPlugin = fp(\n  async (fastify: FastifyInstance, options: FastifyPluginOptions) => {\n    if (!options.client) {\n      console.log('App Insights not configured');\n      return;\n    }\n\n    const client: appInsights.TelemetryClient = options.client;\n    const urlsToIgnore = options.urlsToIgnore || [];\n\n    fastify.addHook(\n      'onRequest',\n      async function (this: FastifyInstance, request, _reply) {\n        // store the start time of the request\n        const start = Date.now();\n        request.app = { start };\n      },\n    );\n\n    fastify.addHook(\n      'onResponse',\n      async function (this: FastifyInstance, request, reply) {\n        if (urlsToIgnore.includes(request.raw.url)) return;\n\n        const duration = Date.now() - request.app.start;\n        client.trackRequest({\n          name: request.raw.method + ' ' + request.raw.url,\n          url: request.raw.url,\n          duration: duration,\n          resultCode: reply.statusCode.toString(),\n          success: reply.statusCode < 400,\n          properties: {\n            method: request.raw.method,\n            url: request.raw.url,\n          },\n          measurements: {\n            duration: duration,\n          },\n        });\n      },\n    );\n  },\n);\n"})}),"\n",(0,i.jsx)(t.p,{children:"The above code creates a Fastify plugin that tracks requests manually. It does this by adding two hooks to Fastify:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"onRequest"})," - This hook stores the start time of the request."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"onResponse"})," - This hook calculates the duration of the request and sends it to Azure Application Insights."]}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["It also includes an ",(0,i.jsx)(t.code,{children:"urlsToIgnore"})," option. This is an array of URLs that you don't want to track. For example, you might not want to track requests to the root of your application. You can pass this option when you register the plugin."]}),"\n",(0,i.jsxs)(t.p,{children:["To make the code play nicely with TypeScript, we augment the ",(0,i.jsx)(t.code,{children:"FastifyRequest"})," interface to include a ",(0,i.jsx)(t.code,{children:"start"})," property. This is where we store the start time of the request that we supply to the ",(0,i.jsx)(t.code,{children:"onResponse"})," hook and read from the ",(0,i.jsx)(t.code,{children:"onRequest"})," hook to calculate the duration of the request."]}),"\n",(0,i.jsx)(t.p,{children:"To consume the plugin in a Fastify application, you can do something like this:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-ts",children:"import appInsights from 'applicationinsights';\nimport Fastify, { FastifyInstance } from 'fastify';\n\nimport { appInsightsPlugin } from './appInsightsPlugin.js';\n\nlet client: appInsights.TelemetryClient | undefined;\n\nif (process.env.APPLICATIONINSIGHTS_CONNECTION_STRING) {\n  // https://github.com/microsoft/applicationinsights-node.js?tab=readme-ov-file#configuration\n  appInsights\n    .setup(process.env.APPLICATIONINSIGHTS_CONNECTION_STRING)\n    .setAutoCollectRequests(true)\n    .setAutoCollectPerformance(true, true)\n    .setAutoCollectExceptions(true)\n    .setAutoCollectDependencies(true)\n    .setAutoCollectConsole(true, true) // this will enable console logging\n    .setAutoCollectPreAggregatedMetrics(true)\n    .setSendLiveMetrics(false)\n    .setInternalLogging(false, true)\n    .enableWebInstrumentation(false)\n    .start();\n\n  client = appInsights.defaultClient;\n}\n\nexport const fastify: FastifyInstance = Fastify({\n  logger: true,\n});\n\nfastify.register(appInsightsPlugin, { client, urlsToIgnore: ['/'] });\n"})}),"\n",(0,i.jsxs)(t.p,{children:["This both sets up Azure Application Insights and registers the Fastify plugin. The ",(0,i.jsx)(t.code,{children:"urlsToIgnore"})," option is set to ",(0,i.jsx)(t.code,{children:"['/']"})," which means that requests to the root of the application will not be tracked."]}),"\n",(0,i.jsx)(t.p,{children:"With this in place you'll see traffic in Azure Application Insights:"}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"Screenshot of requests showing up in Application Insights",src:n(85948).A+"",width:"835",height:"588",loading:"lazy"})}),"\n",(0,i.jsx)(t.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,i.jsx)(t.p,{children:"Using Azure Application Insights with Node.js is straightforward. However, if you're using Fastify, you'll need to track requests manually. This post shows you how to do that with a Fastify plugin. I hope you find it useful!"})]})}function p(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},84297:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/title-image-09b4aad04d867b07bb095e561694e59d.png"},85948:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/screenshot-app-insights-requests-9ec422c7488951e303c5f5d1b4aab056.png"}}]);