"use strict";(self.webpackChunkjohnnyreilly_com=self.webpackChunkjohnnyreilly_com||[]).push([[29798],{28453:(e,n,i)=>{i.d(n,{R:()=>s,x:()=>r});var t=i(96540);const a={},o=t.createContext(a);function s(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),t.createElement(o.Provider,{value:n},e.children)}},46922:(e,n,i)=>{i.d(n,{A:()=>t});const t=i.p+"assets/images/title-image-99eeb529f7c75744d9f6863f82b04880.png"},74065:(e,n,i)=>{i.d(n,{A:()=>t});const t=i.p+"assets/images/title-image-99eeb529f7c75744d9f6863f82b04880.png"},82183:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>p,contentTitle:()=>r,default:()=>l,frontMatter:()=>s,metadata:()=>t,toc:()=>c});var t=i(92113),a=i(74848),o=i(28453);const s={slug:"azure-container-apps-bicep-managed-certificates-custom-domains",title:"Azure Container Apps, Bicep, managed certificates and custom domains",authors:"johnnyreilly",tags:["azure container apps","bicep"],image:"./title-image.png",description:"Azure Container Apps support managed certificates and custom domains. However, deploying them with Bicep is not straightforward. This post explains how to do it.",hide_table_of_contents:!1},r=void 0,p={image:i(74065).A,authorsImageUrls:[void 0]},c=[{value:"Updated 08/11/2025 - with <code>bindingType: &#39;Auto&#39;</code> you can deploy in one go",id:"updated-08112025---with-bindingtype-auto-you-can-deploy-in-one-go",level:2},{value:"<code>azd deploy</code> with Microsoft.App containerApps 2025-07-01",id:"azd-deploy-with-microsoftapp-containerapps-2025-07-01",level:3},{value:"The dreaded message",id:"the-dreaded-message",level:2}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",img:"img",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.p,{children:"Azure Container Apps support managed certificates and custom domains. However, deploying them with Bicep is not straightforward - although it is possible. It seems likely there's a bug in the implementation in Azure, but I'm not sure. Either way, it's possible to deploy managed certificates and custom domains using Bicep. You just need to know how."}),"\n",(0,a.jsxs)(n.p,{children:['If, instead, you\'re looking to make use of the "bring your own certificates" approach in Azure Container Apps using Bicep, then you might want to take a look at ',(0,a.jsx)(n.a,{href:"/azure-container-apps-bicep-bring-your-own-certificates-custom-domains",children:"this post on the topic"}),"."]}),"\n",(0,a.jsxs)(n.h2,{id:"updated-08112025---with-bindingtype-auto-you-can-deploy-in-one-go",children:["Updated 08/11/2025 - with ",(0,a.jsx)(n.code,{children:"bindingType: 'Auto'"})," you can deploy in one go"]}),"\n",(0,a.jsxs)(n.p,{children:["Since originally writing this post, the ",(0,a.jsx)(n.a,{href:"https://github.com/microsoft/azure-container-apps/issues/796",children:"need to use multiple pipeline runs to deploy has been resolved"}),". It is now possible to deploy managed certificates and custom domains to Azure Container Apps using a single Bicep deployment. To do that you'll need to use the ",(0,a.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/templates/microsoft.app/2025-07-01/containerapps?pivots=deployment-language-bicep",children:"Microsoft.App containerApps 2025-07-01"})," API version (or newer)."]}),"\n",(0,a.jsxs)(n.p,{children:["That API version introduced the ability to create a managed certificate resource without needing to first create a disabled custom domain on the container app. This means you can now do it all in one go. This is achieved with the use of a new ",(0,a.jsx)(n.code,{children:"bindingType"})," value of ",(0,a.jsx)(n.code,{children:"Auto"})," on the ",(0,a.jsx)(n.code,{children:"customDomains"})," property."]}),"\n",(0,a.jsx)(n.p,{children:"Using the new approach, the Bicep required to create a managed certificate and custom domain looks like this:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bicep",children:"resource containerApp 'Microsoft.App/containerApps@2025-07-01' = {\n  //...\n  properties: {\n    configuration: {\n      //...\n      ingress: {\n        //...\n        customDomains: empty(customDomainName) ? [] : [\n          {\n            name: customDomainName\n            bindingType: 'Auto'\n          }\n        ]\n        //...\n      }\n      //...\n    }\n    //...\n  }\n  //...\n}\n\nresource managedEnvironmentManagedCertificate 'Microsoft.App/managedEnvironments/managedCertificates@2025-07-01' = if (!empty(customDomainName)) {\n  parent: managedEnvironment\n  name: '${managedEnvironment.name}-cert'\n  location: location\n  tags: tags\n  properties: {\n    subjectName: customDomainName\n    domainControlValidation: 'CNAME'\n  }\n  dependsOn: [\n    containerApp\n  ]\n}\n"})}),"\n",(0,a.jsxs)(n.h3,{id:"azd-deploy-with-microsoftapp-containerapps-2025-07-01",children:[(0,a.jsx)(n.code,{children:"azd deploy"})," with Microsoft.App containerApps 2025-07-01"]}),"\n",(0,a.jsxs)(n.p,{children:["If you're using ",(0,a.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/developer/azure-developer-cli/overview",children:"Azure Developer CLI (azd)"})," to deploy your Azure Container Apps, as described in ",(0,a.jsx)(n.a,{href:"/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops",children:"this post"}),", then you'll find that an issue can present when you try to deploy the custom domain and managed certificate using the ",(0,a.jsx)(n.code,{children:"Microsoft.App/containerApps@2025-07-01"})," API version."]}),"\n",(0,a.jsxs)(n.p,{children:["The following error shows up when using ",(0,a.jsx)(n.code,{children:"azd deploy"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"ERROR: failed deploying service 'app': updating container app service: getting container app: getting container app: unmarshalling type *armappcontainers.ContainerApp: unmarshalling type *armappcontainers.ContainerApp: struct field Properties: unmarshalling type *armappcontainers.ContainerAppProperties: struct field Configuration: unmarshalling type *armappcontainers.Configuration: struct field Ingress: unmarshalling type *armappcontainers.Ingress: struct field CustomDomains: unmarshalling type *armappcontainers.CustomDomain: struct field BindingType: json: cannot unmarshal number into Go value of type armappcontainers.BindingType\nSuggestion: set 'apiVersion' on your service in azure.yaml to match the API version in your IaC:\n\nservices:\n  your-service:\n    apiVersion: 2025-02-02-preview\n"})}),"\n",(0,a.jsxs)(n.p,{children:["In fairness, this is a quite helpful error message. It suggests that you can resolve it by specifying the API version in your ",(0,a.jsx)(n.code,{children:"azure.yaml"})," file like so:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json\n\nname: my-container-app\nmetadata:\n  template: azd-init@1.9.4\nservices:\n  app:\n    image: myregistry.azurecr.io/${CONTAINER_IMAGE_NAME}:${APP_VERSION_TAG}\n    host: containerapp\n    resourceName: ${CONTAINER_APP_NAME}\n    apiVersion: 2025-07-01\n"})}),"\n",(0,a.jsxs)(n.p,{children:["With this in place, ",(0,a.jsx)(n.code,{children:"azd deploy"})," will work as expected. Hopefully one day, supplying the API version in ",(0,a.jsx)(n.code,{children:"azure.yaml"})," won't be necessary. I've raised an issue about this ",(0,a.jsx)(n.a,{href:"https://github.com/Azure/azure-dev/issues/6092",children:"here"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["Anyway, if for some reason you can't use the ",(0,a.jsx)(n.code,{children:"Microsoft.App/containerApps@2025-07-01"})," API version, then you can still use the three pipeline approach described below. Back to the original post..."]}),"\n",(0,a.jsx)(n.h2,{id:"the-dreaded-message",children:"The dreaded message"}),"\n",(0,a.jsx)(n.p,{children:"I've facetiously subtitled this post \"a three pipe(line) problem\" because it took three Azure Pipelines to get it working. This is not Azure Pipelines specific though, it's just that I was using Azure Pipelines to deploy the Bicep. Really, this applies to any way of deploying Bicep. GitHub Actions, Azure CLI or whatever."}),"\n",(0,a.jsx)(n.p,{children:"If you're here because you've encountered the dreaded message:"}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.code,{children:"Creating managed certificate requires hostname '....' added as a custom hostname to a container app in environment 'caenv-appname-dev'"})}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Then you're in the right place. I'm going to explain how to get past that error message and get your custom domain working with your Azure Container App whilst still using Bicep. It's going to get ugly. But it will work."}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"title image reading &quot;Azure Container Apps, Bicep, managed certificates and custom domains&quot; with the Azure Container App logos",src:i(46922).A+"",width:"800",height:"450",loading:"lazy"})})]})}function l(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},92113:e=>{e.exports=JSON.parse('{"permalink":"/azure-container-apps-bicep-managed-certificates-custom-domains","editUrl":"https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2023-06-18-azure-container-apps-bicep-managed-certificates-custom-domains/index.md","source":"@site/blog/2023-06-18-azure-container-apps-bicep-managed-certificates-custom-domains/index.md","title":"Azure Container Apps, Bicep, managed certificates and custom domains","description":"Azure Container Apps support managed certificates and custom domains. However, deploying them with Bicep is not straightforward. This post explains how to do it.","date":"2023-06-18T00:00:00.000Z","tags":[{"inline":false,"label":"Azure Container Apps","permalink":"/tags/azure-container-apps","description":"The Azure Container Apps service. Effectively a managed Kubernetes service."},{"inline":false,"label":"Bicep","permalink":"/tags/bicep","description":"The Bicep language for Azure Resource Manager templates."}],"readingTime":8.76,"hasTruncateMarker":true,"authors":[{"name":"John Reilly","title":"OSS Engineer - TypeScript, Azure, React, Node.js, .NET","url":"https://johnnyreilly.com/about","imageURL":"https://johnnyreilly.com/img/profile-2025.jpg","key":"johnnyreilly","page":null}],"frontMatter":{"slug":"azure-container-apps-bicep-managed-certificates-custom-domains","title":"Azure Container Apps, Bicep, managed certificates and custom domains","authors":"johnnyreilly","tags":["azure container apps","bicep"],"image":"./title-image.png","description":"Azure Container Apps support managed certificates and custom domains. However, deploying them with Bicep is not straightforward. This post explains how to do it.","hide_table_of_contents":false},"unlisted":false,"prevItem":{"title":"TypeScript 5.1: declaring JSX element types","permalink":"/typescript-5-1-declaring-jsx-element-types"},"nextItem":{"title":"Azure Container Apps, Easy Auth and .NET authentication","permalink":"/azure-container-apps-easy-auth-and-dotnet-authentication"}}')}}]);