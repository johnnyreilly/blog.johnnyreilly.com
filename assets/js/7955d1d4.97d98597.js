"use strict";(self.webpackChunkjohnnyreilly_com=self.webpackChunkjohnnyreilly_com||[]).push([[25568],{28453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>r});var o=t(96540);const s={},i=o.createContext(s);function a(e){const n=o.useContext(i);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),o.createElement(i.Provider,{value:n},e.children)}},28823:(e,n,t)=>{t.d(n,{A:()=>o});const o=t.p+"assets/images/title-image-44858975d62999ba0013697b9d10be4f.png"},53297:e=>{e.exports=JSON.parse('{"permalink":"/node-18-axios-and-unsafe-legacy-renegotiation-disabled","editUrl":"https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2023-03-09-node-18-axios-and-unsafe-legacy-renegotiation-disabled/index.md","source":"@site/blog/2023-03-09-node-18-axios-and-unsafe-legacy-renegotiation-disabled/index.md","title":"Node.js 18, Axios and unsafe legacy renegotiation disabled","description":"With Node.js 18, unsafe TLS legacy renegotiation was disabled. Some APIs still need it and SSL inspection can downgrade TLS. This post shows an Axios workaround.","date":"2023-03-09T00:00:00.000Z","tags":[{"inline":false,"label":"Node.js","permalink":"/tags/node-js","description":"The Node.js runtime."}],"readingTime":3.18,"hasTruncateMarker":true,"authors":[{"name":"John Reilly","title":"OSS Engineer - TypeScript, Azure, React, Node.js, .NET","url":"https://johnnyreilly.com/about","imageURL":"https://johnnyreilly.com/img/profile-2025.jpg","key":"johnnyreilly","page":null}],"frontMatter":{"slug":"node-18-axios-and-unsafe-legacy-renegotiation-disabled","title":"Node.js 18, Axios and unsafe legacy renegotiation disabled","authors":"johnnyreilly","tags":["node.js"],"image":"./title-image.png","description":"With Node.js 18, unsafe TLS legacy renegotiation was disabled. Some APIs still need it and SSL inspection can downgrade TLS. This post shows an Axios workaround.","hide_table_of_contents":false},"unlisted":false,"prevItem":{"title":"Migrating from ts-node to Bun","permalink":"/migrating-from-ts-node-to-bun"},"nextItem":{"title":"In defence of pull requests","permalink":"/in-defence-of-pull-requests"}}')},58735:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>c,frontMatter:()=>a,metadata:()=>o,toc:()=>d});var o=t(53297),s=t(74848),i=t(28453);const a={slug:"node-18-axios-and-unsafe-legacy-renegotiation-disabled",title:"Node.js 18, Axios and unsafe legacy renegotiation disabled",authors:"johnnyreilly",tags:["node.js"],image:"./title-image.png",description:"With Node.js 18, unsafe TLS legacy renegotiation was disabled. Some APIs still need it and SSL inspection can downgrade TLS. This post shows an Axios workaround.",hide_table_of_contents:!1},r=void 0,l={image:t(28823).A,authorsImageUrls:[void 0]},d=[{value:"The error",id:"the-error",level:2},{value:"Why does this happen?",id:"why-does-this-happen",level:2},{value:"Working around the issue",id:"working-around-the-issue",level:2},{value:"Summary",id:"summary",level:2}];function h(e){const n={a:"a",code:"code",h2:"h2",img:"img",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.p,{children:["Node.js 18 doesn't allow legacy TLS renegotion by default. But some APIs still need it. Also, corporate network traffic network is often subject to SSL inspection and that can manifest as a downgrade in TLS negotiation. ",(0,s.jsx)(n.a,{href:"https://docs.paloaltonetworks.com/pan-os/9-1/pan-os-admin/decryption/configure-ssl-inbound-inspection",children:"Palo Alto Networks SSL Inbound Inspection is an example of an SSL inspector that can downgrade TLS"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"This post shows how to support work around this issue with Axios."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"title image reading &quot;Node.js 18, Axios and unsafe legacy renegotiation disabled&quot; and Axios / Node.js logos",src:t(92652).A+"",width:"800",height:"450",loading:"lazy"})}),"\n",(0,s.jsx)(n.h2,{id:"the-error",children:"The error"}),"\n",(0,s.jsx)(n.p,{children:"If you have code that uses Node.js and Axios, you may have encountered this error when you upgraded to Node.js 18:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"EPROTO B8150000:error:0A000152:SSL routines:final_renegotiate:unsafe legacy renegotiation disabled\n"})}),"\n",(0,s.jsx)(n.p,{children:"or if you're using the Azure SDK for JavaScript, you may have seen this:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"RestError: write EPROTO 40736C4DF87F0000:error:0A000152:SSL routines:final_renegotiate:unsafe legacy renegotiation disabled:../deps/openssl/openssl/ssl/statem/extensions.c:922:\n"})}),"\n",(0,s.jsx)(n.h2,{id:"why-does-this-happen",children:"Why does this happen?"}),"\n",(0,s.jsxs)(n.p,{children:["The source of this error is Node.js 18 disabling unsafe legacy TLS renegotiation. The motivation for this is noble; it's to mitigate ",(0,s.jsx)(n.a,{href:"https://cve.mitre.org/cgi-bin/cvename.cgi?name=cve-2009-3555",children:"CVE-2009-3555"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["Alas, there are APIs that still use legacy TLS negotiation. And SSL inspection can make APIs that actually do support modern TLS appear as though they do not. I first encountered this issue when working with the ",(0,s.jsx)(n.a,{href:"/teams-notification-webhooks",children:"Teams webhook API"}),", and for a while incorrectly thought that the fault was with the API. It was not, it lay with Palo Alto Networks SSL Inbound Inspection."]}),"\n",(0,s.jsxs)(n.p,{children:["I subsequently encountered the self same issue with the ",(0,s.jsx)(n.a,{href:"https://github.com/Azure/azure-sdk-for-js",children:"Azure SDK for JavaScript"})," and ",(0,s.jsx)(n.a,{href:"https://github.com/Azure/azure-sdk-for-js/issues/26310",children:"in discussion with the team the SSL inspection was identified as a likely cause"}),". We were further able to confirm that SSL inspection was the cause by working with our network team to disable SSL inspection for the API in question. This resolved the issue."]}),"\n",(0,s.jsx)(n.h2,{id:"working-around-the-issue",children:"Working around the issue"}),"\n",(0,s.jsx)(n.p,{children:"But what say you can't disable SSL inspection? Or what if you're using an API that doesn't support modern TLS negotiation? Well, you can work around the issue by allowing legacy TLS renegotiation."}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://stackoverflow.com/questions/74324019/allow-legacy-renegotiation-for-nodejs/74600467#74600467",children:"I found details on how to do this using Axios on Stack Overflow"}),". I kept needing to come back to it again and again, so I wrote this up to make the solution easier for me to find."]}),"\n",(0,s.jsx)(n.p,{children:"So if you are facing this issue, here's how to work around it with Axios."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"import crypto from 'crypto';\nimport https from 'https';\n\n/**\n * Handle this problem with Node 18\n * write EPROTO B8150000:error:0A000152:SSL routines:final_renegotiate:unsafe legacy renegotiation disabled\n * see https://stackoverflow.com/questions/74324019/allow-legacy-renegotiation-for-nodejs/74600467#74600467\n **/\nconst allowLegacyRenegotiationforNodeJsOptions = {\n  httpsAgent: new https.Agent({\n    // for self signed you could also add\n    // rejectUnauthorized: false,\n    // allow legacy server\n    secureOptions: crypto.constants.SSL_OP_LEGACY_SERVER_CONNECT,\n  }),\n};\n\nfunction makeRequest(url: string, data: object) {\n  return axios({\n    ...allowLegacyRenegotiationforNodeJsOptions,\n    url,\n    headers: {\n      Accept: 'application/json',\n      'Content-Type': 'application/json',\n    },\n    method: 'POST',\n    data: { some: 'data' },\n  });\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"There's not much going on here; we're just telling Axios to use an https agent that allows legacy TLS renegotiation. No more than that. With this approach, you can make Axios requests to APIs that use legacy TLS renegotiation. I'd love to be able to do this with the Fetch API, but I haven't found a way to do that yet."}),"\n",(0,s.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,s.jsx)(n.p,{children:"Node.js 18 disables unsafe legacy TLS renegotiation by default. This can cause issues with APIs that still use legacy TLS renegotiation. It can also cause issues if your requests are subject to SSL inspection."}),"\n",(0,s.jsx)(n.p,{children:"This post demonstrates how to work around the issue with Axios."})]})}function c(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},92652:(e,n,t)=>{t.d(n,{A:()=>o});const o=t.p+"assets/images/title-image-44858975d62999ba0013697b9d10be4f.png"}}]);