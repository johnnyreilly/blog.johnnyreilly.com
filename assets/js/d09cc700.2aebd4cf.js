"use strict";(self.webpackChunkjohnnyreilly_com=self.webpackChunkjohnnyreilly_com||[]).push([[60921],{7641:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>g,frontMatter:()=>a,metadata:()=>t,toc:()=>h});var t=i(29703),o=i(74848),s=i(28453);const a={slug:"image-optimisation-tinypng-api",title:"Image Optimisation with the TinyPNG API",authors:"johnnyreilly",tags:[],image:"./title-image.webp",description:"Image optimisation can be automated with the TinyPNG API. This post demonstrates how to do that.",hide_table_of_contents:!1},r=void 0,l={image:i(70566).A,authorsImageUrls:[void 0]},h=[{value:"Images and optimisation",id:"images-and-optimisation",level:2},{value:"The TinyPNG API",id:"the-tinypng-api",level:2},{value:"Making a command line tool",id:"making-a-command-line-tool",level:2},{value:"Using the tool",id:"using-the-tool",level:2},{value:"Conclusion",id:"conclusion",level:2}];function c(e){const n={a:"a",code:"code",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",...(0,s.R)(),...e.components},{Head:t}=n;return t||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Head",!0),(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.p,{children:"Image optimisation can be automated with the TinyPNG API. This post demonstrates how to do that."}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"title image reading &quot;Image Optimisation with the TinyPNG API&quot; with TinyPNG and Lighthouse logos",src:i(51219).A+"",width:"800",height:"450",loading:"lazy"})}),"\n",(0,o.jsx)(n.h2,{id:"images-and-optimisation",children:"Images and optimisation"}),"\n",(0,o.jsxs)(n.p,{children:["Images are a big part of the web. They're also a big part of the web's payload. If we're not careful, we can end up with a site that's slow to load and expensive to host. I run ",(0,o.jsx)(n.a,{href:"https://developer.chrome.com/docs/lighthouse/overview/",children:"Lighthouse"})," on my blog and I'm always looking for ways to improve the performance of the site. One of the things that Lighthouse flags is image optimisation."]}),"\n",(0,o.jsxs)(n.p,{children:["It's a good idea to optimise our images; to make sure they're not unhelpfully large. We can do this manually using tools like ",(0,o.jsx)(n.a,{href:"https://tinypng.com/",children:"TinyPNG"})," or ",(0,o.jsx)(n.a,{href:"https://squoosh.app/",children:"Squoosh"}),". However, it's also possible to automate this process. In this post, I'll show you how to do that using the TinyPNG API."]}),"\n",(0,o.jsx)(n.h2,{id:"the-tinypng-api",children:"The TinyPNG API"}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.a,{href:"https://tinypng.com/developers",children:"TinyPNG API"})," is a paid service. We can get a free API key which allows us to optimise 500 images per month. If we need to optimise more than that, we'll need to pay for a subscription. I rarely find I optimise more than 500 images per month so I'm happy with the free plan."]}),"\n",(0,o.jsx)(n.p,{children:"It's worth noting that the name \"TinyPNG\" is a bit of a misnomer. The API supports a number of image formats including PNG, JPEG and WebP. It's not just for PNGs. In fact we'll be using the WebP format in this post."}),"\n",(0,o.jsxs)(n.p,{children:["You can just use the API directly. However, I prefer to use a client library. We'll be using ",(0,o.jsx)(n.a,{href:"https://tinypng.com/developers/reference/nodejs",children:"the Node.js"})," library."]}),"\n",(0,o.jsx)(n.h2,{id:"making-a-command-line-tool",children:"Making a command line tool"}),"\n",(0,o.jsxs)(n.p,{children:['We\'re going to initialise a simple Node.js console application called "tinify" using ',(0,o.jsx)(n.a,{href:"https://www.typescriptlang.org/",children:"TypeScript"})," and ",(0,o.jsx)(n.a,{href:"https://typestrong.org/ts-node/",children:(0,o.jsx)(n.code,{children:"ts-node"})}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"mkdir tinify\ncd tinify\nnpm init -y\nnpm install @types/node tinify ts-node typescript\nnpx tsc --init\n"})}),"\n",(0,o.jsxs)(n.p,{children:["You'll note that we're using the ",(0,o.jsx)(n.code,{children:"tinify"})," npm package ",(0,o.jsx)(n.a,{href:"https://github.com/tinify/tinify-nodejs",children:"which is developed here"}),". Handily this package ships with TypeScript definitions, so we don't need to install a separate types package."]}),"\n",(0,o.jsxs)(n.p,{children:["In our ",(0,o.jsx)(n.code,{children:"package.json"})," file we'll add a ",(0,o.jsx)(n.code,{children:"start"})," script to run our application:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:'  "scripts": {\n    "start": "ts-node index.ts"\n  },\n'})}),"\n",(0,o.jsxs)(n.p,{children:["In our ",(0,o.jsx)(n.code,{children:"tsconfig.json"})," file we'll also up the ",(0,o.jsx)(n.code,{children:"target"})," to a new ECMAScript emit version to allow us to use some newer language features. We don't need this for TinyPNG, but it's nice to use the newer features:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:'{\n  "compilerOptions": {\n    "target": "es2021"\n  }\n}\n'})}),"\n",(0,o.jsxs)(n.p,{children:["Now we can create our ",(0,o.jsx)(n.code,{children:"index.ts"})," file:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ts",children:"import fs from 'fs';\nimport path from 'path';\nimport tinify from 'tinify';\n\nfunction setUpTinify() {\n  if (!process.env.TINIFY_KEY) {\n    console.log(\n      'Run with: TINIFY_KEY=$YOUR_API_KEY IMAGE_DIR=$YOUR_IMAGE_DIRECTORY yarn start',\n    );\n    process.exit(1);\n  }\n\n  tinify.key = process.env.TINIFY_KEY;\n}\n\nfunction getImageFilesFromDirectory(dir: string) {\n  return fs\n    .readdirSync(dir)\n    .filter(\n      (file) =>\n        file.endsWith('.jpg') ||\n        file.endsWith('.jpeg') ||\n        file.endsWith('.webp') ||\n        file.endsWith('.png'),\n    )\n    .map((file) => path.resolve(dir, file))\n    .filter((file) => fs.statSync(file).size > 0);\n}\n\nasync function processImageFiles(imageFiles: string[]) {\n  let processed = 0;\n  let totalOriginalSizeKb = 0n;\n  let totalNewSizeKb = 0n;\n  let failed: string[] = [];\n\n  for (const imageFilePath of imageFiles) {\n    try {\n      console.log(`\n\ud83d\uddbc\ufe0f  Processing ${imageFilePath}\n`);\n      const originalImageFilePrefix = imageFilePath.substring(\n        0,\n        imageFilePath.lastIndexOf('.'),\n      );\n\n      const originalStats = await fs.promises.stat(imageFilePath, {\n        bigint: true,\n      });\n      const originalSizeKb = originalStats.size / 1024n;\n\n      const source = tinify.fromFile(imageFilePath);\n      const converted = source.convert({ type: ['image/webp', 'image/png'] });\n      const convertedExtension = await converted.result().extension();\n      const newImageFilePath = `${originalImageFilePrefix}.${convertedExtension}`;\n      await converted.toFile(newImageFilePath);\n\n      const newStats = await fs.promises.stat(newImageFilePath, {\n        bigint: true,\n      });\n      const newSizeKb = newStats.size / 1024n;\n\n      const imageFileName = path.basename(imageFilePath);\n      const newImageFileName = path.basename(newImageFilePath);\n\n      totalOriginalSizeKb += originalSizeKb;\n      totalNewSizeKb += newSizeKb;\n\n      console.log(`- \ud83d\udd34 ${originalSizeKb}kb - ${imageFileName}\n- \ud83d\udfe2 ${newSizeKb}kb - ${newImageFileName}\n- \ud83d\udd3d ${calculatePercentageReduction({ originalSizeKb, newSizeKb }).toFixed(\n        2,\n      )}% reduction\n\n\u2705 Processed! (${++processed} of ${imageFiles.length})\n\n----------------------`);\n    } catch (e) {\n      console.log(`\\n\u274c Failed to process ${imageFilePath}`);\n      failed.push(imageFilePath);\n    }\n  }\n\n  console.log(`\n************************************************\n* Total savings for ${imageFiles.length} images \n- \ud83d\udd34 ${totalOriginalSizeKb}kb\n- \ud83d\udfe2 ${totalNewSizeKb}kb\n- \ud83d\udd3d ${calculatePercentageReduction({\n    originalSizeKb: totalOriginalSizeKb,\n    newSizeKb: totalNewSizeKb,\n  }).toFixed(2)}% reduction\n************************************************\n`);\n\n  if (failed.length > 0) console.log('Failed to process', failed);\n}\n\nfunction calculatePercentageReduction({\n  originalSizeKb,\n  newSizeKb,\n}: {\n  originalSizeKb: bigint;\n  newSizeKb: bigint;\n}) {\n  return (\n    ((Number(originalSizeKb) - Number(newSizeKb)) / Number(originalSizeKb)) *\n    100\n  );\n}\n\nasync function run() {\n  setUpTinify();\n\n  let directory = process.env.IMAGE_DIR;\n\n  if (!directory) {\n    console.log('No directory specified!');\n    process.exit(1);\n  }\n\n  const imageFiles = getImageFilesFromDirectory(directory);\n  console.log(`Found ${imageFiles.length} image files in ${directory}`);\n  await processImageFiles(imageFiles);\n}\n\n// do it!\nrun();\n"})}),"\n",(0,o.jsx)(n.p,{children:"There's a number of things happening here. Let me walk it through; each time we run:"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"We're checking that we have a TinyPNG API key and an image directory specified. If not, we'll exit with an error message."}),"\n",(0,o.jsxs)(n.li,{children:["We're getting a list of image files from the specified directory. We look for files with the extensions ",(0,o.jsx)(n.code,{children:".jpg"}),", ",(0,o.jsx)(n.code,{children:".jpeg"}),", ",(0,o.jsx)(n.code,{children:".webp"})," and ",(0,o.jsx)(n.code,{children:".png"})," (those formats supported by TinyPNG). We also filter out any files that are empty."]}),"\n",(0,o.jsxs)(n.li,{children:["We're looping through the image files and processing them one by one. We're using the ",(0,o.jsx)(n.code,{children:"tinify"})," package to shrink the image; and we say we'll accept either ",(0,o.jsx)(n.code,{children:"webp"})," or ",(0,o.jsx)(n.code,{children:"png"})," as our target format. Tinify will decide which is the most optimal format upon each request and render accordingly. Finally we're saving the new files to the same directory as the original file. We're also calculating the percentage reduction in file size."]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"If we wanted to look just at the code that does the actual conversion, it's this:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ts",children:"const source = tinify.fromFile(imageFilePath);\nconst converted = source.convert({ type: ['image/webp', 'image/png'] });\nconst convertedExtension = await converted.result().extension();\nconst newImageFilePath = `${originalImageFilePrefix}.${convertedExtension}`;\nawait converted.toFile(newImageFilePath);\n"})}),"\n",(0,o.jsx)(n.h2,{id:"using-the-tool",children:"Using the tool"}),"\n",(0,o.jsxs)(n.p,{children:["With our tool written, we now need to test it out. I've a directory of images that I want to compress: ",(0,o.jsx)(n.code,{children:"~/code/github/open-graph-sharing-previews/images-to-shrink"})]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"screenshot of image files before optimisation",src:i(14901).A+"",width:"1391",height:"610",loading:"lazy"})}),"\n",(0,o.jsx)(n.p,{children:"Now let's run our tool against that directory and see what happens:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"TINIFY_KEY=YOUR_API_KEY_GOES_HERE IMAGE_DIR=~/code/github/open-graph-sharing-previews/images-to-shrink yarn start\n\nyarn run v1.22.18\n$ ts-node index.ts\nFound 6 image files in /home/john/code/github/open-graph-sharing-previews/images-to-shrink\n\n\ud83d\uddbc\ufe0f  Processing /home/john/code/github/open-graph-sharing-previews/images-to-shrink/screenshot-of-demo-with-devtools-open.png\n\n- \ud83d\udd34 253kb - screenshot-of-demo-with-devtools-open.png\n- \ud83d\udfe2 83kb - screenshot-of-demo-with-devtools-open.png\n- \ud83d\udd3d 67.19% reduction\n\n\u2705 Processed! (1 of 6)\n\n----------------------\n\n\ud83d\uddbc\ufe0f  Processing /home/john/code/github/open-graph-sharing-previews/images-to-shrink/screenshot-of-email-demonstrating-sharing-with-a-non-cropped-image.png\n\n- \ud83d\udd34 158kb - screenshot-of-email-demonstrating-sharing-with-a-non-cropped-image.png\n- \ud83d\udfe2 50kb - screenshot-of-email-demonstrating-sharing-with-a-non-cropped-image.png\n- \ud83d\udd3d 68.35% reduction\n\n\u2705 Processed! (2 of 6)\n\n----------------------\n\n\ud83d\uddbc\ufe0f  Processing /home/john/code/github/open-graph-sharing-previews/images-to-shrink/screenshot-of-tweet-demonstrating-sharing-with-a-cropped-image.png\n\n- \ud83d\udd34 391kb - screenshot-of-tweet-demonstrating-sharing-with-a-cropped-image.png\n- \ud83d\udfe2 64kb - screenshot-of-tweet-demonstrating-sharing-with-a-cropped-image.webp\n- \ud83d\udd3d 83.63% reduction\n\n\u2705 Processed! (3 of 6)\n\n----------------------\n\n\ud83d\uddbc\ufe0f  Processing /home/john/code/github/open-graph-sharing-previews/images-to-shrink/screenshot-of-tweet-demonstrating-sharing.png\n\n- \ud83d\udd34 407kb - screenshot-of-tweet-demonstrating-sharing.png\n- \ud83d\udfe2 78kb - screenshot-of-tweet-demonstrating-sharing.webp\n- \ud83d\udd3d 80.84% reduction\n\n\u2705 Processed! (4 of 6)\n\n----------------------\n\n\ud83d\uddbc\ufe0f  Processing /home/john/code/github/open-graph-sharing-previews/images-to-shrink/screenshot-of-twitter-validator.png\n\n- \ud83d\udd34 162kb - screenshot-of-twitter-validator.png\n- \ud83d\udfe2 49kb - screenshot-of-twitter-validator.webp\n- \ud83d\udd3d 69.75% reduction\n\n\u2705 Processed! (5 of 6)\n\n----------------------\n\n\ud83d\uddbc\ufe0f  Processing /home/john/code/github/open-graph-sharing-previews/images-to-shrink/title-image.png\n\n- \ud83d\udd34 308kb - title-image.png\n- \ud83d\udfe2 49kb - title-image.webp\n- \ud83d\udd3d 84.09% reduction\n\n\u2705 Processed! (6 of 6)\n\n----------------------\n\n************************************************\n* Total savings for 6 images\n- \ud83d\udd34 1679kb\n- \ud83d\udfe2 373kb\n- \ud83d\udd3d 77.78% reduction\n************************************************\n\nDone in 25.23s.\n"})}),"\n",(0,o.jsx)(n.p,{children:"Isn't that impressive? We've reduced the file size of all of these images by an average amount of 77.78%! That's a huge saving."}),"\n",(0,o.jsx)(n.p,{children:"If we look a little closer, we'll see that on two occasions the format has remained as a PNG file and the size has shrunk. In four cases, the format has changed to a WebP file. When we look at our directory again, we'll see that the files have been updated, and some new WebP files have been created:"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"screenshot of image files after optimisation",src:i(78152).A+"",width:"1391",height:"971",loading:"lazy"})}),"\n",(0,o.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,o.jsx)(n.p,{children:"We've seen how we can use the TinyPNG API to optimise our images. We've also built a tool that uses the TinyPNG API to optimise the images in a given directory."}),"\n",(0,o.jsx)(n.p,{children:"It's all automated. We can now run this script whenever we want to optimise the images in any directory!"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.a,{href:"https://blog.logrocket.com/automate-image-optimization-tinypng-api/",children:"This post was originally published on LogRocket."})}),"\n",(0,o.jsx)(t,{children:(0,o.jsx)("link",{rel:"canonical",href:"https://blog.logrocket.com/automate-image-optimization-tinypng-api/"})})]})}function g(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},14901:(e,n,i)=>{i.d(n,{A:()=>t});const t=i.p+"assets/images/screenshot-files-before-optimisation-49a7947a0a404b61bce1b97d582dc75d.png"},28453:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>r});var t=i(96540);const o={},s=t.createContext(o);function a(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),t.createElement(s.Provider,{value:n},e.children)}},29703:e=>{e.exports=JSON.parse('{"permalink":"/image-optimisation-tinypng-api","editUrl":"https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2023-01-22-image-optimisation-tinypng-api/index.md","source":"@site/blog/2023-01-22-image-optimisation-tinypng-api/index.md","title":"Image Optimisation with the TinyPNG API","description":"Image optimisation can be automated with the TinyPNG API. This post demonstrates how to do that.","date":"2023-01-22T00:00:00.000Z","tags":[],"readingTime":6.9,"hasTruncateMarker":true,"authors":[{"name":"John Reilly","title":"OSS Engineer - TypeScript, Azure, React, Node.js, .NET","url":"https://johnnyreilly.com/about","imageURL":"https://johnnyreilly.com/img/profile.jpg","key":"johnnyreilly","page":null}],"frontMatter":{"slug":"image-optimisation-tinypng-api","title":"Image Optimisation with the TinyPNG API","authors":"johnnyreilly","tags":[],"image":"./title-image.webp","description":"Image optimisation can be automated with the TinyPNG API. This post demonstrates how to do that.","hide_table_of_contents":false},"unlisted":false,"prevItem":{"title":"Docusaurus blogs: using the createFeedItems API with git commit date","permalink":"/docusaurus-createfeeditems-api-git-commit-date"},"nextItem":{"title":"Docusaurus: improving Core Web Vitals with fetchpriority","permalink":"/docusaurus-improve-core-web-vitals-fetchpriority"}}')},51219:(e,n,i)=>{i.d(n,{A:()=>t});const t=i.p+"assets/images/title-image-84b1568885dbbcdc1a7c97d1336b8558.webp"},70566:(e,n,i)=>{i.d(n,{A:()=>t});const t=i.p+"assets/images/title-image-84b1568885dbbcdc1a7c97d1336b8558.webp"},78152:(e,n,i)=>{i.d(n,{A:()=>t});const t=i.p+"assets/images/screenshot-files-after-optimisation-6f7e4394defa4ef63878ac29cb9638c2.png"}}]);