"use strict";(self.webpackChunkjohnnyreilly_com=self.webpackChunkjohnnyreilly_com||[]).push([[47102],{82120:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>l,frontMatter:()=>a,metadata:()=>r,toc:()=>p});var i=t(85893),s=t(11151);const a={slug:"configure-azure-connection-strings-keys-in-azure-bicep",title:"Configure Azure connection strings and keys in Azure Bicep",authors:"johnnyreilly",tags:["bicep","azure","azure container apps","azure static web apps"],image:"./title-image.png",hide_table_of_contents:!1,description:"Learn how to configure Azure resources like Azure Static Web Apps and Azure Container Apps with connection strings and access keys in Azure with Bicep."},o=void 0,r={permalink:"/configure-azure-connection-strings-keys-in-azure-bicep",editUrl:"https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2024-03-10-configure-azure-connection-strings-keys-in-azure-bicep/index.md",source:"@site/blog/2024-03-10-configure-azure-connection-strings-keys-in-azure-bicep/index.md",title:"Configure Azure connection strings and keys in Azure Bicep",description:"Learn how to configure Azure resources like Azure Static Web Apps and Azure Container Apps with connection strings and access keys in Azure with Bicep.",date:"2024-03-10T00:00:00.000Z",formattedDate:"March 10, 2024",tags:[{label:"bicep",permalink:"/tags/bicep"},{label:"azure",permalink:"/tags/azure"},{label:"azure container apps",permalink:"/tags/azure-container-apps"},{label:"azure static web apps",permalink:"/tags/azure-static-web-apps"}],readingTime:4.64,hasTruncateMarker:!0,authors:[{name:"John Reilly",title:"OSS Engineer - TypeScript, Azure, React, Node.js, .NET",url:"https://johnnyreilly.com/about",imageURL:"https://johnnyreilly.com/img/profile.jpg",key:"johnnyreilly"}],frontMatter:{slug:"configure-azure-connection-strings-keys-in-azure-bicep",title:"Configure Azure connection strings and keys in Azure Bicep",authors:"johnnyreilly",tags:["bicep","azure","azure container apps","azure static web apps"],image:"./title-image.png",hide_table_of_contents:!1,description:"Learn how to configure Azure resources like Azure Static Web Apps and Azure Container Apps with connection strings and access keys in Azure with Bicep."},unlisted:!1,nextItem:{title:"Multiline strings in .env files",permalink:"/multiline-strings-dot-env-files"}},c={image:t(19982).Z,authorsImageUrls:[void 0]},p=[{value:"Configure an Azure Static Web App with a connection string and an access key",id:"configure-an-azure-static-web-app-with-a-connection-string-and-an-access-key",level:2},{value:"Configure an Azure Container App with a connection string and an access key",id:"configure-an-azure-container-app-with-a-connection-string-and-an-access-key",level:2},{value:"Conclusion",id:"conclusion",level:2}];function u(e){const n={a:"a",code:"code",em:"em",h2:"h2",img:"img",p:"p",pre:"pre",...(0,s.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"Imagine you're deploying a solution to Azure. It'll feature some resources like a database or a storage account. How do can you configure your application with access to these resources? One approach would be using Managed Identity. Another approach is configuring the connection strings and access keys in our application's configuration store as the Bicep templates are deployed. This is a common approach when working with Azure Functions, Azure Static Web Apps, Azure Container Apps and similar."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"title image reading &quot;Configure Azure connection strings and keys in Azure Bicep&quot; with the Bicep and Azure logos",src:t(68319).Z+"",width:"800",height:"450",loading:"eager",fetchpriority:"high"})}),"\n",(0,i.jsxs)(n.p,{children:["A wonderful aspect of this approach is that no human need ever get to see the connection strings / access keys. They'll be discovered and consumed by Azure during a deployment, and known to your application at runtime, but untrustworthy humans need never get to see them. This is secure, and therefore ",(0,i.jsx)(n.em,{children:"good"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"configure-an-azure-static-web-app-with-a-connection-string-and-an-access-key",children:"Configure an Azure Static Web App with a connection string and an access key"}),"\n",(0,i.jsx)(n.p,{children:"The blog you are reading this on is hosted on Azure Static Web Apps and deployed with Bicep. It also has an Azure Cosmos DB database and an Application Insights instance. The Azure Static Web App has access to the database via its access key and has access to the Application Insights instance through a connection string. The key and connection string are supplied to the configuration of the SWA during deployment."}),"\n",(0,i.jsx)(n.p,{children:"Let's look at the Bicep configuration that deploys a database. Here's a snippet of the Bicep template:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bicep",children:"resource databaseAccount 'Microsoft.DocumentDB/databaseAccounts@2023-04-15' = {\n  name: cosmosDbAccountName\n  kind: 'GlobalDocumentDB'\n  location: location\n  tags: tags\n  properties: {\n    consistencyPolicy: { defaultConsistencyLevel: 'Session' }\n    locations: locations\n    enableAutomaticFailover: true\n    databaseAccountOfferType: 'Standard'\n    publicNetworkAccess: 'Enabled'\n    ipRules: [for ipAddress in ipAddresses: {\n      ipAddressOrRange: ipAddress\n    }]\n    backupPolicy: { type: 'Periodic', periodicModeProperties: { backupIntervalInMinutes: 240, backupRetentionIntervalInHours: 720 }}\n  }\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"Here's a snippet of the Bicep template that deploys the Application Insights instance:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bicep",children:"resource appInsights 'Microsoft.Insights/components@2020-02-02' = {\n  name: appInsightsName\n  location: location\n  kind: 'other'\n  properties: {\n    Application_Type: 'web'\n    Flow_Type: 'Bluefield'\n    WorkspaceResourceId: workspace.id\n    RetentionInDays: 90\n    IngestionMode: 'LogAnalytics'\n    publicNetworkAccessForIngestion: 'Enabled'\n    publicNetworkAccessForQuery: 'Enabled'\n  }\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"Given that both of these resources are deployed, we can reference them subsequently and acquire connection strings / access keys."}),"\n",(0,i.jsx)(n.p,{children:"So when we're getting ready to deploy the Azure Static Web App, we are able reference both the database and the Application Insights instance. Here's a snippet of the Bicep template that acquires the references:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bicep",children:"resource databaseAccount 'Microsoft.DocumentDB/databaseAccounts@2023-04-15' existing = {\n  name: cosmosDbAccountName\n}\n\nresource appInsightsResource 'Microsoft.Insights/components@2020-02-02' existing = {\n  name: appInsightsName\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"With those references in hand, we can now configure the Azure Static Web App with the connection string and access key. Here's a snippet of the Bicep template that configures the Azure Static Web App with the connection string and access key:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bicep",children:"// deploy the Azure Static Web App\nresource staticWebApp 'Microsoft.Web/staticSites@2022-09-01' = {\n  name: staticWebAppName\n  location: location\n  tags: tagsWithHiddenLinks\n  sku: {\n    name: 'Free'\n    tier: 'Free'\n  }\n  properties: {\n    repositoryUrl: 'https://github.com/johnnyreilly/blog.johnnyreilly.com'\n    repositoryToken: repositoryToken\n    branch: branch\n    provider: 'GitHub'\n    stagingEnvironmentPolicy: 'Enabled'\n    allowConfigFileUpdates: true\n    buildProperties:{\n      skipGithubActionWorkflowGeneration: true\n    }\n  }\n}\n\n// configure the Azure Static Web App with the connection string and access key\nresource staticWebAppAppSettings 'Microsoft.Web/staticSites/config@2022-09-01' = {\n  name: 'appsettings'\n  kind: 'config'\n  parent: staticWebApp\n  properties: {\n    APPINSIGHTS_INSTRUMENTATIONKEY: appInsightsResource.properties.InstrumentationKey\n    APPLICATIONINSIGHTS_CONNECTION_STRING: appInsightsResource.properties.ConnectionString // <-- connection string\n    COSMOS_ENDPOINT: databaseAccount.properties.documentEndpoint\n    COSMOS_KEY: databaseAccount.listKeys().primaryMasterKey // <-- access key\n  }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["I've slightly tweaked the code to make it more readable, if you'd like to see the full configuration of the Azure Static Web App in the source of my blog, you can find it ",(0,i.jsx)(n.a,{href:"https://github.com/johnnyreilly/blog.johnnyreilly.com/blob/df2382e31dab82604e98d91f83967b8b559eb507/infra/static-web-app.bicep#L47C1-L57C2",children:"here"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"You can see the effect of this configuration in the Azure Portal. Here's a screenshot of the configured environment variables of the Azure Static Web App:"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Screenshot of the Azure Static Web App in the Azure Portal",src:t(2062).Z+"",width:"583",height:"316",loading:"lazy"})}),"\n",(0,i.jsx)(n.h2,{id:"configure-an-azure-container-app-with-a-connection-string-and-an-access-key",children:"Configure an Azure Container App with a connection string and an access key"}),"\n",(0,i.jsx)(n.p,{children:"What's hopefully apparent from the previous section is that in the end this amounts to injecting a string to the appropriate place in the configuration of the resource. This is true for Azure Container Apps as well. Here's a snippet of the Bicep template that configures an Azure Container App with a connection string and access key:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bicep",children:"var appInsightsInstrumentationRef = 'app-insights-instrumentation-key'\nvar appInsightsConnectionStringRef = 'app-insights-connection-string'\nvar cosmosKeyRef = 'cosmos-key'\n\nresource webServiceContainerApp 'Microsoft.App/containerApps@2023-05-01' = {\n  name: webServiceContainerAppName\n  tags: tags\n  location: location\n  properties: {\n    // ...\n    configuration: {\n      secrets: [\n        {\n          name: appInsightsInstrumentationRef\n          value: appInsightsResource.properties.InstrumentationKey\n        }\n        {\n          name: appInsightsConnectionStringRef\n          value: appInsightsResource.properties.ConnectionString // <-- connection string\n        }\n        {\n          name: cosmosKeyRef\n          value: databaseAccount.listKeys().primaryMasterKey // <-- access key\n        }\n        // ...\n      ]\n      // ...\n    }\n    template: {\n      containers: [\n        {\n          // ...\n          env: [\n            {\n              name: 'APPINSIGHTS_INSTRUMENTATIONKEY'\n              secretRef: appInsightsInstrumentationRef\n            }\n            {\n              name: 'APPLICATIONINSIGHTS_CONNECTION_STRING'\n              secretRef: appInsightsConnectionStringRef\n            }\n            {\n              name: 'COSMOS_ENDPOINT'\n              value: databaseAccount.properties.documentEndpoint\n            }\n            {\n              name: 'COSMOS_KEY'\n              secretRef: cosmosKeyRef\n            }\n            // ...\n          ]\n        }\n      ]\n      // ...\n    }\n  }\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"The mechanism is slightly different, as befits the different service being used, but the principle is the same. We're injecting the connection string and access key into the configuration of the resource."}),"\n",(0,i.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,i.jsx)(n.p,{children:"In this post we've demonstrated how to deploy resources, acquire reference to them and safely configure Azure Static Web Apps and Azure Container Apps such that they can access the resources."}),"\n",(0,i.jsx)(n.p,{children:"The pattern we've used here is generally applicable in the Azure world. The same technique can be used to configure Azure Functions, Azure KeyVault, and many other Azure resources. The key is to understand the configuration of the resource you're working with and to understand how to inject the relevant secrets into that configuration."})]})}function l(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(u,{...e})}):u(e)}},19982:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/title-image-abc46f74075588ff096aed6c166c7ccb.png"},2062:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/screenshot-azure-portal-environment-variables-e3e899ec9559b64c65a276a82ef48ce4.png"},68319:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/title-image-abc46f74075588ff096aed6c166c7ccb.png"},11151:(e,n,t)=>{t.d(n,{Z:()=>r,a:()=>o});var i=t(67294);const s={},a=i.createContext(s);function o(e){const n=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);