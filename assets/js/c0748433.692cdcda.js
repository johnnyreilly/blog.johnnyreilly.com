"use strict";(self.webpackChunkjohnnyreilly_com=self.webpackChunkjohnnyreilly_com||[]).push([[78418],{20135:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>h,contentTitle:()=>r,default:()=>u,frontMatter:()=>a,metadata:()=>s,toc:()=>c});var s=n(45411),i=n(74848),o=n(28453);const a={slug:"cypress-and-auth0",title:"Cypress and Auth0",authors:"johnnyreilly",tags:["auth","automated testing"],hide_table_of_contents:!1,description:"The article explains how to automate Auth0 login using Cypress, by using the auth0-js client library, and creating a custom command."},r=void 0,h={authorsImageUrls:[void 0]},c=[{value:"Commanding Auth0",id:"commanding-auth0",level:2},{value:"Using It",id:"using-it",level:2},{value:"One More Thing...",id:"one-more-thing",level:2}];function l(e){const t={a:"a",blockquote:"blockquote",code:"code",h2:"h2",img:"img",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.a,{href:"https://www.cypress.io/",children:"Cypress"})," is a fantastic way to write UI tests for your web apps. Just world class. Wait, no. Galaxy class. I'm going to go one further: universe class. You get my drift."]}),"\n",(0,i.jsx)(t.p,{children:"Here's a pickle for you. You have functionality that lies only behind the walled garden of authentication. You want to write tests for these capabilities. Assuming that authentication takes place within your application that's no great shakes. Authentication is part of your app; it's no big deal using Cypress to automate logging in."}),"\n",(0,i.jsx)(t.p,{children:"Auth is a serious business and, as Cypress is best in class for UI testing, I'll say that Auth0 is romping home with the same title in the auth-as-a-service space. My app is using Auth0 for authentication. What's important to note about this is the flow. Typically when using auth-as-a-service, the user is redirected to the auth provider's site to authenticate and then be redirected back to the application post-login."}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.a,{href:"https://github.com/brian-mann",children:"Brian Mann"})," (of Cypress fame) has been ",(0,i.jsx)(t.a,{href:"https://github.com/cypress-io/cypress/issues/1342#issuecomment-366747803",children:"fairly clear when talking about testing with this sort of authentication flow"}),":"]}),"\n",(0,i.jsxs)(t.blockquote,{children:["\n",(0,i.jsx)(t.p,{children:"You're trying to test SSO - and we have recipes showing you exactly how to do this."}),"\n",(0,i.jsxs)(t.p,{children:["Also best practice is never to visit or test 3rd party sites not under your control. You don't control ",(0,i.jsx)(t.code,{children:"microsoftonline"}),", so there's no reason to use the UI to test this. You can programmatically test the integration between it and your app with ",(0,i.jsx)(t.code,{children:"cy.request"})," - which is far faster, more reliable, and still gives you 100% confidence."]}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"I want to automate logging into Auth0 from my Cypress tests. But hopefully in a good way. Not a bad way. Wouldn't want to make Brian sad."}),"\n",(0,i.jsx)(t.h2,{id:"commanding-auth0",children:"Commanding Auth0"}),"\n",(0,i.jsxs)(t.p,{children:["To automate our login, we're going to use the ",(0,i.jsx)(t.a,{href:"https://github.com/auth0/auth0.js",children:"auth0-js client library"}),". This is the same library the application uses; but we're going to do something subtly different with it."]}),"\n",(0,i.jsxs)(t.p,{children:["The application uses ",(0,i.jsx)(t.a,{href:"https://github.com/auth0/auth0.js#api",children:(0,i.jsx)(t.code,{children:"authorize"})})," to log users in. This function redirects the user into the Auth0 lock screen, and then, post authentication, redirects the user back to the application with a token in the URL. The app parses the token (using the auth0 client library) and sets the token and the expiration of said token in the browser sessionStorage."]}),"\n",(0,i.jsxs)(t.p,{children:["What we're going to do is automate our login by using ",(0,i.jsx)(t.code,{children:"login"})," instead. First of all, we need to add ",(0,i.jsx)(t.code,{children:"auth0-js"})," as a dependency of our e2e tests:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-js",children:"yarn add auth0-js --dev\n"})}),"\n",(0,i.jsx)(t.p,{children:"Next, we're going to create ourselves a custom command called loginAsAdmin:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-js",children:"const auth0 = require('auth0-js');\n\nCypress.Commands.add('loginAsAdmin', (overrides = {}) => {\n  Cypress.log({\n    name: 'loginAsAdminBySingleSignOn',\n  });\n\n  const webAuth = new auth0.WebAuth({\n    domain: 'my-super-duper-domain.eu.auth0.com', // Get this from https://manage.auth0.com/#/applications and your application\n    clientID: 'myclientid', // Get this from https://manage.auth0.com/#/applications and your application\n    responseType: 'token id_token',\n  });\n\n  webAuth.client.login(\n    {\n      realm: 'Username-Password-Authentication',\n      username: 'mytestemail@something.co.uk',\n      password: 'SoVeryVeryVery$ecure',\n      audience: 'myaudience', // Get this from https://manage.auth0.com/#/apis and your api, use the identifier property\n      scope: 'openid email profile',\n    },\n    function (err, authResult) {\n      // Auth tokens in the result or an error\n      if (authResult && authResult.accessToken && authResult.idToken) {\n        const token = {\n          accessToken: authResult.accessToken,\n          idToken: authResult.idToken,\n          // Set the time that the access token will expire at\n          expiresAt: authResult.expiresIn * 1000 + new Date().getTime(),\n        };\n\n        window.sessionStorage.setItem(\n          'my-super-duper-app:storage_token',\n          JSON.stringify(token),\n        );\n      } else {\n        console.error('Problem logging into Auth0', err);\n        throw err;\n      }\n    },\n  );\n});\n"})}),"\n",(0,i.jsxs)(t.p,{children:["This command logs in using the ",(0,i.jsx)(t.code,{children:"auth0-js"})," API and then sets the result into ",(0,i.jsx)(t.code,{children:"sessionStorage"})," in the same way that our app does. This allows our app to read the value out of ",(0,i.jsx)(t.code,{children:"sessionStorage"})," and use it. We're also going to put together one other command:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-js",children:"Cypress.Commands.add('visitHome', (overrides = {}) => {\n  cy.visit('/', {\n    onBeforeLoad: (win) => {\n      win.sessionStorage.clear();\n    },\n  });\n});\n"})}),"\n",(0,i.jsxs)(t.p,{children:["This visits the root of our application and wipes the ",(0,i.jsx)(t.code,{children:"sessionStorage"}),". This is necessary because Cypress doesn't clear down ",(0,i.jsx)(t.code,{children:"sessionStorage"})," between tests. (",(0,i.jsx)(t.a,{href:"https://github.com/cypress-io/cypress/issues/413",children:"That's going to change though."}),")"]}),"\n",(0,i.jsx)(t.h2,{id:"using-it",children:"Using It"}),"\n",(0,i.jsx)(t.p,{children:"Let's write a test that uses our new commands to see if it gets access to our admin functionality:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-js",children:"describe('access secret admin functionality', () => {\n  it('should be able to navigate to', () => {\n    cy.visitHome()\n      .loginAsAdmin()\n      .get('[href=\"/secret-adminny-stuff\"]') // This link should only be visible to admins\n      .click()\n      .url()\n      .should('contain', 'secret-adminny-stuff/'); // non-admins should be redirected away from this url\n  });\n});\n"})}),"\n",(0,i.jsx)(t.p,{children:"Well, the test looks good but it's failing. If I fire up the Chrome Dev Tools in Cypress (did I mention that Cypress is absolutely fabulous?) then I see this response tucked away in the network tab:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-json",children:'{error: "unauthorized_client",\u2026} error : "unauthorized_client" error_description : "Grant type \'http://auth0.com/oauth/grant-type/password-realm\' not allowed for the client."\n'})}),"\n",(0,i.jsxs)(t.p,{children:["Hmmm... So sad. If you go to ",(0,i.jsx)(t.a,{href:"https://manage.auth0.com/#/applications",children:"https://manage.auth0.com/#/applications"}),", select your application, ",(0,i.jsx)(t.code,{children:"Show Advanced Settings"})," and ",(0,i.jsx)(t.code,{children:"Grant Types"})," you'll see a ",(0,i.jsx)(t.code,{children:"Password"})," option is unselected."]}),"\n",(0,i.jsx)(t.p,{children:"Select it, Save Changes and try again."}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{src:n(99461).A+"",width:"640",height:"449",loading:"lazy"})}),"\n",(0,i.jsx)(t.p,{children:"You now have a test which automates your Auth0 login using Cypress and goes on to test your application functionality with it!"}),"\n",(0,i.jsx)(t.h2,{id:"one-more-thing",children:"One More Thing..."}),"\n",(0,i.jsxs)(t.p,{children:["It's worth saying that it's worth setting up different tenants in Auth0 to support your testing scenarios. This is generally a good idea so you can separate your testing accounts from Production accounts. Further to that, you don't need to have your Production setup supporting the ",(0,i.jsx)(t.code,{children:"Password``Grant Type"}),"."]}),"\n",(0,i.jsxs)(t.p,{children:["Also, if you're curious about what the application under test is like then read ",(0,i.jsx)(t.a,{href:"/auth0-typescript-and-aspnet-core",children:"this"}),"."]})]})}function u(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>a,x:()=>r});var s=n(96540);const i={},o=s.createContext(i);function a(e){const t=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),s.createElement(o.Provider,{value:t},e.children)}},45411:e=>{e.exports=JSON.parse('{"permalink":"/cypress-and-auth0","editUrl":"https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2018-07-09-cypress-and-auth0/index.md","source":"@site/blog/2018-07-09-cypress-and-auth0/index.md","title":"Cypress and Auth0","description":"The article explains how to automate Auth0 login using Cypress, by using the auth0-js client library, and creating a custom command.","date":"2018-07-09T00:00:00.000Z","tags":[{"inline":false,"label":"Authentication and Authorization","permalink":"/tags/auth","description":"Matters related to identity and permissioning"},{"inline":false,"label":"Automated Testing","permalink":"/tags/automated-testing","description":"How to perform the automation of tests."}],"readingTime":4.65,"hasTruncateMarker":true,"authors":[{"name":"John Reilly","title":"OSS Engineer - TypeScript, Azure, React, Node.js, .NET","url":"https://johnnyreilly.com/about","imageURL":"https://johnnyreilly.com/img/profile-2025.jpg","key":"johnnyreilly","page":null}],"frontMatter":{"slug":"cypress-and-auth0","title":"Cypress and Auth0","authors":"johnnyreilly","tags":["auth","automated testing"],"hide_table_of_contents":false,"description":"The article explains how to automate Auth0 login using Cypress, by using the auth0-js client library, and creating a custom command."},"unlisted":false,"prevItem":{"title":"Azure App Service: nested configuration for ASP.NET running in Web App for Containers using Application Settings","permalink":"/azure-app-service-web-app-containers-asp-net-nested-configuration"},"nextItem":{"title":"VSTS and EF Core Migrations","permalink":"/vsts-and-ef-core-migrations"}}')},99461:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/auth0-enable-password-grant-type-8ee502754568e2a02f38de706c4cfdb7.webp"}}]);