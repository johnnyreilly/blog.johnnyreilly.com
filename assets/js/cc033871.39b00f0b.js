"use strict";(self.webpackChunkjohnnyreilly_com=self.webpackChunkjohnnyreilly_com||[]).push([[66156],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>m});var i=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,i,r=function(e,t){if(null==e)return{};var n,i,r={},o=Object.keys(e);for(i=0;i<o.length;i++)n=o[i],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(i=0;i<o.length;i++)n=o[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=i.createContext({}),c=function(e){var t=i.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},u=function(e){var t=c(e.components);return i.createElement(l.Provider,{value:t},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},h=i.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),p=c(n),h=r,m=p["".concat(l,".").concat(h)]||p[h]||d[h]||o;return n?i.createElement(m,a(a({ref:t},u),{},{components:n})):i.createElement(m,a({ref:t},u))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,a=new Array(o);a[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[p]="string"==typeof e?e:r,a[1]=s;for(var c=2;c<o;c++)a[c]=n[c];return i.createElement.apply(null,a)}return i.createElement.apply(null,n)}h.displayName="MDXCreateElement"},61322:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>l,default:()=>h,frontMatter:()=>s,metadata:()=>c,toc:()=>p});n(67294);var i=n(3905);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}function a(e,t){if(null==e)return{};var n,i,r=function(e,t){if(null==e)return{};var n,i,r={},o=Object.keys(e);for(i=0;i<o.length;i++)n=o[i],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(i=0;i<o.length;i++)n=o[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}const s={slug:"azure-static-web-apps-dynamic-redirects-azure-functions",title:"Azure Static Web Apps: dynamic redirects with Azure Functions",authors:"johnnyreilly",tags:["azure static web apps","azure functions","github actions"],image:"./title-image.png",description:"Azure Static Web Apps can perform URL redirects using the `routes` section in the `staticwebapp.config.json`. However it is limited. This post will demonstrate dynamic URL redirects with Azure Functions.",hide_table_of_contents:!1},l=void 0,c={permalink:"/azure-static-web-apps-dynamic-redirects-azure-functions",editUrl:"https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2022-12-22-azure-static-web-apps-dynamic-redirects-azure-functions/index.md",source:"@site/blog/2022-12-22-azure-static-web-apps-dynamic-redirects-azure-functions/index.md",title:"Azure Static Web Apps: dynamic redirects with Azure Functions",description:"Azure Static Web Apps can perform URL redirects using the `routes` section in the `staticwebapp.config.json`. However it is limited. This post will demonstrate dynamic URL redirects with Azure Functions.",date:"2022-12-22T00:00:00.000Z",formattedDate:"December 22, 2022",tags:[{label:"azure static web apps",permalink:"/tags/azure-static-web-apps"},{label:"azure functions",permalink:"/tags/azure-functions"},{label:"github actions",permalink:"/tags/github-actions"}],readingTime:4.78,hasTruncateMarker:!0,authors:[{name:"John Reilly",title:"OSS Engineer - TypeScript, Azure, React, Node.js, .NET",url:"https://johnnyreilly.com/about",imageURL:"https://johnnyreilly.com/img/profile.jpg",key:"johnnyreilly"}],frontMatter:{slug:"azure-static-web-apps-dynamic-redirects-azure-functions",title:"Azure Static Web Apps: dynamic redirects with Azure Functions",authors:"johnnyreilly",tags:["azure static web apps","azure functions","github actions"],image:"./title-image.png",description:"Azure Static Web Apps can perform URL redirects using the `routes` section in the `staticwebapp.config.json`. However it is limited. This post will demonstrate dynamic URL redirects with Azure Functions.",hide_table_of_contents:!1},prevItem:{title:"Serving Docusaurus images with Cloudinary",permalink:"/docusaurus-image-cloudinary-rehype-plugin"},nextItem:{title:"Azure Static Web Apps: build app externally",permalink:"/azure-static-web-apps-build-app-externally"}},u={image:n(84949).Z,authorsImageUrls:[void 0]},p=[{value:"The limits of <code>routes</code> in <code>staticwebapp.config.json</code>",id:"the-limits-of-routes-in-staticwebappconfigjson",level:2},{value:"Adding an Azure Function to our Azure Static Web App",id:"adding-an-azure-function-to-our-azure-static-web-app",level:2},{value:"JSDoc types with <code>@azure/functions</code>",id:"jsdoc-types-with-azurefunctions",level:2},{value:"Consuming the Azure Function from our Azure Static Web App",id:"consuming-the-azure-function-from-our-azure-static-web-app",level:2},{value:"Deploying our Azure Function",id:"deploying-our-azure-function",level:2},{value:"Testing our Azure Function",id:"testing-our-azure-function",level:2},{value:"Conclusion",id:"conclusion",level:2}],d={toc:p};function h(e){var{components:t}=e,s=a(e,["components"]);return(0,i.kt)("wrapper",o(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},i=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),i.forEach((function(t){r(e,t,n[t])}))}return e}({},d,s),{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"Azure Static Web Apps can perform URL redirects using the ",(0,i.kt)("inlineCode",{parentName:"p"},"routes")," section in the ",(0,i.kt)("inlineCode",{parentName:"p"},"staticwebapp.config.json"),". However it is limited. This post will demonstrate dynamic URL redirects with Azure Functions."),(0,i.kt)("p",null,(0,i.kt)("img",{loading:"eager",fetchpriority:"high",alt:"title image reading &quot;Azure Static Web Apps: dynamic redirects with Azure Functions&quot; with the Static Web Apps and Azure Functions logo",src:n(84949).Z,width:"800",height:"450"})),(0,i.kt)("h2",{id:"the-limits-of-routes-in-staticwebappconfigjson"},"The limits of ",(0,i.kt)("inlineCode",{parentName:"h2"},"routes")," in ",(0,i.kt)("inlineCode",{parentName:"h2"},"staticwebapp.config.json")),(0,i.kt)("p",null,"I recently found myself fixing up some redirects for my blog, which runs on Azure Static Web Apps. I had quite a few redirects to implement and I ended up with ",(0,i.kt)("a",{parentName:"p",href:"https://learn.microsoft.com/en-us/azure/static-web-apps/configuration#routes"},"a very large ",(0,i.kt)("inlineCode",{parentName:"a"},"routes")," section"),". It was so large that I exceeded ",(0,i.kt)("a",{parentName:"p",href:"https://learn.microsoft.com/en-us/azure/static-web-apps/configuration#restrictions"},"the 20kb limit that affect Azure Static Web Apps"),"."),(0,i.kt)("p",null,"I bemoaned this on Twitter and got some great advice from ",(0,i.kt)("a",{parentName:"p",href:"https://twitter.com/nthonyChu"},"Anthony Chu who works on Azure Static Web Apps"),":"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://twitter.com/nthonyChu/status/1605248878009208832"},(0,i.kt)("img",{loading:"lazy",alt:"Tweet that reads: Your best bet today might be to use a function that handles 404 response overrides. You can do the lookup with it and return a redirect if found. There might be a small cold start on those routes but for this case maybe it\u2019s okay.",src:n(13449).Z,width:"1121",height:"1410"}))),(0,i.kt)("p",null,"Anthony went on to ",(0,i.kt)("a",{parentName:"p",href:"https://twitter.com/nthonyChu/status/1605429770715402240"},"share details of an example implementation that Nuxt.js has implemented"),". I took this as a challenge to implement something similar for my blog. Let's see how we got on."),(0,i.kt)("h2",{id:"adding-an-azure-function-to-our-azure-static-web-app"},"Adding an Azure Function to our Azure Static Web App"),(0,i.kt)("p",null,"The first thing we need to do is add an Azure Function to our Azure Static Web App. All Static Web Apps can be backed by an Azure Function App. ",(0,i.kt)("a",{parentName:"p",href:"https://learn.microsoft.com/en-us/azure/static-web-apps/add-api?tabs=react#create-the-api"},"We can create a simple JavaScript HttpTrigger Azure Function following this guide"),". I used JavScript as it seemed like the simplest option. If we wanted a different language we could use one."),(0,i.kt)("p",null,"We're going to name the single function ",(0,i.kt)("inlineCode",{parentName:"p"},"fallback"),", so it will be served up at ",(0,i.kt)("inlineCode",{parentName:"p"},"/api/fallback"),". The code of the function is:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"//@ts-check\nconst { parseURL } = require('ufo');\nconst routes = require('./redirects');\n\n/**\n *\n * @param { import(\"@azure/functions\").Context } context\n * @param { import(\"@azure/functions\").HttpRequest } req\n */\nasync function fallback(context, req) {\n  const originalUrl = req.headers['x-ms-original-url'];\n  if (originalUrl) {\n    // This URL has been proxied as there was no static file matching it.\n    context.log(`x-ms-original-url: ${originalUrl}`);\n\n    const parsedURL = parseURL(originalUrl);\n\n    const matchedRoute = routes.find((route) =>\n      parsedURL.pathname.includes(route.route),\n    );\n\n    if (matchedRoute) {\n      context.log(`Redirecting ${originalUrl} to ${matchedRoute.redirect}`);\n\n      context.res = {\n        status: matchedRoute.statusCode,\n        headers: { location: matchedRoute.redirect },\n      };\n      return;\n    }\n  }\n\n  context.log(\n    `No explicit redirect for ${originalUrl} so will redirect to 404`,\n  );\n\n  context.res = {\n    status: 302,\n    headers: {\n      location: originalUrl\n        ? `/404?originalUrl=${encodeURIComponent(originalUrl)}`\n        : '/404',\n    },\n  };\n}\n\nmodule.exports = fallback;\n")),(0,i.kt)("p",null,"What's happening here? Well, we're using the ",(0,i.kt)("inlineCode",{parentName:"p"},"ufo")," package to parse the URL which we grab from the ",(0,i.kt)("inlineCode",{parentName:"p"},"x-ms-original-url")," header. We then look for a match in our ",(0,i.kt)("inlineCode",{parentName:"p"},"redirects.js"),", which is a ",(0,i.kt)("em",{parentName:"p"},"big")," list of potential redirects."),(0,i.kt)("p",null,"If we find a match, we redirect based upon that match. Otherwise we redirect to the custom 404 screen in our app. And we include the original URL in the query string for visibility. (With this in place, any unhandled redirects should show up in Google Analytics etc.)"),(0,i.kt)("h2",{id:"jsdoc-types-with-azurefunctions"},"JSDoc types with ",(0,i.kt)("inlineCode",{parentName:"h2"},"@azure/functions")),(0,i.kt)("p",null,"You'll notice that we're using JSDoc types in the above code and enabling type checking through use of ",(0,i.kt)("a",{parentName:"p",href:"https://www.typescriptlang.org/docs/handbook/intro-to-js-ts.html#ts-check"},(0,i.kt)("inlineCode",{parentName:"a"},"// @ts-check")),". We're providing types to our function through the ",(0,i.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/@azure/functions"},(0,i.kt)("inlineCode",{parentName:"a"},"@azure/functions"))," package which we've added as a ",(0,i.kt)("inlineCode",{parentName:"p"},"devDependency"),". You don't have to do this, but it's a nice way to get some type safety."),(0,i.kt)("h2",{id:"consuming-the-azure-function-from-our-azure-static-web-app"},"Consuming the Azure Function from our Azure Static Web App"),(0,i.kt)("p",null,"Now our Azure Function is in place, we need to configure our Azure Static Web App to use it. In our ",(0,i.kt)("inlineCode",{parentName:"p"},"staticwebapp.config.json")," we'll make some changes:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'  "navigationFallback": {\n    "rewrite": "/api/fallback"\n  },\n  "platform": {\n    "apiRuntime": "node:18"\n  },\n  "routes": [\n    {\n      "route": "/404",\n      "statusCode": 404\n    },\n')),(0,i.kt)("p",null,"Here we:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Point to our apps navigation fallback to our ",(0,i.kt)("inlineCode",{parentName:"li"},"fallback")," function (",(0,i.kt)("inlineCode",{parentName:"li"},"/api/fallback"),") - this will be called whenever a URL is not matched by a static file."),(0,i.kt)("li",{parentName:"ul"},"We declare an ",(0,i.kt)("inlineCode",{parentName:"li"},"apiRuntime")," of Node.js 18 - this is the version of Node.js that our Azure Function is using."),(0,i.kt)("li",{parentName:"ul"},"Whenever the ",(0,i.kt)("inlineCode",{parentName:"li"},"/404")," route is hit in our app, we ensure the status code presented is 404."),(0,i.kt)("li",{parentName:"ul"},"We remove the ",(0,i.kt)("inlineCode",{parentName:"li"},"route")," redirects we had in place as these will now be handled by ",(0,i.kt)("inlineCode",{parentName:"li"},"/api/fallback")," (this isn't shown in the above snippet)")),(0,i.kt)("h2",{id:"deploying-our-azure-function"},"Deploying our Azure Function"),(0,i.kt)("p",null,"We need to deploy our Function, and we achieve that by tweaking the our GitHub Action that deploys our Static Web App. We add the following:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yml"},"api_location: '/blog-website/api'\n")),(0,i.kt)("p",null,"And now our Azure Function will be built and deployed alongside our blog."),(0,i.kt)("h2",{id:"testing-our-azure-function"},"Testing our Azure Function"),(0,i.kt)("p",null,"We can demonstrate this works pretty easily. Let's take a super old blog post of mine, where I upgraded to TypeScript 0.9.5 (!!!) The route has changed since I originally posted back in 2014. If we go to ",(0,i.kt)("a",{parentName:"p",href:"https://johnnyreilly.com/2014/01/upgrading-to-typescript-095-personal.html"},"https://johnnyreilly.com/2014/01/upgrading-to-typescript-095-personal.html")," (the old Blogger URL), we'll be redirected (301'd to be specific - signalling a permanent move) to ",(0,i.kt)("a",{parentName:"p",href:"https://johnnyreilly.com/2014/01/09/upgrading-to-typescript-095-personal"},"https://johnnyreilly.com/2014/01/09/upgrading-to-typescript-095-personal")," - the new URL. This is demonstrated in the following screenshot - note the ",(0,i.kt)("inlineCode",{parentName:"p"},"location")," header in the response:"),(0,i.kt)("p",null,(0,i.kt)("img",{loading:"lazy",alt:"screenshot of redirect in Chrome Devtools",src:n(52606).Z,width:"1799",height:"541"})),(0,i.kt)("p",null,"This particular redirect is driven by ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/johnnyreilly/blog.johnnyreilly.com/blob/e21d3faf897505e860fc351260ab45ef6fa21d60/blog-website/api/fallback/redirects.js#L475-L479"},"an entry in our ",(0,i.kt)("inlineCode",{parentName:"a"},"redirects.js"))," file:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},"  {\n    route: '/2014/01/upgrading-to-typescript-095-personal.html',\n    redirect: '/2014/01/09/upgrading-to-typescript-095-personal',\n    statusCode: 301,\n  },\n")),(0,i.kt)("h2",{id:"conclusion"},"Conclusion"),(0,i.kt)("p",null,"I'd love it if there was a way to do this without an Azure Function. Imagine a ",(0,i.kt)("inlineCode",{parentName:"p"},"staticwebapp.config.js")," that could be used to configure redirects. That would be awesome. But for now, this is a pretty good solution. Thanks to Anthony Chu for the inspiration and the example. (And thanks to the Nuxt.js team for the example too!)"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://github.com/johnnyreilly/blog.johnnyreilly.com/pull/384"},"If you'd like to see what it looked like when this landed in this very blog, then look at this pull request"),"."))}h.isMDXComponent=!0},52606:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/images/screenshot-redirect-in-chrome-devtools-6e20527e1021498c5e0dedec16153dfa.png"},13449:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/images/screenshot-tweet-azure-function-redirect-16535320bd761808f4da0f64250fade3.webp"},84949:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/images/title-image-8e14b55a0d1eda8f92a7d486b1b3c664.png"}}]);