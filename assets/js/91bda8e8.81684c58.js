"use strict";(self.webpackChunkjohnnyreilly_com=self.webpackChunkjohnnyreilly_com||[]).push([[45919],{42880:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>h,contentTitle:()=>i,default:()=>d,frontMatter:()=>a,metadata:()=>r,toc:()=>l});var n=s(74848),o=s(28453);const a={slug:"ms-teams-direct-message-api",title:"Teams Direct Message API with Power Automate",authors:["johnnyreilly",{name:"Chris Tacey-Green",title:"Engineer, Architect, Human",url:"https://github.com/ctaceygreen",image_url:"https://avatars.githubusercontent.com/u/11404995?v=4"}],tags:[],image:"./title-image.png",description:"Teams does not have a public API for sending direct messages to people rather than channels. This post describes a workaround using Power Automate and the Teams Notification API.",hide_table_of_contents:!1},i=void 0,r={permalink:"/ms-teams-direct-message-api",editUrl:"https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2023-05-04-ms-teams-direct-message-api/index.md",source:"@site/blog/2023-05-04-ms-teams-direct-message-api/index.md",title:"Teams Direct Message API with Power Automate",description:"Teams does not have a public API for sending direct messages to people rather than channels. This post describes a workaround using Power Automate and the Teams Notification API.",date:"2023-05-04T00:00:00.000Z",tags:[],readingTime:9.725,hasTruncateMarker:!0,authors:[{name:"John Reilly",title:"OSS Engineer - TypeScript, Azure, React, Node.js, .NET",url:"https://johnnyreilly.com/about",imageURL:"https://johnnyreilly.com/img/profile.jpg",key:"johnnyreilly",page:null},{name:"Chris Tacey-Green",title:"Engineer, Architect, Human",url:"https://github.com/ctaceygreen",image_url:"https://avatars.githubusercontent.com/u/11404995?v=4",imageURL:"https://avatars.githubusercontent.com/u/11404995?v=4",key:null,page:null}],frontMatter:{slug:"ms-teams-direct-message-api",title:"Teams Direct Message API with Power Automate",authors:["johnnyreilly",{name:"Chris Tacey-Green",title:"Engineer, Architect, Human",url:"https://github.com/ctaceygreen",image_url:"https://avatars.githubusercontent.com/u/11404995?v=4",imageURL:"https://avatars.githubusercontent.com/u/11404995?v=4"}],tags:[],image:"./title-image.png",description:"Teams does not have a public API for sending direct messages to people rather than channels. This post describes a workaround using Power Automate and the Teams Notification API.",hide_table_of_contents:!1},unlisted:!1,prevItem:{title:"Migrating Azure Functions from JSDoc JavaScript to TypeScript",permalink:"/migrating-azure-functions-from-jsdoc-javascript-to-typescript"},nextItem:{title:"Docusaurus: Structured Data FAQs with MDX",permalink:"/docusaurus-structured-data-faqs-mdx"}},h={image:s(63554).A,authorsImageUrls:[void 0,void 0]},l=[{value:"What are we trying to do?",id:"what-are-we-trying-to-do",level:2},{value:"Power Automate",id:"power-automate",level:2},{value:"Setting up the Power Automate workflow",id:"setting-up-the-power-automate-workflow",level:2},{value:"Triggering the Power Automate workflow",id:"triggering-the-power-automate-workflow",level:2},{value:"Testing it out",id:"testing-it-out",level:2},{value:"User blocked the conversation with the bot",id:"user-blocked-the-conversation-with-the-bot",level:2},{value:"Conclusion",id:"conclusion",level:2}];function c(e){const t={a:"a",code:"code",em:"em",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(t.p,{children:["I've written previously about ",(0,n.jsx)(t.a,{href:"/teams-notification-webhooks",children:"sending Teams notifications using a webhook"}),", and it's a technique I've used a lot. But I've always wanted to be able to send a direct message to a user, and that's not possible with the webhook approach. I work with a marvellous fellow named Chris Tacey-Green, and he's figured out a way to do this using Power Automate and the Teams Notification API. I'm going to describe how he did it here, with a little help from him."]}),"\n",(0,n.jsx)(t.p,{children:"It's probably worth saying, both Chris and I work for Investec, and we're going to share some of the things we've learned about using Teams and Power Automate in the hope that it's useful to others. But we're not speaking on behalf of Investec, and we're not suggesting that this is the best way to do things. This is likely in the \"do things that do not scale\" category. Significantly though, it works!"}),"\n",(0,n.jsx)(t.p,{children:"You will see some screenshots of our internal Teams environment, but we've tried to keep them to a minimum, and we're not going to share any sensitive information."}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"title image reading &quot;Teams Direct Message API with Power Automate&quot; with a Teams logo",src:s(48439).A+"",width:"800",height:"450",loading:"eager",fetchpriority:"high"})}),"\n",(0,n.jsx)(t.h2,{id:"what-are-we-trying-to-do",children:"What are we trying to do?"}),"\n",(0,n.jsx)(t.p,{children:"Teams is a great way to keep people informed of what's going on. But sometimes you want to send a message to a specific person. You can @mention them in a channel, but that's not the same as a direct message. And you can send them an email, but that's not the same as a direct message either. What we want is a way to send a direct message to a user in Teams, via an API. Because we want to automate. Tragically, sending DMs in Teams via an API is not supported at the time of writing (or if it is - please let us know!)"}),"\n",(0,n.jsx)(t.p,{children:"All is not lost."}),"\n",(0,n.jsx)(t.h2,{id:"power-automate",children:"Power Automate"}),"\n",(0,n.jsx)(t.p,{children:"Power Automate is a tool that allows you to automate tasks. It's a low-code/no-code tool that allows you to create workflows that can be triggered by events. It's a great tool for automating tasks. And it's a great tool for sending direct messages in Teams. Or so it turns out."}),"\n",(0,n.jsx)(t.p,{children:"You see, it's possible to send a notification to a user in Teams using the Teams Notification API. And it's possible to trigger a Power Automate workflow using the \"when a new channel message is added\" trigger. So if we can get a notification to the Teams Notification API, we can trigger a Power Automate workflow. And if we can trigger a Power Automate workflow, we can send a direct message to a user in Teams."}),"\n",(0,n.jsx)(t.p,{children:"This post will do two things:"}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsx)(t.li,{children:"Describe how to set up a Power Automate workflow that sends a direct message to a user in Teams"}),"\n",(0,n.jsx)(t.li,{children:"Describe how to trigger that workflow using the Teams Notification API and Adaptive Card messages"}),"\n"]}),"\n",(0,n.jsx)(t.h2,{id:"setting-up-the-power-automate-workflow",children:"Setting up the Power Automate workflow"}),"\n",(0,n.jsxs)(t.p,{children:["First things first, we need to create a Power Automate workflow that sends a direct message to a user in Teams. This is pretty straightforward, but when it came to doing this, I knew ",(0,n.jsx)(t.em,{children:"nothing"}),"."]}),"\n",(0,n.jsx)(t.p,{children:"Before we start this, I should warn you there's going to be lots of screenshots. As far as I'm aware, there's not a code-first way to create Power Automate flows, so point and click is the only game in town."}),"\n",(0,n.jsx)(t.p,{children:"The first thing to do, is fire up Teams and install the Power Automate app:"}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"screenshot of installing the Power Automate app",src:s(11601).A+"",width:"1808",height:"600",loading:"lazy"})}),"\n",(0,n.jsx)(t.p,{children:'This allows us to access the Power Automate app. There we can create a new workflow (from blank) with the "when a new channel message is added" trigger:'}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"screenshot of creating the Power Automate flow with the when a new channel message is added trigger",src:s(97109).A+"",width:"2692",height:"1152",loading:"lazy"})}),"\n",(0,n.jsx)(t.p,{children:"We then need to select the team and channel that we want to trigger the workflow:"}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"screenshot of selecting the team and channel",src:s(59885).A+"",width:"2692",height:"692",loading:"lazy"})}),"\n",(0,n.jsx)(t.p,{children:"You'll note in the screenshot above, we've got a dedicated channel for this workflow. This is because we don't want to disturb channels people are already using with the messages we will write to this channel. To all intents and purposes, this channel could actually be invisible to users - we just need it to exist to be our carrier pidgeon."}),"\n",(0,n.jsx)(t.p,{children:'With the trigger in place, we need to create the action. We\'re going to use the "apply to each" control, which will run for every message that comes through. We want to use the "Message mentions" output, which will give us the user that was mentioned in the message. We don\'t want to use the similarly named "Message mentions item":'}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"screenshot of selecting the output from previous steps",src:s(67484).A+"",width:"2702",height:"1410",loading:"lazy"})}),"\n",(0,n.jsx)(t.p,{children:'The message mention gives us our user, we\'ll then use the "Get user profile (V2)" operation so we can look up that user up.'}),"\n",(0,n.jsx)(t.p,{children:"It's at this point, that we start to do something slightly more complicated in the Power Automate UI. We're going to need to supply an id to the \"Get user profile (V2)\" operation. We're going to use an expression to determine this id. The expression we're going to use is:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:"triggerOutputs()?['body/mentions'][0].mentioned.user.id\n"})}),"\n",(0,n.jsx)(t.p,{children:"This expression is operating on JSON similar to the following:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-json",children:'{\n  "@odata.type": "#microsoft.graph.chatMessage",\n  "etag": "1683099494281",\n  "messageType": "message",\n  "createdDateTime": "2023-05-03T07:38:14.281Z",\n  "lastModifiedDateTime": "2023-05-03T07:38:14.281Z",\n  // ...\n  "mentions": [\n    {\n      "id": 0,\n      "mentionText": "John Reilly",\n      "mentioned": {\n        "application": null,\n        "device": null,\n        "conversation": null,\n        "tag": null,\n        "user": {\n          "@odata.type": "#microsoft.graph.teamworkUserIdentity",\n          "id": "my-id-it-is-a-guid",\n          "displayName": "John Reilly",\n          "userIdentityType": "aadUser"\n        }\n      }\n    }\n  ]\n  // ...\n}\n'})}),"\n",(0,n.jsx)(t.p,{children:'So that expression is just some JavaScript that gets us to the value we need; the id of the first mentioned user. We provide that in the "Expression" field and then click the "OK" button:'}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"screenshot of entering that into PA",src:s(64159).A+"",width:"2702",height:"1410",loading:"lazy"})}),"\n",(0,n.jsx)(t.p,{children:'Now it\'s time for our final action - sending on the message with the "post card in chat or channel" operation:'}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"screenshot of adding a post card entry",src:s(44565).A+"",width:"2702",height:"1622",loading:"lazy"})}),"\n",(0,n.jsxs)(t.p,{children:['We\'ll post as the Flow bot, post in a chat with the Flow bot and make our recipient "Mail" (which behind the scenes is the expression ',(0,n.jsx)(t.code,{children:"outputs('Get_user_profile_(V2)')?['body/mail']"}),")."]}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"screenshot of adding the recipient mail",src:s(8703).A+"",width:"2702",height:"1642",loading:"lazy"})}),"\n",(0,n.jsx)(t.p,{children:"Finally, it's once more expression time, as we use this value for our Adaptive Card:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:"triggerOutputs()?['body/attachments'][0]['content']\n"})}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"screenshot of entering expression",src:s(75518).A+"",width:"2702",height:"1714",loading:"lazy"})}),"\n",(0,n.jsx)(t.p,{children:"Hopefully, what you've realised is that we're just taking the Adaptive Card from the message that triggered the workflow and passing it on to the recipient. We're intentionally doing as little as possible in the Power Automate workflow, as it's the trickiest part of our solution to work with. (Debugging Power Automate workflows is possible, but it's not the most fun you'll ever have.)"}),"\n",(0,n.jsx)(t.p,{children:"We now have our complete workflow, and it looks like this:"}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"screenshot of the Power Automate workflow",src:s(89711).A+"",width:"1324",height:"1522",loading:"lazy"})}),"\n",(0,n.jsx)(t.h2,{id:"triggering-the-power-automate-workflow",children:"Triggering the Power Automate workflow"}),"\n",(0,n.jsx)(t.p,{children:"Whilst we have a workflow, we don't have anything to trigger it yet. To do that, we'll need to send a message to the channel we created earlier. We can do this using the Teams Notification API. And it needs to be a special kind of message; it needs to be an Adaptive Card, which includes a mention of the person we want to direct message."}),"\n",(0,n.jsxs)(t.p,{children:["My post on ",(0,n.jsx)(t.a,{href:"/teams-notification-webhooks",children:"sending Teams notifications using a webhook"})," describes how to send a message to a channel using the Teams Notification API. We're going to use the same technique, but we're going to send an ",(0,n.jsx)(t.a,{href:"https://github.com/Microsoft/AdaptiveCards/",children:"Adaptive Card"})," instead of a plain message. I won't repeat the details of creating a webhook connector here, instead let's just focus on what we need to send to the API."]}),"\n",(0,n.jsxs)(t.p,{children:["Ultimately, it's just a ",(0,n.jsx)(t.a,{href:"/node-18-axios-and-unsafe-legacy-renegotiation-disabled",children:"POST request to the webhook connector"}),", with a JSON body that looks like this:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-json",children:'{\n  "type": "message",\n  "attachments": [\n    {\n      "contentType": "application/vnd.microsoft.card.adaptive",\n      "contentUrl": null,\n      "content": {\n        "type": "AdaptiveCard",\n        "version": "1.0",\n        "body": [\n          {\n            "type": "TextBlock",\n            "size": "medium",\n            "text": "Hey <at>John Reilly</at>!\\n\\nYou have 102 unresolved secret findings! Click on the button below to view them.",\n            "wrap": true\n          }\n        ],\n        "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",\n        "msteams": {\n          "entities": [\n            {\n              "type": "mention",\n              "text": "<at>John Reilly</at>",\n              "mentioned": {\n                "id": "John.Reilly@investec.co.uk",\n                "name": "John Reilly"\n              }\n            }\n          ]\n        },\n        "actions": [\n          {\n            "type": "Action.OpenUrl",\n            "title": "View findings",\n            "url": "https://some.url.com/",\n            "role": "button"\n          }\n        ]\n      }\n    }\n  ]\n}\n'})}),"\n",(0,n.jsxs)(t.p,{children:["The part that's relevant to us is the ",(0,n.jsx)(t.code,{children:"msteams"})," property. This is where we specify the user we want to mention. We do this by specifying the ",(0,n.jsx)(t.code,{children:"id"})," and ",(0,n.jsx)(t.code,{children:"name"})," properties. The ",(0,n.jsx)(t.code,{children:"id"})," property is the email address of the user we want to mention. The ",(0,n.jsx)(t.code,{children:"name"})," property is the display name of the user we want to mention."]}),"\n",(0,n.jsxs)(t.p,{children:["This is the secret sauce that allows our Power Automate flow to work. It reads these values and uses them to send a message to the user we want to mention. Alongside that, the ",(0,n.jsx)(t.code,{children:"msteams.entities[].text"})," property must be in your message body. That's what Teams uses to link the mention to the part of the message that's \"doing the mentioning\" (thanks Chris for pointing this out)."]}),"\n",(0,n.jsx)(t.h2,{id:"testing-it-out",children:"Testing it out"}),"\n",(0,n.jsx)(t.p,{children:"So far, so screenshots and code. Does it work? Let's find out."}),"\n",(0,n.jsx)(t.p,{children:"When we run our tool for triggering the Teams Notification API, we get a message in our channel:"}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"screenshot of the adaptive card in the shared teams channel",src:s(80310).A+"",width:"1108",height:"528",loading:"lazy"})}),"\n",(0,n.jsx)(t.p,{children:"Note that it has the @mention of the user: me. Now that this message in the relevant channel exists, our Power Automate workflow will be triggered. I've seen it take between 2 and 10 minutes for the trigger to fire. When it does, the flow runs and we get a direct message from the Flow bot:"}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"screenshot of the adaptive card in a teams direct chat",src:s(6219).A+"",width:"1108",height:"440",loading:"lazy"})}),"\n",(0,n.jsxs)(t.p,{children:["And this is our handrolled direct message to a user in Microsoft Teams. It's the same message we sent to the channel, just forwarded on by the Flow bot. Brilliant. The eagle eyed amongst you will note the ugly ",(0,n.jsx)(t.code,{children:'<at id="0">John Reilly</at>'}),"; we're losing something in our forwarding. This could be remedied if we made our Power Automate flow a little more complex, but as mentioned, we're trying to keep our flow as simple as possible. The ",(0,n.jsx)(t.code,{children:'<at id="0">'})," is a small price to pay for the simplicity of our flow."]}),"\n",(0,n.jsx)(t.h2,{id:"user-blocked-the-conversation-with-the-bot",children:"User blocked the conversation with the bot"}),"\n",(0,n.jsx)(t.p,{children:"As you look at your Power Automate Flow runs, you can sometimes spot failures along these lines:"}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"screenshot of a failed run of the power automate flow",src:s(65701).A+"",width:"2892",height:"1460",loading:"lazy"})}),"\n",(0,n.jsx)(t.p,{children:"If you look to the right on that screenshot you can see the error message:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-json",children:'Request to the Bot framework failed with error:\n\n{\n  "error": {\n    "code":"ConversationBlockedByUser",\n    "message":"User blocked the conversation with the bot."\n  }\n}\n'})}),"\n",(0,n.jsx)(t.p,{children:'These kinds of failures appear to be a consequence of someone having blocked the Power Automate Flow bot. If you dig into the inputs ("Click to download" in the screenshot) you can discover the user who blocked the bot and have a conversation with them about it. Unblocking seems to be fairly straightforward; you just need to right-click / ctrl-click on the Power Automate app in Teams and select "Unblock":'}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"screenshot of unblocking the bot",src:s(36025).A+"",width:"552",height:"372",loading:"lazy"})}),"\n",(0,n.jsx)(t.p,{children:"In our experience, this is a rare occurrence, but it's worth being aware of."}),"\n",(0,n.jsx)(t.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,n.jsx)(t.p,{children:"Together we've built a mechanism for sending a direct message to a user in Microsoft Teams. We've used the Teams Notification API to send a message to a channel, and we've used Power Automate to pick up that message and send it on to the user we want to mention."}),"\n",(0,n.jsx)(t.p,{children:"Thanks so much to Chris for coming up with this novel way of sending a direct message to a user in Microsoft Teams. I hope you've found this post useful."})]})}function d(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(c,{...e})}):c(e)}},63554:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/title-image-a6e4f918adb5839bf03ac87c472924d7.png"},80310:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/screenshot-adaptive-card-in-channel-62b838ceffbf213ac73137981438ebd5.webp"},11601:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/screenshot-power-automate-app-93008b2c2df59ecd1e4240befd8fc089.webp"},64159:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/screenshot-power-automate-expression1-ce474f69aee8463faeaeae87a29e0d75.webp"},75518:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/screenshot-power-automate-expression2-90b50b16b563542f6f4f837e91c85e27.webp"},65701:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/screenshot-power-automate-flow-failure-50afaf30d2224e5204af76dc527bd23a.webp"},44565:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/screenshot-power-automate-post-card-3a126a984889704f0a60fe98812f22e4.webp"},8703:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/screenshot-power-automate-recipient-mail-f1b5de50e8651cc1643403275627140f.webp"},67484:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/screenshot-power-automate-select-output-previous-steps-ee81326b0a8ea1edfba388c90da51d5a.webp"},59885:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/screenshot-power-automate-team-and-channel-630a906c51baeb51d01e32f138e5b633.webp"},97109:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/screenshot-power-automate-when-a-new-channel-message-is-added-9acde451426fcf22b86a9fff4b7fc335.webp"},89711:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/screenshot-power-automate-workflow-7dc937469082c29ba7d6b13a7f1b8db4.webp"},6219:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/screenshot-teams-direct-message-ee88aa5153ef11a2dbfeee64ff3b5401.webp"},36025:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/screenshot-unblock-the-bot-14f3e24135908174b39e6ef4b0fa8660.webp"},48439:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/title-image-a6e4f918adb5839bf03ac87c472924d7.png"},28453:(e,t,s)=>{s.d(t,{R:()=>i,x:()=>r});var n=s(96540);const o={},a=n.createContext(o);function i(e){const t=n.useContext(a);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),n.createElement(a.Provider,{value:t},e.children)}}}]);