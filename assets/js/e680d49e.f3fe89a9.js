"use strict";(self.webpackChunkjohnnyreilly_com=self.webpackChunkjohnnyreilly_com||[]).push([["64917"],{58824:function(e,t,r){r.r(t),r.d(t,{assets:function(){return c},contentTitle:function(){return s},default:function(){return p},frontMatter:function(){return o},metadata:function(){return n},toc:function(){return l}});var n=r(84093),i=r(85893),a=r(50065);let o={slug:"private-bicep-registry-authentication-azureresourcemanagertemplatedeployment",title:"Private Bicep registry authentication with AzureResourceManagerTemplateDeployment@3",authors:"johnnyreilly",tags:["bicep","azure devops"],image:"./title-image.png",description:"You can deploy Bicep to Azure with the dedicated Azure DevOps task; however authentication to private Bicep registries is not supported.  This post shares a workaround.",hide_table_of_contents:!1},s=void 0,c={image:r(80683).Z,authorsImageUrls:[void 0]},l=[{value:"&quot;Unable to restore the module... Status: 401 (Unauthorized)&quot;",id:"unable-to-restore-the-module-status-401-unauthorized",level:2},{value:"Workaround",id:"workaround",level:2},{value:"In the box, in the future?",id:"in-the-box-in-the-future",level:2}];function u(e){let t={a:"a",code:"code",em:"em",h2:"h2",img:"img",p:"p",pre:"pre",...(0,a.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(t.p,{children:["If you deploy Bicep templates to Azure in Azure DevOps, you'll likely use the dedicated Azure DevOps task; the catchily named ",(0,i.jsx)(t.a,{href:"https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/azure-resource-manager-template-deployment-v3?view=azure-pipelines",children:(0,i.jsx)(t.code,{children:"AzureResourceManagerTemplateDeployment@3"})}),". This task has had support for deploying Bicep since early 2022. But whilst vanilla Bicep is supported, there's a use case which isn't supported; private Bicep registries."]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"title image reading &quot;Private Bicep registry authentication with AzureResourceManagerTemplateDeployment@3&quot; with the Bicep, Azure and Azure DevOps logos",src:r(17755).Z+"",width:"1600",height:"900",loading:"eager",fetchpriority:"high"})}),"\n",(0,i.jsx)(t.h2,{id:"unable-to-restore-the-module-status-401-unauthorized",children:'"Unable to restore the module... Status: 401 (Unauthorized)"'}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.a,{href:"https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/private-module-registry?tabs=azure-powershell",children:"Private Bicep registries"})," are a great way to share Bicep modules across your organisation. We use them in the organisation that I'm part of; it's a good a way to help us move faster and to share common security baselines."]}),"\n",(0,i.jsxs)(t.p,{children:["Alas it turns out that the ",(0,i.jsx)(t.code,{children:"AzureResourceManagerTemplateDeployment@3"})," task doesn't presently play well with private Bicep registries. This is because it's necessary to authenticate to a private registry before you can consume modules. And that's not supported by the ",(0,i.jsx)(t.code,{children:"AzureResourceManagerTemplateDeployment@3"})," task. What does that mean? Well take a look at the following Azure Pipeline:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-yml",children:"- task: AzureResourceManagerTemplateDeployment@3\n  name: DeployInfra\n  displayName: Deploy infra\n  retryCountOnTaskFailure: 3\n  inputs:\n    deploymentScope: Resource Group\n    azureResourceManagerConnection: ${{ variables.serviceConnection }}\n    subscriptionId: $(subscriptionId)\n    action: Create Or Update Resource Group\n    resourceGroupName: $(resourceGroupName)\n    location: $(location)\n    templateLocation: Linked artifact\n    csmFile: 'infra/main.bicep'\n"})}),"\n",(0,i.jsxs)(t.p,{children:["You'll note that it passes a Bicep file to the ",(0,i.jsx)(t.code,{children:"csmFile"})," property. This is the file that will be deployed. But what if that file references modules from a private registry? Well, you'll see an error like this:"]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"screenshot of the failing pipeline including the text &#39;Error BCP192: Unable to restore the module with reference &quot;br.azurecr.io/bicep/ice/providers/document-db/database-accounts.3&quot;: Service request failed.&#39;",src:r(1316).Z+"",width:"2016",height:"740",loading:"lazy"})}),"\n",(0,i.jsxs)(t.p,{children:["As you can see from the ",(0,i.jsx)(t.code,{children:"Status: 401 (Unauthorized)"}),", we have an authentication problem; the task doesn't know how to authenticate to the private registry."]}),"\n",(0,i.jsx)(t.h2,{id:"workaround",children:"Workaround"}),"\n",(0,i.jsxs)(t.p,{children:["You might think, \"oh well that's it then, I can't use private Bicep registries with the ",(0,i.jsx)(t.code,{children:"AzureResourceManagerTemplateDeployment@3"})," task\". But you'd be wrong. There's a workaround. Essentially, when the ",(0,i.jsx)(t.code,{children:"AzureResourceManagerTemplateDeployment@3"})," task runs, it attempts to restore the modules it needs as a first step to compiling the Bicep in to ARM. But it only does this if it needs to. If we perform the restore manually first, then the task won't need to do it again. That's the trick."]}),"\n",(0,i.jsxs)(t.p,{children:["Before the ",(0,i.jsx)(t.code,{children:"AzureResourceManagerTemplateDeployment@3"})," task runs, we can run a task to restore the modules. We can use the ",(0,i.jsx)(t.code,{children:"AzureCLI@2"})," task to do this. Here's an example:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-yml",children:"- task: AzureCLI@2\n  displayName: Bicep restore\n  inputs:\n    azureSubscription: service-connection-with-access-to-registry\n    scriptType: bash\n    scriptLocation: inlineScript\n    inlineScript: |\n      bicep restore infra/main.bicep\n"})}),"\n",(0,i.jsxs)(t.p,{children:["Where ",(0,i.jsx)(t.code,{children:"service-connection-with-access-to-registry"})," is an Azure Resource Manager service connection using service principal authentication which has access to the private Bicep registry."]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"screenshot of service connection",src:r(58570).Z+"",width:"640",height:"524",loading:"lazy"})}),"\n",(0,i.jsxs)(t.p,{children:["So if the above task runs ",(0,i.jsx)(t.em,{children:"prior"})," to the ",(0,i.jsx)(t.code,{children:"AzureResourceManagerTemplateDeployment@3"})," task, then the modules will be restored and the ",(0,i.jsx)(t.code,{children:"AzureResourceManagerTemplateDeployment@3"})," task will be able to compile the Bicep in to ARM and deploy it to Azure. This solves the problem; albeit at the cost of an extra task in the pipeline."]}),"\n",(0,i.jsx)(t.h2,{id:"in-the-box-in-the-future",children:"In the box, in the future?"}),"\n",(0,i.jsxs)(t.p,{children:["It would be tremendous if authentication to private Bicep registries was supported by the ",(0,i.jsx)(t.code,{children:"AzureResourceManagerTemplateDeployment@3"})," task. I've raised a feature request for this ",(0,i.jsx)(t.a,{href:"https://github.com/microsoft/azure-pipelines-tasks/issues/18426",children:"here"}),". If you'd like to see this too, please do add your voice to the issue."]})]})}function p(e={}){let{wrapper:t}={...(0,a.a)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(u,{...e})}):u(e)}},80683:function(e,t,r){r.d(t,{Z:function(){return n}});let n=r.p+"assets/images/title-image-b1eca5c7e68137b8d193bf8181039de0.png"},1316:function(e,t,r){r.d(t,{Z:function(){return n}});let n=r.p+"assets/images/screenshot-authentication-failure-6d2c5403c6ded939008de620567adabd.png"},58570:function(e,t,r){r.d(t,{Z:function(){return n}});let n=r.p+"assets/images/screenshot-service-connection-48c335e1124eb2d6e48ed253fcb67782.webp"},17755:function(e,t,r){r.d(t,{Z:function(){return n}});let n=r.p+"assets/images/title-image-b1eca5c7e68137b8d193bf8181039de0.png"},50065:function(e,t,r){r.d(t,{Z:function(){return s},a:function(){return o}});var n=r(67294);let i={},a=n.createContext(i);function o(e){let t=n.useContext(a);return n.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),n.createElement(a.Provider,{value:t},e.children)}},84093:function(e){e.exports=JSON.parse('{"permalink":"/private-bicep-registry-authentication-azureresourcemanagertemplatedeployment","editUrl":"https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2023-06-02-private-bicep-registry-authentication-azureresourcemanagertemplatedeployment/index.md","source":"@site/blog/2023-06-02-private-bicep-registry-authentication-azureresourcemanagertemplatedeployment/index.md","title":"Private Bicep registry authentication with AzureResourceManagerTemplateDeployment@3","description":"You can deploy Bicep to Azure with the dedicated Azure DevOps task; however authentication to private Bicep registries is not supported.  This post shares a workaround.","date":"2023-06-02T00:00:00.000Z","tags":[{"inline":false,"label":"Bicep","permalink":"/tags/bicep","description":"The Bicep language for Azure Resource Manager templates."},{"inline":false,"label":"Azure DevOps","permalink":"/tags/azure-devops","description":"The Azure DevOps suite of tools."}],"readingTime":2.69,"hasTruncateMarker":true,"authors":[{"name":"John Reilly","title":"OSS Engineer - TypeScript, Azure, React, Node.js, .NET","url":"https://johnnyreilly.com/about","imageURL":"https://johnnyreilly.com/img/profile.jpg","key":"johnnyreilly","page":null}],"frontMatter":{"slug":"private-bicep-registry-authentication-azureresourcemanagertemplatedeployment","title":"Private Bicep registry authentication with AzureResourceManagerTemplateDeployment@3","authors":"johnnyreilly","tags":["bicep","azure devops"],"image":"./title-image.png","description":"You can deploy Bicep to Azure with the dedicated Azure DevOps task; however authentication to private Bicep registries is not supported.  This post shares a workaround.","hide_table_of_contents":false},"unlisted":false,"prevItem":{"title":"Azure Container Apps, Easy Auth and .NET authentication","permalink":"/azure-container-apps-easy-auth-and-dotnet-authentication"},"nextItem":{"title":"Static Web Apps CLI and Node.js 18: could not connect to API","permalink":"/static-web-apps-cli-node-18-could-not-connect-to-api"}}')}}]);