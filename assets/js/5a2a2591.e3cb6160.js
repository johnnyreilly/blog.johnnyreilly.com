"use strict";(self.webpackChunkjohnnyreilly_com=self.webpackChunkjohnnyreilly_com||[]).push([[1714],{8405:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>r,default:()=>h,frontMatter:()=>i,metadata:()=>o,toc:()=>l});var s=n(85893),a=n(11151);const i={slug:"azure-standard-tests-with-bicep",title:"Azure standard availability tests with Bicep",authors:"johnnyreilly",tags:["azure","bicep"],image:"./title-image.png",hide_table_of_contents:!1,description:"Learn how to deploy Azure standard tests using Bicep! This post goes through the process and includes a complete code snippet."},r=void 0,o={permalink:"/azure-standard-tests-with-bicep",editUrl:"https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2021-11-18-azure-standard-tests-with-bicep/index.md",source:"@site/blog/2021-11-18-azure-standard-tests-with-bicep/index.md",title:"Azure standard availability tests with Bicep",description:"Learn how to deploy Azure standard tests using Bicep! This post goes through the process and includes a complete code snippet.",date:"2021-11-18T00:00:00.000Z",formattedDate:"November 18, 2021",tags:[{label:"azure",permalink:"/tags/azure"},{label:"bicep",permalink:"/tags/bicep"}],readingTime:5.75,hasTruncateMarker:!0,authors:[{name:"John Reilly",title:"OSS Engineer - TypeScript, Azure, React, Node.js, .NET",url:"https://johnnyreilly.com/about",imageURL:"https://johnnyreilly.com/img/profile.jpg",key:"johnnyreilly"}],frontMatter:{slug:"azure-standard-tests-with-bicep",title:"Azure standard availability tests with Bicep",authors:"johnnyreilly",tags:["azure","bicep"],image:"./title-image.png",hide_table_of_contents:!1,description:"Learn how to deploy Azure standard tests using Bicep! This post goes through the process and includes a complete code snippet."},unlisted:!1,prevItem:{title:"TypeScript vs JSDoc JavaScript",permalink:"/typescript-vs-jsdoc-javascript"},nextItem:{title:"NSwag generated C# client: Open API property name clashes and decimal types rather than double",permalink:"/nswag-generated-c-sharp-client-property-name-clash"}},d={image:n(67699).Z,authorsImageUrls:[void 0]},l=[{value:"What are standard tests?",id:"what-are-standard-tests",level:2},{value:"Standard test Bicep",id:"standard-test-bicep",level:2},{value:"Locations / populations",id:"locations--populations",level:3},{value:"The <code>hidden-link</code> tag",id:"the-hidden-link-tag",level:3},{value:"App insights and standard tests share a resource group",id:"app-insights-and-standard-tests-share-a-resource-group",level:3},{value:"Using <code>standard-test.bicep</code>",id:"using-standard-testbicep",level:2},{value:"Azure Pipelines test",id:"azure-pipelines-test",level:2}];function c(e){const t={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.p,{children:"Azure standard tests are a tremendous way to monitor the uptime of your services in Azure. Sometimes also called availability tests, web tests and ping tests, this post goes through how to deploy one using Bicep. It also looks at some of the gotchas that you may encounter as you're setting it up."}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"title image reading &quot;Azure standard availability tests with Bicep&quot; with a Bicep logo and Azure logos",src:n(58406).Z+"",width:"1600",height:"900",loading:"eager",fetchpriority:"high"})}),"\n",(0,s.jsx)(t.h2,{id:"what-are-standard-tests",children:"What are standard tests?"}),"\n",(0,s.jsxs)(t.p,{children:["To quote the ",(0,s.jsx)(t.a,{href:"https://docs.microsoft.com/en-us/azure/azure-monitor/app/availability-standard-tests",children:"docs"}),":"]}),"\n",(0,s.jsxs)(t.blockquote,{children:["\n",(0,s.jsx)(t.p,{children:"Standard tests are a single request test that is similar to the URL ping test but more advanced. In addition to validating whether an endpoint is responding and measuring the performance, Standard tests also includes SSL certificate validity, proactive lifetime check, HTTP request verb (for example GET,HEAD,POST, etc.), custom headers, and custom data associated with your HTTP request."}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"So we can use these to:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"send requests to a URL"}),"\n",(0,s.jsx)(t.li,{children:"from a variety of geographic locations"}),"\n",(0,s.jsx)(t.li,{children:"and determine if it is responding with a 200 status code"}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"The URL may be one of our own service URLs, but it could be checking any kind of URL. It's web specific, not Azure specific."}),"\n",(0,s.jsx)(t.h2,{id:"standard-test-bicep",children:"Standard test Bicep"}),"\n",(0,s.jsxs)(t.p,{children:["Now we're going to write a Bicep module that provisions a standard test named ",(0,s.jsx)(t.code,{children:"standard-test.bicep"}),":"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bicep",children:"@description('Tags that our resources need')\nparam tags object\n\n@description('The resource id of the app insights which the webtest will reference')\nparam appInsightsResourceId string\n\n@description('The name of the webtest to create')\nparam standardTestName string\n\n@description('URL to test')\nparam urlToTest string\n\n@description('Interval in seconds between test runs for this WebTest. Default value is 300.')\nparam frequency int = 300\n\n@description('Seconds until this WebTest will timeout and fail. Default value is 30.')\nparam timeout int = 30\n\n// useful reference:\n// https://docs.microsoft.com/en-us/azure/azure-monitor/app/monitor-web-app-availability#azure\n@allowed([\n  'emea-au-syd-edge' // Australia\u202fEast\n  'latam-br-gru-edge' // Brazil South\n  'us-fl-mia-edge' // Central US\n  'apac-hk-hkn-azr' // East Asia\n  'us-va-ash-azr' // East US\n  'emea-ch-zrh-edge' // France South (Formerly France Central)\n  'emea-fr-pra-edge' // France Central\n  'apac-jp-kaw-edge' // Japan East\n  'emea-gb-db3-azr' // North Europe\n  'us-il-ch1-azr' // North Central US\n  'us-tx-sn1-azr' // South Central US\n  'apac-sg-sin-azr' // Southeast Asia\n  'emea-se-sto-edge' // UK West\n  'emea-nl-ams-azr' // West Europe\n  'us-ca-sjc-azr' // West US\n  'emea-ru-msa-edge' // UK South\n])\n@description('The populations (locations) for the test')\nparam testPopulations array = [\n  'emea-se-sto-edge' // UK West\n  'emea-ru-msa-edge' // UK South\n  'emea-gb-db3-azr' // North Europe\n  'us-va-ash-azr' // East US\n  'apac-sg-sin-azr' // Southeast Asia\n]\n\nvar tagsWithHiddenLink = union({\n  'hidden-link:${appInsightsResourceId}': 'Resource'\n}, tags)\n\nresource standardWebTest 'Microsoft.Insights/webtests@2018-05-01-preview' = {\n  name: standardTestName\n  location: resourceGroup().location\n  tags: tagsWithHiddenLink\n  kind: 'ping'\n  properties: {\n    SyntheticMonitorId: urlToTest\n    Name: urlToTest\n    Description: null\n    Enabled: true\n    Frequency: frequency\n    Timeout: timeout\n    Kind: 'standard'\n    RetryEnabled: true\n    Locations: [for testPopulation in testPopulations: {\n      Id: testPopulation\n    }]\n    Configuration: null\n    Request: {\n      RequestUrl: urlToTest\n      Headers: null\n      HttpVerb: 'GET'\n      RequestBody: null\n      ParseDependentRequests: false\n      FollowRedirects: null\n    }\n    ValidationRules: {\n      ExpectedHttpStatusCode: 200\n      IgnoreHttpsStatusCode: false\n      ContentValidation: null\n      SSLCheck: true\n      SSLCertRemainingLifetimeCheck: 7\n    }\n  }\n}\n\noutput standardWebTestName string = standardWebTest.name\noutput standardWebTestId string = standardWebTest.id\n"})}),"\n",(0,s.jsx)(t.h3,{id:"locations--populations",children:"Locations / populations"}),"\n",(0,s.jsxs)(t.p,{children:["You'll note that a parameter to the Bicep module is ",(0,s.jsx)(t.code,{children:"testPopulations"}),". These are the geographical places where requests will be sent from. You'll note we have a default value of five populations, but these could be any of the (presently) sixteen valid values. If you were wondering where those are sourced from, ",(0,s.jsx)(t.a,{href:"https://docs.microsoft.com/en-us/azure/azure-monitor/app/availability-standard-tests#location-population-tags",children:"here is the link to the Azure docs"}),"."]}),"\n",(0,s.jsxs)(t.h3,{id:"the-hidden-link-tag",children:["The ",(0,s.jsx)(t.code,{children:"hidden-link"})," tag"]}),"\n",(0,s.jsxs)(t.p,{children:["Another significant call out should go to the ",(0,s.jsx)(t.code,{children:"hidden-link"})," tag. The ",(0,s.jsx)(t.code,{children:"hidden-link"}),' tag is a mandatory tag that connects the test (known in Azure as a "webtest") to an app insights instance.']}),"\n",(0,s.jsxs)(t.p,{children:["If you do not provide a ",(0,s.jsx)(t.code,{children:"hidden-link"})," tag, or if you try to specify a resource group other than the app insights resource group, Azure will fail to deploy your test and you may find yourself presented with an error like this in the deployments section of the Azure Portal."]}),"\n",(0,s.jsxs)(t.blockquote,{children:["\n",(0,s.jsx)(t.p,{children:"Resource should exist in the same resource group as the linked component"}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"screenshot of the Azure Portal Deployments section saying &quot;Resource should exist in the same resource group as the linked component&quot;",src:n(44013).Z+"",width:"1102",height:"241",loading:"lazy"})}),"\n",(0,s.jsxs)(t.p,{children:["In our module we set both the ",(0,s.jsx)(t.code,{children:"hidden-link"})," tag as well as the tags that have been supplied via the ",(0,s.jsx)(t.code,{children:"tags"})," parameter."]}),"\n",(0,s.jsx)(t.h3,{id:"app-insights-and-standard-tests-share-a-resource-group",children:"App insights and standard tests share a resource group"}),"\n",(0,s.jsx)(t.p,{children:"Another thing that can cause issues is the deployment of your app insights resource. It's not unusual to spin up Azure resources on demand, for a given branch of your source code. Those resources will be named in relation to the branch and will depend upon one another. I've never managed to successfully create an app insights resource, and reference it from a standard test within the same Bicep file. It appears to be necessary to separate the two actions, such that Azure recognises the existence of the app insights resource when the standard test is deployed."}),"\n",(0,s.jsx)(t.p,{children:"If you are working with long-lived app insights it won't be an issue for you, but if you aren't it's worth being aware of."}),"\n",(0,s.jsxs)(t.h2,{id:"using-standard-testbicep",children:["Using ",(0,s.jsx)(t.code,{children:"standard-test.bicep"})]}),"\n",(0,s.jsxs)(t.p,{children:["Our Bicep module can be invoked from another Bicep module named ",(0,s.jsx)(t.code,{children:"ping-them.bicep"})," like so:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bicep",children:"@description('Tags that our resources need')\nparam tags object\n\n@description('The name of the app insights')\nparam appInsightsName string\n\n@description('An object where the keys are the name of the web test and the values are the URL eg {\"my-standard-test\": \"https://status.azure.com/en-gb/status\"} ')\nparam standardTests object\n\nvar appInsightsResourceId = resourceId('Microsoft.Insights/components', appInsightsName)\n\nmodule standardTestsToCreate 'standard-test.bicep' = [for standardTest in items(standardTests): {\n  name: standardTest.key\n  params: {\n    tags: tags\n    appInsightsResourceId: appInsightsResourceId\n    standardTestName: standardTest.key\n    urlToTest: standardTest.value\n  }\n}]\n"})}),"\n",(0,s.jsx)(t.p,{children:"As you can see, this module itself takes a number of parameters, and will typically be invoked from some kind of continuous integration mechanism such as Azure Pipelines or GitHub Actions."}),"\n",(0,s.jsxs)(t.p,{children:["This module is written in the expectation that multiple URLs will need to be pinged, and so it has a parameter named ",(0,s.jsx)(t.code,{children:"standardTests"})," which is effectively a dictionary of key-value pairs, where the key is the name of the standard test, and the value is the URL to test."]}),"\n",(0,s.jsxs)(t.p,{children:["The module makes use of the ",(0,s.jsx)(t.a,{href:"https://docs.microsoft.com/en-us/azure/azure-resource-manager/bicep/bicep-functions-array#items",children:(0,s.jsx)(t.code,{children:"items"})})," array helper in Bicep to convert the object into an array that can be iterated over."]}),"\n",(0,s.jsx)(t.h2,{id:"azure-pipelines-test",children:"Azure Pipelines test"}),"\n",(0,s.jsxs)(t.p,{children:["We're going to use Azure Pipelines to test this out. Here's an ",(0,s.jsx)(t.code,{children:"azure-pipelines.yml"})," file:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-yml",children:'trigger:\n  - main\n\npool:\n  vmImage: ubuntu-latest\n\nsteps:\n  - checkout: self\n    submodules: true\n\n  - bash: az bicep build --file ping-them.bicep\n    displayName: \'Compile Bicep to ARM\'\n\n  - task: AzureResourceManagerTemplateDeployment@3\n    name: DeploySharedWebTests\n    displayName: Deploy Shared Web Tests\n    inputs:\n      deploymentScope: Resource Group\n      azureResourceManagerConnection: ${{ variables.serviceConnection }}\n      subscriptionId: $(subscriptionId)\n      action: Create Or Update Resource Group\n      resourceGroupName: $(resourceGroup)\n      location: $(location)\n      templateLocation: Linked artifact\n      csmFile: \'ping-them.json\' # created by bash script\n      overrideParameters: >-\n        -tags {"owner": "@johnny_reilly", "branch": "$(Build.SourceBranchName)"}\n        -appInsightsName $(appInsightsName)\n        -standardTests {"my-standard-test": "https://status.azure.com/en-gb/status"}\n      deploymentMode: Incremental\n'})}),"\n",(0,s.jsxs)(t.p,{children:["When run, it invokes our ",(0,s.jsx)(t.code,{children:"ping-them.bicep"})," module, passing two URLs to test."]}),"\n",(0,s.jsx)(t.p,{children:'When executed, you end up with a delightful "availability test" (which is your standard test) in Azure:'}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"screenshot of an Availability test in the Azure Portal",src:n(87550).Z+"",width:"3016",height:"1310",loading:"lazy"})})]})}function h(e={}){const{wrapper:t}={...(0,a.a)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},67699:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/title-image-90f6b7716712d9f72a72a2d0895cb8f7.png"},87550:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/screenshot-azure-portal-availability-4639f627993291117dc4b932a56b6415.png"},44013:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/screenshot-azure-portal-deployments-resource-should-exist-in-the-same-resource-group-190e7c644667cf344f9895d2f01bab96.webp"},58406:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/title-image-90f6b7716712d9f72a72a2d0895cb8f7.png"},11151:(e,t,n)=>{n.d(t,{Z:()=>o,a:()=>r});var s=n(67294);const a={},i=s.createContext(a);function r(e){const t=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),s.createElement(i.Provider,{value:t},e.children)}}}]);