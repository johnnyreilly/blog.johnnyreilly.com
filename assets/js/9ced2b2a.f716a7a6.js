"use strict";(self.webpackChunkjohnnyreilly_com=self.webpackChunkjohnnyreilly_com||[]).push([[42535],{23131:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>p,contentTitle:()=>a,default:()=>u,frontMatter:()=>r,metadata:()=>o,toc:()=>l});var t=n(74848),s=n(28453);const r={slug:"bicep-azure-static-web-apps-azure-devops",title:"Publish Azure Static Web Apps with Bicep and Azure DevOps",authors:"johnnyreilly",tags:["azure static web apps","bicep","azure pipelines","azure devops"],image:"./title-image.png",hide_table_of_contents:!1,description:"Learn how to deploy Azure Static Web Apps using Bicep and Azure DevOps, including workarounds for common deployment issues."},a=void 0,o={permalink:"/bicep-azure-static-web-apps-azure-devops",editUrl:"https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2021-08-15-bicep-azure-static-web-apps-azure-devops/index.md",source:"@site/blog/2021-08-15-bicep-azure-static-web-apps-azure-devops/index.md",title:"Publish Azure Static Web Apps with Bicep and Azure DevOps",description:"Learn how to deploy Azure Static Web Apps using Bicep and Azure DevOps, including workarounds for common deployment issues.",date:"2021-08-15T00:00:00.000Z",tags:[{inline:!1,label:"Azure Static Web Apps",permalink:"/tags/azure-static-web-apps",description:"The Azure Static Web Apps service."},{inline:!1,label:"Bicep",permalink:"/tags/bicep",description:"The Bicep language for Azure Resource Manager templates."},{inline:!1,label:"Azure Pipelines",permalink:"/tags/azure-pipelines",description:"The Azure Pipelines CI / CD service."},{inline:!1,label:"Azure DevOps",permalink:"/tags/azure-devops",description:"The Azure DevOps suite of tools."}],readingTime:4.5,hasTruncateMarker:!0,authors:[{name:"John Reilly",title:"OSS Engineer - TypeScript, Azure, React, Node.js, .NET",url:"https://johnnyreilly.com/about",imageURL:"https://johnnyreilly.com/img/profile.jpg",key:"johnnyreilly"}],frontMatter:{slug:"bicep-azure-static-web-apps-azure-devops",title:"Publish Azure Static Web Apps with Bicep and Azure DevOps",authors:"johnnyreilly",tags:["azure static web apps","bicep","azure pipelines","azure devops"],image:"./title-image.png",hide_table_of_contents:!1,description:"Learn how to deploy Azure Static Web Apps using Bicep and Azure DevOps, including workarounds for common deployment issues."},unlisted:!1,prevItem:{title:"Bicep: syntax highlighting with PrismJS (and Docusaurus)",permalink:"/bicep-syntax-highlighting-with-prismjs"},nextItem:{title:"TypeScript 4.4 and more readable code",permalink:"/typescript-4-4-more-readable-code"}},p={image:n(7187).A,authorsImageUrls:[void 0]},l=[{value:"Bicep template",id:"bicep-template",level:2},{value:"Static Web App",id:"static-web-app",level:2},{value:"Azure Pipeline",id:"azure-pipeline",level:2},{value:"<code>Provider is invalid</code> workaround 2",id:"provider-is-invalid-workaround-2",level:2}];function c(e){const i={a:"a",code:"code",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(i.p,{children:["This post demonstrates how to deploy ",(0,t.jsx)(i.a,{href:"https://docs.microsoft.com/en-us/azure/static-web-apps/overview",children:"Azure Static Web Apps"})," using Bicep and Azure DevOps. It includes a few workarounds for the ",(0,t.jsx)(i.a,{href:"https://github.com/Azure/static-web-apps/issues/516",children:'"Provider is invalid. Cannot change the Provider. Please detach your static site first if you wish to use to another deployment provider." issue'}),"."]}),"\n",(0,t.jsx)(i.p,{children:(0,t.jsx)(i.img,{alt:"title image reading &quot;Publish Azure Static Web Apps with Bicep and Azure DevOps&quot; and some Azure logos",src:n(38368).A+"",width:"1522",height:"644",loading:"eager",fetchpriority:"high"})}),"\n",(0,t.jsx)(i.h2,{id:"bicep-template",children:"Bicep template"}),"\n",(0,t.jsx)(i.p,{children:"The first thing we're going to do is create a folder where our Bicep file for deploying our Azure Static Web App will live:"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-bash",children:"mkdir infra/static-web-app -p\n"})}),"\n",(0,t.jsxs)(i.p,{children:["Then we'll create a ",(0,t.jsx)(i.code,{children:"main.bicep"})," file:"]}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-bicep",children:"param repositoryUrl string\nparam repositoryBranch string\n\nparam location string = 'westeurope'\nparam skuName string = 'Free'\nparam skuTier string = 'Free'\n\nparam appName string\n\nresource staticWebApp 'Microsoft.Web/staticSites@2020-12-01' = {\n  name: appName\n  location: location\n  sku: {\n    name: skuName\n    tier: skuTier\n  }\n  properties: {\n    // The provider, repositoryUrl and branch fields are required for successive deployments to succeed\n    // for more details see: https://github.com/Azure/static-web-apps/issues/516\n    provider: 'DevOps'\n    repositoryUrl: repositoryUrl\n    branch: repositoryBranch\n    buildProperties: {\n      skipGithubActionWorkflowGeneration: true\n    }\n  }\n}\n"})}),"\n",(0,t.jsxs)(i.p,{children:["There's some things to draw attention to in the code above. The ",(0,t.jsx)(i.code,{children:"provider"}),", ",(0,t.jsx)(i.code,{children:"repositoryUrl"})," and ",(0,t.jsx)(i.code,{children:"branch"})," fields are required for successive deployments to succeed. In our case we're deploying via Azure DevOps and so our provider is ",(0,t.jsx)(i.code,{children:"'DevOps'"}),". For more details, ",(0,t.jsx)(i.a,{href:"https://github.com/Azure/static-web-apps/issues/516",children:"look at this issue"}),"."]}),"\n",(0,t.jsx)(i.h2,{id:"static-web-app",children:"Static Web App"}),"\n",(0,t.jsx)(i.p,{children:"In order that we can test out Azure Static Web Apps, what we need is a static web app. You could use pretty much anything here; we're going to use Docusaurus. We'll execute this single command:"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-bash",children:"npx @docusaurus/init@latest init static-web-app classic\n"})}),"\n",(0,t.jsxs)(i.p,{children:["Which will scaffold a Docusaurus site in a folder named ",(0,t.jsx)(i.code,{children:"static-web-app"}),". We don't need to change it any further; let's just see if we can deploy it."]}),"\n",(0,t.jsx)(i.h2,{id:"azure-pipeline",children:"Azure Pipeline"}),"\n",(0,t.jsxs)(i.p,{children:["We're going to add an ",(0,t.jsx)(i.code,{children:"azure-pipelines.yml"})," file which Azure DevOps can use to power a pipeline:"]}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-yml",children:"trigger:\n  - main\n\npool:\n  vmImage: ubuntu-latest\n\nsteps:\n  - checkout: self\n    submodules: true\n\n  - bash: az bicep build --file infra/static-web-app/main.bicep\n    displayName: 'Compile Bicep to ARM'\n\n  - task: AzureResourceManagerTemplateDeployment@3\n    name: DeployStaticWebAppInfra\n    displayName: Deploy Static Web App infra\n    inputs:\n      deploymentScope: Resource Group\n      azureResourceManagerConnection: $(serviceConnection)\n      subscriptionId: $(subscriptionId)\n      action: Create Or Update Resource Group\n      resourceGroupName: $(azureResourceGroup)\n      location: $(location)\n      templateLocation: Linked artifact\n      csmFile: 'infra/static-web-app/main.json' # created by bash script\n      overrideParameters: >-\n        -repositoryUrl $(repo)\n        -repositoryBranch $(Build.SourceBranchName)\n        -appName $(staticWebAppName)\n      deploymentMode: Incremental\n      deploymentOutputs: deploymentOutputs\n\n  # Only necessary when consuming deploymentOutputs\n  # - task: PowerShell@2\n  #   name: 'SetDeploymentOutputVariables'\n  #   displayName: 'Set Deployment Output Variables'\n  #   inputs:\n  #     targetType: inline\n  #     script: |\n  #       $armOutputObj = '$(deploymentOutputs)' | ConvertFrom-Json\n  #       $armOutputObj.PSObject.Properties | ForEach-Object {\n  #         $keyname = $_.Name\n  #         $value = $_.Value.value\n\n  #         # Creates a standard pipeline variable\n  #         Write-Output \"##vso[task.setvariable variable=$keyName;issecret=true]$value\"\n\n  #         # Display keys in pipeline\n  #         Write-Output \"output variable: $keyName\"\n  #       }\n  #     pwsh: true\n\n  - task: AzureCLI@2\n    displayName: 'Acquire API key for deployment'\n    inputs:\n      azureSubscription: $(serviceConnection)\n      scriptType: bash\n      scriptLocation: inlineScript\n      inlineScript: |\n        APIKEY=$(az staticwebapp secrets list --name $(staticWebAppName) | jq -r '.properties.apiKey')\n        echo \"##vso[task.setvariable variable=apiKey;issecret=true]$APIKEY\"\n\n  - task: AzureStaticWebApp@0\n    name: DeployStaticWebApp\n    displayName: Deploy Static Web App\n    inputs:\n      app_location: 'static-web-app'\n      # api_location: 'api' # we don't have an API\n      output_location: 'build'\n      azure_static_web_apps_api_token: $(apiKey)\n"})}),"\n",(0,t.jsx)(i.p,{children:"When the pipeline is run, it does the following:"}),"\n",(0,t.jsxs)(i.ol,{children:["\n",(0,t.jsx)(i.li,{children:"Compiles our Bicep into an ARM template"}),"\n",(0,t.jsx)(i.li,{children:"Deploys the compiled ARM template to Azure"}),"\n",(0,t.jsxs)(i.li,{children:["Captures the deployment outputs (essentially the ",(0,t.jsx)(i.code,{children:"deployment_token"}),") and converts them into variables to use in the pipeline"]}),"\n",(0,t.jsxs)(i.li,{children:["Deploys our Static Web App using the ",(0,t.jsx)(i.code,{children:"deployment_token"})]}),"\n"]}),"\n",(0,t.jsx)(i.p,{children:"The pipeline depends upon a number of variables:"}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"azureResourceGroup"})," - the name of your resource group in Azure where the app will be deployed"]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"location"})," - where your app is deployed, eg ",(0,t.jsx)(i.code,{children:"northeurope"})]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"repo"})," - the URL of your repository in Azure DevOps, eg ",(0,t.jsx)(i.a,{href:"https://dev.azure.com/johnnyreilly/_git/azure-static-web-apps",children:"https://dev.azure.com/johnnyreilly/_git/azure-static-web-apps"})]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"serviceConnection"})," - the name of your AzureRM service connection in Azure DevOps"]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"staticWebAppName"})," - the name of your static web app, eg ",(0,t.jsx)(i.code,{children:"azure-static-web-apps-johnnyreilly"})]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"subscriptionId"})," - your Azure subscription id from the ",(0,t.jsx)(i.a,{href:"https://portal.azure.com",children:"Azure Portal"})]}),"\n"]}),"\n",(0,t.jsx)(i.p,{children:"A successful pipeline looks something like this:"}),"\n",(0,t.jsx)(i.p,{children:(0,t.jsx)(i.img,{alt:"Screenshot of successfully running Azure Pipeline",src:n(52469).A+"",width:"2090",height:"1648",loading:"lazy"})}),"\n",(0,t.jsxs)(i.p,{children:["What you might notice is that the ",(0,t.jsx)(i.code,{children:"AzureStaticWebApp"})," is itself installing and building our application. This is handled by ",(0,t.jsx)(i.a,{href:"https://github.com/Microsoft/Oryx",children:"Microsoft Oryx"}),". The upshot of this is that we don't need to manually run ",(0,t.jsx)(i.code,{children:"npm install"})," and ",(0,t.jsx)(i.code,{children:"npm build"})," ourselves; the ",(0,t.jsx)(i.code,{children:"AzureStaticWebApp"})," task will take care of it for us."]}),"\n",(0,t.jsx)(i.p,{children:"Finally, let's see if we've deployed something successfully..."}),"\n",(0,t.jsx)(i.p,{children:(0,t.jsx)(i.img,{alt:"Screenshot of deployed Azure Static Web App",src:n(53218).A+"",width:"1856",height:"1482",loading:"lazy"})}),"\n",(0,t.jsx)(i.p,{children:"We have! It's worth noting that you'll likely want to give your Azure Static Web App a lovelier URL, and perhaps even put it behind Azure Front Door as well."}),"\n",(0,t.jsxs)(i.h2,{id:"provider-is-invalid-workaround-2",children:[(0,t.jsx)(i.code,{children:"Provider is invalid"})," workaround 2"]}),"\n",(0,t.jsxs)(i.p,{children:[(0,t.jsx)(i.a,{href:"https://www.linkedin.com/in/shaneneff/",children:"Shane Neff"})," was attempting to follow the instructions in this post and encountered issues. He shared his struggles with me as he encountered the ",(0,t.jsx)(i.a,{href:"https://github.com/Azure/static-web-apps/issues/516",children:'"Provider is invalid. Cannot change the Provider. Please detach your static site first if you wish to use to another deployment provider." issue'}),"."]}),"\n",(0,t.jsxs)(i.p,{children:["He was good enough to share his solution as well, which is inserting this task at the start of the pipeline (before the ",(0,t.jsx)(i.code,{children:"az bicep build"})," step):"]}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-yml",children:"- task: AzureCLI@2\n  inputs:\n    azureSubscription: '<name of your service connection>'\n    scriptType: 'bash'\n    scriptLocation: 'inlineScript'\n    inlineScript: 'az staticwebapp disconnect -n <name of your app>'\n"})}),"\n",(0,t.jsx)(i.p,{children:"I haven't had the problems that Shane has had myself, but I wanted to share his fix for the people out there who almost certainly are bumping on this."})]})}function u(e={}){const{wrapper:i}={...(0,s.R)(),...e.components};return i?(0,t.jsx)(i,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},7187:(e,i,n)=>{n.d(i,{A:()=>t});const t=n.p+"assets/images/title-image-2f09fb58fbc23a5988344f6bb4334136.png"},53218:(e,i,n)=>{n.d(i,{A:()=>t});const t=n.p+"assets/images/deployed-azure-static-web-app-screenshot-ffb2d909dc180d9eeca7093df08e0ab4.png"},52469:(e,i,n)=>{n.d(i,{A:()=>t});const t=n.p+"assets/images/successful-azure-pipelines-run-screenshot-2307f958e834b2e8fa65ba0c158e5098.png"},38368:(e,i,n)=>{n.d(i,{A:()=>t});const t=n.p+"assets/images/title-image-2f09fb58fbc23a5988344f6bb4334136.png"},28453:(e,i,n)=>{n.d(i,{R:()=>a,x:()=>o});var t=n(96540);const s={},r=t.createContext(s);function a(e){const i=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(i):{...i,...e}}),[i,e])}function o(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),t.createElement(r.Provider,{value:i},e.children)}}}]);