"use strict";(self.webpackChunkblog_johnnyreilly_com=self.webpackChunkblog_johnnyreilly_com||[]).push([[87092],{3905:(e,t,n)=>{n.d(t,{Zo:()=>l,kt:()=>m});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function p(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},l=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,s=e.parentName,l=p(e,["components","mdxType","originalType","parentName"]),d=c(n),m=i,b=d["".concat(s,".").concat(m)]||d[m]||u[m]||o;return n?a.createElement(b,r(r({ref:t},l),{},{components:n})):a.createElement(b,r({ref:t},l))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,r=new Array(o);r[0]=d;var p={};for(var s in t)hasOwnProperty.call(t,s)&&(p[s]=t[s]);p.originalType=e,p.mdxType="string"==typeof e?e:i,r[1]=p;for(var c=2;c<o;c++)r[c]=n[c];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},95372:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>p,default:()=>d,frontMatter:()=>r,metadata:()=>s,toc:()=>l});n(67294);var a=n(3905);function i(){return i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},i.apply(this,arguments)}function o(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}const r={title:"Bicep: Static Web Apps and Linked Backends",authors:"johnnyreilly",tags:["Bicep","Azure","Static Web Apps","Linked Backends"],image:"./title-image.webp",hide_table_of_contents:!1},p=void 0,s={permalink:"/2022/10/14/bicep-static-web-apps-linked-backends",editUrl:"https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2022-10-14-bicep-static-web-apps-linked-backends/index.md",source:"@site/blog/2022-10-14-bicep-static-web-apps-linked-backends/index.md",title:"Bicep: Static Web Apps and Linked Backends",description:"Azure Static Web Apps can be linked to Azure Functions, Azure Container Apps etc to provide the linked backend for a site. This post will demonstrate how to do this with Bicep.",date:"2022-10-14T00:00:00.000Z",formattedDate:"October 14, 2022",tags:[{label:"Bicep",permalink:"/tags/bicep"},{label:"Azure",permalink:"/tags/azure"},{label:"Static Web Apps",permalink:"/tags/static-web-apps"},{label:"Linked Backends",permalink:"/tags/linked-backends"}],readingTime:3.135,hasTruncateMarker:!1,authors:[{name:"John Reilly",url:"https://twitter.com/johnny_reilly",imageURL:"https://blog.johnnyreilly.com/img/profile.jpg",key:"johnnyreilly"}],frontMatter:{title:"Bicep: Static Web Apps and Linked Backends",authors:"johnnyreilly",tags:["Bicep","Azure","Static Web Apps","Linked Backends"],image:"./title-image.webp",hide_table_of_contents:!1},prevItem:{title:"Getting started with the Web Monetization API",permalink:"/2022/10/20/web-monetization-api"},nextItem:{title:"TypeScript Unit Tests with Debug Support",permalink:"/2022/10/01/typescript-unit-tests-with-debug-support"}},c={image:n(81236).Z,authorsImageUrls:[void 0]},l=[{value:"Introduction",id:"introduction",level:2},{value:"The Function App Bicep",id:"the-function-app-bicep",level:2},{value:"The Static Web App Bicep",id:"the-static-web-app-bicep",level:2},{value:"The Deployment",id:"the-deployment",level:2}],u={toc:l};function d(e){var{components:t}=e,r=o(e,["components"]);return(0,a.kt)("wrapper",i({},u,r,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"Azure Static Web Apps can be linked to Azure Functions, Azure Container Apps etc to provide the linked backend for a site. This post will demonstrate how to do this with Bicep."),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"title image reading &quot;Bicep: Static Web Apps and Linked Backends&quot; with Bicep and Static Web App logos",src:n(81236).Z,width:"800",height:"450"})),(0,a.kt)("h2",i({},{id:"introduction"}),"Introduction"),(0,a.kt)("p",null,'Azure Static Web Apps ship with their own slightly restricted Azure Functions backend; it does not have all of the triggers of the standard offering. If you should need that wider featureset, you can link to an existing Azure Functions instance instead. This is known as the "bring your own functions" approach and is ',(0,a.kt)("a",i({parentName:"p"},{href:"https://learn.microsoft.com/en-us/azure/static-web-apps/functions-bring-your-own"}),"documented here"),". The back end doesn't have to be Azure Functions; it could be Azure Container Apps also. This post will demonstrate how to do this with Azure Functions and with Bicep."),(0,a.kt)("h2",i({},{id:"the-function-app-bicep"}),"The Function App Bicep"),(0,a.kt)("p",null,"You're going to need to create an Azure Function in your Bicep template. We'll do this here with a Bicep module called ",(0,a.kt)("inlineCode",{parentName:"p"},"function.bicep"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",i({parentName:"pre"},{className:"language-bicep"}),"param functionAppName string\nparam location string\nparam hostingPlanName string\nparam storageAccountName string\nparam tags object\n\nresource functionApp 'Microsoft.Web/sites@2022-03-01' = {\n  name: functionAppName\n  kind: 'functionapp,linux'\n  location: location\n  tags: tags\n  properties: {\n    siteConfig: {\n      appSettings: [\n        {\n          name: 'FUNCTIONS_EXTENSION_VERSION'\n          value: '~4'\n        }\n        {\n          name: 'FUNCTIONS_WORKER_RUNTIME'\n          value: 'node'\n        }\n        {\n          name: 'AzureWebJobsStorage'\n          value: 'DefaultEndpointsProtocol=https;AccountName=${storageAccount.name};EndpointSuffix=${environment().suffixes.storage};AccountKey=${storageAccount.listKeys().keys[0].value}'\n        }\n        {\n          name: 'WEBSITE_CONTENTAZUREFILECONNECTIONSTRING'\n          value: 'DefaultEndpointsProtocol=https;AccountName=${storageAccount.name};EndpointSuffix=${environment().suffixes.storage};AccountKey=${storageAccount.listKeys().keys[0].value}'\n        }\n        {\n          name: 'WEBSITE_CONTENTSHARE'\n          value: '${toLower(functionAppName)}a6e3'\n        }\n      ]\n      cors: {\n        allowedOrigins: [\n          'https://portal.azure.com'\n        ]\n      }\n      use32BitWorkerProcess: false\n      ftpsState: 'FtpsOnly'\n      linuxFxVersion: 'Node|16'\n    }\n    serverFarmId: serverFarm.id\n    clientAffinityEnabled: false\n    httpsOnly: true\n  }\n}\n\nresource serverFarm 'Microsoft.Web/serverfarms@2022-03-01' = {\n  name: hostingPlanName\n  location: location\n  kind: 'linux'\n  tags: {}\n  properties: {\n    reserved: true\n  }\n  sku: {\n    tier: 'Dynamic'\n    name: 'Y1'\n  }\n  dependsOn: []\n}\n\nresource storageAccount 'Microsoft.Storage/storageAccounts@2022-05-01' = {\n  name: storageAccountName\n  location: location\n  tags: {}\n  sku: {\n    name: 'Standard_LRS'\n  }\n  properties: {\n    supportsHttpsTrafficOnly: true\n    minimumTlsVersion: 'TLS1_2'\n  }\n  kind: 'StorageV2'\n}\n\noutput functionAppResourceId string = functionApp.id\n")),(0,a.kt)("p",null,"It also creates a storage account and a server farm to support the function app. You'll note it exports the resource name of the function app. We'll use this in the next step."),(0,a.kt)("h2",i({},{id:"the-static-web-app-bicep"}),"The Static Web App Bicep"),(0,a.kt)("p",null,"In our main Bicep template we'll create a static web app and link it to the function app we created in the previous step. We'll do this with a Bicep module called ",(0,a.kt)("inlineCode",{parentName:"p"},"main.bicep"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",i({parentName:"pre"},{className:"language-bicep"}),"param location string\nparam branch string\nparam staticWebAppName string\nparam functionAppName string\nparam hostingPlanName string\nparam storageAccountName string\nparam tags object\n@secure()\nparam repositoryToken string\nparam customDomainName string\n\nmodule functionApp 'function.bicep' = {\n  name: 'functionApp'\n  params: {\n    location: location\n    tags: tags\n    functionAppName: functionAppName\n    hostingPlanName: hostingPlanName\n    storageAccountName: storageAccountName\n  }\n}\n\nresource staticWebApp 'Microsoft.Web/staticSites@2021-02-01' = {\n  name: staticWebAppName\n  location: location\n  tags: tags\n  sku: {\n    // Free doesn't work with linked backends\n    name: 'Standard'\n    tier: 'Standard'\n  }\n  properties: {\n    repositoryUrl: 'https://github.com/johnnyreilly/blog.johnnyreilly.com'\n    repositoryToken: repositoryToken\n    branch: branch\n    provider: 'GitHub'\n    stagingEnvironmentPolicy: 'Enabled'\n    allowConfigFileUpdates: true\n    buildProperties:{\n      skipGithubActionWorkflowGeneration: true\n    }\n  }\n}\n\nresource customDomain 'Microsoft.Web/staticSites/customDomains@2021-02-01' = {\n  parent: staticWebApp\n  name: customDomainName\n  properties: {}\n}\n\nresource staticWebAppBackend 'Microsoft.Web/staticSites/linkedBackends@2022-03-01' = {\n  name: '${staticWebAppName}/backend'\n  properties: {\n    backendResourceId: functionApp.outputs.functionAppResourceId\n    region: location\n  }\n}\n\noutput staticWebAppDefaultHostName string = staticWebApp.properties.defaultHostname // eg gentle-bush-0db02ce03.azurestaticapps.net\noutput staticWebAppId string = staticWebApp.id\noutput staticWebAppName string = staticWebApp.name\n")),(0,a.kt)("p",null,"The crucial bit above is this:"),(0,a.kt)("pre",null,(0,a.kt)("code",i({parentName:"pre"},{className:"language-bicep"}),"resource staticWebAppBackend 'Microsoft.Web/staticSites/linkedBackends@2022-03-01' = {\n  name: '${staticWebAppName}/backend'\n  properties: {\n    backendResourceId: functionApp.outputs.functionAppResourceId\n    region: location\n  }\n}\n")),(0,a.kt)("p",null,"This links the static web app to the function app we created in the previous step. We use the ",(0,a.kt)("inlineCode",{parentName:"p"},"functionApp.outputs.functionAppResourceId")," to get the resource ID of the function app from our module."),(0,a.kt)("h2",i({},{id:"the-deployment"}),"The Deployment"),(0,a.kt)("p",null,"Once this is deployed to Azure, if you click on the APIs section of the static web app you'll see the function app is now linked:"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"The function app is now linked to the static web app as demonstrated in the Azure Portal",src:n(33685).Z,width:"1920",height:"494"})))}d.isMDXComponent=!0},33685:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/screenshot-azure-portal-linked-backend-f49e3a6cfb38bfc7ad34bc22d4d942cf.webp"},81236:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/title-image-8c4c5f95e4f0573b835f4e894fc669e8.webp"}}]);