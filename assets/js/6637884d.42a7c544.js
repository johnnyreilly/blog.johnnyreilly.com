"use strict";(self.webpackChunkjohnnyreilly_com=self.webpackChunkjohnnyreilly_com||[]).push([[44638],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>h});var o=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);n&&(o=o.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,o)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,o,r=function(e,n){if(null==e)return{};var t,o,r={},a=Object.keys(e);for(o=0;o<a.length;o++)t=a[o],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)t=a[o],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var c=o.createContext({}),l=function(e){var n=o.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},p=function(e){var n=l(e.components);return o.createElement(c.Provider,{value:n},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var n=e.children;return o.createElement(o.Fragment,{},n)}},m=o.forwardRef((function(e,n){var t=e.components,r=e.mdxType,a=e.originalType,c=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=l(t),m=r,h=d["".concat(c,".").concat(m)]||d[m]||u[m]||a;return t?o.createElement(h,i(i({ref:n},p),{},{components:t})):o.createElement(h,i({ref:n},p))}));function h(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var a=t.length,i=new Array(a);i[0]=m;var s={};for(var c in n)hasOwnProperty.call(n,c)&&(s[c]=n[c]);s.originalType=e,s[d]="string"==typeof e?e:r,i[1]=s;for(var l=2;l<a;l++)i[l]=t[l];return o.createElement.apply(null,i)}return o.createElement.apply(null,t)}m.displayName="MDXCreateElement"},75124:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>p,contentTitle:()=>c,default:()=>m,frontMatter:()=>s,metadata:()=>l,toc:()=>d});t(67294);var o=t(3905);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);n&&(o=o.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,o)}return t}(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})),e}function i(e,n){if(null==e)return{};var t,o,r=function(e,n){if(null==e)return{};var t,o,r={},a=Object.keys(e);for(o=0;o<a.length;o++)t=a[o],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)t=a[o],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}const s={slug:"devcontainers-aka-performance-in-secure",title:"Devcontainers AKA performance in a secure sandbox",authors:"johnnyreilly",tags:["devcontainer"],hide_table_of_contents:!1,description:"Speedy ASP.NET Core and JavaScript development is made possible by devcontainers, which isolate tools and code to improve productivity."},c=void 0,l={permalink:"/devcontainers-aka-performance-in-secure",editUrl:"https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2020-08-09-devcontainers-aka-performance-in-secure/index.md",source:"@site/blog/2020-08-09-devcontainers-aka-performance-in-secure/index.md",title:"Devcontainers AKA performance in a secure sandbox",description:"Speedy ASP.NET Core and JavaScript development is made possible by devcontainers, which isolate tools and code to improve productivity.",date:"2020-08-09T00:00:00.000Z",formattedDate:"August 9, 2020",tags:[{label:"devcontainer",permalink:"/tags/devcontainer"}],readingTime:6.545,hasTruncateMarker:!0,authors:[{name:"John Reilly",title:"OSS Engineer - TypeScript, Azure, React, Node.js, .NET",url:"https://johnnyreilly.com/about",imageURL:"https://johnnyreilly.com/img/profile.jpg",key:"johnnyreilly"}],frontMatter:{slug:"devcontainers-aka-performance-in-secure",title:"Devcontainers AKA performance in a secure sandbox",authors:"johnnyreilly",tags:["devcontainer"],hide_table_of_contents:!1,description:"Speedy ASP.NET Core and JavaScript development is made possible by devcontainers, which isolate tools and code to improve productivity."},prevItem:{title:"Why your team needs a newsfeed",permalink:"/why-your-team-needs-newsfeed"},nextItem:{title:"Devcontainers and SSL interception",permalink:"/devcontainers-and-ssl-interception"}},p={authorsImageUrls:[void 0]},d=[{value:"&quot;Hide from the virus checkers*** in a devcontainer&quot;",id:"hide-from-the-virus-checkers-in-a-devcontainer",level:2},{value:"Make me a devcontainer...",id:"make-me-a-devcontainer",level:2}],u={toc:d};function m(e){var{components:n}=e,t=i(e,["components"]);return(0,o.kt)("wrapper",a(function(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{},o=Object.keys(t);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(t).filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})))),o.forEach((function(n){r(e,n,t[n])}))}return e}({},u,t),{components:n,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"Many corporate machines arrive in engineers hands with a preponderance of pre-installed background tools; from virus checkers to backup utilities to port blockers; the list is long."),(0,o.kt)("p",null,"The reason that these tools are installed is generally noble. However, the implementation can often be problematic. The tools may be set up in such a way as they impact and interfere with one another. Really powerful machines with 8 CPUs and hardy SSDs can be slowed to a crawl. Put simply: the good people responsible for ensuring security are rarely encouraged to incentivise performance alongside it. And so don't."),(0,o.kt)("p",null,"The unfortunate consequence of considering the role of security without regard to performance is this: sluggish computers. The further consequence (and this is the one I want you to think long and hard about) is ",(0,o.kt)("em",{parentName:"p"},"low developer productivity"),". And that sucks. It impacts what an organisation is able to do, how fast an organisation is able to move. Put simply: it can be the difference between success and failure."),(0,o.kt)("p",null,"The most secure computer is off. But you won't ship much with it. Encouraging your organisation to consider tackling security with performance in mind is worthwhile. It's a long game though. In the meantime what can we do?"),(0,o.kt)("h2",{id:"hide-from-the-virus-checkers-in-a-devcontainer"},'"Hide from the virus checkers',"*","*","*",' in a devcontainer"'),(0,o.kt)("p",null,"Devcontainers, the infrastructure as code equivalent for developing software, have an underappreciated quality: unlocking your machine's performance."),(0,o.kt)("p",null,"Devcontainers are isolated secure sandboxes in which you can build software. To quote the ",(0,o.kt)("a",{parentName:"p",href:"https://code.visualstudio.com/docs/remote/containers"},"docs"),":"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"A ",(0,o.kt)("inlineCode",{parentName:"p"},"devcontainer.json")," file in your project tells VS Code how to access (or create) a development container with a well-defined tool and runtime stack. This container can be used to run an application or to sandbox tools, libraries, or runtimes needed for working with a codebase."),(0,o.kt)("p",{parentName:"blockquote"},"Workspace files are mounted from the local file system or copied or ",(0,o.kt)("em",{parentName:"p"},"cloned into the container"),".")),(0,o.kt)("p",null,"We're going to set up a devcontainer to code an ASP.NET Core application with a JavaScript (well TypeScript) front end. If there's one thing that's sure to catch a virus checkers beady eye, it's ",(0,o.kt)("inlineCode",{parentName:"p"},"node_modules"),". ",(0,o.kt)("inlineCode",{parentName:"p"},"node_modules")," contains more files than a black hole has mass. Consider a project with 5,000 source files. One trusty ",(0,o.kt)("inlineCode",{parentName:"p"},"yarn")," later and the folder now has a tidy 250,000 files. The virus checker is now really sitting up and taking notice."),(0,o.kt)("p",null,"Our project has a ",(0,o.kt)("inlineCode",{parentName:"p"},"git commit")," hook set up with ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/typicode/husky"},"Husky")," that formats our TypeScript files with ",(0,o.kt)("a",{parentName:"p",href:"https://prettier.io/"},"Prettier"),". Every commit the files are formatted to align with the project standard. With all the virus checkers in place a ",(0,o.kt)("inlineCode",{parentName:"p"},"git commit")," takes around 45 seconds. Inside a devcontainer we can drop this to 5 seconds. That's nine times faster. I'll repeat that: that's ",(0,o.kt)("strong",{parentName:"p"},"nine times faster"),"!"),(0,o.kt)("p",null,"The \"cloned into a container\" above is key to what we're going to do. We're ",(0,o.kt)("em",{parentName:"p"},"not")," going to mount our local file system into the devcontainer. Oh no. We're going to build a devcontainer with ASP.NET CORE and JavaScript in. Then, inside there, we're going to clone our repo. Then we can develop, build and debug all inside the container. It will feel like we're working on our own machine because VS Code does such a damn fine job. In reality, we're connecting to another computer (a Linux computer to boot) that is running in isolation to our own. In our case that machine is sharing our hardware; but that's just an implementation detail. It could be anywhere (and in the future may well be)."),(0,o.kt)("h2",{id:"make-me-a-devcontainer"},"Make me a devcontainer..."),(0,o.kt)("p",null,"Enough talk... We're going to need a ",(0,o.kt)("inlineCode",{parentName:"p"},".devcontainer/devcontainer.json"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "name": "my devcontainer",\n  "dockerComposeFile": "../docker-compose.devcontainer.yml",\n  "service": "my-devcontainer",\n  "workspaceFolder": "/workspace",\n\n  // Set *default* container specific settings.json values on container create.\n  "settings": {\n    "terminal.integrated.shell.linux": "/bin/zsh"\n  },\n\n  // Add the IDs of extensions you want installed when the container is created.\n  "extensions": [\n    "ms-dotnettools.csharp",\n    "dbaeumer.vscode-eslint",\n    "esbenp.prettier-vscode",\n    "ms-mssql.mssql",\n    "eamodio.gitlens",\n    "ms-azuretools.vscode-docker",\n    "k--kato.docomment",\n    "Leopotam.csharpfixformat"\n  ],\n\n  // Use \'postCreateCommand\' to clone the repo into the workspace folder when the devcontainer starts\n  // and copy in the .env file\n  "postCreateCommand": "git clone git@github.com:my-org/my-repo.git . && cp /.env /workspace/.env"\n\n  // "remoteUser": "vscode"\n}\n')),(0,o.kt)("p",null,"Now the ",(0,o.kt)("inlineCode",{parentName:"p"},"docker-compose.devcontainer.yml")," which lives in the root of the project. It provisions a SQL Server container (using the official image) and our devcontainer:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yml"},"version: '3.7'\nservices:\n  my-devcontainer:\n    image: my-devcontainer\n    build:\n      context: .\n      dockerfile: Dockerfile.devcontainer\n    command: /bin/zsh -c \"while sleep 1000; do :; done\"\n    volumes:\n      # mount .zshrc from home - make sure it doesn't contain Windows line endings\n      - ~/.zshrc:/root/.zshrc\n\n    # user: vscode\n    ports:\n      - '5000:5000'\n      - '8080:8080'\n    environment:\n      - CONNECTIONSTRINGS__MYDATABASECONNECTION\n    depends_on:\n      - db\n  db:\n    image: mcr.microsoft.com/mssql/server:2019-latest\n    privileged: true\n    ports:\n      - 1433:1433\n    environment:\n      SA_PASSWORD: 'Your_password123'\n      ACCEPT_EULA: 'Y'\n")),(0,o.kt)("p",null,"The devcontainer will be built with the ",(0,o.kt)("inlineCode",{parentName:"p"},"Dockerfile.devcontainer")," in the root of our repo. It relies upon your SSH keys and a ",(0,o.kt)("inlineCode",{parentName:"p"},".env")," file being available to be copied in:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-Dockerfile"},'#-----------------------------------------------------------------------------------------------------------\n# Based upon: https://github.com/microsoft/vscode-dev-containers/tree/master/containers/dotnetcore\n#-----------------------------------------------------------------------------------------------------------\nARG VARIANT="3.1-bionic"\nFROM mcr.microsoft.com/dotnet/core/sdk:${VARIANT}\n\n# Because MITM certificates\nCOPY ./docker/certs/. /usr/local/share/ca-certificates/\nENV NODE_EXTRA_CA_CERTS=/usr/local/share/ca-certificates/mitm.pem\nRUN update-ca-certificates\n\n# This Dockerfile adds a non-root user with sudo access. Use the "remoteUser"\n# property in devcontainer.json to use it. On Linux, the container user\'s GID/UIDs\n# will be updated to match your local UID/GID (when using the dockerFile property).\n# See https://aka.ms/vscode-remote/containers/non-root-user for details.\nARG USERNAME=vscode\nARG USER_UID=1000\nARG USER_GID=$USER_UID\n\n# Options for common package install script\nARG INSTALL_ZSH="true"\nARG UPGRADE_PACKAGES="true"\nARG COMMON_SCRIPT_SOURCE="https://raw.githubusercontent.com/microsoft/vscode-dev-containers/master/script-library/common-debian.sh"\nARG COMMON_SCRIPT_SHA="dev-mode"\n\n# Settings for installing Node.js.\nARG INSTALL_NODE="true"\nARG NODE_SCRIPT_SOURCE="https://raw.githubusercontent.com/microsoft/vscode-dev-containers/master/script-library/node-debian.sh"\nARG NODE_SCRIPT_SHA="dev-mode"\n\n# ARG NODE_VERSION="lts/*"\nARG NODE_VERSION="14"\nENV NVM_DIR=/usr/local/share/nvm\n\n# Have nvm create a "current" symlink and add to path to work around https://github.com/microsoft/vscode-remote-release/issues/3224\nENV NVM_SYMLINK_CURRENT=true\nENV PATH=${NVM_DIR}/current/bin:${PATH}\n\n# Configure apt and install packages\nRUN apt-get update \\\n    && export DEBIAN_FRONTEND=noninteractive \\\n    #\n    # Verify git, common tools / libs installed, add/modify non-root user, optionally install zsh\n    && apt-get -y install --no-install-recommends curl ca-certificates 2>&1 \\\n    && curl -sSL ${COMMON_SCRIPT_SOURCE} -o /tmp/common-setup.sh \\\n    && ([ "${COMMON_SCRIPT_SHA}" = "dev-mode" ] || (echo "${COMMON_SCRIPT_SHA} */tmp/common-setup.sh" | sha256sum -c -)) \\\n    && /bin/bash /tmp/common-setup.sh "${INSTALL_ZSH}" "${USERNAME}" "${USER_UID}" "${USER_GID}" "${UPGRADE_PACKAGES}" \\\n    #\n    # Install Node.js\n    && curl -sSL ${NODE_SCRIPT_SOURCE} -o /tmp/node-setup.sh \\\n    && ([ "${NODE_SCRIPT_SHA}" = "dev-mode" ] || (echo "${COMMON_SCRIPT_SHA} */tmp/node-setup.sh" | sha256sum -c -)) \\\n    && /bin/bash /tmp/node-setup.sh "${NVM_DIR}" "${NODE_VERSION}" "${USERNAME}" \\\n    #\n    # Clean up\n    && apt-get autoremove -y \\\n    && apt-get clean -y \\\n    && rm -f /tmp/common-setup.sh /tmp/node-setup.sh \\\n    && rm -rf /var/lib/apt/lists/* \\\n    #\n    # Workspace\n    && mkdir workspace \\\n    && chown -R ${NONROOT_USER}:root workspace\n\n\n# Install Vim\nRUN apt-get update && apt-get install -y \\\n    vim \\\n    && rm -rf /var/lib/apt/lists/*\n\n# Set up a timezone in the devcontainer - necessary for anything timezone dependent\nENV TZ=Europe/London\nRUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone \\\n && apt-get update \\\n && apt-get install --no-install-recommends -y \\\n    apt-utils \\\n    tzdata  \\\n && apt-get autoremove -y \\\n && apt-get clean -y \\\n && rm -rf /var/lib/apt/lists/*\n\nENV DOTNET_RUNNING_IN_CONTAINER=true\n\n# Copy across SSH keys so you can git clone\nRUN mkdir /root/.ssh\nRUN chmod 700 /root/.ssh\n\nCOPY .ssh/id_rsa /root/.ssh\nRUN chmod 600 /root/.ssh/id_rsa\n\nCOPY .ssh/id_rsa.pub /root/.ssh\nRUN chmod 644 /root/.ssh/id_rsa.pub\n\nCOPY .ssh/known_hosts /root/.ssh\nRUN chmod 644 /root/.ssh/known_hosts\n\n# Disable initial git clone prompt\nRUN echo "StrictHostKeyChecking no" >> /etc/ssh/ssh_config\n\n# Copy across .env file so you can customise environment variables\n# This will be copied into the root of the repo post git clone\nCOPY .env /.env\nRUN chmod 644 /.env\n\n# Install dotnet entity framework tools\nRUN dotnet tool install dotnet-ef --tool-path /usr/local/bin --version 3.1.2\n')),(0,o.kt)("p",null,"With this devcontainer you're good to go for an ASP.NET Core / JavaScript developer setup that is blazing fast! Remember to fire up Docker and give it goodly access to the resources of your host machine. All the CPUs, lots of memory and all the performance that there ought to be."),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"*",' "virus checkers" is a euphemism here for all the background tools that may be running. It was that or calling them "we are legion"')))}m.isMDXComponent=!0}}]);