"use strict";(self.webpackChunkjohnnyreilly_com=self.webpackChunkjohnnyreilly_com||[]).push([["64295"],{74818:function(e,n,t){t.r(n),t.d(n,{assets:function(){return c},contentTitle:function(){return a},default:function(){return h},frontMatter:function(){return s},metadata:function(){return r},toc:function(){return l}});var r=t(31165),i=t(85893),o=t(50065);let s={slug:"introducing-azdo-npm-auth",title:"Introducing azdo-npm-auth (Azure DevOps npm auth)",authors:"johnnyreilly",tags:["azure devops","node.js"],image:"./title-image.png",hide_table_of_contents:!1,description:"Azure DevOps npm auth eases setting up local authentication to Azure DevOps npm feeds, particularly for non Windows users."},a=void 0,c={image:t(23642).Z,authorsImageUrls:[void 0]},l=[{value:"What problem are we solving?",id:"what-problem-are-we-solving",level:2},{value:"When do I need to run <code>azdo-npm-auth</code>?",id:"when-do-i-need-to-run-azdo-npm-auth",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Authenticating to Azure",id:"authenticating-to-azure",level:2},{value:"Integration with <code>package.json</code>",id:"integration-with-packagejson",level:2},{value:"Using a <code>preinstall</code> script",id:"using-a-preinstall-script",level:3},{value:"Using an <code>auth</code> script",id:"using-an-auth-script",level:3},{value:"What about CI?",id:"what-about-ci",level:2},{value:"Summary",id:"summary",level:2}];function d(e){let n={a:"a",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"Azure DevOps has a feature called Azure Artifacts that supports publishing npm packages to a feed for consumption. Typically those npm packages are intended to be consumed by a restricted audience. To install a package published to a private feed you need to configure authentication, and for non Windows users this is a convoluted process."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"title image reading &quot;Introducing Azure DevOps npm auth&quot; with an Azure DevOps and npm logos",src:t(62805).Z+"",width:"800",height:"450",loading:"eager",fetchpriority:"high"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://github.com/johnnyreilly/azdo-npm-auth",children:(0,i.jsx)(n.code,{children:"azdo-npm-auth"})})," exists to ease the setting up of local authentication to Azure DevOps npm feeds, particularly for non Windows users."]}),"\n",(0,i.jsx)(n.h2,{id:"what-problem-are-we-solving",children:"What problem are we solving?"}),"\n",(0,i.jsx)(n.p,{children:"Consider the onboarding process for a Windows user for consuming an Azure Artifact npm feed:"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"screenshot of the onboarding process for Windows users",src:t(27033).Z+"",width:"2168",height:"592",loading:"lazy"})}),"\n",(0,i.jsx)(n.p,{children:"Now consider the onboarding process for a non Windows user:"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"screenshot of the onboarding process for non Windows users",src:t(68755).Z+"",width:"2168",height:"1606",loading:"lazy"})}),"\n",(0,i.jsxs)(n.p,{children:["As we can see, there is a significant difference in the onboarding experience between operating systems. Windows users can use a tool named ",(0,i.jsx)(n.a,{href:"https://www.npmjs.com/package/vsts-npm-auth",children:(0,i.jsx)(n.code,{children:"vsts-npm-auth"})})," which automates onboarding. Non Windows users have a longer road to follow. The instructions walk through manually creating an ",(0,i.jsx)(n.code,{children:".npmrc"})," file in a users home directory which contains information including a base 64 encoded Azure DevOps Personal Access Token with the Packaging read and write scopes. It is tedious to do."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"azdo-npm-auth"})," aims to automate the toil, and make the onboarding experience for non Windows users as simple as it is for Windows users."]}),"\n",(0,i.jsxs)(n.p,{children:["There is an official package named ",(0,i.jsx)(n.a,{href:"https://github.com/microsoft/ado-npm-auth",children:(0,i.jsx)(n.code,{children:"ado-npm-auth"})}),". However, ",(0,i.jsxs)(n.a,{href:"https://github.com/microsoft/ado-npm-auth/issues/50",children:["due to issues I experienced in using the ",(0,i.jsx)(n.code,{children:"ado-npm-auth"})," package"]}),", I found myself creating ",(0,i.jsx)(n.code,{children:"azdo-npm-auth"}),". By the way, the package was briefly named ",(0,i.jsx)(n.code,{children:"ado-npm-auth-lite"}),"; I renamed it as I felt ",(0,i.jsx)(n.code,{children:"azdo-npm-auth"})," was a better name."]}),"\n",(0,i.jsxs)(n.h2,{id:"when-do-i-need-to-run-azdo-npm-auth",children:["When do I need to run ",(0,i.jsx)(n.code,{children:"azdo-npm-auth"}),"?"]}),"\n",(0,i.jsxs)(n.p,{children:["Should you encounter the following message when you try to ",(0,i.jsx)(n.code,{children:"npm i"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"npm error code E401\nnpm error Unable to authenticate, your authentication token seems to be invalid.\nnpm error To correct this please try logging in again with:\nnpm error npm login\n"})}),"\n",(0,i.jsx)(n.p,{children:"OR"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"npm error code E401\nnpm error Incorrect or missing password.\nnpm error If you were trying to login, change your password, create an\nnpm error authentication token or enable two-factor authentication then\nnpm error that means you likely typed your password in incorrectly.\nnpm error Please try again, or recover your password at:\nnpm error   https://www.npmjs.com/forgot\nnpm error\nnpm error If you were doing some other operation then your saved credentials are\nnpm error probably out of date. To correct this please try logging in again with:\nnpm error   npm login\n"})}),"\n",(0,i.jsx)(n.p,{children:"That means either:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["You have no user ",(0,i.jsx)(n.code,{children:".npmrc"})," file ",(0,i.jsx)(n.strong,{children:"OR"})]}),"\n",(0,i.jsxs)(n.li,{children:["The token in your user ",(0,i.jsx)(n.code,{children:".npmrc"})," file is out of date"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["In either case, running ",(0,i.jsx)(n.code,{children:"azdo-npm-auth"})," should resolve the issue. But the way you run it is important. To get ",(0,i.jsx)(n.code,{children:"azdo-npm-auth"})," to create the necessary user ",(0,i.jsx)(n.code,{children:".npmrc"})," file for local development, run the following command:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"npx -y --registry https://registry.npmjs.org azdo-npm-auth\n"})}),"\n",(0,i.jsxs)(n.p,{children:["It is possible to use environment variables to control the ",(0,i.jsx)(n.code,{children:"registry"})," setting as well; consider the following (non-Windows compatible) example:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"npm_config_registry=https://registry.npmjs.org npx azdo-npm-auth\n"})}),"\n",(0,i.jsxs)(n.p,{children:["You might be wondering what the ",(0,i.jsx)(n.code,{children:"--registry https://registry.npmjs.org"})," part is for. It is a way to ensure that the ",(0,i.jsx)(n.code,{children:"npx"})," command uses the ",(0,i.jsx)(n.strong,{children:"public"})," npm registry to install ",(0,i.jsx)(n.code,{children:"azdo-npm-auth"}),". Without this, you might encounter a ",(0,i.jsx)(n.code,{children:"npm error code E401"})," error like those above."]}),"\n",(0,i.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"azdo-npm-auth"})," requires that a project ",(0,i.jsx)(n.code,{children:".npmrc"})," file exists in order that it can acquire the information to run."]}),"\n",(0,i.jsxs)(n.p,{children:["There is an optional ",(0,i.jsx)(n.code,{children:"config"})," parameter which allows selection of a specific project ",(0,i.jsx)(n.code,{children:".npmrc"})," file. If the ",(0,i.jsx)(n.code,{children:"config"})," parameter is not supplied, ",(0,i.jsx)(n.code,{children:"azdo-npm-auth"})," will default to use the ",(0,i.jsx)(n.code,{children:".npmrc"})," in the current project directory."]}),"\n",(0,i.jsxs)(n.p,{children:["Should you not have one of these files already, there will be information in your Azure DevOps Artifacts section for connecting to the npm feed around creating a project ",(0,i.jsx)(n.code,{children:".npmrc"})," file. The required file should look something like this:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"registry=https://pkgs.dev.azure.com/johnnyreilly/_packaging/npmrc-script-organization/npm/registry/\n\nalways-auth=true\n"})}),"\n",(0,i.jsx)(n.h2,{id:"authenticating-to-azure",children:"Authenticating to Azure"}),"\n",(0,i.jsxs)(n.p,{children:["If you would like ",(0,i.jsx)(n.code,{children:"azdo-npm-auth"})," to acquire a token on your behalf, then it requires that your ",(0,i.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/devops/organizations/accounts/connect-organization-to-azure-ad?view=azure-devops",children:"Azure DevOps organisation is connected with your Azure account / Microsoft Entra ID"}),". Then, assuming you are authenticated with Azure, it can acquire an Azure DevOps Personal Access Token on your behalf. To authenticate, run ",(0,i.jsx)(n.code,{children:"az login"}),". ",(0,i.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/cli/azure/install-azure-cli",children:"If you need to install the Azure CLI, follow these instructions"}),". It is not necessary to run ",(0,i.jsx)(n.code,{children:"az login"})," if you are already authenticated with Azure."]}),"\n",(0,i.jsxs)(n.p,{children:["If you would like to acquire a PAT token manually, there is a ",(0,i.jsx)(n.code,{children:"--pat"})," option for that very circumstance."]}),"\n",(0,i.jsxs)(n.h2,{id:"integration-with-packagejson",children:["Integration with ",(0,i.jsx)(n.code,{children:"package.json"})]}),"\n",(0,i.jsxs)(n.h3,{id:"using-a-preinstall-script",children:["Using a ",(0,i.jsx)(n.code,{children:"preinstall"})," script"]}),"\n",(0,i.jsxs)(n.p,{children:["A great way to integrate ",(0,i.jsx)(n.code,{children:"azdo-npm-auth"})," is by using it in a ",(0,i.jsx)(n.code,{children:"preinstall"})," script in your ",(0,i.jsx)(n.code,{children:"package.json"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'"scripts": {\n  "preinstall": "npx --yes azdo-npm-auth --config ./subdirectory-with-another-package-json/.npmrc"\n},\n'})}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"--yes"})," flag above simply skips having npm challenge the user as to whether to download the package."]}),"\n",(0,i.jsxs)(n.p,{children:["However, as you're probably noticing, this requires having multiple ",(0,i.jsx)(n.code,{children:"package.json"}),"s and only having the ",(0,i.jsx)(n.code,{children:".npmrc"})," file in the nested one. Assuming that works for you, brilliant. It may not - no worries. We'll talk about that in a second."]}),"\n",(0,i.jsxs)(n.p,{children:["With the above ",(0,i.jsx)(n.code,{children:"preinstall"})," script in place, when the user performs ",(0,i.jsx)(n.code,{children:"npm i"})," or similar, before attempting to install, the relevant user ",(0,i.jsx)(n.code,{children:".npmrc"})," file will be put in place so that installation just works\u2122\uFE0F. This is a ",(0,i.jsx)(n.strong,{children:"great"})," developer experience."]}),"\n",(0,i.jsxs)(n.h3,{id:"using-an-auth-script",children:["Using an ",(0,i.jsx)(n.code,{children:"auth"})," script"]}),"\n",(0,i.jsxs)(n.p,{children:["If the complexity of nested ",(0,i.jsx)(n.code,{children:"package.json"}),"s doesn't work for you, we generally advise setting up a script like the one below:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'"scripts": {\n  "auth": "npx -y --registry https://registry.npmjs.org azdo-npm-auth"\n},\n'})}),"\n",(0,i.jsxs)(n.p,{children:["And running ",(0,i.jsx)(n.code,{children:"npm run auth"})," when a ",(0,i.jsx)(n.code,{children:"npm error code E401"})," is encountered. (Your script doesn't have to be called ",(0,i.jsx)(n.code,{children:"auth"})," necessarily - if you like you could call it ",(0,i.jsx)(n.code,{children:"fix-code-e401"}),", or something else entirely.)"]}),"\n",(0,i.jsx)(n.h2,{id:"what-about-ci",children:"What about CI?"}),"\n",(0,i.jsxs)(n.p,{children:["You might be worried about ",(0,i.jsx)(n.code,{children:"azdo-npm-auth"})," trying to create user ",(0,i.jsx)(n.code,{children:".npmrc"})," files when running CI builds. Happily this does not happen; it detects whether it is running in a CI environment and does ",(0,i.jsx)(n.strong,{children:"not"})," create a user ",(0,i.jsx)(n.code,{children:".npmrc"})," file in that case."]}),"\n",(0,i.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,i.jsxs)(n.p,{children:["If you're a Mac or a Linux user, hopefully ",(0,i.jsx)(n.code,{children:"azdo-npm-auth"})," can significantly ease the friction experienced doing local development with Azure DevOps npm feeds. You can see the ",(0,i.jsx)(n.a,{href:"https://github.com/johnnyreilly/azdo-npm-auth",children:"project code on GitHub here"}),"."]})]})}function h(e={}){let{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},23642:function(e,n,t){t.d(n,{Z:function(){return r}});let r=t.p+"assets/images/title-image-20d2fea1b99047c4bfb7a058a01ab1fb.png"},68755:function(e,n,t){t.d(n,{Z:function(){return r}});let r=t.p+"assets/images/screenshot-onboarding-with-other-f763bbba47f0835be032ce1bdeb202bb.png"},27033:function(e,n,t){t.d(n,{Z:function(){return r}});let r=t.p+"assets/images/screenshot-onboarding-with-windows-f829c5e94b4ccdc17ec2c9c325cfaca5.png"},62805:function(e,n,t){t.d(n,{Z:function(){return r}});let r=t.p+"assets/images/title-image-20d2fea1b99047c4bfb7a058a01ab1fb.png"},50065:function(e,n,t){t.d(n,{Z:function(){return a},a:function(){return s}});var r=t(67294);let i={},o=r.createContext(i);function s(e){let n=r.useContext(o);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),r.createElement(o.Provider,{value:n},e.children)}},31165:function(e){e.exports=JSON.parse('{"permalink":"/introducing-azdo-npm-auth","editUrl":"https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2024-11-09-introducing-azdo-npm-auth/index.md","source":"@site/blog/2024-11-09-introducing-azdo-npm-auth/index.md","title":"Introducing azdo-npm-auth (Azure DevOps npm auth)","description":"Azure DevOps npm auth eases setting up local authentication to Azure DevOps npm feeds, particularly for non Windows users.","date":"2024-11-09T00:00:00.000Z","tags":[{"inline":false,"label":"Azure DevOps","permalink":"/tags/azure-devops","description":"The Azure DevOps suite of tools."},{"inline":false,"label":"Node.js","permalink":"/tags/node-js","description":"The Node.js runtime."}],"readingTime":5.23,"hasTruncateMarker":true,"authors":[{"name":"John Reilly","title":"OSS Engineer - TypeScript, Azure, React, Node.js, .NET","url":"https://johnnyreilly.com/about","imageURL":"https://johnnyreilly.com/img/profile.jpg","key":"johnnyreilly","page":null}],"frontMatter":{"slug":"introducing-azdo-npm-auth","title":"Introducing azdo-npm-auth (Azure DevOps npm auth)","authors":"johnnyreilly","tags":["azure devops","node.js"],"image":"./title-image.png","hide_table_of_contents":false,"description":"Azure DevOps npm auth eases setting up local authentication to Azure DevOps npm feeds, particularly for non Windows users."},"unlisted":false,"prevItem":{"title":"Azure Artifacts: Publish a private npm package with Azure DevOps","permalink":"/azure-artifacts-publish-private-npm-package-with-azure-devops"},"nextItem":{"title":"Azure DevOps API: Set User Story column with the Azure DevOps Client for Node.js","permalink":"/azure-devops-set-user-story-column-api"}}')}}]);