"use strict";(self.webpackChunkjohnnyreilly_com=self.webpackChunkjohnnyreilly_com||[]).push([[38997],{839:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/swa-cli-local-auth-7a324cc39d640ff7fd8fd5c1f680c293.webp"},12888:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/title-image-bd0f70a54d087f447ca7b6d544692a83.png"},28453:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>r});var i=n(96540);const a={},s=i.createContext(a);function o(e){const t=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),i.createElement(s.Provider,{value:t},e.children)}},40329:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/screenshot-vite-server-06ee838b6ca49ff9619b840c6e296186.webp"},55255:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/title-image-bd0f70a54d087f447ca7b6d544692a83.png"},61862:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/screenshot-swa-cli-auth-0cb8d333b83d6796d90edf262dbe8ee6.webp"},82212:e=>{e.exports=JSON.parse('{"permalink":"/static-web-apps-cli-local-auth-emulator-with-dotnet-authentication","editUrl":"https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2025-03-29-static-web-apps-cli-local-auth-emulator-with-dotnet-authentication/index.md","source":"@site/blog/2025-03-29-static-web-apps-cli-local-auth-emulator-with-dotnet-authentication/index.md","title":"Static Web Apps CLI: local authentication emulation with ASP.NET","description":"The Static Web Apps CLI has a local authentication emulator. This is a useful tool for local development, and can be used with ASP.NET authentication. This post shows how.","date":"2025-03-29T00:00:00.000Z","tags":[{"inline":false,"label":"Azure Static Web Apps","permalink":"/tags/azure-static-web-apps","description":"The Azure Static Web Apps service."},{"inline":false,"label":"Node.js","permalink":"/tags/node-js","description":"The Node.js runtime."},{"inline":false,"label":"ASP.NET","permalink":"/tags/asp-net","description":"The web framework built by Microsoft."},{"inline":false,"label":"Static Web Apps CLI","permalink":"/tags/static-web-apps-cli","description":"The Static Web Apps CLI is a local development tool which can be used with static web apps / single page applications"}],"readingTime":17.84,"hasTruncateMarker":true,"authors":[{"name":"John Reilly","title":"OSS Engineer - TypeScript, Azure, React, Node.js, .NET","url":"https://johnnyreilly.com/about","imageURL":"https://johnnyreilly.com/img/profile-2025.jpg","key":"johnnyreilly","page":null}],"frontMatter":{"slug":"static-web-apps-cli-local-auth-emulator-with-dotnet-authentication","title":"Static Web Apps CLI: local authentication emulation with ASP.NET","authors":"johnnyreilly","tags":["azure static web apps","node.js","asp.net","static web apps cli"],"image":"./title-image.png","description":"The Static Web Apps CLI has a local authentication emulator. This is a useful tool for local development, and can be used with ASP.NET authentication. This post shows how.","hide_table_of_contents":false},"unlisted":false,"prevItem":{"title":"List Pipelines with the Azure DevOps API","permalink":"/list-pipelines-with-azure-devops-api"},"nextItem":{"title":"Node.js, Azure Application Insights, and Fastify","permalink":"/nodejs-azure-appinsights-fastify"}}')},85098:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>p,frontMatter:()=>o,metadata:()=>i,toc:()=>c});var i=n(82212),a=n(74848),s=n(28453);const o={slug:"static-web-apps-cli-local-auth-emulator-with-dotnet-authentication",title:"Static Web Apps CLI: local authentication emulation with ASP.NET",authors:"johnnyreilly",tags:["azure static web apps","node.js","asp.net","static web apps cli"],image:"./title-image.png",description:"The Static Web Apps CLI has a local authentication emulator. This is a useful tool for local development, and can be used with ASP.NET authentication. This post shows how.",hide_table_of_contents:!1},r=void 0,l={image:n(12888).A,authorsImageUrls:[void 0]},c=[{value:"Local authentication choices",id:"local-authentication-choices",level:2},{value:"What is the Static Web Apps CLI?",id:"what-is-the-static-web-apps-cli",level:2},{value:"How does the Static Web Apps CLI local authentication emulator work?",id:"how-does-the-static-web-apps-cli-local-authentication-emulator-work",level:2},{value:"How is our solution going to work?",id:"how-is-our-solution-going-to-work",level:2},{value:"Time to implement",id:"time-to-implement",level:2},{value:"Setting up the back end",id:"setting-up-the-back-end",level:2},{value:"Setting up the front end",id:"setting-up-the-front-end",level:2},{value:"Set up the Static Web Apps CLI",id:"set-up-the-static-web-apps-cli",level:3},{value:"Set up the Vite server",id:"set-up-the-vite-server",level:3},{value:"Bringing front end and back end together",id:"bringing-front-end-and-back-end-together",level:2},{value:"Testing the authentication",id:"testing-the-authentication",level:2},{value:"Summing up",id:"summing-up",level:2},{value:"Credits",id:"credits",level:2}];function h(e){const t={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(t.p,{children:"When developing web applications that have some dependency on authentication, it can be tricky to get a local development setup that allows you to manage authentication effectively. However, there's a way to achieve this, using the Static Web Apps CLI local authentication emulator."}),"\n",(0,a.jsx)(t.p,{children:(0,a.jsx)(t.img,{alt:"title image reading &quot;Static Web Apps CLI: improve performance with Vite server proxy&quot; with the Static Web Apps CLI and Vite logos",src:n(55255).A+"",width:"800",height:"450",loading:"lazy"})}),"\n",(0,a.jsx)(t.p,{children:"I build a lot of SPA style applications that run JavaScript / TypeScript on the front end and C# / ASP.NET on the back end. The majority of those apps require some kind of authentication. In fact I'd struggle to think of many apps that don't. This post will walk through how to integrate ASP.NET authentication with the Static Web Apps CLI local authentication emulator to achieve a great local development setup. Don't worry if that doesn't make sense right now, once we have walked through the setup, it will."}),"\n",(0,a.jsxs)(t.p,{children:["This post builds somewhat on posts I've written about using the Static Web Apps CLI ",(0,a.jsx)(t.a,{href:"/static-web-apps-cli-improve-performance-with-vite-server-proxy",children:"with the Vite proxy server with for enhanced performance"})," and ",(0,a.jsxs)(t.a,{href:"/static-web-apps-cli-node-18-could-not-connect-to-api",children:["how to use the ",(0,a.jsx)(t.code,{children:"--api-location"})," argument to connect to a separately running backend API"]}),". However, you need not have read either post to understand what we're doing."]}),"\n",(0,a.jsx)(t.p,{children:"We're going to first walk through what we're trying to achieve, and then we'll walk through the steps to get there. When it comes to implementation, we're going to use Vite as our front end server, and ASP.NET as our back end server. The Static Web Apps CLI will be used for local authentication emulation."}),"\n",(0,a.jsx)(t.h2,{id:"local-authentication-choices",children:"Local authentication choices"}),"\n",(0,a.jsxs)(t.p,{children:["When we're building an application, let's think about the options that we have, with regards to our local development setup. It's pretty typical for applications to use some kind of third party authentication provider, rather than providing their own. This could be ",(0,a.jsx)(t.a,{href:"https://www.okta.com/",children:"Okta"}),", ",(0,a.jsx)(t.a,{href:"https://learn.microsoft.com/en-us/entra/identity/authentication/overview-authentication",children:"Microsoft Entra / Azure AD"}),", ",(0,a.jsx)(t.a,{href:"https://auth0.com/",children:"Auth0"})," or something else."]}),"\n",(0,a.jsxs)(t.p,{children:["It's possible to configure a local development setup which integrates with a third party authentication provider. However, is that wise? Do you want to couple your ability to be able to test scenarios on your local machine, to a server, somewhere out there on the internet? You certainly can. It typically involves setting a redirect URI on the authentication provider to ",(0,a.jsx)(t.code,{children:"http://localhost:5173"})," (or wherever your local setup runs)."]}),"\n",(0,a.jsx)(t.p,{children:"But it is inconvenient to get that set up in the first place. And even once it is set up, you're then coupled to being online whenever you're testing locally. We're offline more than we appreciate. I'm writing these words on an aeroplane which is currently flying over Botswana. I have no internet access right now. But as you've gathered, I'm on my computer and I'm able to do things. How? Because I'm using the Azure Static Web Apps CLI local authentication emulator for local development."}),"\n",(0,a.jsx)(t.p,{children:"That's what this post is about. How to use the Static Web Apps CLI local authentication emulator with ASP.NET authentication to enable a great (and offline-first) local development setup."}),"\n",(0,a.jsx)(t.h2,{id:"what-is-the-static-web-apps-cli",children:"What is the Static Web Apps CLI?"}),"\n",(0,a.jsxs)(t.p,{children:["We should probably talk about what the ",(0,a.jsx)(t.a,{href:"https://azure.github.io/static-web-apps-cli/",children:"Static Web Apps CLI"})," is. It describes itself as:"]}),"\n",(0,a.jsxs)(t.blockquote,{children:["\n",(0,a.jsx)(t.p,{children:"The Static Web Apps (SWA) CLI is an open-source commandline tool that streamlines local development and deployment for Azure Static Web Apps."}),"\n"]}),"\n",(0,a.jsxs)(t.p,{children:["It's original purpose was to provide a local development server for an Azure service known as ",(0,a.jsx)(t.a,{href:"https://learn.microsoft.com/en-us/azure/static-web-apps/",children:"Azure Static Web Apps"}),". However, it has a number of features that make it useful for general web application development. For example, it can be used to ",(0,a.jsx)(t.a,{href:"https://azure.github.io/static-web-apps-cli/docs/cli/swa-start#serve-both-the-front-end-app-and-api",children:"proxy requests to a backend API server"}),", and it can also be used to ",(0,a.jsx)(t.a,{href:"https://azure.github.io/static-web-apps-cli/docs/cli/local-auth",children:"emulate authentication"}),"."]}),"\n",(0,a.jsx)(t.p,{children:"We're going to use the authentication emulator to provide a local authentication server whilst we're developing. Just that piece of functionality; we're intentionally only using a subset of the Static Web Apps CLI functionality."}),"\n",(0,a.jsxs)(t.p,{children:["Incidentally, there are alternatives. I'm aware of one other local authentication emulator, which is the ",(0,a.jsx)(t.a,{href:"https://firebase.google.com/docs/emulator-suite/connect_auth",children:"Firebase Authentication Emulator"}),". This could likely be used in a similar way. However, we'll be using the Static Web Apps CLI local authentication emulator."]}),"\n",(0,a.jsx)(t.h2,{id:"how-does-the-static-web-apps-cli-local-authentication-emulator-work",children:"How does the Static Web Apps CLI local authentication emulator work?"}),"\n",(0,a.jsxs)(t.p,{children:["When running the Static Web Apps ",(0,a.jsx)(t.code,{children:"start"})," command, it surfaces login endpoints at this location: ",(0,a.jsx)(t.code,{children:"http://localhost:4280/.auth/login/<PROVIDER_NAME>"}),". ",(0,a.jsx)(t.code,{children:"<PROVIDER_NAME>"})," is the name of the authentication provider you want to use. This might be ",(0,a.jsx)(t.code,{children:"aad"}),", ",(0,a.jsx)(t.code,{children:"github"})," etc. If you look at the code (",(0,a.jsx)(t.a,{href:"https://github.com/Azure/static-web-apps-cli/blob/062fb288d34126a095be6f3e1dc57fe5adb3f4bf/src/public/auth.html",children:"and you can here"}),") you'll realise that the ",(0,a.jsx)(t.code,{children:"<PROVIDER_NAME>"})," can actually be any string; it's not limited to the names of the authentication providers that are supported by Azure Static Web Apps. So if you want to use an arbitary name like ",(0,a.jsx)(t.code,{children:"potato"})," as the provider name, you can do that. In terms of emulation, it doesn't matter what the provider name is."]}),"\n",(0,a.jsx)(t.p,{children:"When started, the CLI will serve a local authentication UI at this endpoint which looks like this:"}),"\n",(0,a.jsx)(t.p,{children:(0,a.jsx)(t.img,{alt:"screenshot of Static Web Apps CLI local authentication emulator at work",src:n(839).A+"",width:"1394",height:"1756",loading:"lazy"})}),"\n",(0,a.jsxs)(t.p,{children:["When you hit the ",(0,a.jsx)(t.code,{children:"Login"})," button, it will use the form data to create a fake user and ",(0,a.jsxs)(t.a,{href:"https://github.com/Azure/static-web-apps-cli/blob/062fb288d34126a095be6f3e1dc57fe5adb3f4bf/src/public/auth.html#L193-L196",children:["set a cookie in your browser named ",(0,a.jsx)(t.code,{children:"StaticWebAppsAuthCookie"})]}),". That cookie will look something like this:"]}),"\n",(0,a.jsx)(t.p,{children:(0,a.jsx)(t.img,{alt:"screenshot of the StaticWebAppsAuthCookie in Chrome Devtools",src:n(88547).A+"",width:"2360",height:"582",loading:"lazy"})}),"\n",(0,a.jsxs)(t.p,{children:["And whilst it looks like a JWT, it isn't. It's actually a base64 encoded string which contains the user information that you provided in the form. In fact you can see what it is by flipping open the browser devtools and running this code in the console after you have hit the ",(0,a.jsx)(t.code,{children:"Login"})," button:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-js",children:"JSON.parse(\n  atob(\n    document.cookie\n      .split('; ')\n      .find((row) => row.startsWith('StaticWebAppsAuthCookie='))\n      ?.split('=')[1],\n  ),\n);\n"})}),"\n",(0,a.jsx)(t.p,{children:"This will acquire the cookie that has just been created by the Static Web Apps CLI local authentication emulator from your browser. It then decodes it and parses the JSON string to get the user information that you provided in the form. It produces something like this:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-json",children:'{\n  "userId": "4a27b7326639199f5de91c4b9a62531b",\n  "userRoles": ["anonymous", "authenticated", "other-role"],\n  "claims": [{ "typ": "MyId", "val": "123456789" }],\n  "identityProvider": "couldbeanything",\n  "userDetails": "megan.s@thing.com"\n}\n'})}),"\n",(0,a.jsx)(t.p,{children:"This cookie will be sent to your backend API server with every request."}),"\n",(0,a.jsx)(t.h2,{id:"how-is-our-solution-going-to-work",children:"How is our solution going to work?"}),"\n",(0,a.jsx)(t.p,{children:"To make a working development setup, we need three things:"}),"\n",(0,a.jsxs)(t.ol,{children:["\n",(0,a.jsx)(t.li,{children:"A front end server (Vite)"}),"\n",(0,a.jsx)(t.li,{children:"A back end server (ASP.NET)"}),"\n",(0,a.jsx)(t.li,{children:"A local authentication server (Static Web Apps CLI)"}),"\n"]}),"\n",(0,a.jsx)(t.p,{children:"We'll bring these three things together to create a local development setup that allows us to develop our application locally, with authentication. This diagram shows how the three components will work together:"}),"\n",(0,a.jsx)(t.mermaid,{value:'graph TD\n    subgraph Network traffic\n        UserBrowser[<img src="./img/icon-noun-browser.svg" style="height: 50px" /> Developer\'s local browser]\n        ViteProxy[<img src="./img/icon-noun-server.svg" style="height: 50px" /> Vite server http:\\/\\/localhost:5173]\n        AuthEmulator[<img src="./img/icon-noun-server.svg" style="height: 50px" /> Static Web App CLI local authentication emulator http:\\/\\/localhost:4280]\n        DotNetBackend[<img src="./img/icon-noun-server.svg" style="height: 50px" /> ASP.NET Backend http:\\/\\/localhost:5000]\n    end\n\n    UserBrowser --\x3e ViteProxy\n    ViteProxy --\x3e | authentication requests | AuthEmulator\n    ViteProxy --\x3e | all other requests | DotNetBackend'}),"\n",(0,a.jsxs)(t.p,{children:["From the developer's browser, HTTP requests will be sent to the Vite server running on ",(0,a.jsx)(t.code,{children:"http://localhost:5173"}),". The Vite server will proxy authentication emulation requests to the Static Web Apps CLI local authentication emulator running on ",(0,a.jsx)(t.code,{children:"http://localhost:4280"}),". All other requests will be proxied to the ASP.NET backend server running on ",(0,a.jsx)(t.code,{children:"http://localhost:5000"}),"."]}),"\n",(0,a.jsx)(t.p,{children:"This setup means that the cookie that is set by the Static Web Apps CLI local authentication emulator will be shared with the ASP.NET backend server through the Vite proxy mechanism. So to make the ASP.NET authentication work, we need to make sure that the ASP.NET server is configured to accept this cookie and use it to authenticate the user."}),"\n",(0,a.jsx)(t.h2,{id:"time-to-implement",children:"Time to implement"}),"\n",(0,a.jsxs)(t.p,{children:["Now that we've talked about what we're trying to achieve, let's walk through the steps to get there. We'll need both the .NET SDK and Node.js installed on our machine. From here on out it's code. The full example can be found in ",(0,a.jsx)(t.a,{href:"https://github.com/johnnyreilly/swa-local-auth-emulator-and-dotnet",children:"this GitHub repository"}),"."]}),"\n",(0,a.jsxs)(t.p,{children:["We'll start by creating a new Vite project in a folder we'll call ",(0,a.jsx)(t.code,{children:"AppFrontEnd"}),". We'll use the React + TypeScript template. You can use whatever template you like:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-bash",children:"npm create vite@latest AppFrontEnd -- --template react-ts\n"})}),"\n",(0,a.jsxs)(t.p,{children:["Next we'll create a new ASP.NET project in a folder we'll call ",(0,a.jsx)(t.code,{children:"AppBackEnd"}),":"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-bash",children:"dotnet new web -n AppBackEnd\n"})}),"\n",(0,a.jsxs)(t.p,{children:["And we'll initialise a ",(0,a.jsx)(t.code,{children:"package.json"})," in the root of our project:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-bash",children:"npm init -y\n"})}),"\n",(0,a.jsxs)(t.p,{children:["This ",(0,a.jsx)(t.code,{children:"package.json"})," will be used as a general purpose task runner later on."]}),"\n",(0,a.jsx)(t.h2,{id:"setting-up-the-back-end",children:"Setting up the back end"}),"\n",(0,a.jsxs)(t.p,{children:["We'd first like to adjust the port that our ASP.NET server runs on in development. We'll update the ",(0,a.jsx)(t.code,{children:"launchSettings.json"})," file to look like this:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-json",children:'{\n  "$schema": "https://json.schemastore.org/launchsettings.json",\n  "profiles": {\n    "http": {\n      "commandName": "Project",\n      "dotnetRunMessages": true,\n      "launchBrowser": false,\n      "applicationUrl": "http://localhost:5000",\n      "environmentVariables": {\n        "ASPNETCORE_ENVIRONMENT": "Development"\n      }\n    }\n  }\n}\n'})}),"\n",(0,a.jsxs)(t.p,{children:["This will set the ASP.NET server to run on ",(0,a.jsx)(t.code,{children:"http://localhost:5000"})," in development. You can run the server with ",(0,a.jsx)(t.code,{children:"dotnet run"}),"."]}),"\n",(0,a.jsxs)(t.p,{children:["We need to build an ",(0,a.jsx)(t.code,{children:"AuthenticationHandler"})," that will accept the cookie set by the Static Web Apps CLI local authentication emulator. This is a custom authentication handler that will be used to authenticate users based on the cookie set by the Static Web Apps CLI local authentication emulator. So here the ",(0,a.jsx)(t.code,{children:"StaticWebAppsCLIAuthentication.cs"})," in all its glory:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-cs",children:'using System.Security.Claims;\nusing System.Text.Encodings.Web;\nusing System.Text.Json;\nusing System.Text.Json.Serialization;\n\nusing Microsoft.AspNetCore.Authentication;\nusing Microsoft.Extensions.Options;\n\nnamespace AppBackEnd;\n\npublic static class StaticWebAppsCLIAuthentication\n{\n    public const string STATICWEBAPPSCLIAUTH_SCHEMENAME = "StaticWebAppsCLIAuthScheme";\n\n    public static AuthenticationBuilder AddStaticWebAppsCLIAuth(\n        this AuthenticationBuilder builder,\n        Action<AuthenticationSchemeOptions>? configure = null)\n    {\n        if (configure == null) configure = o => { };\n\n        return builder.AddScheme<AuthenticationSchemeOptions, StaticWebAppsCLIAuthenticationHandler>(\n            STATICWEBAPPSCLIAUTH_SCHEMENAME,\n            STATICWEBAPPSCLIAUTH_SCHEMENAME,\n            configure\n        );\n    }\n}\n\npublic class StaticWebAppsCLIAuthenticationHandler : AuthenticationHandler<AuthenticationSchemeOptions>\n{\n    public StaticWebAppsCLIAuthenticationHandler(\n        IOptionsMonitor<AuthenticationSchemeOptions> options,\n        ILoggerFactory logger,\n        UrlEncoder encoder)\n        : base(options, logger, encoder)\n    {\n    }\n\n    protected override async Task<AuthenticateResult> HandleAuthenticateAsync()\n    {\n        try\n        {\n\n            var principal = await MakeClaimsPrincipalFromHeaderOrCookie(\n                // eg eyJ1c2VySWQiOiIwMTA2ZWMwYmU2MjAwNDM5YjY5ODc3NTFiOGJmNmU3YSIsInVzZXJSb2xlcyI6WyJhbm9ueW1vdXMiLCJhdXRoZW50aWNhdGVkIl0sImNsYWltcyI6W3sidHlwIjoibmFtZSIsInZhbCI6IkF6dXJlIFN0YXRpYyBXZWIgQXBwcyJ9XSwiaWRlbnRpdHlQcm92aWRlciI6ImFhZCIsInVzZXJEZXRhaWxzIjoiam9obm55cmVpbGx5In0\n                Context.Request.Cookies["StaticWebAppsAuthCookie"] ??\n                // eg eyJ1c2VySWQiOiIwMTA2ZWMwYmU2MjAwNDM5YjY5ODc3NTFiOGJmNmU3YSIsInVzZXJSb2xlcyI6WyJhbm9ueW1vdXMiLCJhdXRoZW50aWNhdGVkIl0sImlkZW50aXR5UHJvdmlkZXIiOiJhYWQiLCJ1c2VyRGV0YWlscyI6ImpvaG5ueXJlaWxseSJ9\n                // for reasons that are unclear, the X-MS-CLIENT-PRINCIPAL header presently excludes claims; see https://github.com/Azure/static-web-apps-cli/blob/062fb288d34126a095be6f3e1dc57fe5adb3f4bf/src/msha/handlers/function.handler.ts#L38-L42\n                Context.Request.Headers["X-MS-CLIENT-PRINCIPAL"].FirstOrDefault()\n            );\n\n            if (principal == null)\n                return AuthenticateResult.NoResult();\n\n            Context.User = principal;\n\n            return AuthenticateResult.Success(new AuthenticationTicket(principal, principal.Identity?.AuthenticationType ?? "unknown"));\n        }\n        catch (Exception ex)\n        {\n            return AuthenticateResult.Fail(ex);\n        }\n    }\n\n    private async Task<ClaimsPrincipal?> MakeClaimsPrincipalFromHeaderOrCookie(string? headerOrCookie)\n    {\n        if (string.IsNullOrEmpty(headerOrCookie))\n            return null;\n\n        var decodedBytes = Convert.FromBase64String(headerOrCookie);\n        using var memoryStream = new MemoryStream(decodedBytes);\n        var staticWebAppClientPrinciple = await JsonSerializer.DeserializeAsync<StaticWebAppsCLIClientPrinciple>(memoryStream);\n\n        if (staticWebAppClientPrinciple == null ||\n            string.IsNullOrWhiteSpace(staticWebAppClientPrinciple.UserDetails) ||\n            string.IsNullOrWhiteSpace(staticWebAppClientPrinciple.UserId))\n            return null;\n\n        var claims = DefaultMapClaims(staticWebAppClientPrinciple);\n\n        var principal = new ClaimsPrincipal();\n        principal.AddIdentity(new ClaimsIdentity(\n            claims,\n            authenticationType: staticWebAppClientPrinciple.IdentityProvider ?? "unknown",\n            nameType: ClaimTypes.Email,\n            roleType: ClaimTypes.Role\n        ));\n\n        return principal;\n    }\n\n    /// <summary>\n    /// Method takes the StaticWebAppClientPrinciple and produces a list of claims constructed\n    /// from the claims, user details and user roles\n    /// </summary>\n    static Claim[] DefaultMapClaims(StaticWebAppsCLIClientPrinciple staticWebAppClientPrinciple)\n    {\n        var claims = new List<StaticWebAppsCLIClaim>();\n        if (!string.IsNullOrWhiteSpace(staticWebAppClientPrinciple.UserDetails))\n        {\n            claims.Add(new StaticWebAppsCLIClaim\n            {\n                Type = "preferred_username",\n                Value = staticWebAppClientPrinciple.UserDetails\n            });\n            claims.Add(new StaticWebAppsCLIClaim\n            {\n                Type = ClaimTypes.Email,\n                Value = staticWebAppClientPrinciple.UserDetails\n            });\n            claims.Add(new StaticWebAppsCLIClaim\n            {\n                Type = ClaimTypes.Name,\n                Value = staticWebAppClientPrinciple.UserDetails\n            });\n        }\n\n        if (staticWebAppClientPrinciple.Claims != null)\n        {\n            claims.AddRange(staticWebAppClientPrinciple.Claims);\n        }\n\n        var mappedClaims = claims.Select(claim => new Claim(claim.Type, claim.Value));\n        // translate the user roles into claims with the type ClaimTypes.Role\n        // eg "userRoles": ["anonymous", "authenticated"]\n        var userRoleClaims = staticWebAppClientPrinciple.UserRoles?.Select(role =>\n            new Claim(ClaimTypes.Role, role)) ?? [];\n\n        Claim[] combinedClaims = [..mappedClaims, ..userRoleClaims];\n\n        return combinedClaims;\n    }\n}\n\n/// <summary>\n/// This is the JSON object that is decoded from either the\n/// StaticWebAppsAuthCookie cookie or the X-MS-CLIENT-PRINCIPAL header\n/// when working with the Static Web Apps CLI local authentication emulator.\n///\n/// The claims element is not present on the X-MS-CLIENT-PRINCIPAL header\n///\n/// {\n///     "userId": "9b516349fcf5caf60f715703d8804aa7",\n///     "userRoles": [\n///         "anonymous",\n///         "authenticated"\n///     ],\n///     "claims": [{"typ":"blarg","val":"Azure Static Web Apps"}],\n///     "identityProvider": "aad",\n///     "userDetails": "someone.name@company.com"\n/// }\n/// </summary>\npublic class StaticWebAppsCLIClientPrinciple\n{\n    /// <summary>\n    /// User Id\n    /// </summary>\n    [JsonPropertyName("userId")]\n    public string? UserId { get; set; }\n\n    /// <summary>\n    /// User roles\n    /// </summary>\n    [JsonPropertyName("userRoles")]\n    public IEnumerable<string>? UserRoles { get; set; }\n\n    /// <summary>\n    /// Identity provider typically "aad"\n    /// </summary>\n    [JsonPropertyName("identityProvider")]\n    public string? IdentityProvider { get; set; }\n\n    /// <summary>\n    /// User details typically email address\n    /// </summary>\n    [JsonPropertyName("userDetails")]\n    public string? UserDetails { get; set; }\n\n    /// <summary>\n    /// Claims for the user\n    /// </summary>\n    [JsonPropertyName("claims")]\n    public IEnumerable<StaticWebAppsCLIClaim>? Claims { get; set; } = [];\n}\n\npublic class StaticWebAppsCLIClaim\n{\n    /// <summary>\n    /// Type of claim eg "name"\n    /// </summary>\n    [JsonPropertyName("typ")]\n    public string Type { get; set; } = string.Empty;\n    /// <summary>\n    /// Value of claim eg "Someone Name"\n    /// </summary>\n    [JsonPropertyName("val")]\n    public string Value { get; set; } = string.Empty;\n}\n'})}),"\n",(0,a.jsx)(t.p,{children:"Whilst there's a good amount of code here, what we're actually doing is relatively simple:"}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsxs)(t.li,{children:["We define a custom authentication scheme called ",(0,a.jsx)(t.code,{children:"StaticWebAppsCLIAuthScheme"})]}),"\n",(0,a.jsxs)(t.li,{children:["We define a custom authentication handler called ",(0,a.jsx)(t.code,{children:"StaticWebAppsCLIAuthenticationHandler"}),". The handler will decode the cookie and create a ",(0,a.jsx)(t.code,{children:"ClaimsPrincipal"})," object that contains the user information it. This will be used to authenticate users based on the cookie that has been set by the Static Web Apps CLI local authentication emulator. If the ",(0,a.jsx)(t.code,{children:"StaticWebAppsAuthCookie"})," cookie is not detected, the handler will fallback to the ",(0,a.jsx)(t.code,{children:"X-MS-CLIENT-PRINCIPAL"})," header. (This should never happen in practice, but it's there for completeness.)"]}),"\n"]}),"\n",(0,a.jsxs)(t.p,{children:["With our handler in place, we need to update the ",(0,a.jsx)(t.code,{children:"Program.cs"})," file in the ",(0,a.jsx)(t.code,{children:"AppBackEnd"})," project to use it. We'll also add a ",(0,a.jsx)(t.code,{children:"/api/me"})," endpoint to test the authentication. So the modified ",(0,a.jsx)(t.code,{children:"Program.cs"})," file looks like this:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-cs",children:'using AppBackEnd;\n\nvar builder = WebApplication.CreateBuilder(args);\n\nif (builder.Environment.IsDevelopment())\n{\n    // in development, we want to use the Static Web Apps CLI authentication scheme\n    builder.Services\n        .AddAuthentication(StaticWebAppsCLIAuthentication.STATICWEBAPPSCLIAUTH_SCHEMENAME)\n        .AddStaticWebAppsCLIAuth();\n}\nelse\n{\n    // in production we will use an alternative authentication scheme\n    // ...\n}\n\nbuilder.Services.AddAuthorization();\n\nvar app = builder.Build();\n\napp.UseAuthentication();\napp.UseAuthorization();\n\napp.MapGet("/", () => "Hello World!");\n\napp.MapGet("/api/me", (context) => {\n    var user = context.User;\n    var roleClaimType = user.Identities.First().RoleClaimType;\n\n    var userDetails = new {\n        user.Identity?.Name,\n        user.Identity?.IsAuthenticated,\n        Claims = user.Claims.Select(claim => new { claim.Type, claim.Value }).ToArray(),\n    };\n\n    return context.Response.WriteAsJsonAsync(userDetails);\n});\n\napp.Run();\n'})}),"\n",(0,a.jsxs)(t.p,{children:["I haven't included the production authentication scheme here; that will be specific to your application. The important part is that we are using the ",(0,a.jsx)(t.code,{children:"StaticWebAppsCLIAuthentication"})," scheme in only in development."]}),"\n",(0,a.jsxs)(t.p,{children:["Let's test this works. We'll start the ASP.NET server with ",(0,a.jsx)(t.code,{children:"dotnet run"}),". Then we'll use the ",(0,a.jsx)(t.code,{children:"curl"})," command to call the ",(0,a.jsx)(t.code,{children:"/api/me"})," endpoint:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-bash",children:'curl http://localhost:5000/api/me --cookie "StaticWebAppsAuthCookie=eyJ1c2VySWQiOiIxNDdmMTVjNmFiODBhNmY3NjJhOWQyZDRmNzczNzUwOSIsInVzZXJSb2xlcyI6WyJhbm9ueW1vdXMiLCJhdXRoZW50aWNhdGVkIiwib3RoZXItcm9sZSJdLCJjbGFpbXMiOlt7InR5cCI6Ik15SWQiLCJ2YWwiOiIxMjM0NTY3ODkifV0sImlkZW50aXR5UHJvdmlkZXIiOiJjb3VsZGJlYW55dGhpbmciLCJ1c2VyRGV0YWlscyI6Im1lZ2FuLnNAdGhpbmcuY29tIn0="\n'})}),"\n",(0,a.jsx)(t.p,{children:"This will return the user information that was set in the cookie by the Static Web Apps CLI local authentication emulator:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-json",children:'{\n  "name": "megan.s@thing.com",\n  "isAuthenticated": true,\n  "claims": [\n    {\n      "type": "preferred_username",\n      "value": "megan.s@thing.com"\n    },\n    {\n      "type": "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress",\n      "value": "megan.s@thing.com"\n    },\n    {\n      "type": "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name",\n      "value": "megan.s@thing.com"\n    },\n    {\n      "type": "MyId",\n      "value": "123456789"\n    },\n    {\n      "type": "http://schemas.microsoft.com/ws/2008/06/identity/claims/role",\n      "value": "anonymous"\n    },\n    {\n      "type": "http://schemas.microsoft.com/ws/2008/06/identity/claims/role",\n      "value": "authenticated"\n    },\n    {\n      "type": "http://schemas.microsoft.com/ws/2008/06/identity/claims/role",\n      "value": "other-role"\n    }\n  ]\n}\n'})}),"\n",(0,a.jsx)(t.p,{children:"So our authentication mechanism works! Now we just need to set up the Vite server and the Static Web Apps CLI local authentication emulator to provide the full local development experience."}),"\n",(0,a.jsx)(t.h2,{id:"setting-up-the-front-end",children:"Setting up the front end"}),"\n",(0,a.jsxs)(t.p,{children:["Now we'll move over to the ",(0,a.jsx)(t.code,{children:"AppFrontEnd"})," folder."]}),"\n",(0,a.jsx)(t.h3,{id:"set-up-the-static-web-apps-cli",children:"Set up the Static Web Apps CLI"}),"\n",(0,a.jsx)(t.p,{children:"We'll install the Static Web Apps CLI as a development dependency:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-bash",children:"npm install -D @azure/static-web-apps-cli\n"})}),"\n",(0,a.jsxs)(t.p,{children:["And we'll add a ",(0,a.jsx)(t.code,{children:"start"})," script to the ",(0,a.jsx)(t.code,{children:"package.json"})," file to start the Static Web Apps CLI and the Vite server. The ",(0,a.jsx)(t.code,{children:"start"})," script will look like this:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-json",children:'{\n  "scripts": {\n    "start": "swa start http://localhost:5173 --run \\"npm run dev\\" --api-devserver-url http://127.0.0.1:5000"\n  }\n}\n'})}),"\n",(0,a.jsxs)(t.p,{children:["When run, this will start the Static Web App CLI and the Vite server. The ",(0,a.jsx)(t.code,{children:"--run"})," argument will start the Vite server, and the ",(0,a.jsx)(t.code,{children:"--api-devserver-url"})," argument will set the URL of the ASP.NET backend server. We'll create a mechanism for starting the ASP.NET server alongside the front end shortly."]}),"\n",(0,a.jsx)(t.h3,{id:"set-up-the-vite-server",children:"Set up the Vite server"}),"\n",(0,a.jsx)(t.p,{children:"We already have the Vite server in place, but it needs a little configuration."}),"\n",(0,a.jsxs)(t.p,{children:["I'm now going to borrow from ",(0,a.jsx)(t.a,{href:"/static-web-apps-cli-improve-performance-with-vite-server-proxy",children:"this post on using the Vite proxy server with for enhanced performance"}),". We'll update the ",(0,a.jsx)(t.code,{children:"vite.config.ts"})," file to add a proxy configuration. The ",(0,a.jsx)(t.code,{children:"vite.config.ts"})," file will look like this:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-ts",children:"import { defineConfig } from 'vite';\n\n// https://vitejs.dev/config/\nexport default defineConfig({\n  // ...\n  server: {\n    proxy: {\n      '/api': {\n        // our .NET application is running on port 5000\n        target: 'http://127.0.0.1:5000',\n        changeOrigin: true,\n        autoRewrite: true,\n      },\n      '/.auth': {\n        // the Static Web Apps local auth emulator is running on port 4280\n        target: 'http://127.0.0.1:4280',\n        changeOrigin: true,\n        autoRewrite: true,\n      },\n    },\n  },\n});\n"})}),"\n",(0,a.jsxs)(t.p,{children:["The code above is responsible for ensuring that requests to the Vite server with the prefix ",(0,a.jsx)(t.code,{children:"/.auth"})," are proxied to the Static Web Apps CLI local authentication emulator. Requests with the prefix ",(0,a.jsx)(t.code,{children:"/api"})," (most requests) are proxied to the ASP.NET backend server."]}),"\n",(0,a.jsxs)(t.p,{children:["With this in place, the Static Web Apps CLI local authentication emulator will be able to set the ",(0,a.jsx)(t.code,{children:"StaticWebAppsAuthCookie"})," cookie in the browser, and the Vite server will proxy requests with that cookie to the ASP.NET backend server for use."]}),"\n",(0,a.jsx)(t.h2,{id:"bringing-front-end-and-back-end-together",children:"Bringing front end and back end together"}),"\n",(0,a.jsxs)(t.p,{children:["We now have a back end and a front end in place. We need both to be running for local development. We mentioned earlier we'd be using the ",(0,a.jsx)(t.code,{children:"package.json"})," in the root of the project as a task runner."]}),"\n",(0,a.jsxs)(t.p,{children:["We'll use the ",(0,a.jsx)(t.a,{href:"https://github.com/open-cli-tools/concurrently",children:(0,a.jsx)(t.code,{children:"concurrently"})})," package to allow us to run both the ASP.NET server and the Static Web Apps CLI local authentication emulator at the same time."]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-bash",children:"npm install -D concurrently\n"})}),"\n",(0,a.jsxs)(t.p,{children:["And we'll update the ",(0,a.jsx)(t.code,{children:"scripts"})," section of the ",(0,a.jsx)(t.code,{children:"package.json"})," as follows:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-json",children:'{\n  "scripts": {\n    "postinstall": "npm run install:frontend && npm run install:backend",\n    "install:frontend": "cd AppFrontEnd && npm install",\n    "install:backend": "cd AppBackEnd && dotnet restore",\n    "start": "concurrently -n \\"FE,BE\\" -c \\"bgBlue.bold,bgMagenta.bold\\" \\"npm run start:frontend\\" \\"npm run start:backend\\"",\n    "start:frontend": "cd AppFrontEnd && npm run start",\n    "start:backend": "cd AppBackEnd && dotnet watch run"\n  }\n}\n'})}),"\n",(0,a.jsx)(t.p,{children:"We can now install all our dependencies (front end and backend) with a single command:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-bash",children:"npm install\n"})}),"\n",(0,a.jsx)(t.p,{children:"Then we can start the local development server with:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-bash",children:"npm start\n"})}),"\n",(0,a.jsxs)(t.p,{children:["If we then go to ",(0,a.jsx)(t.code,{children:"http://localhost:5173"}),", we should see the Vite server running:"]}),"\n",(0,a.jsx)(t.p,{children:(0,a.jsx)(t.img,{alt:"screenshot of Vite server running",src:n(40329).A+"",width:"1272",height:"1348",loading:"lazy"})}),"\n",(0,a.jsx)(t.p,{children:"So far, this is just the Vite server. Time to get our login mechanism in place."}),"\n",(0,a.jsx)(t.h2,{id:"testing-the-authentication",children:"Testing the authentication"}),"\n",(0,a.jsxs)(t.p,{children:["We're going to replace the contents of the ",(0,a.jsx)(t.code,{children:"src/App.tsx"})," file in the ",(0,a.jsx)(t.code,{children:"AppFrontEnd"})," project with code that will call the ",(0,a.jsx)(t.code,{children:"/api/me"})," endpoint on the ASP.NET backend server to get the user information from the cookie set by the Static Web Apps CLI local authentication emulator and display it in the browser. If the user is not authenticated, it will show a login link."]}),"\n",(0,a.jsx)(t.p,{children:"A reminder, we're using React and TypeScript for our front end. But that's just because it's my preference; this technique is front end agnostic. You can use whatever framework (or none) that you like."}),"\n",(0,a.jsx)(t.p,{children:"Our implementation will look like this:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-tsx",children:"import { useState, useEffect } from 'react';\nimport './App.css';\n\ninterface UserData {\n  name: string | null;\n  isAuthenticated: boolean;\n  claims: { type: string; value: string }[];\n}\n\nfunction App() {\n  const [userData, setUserData] = useState<UserData>();\n\n  useEffect(() => {\n    async function fetchData() {\n      try {\n        const response = await fetch('/api/me');\n        if (!response.ok) {\n          throw new Error('Failed to fetch user data');\n        }\n        const data = await response.json();\n        setUserData(data);\n      } catch (error) {\n        console.error('Error fetching user data:', error);\n      }\n    }\n\n    fetchData();\n  }, []);\n\n  return (\n    <>\n      <h1>Static Web Apps CLI:</h1>\n      <h2>local authentication emulation with ASP.NET</h2>\n      {userData ? (\n        userData.isAuthenticated ? (\n          <p style={{ textAlign: 'left' }}>\n            You are logged in {userData.name} |{' '}\n            <a href=\"/.auth/logout\">Log out</a>\n            <pre>{JSON.stringify(userData, null, 2)}</pre>\n          </p>\n        ) : (\n          <p>\n            <a href=\"/.auth/login/aad\">Log in</a>\n          </p>\n        )\n      ) : (\n        <p>Loading user data...</p>\n      )}\n    </>\n  );\n}\n\nexport default App;\n"})}),"\n",(0,a.jsxs)(t.p,{children:["Let's test it! First we'll start our local dev setup with ",(0,a.jsx)(t.code,{children:"npm start"}),". When we browse to ",(0,a.jsx)(t.code,{children:"http://localhost:5173"}),", we should see the Vite server running:"]}),"\n",(0,a.jsx)(t.p,{children:(0,a.jsx)(t.img,{alt:"screenshot of the browser when not logged in",src:n(98209).A+"",width:"1294",height:"1618",loading:"lazy"})}),"\n",(0,a.jsxs)(t.p,{children:["If we click the ",(0,a.jsx)(t.code,{children:"Login"})," link, we'll be taken to the Static Web Apps CLI local authentication emulator. We'll fill in the form and hit ",(0,a.jsx)(t.code,{children:"Login"}),". This will set the ",(0,a.jsx)(t.code,{children:"StaticWebAppsAuthCookie"})," cookie in our browser."]}),"\n",(0,a.jsx)(t.p,{children:(0,a.jsx)(t.img,{alt:"screenshot of the Static Web Apps CLI local auth emulator",src:n(61862).A+"",width:"1294",height:"1618",loading:"lazy"})}),"\n",(0,a.jsxs)(t.p,{children:["We'll be redirected back to the Vite server, and the cookie will be sent to the ASP.NET backend server. The ASP.NET backend server will use the cookie to authenticate the user and return the user information when the browser calls the ",(0,a.jsx)(t.code,{children:"/api/me"})," endpoint. This will be displayed in the browser:"]}),"\n",(0,a.jsx)(t.p,{children:(0,a.jsx)(t.img,{alt:"screenshot of the browser when logged in",src:n(85196).A+"",width:"1294",height:"1618",loading:"lazy"})}),"\n",(0,a.jsx)(t.p,{children:"It works!"}),"\n",(0,a.jsx)(t.h2,{id:"summing-up",children:"Summing up"}),"\n",(0,a.jsx)(t.p,{children:"This has been a long post, but hopefully it has been useful. We've walked through how to set up a local development environment that uses the Static Web Apps CLI local authentication emulator with ASP.NET authentication. This allows us to develop our application locally, with authentication, without being coupled to a third party authentication provider."}),"\n",(0,a.jsxs)(t.p,{children:["The code built in this post ",(0,a.jsx)(t.a,{href:"https://github.com/johnnyreilly/swa-local-auth-emulator-and-dotnet",children:"can be found here"}),"."]}),"\n",(0,a.jsx)(t.h2,{id:"credits",children:"Credits"}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsxs)(t.li,{children:["Server icon by Konstantin Velichko from ",(0,a.jsx)(t.a,{href:"https://thenounproject.com/browse/icons/term/server/",children:"Noun Project"})," (CC BY 3.0)"]}),"\n",(0,a.jsxs)(t.li,{children:["Browser icon by syahruni from ",(0,a.jsx)(t.a,{href:"https://thenounproject.com/browse/icons/term/browser/",children:"Noun Project"})," (CC BY 3.0)"]}),"\n"]})]})}function p(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,a.jsx)(t,{...e,children:(0,a.jsx)(h,{...e})}):h(e)}},85196:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/screenshot-logged-in-cb3e296fdd9bf86d97bbac7440e2764a.png"},88547:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/screenshot-staticwebappsauthcookie-70b7978c3b4d620c7abbe906859bdff2.webp"},98209:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/screenshot-not-logged-in-7f95bc0b6967fef77a1b090aba01aab2.webp"}}]);