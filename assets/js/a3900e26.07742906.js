"use strict";(self.webpackChunkjohnnyreilly_com=self.webpackChunkjohnnyreilly_com||[]).push([[3733],{20684:(e,t,r)=>{r.d(t,{A:()=>n});const n=r.p+"assets/images/title-image-6d92def2e18c2d0c25e0676cc8c1525a.png"},27407:(e,t,r)=>{r.d(t,{A:()=>n});const n=r.p+"assets/images/title-image-6d92def2e18c2d0c25e0676cc8c1525a.png"},28453:(e,t,r)=>{r.d(t,{R:()=>o,x:()=>a});var n=r(96540);const i={},s=n.createContext(i);function o(e){const t=n.useContext(s);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),n.createElement(s.Provider,{value:t},e.children)}},37166:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>d,frontMatter:()=>o,metadata:()=>n,toc:()=>c});var n=r(38906),i=r(74848),s=r(28453);const o={slug:"graph-api-ad-users-group-name-ids-csharp-sdk",title:"Graph API: getting users Active Directory group names and ids with the C# SDK",authors:"johnnyreilly",image:"./title-image.png",tags:["auth","azure","c#","asp.net","microsoft graph"],description:"Learn how to get the Azure Active Directory group names and ids from the Graph API using the C# SDK.",hide_table_of_contents:!1},a=void 0,l={image:r(20684).A,authorsImageUrls:[void 0]},c=[{value:"Related posts",id:"related-posts",level:2},{value:"Azure AD app registration API permissions",id:"azure-ad-app-registration-api-permissions",level:2},{value:"Querying the Graph API",id:"querying-the-graph-api",level:2},{value:"Install the SDK",id:"install-the-sdk",level:3},{value:"Create a GraphServiceClient",id:"create-a-graphserviceclient",level:3},{value:"Query the Graph API",id:"query-the-graph-api",level:3},{value:"Putting it all together",id:"putting-it-all-together",level:2},{value:"Conclusion",id:"conclusion",level:2}];function h(e){const t={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.p,{children:"The Graph API is a great way to get information about users in Azure Active Directory. I recently needed to get the names and ids of the Active Directory groups that a user was a member of. Here's how to do it with the C# SDK."}),"\n",(0,i.jsx)(t.p,{children:"I'm writing this post as, whilst it ends up being a relatively small amount of code and configuration required, if you don't know what that is, you can end up somewhat stuck. This should hopefully unstick you."}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"title image reading &quot;Graph API: getting users AD group names and ids with the C# SDK&quot; with the Azure Graph and C# logos",src:r(27407).A+"",width:"800",height:"450",loading:"lazy"})}),"\n",(0,i.jsx)(t.h2,{id:"related-posts",children:"Related posts"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"/azure-ad-claims-static-web-apps-azure-functions",children:"Azure AD Claims with Static Web Apps and Azure Functions"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"/microsoft-graphclient-filter-endswith-consistencylevel-eventual-header",children:"Microsoft Graph client: how to filter by endswith"})}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"azure-ad-app-registration-api-permissions",children:"Azure AD app registration API permissions"}),"\n",(0,i.jsx)(t.p,{children:"To query the Graph API, we'll need:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"an Azure AD app registration"}),"\n",(0,i.jsx)(t.li,{children:"a client id and client secret for that app registration"}),"\n",(0,i.jsx)(t.li,{children:"the tenant id for the Azure AD tenant that the app registration is in"}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"GroupMember.Read.All"})," and ",(0,i.jsx)(t.code,{children:"User.Read.All"})," API application permissions"]}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"Of the above, it's the API permissions that I want to draw your attention to. Ultimately, you'll need to get your Azure AD admin to grant consent to these permissions for your app registration so you have the necessary permissions to query the Graph API:"}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"screenshot of the Azure Portal showing the API permissions we require",src:r(48343).A+"",width:"3576",height:"1074",loading:"lazy"})}),"\n",(0,i.jsxs)(t.p,{children:["How did I know that I needed these permissions? Great question! I found the answer in the ",(0,i.jsx)(t.a,{href:"https://learn.microsoft.com/en-us/graph/api/directoryobject-getmembergroups?view=graph-rest-1.0&tabs=http#group-memberships-for-a-user",children:'"directoryObject: getMemberGroups / group memberships for a user" documentation'}),"."]}),"\n",(0,i.jsxs)(t.p,{children:["The Application ",(0,i.jsx)(t.code,{children:"User.Read.All"})," and ",(0,i.jsx)(t.code,{children:"GroupMember.Read.All"})," permissions are the least privileged permissions that allow you to query the Graph API for the information we need. If you're interested in the other permissions available, check out the ",(0,i.jsx)(t.a,{href:"https://learn.microsoft.com/en-us/graph/permissions-reference",children:"Microsoft Graph permissions reference"}),"."]}),"\n",(0,i.jsx)(t.h2,{id:"querying-the-graph-api",children:"Querying the Graph API"}),"\n",(0,i.jsx)(t.p,{children:"Now we've configured our app registration, we can query the Graph API. I'm going to show you how to do this with the C# SDK. If you're using a different language, you'll need to find the equivalent SDK for your language."}),"\n",(0,i.jsx)(t.h3,{id:"install-the-sdk",children:"Install the SDK"}),"\n",(0,i.jsxs)(t.p,{children:["The first thing we need to do is install the SDK. I'm using the ",(0,i.jsx)(t.a,{href:"https://www.nuget.org/packages/Microsoft.Graph/",children:"Microsoft.Graph"})," package. At the time of writing, the latest version is 5.35.0."]}),"\n",(0,i.jsxs)(t.p,{children:["Once you have added it, you'll have an entry in your ",(0,i.jsx)(t.code,{children:".csproj"})," along these lines:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-xml",metastring:'title="MyApp.csproj"',children:'<PackageReference Include="Microsoft.Graph" Version="5.35.0" />\n'})}),"\n",(0,i.jsxs)(t.p,{children:["If you're interested in the underlying project, you can find it as ",(0,i.jsxs)(t.a,{href:"https://github.com/microsoftgraph/msgraph-sdk-dotnet",children:[(0,i.jsx)(t.code,{children:"msgraph-sdk-dotnet"})," on GitHub"]}),"."]}),"\n",(0,i.jsx)(t.h3,{id:"create-a-graphserviceclient",children:"Create a GraphServiceClient"}),"\n",(0,i.jsxs)(t.p,{children:["Next, we need to create a ",(0,i.jsx)(t.code,{children:"GraphServiceClient"}),". This is the object that we'll use to query the Graph API. For that we'll need a credential which we'll construct using the ",(0,i.jsx)(t.code,{children:"tenantId"}),", ",(0,i.jsx)(t.code,{children:"clientId"})," and ",(0,i.jsx)(t.code,{children:"clientSecret"})," that we got from our app registration:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-cs",children:'using Azure.Identity;\nusing Microsoft.Graph;\n\n// ...\n\n// The client credentials flow requires that you request the\n// /.default scope, and pre-configure your permissions on the\n// app registration in Azure. An administrator must grant consent\n// to those permissions beforehand.\nvar scopes = new[] { "https://graph.microsoft.com/.default" };\n\n// using Azure.Identity;\nvar options = new ClientSecretCredentialOptions\n{\n    AuthorityHost = AzureAuthorityHosts.AzurePublicCloud,\n};\n\n// https://learn.microsoft.com/en-us/graph/sdks/choose-authentication-providers?tabs=csharp#using-a-client-secret\n// https://learn.microsoft.com/dotnet/api/azure.identity.clientsecretcredential\nvar clientSecretCredential = new ClientSecretCredential(\n    tenantId, clientId, clientSecret, options);\n\n_graphClient = new GraphServiceClient(clientSecretCredential, scopes);\n'})}),"\n",(0,i.jsxs)(t.p,{children:["The above code is based on the ",(0,i.jsx)(t.a,{href:"https://learn.microsoft.com/en-us/graph/sdks/choose-authentication-providers?tabs=csharp#using-a-client-secret",children:'"client credentials provider / using a client secret" documentation'}),". It's possible that you might want to use a different authentication provider. If so, check out the ",(0,i.jsx)(t.a,{href:"https://learn.microsoft.com/en-us/graph/sdks/choose-authentication-providers?tabs=csharp",children:'"choose authentication providers" documentation'}),". Because we're querying for application permissions, we need to use the client credentials provider. We could, if we wanted to, use the client certificate approach instead. I'm not going to cover that here."]}),"\n",(0,i.jsx)(t.h3,{id:"query-the-graph-api",children:"Query the Graph API"}),"\n",(0,i.jsxs)(t.p,{children:["Now we come to the fun part. We're going to query the Graph API for the groups that a user is a member of. We'll need to pass in the ",(0,i.jsx)(t.code,{children:"usernameOrId"})," of the user that we're interested in. I'm using the user's email address as the ",(0,i.jsx)(t.code,{children:"usernameOrId"})," in my application. You might want to use the user's id instead. It's up to you."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-cs",children:'List<GroupIdDisplayName> groupIds = new();\n\nMicrosoft.Graph.Models.GroupCollectionResponse? response = await _graphClient.Users[usernameOrId].MemberOf.GraphGroup.GetAsync(requestConfiguration =>\n{\n    requestConfiguration.QueryParameters.Select = ["id", "displayName"];\n    requestConfiguration.QueryParameters.Top = 100;\n});\n\nvar pageIterator = PageIterator<\n    Microsoft.Graph.Models.Group,\n    Microsoft.Graph.Models.GroupCollectionResponse?\n>.CreatePageIterator(_graphClient, response, (group) =>\n{\n    groupIds.Add(new GroupIdDisplayName(Id: group.Id, DisplayName: group.DisplayName));\n    return true;\n});\n\nawait pageIterator.IterateAsync();\n'})}),"\n",(0,i.jsx)(t.p,{children:"Let's unpack the code above. It does the following:"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:["Creates an empty list of ",(0,i.jsx)(t.code,{children:"GroupIdDisplayName"})," objects. This is the type that I'm using to store the group ids and display names. You can use whatever type you want."]}),"\n",(0,i.jsxs)(t.li,{children:["It indexes into the ",(0,i.jsx)(t.code,{children:"Users"})," collection on the ",(0,i.jsx)(t.code,{children:"GraphServiceClient"})," using the ",(0,i.jsx)(t.code,{children:"usernameOrId"})," that we passed in. From there we make use of ",(0,i.jsx)(t.code,{children:"MemberOf.GraphGroup"})," and call ",(0,i.jsx)(t.code,{children:"GetAsync"})," on that, passing in a request configuration method. This is where we specify the ",(0,i.jsx)(t.code,{children:"Select"})," and ",(0,i.jsx)(t.code,{children:"Top"})," query parameters. We're using ",(0,i.jsx)(t.code,{children:"Select"})," to specify only the properties that we want to return - by default lots more data would come back than we require. We're using ",(0,i.jsx)(t.code,{children:"Top"})," to specify the maximum number of results that we want to return. I'm using 100 as that's the maximum that the Graph API will allow. We'll need to use a ",(0,i.jsx)(t.code,{children:"PageIterator"})," to get all of the results. More on that in a moment."]}),"\n",(0,i.jsxs)(t.li,{children:["Because we want to get all of the results, we need to use a ",(0,i.jsx)(t.code,{children:"PageIterator"}),". We create one using the ",(0,i.jsx)(t.code,{children:"CreatePageIterator"})," method on the ",(0,i.jsx)(t.code,{children:"PageIterator"})," class. We pass in the ",(0,i.jsx)(t.code,{children:"GraphServiceClient"})," that we created earlier, the ",(0,i.jsx)(t.code,{children:"response"})," that we got from the ",(0,i.jsx)(t.code,{children:"GetAsync"})," call and a delegate that will be called for each result. In our delegate, we add the ",(0,i.jsx)(t.code,{children:"GroupIdDisplayName"})," to our list and return ",(0,i.jsx)(t.code,{children:"true"})," to indicate that we want to continue iterating. If we wanted to stop iterating, we'd return ",(0,i.jsx)(t.code,{children:"false"}),". Finally we call ",(0,i.jsx)(t.code,{children:"IterateAsync"})," on the ",(0,i.jsx)(t.code,{children:"PageIterator"})," to get all of the results."]}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["The ",(0,i.jsx)(t.code,{children:"PageIterator"})," is somewhat confusing, in my opinion. I'm used to paging through results, but this way of doing it did puzzle me. If you're interested in learning more about the ",(0,i.jsx)(t.code,{children:"PageIterator"}),", check out the ",(0,i.jsx)(t.a,{href:"https://learn.microsoft.com/en-us/graph/sdks/paging?tabs=csharp",children:'"paging" documentation'}),". I also found ",(0,i.jsx)(t.a,{href:"https://github.com/microsoftgraph/msgraph-sdk-dotnet/blob/dev/docs/upgrade-to-v5.md#pageiterator",children:"this documentation helpful"}),"."]}),"\n",(0,i.jsxs)(t.p,{children:["Initially the ",(0,i.jsx)(t.code,{children:"PageIterator"})," was throwing an exception when I used it. ",(0,i.jsx)(t.a,{href:"https://stackoverflow.com/questions/75860298/graphserviceclient-pageitarator-failes-with-the-parsable-does-not-contain-a-col",children:"I found the answer to that on StackOverflow"}),". It turns out that the types you specify for the ",(0,i.jsx)(t.code,{children:"PageIterator"})," need to be correct for the request above; and if not you may be impaced by type mismatches at runtime. The entries that are returned from the API may be wider or simply different to what you require. I've the correct types in my code now - but I mention it just in case."]}),"\n",(0,i.jsx)(t.h2,{id:"putting-it-all-together",children:"Putting it all together"}),"\n",(0,i.jsxs)(t.p,{children:["Ultimately I wrote a ",(0,i.jsx)(t.code,{children:"GroupService"})," that I could use to get the groups for a user. That service looks like this:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-cs",metastring:'title="GroupService.cs"',children:'using Azure.Identity;\nusing Microsoft.Graph;\n\nnamespace ZebraGptContainerApp.Services.Implementations;\n\npublic record GroupIdDisplayName(\n    string? Id,\n    string? DisplayName\n);\n\npublic interface IGroupService\n{\n    Task<List<GroupIdDisplayName>> GetGroups(string usernameOrId);\n}\n\npublic class GroupService : IGroupService\n{\n    private readonly GraphServiceClient _graphClient;\n    private readonly ILogger<GroupService> _logger;\n\n    // new this up in program.cs\n    public GroupService(ILogger<GroupService> logger, string tenantId, string clientId, string clientSecret)\n    {\n        _logger = logger;\n\n        // The client credentials flow requires that you request the\n        // /.default scope, and pre-configure your permissions on the\n        // app registration in Azure. An administrator must grant consent\n        // to those permissions beforehand.\n        var scopes = new[] { "https://graph.microsoft.com/.default" };\n\n        // using Azure.Identity;\n        var options = new ClientSecretCredentialOptions\n        {\n            AuthorityHost = AzureAuthorityHosts.AzurePublicCloud,\n        };\n\n        // https://learn.microsoft.com/en-us/graph/sdks/choose-authentication-providers?tabs=csharp#using-a-client-secret\n        // https://learn.microsoft.com/dotnet/api/azure.identity.clientsecretcredential\n        var clientSecretCredential = new ClientSecretCredential(\n            tenantId, clientId, clientSecret, options);\n\n        _graphClient = new GraphServiceClient(clientSecretCredential, scopes);\n    }\n\n    public async Task<List<GroupIdDisplayName>> GetGroups(string usernameOrId)\n    {\n        // https://stackoverflow.com/questions/75860298/graphserviceclient-pageitarator-failes-with-the-parsable-does-not-contain-a-col\n        try\n        {\n            List<GroupIdDisplayName> groupIds = new();\n\n            Microsoft.Graph.Models.GroupCollectionResponse? response = await _graphClient.Users[usernameOrId].MemberOf.GraphGroup.GetAsync(requestConfiguration =>\n            {\n                requestConfiguration.QueryParameters.Select = ["id", "displayName"];\n                requestConfiguration.QueryParameters.Top = 100;\n            });\n\n            var pageIterator = PageIterator<\n                Microsoft.Graph.Models.Group,\n                Microsoft.Graph.Models.GroupCollectionResponse?\n            >.CreatePageIterator(_graphClient, response, (group) =>\n            {\n                groupIds.Add(new GroupIdDisplayName(Id: group.Id, DisplayName: group.DisplayName));\n                return true;\n            });\n\n            await pageIterator.IterateAsync();\n\n            return groupIds;\n        }\n        catch (Exception ex)\n        {\n            _logger.LogError(ex, "Problem getting groups with usernameOrId {usernameOrId}", usernameOrId);\n            throw new Exception($"Problem getting groups with usernameOrId {usernameOrId}", ex);\n        }\n    }\n}\n'})}),"\n",(0,i.jsxs)(t.p,{children:["It is constructed in ",(0,i.jsx)(t.code,{children:"Program.cs"}),":"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-cs",metastring:'title="Program.cs"',children:'// ...\n\nbuilder.Services.AddSingleton<IGroupService>(serviceProvider =>\n    new GroupService(\n        logger: serviceProvider.GetRequiredService<ILogger<GroupService>>(),\n        tenantId: builder.Configuration.GetValue<string>("TenantId")!,\n        clientId: builder.Configuration.GetValue<string>("ClientId")!,\n        clientSecret: builder.Configuration.GetValue<string>("ClientSecret")!\n    )\n);\n\n// ...\n'})}),"\n",(0,i.jsx)(t.p,{children:"Then I can use it in my controller:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-cs",metastring:'title="GroupsController.cs"',children:'using Microsoft.AspNetCore.Mvc;\n\nnamespace MyApp.Controllers;\n\n[ApiController]\npublic class GroupsController : ControllerBase\n{\n    readonly IGroupService _groupService;\n    readonly ILogger<MeController> _log;\n\n    public GroupsController(IGroupService groupService, ILogger<MeController> log)\n    {\n        _groupService = groupService;\n        _log = log;\n    }\n\n    [HttpGet("api/groups")]\n    public async Task<IActionResult> GetGroups()\n    {\n        string? email = User?.Identity?.Name; // email in my context\n        try\n        {\n            if (string.IsNullOrEmpty(email))\n                return Unauthorized();\n\n            var groups = await _groupService.GetGroups(email);\n            return Ok(groups);\n        }\n        catch (Exception ex)\n        {\n            _log.LogError(ex, "Problem getting groups for {email}", email);\n            return BadRequest($"Problem getting groups for {email}");\n        }\n    }\n}\n'})}),"\n",(0,i.jsxs)(t.p,{children:["When you browse to ",(0,i.jsx)(t.code,{children:"/api/groups"}),", you'll get a JSON response with the group ids and display names:"]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"screenshot of the JSON returned from the controller displaying ids and displayNames",src:r(60120).A+"",width:"926",height:"468",loading:"lazy"})}),"\n",(0,i.jsxs)(t.p,{children:["And if you're anything like me, you'll discover that you are in ",(0,i.jsx)(t.em,{children:"way"})," more groups than you thought you were."]}),"\n",(0,i.jsx)(t.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,i.jsx)(t.p,{children:"This post has demonstrated both the configuration and the code required to query the Graph API for the groups that a user is a member of. Hopefully it also provides something of a reference for acquiring different types of Graph API permissions and using the C# SDK to query the Graph API."})]})}function d(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},38906:e=>{e.exports=JSON.parse('{"permalink":"/graph-api-ad-users-group-name-ids-csharp-sdk","editUrl":"https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2023-11-23-graph-api-ad-users-group-name-ids-csharp-sdk/index.md","source":"@site/blog/2023-11-23-graph-api-ad-users-group-name-ids-csharp-sdk/index.md","title":"Graph API: getting users Active Directory group names and ids with the C# SDK","description":"Learn how to get the Azure Active Directory group names and ids from the Graph API using the C# SDK.","date":"2023-11-23T00:00:00.000Z","tags":[{"inline":false,"label":"Authentication and Authorization","permalink":"/tags/auth","description":"Matters related to identity and permissioning"},{"inline":false,"label":"Azure","permalink":"/tags/azure","description":"The Microsoft cloud platform."},{"inline":false,"label":"C#","permalink":"/tags/csharp","description":"The C# programming language."},{"inline":false,"label":"ASP.NET","permalink":"/tags/asp-net","description":"The web framework built by Microsoft."},{"inline":false,"label":"Microsoft Graph","permalink":"/tags/microsoft-graph","description":"The Microsoft Graph."}],"readingTime":8.44,"hasTruncateMarker":true,"authors":[{"name":"John Reilly","title":"OSS Engineer - TypeScript, Azure, React, Node.js, .NET","url":"https://johnnyreilly.com/about","imageURL":"https://johnnyreilly.com/img/profile.jpg","key":"johnnyreilly","page":null}],"frontMatter":{"slug":"graph-api-ad-users-group-name-ids-csharp-sdk","title":"Graph API: getting users Active Directory group names and ids with the C# SDK","authors":"johnnyreilly","image":"./title-image.png","tags":["auth","azure","c#","asp.net","microsoft graph"],"description":"Learn how to get the Azure Active Directory group names and ids from the Graph API using the C# SDK.","hide_table_of_contents":false},"unlisted":false,"prevItem":{"title":"How we fixed my SEO","permalink":"/how-we-fixed-my-seo"},"nextItem":{"title":"Migrating to v4 Azure Functions Node.js with TypeScript","permalink":"/migrating-azure-functions-node-js-v4-typescript"}}')},48343:(e,t,r)=>{r.d(t,{A:()=>n});const n=r.p+"assets/images/screenshot-azure-app-registration-api-permissions-481a37148442bfa0ae49d95ab40dbeab.png"},60120:(e,t,r)=>{r.d(t,{A:()=>n});const n=r.p+"assets/images/screenshot-group-ids-and-display-names-dc6000021cbc2b95498002e5ce2a42dc.png"}}]);