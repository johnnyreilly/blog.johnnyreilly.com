"use strict";(self.webpackChunkjohnnyreilly_com=self.webpackChunkjohnnyreilly_com||[]).push([[16796],{73807:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>s,default:()=>u,frontMatter:()=>a,metadata:()=>r,toc:()=>l});var o=n(85893),i=n(11151);const a={slug:"azure-open-ai-capacity-quota-bicep",title:"Azure Open AI: handling capacity and quota limits with Bicep",authors:"johnnyreilly",image:"./title-image.png",tags:["azure","bicep"],description:"This post details how to control the capacity of an Azure Open AI deployment with Bicep so that you don't exceed your quota.",hide_table_of_contents:!1},s=void 0,r={permalink:"/azure-open-ai-capacity-quota-bicep",editUrl:"https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2023-08-17-azure-open-ai-capacity-quota-bicep/index.md",source:"@site/blog/2023-08-17-azure-open-ai-capacity-quota-bicep/index.md",title:"Azure Open AI: handling capacity and quota limits with Bicep",description:"This post details how to control the capacity of an Azure Open AI deployment with Bicep so that you don't exceed your quota.",date:"2023-08-17T00:00:00.000Z",formattedDate:"August 17, 2023",tags:[{label:"azure",permalink:"/tags/azure"},{label:"bicep",permalink:"/tags/bicep"}],readingTime:3.445,hasTruncateMarker:!0,authors:[{name:"John Reilly",title:"OSS Engineer - TypeScript, Azure, React, Node.js, .NET",url:"https://johnnyreilly.com/about",imageURL:"https://johnnyreilly.com/img/profile.jpg",key:"johnnyreilly"}],frontMatter:{slug:"azure-open-ai-capacity-quota-bicep",title:"Azure Open AI: handling capacity and quota limits with Bicep",authors:"johnnyreilly",image:"./title-image.png",tags:["azure","bicep"],description:"This post details how to control the capacity of an Azure Open AI deployment with Bicep so that you don't exceed your quota.",hide_table_of_contents:!1},unlisted:!1,prevItem:{title:"TypeScript: The Movie",permalink:"/typescript-documentary"},nextItem:{title:"Azure Pipelines meet Vitest",permalink:"/azure-pipelines-meet-vitest"}},c={image:n(72605).Z,authorsImageUrls:[void 0]},l=[{value:"Viewing capacity and quota limits in the Azure Open AI Studio",id:"viewing-capacity-and-quota-limits-in-the-azure-open-ai-studio",level:2},{value:"Controlling capacity and quota limits with Bicep",id:"controlling-capacity-and-quota-limits-with-bicep",level:2}];function p(e){const t={a:"a",code:"code",h2:"h2",img:"img",p:"p",pre:"pre",...(0,i.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.p,{children:"We're currently in the gold rush period of AI. The world cannot get enough. A consequence of this, is that rationing is in force. It's like the end of the second world war, but with GPUs. This is a good thing, because it means that we can't just spin up as many resources as we like. It's a bad thing, for the exact same reason."}),"\n",(0,o.jsxs)(t.p,{children:["If you're making use of Azure's Open AI resources for your AI needs, you'll be aware that there are ",(0,o.jsx)(t.a,{href:"https://learn.microsoft.com/en-us/azure/ai-services/openai/how-to/quota?tabs=bicep",children:'limits known as "quotas"'})," in place. If you're looking to control how many resources you're using, you'll want to be able to control the capacity of your deployments. This is possible with Bicep."]}),"\n",(0,o.jsxs)(t.p,{children:["This post grew out of a ",(0,o.jsx)(t.a,{href:"https://github.com/Azure/bicep-types-az/issues/1660#issuecomment-1643484703",children:"GitHub issue"})," around the topic where people were bumping on the message ",(0,o.jsx)(t.code,{children:"the capacity should be null for standard deployment"})," as they attempted to deploy. At the time that issue was raised, there was very little documentation on how to handle this. Since then, things have improved, but I thought it would be useful to have a post on the topic."]}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"title image reading &quot;Azure Open AI: handling capacity and quota limits with Bicep&quot; with the Azure Open AI / Bicep logos",src:n(21843).Z+"",width:"800",height:"450",loading:"eager",fetchpriority:"high"})}),"\n",(0,o.jsx)(t.h2,{id:"viewing-capacity-and-quota-limits-in-the-azure-open-ai-studio",children:"Viewing capacity and quota limits in the Azure Open AI Studio"}),"\n",(0,o.jsxs)(t.p,{children:["If you take a look at the ",(0,o.jsx)(t.a,{href:"https://oai.azure.com/",children:"Azure Open AI Studio"}),' you\'ll notice a "Quotas" section:']}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"screenshot of azure open ai studio with quotas highlighted",src:n(31668).Z+"",width:"3076",height:"1290",loading:"lazy"})}),"\n",(0,o.jsx)(t.p,{children:"You'll see above that we've got two deployments of GPT-35-Turbo in our subscription. Both of these contribute towards an overall limit of 360K TPM. If we try and deploy resources and have an overall capacity total that exceeds that, our deployment will fail."}),"\n",(0,o.jsx)(t.p,{children:"That being the case, we need to be able to control the capacity of our deployments. This is possible with Bicep."}),"\n",(0,o.jsx)(t.h2,{id:"controlling-capacity-and-quota-limits-with-bicep",children:"Controlling capacity and quota limits with Bicep"}),"\n",(0,o.jsxs)(t.p,{children:["Consider the following ",(0,o.jsx)(t.code,{children:"account-deployments.bicep"}),":"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bicep",children:"@description('Name of the Cognitive Services resource')\nparam cognitiveServicesName string\n\n@description('Name of the deployment resource.')\nparam deploymentName string\n\n@description('Deployment model format.')\nparam format string\n\n@description('Deployment model name.')\nparam name string\n\n@description('Deployment model version.')\nparam version string = '1'\n\n@description('The name of RAI policy.')\nparam raiPolicyName string = 'Default'\n\n@allowed([\n  'NoAutoUpgrade'\n  'OnceCurrentVersionExpired'\n  'OnceNewDefaultVersionAvailable'\n])\n@description('Deployment model version upgrade option. see https://learn.microsoft.com/en-us/azure/templates/microsoft.cognitiveservices/2023-05-01/accounts/deployments?pivots=deployment-language-bicep#deploymentproperties')\nparam versionUpgradeOption string = 'OnceNewDefaultVersionAvailable'\n\n@description('''Deployments SKU see: https://learn.microsoft.com/en-us/azure/templates/microsoft.cognitiveservices/2023-05-01/accounts/deployments?pivots=deployment-language-bicep#sku\neg:\n\nsku: {\n  name: 'Standard'\n  capacity: 10\n}\n\n''')\nparam sku object\n\n// https://learn.microsoft.com/en-us/azure/templates/microsoft.cognitiveservices/2023-05-01/accounts?pivots=deployment-language-bicep\nresource cog 'Microsoft.CognitiveServices/accounts@2023-05-01' existing = {\n  name: cognitiveServicesName\n}\n\n// https://learn.microsoft.com/en-us/azure/templates/microsoft.cognitiveservices/2023-05-01/accounts/deployments?pivots=deployment-language-bicep\nresource deployment 'Microsoft.CognitiveServices/accounts/deployments@2023-05-01' = {\n  name: deploymentName\n  parent: cog\n  sku: sku\n  properties: {\n    model: {\n      format: format\n      name: name\n      version: version\n    }\n    raiPolicyName: raiPolicyName\n    versionUpgradeOption: versionUpgradeOption\n  }\n}\n\noutput deploymentName string = deployment.name\noutput deploymentResourceId string = deployment.id\n"})}),"\n",(0,o.jsx)(t.p,{children:"We can use this to deploy.... deployments (naming here is definitely confusing) to Azure like so:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bicep",children:"var cognitiveServicesDeployments = [\n  {\n    name: 'OpenAi-gpt-35-turbo'\n    shortName: 'gpt35t'\n    model: {\n      format: 'OpenAI'\n      name: 'gpt-35-turbo'\n      version: '0301'\n    }\n    sku: {\n      name: 'Standard'\n      capacity: repositoryBranch == 'refs/heads/main' ? 100 : 10 // capacity in thousands of TPM\n    }\n  }\n]\n\n// Model Deployment - one at a time as parallel deployments are not supported\n@batchSize(1)\nmodule openAiAccountsDeployments35Turbo 'account-deployments.bicep' = [for deployment in cognitiveServicesDeployments: {\n  name: '${deployment.shortName}-cog-accounts-deployments'\n  params: {\n    cognitiveServicesName: openAi.outputs.cognitiveServicesName\n    deploymentName: deployment.name\n    format: deployment.model.format\n    name: deployment.model.name\n    version: deployment.model.version\n    sku: deployment.sku\n  }\n}]\n"})}),"\n",(0,o.jsxs)(t.p,{children:["We're currently only deploying a single account deployment in our array, but we do it this way as it's not unusual to deploy multiple deployments together. Notice the ",(0,o.jsx)(t.code,{children:"sku"})," portion above:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bicep",children:"    sku: {\n      name: 'Standard'\n      capacity: repositoryBranch == 'refs/heads/main' ? 100 : 10\n    }\n"})}),"\n",(0,o.jsxs)(t.p,{children:["Here we provision a larger ",(0,o.jsx)(t.code,{children:"capacity"})," for our feature branch deployments than our ",(0,o.jsx)(t.code,{children:"main"})," branch deployments. This demonstrates our own usage, whereby we deploy a smaller capacity for our feature branches so that we can test things out, but then deploy a larger capacity for our main branch deployments."]}),"\n",(0,o.jsx)(t.p,{children:"Significantly, we're controlling the capacity of our deployments. The way in which you choose to decide on the capacity of your deployments is up to you, but the above demonstrates how you can do it with Bicep and stick within your quota limits."})]})}function u(e={}){const{wrapper:t}={...(0,i.a)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(p,{...e})}):p(e)}},72605:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/title-image-015ac7f920c42c69f461711f0fd46156.png"},31668:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/screenshot-azure-ai-studio-75ce4e148dad67f942e31aaa9874030d.webp"},21843:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/title-image-015ac7f920c42c69f461711f0fd46156.png"},11151:(e,t,n)=>{n.d(t,{Z:()=>r,a:()=>s});var o=n(67294);const i={},a=o.createContext(i);function s(e){const t=o.useContext(a);return o.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),o.createElement(a.Provider,{value:t},e.children)}}}]);