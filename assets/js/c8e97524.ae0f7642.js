"use strict";(self.webpackChunkjohnnyreilly_com=self.webpackChunkjohnnyreilly_com||[]).push([[99322],{516:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/screenshot-azure-portal-azure-ad-app-registration-api-permissions-2475b91d55370c463f10fc45a802996d.png"},28453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>o});var i=t(96540);const s={},a=i.createContext(s);function r(e){const n=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),i.createElement(a.Provider,{value:n},e.children)}},30739:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/title-image-bf4b643f03830f5f5ad3512d581138f3.png"},44799:e=>{e.exports=JSON.parse('{"permalink":"/azure-ad-claims-static-web-apps-azure-functions","editUrl":"https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2022-11-17-azure-ad-claims-static-web-apps-azure-functions/index.md","source":"@site/blog/2022-11-17-azure-ad-claims-static-web-apps-azure-functions/index.md","title":"Azure AD Claims with Static Web Apps and Azure Functions","description":"Authorization with Azure Static Web Apps linked to Azure Functions has an issue. Azure AD app role claims are not supplied; this post will demo a workaround.","date":"2022-11-17T00:00:00.000Z","tags":[{"inline":false,"label":"Authentication and Authorization","permalink":"/tags/auth","description":"Matters related to identity and permissioning"},{"inline":false,"label":"Azure Functions","permalink":"/tags/azure-functions","description":"The Azure Functions service."},{"inline":false,"label":"Azure Static Web Apps","permalink":"/tags/azure-static-web-apps","description":"The Azure Static Web Apps service."},{"inline":false,"label":"Azure","permalink":"/tags/azure","description":"The Microsoft cloud platform."},{"inline":false,"label":"Microsoft Graph","permalink":"/tags/microsoft-graph","description":"The Microsoft Graph."}],"readingTime":12.34,"hasTruncateMarker":true,"authors":[{"name":"John Reilly","title":"OSS Engineer - TypeScript, Azure, React, Node.js, .NET","url":"https://johnnyreilly.com/about","imageURL":"https://johnnyreilly.com/img/profile.jpg","key":"johnnyreilly","page":null}],"frontMatter":{"slug":"azure-ad-claims-static-web-apps-azure-functions","title":"Azure AD Claims with Static Web Apps and Azure Functions","authors":"johnnyreilly","tags":["auth","azure functions","azure static web apps","azure","microsoft graph"],"image":"./title-image.png","description":"Authorization with Azure Static Web Apps linked to Azure Functions has an issue. Azure AD app role claims are not supplied; this post will demo a workaround.","hide_table_of_contents":false},"unlisted":false,"prevItem":{"title":"XML: read and write with Node.js","permalink":"/xml-read-and-write-with-node-js"},"nextItem":{"title":"Debugging Azure Functions in VS Code on Mac OS","permalink":"/debugging-azure-functions-vs-code-mac-os"}}')},49920:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>r,metadata:()=>i,toc:()=>c});var i=t(44799),s=t(74848),a=t(28453);const r={slug:"azure-ad-claims-static-web-apps-azure-functions",title:"Azure AD Claims with Static Web Apps and Azure Functions",authors:"johnnyreilly",tags:["auth","azure functions","azure static web apps","azure","microsoft graph"],image:"./title-image.png",description:"Authorization with Azure Static Web Apps linked to Azure Functions has an issue. Azure AD app role claims are not supplied; this post will demo a workaround.",hide_table_of_contents:!1},o=void 0,l={image:t(73314).A,authorsImageUrls:[void 0]},c=[{value:"Updated 28th November 2022",id:"updated-28th-november-2022",level:2},{value:"Related posts",id:"related-posts",level:2},{value:"Where&#39;s my claims?",id:"wheres-my-claims",level:2},{value:"Maybe they&#39;re hiding in <code>x-ms-client-principal</code>?",id:"maybe-theyre-hiding-in-x-ms-client-principal",level:2},{value:"Microsoft Graph API",id:"microsoft-graph-api",level:2},{value:"Interrogating the Microsoft Graph API",id:"interrogating-the-microsoft-graph-api",level:2},{value:"Using the <code>PrincipalService</code>",id:"using-the-principalservice",level:2},{value:"<code>GetPrincipal</code> - what claims do we have?",id:"getprincipal---what-claims-do-we-have",level:3},{value:"<code>AmIInRole</code> - test <code>IsInRole</code> functionality",id:"amiinrole---test-isinrole-functionality",level:3},{value:"Conclusion",id:"conclusion",level:2}];function p(e){const n={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"Authorization in Azure Functions is impaired by an issue with Azure Static Web Apps linked to Azure Functions. Azure AD app role claims are not supplied to Azure Functions. This post will demonstrate a workaround."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"title image reading &quot;Azure AD Claims with Static Web Apps and Azure Functions&quot; with Azure AD, Azure Functions and Static Web App logos",src:t(30739).A+"",width:"800",height:"450",loading:"lazy"})}),"\n",(0,s.jsx)(n.h2,{id:"updated-28th-november-2022",children:"Updated 28th November 2022"}),"\n",(0,s.jsxs)(n.p,{children:["After I posted this, ",(0,s.jsx)(n.a,{href:"https://twitter.com/thomasgauvin",children:"Thomas Gauvin"})," (Product manager for Static Web Apps) was kind enough to tweet this:"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://twitter.com/thomasgauvin/status/1596242773686079496",children:(0,s.jsx)(n.img,{alt:"screenshot of tweet from Thomas Gauvin saying &quot;Thanks for writing this @johnny_reilly, I know this is a pain point with SWA auth at the moment. I&#39;m sure this article will help others in the meantime. We&#39;re working on correcting our docs + looking to add support for this in the future&quot;",src:t(68832).A+"",width:"2005",height:"689",loading:"lazy"})})}),"\n",(0,s.jsx)(n.p,{children:"So by the sounds of it, this blog post will not be required in the longer term, as support should to be added directly. Tremendous news!"}),"\n",(0,s.jsx)(n.h2,{id:"related-posts",children:"Related posts"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/graph-api-ad-users-group-name-ids-csharp-sdk",children:"Graph API: getting users Active Directory group names and ids with the C# SDK"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/microsoft-graphclient-filter-endswith-consistencylevel-eventual-header",children:"Microsoft Graph client: how to filter by endswith"})}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"wheres-my-claims",children:"Where's my claims?"}),"\n",(0,s.jsxs)(n.p,{children:["There is a limitation that affects authorization when you have a linked backend paired with an Azure Static Web App. Let's take the case of having an Azure Function App as the linked backend. Essentially the Azure Function app ",(0,s.jsx)(n.em,{children:"does not"})," receive the claims that the Static Web App receives. ",(0,s.jsx)(n.a,{href:"https://github.com/Azure/static-web-apps/issues/988",children:"There's an issue tracking this on GitHub"}),", and it seems that this is a general problem with Static Web Apps, Azure AD and linked backends."]}),"\n",(0,s.jsxs)(n.p,{children:["We have a Static Web App, with an associated C# Function App (using the ",(0,s.jsx)(n.a,{href:"/bicep-static-web-apps-linked-backends",children:"Bring Your Own Functions"}),' AKA "linked backend" approach). Both the Static Web App and Function App are associated with the same Azure AD App Registration.']}),"\n",(0,s.jsxs)(n.p,{children:["When we're authenticated with Azure AD and go to the auth endpoint in our Static Web App: ",(0,s.jsx)(n.code,{children:"/.auth/me"})," we see:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "clientPrincipal": {\n    "identityProvider": "aad",\n    "userId": "d9178465-3847-4d98-9d23-b8b9e403b323",\n    "userDetails": "johnny_reilly@hotmail.com",\n    "userRoles": ["authenticated", "anonymous"],\n    "claims": [\n      // ...\n      {\n        "typ": "http://schemas.microsoft.com/identity/claims/objectidentifier",\n        "val": "d9178465-3847-4d98-9d23-b8b9e403b323"\n      },\n      {\n        "typ": "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress",\n        "val": "johnny_reilly@hotmail.com"\n      },\n      {\n        "typ": "name",\n        "val": "John Reilly"\n      },\n      {\n        "typ": "roles",\n        "val": "OurApp.Read"\n      },\n      // ...\n      {\n        "typ": "ver",\n        "val": "2.0"\n      }\n    ]\n  }\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Note the claims in there. These include custom claims that we've configured against our Azure AD App Registration such as roles with ",(0,s.jsx)(n.code,{children:"OurApp.Read"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["So we can access claims successfully in the Static Web App (the front end). However, the associated Function App does ",(0,s.jsx)(n.strong,{children:"not"})," have access to the claims."]}),"\n",(0,s.jsx)(n.p,{children:"It's possible to see this by implementing a function in our Azure Function App which surfaces roles:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cs",children:'[FunctionName("GetRoles")]\npublic static async Task<IActionResult> Run(\n    [HttpTrigger(AuthorizationLevel.Anonymous, "get", "post", Route = "GetRoles")] HttpRequest req\n)\n{\n    var roles = req.HttpContext.User?.Claims.Select(c => new { c.Type, c.Value });\n\n    return new OkObjectResult(roles);\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["When this ",(0,s.jsx)(n.code,{children:"/api/GetRoles"})," endpoint is accessed we see this:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'[\n  {\n    "Type": "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier",\n    "Value": "d9178465-3847-4d98-9d23-b8b9e403b323"\n  },\n  {\n    "Type": "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name",\n    "Value": "johnny_reilly@hotmail.com"\n  },\n  {\n    "Type": "http://schemas.microsoft.com/ws/2008/06/identity/claims/role",\n    "Value": "authenticated"\n  },\n  {\n    "Type": "http://schemas.microsoft.com/ws/2008/06/identity/claims/role",\n    "Value": "anonymous"\n  }\n]\n'})}),"\n",(0,s.jsxs)(n.p,{children:["At first look, this seems great; we have claims! But when we look again we realise that we have far less claims than we might have hoped for. Crucially, our custom claims / app roles like ",(0,s.jsx)(n.code,{children:"OurApp.Read"})," are missing."]}),"\n",(0,s.jsxs)(n.h2,{id:"maybe-theyre-hiding-in-x-ms-client-principal",children:["Maybe they're hiding in ",(0,s.jsx)(n.code,{children:"x-ms-client-principal"}),"?"]}),"\n",(0,s.jsxs)(n.p,{children:["If we look directly at the ",(0,s.jsx)(n.code,{children:"x-ms-client-principal"})," header, maybe we'll find what we need?"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cs",children:'[FunctionName("GetRoles")]\npublic static async Task<IActionResult> GetRoles(\n    [HttpTrigger(AuthorizationLevel.Anonymous, "get", Route = "GetRoles")] HttpRequest req\n)\n{\n    var header = req.Headers["x-ms-client-principal"];\n    var data = header.FirstOrDefault();\n    if (data == null)\n    {\n        return new OkObjectResult("nothing");\n    }\n\n    var decoded = System.Convert.FromBase64String(data);\n    var json = System.Text.ASCIIEncoding.ASCII.GetString(decoded);\n\n    return new OkObjectResult(json);\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:'Alas not. We have the user\'s email and some simple roles ("authenticated" and "anonymous"), but no sign of our custom claims / app roles:'}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "identityProvider": "aad",\n  "userId": "d9178465-3847-4d98-9d23-b8b9e403b323",\n  "userDetails": "johnny_reilly@hotmail.com",\n  "userRoles": ["authenticated", "anonymous"]\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"This is the problem: we want our Azure Function App to be able to make use of the same custom claims / app roles that we use for authorization in the Static Web App. How can we achieve this?"}),"\n",(0,s.jsx)(n.h2,{id:"microsoft-graph-api",children:"Microsoft Graph API"}),"\n",(0,s.jsx)(n.p,{children:"The answer lies with the Microsoft Graph API. We can interrogate it to get the app role assignments for the user. This will give us the same information that we have in the Static Web App. (Well to be strictly accurate, it will be a slightly different set of claims. But what matters is it will be the app role assignment claims that we want to use for authorization.)"}),"\n",(0,s.jsx)(n.p,{children:"We already have an Azure AD app registration. In order that we can interrogate the Microsoft Graph API, we'll need the following permissions:"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"Screenshot of the Azure AD app registration API permissions screen",src:t(516).A+"",width:"970",height:"290",loading:"lazy"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/graph/permissions-reference#delegated-permissions-85",children:"User.Read"})," - to sign in"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/graph/permissions-reference#application-permissions-81",children:"User.Read.All"})," - for acquiring the app role assignments against a user"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/graph/permissions-reference#application-permissions-4",children:"Application.Read.All"})," - to get more information about the app role assignments - allowing us to translate the app role assignments into the claims that we want to use for authorization"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Of the above permissions, it's likely that you'll already have delegated ",(0,s.jsx)(n.code,{children:"User.Read"})," in place; the other two you might need to add and ensure they're granted in Azure."]}),"\n",(0,s.jsx)(n.h2,{id:"interrogating-the-microsoft-graph-api",children:"Interrogating the Microsoft Graph API"}),"\n",(0,s.jsxs)(n.p,{children:["Now we have an Azure AD App Registration with sufficient permissions, we'll need a ",(0,s.jsx)(n.code,{children:"GraphClient"})," to interrogate the Microsoft Graph API. To get that we're going to build an ",(0,s.jsx)(n.code,{children:"AuthenticatedGraphClientFactory"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cs",children:'using System.Net.Http;\nusing System.Net.Http.Headers;\nusing System.Threading.Tasks;\nusing Microsoft.Graph;\nusing Microsoft.Identity.Client;\n\nnamespace MyApp.Auth\n{\n    public interface IAuthenticatedGraphClientFactory\n    {\n        (GraphServiceClient, string) GetAuthenticatedGraphClientAndClientId();\n    }\n\n    public class AuthenticatedGraphClientFactory : IAuthenticatedGraphClientFactory\n    {\n        private GraphServiceClient? _graphServiceClient;\n        private readonly string _clientId;\n        private readonly string _clientSecret;\n        private readonly string _tenantId;\n\n        public AuthenticatedGraphClientFactory(\n            string clientId,\n            string clientSecret,\n            string tenantId\n        )\n        {\n            _clientId = clientId;\n            _clientSecret = clientSecret;\n            _tenantId = tenantId;\n        }\n\n        public (GraphServiceClient, string) GetAuthenticatedGraphClientAndClientId()\n        {\n            var authenticationProvider = CreateAuthenticationProvider();\n\n            _graphServiceClient = new GraphServiceClient(authenticationProvider);\n\n            return (_graphServiceClient, _clientId);\n        }\n\n        private IAuthenticationProvider CreateAuthenticationProvider()\n        {\n            // this specific scope means that application will default to what is defined in the application registration rather than using dynamic scopes\n            string[] scopes = new string[]\n            {\n                "https://graph.microsoft.com/.default"\n            };\n\n            var confidentialClientApplication = ConfidentialClientApplicationBuilder.Create(_clientId)\n                .WithAuthority($"https://login.microsoftonline.com/{_tenantId}/v2.0")\n                .WithClientSecret(_clientSecret)\n                .Build();\n\n            return new MsalAuthenticationProvider(confidentialClientApplication, scopes); ;\n        }\n    }\n\n    public class MsalAuthenticationProvider : IAuthenticationProvider\n    {\n        private readonly IConfidentialClientApplication _clientApplication;\n        private readonly string[] _scopes;\n\n        public MsalAuthenticationProvider(IConfidentialClientApplication clientApplication, string[] scopes)\n        {\n            _clientApplication = clientApplication;\n            _scopes = scopes;\n        }\n\n        /// <summary>\n        /// Update HttpRequestMessage with credentials\n        /// </summary>\n        public async Task AuthenticateRequestAsync(HttpRequestMessage request)\n        {\n            var token = await GetTokenAsync();\n\n            request.Headers.Authorization = new AuthenticationHeaderValue("bearer", token);\n        }\n\n        /// <summary>\n        /// Acquire Token\n        /// </summary>\n        public async Task<string?> GetTokenAsync()\n        {\n            var authResult = await _clientApplication.AcquireTokenForClient(_scopes).ExecuteAsync();\n\n            return authResult.AccessToken;\n        }\n    }\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["When we execute ",(0,s.jsx)(n.code,{children:"GetAuthenticatedGraphClientAndClientId"})," we'll get back a ",(0,s.jsx)(n.code,{children:"GraphServiceClient"})," that we can use to interrogate the Microsoft Graph API. We'll also get back the client ID of the Graph API App. We'll need this later. Note that the ",(0,s.jsx)(n.code,{children:"AuthenticatedGraphClientFactory"})," requires the client ID, client secret and tenant ID of the Azure AD App Registration."]}),"\n",(0,s.jsxs)(n.p,{children:["Now we have the ability to interrogate the Microsoft Graph API, we can write a ",(0,s.jsx)(n.code,{children:"PrincipalService.cs"})," class that will interrogate it and return the app role assignments for the user:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cs",children:'using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Security.Claims;\nusing System.Text;\nusing System.Text.Json;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Http;\nusing Microsoft.Extensions.Logging;\nusing Microsoft.Graph;\n\nnamespace MyApp.Auth\n{\n    public interface IPrincipalService\n    {\n        Task<ClaimsPrincipal> GetPrincipal(HttpRequest req);\n    }\n\n    public class PrincipalService : IPrincipalService\n    {\n        readonly ILogger<PrincipalService> _log;\n        readonly IAuthenticatedGraphClientFactory _graphClientFactory;\n\n        public PrincipalService(\n            IAuthenticatedGraphClientFactory graphClientFactory,\n            ILogger<PrincipalService> log\n        )\n        {\n            _graphClientFactory = graphClientFactory;\n            _log = log;\n        }\n\n        public async Task<ClaimsPrincipal> GetPrincipal(HttpRequest req)\n        {\n            try\n            {\n                MsClientPrincipal? principal = MakeMsClientPrincipal(req);\n\n                if (principal == null)\n                    return new ClaimsPrincipal();\n\n                if (!principal.UserRoles?.Where(NotAnonymous).Any() ?? true)\n                    return new ClaimsPrincipal();\n\n                ClaimsIdentity identity = await MakeClaimsIdentity(principal);\n\n                return new ClaimsPrincipal(identity);\n            }\n            catch (Exception e)\n            {\n                _log.LogError(e, "Error parsing claims principal");\n                return new ClaimsPrincipal();\n            }\n        }\n\n        MsClientPrincipal? MakeMsClientPrincipal(HttpRequest req)\n        {\n            MsClientPrincipal? principal = null;\n\n            if (req.Headers.TryGetValue("x-ms-client-principal", out var header))\n            {\n                var data = header.FirstOrDefault();\n                if (data != null)\n                {\n                    var decoded = Convert.FromBase64String(data);\n                    var json = Encoding.UTF8.GetString(decoded);\n                    _log.LogInformation($"x-ms-client-principal: {json}");\n                    principal = JsonSerializer.Deserialize<MsClientPrincipal>(json, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });\n                }\n            }\n\n            return principal;\n        }\n\n        async Task<ClaimsIdentity> MakeClaimsIdentity(MsClientPrincipal principal)\n        {\n            var identity = new ClaimsIdentity(principal.IdentityProvider);\n\n            identity.AddClaim(new Claim(ClaimTypes.NameIdentifier, principal.UserId!));\n            identity.AddClaim(new Claim(ClaimTypes.Name, principal.UserDetails!));\n\n            if (principal.UserRoles != null)\n                identity.AddClaims(principal.UserRoles\n                    .Where(NotAnonymous)\n                    .Select(userRole => new Claim(ClaimTypes.Role, userRole)));\n\n            var username = principal.UserDetails;\n            if (username != null)\n            {\n                var userAppRoleAssignments = await GetUserAppRoleAssignments(username);\n                identity.AddClaims(userAppRoleAssignments\n                    .Select(userAppRoleAssignments => new Claim(ClaimTypes.Role, userAppRoleAssignments)));\n            }\n\n            return identity;\n        }\n\n        static bool NotAnonymous(string r) =>\n            !string.Equals(r, "anonymous", StringComparison.CurrentCultureIgnoreCase);\n\n        async Task<string[]> GetUserAppRoleAssignments(string username)\n        {\n            try\n            {\n                var (graphClient, clientId) = _graphClientFactory.GetAuthenticatedGraphClientAndClientId();\n                _log.LogInformation("Getting AppRoleAssignments for {username}", username);\n\n                var userRoleAssignments = await graphClient.Users[username]\n                    .AppRoleAssignments\n                    .Request()\n                    .GetAsync();\n\n                var roleIds = new List<string>();\n                var pageIterator = PageIterator<AppRoleAssignment>\n                    .CreatePageIterator(\n                        graphClient,\n                        userRoleAssignments,\n                        // Callback executed for each item in the collection\n                        (appRoleAssignment) =>\n                        {\n                            if (appRoleAssignment.AppRoleId.HasValue && appRoleAssignment.AppRoleId.Value != Guid.Empty)\n                                roleIds.Add(appRoleAssignment.AppRoleId.Value.ToString());\n\n                            return true;\n                        },\n                        // Used to configure subsequent page requests\n                        (baseRequest) =>\n                        {\n                            // Re-add the header to subsequent requests\n                            baseRequest.Header("Prefer", "outlook.body-content-type=\\"text\\"");\n                            return baseRequest;\n                        });\n\n                await pageIterator.IterateAsync();\n\n                var applications = await graphClient.Applications\n                    .Request()\n                    .Filter($"appId eq \'{clientId}\'") // we\'re only interested in the app that we\'re running as\n                    .GetAsync();\n\n                var appRoleAssignments = applications\n                    .FirstOrDefault()\n                    ?.AppRoles\n                    ?.Where(appRole => appRole.Id.HasValue && roleIds.Contains(appRole.Id!.Value.ToString()))\n                    .Select(appRole => appRole.Value)\n                    .ToArray();\n\n                return appRoleAssignments ?? Array.Empty<string>();\n            }\n            catch (Exception e)\n            {\n                _log.LogError(e, "Error getting AppRoleAssignments");\n                return Array.Empty<string>();\n            }\n        }\n\n        class MsClientPrincipal\n        {\n            public string? IdentityProvider { get; set; }\n            public string? UserId { get; set; }\n            public string? UserDetails { get; set; }\n            public IEnumerable<string>? UserRoles { get; set; }\n        }\n    }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"Quite a lot of code! Let's walk through what it does:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["It takes the ",(0,s.jsx)(n.code,{children:"x-ms-client-principal"})," header and deserializes it into a ",(0,s.jsx)(n.code,{children:"MsClientPrincipal"})," object - this is the cut down version of the ",(0,s.jsx)(n.code,{children:"ClaimsPrincipal"})," object that we saw earlier:"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "identityProvider": "aad",\n  "userId": "d9178465-3847-4d98-9d23-b8b9e403b323",\n  "userDetails": "johnny_reilly@hotmail.com",\n  "userRoles": ["authenticated", "anonymous"]\n}\n'})}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["It creates a new ",(0,s.jsx)(n.code,{children:"ClaimsIdentity"})," using that information, but stripping out the ",(0,s.jsx)(n.code,{children:"anonymous"})," role as it's superfluous."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Using the ",(0,s.jsx)(n.code,{children:"userDetails"})," (email address) from the ",(0,s.jsx)(n.code,{children:"MsClientPrincipal"})," object, it gets the app role assignments for that user from the Graph API. (We needed ",(0,s.jsx)(n.code,{children:"User.Read.All"})," to do this.)"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["In a perfect world, we'd be able to use the ",(0,s.jsx)(n.code,{children:"AppRoleAssignments"})," property on the ",(0,s.jsx)(n.code,{children:"User"})," object to get the app role assignments for a user, but unfortunately that doesn't come with the human readable name you'd hope for; the ",(0,s.jsx)(n.code,{children:"MyApp.Read"}),". So we have to interrogate the Graph API once more and use the ",(0,s.jsx)(n.code,{children:"Application"})," that represents our Azure AD App Registration (we acquire this by filtering for an ",(0,s.jsx)(n.code,{children:"appId"})," matching our ",(0,s.jsx)(n.code,{children:"clientId"}),"). Then we can get the human readable / ",(0,s.jsx)(n.code,{children:"MyApp.Read"})," role assignment."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["It adds the app role assignments as role claims to the ",(0,s.jsx)(n.code,{children:"ClaimsIdentity"})," object."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["It returns the ",(0,s.jsx)(n.code,{children:"ClaimsIdentity"})," object wrapped in a ",(0,s.jsx)(n.code,{children:"ClaimsPrincipal"})," object."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.h2,{id:"using-the-principalservice",children:["Using the ",(0,s.jsx)(n.code,{children:"PrincipalService"})]}),"\n",(0,s.jsxs)(n.p,{children:["In order that we can make use of our ",(0,s.jsx)(n.code,{children:"PrincipalService"})," we need to configure it and the ",(0,s.jsx)(n.code,{children:"AuthenticatedGraphClientFactory"})," in our ",(0,s.jsx)(n.code,{children:"Startup"})," class:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cs",children:"services.AddTransient<IAuthenticatedGraphClientFactory>(sp =>\n    new AuthenticatedGraphClientFactory(\n        // The parameters can be sourced from the Azure AD App Registration\n        clientId,\n        clientSecret,\n        tenantId\n    ));\n\nservices.AddTransient<IPrincipalService, PrincipalService>();\n"})}),"\n",(0,s.jsxs)(n.p,{children:["With that in place, we can now use the ",(0,s.jsx)(n.code,{children:"IPrincipalService"})," in a function:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cs",children:'using System.Linq;\nusing System.Threading.Tasks;\nusing MyApp.Auth;\nusing Microsoft.AspNetCore.Http;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.Azure.WebJobs;\nusing Microsoft.Azure.WebJobs.Extensions.Http;\n\nnamespace MyApp.Functions\n{\n    public class GetClaimsPrincipalFunction\n    {\n        private readonly IPrincipalService _principalService;\n\n        public GetClaimsPrincipalFunction(\n            IPrincipalService principalService\n        )\n        {\n            _principalService = principalService;\n        }\n\n        [FunctionName(nameof(GetPrincipal))]\n        public async Task<IActionResult> GetPrincipal(\n            [HttpTrigger(AuthorizationLevel.Anonymous, "get", Route = "get-principal")] HttpRequest request\n        )\n        {\n            var principal = await _principalService.GetPrincipal(request);\n            var identity = principal?.Identity;\n            var data = new\n            {\n                Name = identity?.Name ?? "",\n                AuthenticationType = identity?.AuthenticationType ?? "",\n                Claims = principal?.Claims.Select(c => new { c.Type, c.Value }),\n            };\n\n            return new OkObjectResult(data);\n        }\n\n        [FunctionName(nameof(AmIInRole))]\n        public async Task<IActionResult> AmIInRole(\n            [HttpTrigger(AuthorizationLevel.Anonymous, "get", Route = "am-i-in-role")] HttpRequest request\n        )\n        {\n            var role = request.Query["role"].FirstOrDefault();\n\n            if (string.IsNullOrEmpty(role))\n                return new BadRequestObjectResult("role query parameter is required");\n\n            var principal = await _principalService.GetPrincipal(request);\n\n            var isInRole = principal?.IsInRole(role) == true;\n            if (!isInRole)\n                return new ObjectResult($"Forbidden for {role}")\n                {\n                    StatusCode = Status403Forbidden\n                };\n\n            return new OkObjectResult($"Welcome {principal?.Identity?.Name} - you have role {role}!");\n        }\n    }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"The above class has 2 functions:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"GetPrincipal"})," - returns the ",(0,s.jsx)(n.code,{children:"ClaimsPrincipal"})," object as JSON"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"AmIInRole"})," - takes a ",(0,s.jsx)(n.code,{children:"role"})," query parameter, tests if a user has that role and returns a 403 if they don't and a 200 with a welcome message if they do"]}),"\n"]}),"\n",(0,s.jsxs)(n.h3,{id:"getprincipal---what-claims-do-we-have",children:[(0,s.jsx)(n.code,{children:"GetPrincipal"})," - what claims do we have?"]}),"\n",(0,s.jsxs)(n.p,{children:["Let's try out the ",(0,s.jsx)(n.code,{children:"GetPrincipal"})," function, when I go to the ",(0,s.jsx)(n.code,{children:"/api/get-principal"})," endpoint I see this:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "name": "johnny_reilly@hotmail.com",\n  "authenticationType": "aad",\n  "claims": [\n    {\n      "type": "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier",\n      "value": "d9178465-3847-4d98-9d23-b8b9e403b323"\n    },\n    {\n      "type": "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name",\n      "value": "johnny_reilly@hotmail.com"\n    },\n    {\n      "type": "http://schemas.microsoft.com/ws/2008/06/identity/claims/role",\n      "value": "authenticated"\n    },\n    {\n      "type": "http://schemas.microsoft.com/ws/2008/06/identity/claims/role",\n      "value": "OurApp.Read"\n    }\n  ]\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["This isn't the ",(0,s.jsx)(n.em,{children:"same"})," information as the Static Web Apps principal, but it's close enough for our purposes. Crucially, we can see the AppRoleAssignment ",(0,s.jsx)(n.code,{children:"OurApp.Read"})," that we assigned to our user in the Azure Portal. That is the key information that we need, and that we are missing by default."]}),"\n",(0,s.jsx)(n.p,{children:"Crucially this is enough information for us to be able to apply authorization to our functions."}),"\n",(0,s.jsxs)(n.h3,{id:"amiinrole---test-isinrole-functionality",children:[(0,s.jsx)(n.code,{children:"AmIInRole"})," - test ",(0,s.jsx)(n.code,{children:"IsInRole"})," functionality"]}),"\n",(0,s.jsxs)(n.p,{children:["We can demonstrate applying authorization by using the ",(0,s.jsx)(n.code,{children:"AmIInRole"})," function. This internally uses the inbuilt ",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/dotnet/api/system.security.claims.claimsprincipal.isinrole?view=net-6.0",children:(0,s.jsx)(n.code,{children:"IsInRole"})})," functionality of the ",(0,s.jsx)(n.code,{children:"ClaimsPrincipal"})," object, and returns an appropriate API result accordingly."]}),"\n",(0,s.jsxs)(n.p,{children:["If I go to the ",(0,s.jsx)(n.code,{children:"/api/am-i-in-role?role=OurApp.Read"})," endpoint I get a 200 status code and the message: ",(0,s.jsx)(n.code,{children:"Welcome johnny_reilly@hotmail.com - you have role OurApp.Read!"}),". This makes sense, my user account has the ",(0,s.jsx)(n.code,{children:"OurApp.Read"})," role."]}),"\n",(0,s.jsxs)(n.p,{children:["Let's test that we also deny access appropriately. There is an ",(0,s.jsx)(n.code,{children:"OurApp.Write"})," role; my account does not have this. If I go to the ",(0,s.jsx)(n.code,{children:"/api/am-i-in-role?role=OurApp.Write"})," endpoint I get a 403 status code and the message: ",(0,s.jsx)(n.code,{children:"Forbidden for OurApp.Write"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"It works!"}),"\n",(0,s.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,s.jsxs)(n.p,{children:["We've demonstrated a way to acquire a ",(0,s.jsx)(n.code,{children:"ClaimsPrincipal"})," object that contains the AppRoleAssignments for a user. This is enough information for us to be able to apply authorization to our functions."]}),"\n",(0,s.jsxs)(n.p,{children:["It would be ideal if this wasn't required, and I'm hoping that the Static Web Apps team will be able to provide a solution for this in the future. ",(0,s.jsx)(n.a,{href:"https://github.com/Azure/static-web-apps/issues/988",children:"Keep an eye on this GitHub issue."})," In the meantime, this is a workable solution."]}),"\n",(0,s.jsxs)(n.p,{children:["Thanks to ",(0,s.jsx)(n.a,{href:"https://github.com/warrenandre",children:"Warren Joubert"})," for his help with this post."]})]})}function d(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(p,{...e})}):p(e)}},68832:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/screenshot-twitter-thomas-gauvin-support-in-future-0b27ec1d7904bd7e15c073d9065eb0e5.webp"},73314:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/title-image-bf4b643f03830f5f5ad3512d581138f3.png"}}]);