"use strict";(self.webpackChunkjohnnyreilly_com=self.webpackChunkjohnnyreilly_com||[]).push([[54906],{28453:(e,t,n)=>{n.d(t,{R:()=>r,x:()=>a});var i=n(96540);const o={},s=i.createContext(o);function r(e){const t=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),i.createElement(s.Provider,{value:t},e.children)}},41845:e=>{e.exports=JSON.parse('{"permalink":"/azure-open-ai-generate-article-metadata-with-typescript","editUrl":"https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2023-09-25-azure-open-ai-generate-article-metadata-with-typescript/index.md","source":"@site/blog/2023-09-25-azure-open-ai-generate-article-metadata-with-typescript/index.md","title":"Azure Open AI: generate article metadata with TypeScript","description":"Use the TypeScript Azure Open AI SDK to generate article metadata.","date":"2023-09-25T00:00:00.000Z","tags":[{"inline":false,"label":"Azure","permalink":"/tags/azure","description":"The Microsoft cloud platform."},{"inline":false,"label":"TypeScript","permalink":"/tags/typescript","description":"The TypeScript programming language."},{"inline":false,"label":"AI","permalink":"/tags/ai","description":"All things AI - Artificial Intelligence, Large Language Models and the like."}],"readingTime":9.26,"hasTruncateMarker":true,"authors":[{"name":"John Reilly","title":"OSS Engineer - TypeScript, Azure, React, Node.js, .NET","url":"https://johnnyreilly.com/about","imageURL":"https://johnnyreilly.com/img/profile-2025.jpg","key":"johnnyreilly","page":null}],"frontMatter":{"slug":"azure-open-ai-generate-article-metadata-with-typescript","title":"Azure Open AI: generate article metadata with TypeScript","authors":"johnnyreilly","image":"./title-image.png","tags":["azure","typescript","ai"],"description":"Use the TypeScript Azure Open AI SDK to generate article metadata.","hide_table_of_contents":false},"unlisted":false,"prevItem":{"title":"Docusaurus 3: how to migrate rehype plugins","permalink":"/docusaurus-3-how-to-migrate-rehype-plugins"},"nextItem":{"title":"TypeScript: The Movie","permalink":"/typescript-documentary"}}')},57565:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/title-image-8073436bce980c6c577b07d612072b84.png"},60775:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/title-image-8073436bce980c6c577b07d612072b84.png"},92544:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>p,frontMatter:()=>r,metadata:()=>i,toc:()=>l});var i=n(41845),o=n(74848),s=n(28453);const r={slug:"azure-open-ai-generate-article-metadata-with-typescript",title:"Azure Open AI: generate article metadata with TypeScript",authors:"johnnyreilly",image:"./title-image.png",tags:["azure","typescript","ai"],description:"Use the TypeScript Azure Open AI SDK to generate article metadata.",hide_table_of_contents:!1},a=void 0,c={image:n(57565).A,authorsImageUrls:[void 0]},l=[{value:"TypeScript Azure Open AI SDK",id:"typescript-azure-open-ai-sdk",level:2},{value:"What I wanted to do",id:"what-i-wanted-to-do",level:2},{value:"Reading the blog posts",id:"reading-the-blog-posts",level:2},{value:"Generating the descriptions",id:"generating-the-descriptions",level:2},{value:"Authentication",id:"authentication",level:3},{value:"Producing the summary",id:"producing-the-summary",level:3},{value:"Running the script",id:"running-the-script",level:2}];function h(e){const t={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.p,{children:"This post grew out of my desire to improve the metadata for my blog posts. I have been blogging for more than ten years, and the majority of my posts lack descriptions. A description is meta tag that sits in a page and describes the contents of the page. This is what this posts description meta tag looks like in HTML:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-html",children:'<meta\n  name="description"\n  content="Use the TypeScript Azure Open AI SDK to generate article metadata."\n/>\n'})}),"\n",(0,o.jsxs)(t.p,{children:["Descriptions are important for search engine optimisation (SEO) and for accessibility. You can ",(0,o.jsx)(t.a,{href:"https://developers.google.com/search/docs/appearance/snippet",children:"read up more on the topic here"}),". I wanted to have descriptions for ",(0,o.jsx)(t.em,{children:"all"})," my blog posts. But writing around 230 descriptions for my existing posts was not something I wanted to do manually. I wanted to automate it."]}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"title image reading &quot;Azure Open AI: generate article metadata with TypeScript&quot; with the Azure Open AI / TypeScript logos",src:n(60775).A+"",width:"800",height:"450",loading:"lazy"})}),"\n",(0,o.jsx)(t.h2,{id:"typescript-azure-open-ai-sdk",children:"TypeScript Azure Open AI SDK"}),"\n",(0,o.jsxs)(t.p,{children:["I've been using Azure Open AI for a while now, and I've been using the ",(0,o.jsxs)(t.a,{href:"https://github.com/Azure/azure-sdk-for-js/blob/main/sdk/openai/openai/README.md",children:["TypeScript SDK in the ",(0,o.jsx)(t.code,{children:"@azure/openai"})," package"]})," to interact with it. What I wanted to do, was to use the SDK to generate descriptions for my blog posts based on the content. Since my blog is powered by Docusaurus and each post is a Markdown file, I had easy access to a individual files that could be summarised."]}),"\n",(0,o.jsx)(t.h2,{id:"what-i-wanted-to-do",children:"What I wanted to do"}),"\n",(0,o.jsx)(t.p,{children:"The plan was, to build a script to do the following:"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:"read all of my blog posts without descriptions"}),"\n",(0,o.jsx)(t.li,{children:"for each one, generate a description using Azure Open AI"}),"\n",(0,o.jsx)(t.li,{children:"write the description to the Markdown file"}),"\n"]}),"\n",(0,o.jsxs)(t.p,{children:["I wanted to use ",(0,o.jsx)(t.a,{href:"https://bun.sh/",children:"Bun"})," for this as it supports TypeScript by default. Using Node.js would equally be possible; but it wouldn't have been so easy to use TypeScript."]}),"\n",(0,o.jsx)(t.h2,{id:"reading-the-blog-posts",children:"Reading the blog posts"}),"\n",(0,o.jsx)(t.p,{children:"I started off by creating a new Bun project:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"mkdir open-ai-description\ncd open-ai-description\nbun init\n"})}),"\n",(0,o.jsx)(t.p,{children:"Then adding the various packages we needed, including the Azure Open AI one:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"bun add @azure/openai @azure/identity\nbun add --dev bun-types typescript\n"})}),"\n",(0,o.jsxs)(t.p,{children:["I then created an ",(0,o.jsx)(t.code,{children:"index.ts"})," file and added the following code:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-typescript",children:"import fs from 'fs';\nimport path from 'path';\nimport { produceSummary } from './summarizer';\n\nconst docusaurusDirectory = '../blog-website';\n\nasync function getBlogDirsOrderedDescending() {\n  const rootBlogPath = path.resolve(docusaurusDirectory, 'blog');\n  const blogDirs = (await fs.promises.readdir(rootBlogPath))\n    .filter((file) => fs.statSync(path.join(rootBlogPath, file)).isDirectory())\n    .map((file) => path.join(rootBlogPath, file));\n\n  blogDirs.sort().reverse();\n\n  return blogDirs;\n}\n\ninterface BlogPost {\n  path: string;\n  content: string;\n}\n\ninterface BlogPostWithDescription extends BlogPost {\n  description: string;\n}\n\nasync function generatePostsWithDescription() {\n  const blogDirs = await getBlogDirsOrderedDescending();\n\n  const postsWithoutDescription: BlogPost[] = [];\n\n  for (const blogDir of blogDirs) {\n    console.log(`Processing ${blogDir}`);\n\n    const indexMdPath = path.join(blogDir, 'index.md');\n    const blogPostContent = await fs.promises.readFile(indexMdPath, 'utf-8');\n\n    const frontMatter = blogPostContent.split('---')[1];\n    const hasDescription = frontMatter.includes('\\ndescription: ');\n    if (!hasDescription) {\n      postsWithoutDescription.push({\n        path: indexMdPath,\n        content: blogPostContent,\n      });\n    }\n  }\n\n  console.log(\n    `Found ${postsWithoutDescription.length} posts without description`,\n  );\n\n  const postsWithDescription: BlogPostWithDescription[] = [];\n\n  for (const post of postsWithoutDescription) {\n    const [, frontmatter, article] = post.content.split('---');\n\n    console.log(\n      `** Generating description for ${post.path\n        .replace('/index.md', '')\n        .split('/')\n        .pop()}`,\n    );\n    const description = await produceSummary(article);\n\n    if (description) {\n      postsWithDescription.push({ ...post, description });\n      console.log(`** description: ${description}`);\n\n      await fs.promises.writeFile(\n        post.path,\n        `---${frontmatter}description: '${description.replaceAll(\"'\", '')}'\n---${article}`,\n      );\n    } else {\n      console.log(`** no description generated`);\n    }\n  }\n\n  return postsWithDescription;\n}\n\nasync function main() {\n  const startedAt = new Date();\n\n  const postsWithDescription: BlogPostWithDescription[] =\n    await generatePostsWithDescription();\n\n  const finishedAt = new Date();\n  const duration = (finishedAt.getTime() - startedAt.getTime()) / 1000;\n  console.log(\n    `${postsWithDescription.length} summaries generated in ${duration} seconds`,\n  );\n}\n\nawait main();\n"})}),"\n",(0,o.jsx)(t.p,{children:"The code above does the following:"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsxs)(t.li,{children:["reads all of the blog posts in my blog; they're all directories in the ",(0,o.jsx)(t.code,{children:"blog"})," directory with an ",(0,o.jsx)(t.code,{children:"index.md"})," underneath so it's pretty easy"]}),"\n",(0,o.jsxs)(t.li,{children:["for each post, it checks to see if there is a description in the front matter (",(0,o.jsx)(t.a,{href:"https://docusaurus.io/docs/markdown-features#front-matter",children:"front matter is a metadata section at the top of the Markdown file"}),")"]}),"\n",(0,o.jsx)(t.li,{children:"if there is no description, it adds the post to a list of posts without descriptions"}),"\n",(0,o.jsxs)(t.li,{children:["it then loops through the posts without descriptions and generates a description for each one using the ",(0,o.jsx)(t.code,{children:"produceSummary"})," function - more on that in a moment"]}),"\n"]}),"\n",(0,o.jsx)(t.h2,{id:"generating-the-descriptions",children:"Generating the descriptions"}),"\n",(0,o.jsxs)(t.p,{children:["So far, so text wrangling. Let's look at the ",(0,o.jsx)(t.code,{children:"produceSummary"})," function in the ",(0,o.jsx)(t.code,{children:"summarizer.ts"})," file:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-typescript",children:"import { OpenAIClient } from '@azure/openai';\nimport { AzureCliCredential } from '@azure/identity';\n\n// Make sure you have az login'd and have the correct subscription selected\n// debug with:\n// bun --inspect-brk open-ai-description/index.ts\n// or:\n// cd open-ai-description\n// bun --inspect-brk index.ts\n\ninterface OpenAiClientAndDeploymentName {\n  openAIClient: OpenAIClient;\n  deploymentName: string;\n}\n\nlet openAiClientAndDeploymentName: OpenAiClientAndDeploymentName | undefined;\n\nfunction getClientAndDeploymentName(): OpenAiClientAndDeploymentName {\n  if (openAiClientAndDeploymentName) {\n    return openAiClientAndDeploymentName;\n  }\n\n  // You will need to set these environment variables or edit the following values\n  const endpoint = process.env['ENDPOINT'];\n\n  if (!endpoint) {\n    throw new Error(\n      'Missing ENDPOINT environment variable with a value like https://<resource name>.openai.azure.com',\n    );\n  }\n\n  // This will use the Azure CLI's currently logged in user;\n  // make sure you've done `az login` and have the correct subscription selected\n  const credential = new AzureCliCredential();\n  const openAIClient = new OpenAIClient(endpoint, credential);\n  const deploymentName = 'OpenAi-gpt-35-turbo';\n\n  openAiClientAndDeploymentName = { openAIClient, deploymentName };\n\n  return openAiClientAndDeploymentName;\n}\n\nexport async function produceSummary(article: string): Promise<string> {\n  const { openAIClient, deploymentName } = getClientAndDeploymentName();\n  const minChars = 120;\n  const maxChars = 156;\n\n  const messages = [\n    {\n      role: 'system',\n      content: `You are a summarizer. You will be given the text of an article and will produce a summary / meta description which summarizes the article. The summary / meta descriptions you produce must be between ${minChars} and ${maxChars} characters long. If they are longer or shorter than that they cannot be used. Avoid using the \\`'\\` character as it is not supported by the blog website - you may use the \\`\u2019\\` character instead. Do not use the expression \"the author\" or \"the writer\" in your summary.`,\n    },\n    {\n      role: 'user',\n      content: `Here is an article to summarize:\n\n${article}`,\n    },\n  ];\n\n  let attempts = 0;\n  const maxAttempts = 10;\n  let summary = '';\n  while (attempts++ < maxAttempts) {\n    console.log(`Attempt ${attempts} of ${maxAttempts}`);\n\n    // This will use the Azure CLI's currently logged in user;\n    // make sure you've done `az login` and have the correct subscription selected\n    const result = await openAIClient.getChatCompletions(\n      deploymentName,\n      messages,\n      {\n        temperature: 0.9,\n      },\n    );\n\n    for (const choice of result.choices) {\n      summary = choice.message?.content || '';\n\n      if (summary.length >= minChars && summary.length <= maxChars) {\n        return summary;\n      }\n      console.log(`Summary was ${summary.length} characters long; no good`);\n    }\n\n    messages.push(\n      {\n        role: 'assistant',\n        content: summary,\n      },\n      {\n        role: 'user',\n        content:\n          summary.length < minChars\n            ? `Too short; try again please - we require a summary that is between ${minChars} and ${maxChars} characters long.`\n            : `Too long; try again please - we require a summary that is between ${minChars} and ${maxChars} characters long.`,\n      },\n    );\n\n    console.log(messages);\n\n    await sleep(500);\n  }\n\n  console.log(`Failed to produce a summary in ${maxAttempts} attempts`);\n  return '';\n}\n\nfunction sleep(ms: number) {\n  return new Promise((resolve) => setTimeout(resolve, ms));\n}\n"})}),"\n",(0,o.jsx)(t.p,{children:"There's a lot going on here, so let's break it down."}),"\n",(0,o.jsx)(t.h3,{id:"authentication",children:"Authentication"}),"\n",(0,o.jsxs)(t.p,{children:["Oftentimes the fiddliest part of using Azure Open AI is authentication. In this case, I'm using the Azure CLI credential. So to run this you need to authenticate with the Azure CLI with ",(0,o.jsx)(t.code,{children:"az login"}),". (Remember to make sure you have the correct subscription selected. You can check this by running ",(0,o.jsx)(t.code,{children:"az account show"})," and checking that the ",(0,o.jsx)(t.code,{children:"isDefault"})," property is set to ",(0,o.jsx)(t.code,{children:"true"}),".)"]}),"\n",(0,o.jsx)(t.p,{children:"Once you're logged in, this code will use the currently logged in user to authenticate with Azure Open AI."}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-typescript",children:"const credential = new AzureCliCredential();\nconst openAIClient = new OpenAIClient(endpoint, credential);\nconst deploymentName = 'OpenAi-gpt-35-turbo';\n"})}),"\n",(0,o.jsxs)(t.p,{children:["You need to set the ",(0,o.jsx)(t.code,{children:"endpoint"})," variable to the endpoint of your Azure Open AI resource. You can find this in the Azure Portal by going to your Azure Open AI resource. Look for something like ",(0,o.jsx)(t.code,{children:"https://<resource name>.openai.azure.com"}),". You'll also need to get the name of your deployment. In my case this is ",(0,o.jsx)(t.code,{children:"OpenAi-gpt-35-turbo"}),"."]}),"\n",(0,o.jsx)(t.h3,{id:"producing-the-summary",children:"Producing the summary"}),"\n",(0,o.jsxs)(t.p,{children:["Once you've authenticated and got the client you can start to summarise. The first thing to do is provide a system message to prime the model with context on what we're trying to do. As part of writing a good description, there's a sweet spot to hit in terms of length; too short and it's not useful, too long and it gets truncated. So we're going to aim for between 120 and 156 characters. We're also going to encourage the AI to avoid certain wording constructs and also avoid using the ",(0,o.jsx)(t.code,{children:"'"})," character as it upsets the front matter."]}),"\n",(0,o.jsx)(t.p,{children:"Once primed, we hand over the blog content to the AI and ask it to produce a summary."}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-typescript",children:"const minChars = 120;\nconst maxChars = 156;\n\nconst messages = [\n  {\n    role: 'system',\n    content: `You are a summarizer. You will be given the text of an article and will produce a summary / meta description which summarizes the article. The summary / meta descriptions you produce must be between ${minChars} and ${maxChars} characters long. If they are longer or shorter than that they cannot be used. Avoid using the \\`'\\` character as it is not supported by the blog website - you may use the \\`\u2019\\` character instead. Do not use the expression \"the author\" or \"the writer\" in your summary.`,\n  },\n  {\n    role: 'user',\n    content: `Here is an article to summarize:\n\n${article}`,\n  },\n];\n"})}),"\n",(0,o.jsxs)(t.p,{children:["The way we interact with the Azure Open AI is with the ",(0,o.jsx)(t.code,{children:"getChatCompletions"})," method, which is effectively a strongly typed wrapper for the ",(0,o.jsx)(t.a,{href:"https://learn.microsoft.com/en-us/azure/ai-services/openai/reference#chat-completions",children:"chat-completions endpoint in Azure"}),"."]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-typescript",children:"let attempts = 0;\nconst maxAttempts = 10;\nlet summary = '';\nwhile (attempts++ < maxAttempts) {\n  console.log(`Attempt ${attempts} of ${maxAttempts}`);\n\n  // This will use the Azure CLI's currently logged in user;\n  // make sure you've done `az login` and have the correct subscription selected\n  const result = await openAIClient.getChatCompletions(\n    deploymentName,\n    messages,\n    {\n      temperature: 0.9, // the closer to 1, the more creative the AI will be\n    },\n  );\n\n  for (const choice of result.choices) {\n    summary = choice.message?.content || '';\n\n    if (summary.length >= minChars && summary.length <= maxChars) {\n      return summary;\n    }\n    console.log(`Summary was ${summary.length} characters long; no good`);\n  }\n\n  messages.push(\n    {\n      role: 'assistant',\n      content: summary,\n    },\n    {\n      role: 'user',\n      content:\n        summary.length < minChars\n          ? `Too short; try again please - we require a summary that is between ${minChars} and ${maxChars} characters long.`\n          : `Too long; try again please - we require a summary that is between ${minChars} and ${maxChars} characters long.`,\n    },\n  );\n\n  console.log(messages);\n}\n\nconsole.log(`Failed to produce a summary in ${maxAttempts} attempts`);\nreturn '';\n"})}),"\n",(0,o.jsxs)(t.p,{children:["What's quite interesting, is that you really can't rely on the AI do what you ask it to do. It ",(0,o.jsx)(t.em,{children:"may"})," create a description of an appropriate length. It may not. So we need to check what it gives us, and if it doesn't satisfy our needs, then we ask it to try again. We'll give it a maximum of 10 attempts per post, as surprisingly, every now and then it struggles to meet the brief and infinite loops are to be avoided."]}),"\n",(0,o.jsx)(t.h2,{id:"running-the-script",children:"Running the script"}),"\n",(0,o.jsxs)(t.p,{children:["When the script ran (after I'd ",(0,o.jsx)(t.code,{children:"az login"}),"-ed) it produced descriptions for all my blog posts. I reviewed each summary and tweaked them where necessary. If I really didn't like a description I'd delete and run the script again. In the end I had descriptions for all my blog posts that I was pretty happy with. If you take a look at ",(0,o.jsx)(t.a,{href:"https://github.com/johnnyreilly/blog.johnnyreilly.com/pull/656",children:"this giant PR"})," you can see them all landing."]}),"\n",(0,o.jsxs)(t.p,{children:["Hopefully this post provides a useful example of how to use the TypeScript Azure Open AI SDK to generate article metadata. You can see the raw code ",(0,o.jsx)(t.a,{href:"https://github.com/johnnyreilly/blog.johnnyreilly.com/tree/main/open-ai-description",children:"here"}),"."]})]})}function p(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(h,{...e})}):h(e)}}}]);