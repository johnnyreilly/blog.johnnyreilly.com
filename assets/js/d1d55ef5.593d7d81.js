"use strict";(self.webpackChunkblog_johnnyreilly_com=self.webpackChunkblog_johnnyreilly_com||[]).push([[78254],{3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>d});var n=a(67294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function s(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?s(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):s(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},s=Object.keys(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var l=n.createContext({}),c=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},p=function(e){var t=c(e.components);return n.createElement(l.Provider,{value:t},e.children)},m="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,s=e.originalType,l=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),m=c(a),h=r,d=m["".concat(l,".").concat(h)]||m[h]||u[h]||s;return a?n.createElement(d,i(i({ref:t},p),{},{components:a})):n.createElement(d,i({ref:t},p))}));function d(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var s=a.length,i=new Array(s);i[0]=h;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o[m]="string"==typeof e?e:r,i[1]=o;for(var c=2;c<s;c++)i[c]=a[c];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}h.displayName="MDXCreateElement"},24598:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>c,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>l,toc:()=>p});a(67294);var n=a(3905);function r(){return r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},r.apply(this,arguments)}function s(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},s=Object.keys(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}const i={title:"Swashbuckle and schemaId is already used",authors:"johnnyreilly",tags:["Swashbuckle","CustomSchemaIds","AddSwaggerGen"],image:"./title-image.png",hide_table_of_contents:!1},o=void 0,l={permalink:"/2022/08/31/swashbuckle-schemaid-already-used",editUrl:"https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2022-08-31-swashbuckle-schemaid-already-used/index.md",source:"@site/blog/2022-08-31-swashbuckle-schemaid-already-used/index.md",title:"Swashbuckle and schemaId is already used",description:'Swashbuckle can fail to generate a swagger / Open API document with the message "The same schemaId is already used...". This post explains what that means, and offers a way to work around it.',date:"2022-08-31T00:00:00.000Z",formattedDate:"August 31, 2022",tags:[{label:"Swashbuckle",permalink:"/tags/swashbuckle"},{label:"CustomSchemaIds",permalink:"/tags/custom-schema-ids"},{label:"AddSwaggerGen",permalink:"/tags/add-swagger-gen"}],readingTime:2.25,hasTruncateMarker:!1,authors:[{name:"John Reilly",url:"https://twitter.com/johnny_reilly",imageURL:"https://blog.johnnyreilly.com/img/profile.jpg",key:"johnnyreilly"}],frontMatter:{title:"Swashbuckle and schemaId is already used",authors:"johnnyreilly",tags:["Swashbuckle","CustomSchemaIds","AddSwaggerGen"],image:"./title-image.png",hide_table_of_contents:!1},prevItem:{title:"Reverse engineering the Azure Application Insights Transactions URL",permalink:"/2022/09/03/reverse-engineering-azure-app-insights-transactions-url"},nextItem:{title:"Terry Pratchett and the Azure Static Web Apps",permalink:"/2022/07/23/terry-pratchett-x-clacks-overhead-azure-static-webapps"}},c={image:a(79876).Z,authorsImageUrls:[void 0]},p=[{value:"&quot;The same schemaId is already used...&quot;",id:"the-same-schemaid-is-already-used",level:2},{value:"Nicer names with <code>SwashbuckleSchemaHelper</code>",id:"nicer-names-with-swashbuckleschemahelper",level:2}],m={toc:p};function u(e){var{components:t}=e,i=s(e,["components"]);return(0,n.kt)("wrapper",r({},m,i,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("p",null,'Swashbuckle can fail to generate a swagger / Open API document with the message "The same schemaId is already used...". This post explains what that means, and offers a way to work around it.'),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"title image reading &quot;Swashbuckle and schemaId is already used&quot; with the Azure Static Web Apps logo and a Terry Pratchett icon by Lisa Krymova from NounProject.com",src:a(79876).Z,width:"1600",height:"900"})),(0,n.kt)("h2",r({},{id:"the-same-schemaid-is-already-used"}),'"The same schemaId is already used..."'),(0,n.kt)("p",null,"When creating a swagger / Open API document with Swashbuckle, it's possible to encounter an error of this nature:"),(0,n.kt)("pre",null,(0,n.kt)("code",r({parentName:"pre"},{}),'System.InvalidOperationException: Can\'t use schemaId "$MyType" for type "$OneNamespace.MyType". The same schemaId is already used for type "$OtherNamespace.MyType"\n')),(0,n.kt)("p",null,(0,n.kt)("a",r({parentName:"p"},{href:"https://github.com/domaindrivendev"}),"Richard Morris")," explains the reason for this ",(0,n.kt)("a",r({parentName:"p"},{href:"https://github.com/domaindrivendev/Swashbuckle.AspNetCore/issues/1607#issuecomment-788900097"}),"here"),":"),(0,n.kt)("blockquote",null,(0,n.kt)("p",{parentName:"blockquote"},"By default, SB uses the short (unqualified name) which has its benefits because it keeps the docs simpler but also it\u2019s downside if model names are duplicated in different namespaces.")),(0,n.kt)("p",null,"The solution for this is using the ",(0,n.kt)("inlineCode",{parentName:"p"},"CustomSchemaIds")," configuration option for Swashbuckle. This allows the customisation of type names, such that collisions are prevented. We need types to be unique strings. A simple way to tackle this is something like this:"),(0,n.kt)("pre",null,(0,n.kt)("code",r({parentName:"pre"},{className:"language-cs"}),"services.AddSwaggerGen(options =>\n{\n    options.CustomSchemaIds(type => type.ToString());\n});\n")),(0,n.kt)("p",null,"However, the types created using the above approach can be verbose. Wouldn't it be nice if we could essentially have the names we had before, but just handle duplicates with an incrementing number?"),(0,n.kt)("h2",r({},{id:"nicer-names-with-swashbuckleschemahelper"}),"Nicer names with ",(0,n.kt)("inlineCode",{parentName:"h2"},"SwashbuckleSchemaHelper")),(0,n.kt)("p",null,"We can do exactly this. What we'll do is put together a class called ",(0,n.kt)("inlineCode",{parentName:"p"},"SwashbuckleSchemaHelper"),":"),(0,n.kt)("pre",null,(0,n.kt)("code",r({parentName:"pre"},{className:"language-cs"}),'public class SwashbuckleSchemaHelper\n{\n    private readonly Dictionary<string, List<string>> _schemaNameRepetition = new();\n\n    // borrowed from https://github.com/domaindrivendev/Swashbuckle.AspNetCore/blob/95cb4d370e08e54eb04cf14e7e6388ca974a686e/src/Swashbuckle.AspNetCore.SwaggerGen/SchemaGenerator/SchemaGeneratorOptions.cs#L44\n    private string DefaultSchemaIdSelector(Type modelType)\n    {\n        if (!modelType.IsConstructedGenericType) return modelType.Name.Replace("[]", "Array");\n\n        var prefix = modelType.GetGenericArguments()\n            .Select(genericArg => DefaultSchemaIdSelector(genericArg))\n            .Aggregate((previous, current) => previous + current);\n\n        return prefix + modelType.Name.Split(\'`\').First();\n    }\n\n    public string GetSchemaId(Type modelType)\n    {\n        string id = DefaultSchemaIdSelector(modelType);\n\n        if (!_schemaNameRepetition.ContainsKey(id))\n            _schemaNameRepetition.Add(id, new List<string>());\n\n        var modelNameList = _schemaNameRepetition[id];\n        var fullName = modelType.FullName ?? "";\n        if (!string.IsNullOrEmpty(fullName) && !modelNameList.Contains(fullName))\n            modelNameList.Add(fullName);\n\n        int index = modelNameList.IndexOf(fullName);\n\n        return $"{id}{(index >= 1 ? index.ToString() : "")}";\n    }\n}\n')),(0,n.kt)("p",null,"The above class borrows the ",(0,n.kt)("a",r({parentName:"p"},{href:"https://github.com/domaindrivendev/Swashbuckle.AspNetCore/blob/95cb4d370e08e54eb04cf14e7e6388ca974a686e/src/Swashbuckle.AspNetCore.SwaggerGen/SchemaGenerator/SchemaGeneratorOptions.cs#L44"}),(0,n.kt)("inlineCode",{parentName:"a"},"DefaultSchemaIdSelector"))," implementation from Swashbuckle itself. It creates the type name using that, and then uses a ",(0,n.kt)("inlineCode",{parentName:"p"},"Dictionary")," to track the numbers of usages of it; suffixing a number where there are duplicates to indicate which duplicate is in play on this occasion. This number suffix is inspired ",(0,n.kt)("a",r({parentName:"p"},{href:"https://stackoverflow.com/a/72677918/761388"}),"by an answer on Stack Overflow")," and also by ",(0,n.kt)("a",r({parentName:"p"},{href:"https://github.com/domaindrivendev/Swashbuckle.AspNetCore/issues/1607#issuecomment-1258337736"}),"Glenn Piper's comment here"),"."),(0,n.kt)("p",null,"Usage of this looks like this:"),(0,n.kt)("pre",null,(0,n.kt)("code",r({parentName:"pre"},{className:"language-cs"}),"services.AddSwaggerGen(options =>\n{\n    var schemaHelper = new SwashbuckleSchemaHelper();\n    options.CustomSchemaIds(type => schemaHelper.GetSchemaId(type));\n});\n")),(0,n.kt)("p",null,"The result of using this approach is that you'll start to generate multiple types: ",(0,n.kt)("inlineCode",{parentName:"p"},"MyType")," and ",(0,n.kt)("inlineCode",{parentName:"p"},"MyType2"),', and importantly a goodbye to the "The same schemaId is already used..." message.'))}u.isMDXComponent=!0},79876:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/title-image-a19b6b9e1f30eedcfcdf6c06e664f63f.png"}}]);