"use strict";(self.webpackChunkjohnnyreilly_com=self.webpackChunkjohnnyreilly_com||[]).push([[9740],{76816:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>p});var t=i(74848),r=i(28453);const o={slug:"azure-container-apps-bicep-and-github-actions",title:"Azure Container Apps, Bicep and GitHub Actions",authors:"johnnyreilly",tags:["bicep","github actions","azure container apps"],image:"./title-image.png",hide_table_of_contents:!1,description:"Learn how to deploy an Azure Container App to Azure with Bicep and GitHub Actions. A basic template is provided for deployment."},a=void 0,s={permalink:"/azure-container-apps-bicep-and-github-actions",editUrl:"https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2021-12-19-azure-container-apps-bicep-and-github-actions/index.md",source:"@site/blog/2021-12-19-azure-container-apps-bicep-and-github-actions/index.md",title:"Azure Container Apps, Bicep and GitHub Actions",description:"Learn how to deploy an Azure Container App to Azure with Bicep and GitHub Actions. A basic template is provided for deployment.",date:"2021-12-19T00:00:00.000Z",tags:[{inline:!1,label:"Bicep",permalink:"/tags/bicep",description:"The Bicep language for Azure Resource Manager templates."},{inline:!1,label:"GitHub Actions",permalink:"/tags/github-actions",description:"The GitHub Actions CI / CD service."},{inline:!1,label:"Azure Container Apps",permalink:"/tags/azure-container-apps",description:"The Azure Container Apps service. Effectively a managed Kubernetes service."}],readingTime:3.725,hasTruncateMarker:!0,authors:[{name:"John Reilly",title:"OSS Engineer - TypeScript, Azure, React, Node.js, .NET",url:"https://johnnyreilly.com/about",imageURL:"https://johnnyreilly.com/img/profile.jpg",key:"johnnyreilly",page:null}],frontMatter:{slug:"azure-container-apps-bicep-and-github-actions",title:"Azure Container Apps, Bicep and GitHub Actions",authors:"johnnyreilly",tags:["bicep","github actions","azure container apps"],image:"./title-image.png",hide_table_of_contents:!1,description:"Learn how to deploy an Azure Container App to Azure with Bicep and GitHub Actions. A basic template is provided for deployment."},unlisted:!1,prevItem:{title:"Azure Container Apps: build and deploy with Bicep and GitHub Actions",permalink:"/azure-container-apps-build-and-deploy-with-bicep-and-github-actions"},nextItem:{title:"Open Graph: a guide to sharable social media previews",permalink:"/open-graph-sharing-previews-guide"}},c={image:i(97674).A,authorsImageUrls:[void 0]},p=[{value:"Updated 02/05/2022",id:"updated-02052022",level:2},{value:"Bicep",id:"bicep",level:2},{value:"Setting up a resource group",id:"setting-up-a-resource-group",level:2},{value:"Deploying with the Azure CLI",id:"deploying-with-the-azure-cli",level:2},{value:"Deploying with GitHub Actions",id:"deploying-with-github-actions",level:2},{value:"Running it",id:"running-it",level:2}];function l(e){const n={a:"a",code:"code",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.p,{children:["Azure Container Apps are an exciting way to deploy containers to Azure. This post shows how to deploy the infrastructure for an Azure Container App to Azure using Bicep and GitHub Actions. The ",(0,t.jsx)(n.a,{href:"https://docs.microsoft.com/en-us/azure/container-apps/",children:"Azure Container App documentation"})," features quickstarts for deploying your first container app using both the Azure Portal and the Azure CLI. These are great, but there's a gap if you prefer to deploy using Bicep and you'd like to get your CI/CD setup right from the beginning. This post aims to fill that gap."]}),"\n",(0,t.jsxs)(n.p,{children:["If you're interested in building your own containers as well, it's worth looking at ",(0,t.jsx)(n.a,{href:"/azure-container-apps-build-and-deploy-with-bicep-and-github-actions",children:"this follow up post"}),"."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"title image reading &quot;Azure Container Apps, Bicep and GitHub Actions&quot; with the Bicep, Azure Container Apps and GitHub Actions logos",src:i(24343).A+"",width:"1600",height:"900",loading:"eager",fetchpriority:"high"})}),"\n",(0,t.jsx)(n.h2,{id:"updated-02052022",children:"Updated 02/05/2022"}),"\n",(0,t.jsxs)(n.p,{children:["This post has been updated to reflect the migration of Azure Container Apps from the Microsoft.Web namespace to the Microsoft.App namespace in March 2022. See: ",(0,t.jsx)(n.a,{href:"https://github.com/microsoft/azure-container-apps/issues/109",children:"https://github.com/microsoft/azure-container-apps/issues/109"})]}),"\n",(0,t.jsx)(n.h2,{id:"bicep",children:"Bicep"}),"\n",(0,t.jsx)(n.p,{children:"Let's begin with the Bicep required to deploy an Azure Container App."}),"\n",(0,t.jsxs)(n.p,{children:["In our new repository we'll create an ",(0,t.jsx)(n.code,{children:"infra"})," directory, into which we'll place a ",(0,t.jsx)(n.code,{children:"main.bicep"})," file which will contain our Bicep template."]}),"\n",(0,t.jsx)(n.p,{children:"I've pared this down to the simplest Bicep template that I can; it only requires a name parameter:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bicep",children:"param name string\nparam secrets array = []\n\nvar location = resourceGroup().location\nvar environmentName = 'Production'\nvar workspaceName = '${name}-log-analytics'\n\nresource workspace 'Microsoft.OperationalInsights/workspaces@2021-12-01-preview' = {\n  name: workspaceName\n  location: location\n  properties: {\n    sku: {\n      name: 'PerGB2018'\n    }\n    retentionInDays: 30\n    workspaceCapping: {}\n  }\n}\n\nresource environment 'Microsoft.App/managedEnvironments@2022-01-01-preview' = {\n  name: environmentName\n  location: location\n  properties: {\n    appLogsConfiguration: {\n      destination: 'log-analytics'\n      logAnalyticsConfiguration: {\n        customerId: workspace.properties.customerId\n        sharedKey: listKeys(workspace.id, workspace.apiVersion).primarySharedKey\n      }\n    }\n  }\n}\n\nresource containerApp 'Microsoft.App/containerApps@2022-01-01-preview' = {\n  name: name\n  kind: 'containerapps'\n  location: location\n  properties: {\n    managedEnvironmentId: environment.id\n    configuration: {\n      secrets: secrets\n      registries: []\n      ingress: {\n        'external':true\n        'targetPort':80\n      }\n    }\n    template: {\n      containers: [\n        {\n          'name':'simple-hello-world-container'\n          'image':'mcr.microsoft.com/azuredocs/containerapps-helloworld:latest'\n          'command':[]\n          'resources':{\n            'cpu':'.25'\n            'memory':'.5Gi'\n          }\n        }\n      ]\n    }\n  }\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"Some things to note from the template:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"We're deploying three resources; a container app, a kube environment and an operational insights."}),"\n",(0,t.jsxs)(n.li,{children:["Just like the official quickstarts we're going to use the ",(0,t.jsx)(n.code,{children:"containerapps-helloworld"})," image."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"setting-up-a-resource-group",children:"Setting up a resource group"}),"\n",(0,t.jsx)(n.p,{children:"In order that you can deploy your Bicep, we're going to need a resource group to send it to. Right now, Azure Container Apps aren't available everywhere. So we're going to create ourselves a resource group in North Europe which does support ACAs:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"az group create -g rg-aca -l northeurope\n"})}),"\n",(0,t.jsx)(n.h2,{id:"deploying-with-the-azure-cli",children:"Deploying with the Azure CLI"}),"\n",(0,t.jsx)(n.p,{children:"With this resource group in place, we could simply deploy using the Azure CLI like so:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"az deployment group create \\\n  --resource-group rg-aca \\\n  --template-file ./infra/main.bicep \\\n  --parameters \\\n    name='container-app'\n"})}),"\n",(0,t.jsx)(n.h2,{id:"deploying-with-github-actions",children:"Deploying with GitHub Actions"}),"\n",(0,t.jsxs)(n.p,{children:["However, we're aiming to set up a GitHub Action to do this for us. We'll create a ",(0,t.jsx)(n.code,{children:".github/workflows/deploy.yaml"})," file in our repository:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"name: Deploy\non:\n  push:\n    branches: [main]\n  workflow_dispatch:\n\nenv:\n  RESOURCE_GROUP: rg-aca\n\njobs:\n  deploy:\n    runs-on: ubuntu-latest\n    steps:\n      - name: Checkout repository\n        uses: actions/checkout@v2\n\n      - name: Azure Login\n        uses: azure/login@v1\n        with:\n          creds: ${{ secrets.AZURE_CREDENTIALS }}\n\n      - name: Deploy bicep\n        uses: azure/CLI@v2\n        with:\n          inlineScript: |\n            az deployment group create \\\n              --resource-group ${{ env.RESOURCE_GROUP }} \\\n              --template-file ./infra/main.bicep \\\n              --parameters \\\n                name='container-app'\n"})}),"\n",(0,t.jsx)(n.p,{children:"The above GitHub action is very simple. It:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Logs into Azure using some ",(0,t.jsx)(n.code,{children:"AZURE_CREDENTIALS"})," we'll set up in a moment."]}),"\n",(0,t.jsx)(n.li,{children:"Invokes the Azure CLI to deploy our Bicep template."}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Let's create that ",(0,t.jsx)(n.code,{children:"AZURE_CREDENTIALS"})," secret in GitHub:"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Screenshot of AZURE_CREDENTIALS secret in the GitHub website that we need to create",src:i(37338).A+"",width:"1540",height:"235",loading:"lazy"})}),"\n",(0,t.jsx)(n.p,{children:"We'll use the Azure CLI once more:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:'az ad sp create-for-rbac --name "myApp" --role contributor \\\n    --scopes /subscriptions/{subscription-id}/resourceGroups/{resource-group} \\\n    --sdk-auth\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Remember to replace the ",(0,t.jsx)(n.code,{children:"{subscription-id}"})," with your subscription id and ",(0,t.jsx)(n.code,{children:"{resource-group}"})," with the name of your resource group (",(0,t.jsx)(n.code,{children:"rg-aca"})," if you're following along). This command will pump out a lump of JSON that looks something like this:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "clientId": "a-client-id",\n  "clientSecret": "a-client-secret",\n  "subscriptionId": "a-subscription-id",\n  "tenantId": "a-tenant-id",\n  "activeDirectoryEndpointUrl": "https://login.microsoftonline.com",\n  "resourceManagerEndpointUrl": "https://management.azure.com/",\n  "activeDirectoryGraphResourceId": "https://graph.windows.net/",\n  "sqlManagementEndpointUrl": "https://management.core.windows.net:8443/",\n  "galleryEndpointUrl": "https://gallery.azure.com/",\n  "managementEndpointUrl": "https://management.core.windows.net/"\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Take this and save it as the ",(0,t.jsx)(n.code,{children:"AZURE_CREDENTIALS"})," secret in Azure."]}),"\n",(0,t.jsx)(n.h2,{id:"running-it",children:"Running it"}),"\n",(0,t.jsx)(n.p,{children:"When the GitHub Action has been run you'll find that Azure Container App is now showing up inside the Azure Portal:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"screenshot of the Azure Container App in the Azure Portal",src:i(36044).A+"",width:"1400",height:"541",loading:"lazy"})}),"\n",(0,t.jsx)(n.p,{children:"You'll see a URL is displayed, when you go that URL you'll find the hello world image is running!"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"screenshot of the running Azure Container App",src:i(42265).A+"",width:"2227",height:"953",loading:"lazy"})})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},97674:(e,n,i)=>{i.d(n,{A:()=>t});const t=i.p+"assets/images/title-image-7a669054be446a898a58586c2b1d466d.png"},36044:(e,n,i)=>{i.d(n,{A:()=>t});const t=i.p+"assets/images/screenshot-azure-portal-container-app-626731be670f8d3df0473c24245c1264.png"},37338:(e,n,i)=>{i.d(n,{A:()=>t});const t=i.p+"assets/images/screenshot-github-secrets-0301b0c474cce2035eda58d8f4c1cc2d.webp"},42265:(e,n,i)=>{i.d(n,{A:()=>t});const t=i.p+"assets/images/screenshot-of-running-container-app-9c2faf56fe8f79d635d7365293bc823a.png"},24343:(e,n,i)=>{i.d(n,{A:()=>t});const t=i.p+"assets/images/title-image-7a669054be446a898a58586c2b1d466d.png"},28453:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>s});var t=i(96540);const r={},o=t.createContext(r);function a(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);