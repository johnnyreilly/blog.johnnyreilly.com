"use strict";(self.webpackChunkjohnnyreilly_com=self.webpackChunkjohnnyreilly_com||[]).push([[71344],{19663:e=>{e.exports=JSON.parse('{"permalink":"/npx-and-azure-artifacts-the-secret-cli-delivery-mechanism","editUrl":"https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2024-12-08-npx-and-azure-artifacts-the-secret-cli-delivery-mechanism/index.md","source":"@site/blog/2024-12-08-npx-and-azure-artifacts-the-secret-cli-delivery-mechanism/index.md","title":"npx and Azure Artifacts: the secret CLI delivery mechanism","description":"By combining npx and Azure Artifacts, you can deliver your command line application to consumers in a way that is easy to use and secure.","date":"2024-12-08T00:00:00.000Z","tags":[{"inline":false,"label":"Azure DevOps","permalink":"/tags/azure-devops","description":"The Azure DevOps suite of tools."},{"inline":false,"label":"Node.js","permalink":"/tags/node-js","description":"The Node.js runtime."}],"readingTime":7.49,"hasTruncateMarker":true,"authors":[{"name":"John Reilly","title":"OSS Engineer - TypeScript, Azure, React, Node.js, .NET","url":"https://johnnyreilly.com/about","imageURL":"https://johnnyreilly.com/img/profile.jpg","key":"johnnyreilly","page":null}],"frontMatter":{"slug":"npx-and-azure-artifacts-the-secret-cli-delivery-mechanism","title":"npx and Azure Artifacts: the secret CLI delivery mechanism","authors":"johnnyreilly","tags":["azure devops","node.js"],"image":"./title-image.png","hide_table_of_contents":false,"description":"By combining npx and Azure Artifacts, you can deliver your command line application to consumers in a way that is easy to use and secure."},"unlisted":false,"prevItem":{"title":"Smuggling .gitignore, .npmrc and friends in npm packages","permalink":"/smuggling-gitignore-npmrc-in-npm-packages"},"nextItem":{"title":"Azure Artifacts: Publish a private npm package with Azure DevOps","permalink":"/azure-artifacts-publish-private-npm-package-with-azure-devops"}}')},22002:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/screenshot-npmrc-e8b46fa648b27148f109ea8fbf6ba807.png"},28453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>r});var i=t(96540);const o={},a=i.createContext(o);function s(e){const n=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),i.createElement(a.Provider,{value:n},e.children)}},36432:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/title-image-d0c6ea44c850de93c1f5bc9b5dc3861f.png"},46890:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>d,frontMatter:()=>s,metadata:()=>i,toc:()=>l});var i=t(19663),o=t(74848),a=t(28453);const s={slug:"npx-and-azure-artifacts-the-secret-cli-delivery-mechanism",title:"npx and Azure Artifacts: the secret CLI delivery mechanism",authors:"johnnyreilly",tags:["azure devops","node.js"],image:"./title-image.png",hide_table_of_contents:!1,description:"By combining npx and Azure Artifacts, you can deliver your command line application to consumers in a way that is easy to use and secure."},r=void 0,c={image:t(36432).A,authorsImageUrls:[void 0]},l=[{value:"Why is combining <code>npx</code> with private npm feeds useful?",id:"why-is-combining-npx-with-private-npm-feeds-useful",level:2},{value:"Publishing a package to Azure Artifacts",id:"publishing-a-package-to-azure-artifacts",level:2},{value:"The <code>registry</code> config setting of <code>npm</code> / <code>npx</code>",id:"the-registry-config-setting-of-npm--npx",level:2},{value:"Running the CLI tool with <code>npx</code>",id:"running-the-cli-tool-with-npx",level:2},{value:"What about authentication?",id:"what-about-authentication",level:2},{value:"Using <code>azdo-npm-auth</code> to authenticate with Azure Artifacts",id:"using-azdo-npm-auth-to-authenticate-with-azure-artifacts",level:2},{value:"Running the original command again",id:"running-the-original-command-again",level:2},{value:"Conclusion",id:"conclusion",level:2}];function h(e){const n={a:"a",code:"code",h2:"h2",img:"img",p:"p",pre:"pre",strong:"strong",...(0,a.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(n.p,{children:["The ",(0,o.jsxs)(n.a,{href:"https://docs.npmjs.com/cli/v8/commands/npx",children:[(0,o.jsx)(n.code,{children:"npx"})," command"]})," is a powerful tool for running CLI tools shipped as npm packages, without having to install them globally. ",(0,o.jsx)(n.code,{children:"npx"})," is typically used to run packages on the public npm registry. However, if you have a private npm feed, you can also use ",(0,o.jsx)(n.code,{children:"npx"})," to run packages available on that feed."]}),"\n",(0,o.jsxs)(n.p,{children:["Azure Artifacts is a feature of Azure DevOps that supports publishing npm packages to a feed for consumption. (You might want to read ",(0,o.jsx)(n.a,{href:"/azure-artifacts-publish-private-npm-package-with-azure-devops",children:"this guide on publishing npm packages to Azure Artifacts"}),".) By combining ",(0,o.jsx)(n.code,{children:"npx"})," and Azure Artifacts, you can deliver your CLI tool to consumers in a way that's easy to use and secure."]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"title image reading &quot;Azure Artifacts: Publish a private npm package with Azure DevOps&quot; with an Azure DevOps and npm logos",src:t(99837).A+"",width:"1600",height:"900",loading:"lazy"})}),"\n",(0,o.jsxs)(n.p,{children:["This post shows how to use ",(0,o.jsx)(n.code,{children:"npx"})," and Azure Artifacts to deliver your private CLI tool to consumers."]}),"\n",(0,o.jsxs)(n.h2,{id:"why-is-combining-npx-with-private-npm-feeds-useful",children:["Why is combining ",(0,o.jsx)(n.code,{children:"npx"})," with private npm feeds useful?"]}),"\n",(0,o.jsx)(n.p,{children:"If you've ever found a need to deliver a private CLI tool to consumers, you'll know that it can be a challenge."}),"\n",(0,o.jsx)(n.p,{children:"I work for a large organization and we need to share internal tools with our colleagues. The problem is, that it's hard to get people to install tools. Either you need to provide detailed instructions on how to acquire and install the tool, or you need to work out some kind of internal distribution mechanism. You also have to think about how to update the tool. It's not simple."}),"\n",(0,o.jsxs)(n.p,{children:["By combining ",(0,o.jsx)(n.code,{children:"npx"})," and Azure Artifacts it becomes much simpler. You can publish your CLI tool to a private npm feed and then consumers can run it with a single command. They don't need to install anything up front (apart from Node.js which they likely already have), and they don't need to worry about updates."]}),"\n",(0,o.jsx)(n.p,{children:"A typical usecase is the one I've mentioned; sharing tools internally in an organisation. But, broader than that, if you want to deliver a private CLI tool to consumers, this is a great way to do it."}),"\n",(0,o.jsx)(n.p,{children:"We're going to look at how we'd achieve this with Azure Artifacts as the host of the npm package. But, you could use any private npm feed that you have access to."}),"\n",(0,o.jsx)(n.h2,{id:"publishing-a-package-to-azure-artifacts",children:"Publishing a package to Azure Artifacts"}),"\n",(0,o.jsxs)(n.p,{children:["Before you can use ",(0,o.jsx)(n.code,{children:"npx"})," to run your CLI tool, you need to publish it to a private npm feed. Here is a guide on ",(0,o.jsx)(n.a,{href:"/azure-artifacts-publish-private-npm-package-with-azure-devops",children:"how to publish a private npm package with Azure Artifacts"}),". In that example we published a package to a feed called ",(0,o.jsx)(n.code,{children:"npmrc-script-organization"})," in the ",(0,o.jsx)(n.code,{children:"johnnyreilly"})," organization of Azure DevOps / Azure Artifacts."]}),"\n",(0,o.jsxs)(n.p,{children:["For the sake of this post, we'll say that our package is a CLI tool with the name ",(0,o.jsx)(n.code,{children:"@johnnyreilly/my-cli-tool"}),"."]}),"\n",(0,o.jsxs)(n.p,{children:["Remember, an npm package which houses a CLI tool is merely an npm package with a ",(0,o.jsxs)(n.a,{href:"https://docs.npmjs.com/cli/v10/configuring-npm/package-json#bin",children:[(0,o.jsx)(n.code,{children:"bin"})," entry in the ",(0,o.jsx)(n.code,{children:"package.json"})]}),". This post is not about how to create a CLI tool, but rather how to deliver one to private consumers. If you would like to see an example of what a CLI tool package looks like, you can check out the ",(0,o.jsxs)(n.a,{href:"https://github.com/johnnyreilly/azdo-npm-auth",children:[(0,o.jsx)(n.code,{children:"azdo-npm-auth"})," package on GitHub"]}),". (In fact, we'll use ",(0,o.jsx)(n.code,{children:"azdo-npm-auth"})," later in this post - it's an example of a CLI tool published to the ",(0,o.jsx)(n.strong,{children:"public"})," npm registry.)"]}),"\n",(0,o.jsxs)(n.p,{children:["The question now is, how we can run the (private) ",(0,o.jsx)(n.code,{children:"@johnnyreilly/my-cli-tool"})," package with ",(0,o.jsx)(n.code,{children:"npx"}),"?"]}),"\n",(0,o.jsxs)(n.h2,{id:"the-registry-config-setting-of-npm--npx",children:["The ",(0,o.jsx)(n.code,{children:"registry"})," config setting of ",(0,o.jsx)(n.code,{children:"npm"})," / ",(0,o.jsx)(n.code,{children:"npx"})]}),"\n",(0,o.jsxs)(n.p,{children:["The secret sauce of running a CLI tool from a private npm feed with ",(0,o.jsx)(n.code,{children:"npx"})," is the ",(0,o.jsxs)(n.a,{href:"https://docs.npmjs.com/cli/v8/using-npm/config#registry",children:[(0,o.jsx)(n.code,{children:"registry"})," config setting of ",(0,o.jsx)(n.code,{children:"npm"})," / ",(0,o.jsx)(n.code,{children:"npx"})]}),". The ",(0,o.jsx)(n.code,{children:"registry"})," option allows you to specify the URL of the npm feed that you want to use."]}),"\n",(0,o.jsx)(n.p,{children:'For our case, we grabbed the registry URL from the Azure DevOps UI by clicking on the "Connect to Feed" button in the Azure Artifacts section:'}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"Screenshot of &quot;connect to feed&quot; in Azure DevOps",src:t(87706).A+"",width:"1016",height:"118",loading:"lazy"})}),"\n",(0,o.jsxs)(n.p,{children:["When we selected ",(0,o.jsx)(n.code,{children:"npm"}),", ADO displayed instructions for setting up an ",(0,o.jsx)(n.code,{children:".npmrc"})," file for private consumption:"]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"Screenshot of the instructions for setting up the .npmrc file",src:t(22002).A+"",width:"2240",height:"678",loading:"lazy"})}),"\n",(0,o.jsxs)(n.p,{children:["We don't need to set up an ",(0,o.jsx)(n.code,{children:".npmrc"})," file to run the CLI tool with ",(0,o.jsx)(n.code,{children:"npx"}),", but we do need to grab the registry URL, which we can see in the example ",(0,o.jsx)(n.code,{children:".npmrc"})," file above. In our case, the URL is ",(0,o.jsx)(n.code,{children:"https://pkgs.dev.azure.com/johnnyreilly/_packaging/npmrc-script-organization/npm/registry/"}),". This is the URL of the registry (private npm feed) that we want to use."]}),"\n",(0,o.jsxs)(n.h2,{id:"running-the-cli-tool-with-npx",children:["Running the CLI tool with ",(0,o.jsx)(n.code,{children:"npx"})]}),"\n",(0,o.jsxs)(n.p,{children:["Equipped with the registry URL, we can now run our CLI tool with ",(0,o.jsx)(n.code,{children:"npx"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"npx -y --registry https://pkgs.dev.azure.com/johnnyreilly/_packaging/npmrc-script-organization/npm/registry/ @johnnyreilly/my-cli-tool\n"})}),"\n",(0,o.jsxs)(n.p,{children:["This command will download the ",(0,o.jsx)(n.code,{children:"@johnnyreilly/my-cli-tool"})," package from the private npm feed and run it. The ",(0,o.jsx)(n.code,{children:"--registry"})," option tells ",(0,o.jsx)(n.code,{children:"npx"})," to use the specified registry URL to download the package and the ",(0,o.jsx)(n.code,{children:"-y"})," option tells ",(0,o.jsx)(n.code,{children:"npx"}),' to answer "yes" to the installation prompt.']}),"\n",(0,o.jsx)(n.p,{children:"If you need to pass arguments to the CLI tool, you can simply add them to the end of the command as you would with any CLI tool: (I'll put this over multiple lines for readability, but you can run it as a single line)"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"npx -y \\\n  --registry https://pkgs.dev.azure.com/johnnyreilly/_packaging/npmrc-script-organization/npm/registry/ \\\n  @johnnyreilly/my-cli-tool --arg1 hello\n"})}),"\n",(0,o.jsxs)(n.p,{children:["There is another way to specify the registry URL, which is to use the ",(0,o.jsx)(n.code,{children:"npm_config_registry"})," environment variable. This approach is more verbose and is not cross platform (it won't work on Windows). But, if you prefer this approach, you can use this style of command:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"npm_config_registry=https://pkgs.dev.azure.com/johnnyreilly/_packaging/npmrc-script-organization/npm/registry/ npx -y @johnnyreilly/my-cli-tool\n"})}),"\n",(0,o.jsx)(n.h2,{id:"what-about-authentication",children:"What about authentication?"}),"\n",(0,o.jsx)(n.p,{children:"If you encounter an error like this:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"npm error code E401\nnpm error Unable to authenticate, your authentication token seems to be invalid.\nnpm error To correct this please try logging in again with:\nnpm error npm login\n"})}),"\n",(0,o.jsx)(n.p,{children:"Then npm is telling you to authenticate with the private npm feed / registry. This is because the feed is private and requires authentication. This is a good thing; it means that your package is secure; just as you'd hoped."}),"\n",(0,o.jsx)(n.p,{children:"You may have your own way of authenticating with the feed. If so, great! Do that now and skip the next section."}),"\n",(0,o.jsxs)(n.h2,{id:"using-azdo-npm-auth-to-authenticate-with-azure-artifacts",children:["Using ",(0,o.jsx)(n.code,{children:"azdo-npm-auth"})," to authenticate with Azure Artifacts"]}),"\n",(0,o.jsxs)(n.p,{children:["On the other hand, if you're using Azure Artifacts (",(0,o.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/devops/organizations/accounts/connect-organization-to-azure-ad?view=azure-devops",children:"and your Azure DevOps organisation is connected with your Azure account / Microsoft Entra ID"}),"), you can use ",(0,o.jsx)(n.a,{href:"https://github.com/johnnyreilly/azdo-npm-auth",children:(0,o.jsx)(n.code,{children:"azdo-npm-auth"})})," to solve your authentication needs. You can run ",(0,o.jsx)(n.code,{children:"azdo-npm-auth"})," like this:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"npx -y azdo-npm-auth --registry https://pkgs.dev.azure.com/johnnyreilly/_packaging/npmrc-script-organization/npm/registry/\n"})}),"\n",(0,o.jsxs)(n.p,{children:["The above command will acquire a PAT (Personal Access Token) from Azure DevOps and use it to create a user ",(0,o.jsx)(n.code,{children:".npmrc"})," file, which will be used by ",(0,o.jsx)(n.code,{children:"npx"})," to authenticate with the feed subsequently."]}),"\n",(0,o.jsxs)(n.p,{children:["If you encounter a ",(0,o.jsx)(n.code,{children:"npm error code E401"})," as you run the ",(0,o.jsx)(n.code,{children:"azdo-npm-auth"})," command, it's possible that you have a local ",(0,o.jsx)(n.code,{children:".npmrc"})," file that is tripping ",(0,o.jsx)(n.code,{children:"npx"})," up. You can get around that by explicitly passing the ",(0,o.jsx)(n.code,{children:"--registry"})," of the public npm feed / registry to ",(0,o.jsx)(n.code,{children:"npx"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"npx -y --registry https://registry.npmjs.org azdo-npm-auth --registry https://pkgs.dev.azure.com/johnnyreilly/_packaging/npmrc-script-organization/npm/registry/\n"})}),"\n",(0,o.jsxs)(n.p,{children:["That's right; we're passing the public npm registry to ",(0,o.jsx)(n.code,{children:"npx"}),"'s ",(0,o.jsx)(n.code,{children:"--registry"})," and we're passing our private npm feed / registry to ",(0,o.jsx)(n.code,{children:"azdo-npm-auth"}),"'s ",(0,o.jsx)(n.code,{children:"--registry"}),". This gets around the ",(0,o.jsx)(n.code,{children:"npm error code E401"})," issue."]}),"\n",(0,o.jsx)(n.h2,{id:"running-the-original-command-again",children:"Running the original command again"}),"\n",(0,o.jsx)(n.p,{children:"Whichever way you authenticated, you should now be ready. You can now run the original command again; it should work this time. For example:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"npx -y --registry https://pkgs.dev.azure.com/johnnyreilly/_packaging/npmrc-script-organization/npm/registry/ @johnnyreilly/my-cli-tool\n"})}),"\n",(0,o.jsxs)(n.p,{children:["And that's it! You've successfully run your CLI tool from a private npm feed with ",(0,o.jsx)(n.code,{children:"npx"}),"."]}),"\n",(0,o.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,o.jsxs)(n.p,{children:["In this post we've used Azure Artifacts as the host of the npm package, but you could use any npm feed that you have access to. The key is to use the ",(0,o.jsx)(n.code,{children:"registry"})," option of ",(0,o.jsx)(n.code,{children:"npm"})," / ",(0,o.jsx)(n.code,{children:"npx"})," to specify the URL of the npm feed."]}),"\n",(0,o.jsxs)(n.p,{children:["By combining ",(0,o.jsx)(n.code,{children:"npx"})," and private npm feeds, you can deliver your CLI tool to consumers in a way that's easy to use and secure. Consumers can run your tool with a single command, without having to install anything up front. This is a powerful way to share private CLI tools."]})]})}function d(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(h,{...e})}):h(e)}},87706:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/screenshot-connect-to-feed-9420465335c838a5365e11888ea36437.webp"},99837:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/title-image-d0c6ea44c850de93c1f5bc9b5dc3861f.png"}}]);