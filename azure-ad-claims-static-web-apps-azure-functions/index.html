<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.0">
<title data-rh="true">Azure AD Claims with Static Web Apps and Azure Functions | johnnyreilly</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://johnnyreilly.com/azure-ad-claims-static-web-apps-azure-functions"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="robots" content="max-image-preview:large"><meta data-rh="true" name="monetization" content="$ilp.uphold.com/LwQQhXdpwxeJ"><meta data-rh="true" property="og:title" content="Azure AD Claims with Static Web Apps and Azure Functions | johnnyreilly"><meta data-rh="true" name="description" content="Authorization with Azure Static Web Apps linked to Azure Functions has an issue. Azure AD app role claims are not supplied; this post will demo a workaround."><meta data-rh="true" property="og:description" content="Authorization with Azure Static Web Apps linked to Azure Functions has an issue. Azure AD app role claims are not supplied; this post will demo a workaround."><meta data-rh="true" property="og:image" content="https://res.cloudinary.com/priou/image/fetch/f_auto,q_auto,w_auto,dpr_auto/https://johnnyreilly.com/assets/images/title-image-bf4b643f03830f5f5ad3512d581138f3.png"><meta data-rh="true" name="twitter:image" content="https://res.cloudinary.com/priou/image/fetch/f_auto,q_auto,w_auto,dpr_auto/https://johnnyreilly.com/assets/images/title-image-bf4b643f03830f5f5ad3512d581138f3.png"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-11-17T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://johnnyreilly.com/about"><meta data-rh="true" property="article:tag" content="auth,azure functions,azure static web apps,azure"><link data-rh="true" rel="icon" href="/favicon.ico"><link data-rh="true" rel="canonical" href="https://johnnyreilly.com/azure-ad-claims-static-web-apps-azure-functions"><link data-rh="true" rel="alternate" href="https://johnnyreilly.com/azure-ad-claims-static-web-apps-azure-functions" hreflang="en"><link data-rh="true" rel="alternate" href="https://johnnyreilly.com/azure-ad-claims-static-web-apps-azure-functions" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://J3MYR1INLT-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="johnnyreilly" href="/opensearch.xml">

<link rel="icon" href="/img/profile-64x64.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#3578e5">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="preload" href="https://johnnyreilly.com/fonts/Poppins-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://johnnyreilly.com/fonts/Poppins-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preconnect" href="https://res.cloudinary.com">
<link rel="monetization" href="https://ilp.uphold.com/LwQQhXdpwxeJ">
<script type="application/ld+json">{"@context":"https://schema.org","@graph":[{"@id":"https://johnnyreilly.com","@type":"WebSite","url":"https://johnnyreilly.com","name":"johnnyreilly","description":"This is John Reilly's blog. John is an Open Source Software Engineer working on TypeScript, Azure, React, Node.js, .NET and more.","copyrightHolder":{"@id":"https://johnnyreilly.com/about"},"publisher":{"@id":"https://johnnyreilly.com/about"},"potentialAction":{"@type":"SearchAction","target":{"@type":"EntryPoint","urlTemplate":"https://johnnyreilly.com/search?q={search_term_string}"},"query-input":"required name=search_term_string"},"inLanguage":"en-UK"},{"@id":"https://johnnyreilly.com/about","@type":"Person","name":"John Reilly","alternateName":"Johnny Reilly","image":{"@type":"ImageObject","inLanguage":"en-UK","@id":"https://johnnyreilly.com/about#image","url":"https://johnnyreilly.com/img/profile.jpg","contentUrl":"https://johnnyreilly.com/img/profile.jpg","width":200,"height":200,"caption":"John Reilly"},"description":"John is an Open Source Software Engineer working on TypeScript, Azure, React, Node.js, .NET and more. As well as writing code, John is a speaker at meetups, one of the founders of the TS Congress conference, and the author of the history of Definitely Typed, which he worked on in the early days of TypeScript.","url":"https://johnnyreilly.com","address":{"@type":"PostalAddress","streetAddress":"Twickenham","addressLocality":"London","addressCountry":"United Kingdom"},"email":"johnny_reilly@hotmail.com","birthPlace":"Bristol","sameAs":["https://github.com/johnnyreilly","https://fosstodon.org/@johnny_reilly","https://twitter.com/johnny_reilly","https://dev.to/johnnyreilly","https://app.daily.dev/johnnyreilly","https://stackoverflow.com/users/761388/john-reilly","https://blog.logrocket.com/author/johnreilly/","https://www.reddit.com/user/johnny_reilly","https://uk.linkedin.com/in/johnnyreilly"]},{"@id":"https://johnnyreilly.com/about#organization","@type":["Organization","Brand"],"url":"https://johnnyreilly.com","name":"johnnyreilly","description":"This is John Reilly's blog. John is an Open Source Software Engineer working on TypeScript, Azure, React, Node.js, .NET and more.","logo":{"@type":"ImageObject","inLanguage":"en-UK","@id":"https://johnnyreilly.com/#logo","url":"https://johnnyreilly.com/img/profile.jpg","contentUrl":"https://johnnyreilly.com/img/profile.jpg","width":200,"height":200,"caption":"John Reilly"},"image":{"@id":"https://johnnyreilly.com/#logo"},"sameAs":["https://github.com/johnnyreilly","https://fosstodon.org/@johnny_reilly","https://twitter.com/johnny_reilly","https://dev.to/johnnyreilly","https://app.daily.dev/johnnyreilly","https://stackoverflow.com/users/761388/john-reilly","https://blog.logrocket.com/author/johnreilly/","https://www.reddit.com/user/johnny_reilly","https://uk.linkedin.com/in/johnnyreilly"]}]}</script>
<link rel="webmention" href="https://webmention.io/johnnyreilly.com/webmention"><link rel="stylesheet" href="/assets/css/styles.06f8963f.css">
<script src="/assets/js/runtime~main.ededbaeb.js" defer="defer"></script>
<script src="/assets/js/main.d785b257.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><script type="application/ld+json">[{"@context":"https://schema.org","@type":"BreadcrumbList","@id":"/azure-ad-claims-static-web-apps-azure-functions#breadcrumb","name":"Blog breadcrumb","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https://johnnyreilly.com"},{"@type":"ListItem","position":2,"name":"Blog","item":"https://johnnyreilly.com/blog"},{"@type":"ListItem","position":3,"name":"Azure AD Claims with Static Web Apps and Azure Functions"}]}]</script><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile-64x64.jpg" alt="Profile picture of John Reilly" class="themedComponent_mlkZ themedComponent--light_NVdE" height="32" width="32"><img src="/img/profile-64x64.jpg" alt="Profile picture of John Reilly" class="themedComponent_mlkZ themedComponent--dark_xIcU" height="32" width="32"></div><b class="navbar__title text--truncate">John Reilly</b></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/talks">Talks</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/johnnyreilly" target="_blank" rel="me" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="me" class="navbar__item navbar__link">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://fosstodon.org/@johnny_reilly" target="_blank" rel="me" class="navbar__item navbar__link">Mastodon<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/schemar-github-action-to-validate-structured-data">Schemar: a GitHub Action to validate structured data</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/snapshot-log-tests-dotnet">Snapshot log tests in .NET</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/bun-overview">Overview of Bun, a JavaScript runtime</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/how-we-fixed-my-seo">How we fixed my SEO</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/graph-api-ad-users-group-name-ids-csharp-sdk">Graph API: getting users Active Directory group names and ids with the C# SDK</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/migrating-azure-functions-node-js-v4-typescript">Migrating to v4 Azure Functions Node.js with TypeScript</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/bicep-link-azure-application-insights-to-static-web-apps">Bicep: Link Azure Application Insights to Static Web Apps</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docusaurus-3-how-to-migrate-rehype-plugins">Docusaurus 3: how to migrate rehype plugins</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="Authorization with Azure Static Web Apps linked to Azure Functions has an issue. Azure AD app role claims are not supplied; this post will demo a workaround."><link itemprop="image" href="https://johnnyreilly.com/assets/images/title-image-bf4b643f03830f5f5ad3512d581138f3.png"><header><h1 class="title_f1Hy" itemprop="headline">Azure AD Claims with Static Web Apps and Azure Functions</h1><div class="container_mt6G margin-vert--md"><time datetime="2022-11-17T00:00:00.000Z" itemprop="datePublished">November 17, 2022</time> · <!-- -->12 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://johnnyreilly.com/about" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://johnnyreilly.com/img/profile.jpg" alt="John Reilly" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://johnnyreilly.com/about" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div><small class="avatar__subtitle" itemprop="description">OSS Engineer - TypeScript, Azure, React, Node.js, .NET</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>Authorization in Azure Functions is impaired by an issue with Azure Static Web Apps linked to Azure Functions. Azure AD app role claims are not supplied to Azure Functions. This post will demonstrate a workaround.</p>
<p><img loading="eager" alt="title image reading &amp;quot;Azure AD Claims with Static Web Apps and Azure Functions&amp;quot; with Azure AD, Azure Functions and Static Web App logos" src="/assets/images/title-image-bf4b643f03830f5f5ad3512d581138f3.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="updated-28th-november-2022">Updated 28th November 2022<a href="#updated-28th-november-2022" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>After I posted this, <a href="https://twitter.com/thomasgauvin" target="_blank" rel="noopener noreferrer">Thomas Gauvin</a> (Product manager for Static Web Apps) was kind enough to tweet this:</p>
<p><a href="https://twitter.com/thomasgauvin/status/1596242773686079496" target="_blank" rel="noopener noreferrer"><img loading="lazy" alt="screenshot of tweet from Thomas Gauvin saying &amp;quot;Thanks for writing this @johnny_reilly, I know this is a pain point with SWA auth at the moment. I&amp;#39;m sure this article will help others in the meantime. We&amp;#39;re working on correcting our docs + looking to add support for this in the future&amp;quot;" src="/assets/images/screenshot-twitter-thomas-gauvin-support-in-future-0b27ec1d7904bd7e15c073d9065eb0e5.webp" width="2005" height="689" class="img_ev3q"></a></p>
<p>So by the sounds of it, this blog post will not be required in the longer term, as support should to be added directly. Tremendous news!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="wheres-my-claims">Where&#x27;s my claims?<a href="#wheres-my-claims" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>There is a limitation that affects authorization when you have a linked backend paired with an Azure Static Web App. Let&#x27;s take the case of having an Azure Function App as the linked backend. Essentially the Azure Function app <em>does not</em> receive the claims that the Static Web App receives. <a href="https://github.com/Azure/static-web-apps/issues/988" target="_blank" rel="noopener noreferrer">There&#x27;s an issue tracking this on GitHub</a>, and it seems that this is a general problem with Static Web Apps, Azure AD and linked backends.</p>
<p>We have a Static Web App, with an associated C# Function App (using the <a href="/bicep-static-web-apps-linked-backends">Bring Your Own Functions</a> AKA &quot;linked backend&quot; approach). Both the Static Web App and Function App are associated with the same Azure AD App Registration.</p>
<p>When we&#x27;re authenticated with Azure AD and go to the auth endpoint in our Static Web App: <code>/.auth/me</code> we see:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">&quot;clientPrincipal&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">&quot;identityProvider&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;aad&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">&quot;userId&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;d9178465-3847-4d98-9d23-b8b9e403b323&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">&quot;userDetails&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;johnny_reilly@hotmail.com&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">&quot;userRoles&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">&quot;authenticated&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;anonymous&quot;</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">&quot;claims&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token property" style="color:#f92672">&quot;typ&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;http://schemas.microsoft.com/identity/claims/objectidentifier&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token property" style="color:#f92672">&quot;val&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;d9178465-3847-4d98-9d23-b8b9e403b323&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token property" style="color:#f92672">&quot;typ&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token property" style="color:#f92672">&quot;val&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;johnny_reilly@hotmail.com&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token property" style="color:#f92672">&quot;typ&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;name&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token property" style="color:#f92672">&quot;val&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;John Reilly&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token property" style="color:#f92672">&quot;typ&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;roles&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token property" style="color:#f92672">&quot;val&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;OurApp.Read&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token property" style="color:#f92672">&quot;typ&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;ver&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token property" style="color:#f92672">&quot;val&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;2.0&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Note the claims in there. These include custom claims that we&#x27;ve configured against our Azure AD App Registration such as roles with <code>OurApp.Read</code>.</p>
<p>So we can access claims successfully in the Static Web App (the front end). However, the associated Function App does <strong>not</strong> have access to the claims.</p>
<p>It&#x27;s possible to see this by implementing a function in our Azure Function App which surfaces roles:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token attribute class-name" style="color:#e6db74">FunctionName</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">(</span><span class="token attribute attribute-arguments string" style="color:#a6e22e">&quot;GetRoles&quot;</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#e6db74">Task</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token return-type class-name" style="color:#e6db74">IActionResult</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">Run</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token attribute class-name" style="color:#e6db74">HttpTrigger</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">(</span><span class="token attribute attribute-arguments">AuthorizationLevel</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">.</span><span class="token attribute attribute-arguments">Anonymous</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">,</span><span class="token attribute attribute-arguments"> </span><span class="token attribute attribute-arguments string" style="color:#a6e22e">&quot;get&quot;</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">,</span><span class="token attribute attribute-arguments"> </span><span class="token attribute attribute-arguments string" style="color:#a6e22e">&quot;post&quot;</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">,</span><span class="token attribute attribute-arguments"> Route </span><span class="token attribute attribute-arguments operator" style="color:#66d9ef">=</span><span class="token attribute attribute-arguments"> </span><span class="token attribute attribute-arguments string" style="color:#a6e22e">&quot;GetRoles&quot;</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">HttpRequest</span><span class="token plain"> req</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> roles </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> req</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">HttpContext</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">User</span><span class="token punctuation" style="color:#f8f8f2">?.</span><span class="token plain">Claims</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">Select</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">c </span><span class="token operator" style="color:#66d9ef">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> c</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Type</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Value </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">OkObjectResult</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">roles</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When this <code>/api/GetRoles</code> endpoint is accessed we see this:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">&quot;Type&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">&quot;Value&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;d9178465-3847-4d98-9d23-b8b9e403b323&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">&quot;Type&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">&quot;Value&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;johnny_reilly@hotmail.com&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">&quot;Type&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">&quot;Value&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;authenticated&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">&quot;Type&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">&quot;Value&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;anonymous&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>At first look, this seems great; we have claims! But when we look again we realise that we have far less claims than we might have hoped for. Crucially, our custom claims / app roles like <code>OurApp.Read</code> are missing.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="maybe-theyre-hiding-in-x-ms-client-principal">Maybe they&#x27;re hiding in <code>x-ms-client-principal</code>?<a href="#maybe-theyre-hiding-in-x-ms-client-principal" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>If we look directly at the <code>x-ms-client-principal</code> header, maybe we&#x27;ll find what we need?</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token attribute class-name" style="color:#e6db74">FunctionName</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">(</span><span class="token attribute attribute-arguments string" style="color:#a6e22e">&quot;GetRoles&quot;</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#e6db74">Task</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token return-type class-name" style="color:#e6db74">IActionResult</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">GetRoles</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token attribute class-name" style="color:#e6db74">HttpTrigger</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">(</span><span class="token attribute attribute-arguments">AuthorizationLevel</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">.</span><span class="token attribute attribute-arguments">Anonymous</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">,</span><span class="token attribute attribute-arguments"> </span><span class="token attribute attribute-arguments string" style="color:#a6e22e">&quot;get&quot;</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">,</span><span class="token attribute attribute-arguments"> Route </span><span class="token attribute attribute-arguments operator" style="color:#66d9ef">=</span><span class="token attribute attribute-arguments"> </span><span class="token attribute attribute-arguments string" style="color:#a6e22e">&quot;GetRoles&quot;</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">HttpRequest</span><span class="token plain"> req</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> header </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> req</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Headers</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">&quot;x-ms-client-principal&quot;</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> data </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> header</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">FirstOrDefault</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">data </span><span class="token operator" style="color:#66d9ef">==</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">null</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">OkObjectResult</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;nothing&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> decoded </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Convert</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">FromBase64String</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> json </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Text</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ASCIIEncoding</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ASCII</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">GetString</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">decoded</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">OkObjectResult</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">json</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Alas not. We have the user&#x27;s email and some simple roles (&quot;authenticated&quot; and &quot;anonymous&quot;), but no sign of our custom claims / app roles:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">&quot;identityProvider&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;aad&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">&quot;userId&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;d9178465-3847-4d98-9d23-b8b9e403b323&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">&quot;userDetails&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;johnny_reilly@hotmail.com&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">&quot;userRoles&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">&quot;authenticated&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;anonymous&quot;</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is the problem: we want our Azure Function App to be able to make use of the same custom claims / app roles that we use for authorization in the Static Web App. How can we achieve this?</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="microsoft-graph-api">Microsoft Graph API<a href="#microsoft-graph-api" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>The answer lies with the Microsoft Graph API. We can interrogate it to get the app role assignments for the user. This will give us the same information that we have in the Static Web App. (Well to be strictly accurate, it will be a slightly different set of claims. But what matters is it will be the app role assignment claims that we want to use for authorization.)</p>
<p>We already have an Azure AD app registration. In order that we can interrogate the Microsoft Graph API, we&#x27;ll need the following permissions:</p>
<p><img loading="lazy" alt="Screenshot of the Azure AD app registration API permissions screen" src="/assets/images/screenshot-azure-portal-azure-ad-app-registration-api-permissions-2475b91d55370c463f10fc45a802996d.png" width="970" height="290" class="img_ev3q"></p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/graph/permissions-reference#delegated-permissions-85" target="_blank" rel="noopener noreferrer">User.Read</a> - to sign in</li>
<li><a href="https://learn.microsoft.com/en-us/graph/permissions-reference#application-permissions-81" target="_blank" rel="noopener noreferrer">User.Read.All</a> - for acquiring the app role assignments against a user</li>
<li><a href="https://learn.microsoft.com/en-us/graph/permissions-reference#application-permissions-4" target="_blank" rel="noopener noreferrer">Application.Read.All</a> - to get more information about the app role assignments - allowing us to translate the app role assignments into the claims that we want to use for authorization</li>
</ul>
<p>Of the above permissions, it&#x27;s likely that you&#x27;ll already have delegated <code>User.Read</code> in place; the other two you might need to add and ensure they&#x27;re granted in Azure.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="interrogating-the-microsoft-graph-api">Interrogating the Microsoft Graph API<a href="#interrogating-the-microsoft-graph-api" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>Now we have an Azure AD App Registration with sufficient permissions, we&#x27;ll need a <code>GraphClient</code> to interrogate the Microsoft Graph API. To get that we&#x27;re going to build an <code>AuthenticatedGraphClientFactory</code>:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">System</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Net</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Http</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">System</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Net</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Http</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Headers</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">System</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Threading</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Tasks</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Microsoft</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Graph</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Microsoft</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Identity</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Client</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">namespace</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">MyApp</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Auth</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">interface</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">IAuthenticatedGraphClientFactory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token return-type class-name punctuation" style="color:#f8f8f2">(</span><span class="token return-type class-name" style="color:#e6db74">GraphServiceClient</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">,</span><span class="token return-type class-name" style="color:#e6db74"> </span><span class="token return-type class-name keyword" style="color:#66d9ef">string</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">GetAuthenticatedGraphClientAndClientId</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">class</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">AuthenticatedGraphClientFactory</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token type-list class-name" style="color:#e6db74">IAuthenticatedGraphClientFactory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">private</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">GraphServiceClient</span><span class="token class-name punctuation" style="color:#f8f8f2">?</span><span class="token plain"> _graphServiceClient</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">private</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">readonly</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#66d9ef">string</span><span class="token plain"> _clientId</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">private</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">readonly</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#66d9ef">string</span><span class="token plain"> _clientSecret</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">private</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">readonly</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#66d9ef">string</span><span class="token plain"> _tenantId</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">AuthenticatedGraphClientFactory</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name keyword" style="color:#66d9ef">string</span><span class="token plain"> clientId</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name keyword" style="color:#66d9ef">string</span><span class="token plain"> clientSecret</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name keyword" style="color:#66d9ef">string</span><span class="token plain"> tenantId</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            _clientId </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> clientId</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            _clientSecret </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> clientSecret</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            _tenantId </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> tenantId</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token return-type class-name punctuation" style="color:#f8f8f2">(</span><span class="token return-type class-name" style="color:#e6db74">GraphServiceClient</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">,</span><span class="token return-type class-name" style="color:#e6db74"> </span><span class="token return-type class-name keyword" style="color:#66d9ef">string</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">GetAuthenticatedGraphClientAndClientId</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> authenticationProvider </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">CreateAuthenticationProvider</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            _graphServiceClient </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">GraphServiceClient</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">authenticationProvider</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">_graphServiceClient</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> _clientId</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">private</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#e6db74">IAuthenticationProvider</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">CreateAuthenticationProvider</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token comment" style="color:#8292a2;font-style:italic">// this specific scope means that application will default to what is defined in the application registration rather than using dynamic scopes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name keyword" style="color:#66d9ef">string</span><span class="token class-name punctuation" style="color:#f8f8f2">[</span><span class="token class-name punctuation" style="color:#f8f8f2">]</span><span class="token plain"> scopes </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name keyword" style="color:#66d9ef">string</span><span class="token constructor-invocation class-name punctuation" style="color:#f8f8f2">[</span><span class="token constructor-invocation class-name punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token string" style="color:#a6e22e">&quot;https://graph.microsoft.com/.default&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> confidentialClientApplication </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> ConfidentialClientApplicationBuilder</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">Create</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">_clientId</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">WithAuthority</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token interpolation-string string" style="color:#a6e22e">$&quot;https://login.microsoftonline.com/</span><span class="token interpolation-string interpolation punctuation" style="color:#f8f8f2">{</span><span class="token interpolation-string interpolation expression language-csharp">_tenantId</span><span class="token interpolation-string interpolation punctuation" style="color:#f8f8f2">}</span><span class="token interpolation-string string" style="color:#a6e22e">/v2.0&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">WithClientSecret</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">_clientSecret</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">Build</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">MsalAuthenticationProvider</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">confidentialClientApplication</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> scopes</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">class</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">MsalAuthenticationProvider</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token type-list class-name" style="color:#e6db74">IAuthenticationProvider</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">private</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">IConfidentialClientApplication</span><span class="token plain"> _clientApplication</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">private</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">readonly</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#66d9ef">string</span><span class="token class-name punctuation" style="color:#f8f8f2">[</span><span class="token class-name punctuation" style="color:#f8f8f2">]</span><span class="token plain"> _scopes</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">MsalAuthenticationProvider</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">IConfidentialClientApplication</span><span class="token plain"> clientApplication</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#66d9ef">string</span><span class="token class-name punctuation" style="color:#f8f8f2">[</span><span class="token class-name punctuation" style="color:#f8f8f2">]</span><span class="token plain"> scopes</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            _clientApplication </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> clientApplication</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            _scopes </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> scopes</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">/// &lt;summary&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">/// Update HttpRequestMessage with credentials</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">/// &lt;/summary&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#e6db74">Task</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">AuthenticateRequestAsync</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">HttpRequestMessage</span><span class="token plain"> request</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> token </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">await</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">GetTokenAsync</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            request</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Headers</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Authorization </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">AuthenticationHeaderValue</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;bearer&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> token</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">/// &lt;summary&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">/// Acquire Token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">/// &lt;/summary&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#e6db74">Task</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token return-type class-name keyword" style="color:#66d9ef">string</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">?</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">GetTokenAsync</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> authResult </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">await</span><span class="token plain"> _clientApplication</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">AcquireTokenForClient</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">_scopes</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">ExecuteAsync</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> authResult</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">AccessToken</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When we execute <code>GetAuthenticatedGraphClientAndClientId</code> we&#x27;ll get back a <code>GraphServiceClient</code> that we can use to interrogate the Microsoft Graph API. We&#x27;ll also get back the client ID of the Graph API App. We&#x27;ll need this later. Note that the <code>AuthenticatedGraphClientFactory</code> requires the client ID, client secret and tenant ID of the Azure AD App Registration.</p>
<p>Now we have the ability to interrogate the Microsoft Graph API, we can write a <code>PrincipalService.cs</code> class that will interrogate it and return the app role assignments for the user:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">System</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">System</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Collections</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Generic</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">System</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Linq</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">System</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Security</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Claims</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">System</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Text</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">System</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Text</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Json</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">System</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Threading</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Tasks</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Microsoft</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">AspNetCore</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Http</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Microsoft</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Extensions</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Logging</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Microsoft</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Graph</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">namespace</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">MyApp</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Auth</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">interface</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">IPrincipalService</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token return-type class-name" style="color:#e6db74">Task</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token return-type class-name" style="color:#e6db74">ClaimsPrincipal</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">GetPrincipal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">HttpRequest</span><span class="token plain"> req</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">class</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">PrincipalService</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token type-list class-name" style="color:#e6db74">IPrincipalService</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">ILogger</span><span class="token class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token class-name" style="color:#e6db74">PrincipalService</span><span class="token class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain"> _log</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">IAuthenticatedGraphClientFactory</span><span class="token plain"> _graphClientFactory</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">PrincipalService</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name" style="color:#e6db74">IAuthenticatedGraphClientFactory</span><span class="token plain"> graphClientFactory</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name" style="color:#e6db74">ILogger</span><span class="token class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token class-name" style="color:#e6db74">PrincipalService</span><span class="token class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain"> log</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            _graphClientFactory </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> graphClientFactory</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            _log </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> log</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#e6db74">Task</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token return-type class-name" style="color:#e6db74">ClaimsPrincipal</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">GetPrincipal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">HttpRequest</span><span class="token plain"> req</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">try</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token class-name" style="color:#e6db74">MsClientPrincipal</span><span class="token class-name punctuation" style="color:#f8f8f2">?</span><span class="token plain"> principal </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">MakeMsClientPrincipal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">principal </span><span class="token operator" style="color:#66d9ef">==</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">null</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                    </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">ClaimsPrincipal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#66d9ef">!</span><span class="token plain">principal</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">UserRoles</span><span class="token punctuation" style="color:#f8f8f2">?.</span><span class="token function" style="color:#e6db74">Where</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">NotAnonymous</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">Any</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">??</span><span class="token plain"> </span><span class="token boolean" style="color:#ae81ff">true</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                    </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">ClaimsPrincipal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token class-name" style="color:#e6db74">ClaimsIdentity</span><span class="token plain"> identity </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">await</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">MakeClaimsIdentity</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">principal</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">ClaimsPrincipal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">identity</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                _log</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">LogError</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;Error parsing claims principal&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">ClaimsPrincipal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token return-type class-name" style="color:#e6db74">MsClientPrincipal</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">?</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">MakeMsClientPrincipal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">HttpRequest</span><span class="token plain"> req</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name" style="color:#e6db74">MsClientPrincipal</span><span class="token class-name punctuation" style="color:#f8f8f2">?</span><span class="token plain"> principal </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">null</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Headers</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">TryGetValue</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;x-ms-client-principal&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">out</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> header</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> data </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> header</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">FirstOrDefault</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">data </span><span class="token operator" style="color:#66d9ef">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">null</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                    </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> decoded </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> Convert</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">FromBase64String</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                    </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> json </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> Encoding</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">UTF8</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">GetString</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">decoded</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                    _log</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">LogInformation</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token interpolation-string string" style="color:#a6e22e">$&quot;x-ms-client-principal: </span><span class="token interpolation-string interpolation punctuation" style="color:#f8f8f2">{</span><span class="token interpolation-string interpolation expression language-csharp">json</span><span class="token interpolation-string interpolation punctuation" style="color:#f8f8f2">}</span><span class="token interpolation-string string" style="color:#a6e22e">&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                    principal </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> JsonSerializer</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token generic-method function" style="color:#e6db74">Deserialize</span><span class="token generic-method generic class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token generic-method generic class-name" style="color:#e6db74">MsClientPrincipal</span><span class="token generic-method generic class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">json</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">JsonSerializerOptions</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> PropertyNameCaseInsensitive </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token boolean" style="color:#ae81ff">true</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> principal</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#e6db74">Task</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token return-type class-name" style="color:#e6db74">ClaimsIdentity</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">MakeClaimsIdentity</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">MsClientPrincipal</span><span class="token plain"> principal</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> identity </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">ClaimsIdentity</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">principal</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">IdentityProvider</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            identity</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">AddClaim</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">Claim</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">ClaimTypes</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">NameIdentifier</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> principal</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">UserId</span><span class="token operator" style="color:#66d9ef">!</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            identity</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">AddClaim</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">Claim</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">ClaimTypes</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> principal</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">UserDetails</span><span class="token operator" style="color:#66d9ef">!</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">principal</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">UserRoles </span><span class="token operator" style="color:#66d9ef">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">null</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                identity</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">AddClaims</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">principal</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">UserRoles</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                    </span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">Where</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">NotAnonymous</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                    </span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">Select</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">userRole </span><span class="token operator" style="color:#66d9ef">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">Claim</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">ClaimTypes</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Role</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> userRole</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> username </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> principal</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">UserDetails</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">username </span><span class="token operator" style="color:#66d9ef">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">null</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> userAppRoleAssignments </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">await</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">GetUserAppRoleAssignments</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">username</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                identity</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">AddClaims</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">userAppRoleAssignments</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                    </span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">Select</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">userAppRoleAssignments </span><span class="token operator" style="color:#66d9ef">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">Claim</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">ClaimTypes</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Role</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> userAppRoleAssignments</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> identity</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#66d9ef">bool</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">NotAnonymous</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name keyword" style="color:#66d9ef">string</span><span class="token plain"> r</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token operator" style="color:#66d9ef">!</span><span class="token keyword" style="color:#66d9ef">string</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">Equals</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">r</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;anonymous&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> StringComparison</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">CurrentCultureIgnoreCase</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#e6db74">Task</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token return-type class-name keyword" style="color:#66d9ef">string</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">[</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">]</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">GetUserAppRoleAssignments</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name keyword" style="color:#66d9ef">string</span><span class="token plain"> username</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">try</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token keyword" style="color:#66d9ef">var</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">graphClient</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> clientId</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> _graphClientFactory</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">GetAuthenticatedGraphClientAndClientId</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                _log</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">LogInformation</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;Getting AppRoleAssignments for {username}&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> username</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> userRoleAssignments </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">await</span><span class="token plain"> graphClient</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Users</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">username</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                    </span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">AppRoleAssignments</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                    </span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">Request</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                    </span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">GetAsync</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> roleIds </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">List</span><span class="token constructor-invocation class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token constructor-invocation class-name keyword" style="color:#66d9ef">string</span><span class="token constructor-invocation class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> pageIterator </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> PageIterator</span><span class="token operator" style="color:#66d9ef">&lt;</span><span class="token plain">AppRoleAssignment</span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                    </span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">CreatePageIterator</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                        graphClient</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                        userRoleAssignments</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                        </span><span class="token comment" style="color:#8292a2;font-style:italic">// Callback executed for each item in the collection</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                        </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">appRoleAssignment</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                        </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                            </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">appRoleAssignment</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">AppRoleId</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">HasValue </span><span class="token operator" style="color:#66d9ef">&amp;&amp;</span><span class="token plain"> appRoleAssignment</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">AppRoleId</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Value </span><span class="token operator" style="color:#66d9ef">!=</span><span class="token plain"> Guid</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Empty</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                                roleIds</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">Add</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">appRoleAssignment</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">AppRoleId</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">ToString</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                            </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token boolean" style="color:#ae81ff">true</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                        </span><span class="token comment" style="color:#8292a2;font-style:italic">// Used to configure subsequent page requests</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                        </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">baseRequest</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                        </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                            </span><span class="token comment" style="color:#8292a2;font-style:italic">// Re-add the header to subsequent requests</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                            baseRequest</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">Header</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;Prefer&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;outlook.body-content-type=\&quot;text\&quot;&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                            </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> baseRequest</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token keyword" style="color:#66d9ef">await</span><span class="token plain"> pageIterator</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">IterateAsync</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> applications </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">await</span><span class="token plain"> graphClient</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Applications</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                    </span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">Request</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                    </span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">Filter</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token interpolation-string string" style="color:#a6e22e">$&quot;appId eq &#x27;</span><span class="token interpolation-string interpolation punctuation" style="color:#f8f8f2">{</span><span class="token interpolation-string interpolation expression language-csharp">clientId</span><span class="token interpolation-string interpolation punctuation" style="color:#f8f8f2">}</span><span class="token interpolation-string string" style="color:#a6e22e">&#x27;&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// we&#x27;re only interested in the app that we&#x27;re running as</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                    </span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">GetAsync</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> appRoleAssignments </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> applications</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                    </span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">FirstOrDefault</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                    </span><span class="token punctuation" style="color:#f8f8f2">?.</span><span class="token plain">AppRoles</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                    </span><span class="token punctuation" style="color:#f8f8f2">?.</span><span class="token function" style="color:#e6db74">Where</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">appRole </span><span class="token operator" style="color:#66d9ef">=&gt;</span><span class="token plain"> appRole</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Id</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">HasValue </span><span class="token operator" style="color:#66d9ef">&amp;&amp;</span><span class="token plain"> roleIds</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">Contains</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">appRole</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Id</span><span class="token operator" style="color:#66d9ef">!</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">ToString</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                    </span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">Select</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">appRole </span><span class="token operator" style="color:#66d9ef">=&gt;</span><span class="token plain"> appRole</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                    </span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">ToArray</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> appRoleAssignments </span><span class="token operator" style="color:#66d9ef">??</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token generic-method function" style="color:#e6db74">Empty</span><span class="token generic-method generic class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token generic-method generic class-name keyword" style="color:#66d9ef">string</span><span class="token generic-method generic class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                _log</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">LogError</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;Error getting AppRoleAssignments&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token generic-method function" style="color:#e6db74">Empty</span><span class="token generic-method generic class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token generic-method generic class-name keyword" style="color:#66d9ef">string</span><span class="token generic-method generic class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">class</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">MsClientPrincipal</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#66d9ef">string</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">?</span><span class="token plain"> IdentityProvider </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">get</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">set</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#66d9ef">string</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">?</span><span class="token plain"> UserId </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">get</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">set</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#66d9ef">string</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">?</span><span class="token plain"> UserDetails </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">get</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">set</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#e6db74">IEnumerable</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token return-type class-name keyword" style="color:#66d9ef">string</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">?</span><span class="token plain"> UserRoles </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">get</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">set</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Quite a lot of code! Let&#x27;s walk through what it does:</p>
<ol>
<li>It takes the <code>x-ms-client-principal</code> header and deserializes it into a <code>MsClientPrincipal</code> object - this is the cut down version of the <code>ClaimsPrincipal</code> object that we saw earlier:</li>
</ol>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">&quot;identityProvider&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;aad&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">&quot;userId&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;d9178465-3847-4d98-9d23-b8b9e403b323&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">&quot;userDetails&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;johnny_reilly@hotmail.com&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">&quot;userRoles&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">&quot;authenticated&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;anonymous&quot;</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="2">
<li>
<p>It creates a new <code>ClaimsIdentity</code> using that information, but stripping out the <code>anonymous</code> role as it&#x27;s superfluous.</p>
</li>
<li>
<p>Using the <code>userDetails</code> (email address) from the <code>MsClientPrincipal</code> object, it gets the app role assignments for that user from the Graph API. (We needed <code>User.Read.All</code> to do this.)</p>
</li>
<li>
<p>In a perfect world, we&#x27;d be able to use the <code>AppRoleAssignments</code> property on the <code>User</code> object to get the app role assignments for a user, but unfortunately that doesn&#x27;t come with the human readable name you&#x27;d hope for; the <code>MyApp.Read</code>. So we have to interrogate the Graph API once more and use the <code>Application</code> that represents our Azure AD App Registration (we acquire this by filtering for an <code>appId</code> matching our <code>clientId</code>). Then we can get the human readable / <code>MyApp.Read</code> role assignment.</p>
</li>
<li>
<p>It adds the app role assignments as role claims to the <code>ClaimsIdentity</code> object.</p>
</li>
<li>
<p>It returns the <code>ClaimsIdentity</code> object wrapped in a <code>ClaimsPrincipal</code> object.</p>
</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-the-principalservice">Using the <code>PrincipalService</code><a href="#using-the-principalservice" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>In order that we can make use of our <code>PrincipalService</code> we need to configure it and the <code>AuthenticatedGraphClientFactory</code> in our <code>Startup</code> class:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">services</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token generic-method function" style="color:#e6db74">AddTransient</span><span class="token generic-method generic class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token generic-method generic class-name" style="color:#e6db74">IAuthenticatedGraphClientFactory</span><span class="token generic-method generic class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">sp </span><span class="token operator" style="color:#66d9ef">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">AuthenticatedGraphClientFactory</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">// The parameters can be sourced from the Azure AD App Registration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        clientId</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        clientSecret</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        tenantId</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">services</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token generic-method function" style="color:#e6db74">AddTransient</span><span class="token generic-method generic class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token generic-method generic class-name" style="color:#e6db74">IPrincipalService</span><span class="token generic-method generic class-name punctuation" style="color:#f8f8f2">,</span><span class="token generic-method generic class-name" style="color:#e6db74"> PrincipalService</span><span class="token generic-method generic class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With that in place, we can now use the <code>IPrincipalService</code> in a function:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">System</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Linq</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">System</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Threading</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Tasks</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">MyApp</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Auth</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Microsoft</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">AspNetCore</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Http</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Microsoft</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">AspNetCore</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Mvc</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Microsoft</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Azure</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">WebJobs</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Microsoft</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Azure</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">WebJobs</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Extensions</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Http</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">namespace</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">MyApp</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Functions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">class</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">GetClaimsPrincipalFunction</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">private</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">IPrincipalService</span><span class="token plain"> _principalService</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">GetClaimsPrincipalFunction</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name" style="color:#e6db74">IPrincipalService</span><span class="token plain"> principalService</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            _principalService </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> principalService</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token attribute class-name" style="color:#e6db74">FunctionName</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">(</span><span class="token attribute attribute-arguments keyword" style="color:#66d9ef">nameof</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">(</span><span class="token attribute attribute-arguments">GetPrincipal</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">)</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#e6db74">Task</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token return-type class-name" style="color:#e6db74">IActionResult</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">GetPrincipal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token attribute class-name" style="color:#e6db74">HttpTrigger</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">(</span><span class="token attribute attribute-arguments">AuthorizationLevel</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">.</span><span class="token attribute attribute-arguments">Anonymous</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">,</span><span class="token attribute attribute-arguments"> </span><span class="token attribute attribute-arguments string" style="color:#a6e22e">&quot;get&quot;</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">,</span><span class="token attribute attribute-arguments"> Route </span><span class="token attribute attribute-arguments operator" style="color:#66d9ef">=</span><span class="token attribute attribute-arguments"> </span><span class="token attribute attribute-arguments string" style="color:#a6e22e">&quot;get-principal&quot;</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">HttpRequest</span><span class="token plain"> request</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> principal </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">await</span><span class="token plain"> _principalService</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">GetPrincipal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> identity </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> principal</span><span class="token punctuation" style="color:#f8f8f2">?.</span><span class="token plain">Identity</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> data </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                Name </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> identity</span><span class="token punctuation" style="color:#f8f8f2">?.</span><span class="token plain">Name </span><span class="token operator" style="color:#66d9ef">??</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                AuthenticationType </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> identity</span><span class="token punctuation" style="color:#f8f8f2">?.</span><span class="token plain">AuthenticationType </span><span class="token operator" style="color:#66d9ef">??</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                Claims </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> principal</span><span class="token punctuation" style="color:#f8f8f2">?.</span><span class="token plain">Claims</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">Select</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">c </span><span class="token operator" style="color:#66d9ef">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> c</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Type</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Value </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">OkObjectResult</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token attribute class-name" style="color:#e6db74">FunctionName</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">(</span><span class="token attribute attribute-arguments keyword" style="color:#66d9ef">nameof</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">(</span><span class="token attribute attribute-arguments">AmIInRole</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">)</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#e6db74">Task</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token return-type class-name" style="color:#e6db74">IActionResult</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">AmIInRole</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token attribute class-name" style="color:#e6db74">HttpTrigger</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">(</span><span class="token attribute attribute-arguments">AuthorizationLevel</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">.</span><span class="token attribute attribute-arguments">Anonymous</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">,</span><span class="token attribute attribute-arguments"> </span><span class="token attribute attribute-arguments string" style="color:#a6e22e">&quot;get&quot;</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">,</span><span class="token attribute attribute-arguments"> Route </span><span class="token attribute attribute-arguments operator" style="color:#66d9ef">=</span><span class="token attribute attribute-arguments"> </span><span class="token attribute attribute-arguments string" style="color:#a6e22e">&quot;am-i-in-role&quot;</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">HttpRequest</span><span class="token plain"> request</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> role </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> request</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Query</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">&quot;role&quot;</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">FirstOrDefault</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">string</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">IsNullOrEmpty</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">role</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">BadRequestObjectResult</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;role query parameter is required&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> principal </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">await</span><span class="token plain"> _principalService</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">GetPrincipal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> isInRole </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> principal</span><span class="token punctuation" style="color:#f8f8f2">?.</span><span class="token function" style="color:#e6db74">IsInRole</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">role</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">==</span><span class="token plain"> </span><span class="token boolean" style="color:#ae81ff">true</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#66d9ef">!</span><span class="token plain">isInRole</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">ObjectResult</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token interpolation-string string" style="color:#a6e22e">$&quot;Forbidden for </span><span class="token interpolation-string interpolation punctuation" style="color:#f8f8f2">{</span><span class="token interpolation-string interpolation expression language-csharp">role</span><span class="token interpolation-string interpolation punctuation" style="color:#f8f8f2">}</span><span class="token interpolation-string string" style="color:#a6e22e">&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                    StatusCode </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> Status403Forbidden</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">OkObjectResult</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token interpolation-string string" style="color:#a6e22e">$&quot;Welcome </span><span class="token interpolation-string interpolation punctuation" style="color:#f8f8f2">{</span><span class="token interpolation-string interpolation expression language-csharp">principal</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:#f8f8f2">?.</span><span class="token interpolation-string interpolation expression language-csharp">Identity</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:#f8f8f2">?.</span><span class="token interpolation-string interpolation expression language-csharp">Name</span><span class="token interpolation-string interpolation punctuation" style="color:#f8f8f2">}</span><span class="token interpolation-string string" style="color:#a6e22e"> - you have role </span><span class="token interpolation-string interpolation punctuation" style="color:#f8f8f2">{</span><span class="token interpolation-string interpolation expression language-csharp">role</span><span class="token interpolation-string interpolation punctuation" style="color:#f8f8f2">}</span><span class="token interpolation-string string" style="color:#a6e22e">!&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The above class has 2 functions:</p>
<ul>
<li><code>GetPrincipal</code> - returns the <code>ClaimsPrincipal</code> object as JSON</li>
<li><code>AmIInRole</code> - takes a <code>role</code> query parameter, tests if a user has that role and returns a 403 if they don&#x27;t and a 200 with a welcome message if they do</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="getprincipal---what-claims-do-we-have"><code>GetPrincipal</code> - what claims do we have?<a href="#getprincipal---what-claims-do-we-have" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>Let&#x27;s try out the <code>GetPrincipal</code> function, when I go to the <code>/api/get-principal</code> endpoint I see this:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">&quot;name&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;johnny_reilly@hotmail.com&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">&quot;authenticationType&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;aad&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">&quot;claims&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">&quot;type&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">&quot;value&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;d9178465-3847-4d98-9d23-b8b9e403b323&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">&quot;type&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">&quot;value&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;johnny_reilly@hotmail.com&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">&quot;type&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">&quot;value&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;authenticated&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">&quot;type&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">&quot;value&quot;</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;OurApp.Read&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This isn&#x27;t the <em>same</em> information as the Static Web Apps principal, but it&#x27;s close enough for our purposes. Crucially, we can see the AppRoleAssignment <code>OurApp.Read</code> that we assigned to our user in the Azure Portal. That is the key information that we need, and that we are missing by default.</p>
<p>Crucially this is enough information for us to be able to apply authorization to our functions.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="amiinrole---test-isinrole-functionality"><code>AmIInRole</code> - test <code>IsInRole</code> functionality<a href="#amiinrole---test-isinrole-functionality" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>We can demonstrate applying authorization by using the <code>AmIInRole</code> function. This internally uses the inbuilt <a href="https://learn.microsoft.com/en-us/dotnet/api/system.security.claims.claimsprincipal.isinrole?view=net-6.0" target="_blank" rel="noopener noreferrer"><code>IsInRole</code></a> functionality of the <code>ClaimsPrincipal</code> object, and returns an appropriate API result accordingly.</p>
<p>If I go to the <code>/api/am-i-in-role?role=OurApp.Read</code> endpoint I get a 200 status code and the message: <code>Welcome johnny_reilly@hotmail.com - you have role OurApp.Read!</code>. This makes sense, my user account has the <code>OurApp.Read</code> role.</p>
<p>Let&#x27;s test that we also deny access appropriately. There is an <code>OurApp.Write</code> role; my account does not have this. If I go to the <code>/api/am-i-in-role?role=OurApp.Write</code> endpoint I get a 403 status code and the message: <code>Forbidden for OurApp.Write</code>.</p>
<p>It works!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>We&#x27;ve demonstrated a way to acquire a <code>ClaimsPrincipal</code> object that contains the AppRoleAssignments for a user. This is enough information for us to be able to apply authorization to our functions.</p>
<p>It would be ideal if this wasn&#x27;t required, and I&#x27;m hoping that the Static Web Apps team will be able to provide a solution for this in the future. <a href="https://github.com/Azure/static-web-apps/issues/988" target="_blank" rel="noopener noreferrer">Keep an eye on this GitHub issue.</a> In the meantime, this is a workable solution.</p>
<p>Thanks to <a href="https://github.com/warrenandre" target="_blank" rel="noopener noreferrer">Warren Joubert</a> for his help with this post.</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/auth">auth</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/azure-functions">azure functions</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/azure-static-web-apps">azure static web apps</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/azure">azure</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2022-11-17-azure-ad-claims-static-web-apps-azure-functions/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/xml-read-and-write-with-node-js"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">XML: read and write with Node.js</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/debugging-azure-functions-vs-code-mac-os"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Debugging Azure Functions in VS Code on Mac OS</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#updated-28th-november-2022" class="table-of-contents__link toc-highlight">Updated 28th November 2022</a></li><li><a href="#wheres-my-claims" class="table-of-contents__link toc-highlight">Where&#39;s my claims?</a></li><li><a href="#maybe-theyre-hiding-in-x-ms-client-principal" class="table-of-contents__link toc-highlight">Maybe they&#39;re hiding in <code>x-ms-client-principal</code>?</a></li><li><a href="#microsoft-graph-api" class="table-of-contents__link toc-highlight">Microsoft Graph API</a></li><li><a href="#interrogating-the-microsoft-graph-api" class="table-of-contents__link toc-highlight">Interrogating the Microsoft Graph API</a></li><li><a href="#using-the-principalservice" class="table-of-contents__link toc-highlight">Using the <code>PrincipalService</code></a><ul><li><a href="#getprincipal---what-claims-do-we-have" class="table-of-contents__link toc-highlight"><code>GetPrincipal</code> - what claims do we have?</a></li><li><a href="#amiinrole---test-isinrole-functionality" class="table-of-contents__link toc-highlight"><code>AmIInRole</code> - test <code>IsInRole</code> functionality</a></li></ul></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title"></div><ul class="footer__items clean-list"><li class="footer__item"><div class="footer__title"><a href="/tags/typescript" class="footer__link-item">TypeScript<img src="/img/ts-logo-128.svg" alt="TypeScript icon" class="footer__icon"></a></div>
<ul class="footer__items clean-list">
  <li class="footer__item"><a href="/typescript-vs-jsdoc-javascript" class="footer__link-item">TypeScript vs JSDoc JavaScript</a></li><li class="footer__item"><a href="/type-annotations-strong-types-weakly-held" class="footer__link-item">Type annotations proposal: strong types, weakly held</a></li>
</ul><div class="footer__title"><a href="/tags/azure" class="footer__link-item">Azure<img src="/img/azure-logo.svg" alt="Azure icon" class="footer__icon"></a></div>
<ul class="footer__items clean-list">
  <li class="footer__item"><a href="/azure-container-apps-easy-auth-and-dotnet-authentication" class="footer__link-item">Azure Container Apps: Easy Auth and .NET</a></li><li class="footer__item"><a href="/azure-static-web-apps-dynamic-redirects-azure-functions" class="footer__link-item">Azure Static Web Apps: dynamic redirects with Azure Functions</a></li>
</ul><div class="footer__title"><a href="/tags/asp-net" class="footer__link-item">ASP.NET<img src="/img/dotnet-logo.svg" alt="ASP.NET icon" class="footer__icon"></a></div>
<ul class="footer__items clean-list">
  <li class="footer__item"><a href="/eslint-your-csharp-in-vs-code-with-roslyn-analyzers" class="footer__link-item">ESLint your C# with Roslyn Analyzers</a></li><li class="footer__item"><a href="/aspnet-serilog-and-application-insights" class="footer__link-item">ASP.NET, Serilog and Application Insights</a></li>
</ul><div class="footer__title"><a href="/tags/react" class="footer__link-item">React<img src="/img/react-logo.svg" alt="React icon" class="footer__icon"></a></div>
<ul class="footer__items clean-list">
  <li class="footer__item"><a href="/structured-data-seo-and-react" class="footer__link-item">Structured data and React</a></li><li class="footer__item"><a href="/react-usesearchparamsstate" class="footer__link-item">React: storing state in URL with URLSearchParams</a></li>
</ul></li></ul></div><div class="col footer__col"><div class="footer__title"></div><ul class="footer__items clean-list"><li class="footer__item"><div class="footer__title">Notable articles</div>
<ul class="footer__items clean-list">
  <li class="footer__item"><a href="/definitely-typed-the-movie" class="footer__link-item">The history of Definitely Typed<img src="/img/definitely-typed-logo.png" alt="The history of Definitely Typed icon" class="footer__icon"></a></li><li class="footer__item"><a href="/typescript-documentary" class="footer__link-item">TypeScript: the documentary<img src="/img/ts-logo-128.svg" alt="TypeScript: the documentary icon" class="footer__icon"></a></li><li class="footer__item"><a href="/definitive-guide-to-migrating-from-blogger-to-docusaurus" class="footer__link-item">The definitive guide to migrating from Blogger to Docusaurus<img src="/img/docusaurus-logo.svg" alt="The definitive guide to migrating from Blogger to Docusaurus icon" class="footer__icon"></a></li><li class="footer__item"><a href="/how-we-fixed-my-seo" class="footer__link-item">How we fixed my SEO</a></li>
</ul><div class="footer__title">Popular articles</div>
<ul class="footer__items clean-list">
  <li class="footer__item"><a href="/aspnet-serilog-and-application-insights" class="footer__link-item">ASP.NET, Serilog and Application Insights</a></li><li class="footer__item"><a href="/eslint-your-csharp-in-vs-code-with-roslyn-analyzers" class="footer__link-item">ESLint your C# with Roslyn Analyzers</a></li><li class="footer__item"><a href="/prettier-your-csharp-with-dotnet-format-and-lint-staged" class="footer__link-item">dotnet-format: Prettier your C# with lint-staged & husky</a></li>
</ul><div class="footer__title">Recently updated</div>
<ul class="footer__items clean-list">
  <li class="footer__item"><a href="migrating-azure-functions-node-js-v4-typescript" class="footer__link-item">Migrating to v4 Azure Functions Node.js with TypeScript</a></li><li class="footer__item"><a href="how-i-ruined-my-seo" class="footer__link-item">How I ruined my SEO</a></li><li class="footer__item"><a href="snapshot-log-tests-dotnet" class="footer__link-item">Snapshot log tests in .NET</a></li>
</ul></li></ul></div><div class="col footer__col"><div class="footer__title">Learn more / support me</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/johnnyreilly/blog.johnnyreilly.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog source code on GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/tags">Blog categories</a></li><li class="footer__item"><a href="https://johnnyreilly.com/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item">RSS feed<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://johnnyreilly.com/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item">Atom feed<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/privacy-policy">Privacy Policy</a></li><li class="footer__item"><iframe src="https://github.com/sponsors/johnnyreilly/card" title="Sponsor johnnyreilly" style="margin-top: 20px; border: 0; border-radius: 10px; background-color: white; min-height: 400px;"></iframe></li><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" rel="noopener" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" loading="lazy" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2012 - 2024 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>