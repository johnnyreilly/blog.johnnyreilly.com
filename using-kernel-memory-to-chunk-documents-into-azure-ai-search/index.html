<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Using Kernel Memory to Chunk Documents into Azure AI Search | johnnyreilly</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://johnnyreilly.com/using-kernel-memory-to-chunk-documents-into-azure-ai-search"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="robots" content="max-image-preview:large"><meta data-rh="true" name="monetization" content="$ilp.uphold.com/LwQQhXdpwxeJ"><meta data-rh="true" property="og:title" content="Using Kernel Memory to Chunk Documents into Azure AI Search | johnnyreilly"><meta data-rh="true" name="description" content="To build RAG (Retrieval Augmented Generation) experiences, where LLMs can query documents, you need a strategy to chunk those documents. Kernel Memory supports this."><meta data-rh="true" property="og:description" content="To build RAG (Retrieval Augmented Generation) experiences, where LLMs can query documents, you need a strategy to chunk those documents. Kernel Memory supports this."><meta data-rh="true" property="og:image" content="https://johnnyreilly.com/assets/images/title-image-337c58e5e55f92f59a1d1db49366ec04.png"><meta data-rh="true" name="twitter:image" content="https://johnnyreilly.com/assets/images/title-image-337c58e5e55f92f59a1d1db49366ec04.png"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-04-21T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://johnnyreilly.com/about"><meta data-rh="true" property="article:tag" content="Azure,C#,ASP.NET,AI"><link data-rh="true" rel="icon" href="/favicon.ico"><link data-rh="true" rel="canonical" href="https://johnnyreilly.com/using-kernel-memory-to-chunk-documents-into-azure-ai-search"><link data-rh="true" rel="alternate" href="https://johnnyreilly.com/using-kernel-memory-to-chunk-documents-into-azure-ai-search" hreflang="en"><link data-rh="true" rel="alternate" href="https://johnnyreilly.com/using-kernel-memory-to-chunk-documents-into-azure-ai-search" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://J3MYR1INLT-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://johnnyreilly.com/using-kernel-memory-to-chunk-documents-into-azure-ai-search","mainEntityOfPage":"https://johnnyreilly.com/using-kernel-memory-to-chunk-documents-into-azure-ai-search","url":"https://johnnyreilly.com/using-kernel-memory-to-chunk-documents-into-azure-ai-search","headline":"Using Kernel Memory to Chunk Documents into Azure AI Search","name":"Using Kernel Memory to Chunk Documents into Azure AI Search","description":"To build RAG (Retrieval Augmented Generation) experiences, where LLMs can query documents, you need a strategy to chunk those documents. Kernel Memory supports this.","datePublished":"2024-04-21T00:00:00.000Z","author":{"@type":"Person","name":"John Reilly","description":"OSS Engineer - TypeScript, Azure, React, Node.js, .NET","url":"https://johnnyreilly.com/about","image":"https://johnnyreilly.com/img/profile-2025.jpg"},"image":{"@type":"ImageObject","@id":"https://johnnyreilly.com/assets/images/title-image-337c58e5e55f92f59a1d1db49366ec04.png","url":"https://johnnyreilly.com/assets/images/title-image-337c58e5e55f92f59a1d1db49366ec04.png","contentUrl":"https://johnnyreilly.com/assets/images/title-image-337c58e5e55f92f59a1d1db49366ec04.png","caption":"title image for the blog post: Using Kernel Memory to Chunk Documents into Azure AI Search"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://johnnyreilly.com/","name":"I CAN MAKE THIS WORK"}}</script><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="johnnyreilly" href="/opensearch.xml">

<link rel="icon" href="/img/profile-2025-64x64.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#cf6d1e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">

<link rel="preload" href="https://johnnyreilly.com/fonts/Poppins-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://johnnyreilly.com/fonts/Poppins-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preconnect" href="https://res.cloudinary.com">
<link rel="monetization" href="https://ilp.uphold.com/LwQQhXdpwxeJ">
<script type="application/ld+json">{"@context":"https://schema.org","@graph":[{"@id":"https://johnnyreilly.com","@type":"WebSite","url":"https://johnnyreilly.com","name":"johnnyreilly","description":"This is John Reilly's blog. John is an Open Source Software Engineer working on TypeScript, Azure, React, Node.js, .NET and more.","copyrightHolder":{"@id":"https://johnnyreilly.com/about"},"publisher":{"@id":"https://johnnyreilly.com/about"},"potentialAction":{"@type":"SearchAction","target":{"@type":"EntryPoint","urlTemplate":"https://johnnyreilly.com/search?q={search_term_string}"},"query-input":"required name=search_term_string"},"inLanguage":"en-UK"},{"@id":"https://johnnyreilly.com/about","@type":"Person","name":"John Reilly","alternateName":"Johnny Reilly","image":{"@type":"ImageObject","inLanguage":"en-UK","@id":"https://johnnyreilly.com/about#image","url":"https://johnnyreilly.com/img/profile-2025.jpg","contentUrl":"https://johnnyreilly.com/img/profile-2025.jpg","width":200,"height":200,"caption":"John Reilly"},"description":"John is an Open Source Software Engineer working on TypeScript, Azure, React, Node.js, .NET and more. As well as writing code, John is a speaker at meetups, one of the founders of the TS Congress conference, and the author of the history of Definitely Typed, which he worked on in the early days of TypeScript.","url":"https://johnnyreilly.com","address":{"@type":"PostalAddress","streetAddress":"Twickenham","addressLocality":"London","addressCountry":"United Kingdom"},"email":"johnny_reilly@hotmail.com","birthPlace":"Bristol","sameAs":["https://github.com/johnnyreilly","https://fosstodon.org/@johnny_reilly","https://twitter.com/johnny_reilly","https://bsky.app/profile/johnnyreilly.com","https://dev.to/johnnyreilly","https://app.daily.dev/johnnyreilly","https://stackoverflow.com/users/761388/john-reilly","https://blog.logrocket.com/author/johnreilly/","https://www.reddit.com/user/johnny_reilly","https://uk.linkedin.com/in/johnnyreilly"]},{"@id":"https://johnnyreilly.com/about#organization","@type":["Organization","Brand"],"url":"https://johnnyreilly.com","name":"johnnyreilly","description":"This is John Reilly's blog. John is an Open Source Software Engineer working on TypeScript, Azure, React, Node.js, .NET and more.","logo":{"@type":"ImageObject","inLanguage":"en-UK","@id":"https://johnnyreilly.com/#logo","url":"https://johnnyreilly.com/img/profile-2025.jpg","contentUrl":"https://johnnyreilly.com/img/profile-2025.jpg","width":200,"height":200,"caption":"John Reilly"},"image":{"@id":"https://johnnyreilly.com/#logo"},"sameAs":["https://github.com/johnnyreilly","https://fosstodon.org/@johnny_reilly","https://twitter.com/johnny_reilly","https://bsky.app/profile/johnnyreilly.com","https://dev.to/johnnyreilly","https://app.daily.dev/johnnyreilly","https://stackoverflow.com/users/761388/john-reilly","https://blog.logrocket.com/author/johnreilly/","https://www.reddit.com/user/johnny_reilly","https://uk.linkedin.com/in/johnnyreilly"]}]}</script>
<link rel="webmention" href="https://webmention.io/johnnyreilly.com/webmention"><link rel="stylesheet" href="/assets/css/styles.a5745732.css">
<script src="/assets/js/runtime~main.cbb8c742.js" defer="defer"></script>
<script src="/assets/js/main.13df2de9.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/profile-2025-64x64.jpg"><link rel="preload" as="image" href="https://johnnyreilly.com/img/profile-2025.jpg"><link rel="preload" as="image" href="/assets/images/title-image-337c58e5e55f92f59a1d1db49366ec04.png"><script type="application/ld+json">[{"@context":"https://schema.org","@type":"BreadcrumbList","@id":"/using-kernel-memory-to-chunk-documents-into-azure-ai-search#breadcrumb","name":"Blog breadcrumb","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https://johnnyreilly.com"},{"@type":"ListItem","position":2,"name":"Blog","item":"https://johnnyreilly.com/blog"},{"@type":"ListItem","position":3,"name":"Using Kernel Memory to Chunk Documents into Azure AI Search"}]}]</script><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile-2025-64x64.jpg" alt="Profile picture of John Reilly" class="themedComponent_mlkZ themedComponent--light_NVdE" height="32" width="32"><img src="/img/profile-2025-64x64.jpg" alt="Profile picture of John Reilly" class="themedComponent_mlkZ themedComponent--dark_xIcU" height="32" width="32"></div><b class="navbar__title text--truncate">John Reilly</b></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/talks">Talks</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/johnnyreilly" target="_blank" rel="me" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><a href="https://bsky.app/profile/johnnyreilly.com" target="_blank" rel="me" class="navbar__item navbar__link">Bluesky<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><a href="https://fosstodon.org/@johnny_reilly" target="_blank" rel="me" class="navbar__item navbar__link">Mastodon<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="me" class="navbar__item navbar__link">Twitter<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/keeping-front-end-and-back-end-in-sync-with-nswag-generated-clients">Keeping front end and back end in sync with NSwag generated clients</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure-devops-pull-requests-conventional-commits">Azure DevOps: merging pull requests with conventional commits</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure-devops-api-pull-requests-merge-set-autocomplete">Azure DevOps: merging pull requests and setting autocomplete with the API</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure-devops-with-defaultazurecredential">Azure DevOps: using DefaultAzureCredential in an Azure Pipeline with AzureCLI@2</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure-devops-pull-requests-dynamic-required-reviewers">Azure DevOps: pull requests and dynamic required reviewers</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/typescript-go-pragmatic-choice">TypeScript is going Go: Why it’s the pragmatic choice</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/microsoft-graphclient-filter-endswith-consistencylevel-eventual-header">Microsoft Graph client: how to filter by endswith</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/list-pipelines-with-azure-devops-api">List Pipelines with the Azure DevOps API</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">Using Kernel Memory to Chunk Documents into Azure AI Search</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-04-21T00:00:00.000Z">April 21, 2024</time> · <!-- -->17 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://johnnyreilly.com/about" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://johnnyreilly.com/img/profile-2025.jpg" alt="John Reilly"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://johnnyreilly.com/about" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">John Reilly</span></a></div><small class="authorTitle_nd0D" title="OSS Engineer - TypeScript, Azure, React, Node.js, .NET">OSS Engineer - TypeScript, Azure, React, Node.js, .NET</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>I&#x27;ve recently been working on building retrieval augmented generation (RAG) experiences into applications; building systems where large language models (LLMs) can query documents. To achieve this, we first need a strategy to chunk those documents and make them LLM-friendly. <a href="https://github.com/microsoft/kernel-memory" target="_blank" rel="noopener noreferrer">Kernel Memory</a>, a sister project of <a href="https://github.com/microsoft/semantic-kernel" target="_blank" rel="noopener noreferrer">Semantic Kernel</a> supports this.</p>
<p><img decoding="async" loading="eager" alt="title image reading &amp;quot;Using Kernel Memory to Chunk Documents into Azure AI Search&amp;quot; with the Azure Open AI / Azure AI Search logos" src="/assets/images/title-image-337c58e5e55f92f59a1d1db49366ec04.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<p>If you haven&#x27;t heard of Kernel Memory before, it&#x27;s a library that, amongst other things, provides a way to chunk documents into smaller pieces. To quote the <a href="https://github.com/microsoft/kernel-memory?tab=readme-ov-file#kernel-memory-km-and-semantic-memory-sm" target="_blank" rel="noopener noreferrer">Kernel Memory GitHub repository</a>:</p>
<blockquote>
<p>Kernel Memory (KM) is a service built on the feedback received and lessons learned from developing Semantic Kernel (SK) and Semantic Memory (SM). It provides several features that would otherwise have to be developed manually, such as storing files, extracting text from files, providing a framework to secure users&#x27; data, etc. The KM codebase is entirely in .NET, which eliminates the need to write and maintain features in multiple languages. As a service, KM can be used from any language, tool, or platform, e.g. browser extensions and ChatGPT assistants.</p>
</blockquote>
<p>In this post, I&#x27;ll show you how to use Kernel Memory to chunk documents in the background of an ASP.NET application.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="kernel-memory-serverless-vs-service">Kernel Memory: Serverless vs Service<a href="#kernel-memory-serverless-vs-service" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>There&#x27;s two ways that we can run Kernel Memory: &quot;Serverless&quot; and &quot;Service&quot;.</p>
<p>Running the full service is more powerful, but effectively requires running a separate application. We would then need to integrate our main app with that. Given that I&#x27;m building with ASP.NET, I&#x27;ll be using the serverless approach, which allows us to run Kernel Memory within the context of a single application (which will contain our main app code as well). We can then manage our integrations with Kernel Memory as simple method calls.</p>
<p>This is simpler and more cost-effective, but it does have some limitations. The service approach offers more features; including persistent retry logic. The documentation states that if we want to scale then we&#x27;ll likely want to consider the service approach. But my own experience has been that serverless works very well for small to medium-sized applications.</p>
<p>Perhaps surprisingly, using serverless we can still have the experience of running Kernel Memory as a <strong>non-blocking</strong> separate service within the context of our ASP.NET application. This is achieved by running Kernel Memory as a <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/host/hosted-services?view=aspnetcore-8.0" target="_blank" rel="noopener noreferrer">hosted service</a> - this is the standard ASP.NET mechanism for running background tasks. That&#x27;s what we&#x27;re going to use.</p>
<p>There&#x27;s four parts to bring this to life:</p>
<ol>
<li>Our Kernel Memory serverless instance - this is where the integration between Kernel Memory, Azure Open AI, Azure AI Search and the actual chunking takes place</li>
<li>A queue which we&#x27;ll use to provide documents for chunking with Kernel Memory</li>
<li>Our hosted service which will bring together the queue and the Kernel Memory integration to manage our background document processing</li>
<li>An endpoint in our ASP.NET application to add documents to the queue</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-setting-up-kernel-memory-serverless">1. Setting up Kernel Memory serverless<a href="#1-setting-up-kernel-memory-serverless" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>There&#x27;s a number of dependencies that we need to add to our project to get Kernel Memory working. These are:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token plain">dotnet </span><span class="token function" style="color:rgb(250, 208, 0)">add</span><span class="token plain"> Azure.AI.OpenAI</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">dotnet </span><span class="token function" style="color:rgb(250, 208, 0)">add</span><span class="token plain"> Azure.AI.FormRecognizer </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># if we want to use Document Intelligence - not mandatory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">dotnet </span><span class="token function" style="color:rgb(250, 208, 0)">add</span><span class="token plain"> Azure.Identity</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">dotnet </span><span class="token function" style="color:rgb(250, 208, 0)">add</span><span class="token plain"> Azure.Storage.Blobs</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">dotnet </span><span class="token function" style="color:rgb(250, 208, 0)">add</span><span class="token plain"> Microsoft.KernelMemory.Core</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">dotnet </span><span class="token function" style="color:rgb(250, 208, 0)">add</span><span class="token plain"> Microsoft.SemanticKernel</span><br></span></code></pre></div></div>
<p>With this in place we&#x27;ll start to integrate with Kernel Memory. We will first construct ourselves an <code>IKernelMemory</code> like so:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token plain">_memory </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">KernelMemoryBuilder</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">WithAzureOpenAITextEmbeddingGeneration</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">AzureOpenAIConfig</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        APIType </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> AzureOpenAIConfig</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">APITypes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">EmbeddingGeneration</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        Auth </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> AzureOpenAIConfig</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AuthTypes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AzureIdentity</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        Endpoint </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&quot;https://cog-ourapp-dev.openai.azure.com/&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        Deployment </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&quot;OpenAi-text-embedding-ada2&quot;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// text-embedding-ada-002</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">WithAzureOpenAITextGeneration</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">AzureOpenAIConfig</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        APIType </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> AzureOpenAIConfig</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">APITypes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">ChatCompletion</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        Auth </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> AzureOpenAIConfig</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AuthTypes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AzureIdentity</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        Endpoint </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&quot;https://cog-ourapp-dev.openai.azure.com/&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        Deployment </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&quot;OpenAi-gpt-35-turbo-16k&quot;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// gpt-3.5-turbo-16k</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">WithAzureAISearchMemoryDb</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">AzureAISearchConfig</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        Auth </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> AzureAISearchConfig</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AuthTypes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AzureIdentity</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        Endpoint </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&quot;https://srch-ourapp-dev.search.windows.net&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// Only necessary if you want to add Document Intelligence</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">WithAzureAIDocIntel</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">AzureAIDocIntelConfig</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        Auth </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> AzureAIDocIntelConfig</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AuthTypes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AzureIdentity</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        Endpoint </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&quot;https://cog-ourapp-dev.cognitiveservices.azure.com/&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Build</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><br></span></code></pre></div></div>
<p>What we&#x27;re doing here, is creating an <code>IKernelMemory</code> instance and making it aware of all our deployed Azure resources. Going through how to deploy those is out of the scope of this post, but it&#x27;s probably worth highlighting that we&#x27;re using <code>AzureIdentity</code> for auth as it&#x27;s particularly secure, if you would like to use other options, you certainly can.</p>
<p>It&#x27;s probably worth highlighting that we&#x27;re using the <code>text-embedding-ada-002</code> model for text embedding and the <code>gpt-3.5-turbo-16k</code> model for text generation. These are the models that I&#x27;ve found to be most effective for my use cases. Of these, the text embedding model is the most important - it&#x27;s the one that will be used to chunk documents.</p>
<p>You&#x27;ll also note we&#x27;re using Azure AI Document Intelligence; this is optional and just tackles a few more document chunking scenarios. It&#x27;s not mandatory.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="chunking-with-kernel-memory-serverless">Chunking with Kernel Memory serverless<a href="#chunking-with-kernel-memory-serverless" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>With our <code>IKernelMemory</code> ready to go, we now need a way to chunk documents. Deep down, this is achieved by acquiring the document we want to chunk from blob storage and passing it to <code>_memory.ImportDocumentAsync</code> with the name of the index we want to process into. You can see examples of this usage in the <a href="https://microsoft.github.io/kernel-memory/serverless" target="_blank" rel="noopener noreferrer">Kernel Memory docs</a>. You can also see how it works in the <a href="https://github.com/microsoft/kernel-memory/blob/9112757f4fe25edd7bfbf10222621f11422bd3b5/service/Core/MemoryServerless.cs#L89" target="_blank" rel="noopener noreferrer">Kernel Memory repository itself</a>.</p>
<p>However, it&#x27;s often helpful to have a number of other things in place to manage:</p>
<ol>
<li>Applying tags to documents (this gives us more power when querying later)</li>
<li>Creating acceptable names / ids for the Azure AI Search Service</li>
<li>Handling rate limiting - more on that in a moment</li>
</ol>
<p>To that end, I tend to end up implementing a <code>Process</code> method that looks something like this:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Task</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">Process</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> index</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> documentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name" style="color:rgb(250, 208, 0)">TokenCredential</span><span class="token plain"> credential </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> _env</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">IsDevelopment</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">AzureCliCredential</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">DefaultAzureCredential</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">DefaultAzureCredentialOptions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        ManagedIdentityClientId </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&quot;[Managed Identity ClientId Here]&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name" style="color:rgb(250, 208, 0)">BlobServiceClient</span><span class="token plain"> azureBlobServiceClient </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Uri</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">&quot;https://stourappdev.blob.core.windows.net&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> credential</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> containerClient </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> azureBlobServiceClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetBlobContainerClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">index</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// eg DocumentUrl: https://stourappdev.blob.core.windows.net/my-index/A%20Booklet.pdf</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> fileName </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> System</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Web</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">HttpUtility</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">UrlDecode</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">DocumentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Split</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token char" style="color:rgb(250, 208, 0)">&#x27;/&#x27;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Last</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> blobClient </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> containerClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetBlobClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">fileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name" style="color:rgb(250, 208, 0)">MemoryStream</span><span class="token plain"> documentContent </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> response </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> blobClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">DownloadToAsync</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">documentContent</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// example documentUrl:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// Chunking, getting embeddings for and storing for documentUrl consisting of 103469 characters in https://stourappdev.blob.core.windows.net/my-index/A%20Booklet.pdf</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogInformation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$&quot;Chunking, getting embeddings for and storing for {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">documentUrl</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} consisting of {{count}} characters in {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">index</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}}&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentContent</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> index</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> documentId </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">MakeDocumentId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">documentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name" style="color:rgb(250, 208, 0)">TagCollection</span><span class="token plain"> tags </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&quot;DocumentUrl&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentUrl </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&quot;FileName&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> fileName </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> stopwatch </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Stopwatch</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    stopwatch</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Start</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">int</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">bool</span><span class="token plain"> done </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">false</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">int</span><span class="token plain"> attempt </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">0</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        attempt</span><span class="token operator" style="color:rgb(255, 157, 0)">++</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">attempt </span><span class="token operator" style="color:rgb(255, 157, 0)">==</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">4</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// if we&#x27;ve tried 3 times, give up</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">throw</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$&quot;Failed to store document </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">documentUrl</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> after </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">attempt </span><span class="token interpolation-string interpolation expression language-csharp operator" style="color:rgb(255, 157, 0)">-</span><span class="token interpolation-string interpolation expression language-csharp"> </span><span class="token interpolation-string interpolation expression language-csharp number" style="color:rgb(255, 98, 140)">1</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> attempts and </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">stopwatch</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Elapsed</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">TotalSeconds</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> seconds&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">try</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">!=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogInformation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$&quot;Waiting {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">waitForSeconds</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} seconds&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> waitForSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> Task</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Delay</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">TimeSpan</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">FromSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">waitForSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogInformation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">&quot;Importing documentId {documentId} attempt {attempt}&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> attempt</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> _memory</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">ImportDocumentAsync</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">content</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> documentContent</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">fileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> fileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">documentId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> documentId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">index</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> index</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">tags</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> tags</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            done </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">Microsoft</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token class-name" style="color:rgb(250, 208, 0)">SemanticKernel</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token class-name" style="color:rgb(250, 208, 0)">HttpOperationException</span><span class="token plain"> e</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">when</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">e</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">InnerException </span><span class="token keyword" style="color:rgb(255, 157, 0)">is</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">Azure</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token class-name" style="color:rgb(250, 208, 0)">RequestFailedException</span><span class="token plain"> azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">HandleRequestFailed</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">Azure</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token class-name" style="color:rgb(250, 208, 0)">RequestFailedException</span><span class="token plain"> azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">HandleRequestFailed</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token plain"> ex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">throw</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$&quot;Error storing document </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">documentUrl</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> on attempt </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">attempt</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> after </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">stopwatch</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Elapsed</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">TotalSeconds</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> seconds&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> ex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">while</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token operator" style="color:rgb(255, 157, 0)">!</span><span class="token plain">done</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    stopwatch</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Stop</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogInformation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$&quot;Processed {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">documentId</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} into {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">index</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} index in {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">stopwatch</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Elapsed</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">TotalSeconds</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} seconds&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> index</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> stopwatch</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Elapsed</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">TotalSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token return-type class-name keyword" style="color:rgb(255, 157, 0)">int</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">HandleRequestFailed</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">Azure</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token class-name" style="color:rgb(250, 208, 0)">RequestFailedException</span><span class="token plain"> azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">int</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> waitForSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> response </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetRawResponse</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> retryAfterSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> response</span><span class="token punctuation" style="color:rgb(255, 255, 255)">?.</span><span class="token plain">Headers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">FirstOrDefault</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">h </span><span class="token operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> h</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Name </span><span class="token operator" style="color:rgb(255, 157, 0)">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&quot;x-ratelimit-reset-requests&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Value</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token operator" style="color:rgb(255, 157, 0)">??</span><span class="token plain"> response</span><span class="token punctuation" style="color:rgb(255, 255, 255)">?.</span><span class="token plain">Headers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">FirstOrDefault</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">h </span><span class="token operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> h</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Name </span><span class="token operator" style="color:rgb(255, 157, 0)">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&quot;Retry-After&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//x-ratelimit-reset-requests: 4,x-ms-client-request-id: XXXX,apim-request-id: 69569dd5-2e4a-4bfa-9b52-f3eb08481a83,Strict-Transport-Security: max-age=31536000; includeSubDomains; preload,X-Content-Type-Options: nosniff,policy-id: DeploymentRatelimit-Call,x-ms-region: West Europe,Date: Fri, 01 Dec 2023 13:29:12 GMT,Content-Length: 85,Content-Type: application/json</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> retryAfterSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">!=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">int</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Parse</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">retryAfterSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">==</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> pattern </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">@&quot;Try again in (\d+) seconds&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> match </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> Regex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Match</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Message</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> pattern</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// wait for 60 seconds if a specific value is not provided</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> match</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Success </span><span class="token operator" style="color:rgb(255, 157, 0)">&amp;&amp;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">int</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">TryParse</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">match</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Groups</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token number" style="color:rgb(255, 98, 140)">1</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">out</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">int</span><span class="token plain"> seconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> seconds </span><span class="token operator" style="color:rgb(255, 157, 0)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">1</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">60</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Status </span><span class="token operator" style="color:rgb(255, 157, 0)">==</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">int</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain">System</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Net</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">HttpStatusCode</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">TooManyRequests</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// var headers = response?.Headers.Select(h =&gt; $&quot;{h.Name}: {h.Value}&quot;).ToList() ?? new List&lt;string&gt;();</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// _logger.LogWarning(azureRequestFailedException, $&quot;429 - too many requests, will wait {{{nameof(waitForSeconds)}}} seconds - HEADERS: {{{nameof(headers)}}}&quot;, waitForSeconds, string.Join(&quot;,&quot;, headers));</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogWarning</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$&quot;429 - too many requests, will wait {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">waitForSeconds</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} seconds&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> waitForSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> headers </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> response</span><span class="token punctuation" style="color:rgb(255, 255, 255)">?.</span><span class="token plain">Headers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Select</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">h </span><span class="token operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> </span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$&quot;</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">h</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Name</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">: </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">h</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Value</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">ToList</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">??</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogError</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$&quot;Azure.RequestFailedException - {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">azureRequestFailedException</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Status</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} status code, will wait {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">waitForSeconds</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} seconds - HEADERS: {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">headers</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}}&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Status</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> waitForSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">string</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Join</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">&quot;,&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> headers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> waitForSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">/// &lt;summary&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">/// Make a documentId from a fileName; remove all characters except A-Z, a-z, 0-9, ., _, -</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">/// &lt;/summary&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">MakeDocumentId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> fileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> Regex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Replace</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">fileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&quot;[^A-Za-z0-9._-]&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// eg &quot;A Booklet.pdf&quot;</span><br></span></code></pre></div></div>
<p>Much of the code above concerns rate limiting / 429s. It&#x27;s not uncommon when chunking to be hit by 429s - &quot;Too many requests&quot;. Chunking documents requires use of Azure Open AI resources, and the level of access we have is typically restricted and controlled via quotas. There&#x27;s an element of this that we can avoid by controlling the quota available on our Azure Open AI deployments (<a href="/azure-open-ai-capacity-quota-bicep">you can read more about this here</a>), and we can implement a certain amount of retry logic also.</p>
<p>The code above tries to handle a number of re-attempts as wisely as it can, and using the information that Azure APIs surface around when re-attempting is allowed. Interestingly you&#x27;ll see a variety of strategies employed here around retry times, as the way information is surfaced to support this keeps changing! We can likely have less code in future when a final standard is committed to.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="bringing-it-together">Bringing it together<a href="#bringing-it-together" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>We&#x27;re going to put this all together in a single class called <code>RagGestionService</code>.</p>
<p>You might be puzzled by the name &quot;RagGestion&quot; - this is a term my good friend <a href="https://medium.com/@georgekarsas" target="_blank" rel="noopener noreferrer">George Karsas</a> coined to describe the process of preparing documents for Retrieval Augmented Generation. It&#x27;s a great term, and I&#x27;ve adopted it!</p>
<p>The <code>RagGestionService</code> will look like this:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Azure</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Storage</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Blobs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Azure</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Core</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Azure</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Identity</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Microsoft</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">KernelMemory</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">OurApp</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Model</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">System</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Diagnostics</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">System</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Text</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">RegularExpressions</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">System</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Text</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Json</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">namespace</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">OurApp</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">interface</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">IRagGestionService</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Task</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">Process</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> indexName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> documentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">RagGestionService</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token type-list class-name" style="color:rgb(250, 208, 0)">IRagGestionService</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">IKernelMemory</span><span class="token plain"> _memory</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">RagGestionService</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">RagGestionService</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">RagGestionService</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> logger</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _logger </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _memory </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">KernelMemoryBuilder</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">WithAzureOpenAITextEmbeddingGeneration</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">AzureOpenAIConfig</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                APIType </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> AzureOpenAIConfig</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">APITypes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">EmbeddingGeneration</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                Auth </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> AzureOpenAIConfig</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AuthTypes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AzureIdentity</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                Endpoint </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&quot;https://cog-ourapp-dev.openai.azure.com/&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                Deployment </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&quot;OpenAi-text-embedding-ada2&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">WithAzureOpenAITextGeneration</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">AzureOpenAIConfig</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                APIType </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> AzureOpenAIConfig</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">APITypes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">ChatCompletion</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                Auth </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> AzureOpenAIConfig</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AuthTypes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AzureIdentity</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                Endpoint </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&quot;https://cog-ourapp-dev.openai.azure.com/&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                Deployment </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&quot;OpenAi-gpt-35-turbo-16k&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">WithAzureAISearchMemoryDb</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">AzureAISearchConfig</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                Auth </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> AzureAISearchConfig</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AuthTypes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AzureIdentity</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                Endpoint </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&quot;https://srch-ourapp-dev.search.windows.net&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// Only necessary if we want to add Document Intelligence</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">WithAzureAIDocIntel</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">AzureAIDocIntelConfig</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                Auth </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> AzureAIDocIntelConfig</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AuthTypes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AzureIdentity</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                Endpoint </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&quot;https://cog-ourapp-dev.cognitiveservices.azure.com/&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Build</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Task</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">Process</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> index</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> documentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">TokenCredential</span><span class="token plain"> credential </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> _env</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">IsDevelopment</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">AzureCliCredential</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">DefaultAzureCredential</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">DefaultAzureCredentialOptions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            ManagedIdentityClientId </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&quot;[Managed Identity ClientId Here]&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">BlobServiceClient</span><span class="token plain"> azureBlobServiceClient </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Uri</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">&quot;https://stourappdev.blob.core.windows.net&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> credential</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> containerClient </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> azureBlobServiceClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetBlobContainerClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">index</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// eg DocumentUrl: https://stourappdev.blob.core.windows.net/my-index/A%20Booklet.pdf</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> fileName </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> System</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Web</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">HttpUtility</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">UrlDecode</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">DocumentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Split</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token char" style="color:rgb(250, 208, 0)">&#x27;/&#x27;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Last</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> blobClient </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> containerClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetBlobClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">fileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">MemoryStream</span><span class="token plain"> documentContent </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> response </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> blobClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">DownloadToAsync</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">documentContent</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// example documentUrl:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// Chunking, getting embeddings for and storing for documentUrl consisting of 103469 characters in https://stourappdev.blob.core.windows.net/my-index/A%20Booklet.pdf</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogInformation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$&quot;Chunking, getting embeddings for and storing for {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">documentUrl</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} consisting of {{count}} characters in {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">index</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}}&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentContent</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> index</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> documentId </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">MakeDocumentId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">documentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">TagCollection</span><span class="token plain"> tags </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&quot;DocumentUrl&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentUrl </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&quot;FileName&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> fileName </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> stopwatch </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Stopwatch</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        stopwatch</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Start</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">int</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">bool</span><span class="token plain"> done </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">false</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">int</span><span class="token plain"> attempt </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">0</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            attempt</span><span class="token operator" style="color:rgb(255, 157, 0)">++</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">attempt </span><span class="token operator" style="color:rgb(255, 157, 0)">==</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">4</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// if we&#x27;ve tried 3 times, give up</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token keyword" style="color:rgb(255, 157, 0)">throw</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$&quot;Failed to store document </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">documentUrl</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> after </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">attempt </span><span class="token interpolation-string interpolation expression language-csharp operator" style="color:rgb(255, 157, 0)">-</span><span class="token interpolation-string interpolation expression language-csharp"> </span><span class="token interpolation-string interpolation expression language-csharp number" style="color:rgb(255, 98, 140)">1</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> attempts and </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">stopwatch</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Elapsed</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">TotalSeconds</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> seconds&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">try</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">!=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogInformation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$&quot;Waiting {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">waitForSeconds</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} seconds&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> waitForSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> Task</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Delay</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">TimeSpan</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">FromSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">waitForSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogInformation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">&quot;Importing documentId {documentId} attempt {attempt}&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> attempt</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> _memory</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">ImportDocumentAsync</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">content</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> documentContent</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">fileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> fileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">documentId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> documentId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">index</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> index</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">tags</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> tags</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                done </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">Microsoft</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token class-name" style="color:rgb(250, 208, 0)">SemanticKernel</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token class-name" style="color:rgb(250, 208, 0)">HttpOperationException</span><span class="token plain"> e</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">when</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">e</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">InnerException </span><span class="token keyword" style="color:rgb(255, 157, 0)">is</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">Azure</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token class-name" style="color:rgb(250, 208, 0)">RequestFailedException</span><span class="token plain"> azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">HandleRequestFailed</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">Azure</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token class-name" style="color:rgb(250, 208, 0)">RequestFailedException</span><span class="token plain"> azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">HandleRequestFailed</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token plain"> ex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token keyword" style="color:rgb(255, 157, 0)">throw</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$&quot;Error storing document </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">documentUrl</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> on attempt </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">attempt</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> after </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">stopwatch</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Elapsed</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">TotalSeconds</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> seconds&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> ex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">while</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token operator" style="color:rgb(255, 157, 0)">!</span><span class="token plain">done</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        stopwatch</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Stop</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogInformation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$&quot;Processed {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">documentId</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} into {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">index</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} index in {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">stopwatch</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Elapsed</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">TotalSeconds</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} seconds&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> index</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> stopwatch</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Elapsed</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">TotalSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token return-type class-name keyword" style="color:rgb(255, 157, 0)">int</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">HandleRequestFailed</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">Azure</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token class-name" style="color:rgb(250, 208, 0)">RequestFailedException</span><span class="token plain"> azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">int</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> waitForSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> response </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetRawResponse</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> retryAfterSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> response</span><span class="token punctuation" style="color:rgb(255, 255, 255)">?.</span><span class="token plain">Headers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">FirstOrDefault</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">h </span><span class="token operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> h</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Name </span><span class="token operator" style="color:rgb(255, 157, 0)">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&quot;x-ratelimit-reset-requests&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Value</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token operator" style="color:rgb(255, 157, 0)">??</span><span class="token plain"> response</span><span class="token punctuation" style="color:rgb(255, 255, 255)">?.</span><span class="token plain">Headers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">FirstOrDefault</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">h </span><span class="token operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> h</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Name </span><span class="token operator" style="color:rgb(255, 157, 0)">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&quot;Retry-After&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//x-ratelimit-reset-requests: 4,x-ms-client-request-id: XXXX,apim-request-id: 69569dd5-2e4a-4bfa-9b52-f3eb08481a83,Strict-Transport-Security: max-age=31536000; includeSubDomains; preload,X-Content-Type-Options: nosniff,policy-id: DeploymentRatelimit-Call,x-ms-region: West Europe,Date: Fri, 01 Dec 2023 13:29:12 GMT,Content-Length: 85,Content-Type: application/json</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> retryAfterSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">!=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">int</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Parse</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">retryAfterSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">==</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> pattern </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">@&quot;Try again in (\d+) seconds&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> match </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> Regex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Match</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Message</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> pattern</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// wait for 60 seconds if a specific value is not provided</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> match</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Success </span><span class="token operator" style="color:rgb(255, 157, 0)">&amp;&amp;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">int</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">TryParse</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">match</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Groups</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token number" style="color:rgb(255, 98, 140)">1</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">out</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">int</span><span class="token plain"> seconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> seconds </span><span class="token operator" style="color:rgb(255, 157, 0)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">1</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">60</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Status </span><span class="token operator" style="color:rgb(255, 157, 0)">==</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">int</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain">System</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Net</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">HttpStatusCode</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">TooManyRequests</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// var headers = response?.Headers.Select(h =&gt; $&quot;{h.Name}: {h.Value}&quot;).ToList() ?? new List&lt;string&gt;();</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// _logger.LogWarning(azureRequestFailedException, $&quot;429 - too many requests, will wait {{{nameof(waitForSeconds)}}} seconds - HEADERS: {{{nameof(headers)}}}&quot;, waitForSeconds, string.Join(&quot;,&quot;, headers));</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogWarning</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$&quot;429 - too many requests, will wait {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">waitForSeconds</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} seconds&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> waitForSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> headers </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> response</span><span class="token punctuation" style="color:rgb(255, 255, 255)">?.</span><span class="token plain">Headers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Select</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">h </span><span class="token operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> </span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$&quot;</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">h</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Name</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">: </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">h</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Value</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">ToList</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">??</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogError</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$&quot;Azure.RequestFailedException - {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">azureRequestFailedException</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Status</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} status code, will wait {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">waitForSeconds</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} seconds - HEADERS: {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">headers</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}}&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Status</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> waitForSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">string</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Join</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">&quot;,&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> headers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> waitForSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">/// &lt;summary&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">/// Make a documentId from a fileName; remove all characters except A-Z, a-z, 0-9, ., _, -</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">/// &lt;/summary&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">MakeDocumentId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> fileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> Regex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Replace</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">fileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&quot;[^A-Za-z0-9._-]&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// eg &quot;A Booklet.pdf&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre></div></div>
<p>By the way, I don&#x27;t advise hard-coding the Azure resources as I have here, but rather passing them in as configuration. Incidentally, we could also use dependency injection to inject a prepared <code>IKernelMemory</code> instance into the service, but again, I&#x27;m keeping it simple here for clarity.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-our-document-processor-queue">2. Our document processor queue<a href="#2-our-document-processor-queue" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>In order that we have a way to provide documents for chunking, we need a queue. This is a simple queue that we can add documents to, and then process them in the background. We&#x27;re going to use a <code>ConcurrentQueue</code> for this, with a little wrapper around it so we can encapsulate the queue for sharing between our UI and our background task, and also to do some logging.</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">System</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Collections</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Concurrent</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">OurApp</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Model</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">namespace</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">OurApp</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Services</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Implementations</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">record</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">DocumentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> DocumentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> IndexName</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">interface</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">IDocumentProcessorQueue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">DocumentToProcess</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">DequeueDocumentUri</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token return-type class-name keyword" style="color:rgb(255, 157, 0)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">EnqueueDocumentUri</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">DocumentToProcess</span><span class="token plain"> documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">DocumentProcessorQueue</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token type-list class-name" style="color:rgb(250, 208, 0)">IDocumentProcessorQueue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">ConcurrentQueue</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">DocumentToProcess</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> _documentUrlQueue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">DocumentProcessorQueue</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">DocumentProcessorQueue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">DocumentProcessorQueue</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _documentUrlQueue </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _logger </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:rgb(255, 157, 0)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">EnqueueDocumentUri</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">DocumentToProcess</span><span class="token plain"> documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogInformation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$&quot;Adding document for background processing onto {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">documentToProcess</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">IndexName</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} index later: {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">documentToProcess</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">DocumentUrl</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} ({{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">_documentUrlQueue</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Count</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} items on queue)&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">IndexName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">DocumentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> _documentUrlQueue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Count</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _documentUrlQueue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Enqueue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">DocumentToProcess</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">DequeueDocumentUri</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">_documentUrlQueue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">TryDequeue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">out</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogInformation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$&quot;Document picked up for background processing onto {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">documentToProcess</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">IndexName</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} index: {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">documentToProcess</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">DocumentUrl</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} ({{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">_documentUrlQueue</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Count</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} items remain on queue)&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">IndexName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">DocumentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> _documentUrlQueue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Count</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre></div></div>
<p>The <code>EnqueueDocumentUri</code> method above will be called from the context of our UI - from an ASP.NET controller. This will be invoked when someone uploads a file and will also be responsible for adding the file to a BlobService for storage prior to processing.</p>
<p>By contrast, the <code>DequeueDocumentUri</code> method will be called from the context of our background service; it will call this method to pick up a file for processing.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-our-background-service">3. Our background service<a href="#3-our-background-service" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>Next, we need a background service to bring together our <code>DocumentProcessorQueue</code> and our <code>RagGestionService</code>. This is a standard ASP.NET hosted service. It will look like this:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">OurApp</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Model</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">OurApp</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">namespace</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">OurApp</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">BackgroundServices</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">DocumentProcessorBackgroundService</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token type-list class-name" style="color:rgb(250, 208, 0)">BackgroundService</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">DocumentProcessorBackgroundService</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">IServiceProvider</span><span class="token plain"> _services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">DocumentProcessorBackgroundService</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">IServiceProvider</span><span class="token plain"> services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">DocumentProcessorBackgroundService</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _services </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _logger </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">protected</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">override</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Task</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">ExecuteAsync</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">CancellationToken</span><span class="token plain"> stoppingToken</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">try</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogInformation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">&quot;Starting RagGestion&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> ragGestionService </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> _services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token generic-method function" style="color:rgb(250, 208, 0)">GetRequiredService</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)">IRagGestionService</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> documentProcessorQueue </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> _services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token generic-method function" style="color:rgb(250, 208, 0)">GetRequiredService</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)">IDocumentProcessorQueue</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">PerformRagGestion</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">env</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> chunkerService</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentProcessorQueue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> stoppingToken</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogError</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">e</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$&quot;Error processing document&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Task</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">PerformRagGestion</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">IRagGestionService</span><span class="token plain"> ragGestionService</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">IDocumentProcessorQueue</span><span class="token plain"> documentProcessorQueue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">CancellationToken</span><span class="token plain"> stoppingToken</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">while</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token operator" style="color:rgb(255, 157, 0)">!</span><span class="token plain">stoppingToken</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">IsCancellationRequested</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> Task</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Delay</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">TimeSpan</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">FromSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token number" style="color:rgb(255, 98, 140)">5</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> stoppingToken</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token class-name" style="color:rgb(250, 208, 0)">DocumentToProcess</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> documentToProcess </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> documentProcessorQueue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">DequeueDocumentUri</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">documentToProcess </span><span class="token operator" style="color:rgb(255, 157, 0)">==</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogDebug</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">&quot;No documents to process&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token keyword" style="color:rgb(255, 157, 0)">continue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">try</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> watch </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> System</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Diagnostics</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Stopwatch</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">StartNew</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogInformation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$&quot;Processing document: {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">documentToProcess</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">DocumentUrl</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}}&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">DocumentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> ragGestionService</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Process</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">indexName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">IndexName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">documentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">DocumentUrl</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                watch</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Stop</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogInformation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$&quot;Chunked and stored {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">documentToProcess</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">DocumentUrl</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} into Azure AI Search {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">documentToProcess</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">IndexName</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} index in {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">watch</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Elapsed</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Seconds</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} seconds&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">DocumentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">IndexName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> watch</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Elapsed</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">TotalSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogError</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">e</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$&quot;Error processing document: {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">documentToProcess</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}}&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre></div></div>
<p>This service will run in the background of the ASP.NET application, will pick up documents from the queue (if there are any) and pass them to the <code>RagGestionService</code> for processing. It will trigger every 5 seconds, running for the lifetime of the application.</p>
<p>You&#x27;ll see we&#x27;re doing some timing here - this is because it&#x27;s useful to know how long the process takes. If we&#x27;re processing a lot of documents, we&#x27;ll want to know how long it&#x27;s taking to process each one.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-adding-documents-to-the-queue">4. Adding documents to the queue<a href="#4-adding-documents-to-the-queue" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>To add documents to the queue, we&#x27;ll need to create an endpoint in our ASP.NET application. This endpoint will accept files and add them to the queue. Here&#x27;s an example of how we might do that:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Microsoft</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">AspNetCore</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Mvc</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Azure</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Storage</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Blobs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Azure</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Identity</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Azure</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Core</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">namespace</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">OurApp</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Controllers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">record</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">UploadedFile</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> FileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">bool</span><span class="token plain"> Succeeded</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">long</span><span class="token plain"> Size</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> DocumentUrl</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token attribute class-name" style="color:rgb(250, 208, 0)">ApiController</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">UploadController</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token type-list class-name" style="color:rgb(250, 208, 0)">ControllerBase</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">IDocumentProcessorQueue</span><span class="token plain"> _documentProcessorQueue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">UploadController</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> _log</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">IHostEnvironment</span><span class="token plain"> _env</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">UploadController</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">UploadController</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> log</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">IHostEnvironment</span><span class="token plain"> env</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">IDocumentProcessorQueue</span><span class="token plain"> documentProcessorQueue</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _log </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> log</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _env </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> env</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _documentProcessorQueue </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> documentProcessorQueue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token attribute class-name" style="color:rgb(250, 208, 0)">RequestSizeLimit</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token attribute attribute-arguments number" style="color:rgb(255, 98, 140)">104857600</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// For files of up to 100 MB - perhaps larger than you&#x27;d want to upload in a single go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token function" style="color:rgb(250, 208, 0)">HttpPost</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$&quot;api/</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">UploadFiles</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token attribute class-name" style="color:rgb(250, 208, 0)">ProducesResponseType</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token attribute attribute-arguments">StatusCodes</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token attribute attribute-arguments">Status200OK</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token attribute attribute-arguments"> Type </span><span class="token attribute attribute-arguments operator" style="color:rgb(255, 157, 0)">=</span><span class="token attribute attribute-arguments"> </span><span class="token attribute attribute-arguments keyword" style="color:rgb(255, 157, 0)">typeof</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token attribute attribute-arguments type-expression class-name" style="color:rgb(250, 208, 0)">List</span><span class="token attribute attribute-arguments type-expression class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token attribute attribute-arguments type-expression class-name" style="color:rgb(250, 208, 0)">UploadedFile</span><span class="token attribute attribute-arguments type-expression class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token attribute class-name" style="color:rgb(250, 208, 0)">ProducesResponseType</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token attribute attribute-arguments">StatusCodes</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token attribute attribute-arguments">Status403Forbidden</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token attribute attribute-arguments"> Type </span><span class="token attribute attribute-arguments operator" style="color:rgb(255, 157, 0)">=</span><span class="token attribute attribute-arguments"> </span><span class="token attribute attribute-arguments keyword" style="color:rgb(255, 157, 0)">typeof</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token attribute attribute-arguments type-expression class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token attribute class-name" style="color:rgb(250, 208, 0)">ProducesResponseType</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token attribute attribute-arguments">StatusCodes</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token attribute attribute-arguments">Status404NotFound</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token attribute attribute-arguments"> Type </span><span class="token attribute attribute-arguments operator" style="color:rgb(255, 157, 0)">=</span><span class="token attribute attribute-arguments"> </span><span class="token attribute attribute-arguments keyword" style="color:rgb(255, 157, 0)">typeof</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token attribute attribute-arguments type-expression class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Task</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">ActionResult</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">List</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">UploadedFile</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">UploadFiles</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token attribute class-name" style="color:rgb(250, 208, 0)">FromQuery</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> indexName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">List</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">IFormFile</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> files</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> processedFiles </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">List</span><span class="token constructor-invocation class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">UploadedFile</span><span class="token constructor-invocation class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">try</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">foreach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> formFile </span><span class="token keyword" style="color:rgb(255, 157, 0)">in</span><span class="token plain"> files</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token keyword" style="color:rgb(255, 157, 0)">try</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token class-name" style="color:rgb(250, 208, 0)">TokenCredential</span><span class="token plain"> credential </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> _env</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">IsDevelopment</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">AzureCliCredential</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">DefaultAzureCredential</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">DefaultAzureCredentialOptions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                        ManagedIdentityClientId </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&quot;[Managed Identity ClientId Here]&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token class-name" style="color:rgb(250, 208, 0)">BlobServiceClient</span><span class="token plain"> azureBlobServiceClient </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                        </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Uri</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">&quot;https://stourappdev.blob.core.windows.net&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> credential</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> containerClient </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> azureBlobServiceClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetBlobContainerClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">indexName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token operator" style="color:rgb(255, 157, 0)">!</span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> containerClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">ExistsAsync</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                        </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> containerClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">CreateIfNotExistsAsync</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> blobClient </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> containerClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetBlobClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">formFile</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">FileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token class-name" style="color:rgb(250, 208, 0)">StreamReader</span><span class="token plain"> streamReader </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">formFile</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">OpenReadStream</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> uploaded </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> blobClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">UploadAsync</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">streamReader</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">BaseStream</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">overwrite</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> uploadedFile </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">UploadedFile</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">FileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> formFile</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">FileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">Succeeded</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">Size</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> formFile</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">DocumentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> blobClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Uri</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AbsoluteUri</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    processedFiles</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Add</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">uploadedFile</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    _documentProcessorQueue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">EnqueueDocumentUri</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                        </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">DocumentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                            </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">DocumentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> uploadedFile</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">DocumentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                            </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">IndexName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> indexName</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token plain"> ex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    processedFiles</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Add</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">UploadedFile</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">FileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> formFile</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">FileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">Succeeded</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">false</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">Size</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> formFile</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">DocumentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">string</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Empty</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    _log</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogError</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">ex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&quot;Failed to upload {file}&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> formFile</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">FileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">Ok</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">processedFiles</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token plain"> ex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            _log</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogError</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">ex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&quot;Problem uploading files&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">BadRequest</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">&quot;Problem uploading files&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre></div></div>
<p>As we can see, this endpoint:</p>
<ol>
<li>Accepts files from a POST request with an index name in the querystring</li>
<li>Uploads them to Blob Storage (matching the container name to the index they will be processed into in future)</li>
<li>Adds them to the queue with <code>_documentProcessorQueue.EnqueueDocumentUri</code>. This will then be picked up by the background service and processed.</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="registering-our-services">Registering our services<a href="#registering-our-services" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>Finally, we&#x27;ll need to register our services in the <code>Program.cs</code> file. We&#x27;ll want to add the following:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token plain">builder</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Services</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token generic-method function" style="color:rgb(250, 208, 0)">AddSingleton</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)">IRagGestionService</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)"> RagGestionService</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token generic-method function" style="color:rgb(250, 208, 0)">AddSingleton</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)">IDocumentProcessorQueue</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)"> DocumentProcessorQueue</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token generic-method function" style="color:rgb(250, 208, 0)">AddHostedService</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)">DocumentProcessorBackgroundService</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><br></span></code></pre></div></div>
<p>With this in place we have an application that can upload documents and chunk them in the background.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>And that&#x27;s it! This is an ASP.NET application that can chunk documents (or RagGest 😉) in the background using Kernel Memory running in serverless mode. I haven&#x27;t yet had the need to upgrade to the full Kernel Memory service. Perhaps the day will come, but the mileage we can get with this approach is considerable.</p>
<p>Many thanks to <a href="https://github.com/drosevear" target="_blank" rel="noopener noreferrer">David Rosevear</a> and <a href="https://www.linkedin.com/in/george-karsas" target="_blank" rel="noopener noreferrer">George Karsas</a> for their help working on this mechanism. And George for &quot;RagGestion&quot; - I love it!</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" title="The Microsoft cloud platform." class="tag_zVej tagRegular_sFm0" href="/tags/azure">Azure</a></li><li class="tag_QGVx"><a rel="tag" title="The C# programming language." class="tag_zVej tagRegular_sFm0" href="/tags/csharp">C#</a></li><li class="tag_QGVx"><a rel="tag" title="The web framework built by Microsoft." class="tag_zVej tagRegular_sFm0" href="/tags/asp-net">ASP.NET</a></li><li class="tag_QGVx"><a rel="tag" title="All things AI - Artificial Intelligence, Large Language Models and the like." class="tag_zVej tagRegular_sFm0" href="/tags/ai">AI</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2024-04-21-using-kernel-memory-to-chunk-documents-into-azure-ai-search/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/large-language-models-view-models-backend-for-frontend"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Large Language Models, Open API, View Models and the Backend for Frontend Pattern</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/webpack-overview"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Overview of webpack, a JavaScript bundler</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#kernel-memory-serverless-vs-service" class="table-of-contents__link toc-highlight">Kernel Memory: Serverless vs Service</a></li><li><a href="#1-setting-up-kernel-memory-serverless" class="table-of-contents__link toc-highlight">1. Setting up Kernel Memory serverless</a><ul><li><a href="#chunking-with-kernel-memory-serverless" class="table-of-contents__link toc-highlight">Chunking with Kernel Memory serverless</a></li><li><a href="#bringing-it-together" class="table-of-contents__link toc-highlight">Bringing it together</a></li></ul></li><li><a href="#2-our-document-processor-queue" class="table-of-contents__link toc-highlight">2. Our document processor queue</a></li><li><a href="#3-our-background-service" class="table-of-contents__link toc-highlight">3. Our background service</a></li><li><a href="#4-adding-documents-to-the-queue" class="table-of-contents__link toc-highlight">4. Adding documents to the queue</a></li><li><a href="#registering-our-services" class="table-of-contents__link toc-highlight">Registering our services</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title"></div><ul class="footer__items clean-list"><li class="footer__item"><div class="footer__title"><a href="/tags/typescript" class="footer__link-item">TypeScript<img src="/img/ts-logo-128.svg" alt="TypeScript icon" class="footer__icon"></a></div>
<ul class="footer__items clean-list">
  <li class="footer__item"><a href="/typescript-vs-jsdoc-javascript" class="footer__link-item">TypeScript vs JSDoc JavaScript</a></li><li class="footer__item"><a href="/type-annotations-strong-types-weakly-held" class="footer__link-item">Type annotations proposal: strong types, weakly held</a></li>
</ul><div class="footer__title"><a href="/tags/azure" class="footer__link-item">Azure<img src="/img/azure-logo.svg" alt="Azure icon" class="footer__icon"></a></div>
<ul class="footer__items clean-list">
  <li class="footer__item"><a href="/azure-container-apps-easy-auth-and-dotnet-authentication" class="footer__link-item">Azure Container Apps: Easy Auth and .NET</a></li><li class="footer__item"><a href="/introducing-azdo-npm-auth" class="footer__link-item">Introducing azdo-npm-auth (Azure DevOps npm auth)</a></li><li class="footer__item"><a href="/npx-and-azure-artifacts-the-secret-cli-delivery-mechanism" class="footer__link-item">npx and Azure Artifacts: the secret CLI delivery mechanism</a></li><li class="footer__item"><a href="/azure-static-web-apps-dynamic-redirects-azure-functions" class="footer__link-item">Azure Static Web Apps: dynamic redirects with Azure Functions</a></li>
</ul><div class="footer__title"><a href="/tags/asp-net" class="footer__link-item">ASP.NET<img src="/img/dotnet-logo.svg" alt="ASP.NET icon" class="footer__icon"></a></div>
<ul class="footer__items clean-list">
  <li class="footer__item"><a href="/eslint-your-csharp-in-vs-code-with-roslyn-analyzers" class="footer__link-item">ESLint your C# with Roslyn Analyzers</a></li><li class="footer__item"><a href="/aspnet-serilog-and-application-insights" class="footer__link-item">ASP.NET, Serilog and Application Insights</a></li>
</ul><div class="footer__title"><a href="/tags/react" class="footer__link-item">React<img src="/img/react-logo.svg" alt="React icon" class="footer__icon"></a></div>
<ul class="footer__items clean-list">
  <li class="footer__item"><a href="/structured-data-seo-and-react" class="footer__link-item">Structured data and React</a></li><li class="footer__item"><a href="/react-usesearchparamsstate" class="footer__link-item">React: storing state in URL with URLSearchParams</a></li>
</ul></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title"></div><ul class="footer__items clean-list"><li class="footer__item"><div class="footer__title">Notable articles</div>
<ul class="footer__items clean-list">
  <li class="footer__item"><a href="/definitely-typed-the-movie" class="footer__link-item">The history of Definitely Typed<img src="/img/definitely-typed-logo.png" alt="The history of Definitely Typed icon" class="footer__icon"></a></li><li class="footer__item"><a href="/typescript-documentary" class="footer__link-item">TypeScript: the documentary<img src="/img/ts-logo-128.svg" alt="TypeScript: the documentary icon" class="footer__icon"></a></li><li class="footer__item"><a href="/how-we-fixed-my-seo" class="footer__link-item">How we fixed my SEO</a></li>
</ul><div class="footer__title">Popular articles</div>
<ul class="footer__items clean-list">
  <li class="footer__item"><a href="/aspnet-serilog-and-application-insights" class="footer__link-item">ASP.NET, Serilog and Application Insights</a></li><li class="footer__item"><a href="/eslint-your-csharp-in-vs-code-with-roslyn-analyzers" class="footer__link-item">ESLint your C# with Roslyn Analyzers</a></li><li class="footer__item"><a href="/prettier-your-csharp-with-dotnet-format-and-lint-staged" class="footer__link-item">dotnet-format: Prettier your C# with lint-staged & husky</a></li>
</ul><div class="footer__title">Recently updated</div>
<ul class="footer__items clean-list">
  <li class="footer__item"><a href="azure-container-apps-bicep-managed-certificates-custom-domains" class="footer__link-item">Azure Container Apps, Bicep, managed certificates and custom domains</a></li><li class="footer__item"><a href="using-azd-for-faster-incremental-azure-static-web-app-deployments-in-github-actions" class="footer__link-item">Using AZD for faster incremental Azure Static Web App deployments in GitHub Actions</a></li><li class="footer__item"><a href="using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops" class="footer__link-item">Using AZD for faster incremental Azure Container App deployments in Azure DevOps</a></li>
</ul></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Learn more / support me</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/about">About me</a></li><li class="footer__item"><a href="https://github.com/johnnyreilly/blog.johnnyreilly.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog source code on GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/tags">Blog categories</a></li><li class="footer__item"><a href="https://johnnyreilly.com/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item">RSS feed<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://johnnyreilly.com/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item">Atom feed<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/privacy-policy">Privacy Policy</a></li><li class="footer__item"><iframe src="https://github.com/sponsors/johnnyreilly/card" title="Sponsor johnnyreilly" style="margin-top: 20px; border: 0; border-radius: 10px; background-color: white; min-height: 400px;"></iframe></li><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" rel="noopener" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" loading="lazy" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2012 - 2025 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>