<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="icon" href="/img/favicon/profile.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(37, 194, 160)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/favicon/apple-touch-icon.png"><title data-react-helmet="true">6 posts tagged with &quot;unit testing&quot; | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="6 posts tagged with &quot;unit testing&quot; | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://blog.johnnyreilly.com/img/profile.png"><meta data-react-helmet="true" name="twitter:image" content="https://blog.johnnyreilly.com/img/profile.png"><meta data-react-helmet="true" property="og:url" content="https://blog.johnnyreilly.com/tags/unit-testing"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-react-helmet="true" name="robots" content="max-image-preview:large"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.johnnyreilly.com/tags/unit-testing"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/unit-testing" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/unit-testing" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.ff16c2af.css">
<link rel="preload" href="/assets/js/runtime~main.89fbb0b4.js" as="script">
<link rel="preload" href="/assets/js/main.14ca547e.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--dark_hz6m"></div><b class="navbar__title">I CAN MAKE THIS WORK</b></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/blog-archive">Blog Archive</a><a class="navbar__item navbar__link" href="/talks">Talks</a></div><div class="navbar__items navbar__items--right"><a href="https://polywork.johnnyreilly.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Polywork<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">ðŸŒœ</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">ðŸŒž</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/12/05/azure-static-web-app-deploy-previews-with-azure-devops">Azure Static Web App Deploy Previews with Azure DevOps</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/11/22/typescript-vs-jsdoc-javascript">TypeScript vs JSDoc JavaScript</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/11/18/azure-standard-tests-with-bicep">Azure standard availability tests with Bicep</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/10/31/nswag-generated-c-sharp-client-property-name-clash">NSwag generated C# client: Open API property name clashes and decimal types rather than double</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/10/18/docusaurus-meta-tags-and-google-discover">Docusaurus, meta tags and Google Discover</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>6 posts tagged with &quot;unit testing&quot;</h1><a href="/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2016/04/25/instant-stubs-with-jsonnet">Instant Stubs with JSON.Net (just add hot water)</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2016-04-25T00:00:00.000Z" itemprop="datePublished">April 25, 2016</time> Â· <!-- -->5 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>I&#x27;d like you to close your eyes and imagine a scenario. You&#x27;re handed a prototype system. You&#x27;re told it works. It has no documentation. It has 0 unit tests. The hope is that you can take it on, refactor it, make it better and (crucially) not break it. Oh, and you don&#x27;t really understand what the code does or why it does it either; information on that front is, alas, sorely lacking.</p><p>This has happened to me; it&#x27;s alas not that unusual. The common advice handed out in this situation is: &quot;add unit tests before you change it&quot;. That&#x27;s good advice. We need to take the implementation that embodies the correctness of the system and create unit tests that set that implementation in stone. However, what say the system that you&#x27;re hoping to add tests to takes a number of large and complex inputs from some external source and produces a similarly large and complex output?</p><p>You could start with integration tests. They&#x27;re good but slow and crucially they depend upon the external inputs being available and unchanged (which is perhaps unlikely). What you could do (what I have done) is debug a working working system. At each point that an input is obtained I have painstakingly transcribed the data which allows me to subsequently hand code stub data. There comes a point when this is plainly untenable; it&#x27;s just too much data to transcribe. At this point the temptation is to think &quot;it&#x27;s okay; I can live without the tests. I&#x27;ll just be super careful with my refactoring... It&#x27;ll be fine It&#x27;ll be fine It&#x27;ll be fine It&#x27;ll be fine&quot;.</p><p>Actually, it probably won&#x27;t be fine. And even if it is (miracles do happen) you&#x27;re going to be fairly stressed as you wonder if you&#x27;ve been careful enough. What if there was another way? A way that wasn&#x27;t quite so hard but that allowed you to add tests without requiring 3 months hand coding....</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="instant-stubs">Instant Stubs<a aria-hidden="true" class="hash-link" href="#instant-stubs" title="Direct link to heading">â€‹</a></h2><p>What I&#x27;ve come up with is a super simple utility class for creating stubs / fakes. (I&#x27;m aware the naming of such things <a href="http://martinfowler.com/articles/mocksArentStubs.html" target="_blank" rel="noopener noreferrer">can be a little contentious</a>.)</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">using Newtonsoft.Json;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.IO;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace MakeFakeData.UnitTests</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public static class Stubs</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    private static JsonSerializer _serializer = new JsonSerializer { NullValueHandling = NullValueHandling.Ignore };</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public static void Make&lt;T&gt;(string stubPath, T data)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      try</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        if (string.IsNullOrEmpty(stubPath))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          throw new ArgumentNullException(nameof(stubPath));</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        if (data == null)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          throw new ArgumentNullException(nameof(data));</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        using (var sw = new StreamWriter(stubPath))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        using (var writer = new JsonTextWriter(sw) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Formatting = Formatting.Indented,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            IndentChar = &#x27; &#x27;,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Indentation = 2})</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          _serializer.Serialize(writer, data);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      catch (Exception exc)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        throw new Exception($&quot;Failed to make {stubPath}&quot;, exc);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public static T Load&lt;T&gt;(string stubPath)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      try</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        if (string.IsNullOrEmpty(stubPath))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          throw new ArgumentNullException(nameof(stubPath));</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        using (var file = File.OpenText(stubPath))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        using (var reader = new JsonTextReader(file))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          return _serializer.Deserialize&lt;T&gt;(reader);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      catch (Exception exc)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        throw new Exception($&quot;Failed to load {stubPath}&quot;, exc);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>As you can see this class uses <a href="http://www.newtonsoft.com/json" target="_blank" rel="noopener noreferrer">JSON.Net</a> and exposes 2 methods:</p><dl><dt>Make</dt><dd>Takes a given piece of data and uses JSON.Net to serialise it as JSON to a file. (nb I choose to format the JSON for readability and exclude null values; both totally optional)</dd><dt>Load</dt><dd>Takes the given path and loads the associated JSON file and deserialises it back into an object.</dd></dl><p>The idea is this: we take our working implementation and, wherever it extracts data from an external source, we insert a temporary statement like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">var data = _dataService.GetComplexData();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // Just inserted so we can generate the stub data...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Stubs.Make($&quot;{System.AppDomain.CurrentDomain.BaseDirectory}\\data.json&quot;, data);</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The next time you run the implementation you&#x27;ll find the app generates a <code>data.json</code> file containing the complex data serialized to JSON. Strip out your <code>Stubs.Make</code> statements from the implementation and we&#x27;re ready for the next stage.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="using-your-json">Using your JSON<a aria-hidden="true" class="hash-link" href="#using-your-json" title="Direct link to heading">â€‹</a></h2><p>What you need to do now is to take the new and shiny <code>data.json</code> file and move it to your unit test project. It needs to be included within the unit test project. Also, for each JSON file you have, the <code>Build Action</code> in VS needs to be set to <code>Content</code> and the <code>Copy to Output Directory</code> to <code>Copy if newer</code>.</p><p>Then within your unit tests you can write code like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ts"><pre tabindex="0" class="prism-code language-ts codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">var</span><span class="token plain"> dummyData </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token maybe-class-name">Stubs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token generic-function function" style="color:rgb(130, 170, 255)">Load</span><span class="token generic-function generic class-name operator" style="color:rgb(127, 219, 202)">&lt;</span><span class="token generic-function generic class-name maybe-class-name" style="color:rgb(255, 203, 139)">ComplexDataType</span><span class="token generic-function generic class-name operator" style="color:rgb(127, 219, 202)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Stubs/data.json&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Which pulls in your data from the JSON file and deserialises it into the original types. With this in hand you can plug together a unit test based on an existing implementation which depends on external data much faster than the hand-cranked method of old.</p><p>Finally, before the wildebeest of TDD descend upon me howling and wailing, let me say again; I anticipate this being useful when you&#x27;re trying to add tests to something that already exists but is untested. Clearly it would be better not to be in this situaion in the first place.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/unit-testing">unit testing</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/stub-data">stub data</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/json-net">json.net</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/mock-data">mock data</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Instant Stubs with JSON.Net (just add hot water)" href="/2016/04/25/instant-stubs-with-jsonnet"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2014/10/03/he-tasks-me-he-heaps-me-i-will-wreak">He tasks me; he heaps me.... I will wreak that MOQ upon him.</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2014-10-03T00:00:00.000Z" itemprop="datePublished">October 3, 2014</time> Â· <!-- -->4 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Enough with the horrific misquotes - this is about Moq and async (that&#x27;s my slight justification for robbing Herman Melville).</p><p>It&#x27;s pretty straightforward to use Moq to do async testing thanks to it&#x27;s marvellous <code>ReturnsAsync</code> method. That means it&#x27;s really easy to test a class that consumes an async API. Below is an example of a class that does just that: (it so happens that this class is a Web API controller but that&#x27;s pretty irrelevant to be honest)</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace Proverb.Web.Controllers</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // ISageService included inline for ease of explanation</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public interface ISageService</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        Task&lt;int&gt; DeleteAsync(int id);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class SageController : ApiController</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        ISageService _sageService;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public SageController(ISageService userService)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _sageService = userService;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public async Task&lt;IHttpActionResult&gt; Delete(int id)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            int deleteCount = await _sageService.DeleteAsync(id);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            if (deleteCount == 0)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return NotFound();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            else</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return Ok();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>To mock the <code>_sageService.DeleteAsync</code> method it&#x27;s as easy as this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace Proverb.Web.Tests.ASPNet.Controllers</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    [TestClass]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class SageControllerTests</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private Mock&lt;ISageService&gt; _sageServiceMock;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private SageController _controller;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [TestInitialize]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public void Initialise()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _sageServiceMock = new Mock&lt;ISageService&gt;();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _controller = new SageController(_sageServiceMock.Object);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [TestMethod]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public async Task Delete_returns_a_NotFound()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _sageServiceMock</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .Setup(x =&gt; x.DeleteAsync(_sage.Id))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .ReturnsAsync(0); // This makes me *so* happy...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            IHttpActionResult result = await _controller.Delete(_sage.Id);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var notFound = result as NotFoundResult;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Assert.IsNotNull(notFound);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _sageServiceMock.Verify(x =&gt; x.DeleteAsync(_sage.Id));</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [TestMethod]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public async Task Delete_returns_an_Ok()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _sageServiceMock</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .Setup(x =&gt; x.DeleteAsync(_sage.Id))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .ReturnsAsync(1); // I&#x27;m still excited now!</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            IHttpActionResult result = await _controller.Delete(_sage.Id);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var ok = result as OkResult;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Assert.IsNotNull(ok);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _sageServiceMock.Verify(x =&gt; x.DeleteAsync(_sage.Id));</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_31ik" id="but-wait-what-if-theres-like-nothing">But wait.... What if there&#x27;s like... Nothing?<a aria-hidden="true" class="hash-link" href="#but-wait-what-if-theres-like-nothing" title="Direct link to heading">â€‹</a></h2><p>Nope, I&#x27;m not getting into metaphysics. Something more simple. What if the <code>async</code> API you&#x27;re consuming returns just a <code>Task</code>? Not a <code>Task</code> of <code>int</code> but a simple old humble <code>Task</code>.</p><p>So to take our example we&#x27;re going from this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">public interface ISageService</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        Task&lt;int&gt; DeleteAsync(int id);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>To this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ts"><pre tabindex="0" class="prism-code language-ts codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">interface</span><span class="token plain"> </span><span class="token class-name maybe-class-name" style="color:rgb(255, 203, 139)">ISageService</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token maybe-class-name">Task</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:rgb(130, 170, 255)">DeleteAsync</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">int id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Your initial thought might be &quot;well that&#x27;s okay, I&#x27;ll just lop off the <code>ReturnsAsync</code> statements and I&#x27;m home free&quot;. That&#x27;s what I thought anyway.... And I was <!-- -->*<strong>WRONG</strong>*<!-- -->! A moments thought and you realise that there&#x27;s still a return type - it&#x27;s just <code>Task</code> now. What you want to do is something like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">_sageServiceMock</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .Setup(x =&gt; x.DeleteAsync(_sage.Id))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .ReturnsAsync(void); // This&#x27;ll definitely work... Probably</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>No it won&#x27;t - <code>void</code> is not a real type and much as you might like it to, this is not going to work.</p><p>So right now you&#x27;re thinking, well Moq probably has my back - it&#x27;ll have something like <code>ReturnsTask</code>, right? Wrong! It&#x27;s intentional it turns out - there&#x27;s a discussion on <a href="https://github.com/Moq/moq4/issues/117" target="_blank" rel="noopener noreferrer">GitHub about the issue</a>. And in that discussion there&#x27;s just what we need. We can use <code>Task.Delay</code> or <code>Task.FromResult</code> alongside Moq&#x27;s good old <code>Returns</code> method and we&#x27;re home free!</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="heres-one-i-made-earlier">Here&#x27;s one I made earlier...<a aria-hidden="true" class="hash-link" href="#heres-one-i-made-earlier" title="Direct link to heading">â€‹</a></h2><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace Proverb.Web.Controllers</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // ISageService again included inline for ease of explanation</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public interface ISageService</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        Task DeleteAsync(int id);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class SageController : ApiController</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        ISageService _sageService;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public SageController(ISageService userService)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _sageService = userService;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public async Task&lt;IHttpActionResult&gt; Delete(int id)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            await _sageService.DeleteAsync(id);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            return Ok();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace Proverb.Web.Tests.ASPNet.Controllers</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    [TestClass]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class SageControllerTests</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private Mock&lt;ISageService&gt; _sageServiceMock;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private SageController _controller;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        readonly Task TaskOfNowt = Task.Delay(0);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        // Or you could use this equally valid but slightly more verbose approach:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        //readonly Task TaskOfNowt = Task.FromResult&lt;object&gt;(null);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [TestInitialize]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public void Initialise()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _sageServiceMock = new Mock&lt;ISageService&gt;();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _controller = new SageController(_sageServiceMock.Object);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [TestMethod]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public async Task Delete_returns_an_Ok()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _sageServiceMock</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .Setup(x =&gt; x.DeleteAsync(_sage.Id))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .Returns(TaskOfNowt); // Feels good doesn&#x27;t it?</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            IHttpActionResult result = await _controller.Delete(_sage.Id);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var ok = result as OkResult;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Assert.IsNotNull(ok);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _sageServiceMock.Verify(x =&gt; x.DeleteAsync(_sage.Id));</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/unit-testing">unit testing</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/async">async</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/moq">MOQ</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/metaphysics">metaphysics</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about He tasks me; he heaps me.... I will wreak that MOQ upon him." href="/2014/10/03/he-tasks-me-he-heaps-me-i-will-wreak"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2014/03/17/the-surprisingly-happy-tale-of-visual">The Surprisingly Happy Tale of Visual Studio Online, Continous Integration and Chutzpah</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2014-03-17T00:00:00.000Z" itemprop="datePublished">March 17, 2014</time> Â· <!-- -->6 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_31ik" id="going-off-piste">Going off piste<a aria-hidden="true" class="hash-link" href="#going-off-piste" title="Direct link to heading">â€‹</a></h2><p>The post that follows is a slightly rambly affair which is pretty much my journal of the first steps of getting up and running with JavaScript unit testing. I will not claim that much of this blog is down to me. In fact in large part is me working my way through <a href="https://blogs.msdn.com/b/visualstudioalm/archive/2012/07/09/javascript-unit-tests-on-team-foundation-service-with-chutzpah.aspx" target="_blank" rel="noopener noreferrer">Mathew Aniyan&#x27;s excellent blog post on integrating Chutzpah with TFS</a>. But a few deviations from this post have made me think it worth keeping hold of this record for my benefit (if no-one else&#x27;s).</p><p>That&#x27;s the disclaimers out of the way now...</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="try-try-try-again">...Try, try, try again...<a aria-hidden="true" class="hash-link" href="#try-try-try-again" title="Direct link to heading">â€‹</a></h2><p>Getting started with JavaScript unit testing has not been the breeze Iâ€™d expected. Frankly Iâ€™ve found the docs out there not particularly helpful. But if at first you don&#x27;t succeed then try, try, try again.</p><p>So after a number of failed attempts Iâ€™m going to give it another go. <a href="http://www.hanselminutes.com/412/getting-started-with-javascript-unit-testing-with-jasmine-and-rushaine-mcbean" target="_blank" rel="noopener noreferrer">Rushaine McBean</a> says Jasmine is easiest so I&#x27;m going to follow her lead and give it a go.</p><p>Letâ€™s new up a new (empty) ASP.NET project. Yes, I know ASP.NET has nothing to do with JavaScript unit testing but my end goal is to be able to run JS unit tests in Visual Studio and as part of Continuous Integration. Further to that, I&#x27;m anticipating a future where I have a solution that contains JavaScript unit tests and C# unit tests as well. It is indeed a bold and visionary Brave New World. We&#x27;ll see how far we get.</p><p>First up, download Jasmine from <a href="http://jasmine.github.io/" target="_blank" rel="noopener noreferrer">GitHub</a> <!-- -->-<!-- --> I&#x27;ll use <a href="https://github.com/pivotal/jasmine/blob/master/dist/jasmine-standalone-2.0.0.zip" target="_blank" rel="noopener noreferrer">v2.0</a>. Unzip it and fire up SpecRunner.html and whaddya know... It works!</p><p><img src="https://4.bp.blogspot.com/-M-Qct1e8Ofo/UxiT5wHICLI/AAAAAAAAAiY/tHUQemETCGI/s320/LookItWorksRightOutTheBox.png"></p><p>As well it might. Iâ€™d be worried if it didnâ€™t. So Iâ€™ll move the contents of the release package into my empty project. Now letâ€™s see if we can get those tests running inside Visual Studio. Iâ€™d heard of <a href="https://chutzpah.codeplex.com/" target="_blank" rel="noopener noreferrer">Chutzpah</a> which describes itself thusly:</p><blockquote><p><em>â€œChutzpah is an open source JavaScript test runner which enables you to run unit tests using QUnit, Jasmine, Mocha, CoffeeScript and TypeScript.â€ </em></p></blockquote><p>What Iâ€™m after is the Chutzpah test adapter for Visual Studio 2012/2013 which can be found <a href="http://visualstudiogallery.msdn.microsoft.com/f8741f04-bae4-4900-81c7-7c9bfb9ed1fe" target="_blank" rel="noopener noreferrer">here</a>. I download the VSIX and install. Pretty painless. Once I restart Visual Studio I can see my unit tests in the test explorer. Nice! Run them and...</p><p><img src="https://2.bp.blogspot.com/-Ns9-ZoCzyxU/UxiVe83GQAI/AAAAAAAAAik/9rJiv7c3gOA/s320/EverythingFails.png"></p><p>All fail. This makes me sad. All the errors say â€œCanâ€™t find variable: Player in fileâ€. Hmmm. Why? Dammit Iâ€™m actually going to have to read the <a href="https://chutzpah.codeplex.com/wikipage?title=Chutzpah%20File%20References&amp;referringTitle=Documentation" target="_blank" rel="noopener noreferrer">documentation</a>... It turns out the issue can be happily resolved by adding these 3 references to the top of PlayerSpec.js:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">/// &lt;reference path=&quot;../src/Player.js&quot; /&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">/// &lt;reference path=&quot;../src/Song.js&quot; /&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">/// &lt;reference path=&quot;SpecHelper.js&quot; /&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now the tests pass:</p><p><img src="https://1.bp.blogspot.com/-n020yJN-tpA/UxiWLRegm5I/AAAAAAAAAis/TJHqYn08MZ4/s320/EverythingPasses.png"></p><p>The question is: can we get this working with Visual Studio Online?</p><p>Fortunately another has gone before me. Mathew Aniyan has written a <a href="https://blogs.msdn.com/b/visualstudioalm/archive/2012/07/09/javascript-unit-tests-on-team-foundation-service-with-chutzpah.aspx" target="_blank" rel="noopener noreferrer">superb blog post called &quot;Javascript Unit Tests on Team Foundation Service with Chutzpah&quot;</a>. Using this post as a guide (it was written 18 months ago which is frankly aeons in the world of the web) I&#x27;m hoping that I&#x27;ll be able to, without too many tweaks, get Javascript unit tests running on Team Foundation Service / Visual Studio Online ( / insert this weeks rebranding here).</p><p>First of all in Visual Studio Online Iâ€™ll create a new project called &quot;GettingStartedWithJavaScriptUnitTesting&quot; (using all the default options). Apparently <em>â€œYour project is created and your team is going to absolutely love this.â€</em> Hmmmm... I think Iâ€™ll be judge of that.</p><p>Let&#x27;s navigate to the project. I&#x27;ll fire up Visual Studio by clicking on the â€œOpen in Visual Studioâ€ link. Once fired up and all the workspace mapping is sorted Iâ€™ll move my project into the GettingStartedWithJavaScriptUnitTesting folder that now exists on my machine and add this to source control.</p><p>Back to Mathew&#x27;s blog. It suggests renaming Chutzpah.VS2012.vsix to Chutzpah.VS2012.zip and checking certain files into TFS. I think Chutzpah has changed a certain amount since this was written. To be on the safe side Iâ€™ll create a new folder in the root of my project called Chutzpah.VS2012 and put the contents of Chutzpah.VS2012.zip in there and add it to TFS (being careful to ensure that no dllâ€™s are excluded).</p><p>Then I&#x27;ll follow steps 3 and 4 from the blog post:</p><blockquote><p>*<!-- -->3<!-- -->.<!-- --> In Visual Studio, Open Team Explorer &amp; connect to Team Foundation Service. Bring up the Manage Build Controllers dialog. <!-- -->[Build â€“&gt; Manage Build Controllers]<!-- --> Select Hosted Build Controller Click on Properties button to bring up the Build Controller Properties dialog.</p><p>4<!-- -->.<!-- --> Change Version Control Path to custom Assemblies to refer to the folder where you checked in the binaries in step 2.</p><ul><li></li></ul></blockquote><p>In step 5 the blog tells me to edit my build definition. Well I donâ€™t have one in this new project so letâ€™s click on â€œNew Build Definitionâ€, create one and then follow step 5:</p><blockquote><p>*<!-- -->5<!-- -->.<!-- --> In Team Explorer, go to the Builds section and Edit your Build Definition which will run the javascript tests. Click on the Process tab Select the row named Automated Tests. Click on â€¦ button next to the value.</p><ul><li></li></ul></blockquote><p>Rather than following step 6 (which essentially nukes the running of any .NET tests you might have) I chose to add another row by clicking &quot;Add&quot;. In the dialog presented I changed the Test assembly specification to <!-- -->*<!-- -->*<!-- -->\<!-- -->*<!-- -->.js and checked the &quot;Fail build on test failure&quot; checkbox.</p><p><img src="https://3.bp.blogspot.com/-4lbMIsT9jFQ/Ux3ATwBrPgI/AAAAAAAAAjY/4XSY0u0RpOE/s320/AutomatedTests.png"></p><p>Step 7 says:</p><blockquote><p>*<!-- -->7<!-- -->.<!-- --> Create your Web application in Visual Studio and add your Qunit or Jasmine unit tests to them. <u>Make sure that the js files (that contain the tests) are getting copied to the build output directory.</u></p><ul><li></li></ul></blockquote><p>The picture below step 7 suggests that you should be setting your test / spec files to have a <code>Copy to Output Directory</code> setting of <code>Copy always</code>. <strong>This did not work for me!!!</strong> Instead, setting a <code>Build Action</code> of <code>Content</code> and a <code>Copy to Output Directory</code> setting of <code>Do not copy</code> did work.</p><p>Finally I checked everything into source control and queued a build. I honestly did not expect this to work. It couldnâ€™t be this easy could it? And...</p><p><img src="https://2.bp.blogspot.com/-gEDIyMV7M_g/Uxibt99tuwI/AAAAAAAAAi8/G4I6XQp0aN0/s320/ItOnlyBlimminWellWorked.png"></p><p>Wow! It did! Hereâ€™s me cynically expecting some kind of â€œpermission deniedâ€ error and it actually works! Brilliant! Look up in the cloud it says the same thing!</p><p><img src="https://2.bp.blogspot.com/-A67cTSkzIDg/Uxib6wVnaWI/AAAAAAAAAjE/ZwbUdBJmi0w/s320/InTheCloudToo.png"></p><p>Fantastic!</p><p>I realise that I havenâ€™t yet written a single JavaScript unit test of my own and so Iâ€™ve still a way to go. What I have done is quietened those voices in my head that said â€œthereâ€™s not too much point having a unit test suite that isnâ€™t plugged into continuous integrationâ€. Although it&#x27;s not documented here I&#x27;m happy to be able to report that I have been able to follow the self-same instructions for Team Foundation Service / Visual Studio Online and get CI working with TFS 2012 on our build server as well.</p><p>Having got up and running off the back of other peoples hard work I best try and write some of my own tests now....</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/jasmine">Jasmine</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/tfs">TFS</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/unit-testing">unit testing</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/javascript">javascript</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/continuous-integration">Continuous Integration</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about The Surprisingly Happy Tale of Visual Studio Online, Continous Integration and Chutzpah" href="/2014/03/17/the-surprisingly-happy-tale-of-visual"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2013/02/18/unit-testing-mvc-controllers-mocking">Unit testing MVC controllers / Mocking UrlHelper</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2013-02-18T00:00:00.000Z" itemprop="datePublished">February 18, 2013</time> Â· <!-- -->3 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_31ik" id="i-have-put-a-name-to-my-pain">I have put a name to my pain...<a aria-hidden="true" class="hash-link" href="#i-have-put-a-name-to-my-pain" title="Direct link to heading">â€‹</a></h2><p>And it is unit testing ASP.Net MVC controllers.</p><p>Well perhaps that&#x27;s unfair. I have no problem unit testing MVC controllers.... <strong>until</strong> it comes to making use of the &quot;innards&quot; of MVC. Let me be more specific. This week I had a controller action that I needed to test. It looked a little like this:</p><script src="https://gist.github.com/johnnyreilly/4959924.js?file=DemoController.cs"></script><p>Looks fine right? It&#x27;s an action that takes a simple object as an argument. That&#x27;s ok. It returns a JsonResult. No worries. The JsonResult consists of an anonymous class. De nada. The anonymous class has one property that is driven by the controllers <code>UrlHelper</code>. Yeah that shouldn&#x27;t be an issue... <strong>Hold your horses sunshine - you&#x27;re going nowhere!</strong></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="getting-disillusioned">Getting disillusioned<a aria-hidden="true" class="hash-link" href="#getting-disillusioned" title="Direct link to heading">â€‹</a></h2><p>Yup, the minute you start pumping in asserts around that <code>UrlHelper</code> driven property you&#x27;re going to be mighty disappointed. What, you didn&#x27;t expect the result to be <code>null</code>? Damn shame.</p><p>Despite <a href="http://msdn.microsoft.com/en-us/magazine/dd942838.aspx" target="_blank" rel="noopener noreferrer">articles</a> on MSDN about how the intention is for MVC to be deliberately testable the sad fact of the matter is that there is a yawning hole around the testing support for controllers in ASP.Net MVC. Whenever you try to test something that makes use of controller &quot;gubbins&quot; you have <strong>serious</strong> problems. And unfortunately I didn&#x27;t find anyone out there who could offer the whole solution.</p><p>After what I can best describe as a day of pain I found a way to scratch my particular itch. I found a way to write unit tests for controllers that made use of UrlHelper. As a bonus I managed to include the unit testing of Routes and Areas (well kind of) too.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="mvcmockcontrollers-updated">MvcMockControllers updated<a aria-hidden="true" class="hash-link" href="#mvcmockcontrollers-updated" title="Direct link to heading">â€‹</a></h2><p>This solution is heavily based on the work of Scott Hanselman who <a href="http://www.hanselman.com/blog/ASPNETMVCSessionAtMix08TDDAndMvcMockHelpers.aspx" target="_blank" rel="noopener noreferrer">wrote and blogged about <code>MvcMockHelpers</code></a> back in 2008. Essentially I&#x27;ve taken this and tweaked it so I could achieve my ends. My version of <code>MvcMockHelpers</code> looks a little like this:</p><script src="https://gist.github.com/johnnyreilly/4959924.js?file=MvcMockHelpers.cs"></script><h2 class="anchor anchorWithStickyNavbar_31ik" id="what-i-want-to-test">What I want to test<a aria-hidden="true" class="hash-link" href="#what-i-want-to-test" title="Direct link to heading">â€‹</a></h2><p>I want to be able to unit test the controller <code>Edit</code> method I mentioned earlier. This method calls the <code>Action</code> method on the controllers <code>Url</code> member (which is, in turn, a <code>UrlHelper</code>) to generate a URL for passing pack to the client. The URL generated should fit with the routing mechanism I have set up. In this case the route we expect a URL for was mapped by the following area registration:</p><script src="https://gist.github.com/johnnyreilly/4959924.js?file=DemoAreaRegistration.cs"></script><h2 class="anchor anchorWithStickyNavbar_31ik" id="enough-of-the-waffle---show-me-a-unit-test">Enough of the waffle - show me a unit test<a aria-hidden="true" class="hash-link" href="#enough-of-the-waffle---show-me-a-unit-test" title="Direct link to heading">â€‹</a></h2><p>Now to the meat; here&#x27;s a unit test which demonstrates how this is used:</p><script src="https://gist.github.com/johnnyreilly/4959924.js?file=UnitTestingAnAreaUsingUrlHelper.cs"></script><p>Let&#x27;s go through this unit test and breakdown what&#x27;s happening:</p><ol><li>Arrange</li><li>Act</li><li>Assert</li></ol><p>The most interesting thing you&#x27;ll note is the controller&#x27;s UrlHelper is now generating a URL as we might have hoped. The URL is generated making use of our routing, yay! Finally we&#x27;re also managing to unit test a route registered by our area.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/mvc">MVC</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/unit-testing">unit testing</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/area-registration-register-all-areas">AreaRegistration.RegisterAllAreas()</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/moq">MOQ</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/url-helper">UrlHelper</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Unit testing MVC controllers / Mocking UrlHelper" href="/2013/02/18/unit-testing-mvc-controllers-mocking"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2012/10/03/unit-testing-and-entity-framework-filth">Unit Testing and Entity Framework: The Filth and the Fury</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2012-10-03T00:00:00.000Z" itemprop="datePublished">October 3, 2012</time> Â· <!-- -->8 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Just recently I&#x27;ve noticed that there appears to be something of a controversy around Unit Testing and Entity Framework. I first came across it as I was Googling around for useful posts on using MOQ in conjunction with EF. I&#x27;ve started to notice the topic more and more and as I have mixed feelings on the subject (that is to say I don&#x27;t have a settled opinion) I thought I&#x27;d write about this and see if I came to any kind of conclusion...</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="the-setup">The Setup<a aria-hidden="true" class="hash-link" href="#the-setup" title="Direct link to heading">â€‹</a></h2><p>It started as I was working on a new project. We were using ASP.NET MVC 3 and Entity Framework with DbContext as our persistence layer. Rather than crowbarring the tests in afterwards the intention was to write tests to support the ongoing development. Not quite test driven development but certainly <a href="http://blog.troyd.net/Test+Supported+Development+TSD+Is+NOT+Test+Driven+Development+TDD.aspx" target="_blank" rel="noopener noreferrer">test supported development</a>. (Let&#x27;s not get into the internecine conflict as to whether this is black belt testable code or not - it isn&#x27;t but he who pays the piper etc.) Oh and we were planning to use MOQ as our mocking library.</p><p>It was the first time I&#x27;d used DbContext rather than ObjectContext and so I thought I&#x27;d do a little research on how people were using DbContext with regards to testability. I had expected to find that there was some kind of consensus and an advised way forwards. I didn&#x27;t get that at all. Instead I found a number of conflicting opinions.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="using-the-repository--unit-of-work-patterns">Using the Repository / Unit of Work Patterns<a aria-hidden="true" class="hash-link" href="#using-the-repository--unit-of-work-patterns" title="Direct link to heading">â€‹</a></h2><p>One thread of advice that came out was that people advised using the Repository / Unit of Work patterns as wrappers when it came to making testable code. This is kind of interesting in itself as to the best of my understanding ObjectSet / ObjectContext and DbSet / DbContext are both in themselves implementations of the Repository / Unit of Work patterns. So the advice was to build a Repository / Unit of Work pattern to wrap an existing Repository / Unit of Work pattern.</p><p>Not as mad as it sounds. The reason for the extra abstraction is that ObjectContext / DbContext in the raw are not MOQ-able.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="or-maybe-im-wrong-maybe-you-can-moq-dbcontext">Or maybe I&#x27;m wrong, maybe you can MOQ DbContext?<a aria-hidden="true" class="hash-link" href="#or-maybe-im-wrong-maybe-you-can-moq-dbcontext" title="Direct link to heading">â€‹</a></h2><p>No you can&#x27;t. Well that&#x27;s not true. You can and it&#x27;s documented <a href="http://romiller.com/2012/02/14/testing-with-a-fake-dbcontext/" target="_blank" rel="noopener noreferrer">here</a> but there&#x27;s a &quot;but&quot;. You need to be using Entity Frameworks Code First approach; actually coding up your DbContext yourself. Before I&#x27;d got on board the project had already begun and we were already some way down the road of using the Database First approach. So this didn&#x27;t seem to be a go-er really.</p><p>The best article I found on testability and Entity Framework was <a href="http://msdn.microsoft.com/en-us/library/ff714955.aspx" target="_blank" rel="noopener noreferrer">this one</a> by <a href="http://odetocode.com/" target="_blank" rel="noopener noreferrer">K. Scott Allen</a> which essentially detailed how you could implement the Repository / Unit of Work patterns on top of ObjectSet / ObjectContext. In the end I adapted this to do the same thing sat on top of DbSet / DbContext instead.</p><p>With this in place I had me my testable code. I was quite happy with this as it seemed quite intelligible. My new approach looked similar to the existing DbSet / DbContext code and so there wasn&#x27;t a great deal of re-writing to do. Sorted, right?</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="here-come-the-nagging-doubts">Here come the nagging doubts...<a aria-hidden="true" class="hash-link" href="#here-come-the-nagging-doubts" title="Direct link to heading">â€‹</a></h2><p>I did wonder, given that I found a number of articles about applying the Repository / Unit of Work patterns on top of ObjectSet / ObjectContext that there didn&#x27;t seem to be many examples to do the same for DbSet / DbContext. (I did find a few examples of this but none that felt satisfactory to me for a variety of reasons.) This puzzled me.</p><p>I also started to notice that a 1 man war was being waged against the approach I was using by <a href="http://www.ladislavmrnka.com/about/" target="_blank" rel="noopener noreferrer">Ladislav Mrnka</a>. Here are a couple of examples of his crusade:</p><ul><li><a href="http://stackoverflow.com/a/6904479/761388" target="_blank" rel="noopener noreferrer">An answer on StackOverflow</a> (there&#x27;s quite a few similar answers around on StackOverflow saying similar)</li><li><a href="http://romiller.com/2012/02/14/testing-with-a-fake-dbcontext/#div-comment-1620" target="_blank" rel="noopener noreferrer">A comment on Rowan Millers post about fake DbContexts</a></li></ul><p>Ladislav is quite strongly of the opinion that wrapping DbSet / DbContext (and I presume ObjectSet / ObjectContext too) in a further Repository / Unit of Work is an antipattern. To quote him: <em>&quot;The reason why I donâ€™t like it is leaky abstraction in Linq-to-entities queries ... In your test you have Linq-to-Objects which is superset of Linq-to-entities and only subset of queries written in L2O is translatable to L2E&quot;</em>. It&#x27;s worth looking at <a href="http://www.youtube.com/watch?v=gNeSZYke-_Q" target="_blank" rel="noopener noreferrer">Jon Skeets explanation of &quot;leaky abstractions&quot;</a> which he did for TekPub.</p><p>As much as I didn&#x27;t want to admit it - I have come to the conclusion Ladislav probably has a point for a number of reasons:</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="1-just-because-it-compiles-and-passes-unit-tests-dont-imagine-that-means-it-works">1<!-- -->.<!-- --> Just because it compiles and passes unit tests don&#x27;t imagine that means it works...<a aria-hidden="true" class="hash-link" href="#1-just-because-it-compiles-and-passes-unit-tests-dont-imagine-that-means-it-works" title="Direct link to heading">â€‹</a></h3><p>Unfortunately, a LINQ query that looks right, compiles and has passing unit tests written for it doesn&#x27;t necessarily work. You can take a query that fails when executed against Entity Framework and come up with test data that will pass that unit test. As Ladislav rightly points out: <code>LINQ-to-Objects != LINQ-to-Entities</code>.</p><p>So in this case unit tests of this sort don&#x27;t provide you with any security. What you need are <!-- -->*<!-- -->*<u>integration</u></p><p>*<!-- -->*<!-- --> tests. Tests that run against an instance of the database and demonstrate that LINQ will actually translate queries / operations into valid SQL.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="2-complex-queries">2<!-- -->.<!-- --> Complex queries<a aria-hidden="true" class="hash-link" href="#2-complex-queries" title="Direct link to heading">â€‹</a></h3><p>You can write some pretty complex LINQ queries if you want. This is made particularly easy if you&#x27;re using <a href="https://blogs.msdn.com/b/ericlippert/archive/2009/12/07/query-transformations-are-syntactic.aspx" target="_blank" rel="noopener noreferrer">comprehension syntax</a>. Whilst these queries may be simple to write it can be uphill work to generate test data to satisfy this. So much so that at times it can feel you&#x27;ve made a rod for your own back using this approach.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="3-lazy-loading">3<!-- -->.<!-- --> Lazy Loading<a aria-hidden="true" class="hash-link" href="#3-lazy-loading" title="Direct link to heading">â€‹</a></h3><p>By default Entity Framework employs lazy loading. This a useful approach which reduces the amount of data that is transported. Sometimes this approach forces you to specify up front if you require a particular entity through use of <code>Include</code> statements. This again doesn&#x27;t lend itself to testing particularly well.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="where-does-this-leave-us">Where does this leave us?<a aria-hidden="true" class="hash-link" href="#where-does-this-leave-us" title="Direct link to heading">â€‹</a></h2><p>Having considered all of the above for a while and tried out various different approaches I think I&#x27;m coming to the conclusion that Ladislav is probably right. Implementing the Repository / Unit of Work patterns on top of ObjectSet / ObjectContext or DbSet / DbContext doesn&#x27;t seem a worthwhile effort in the end.</p><p>So what&#x27;s a better idea? I think that in the name of simplicity you might as well have a simple class which wraps all of your Entity Framework code. This class could implement an interface and hence be straightforwardly MOQ-able (or alternatively all methods could be virtual and you could forego the interface). Along with this you should have integration tests in place which test the execution of the actual Entity Framework code against a test database.</p><p>Now I should say this approach is not necessarily my final opinion. It seems sensible and practical. I think it is likely to simplify the tests that are written around a project. It will certainly be more reliable than just having unit tests in place.</p><p>In terms of the project I&#x27;m working on at the moment we&#x27;re kind of doing this in a halfway house sense. That is to say, we&#x27;re still using our Repository / Unit of Work wrappers for DbSet / DbContext but where things move away from simple operations we&#x27;re adding extra methods to our Unit of Work class or Repository classes which wrap this functionality and then testing it using our integration tests.</p><p>I&#x27;m open to the possibility that my opinion may be modified further. And I&#x27;d be very interested to know what other people think on the subject.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="update">Update<a aria-hidden="true" class="hash-link" href="#update" title="Direct link to heading">â€‹</a></h2><p>It turns out that I&#x27;m not alone in thinking about this issue and indeed others have expressed this rather better than me - take a look at Jimmy Bogard&#x27;s post for an example: <a href="http://lostechies.com/jimmybogard/2012/09/20/limiting-your-abstractions/" target="_blank" rel="noopener noreferrer">http://lostechies.com/jimmybogard/2012/09/20/limiting-your-abstractions/</a>.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="update-2">Update 2<a aria-hidden="true" class="hash-link" href="#update-2" title="Direct link to heading">â€‹</a></h2><p>I&#x27;ve also recently watched the following Pluralsight course by Julie Lerman: <a href="http://pluralsight.com/training/Courses/TableOfContents/efarchitecture#efarchitecture-m3-archrepo" target="_blank" rel="noopener noreferrer">http://pluralsight.com/training/Courses/TableOfContents/efarchitecture#efarchitecture-m3-archrepo</a>. In this course Julie talks about different implementations of the Repository and Unit of Work patterns in conjunction with Entity Framework. Julie is in favour of using this approach but in this module she elaborates on different &quot;flavours&quot; of these patterns that you might want to use for different reasons (bounded contexts / reference contexts etc). She makes a compelling case and helpfully she is open enough to say that this a point of contention in the community. At the end of watching this I think I felt happy that our &quot;halfway house&quot; approach seems to fit and seems to work. More than anything else Julie made clear that there isn&#x27;t one definitively &quot;true&quot; approach. Rather many different but similar approaches for achieving the same goal. Good stuff Julie!</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/unit-testing">unit testing</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/entity-framework">Entity Framework</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/anti-pattern">anti-pattern</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/moq">MOQ</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Unit Testing and Entity Framework: The Filth and the Fury" href="/2012/10/03/unit-testing-and-entity-framework-filth"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2012/04/16/simple-technique-for-initialising">A Simple Technique for Initialising Properties with Internal Setters for Unit Testing</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2012-04-16T00:00:00.000Z" itemprop="datePublished">April 16, 2012</time> Â· <!-- -->6 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>I was recently working with my colleagues on refactoring a legacy application. We didn&#x27;t have an immense amount of time available for this but the plan was to try and improve what was there as much as possible. In its initial state the application had no unit tests in place at all and so the plan was to refactor the code base in such a way as to make testing it a realistic proposition. To that end the <a href="http://en.wikipedia.org/wiki/Domain_layer" target="_blank" rel="noopener noreferrer">domain layer</a> was being heavily adjusted and the GUI was being migrated from WebForms to MVC 3. The intention was to build up a pretty solid collection of unit tests. However, as we were working on this we realised we had a problem with properties on our models with <a href="http://msdn.microsoft.com/en-us/library/7c5ka91b(v=vs.80).aspx" target="_blank" rel="noopener noreferrer"><code>internal</code></a> setters...</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="background">Background<a aria-hidden="true" class="hash-link" href="#background" title="Direct link to heading">â€‹</a></h2><p>The entities of the project in question used an approach which would store pertinent bits of <a href="http://en.wikipedia.org/wiki/Database_normalization" target="_blank" rel="noopener noreferrer">normalised</a> data for read-only purposes in related entities. I&#x27;ve re-read that sentence and realise it&#x27;s as clear as mud. Here is an example to clarify:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">public class Person</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public int Id { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public string FirstName { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public string LastName { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public string Address { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public DateTime DateOfBirth { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  /* Other fascinating properties... */</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">public class Order</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public int Id { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public string ProductOrdered { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public string OrderedById { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public string OrderedByFirstName { get; internal set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public string OrderedByLastName { get; internal set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In the example above you have 2 types of entity: <code>Person</code> and <code>Order</code>. The <code>Order</code> entity makes use of the the <code>Id</code>, <code>FirstName</code> and <code>LastName</code> properties of the <code>Person</code> entity in the properties <code>OrderedById</code>, <code>OrderedByFirstName</code> and <code>OrderedByLastName</code>. For persistence (ie saving to the database) purposes the only necessary <code>Person</code> property is <code>OrderedById</code> identity. <code>OrderedByFirstName</code> and <code>OrderedByLastName</code> are just &quot;nice to haves&quot; - essentially present to make implementing the GUI more straightforward.</p><p>To express this behaviour / intention in the object model the setters for <code>OrderedByFirstName</code> and <code>OrderedByLastName</code> are marked as <code>internal</code>. The implication of this is that properties like this can only be initialised within the current assembly - or any explicitly associated &quot;friend&quot; assemblies. In practice this meant that internally set properties were only populated when an object was read in from the database. It wasn&#x27;t possible to set these properties in other assemblies which meant less code was written (<u>a good thing</u></p><p>) - after all, why set a property when you don&#x27;t need to?</p><p>Background explanation over. It may still be a little unclear but I hope you get the gist.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="whats-our-problem">What&#x27;s our problem?<a aria-hidden="true" class="hash-link" href="#whats-our-problem" title="Direct link to heading">â€‹</a></h2><p>I was writing unit tests for the controllers in our main web application and was having problems with my arrangements. I was mocking the database calls in my controllers much in the manner that you might expect:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ts"><pre tabindex="0" class="prism-code language-ts codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// Arrange</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">var</span><span class="token plain"> orderDb </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">new</span><span class="token plain"> </span><span class="token class-name maybe-class-name" style="color:rgb(255, 203, 139)">Mock</span><span class="token class-name operator" style="color:rgb(127, 219, 202)">&lt;</span><span class="token class-name maybe-class-name" style="color:rgb(255, 203, 139)">IOrderDb</span><span class="token class-name operator" style="color:rgb(127, 219, 202)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  orderDb</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access maybe-class-name" style="color:rgb(130, 170, 255)">Setup</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">x </span><span class="token arrow operator" style="color:rgb(127, 219, 202)">=&gt;</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access maybe-class-name" style="color:rgb(130, 170, 255)">GetOrder</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token maybe-class-name">It</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token generic-function function" style="color:rgb(130, 170, 255)">IsAny</span><span class="token generic-function generic class-name operator" style="color:rgb(127, 219, 202)">&lt;</span><span class="token generic-function generic class-name" style="color:rgb(255, 203, 139)">int</span><span class="token generic-function generic class-name operator" style="color:rgb(127, 219, 202)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access maybe-class-name" style="color:rgb(130, 170, 255)">Returns</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="color:rgb(127, 219, 202)">new</span><span class="token plain"> </span><span class="token class-name maybe-class-name" style="color:rgb(255, 203, 139)">Order</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token maybe-class-name">Id</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">123</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token maybe-class-name">ProductOrdered</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Packet of coffee&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token maybe-class-name">OrderedById</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">987456</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token maybe-class-name">OrderedByFirstName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;John&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token maybe-class-name">OrderedByLastName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Reilly&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>All looks fine doesn&#x27;t it? It&#x27;s not. Because <code>OrderedByFirstName</code> and <code>OrderedByLastName</code> have internal setters we are <u>unable</u></p><p>to initialise them from within the context of our test project. So what to do?</p><p>We toyed with 3 approaches and since each has merits I thought it worth going through each of them:</p><ol><li><p>To the MOQumentation Batman!: <a href="http://code.google.com/p/moq/wiki/QuickStart" target="_blank" rel="noopener noreferrer">http://code.google.com/p/moq/wiki/QuickStart</a>! Looking at the MOQ documentation it states the following:</p><p><em>Mocking internal types of another project: add the following assembly attributes (typically to the AssemblyInfo.cs) to the project containing the internal types:</em></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">// This assembly is the default dynamic assembly generated Castle DynamicProxy,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// used by Moq. Paste in a single line.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">[assembly:InternalsVisibleTo(&quot;DynamicProxyGenAssembly2,PublicKey=0024000004800000940000000602000000240000525341310004000001000100c547cac37abd99c8db225ef2f6c8a3602f3b3606cc9891605d02baa56104f4cfc0734aa39b93bf7852f7d9266654753cc297e7d2edfe0bac1cdcf9f717241550e0a7b191195b7667bb4f64bcb8e2121380fd1d9d46ad2d92d2d15605093924cceaf74c4861eff62abf69b9291ed0a340e113be11e6a7d3113e92484cf7045cc7&quot;)]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">[assembly: InternalsVisibleTo(&quot;The.NameSpace.Of.Your.Unit.Test&quot;)] //I&#x27;d hope it was shorter than that...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This looked to be exactly what we needed and in most situations it would make sense to go with this. Unfortunately for us there was a gotcha. Certain core shared parts of our application platform were <a href="http://en.wikipedia.org/wiki/Global_Assembly_Cache" target="_blank" rel="noopener noreferrer">GAC</a>&#x27;d. A requirement for GAC-ing an assembly is that it is <a href="http://msdn.microsoft.com/en-us/library/xc31ft41.aspx" target="_blank" rel="noopener noreferrer">signed</a>.</p><p>The upshot of this was that if we wanted to use the <code>InternalsVisibleTo</code> approach then we would need to sign our web application test project. We weren&#x27;t particularly averse to that and initially did so without much thought. It was then we remembered that every assembly referenced by a signed assembly must also be signed as well. We didn&#x27;t really want to sign our main web application purely for testing purposes. We could and if there weren&#x27;t viable alternatives we well might have. But it just seemed like the wrong reason to be taking that decision. Like using a sledgehammer to crack a nut.</p></li><li><p>The next approach we took was using mock objects. Instead of using our objects straight we would mock them as below:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">//Create mock and set internal properties</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      var orderMock = new Mock&lt;Order&gt;();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      orderMock.SetupGet(x =&gt; x.OrderedByFirstName).Returns(&quot;John&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      orderMock.SetupGet(x =&gt; x.OrderedByLastName).Returns(&quot;Reilly&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      //Set up standard properties</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      orderMock.SetupAllProperties();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      var orderStub = orderMock.Object;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      orderStub.Id = 123;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      orderStub.ProductOrdered = &quot;Packet of coffee&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      orderStub.OrderedById = 987456;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now this approach worked fine but had a couple of snags:</p><ul><li><p>As you can see it&#x27;s pretty verbose and much less clear to read than it was previously.</p></li><li><p>It required that we add the <code>virtual</code> keyword to all our internally set properties like so:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">public class Order</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  // ....</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public virtual string OrderedByFirstName { get; internal set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public virtual string OrderedByLastName { get; internal set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Our standard constructor already initialised the value of our internally set properties. So adding <code>virtual</code> to the internally set properties generated <a href="http://www.jetbrains.com/resharper/" target="_blank" rel="noopener noreferrer">ReSharper</a> warnings aplenty about virtual properties being initialised in the constructor. Fair enough.</p></li></ul><p>Because of the snags it still felt like we were in nutcracking territory...</p></li><li><p>... and this took us to the approach that we ended up adopting: a special mocking constructor for each class we wanted to test, for example:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">/// &lt;summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">/// Mocking constructor used to initialise internal properties</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">/// &lt;/summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">public Order(string orderedByFirstName = null, string orderedByLastName = null)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">: this()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">OrderedByFirstName = orderedByFirstName;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">OrderedByLastName = orderedByLastName;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Thanks to the ever lovely <a href="http://msdn.microsoft.com/en-us/library/dd264739.aspx" target="_blank" rel="noopener noreferrer">Named and Optional Arguments</a> feature of C# combined with <a href="http://msdn.microsoft.com/en-us/library/bb397680.aspx" target="_blank" rel="noopener noreferrer">Object Initializers</a> it meant it was possible to write quite expressive, succinct code using this approach; for example:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">var order = new Order(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        orderedByFirstName: &quot;John&quot;,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        orderedByLastName: &quot;Reilly&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      )</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        Id = 123,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        ProductOrdered = &quot;Packet of coffee&quot;,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        OrderedById = 987456</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      };</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Here we&#x27;re calling the mocking constructor to set the internally set properties and subsequently initialising the other properties using the object initialiser mechanism.</p><p>Implementing these custom constructors wasn&#x27;t a massive piece of work and so we ended up settling on this technique for initialising internal properties.</p></li></ol></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/unit-testing">unit testing</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/internals-visible-to">InternalsVisibleTo</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/moq">MOQ</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/mocking">mocking</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about A Simple Technique for Initialising Properties with Internal Setters for Unit Testing" href="/2012/04/16/simple-technique-for-initialising"><b>Read More</b></a></div></footer></article></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Support me</div><ul class="footer__items"><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li><li class="footer__item"><div style="display: flex; align-items: center;"><iframe src="https://github.com/sponsors/johnnyreilly/button" title="Sponsor johnnyreilly" height="35" width="116" style="border: 0;"></iframe><div>&nbsp;on GitHub</div></div></li></ul></div><div class="col footer__col"><div class="footer__title">Feeds</div><ul class="footer__items"><li class="footer__item"><a href="https://blog.johnnyreilly.com/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>RSS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://blog.johnnyreilly.com/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Atom<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.89fbb0b4.js"></script>
<script src="/assets/js/main.14ca547e.js"></script>
</body>
</html>