<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=297675200"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","297675200",{})</script>
<link rel="icon" href="/img/favicon/profile.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#3578e5">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/favicon/apple-touch-icon.png"><title data-react-helmet="true">2 posts tagged with &quot;yarn&quot; | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="2 posts tagged with &quot;yarn&quot; | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://blog.johnnyreilly.com/img/profile.jpg"><meta data-react-helmet="true" name="twitter:image" content="https://blog.johnnyreilly.com/img/profile.jpg"><meta data-react-helmet="true" property="og:url" content="https://blog.johnnyreilly.com/tags/yarn"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-react-helmet="true" name="robots" content="max-image-preview:large"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.johnnyreilly.com/tags/yarn"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/yarn" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/yarn" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.85320736.css">
<link rel="preload" href="/assets/js/runtime~main.43c338b2.js" as="script">
<link rel="preload" href="/assets/js/main.b6be8dcb.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">I CAN MAKE THIS WORK</b></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/archive">Blog Archive</a><a class="navbar__item navbar__link" href="/talks">Talks</a></div><div class="navbar__items navbar__items--right"><a href="https://polywork.johnnyreilly.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Polywork<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">üåú</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">üåû</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_q+wC thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_9G5K margin-bottom--md">Recent posts</div><ul class="sidebarItemList_6T4b"><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/2021/12/28/azure-cli-show-query-output-properties">Query deployment outputs with the Azure CLI</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/2021/12/27/azure-container-apps-build-and-deploy-with-bicep-and-github-actions">Azure Container Apps: build and deploy with Bicep and GitHub Actions</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/2021/12/19/azure-container-apps-bicep-and-github-actions">Azure Container Apps, Bicep and GitHub Actions</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/2021/12/12/open-graph-sharing-previews-guide">Open Graph: a guide to sharable social media previews</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/2021/12/05/azure-static-web-app-deploy-previews-with-azure-devops">Azure Static Web App Deploy Previews with Azure DevOps</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>2 posts tagged with &quot;yarn&quot;</h1><a href="/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_d4p0" itemprop="headline"><a itemprop="url" href="/2019/06/07/typescript-webpack-you-down-with-pnp">TypeScript / webpack - you down with PnP? Yarn, you know me!</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2019-06-07T00:00:00.000Z" itemprop="datePublished">June 7, 2019</time> ¬∑ <!-- -->6 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Yarn PnP is an innovation by the Yarn team designed to speed up module resolution by node. To quote the <a href="https://yarnpkg.com/en/docs/pnp" target="_blank" rel="noopener noreferrer">(excellent) docs</a>:</p><blockquote><p>Plug‚Äôn‚ÄôPlay is an alternative installation strategy unveiled in September 2018...</p><p>The way regular installs work is simple: Yarn generates a <code>node_modules</code> directory that Node is then able to consume. In this context, Node doesn‚Äôt know the first thing about what a package is: it only reasons in terms of files. ‚ÄúDoes this file exist here? No? Let‚Äôs look in the parent <code>node_modules</code> then. Does it exist here? Still no? Too bad‚Ä¶ parent folder it is!‚Äù - and it does this until it matches something that matches one of the possibilities. That‚Äôs vastly inefficient.</p><p>When you think about it, Yarn knows everything about your dependency tree - it evens installs it! So why is Node tasked with locating your packages on the disk? Why don‚Äôt we simply query Yarn, and let it tell us where to look for a package X required by a package Y? That‚Äôs what Plug‚Äôn‚ÄôPlay (abbreviated PnP) is. Instead of generating a node_modules directory and leaving the resolution to Node, we now generate a single .pnp.js file and let Yarn tell us where to find our packages.</p></blockquote><p>Yarn has been worked upon, amongst others, by the excellent <a href="https://twitter.com/arcanis" target="_blank" rel="noopener noreferrer">Ma√´l Nison</a>. You can hear him talking about it in person <a href="https://youtu.be/XePfzVs852s" target="_blank" rel="noopener noreferrer">in this talk at JSConfEU</a>.</p><p>Thanks particularly to Ma√´l&#x27;s work, it&#x27;s possible to use Yarn PnP with TypeScript using webpack with <code>ts-loader</code> <em>and</em><code>fork-ts-checker-webpack-plugin</code>. This post intends to show you just how simple it is to convert a project that uses either to work with Yarn PnP.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="vanilla-ts-loader">Vanilla <code>ts-loader</code><a class="hash-link" href="#vanilla-ts-loader" title="Direct link to heading">‚Äã</a></h2><p>Your project is built using standalone <code>ts-loader</code>; i.e. a simple setup that handles both transpilation and type checking.</p><p>First things first, add this property to your <code>package.json</code>: (this is only required if you are using Yarn 1; this tag will be optional starting from the v2, where projects will switch to PnP by default.)</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    &quot;installConfig&quot;: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        &quot;pnp&quot;: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Also, because this is webpack, we&#x27;re going to need to add an extra dependency in the form of <code>pnp-webpack-plugin</code>:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">yarn add -D pnp-webpack-plugin</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>To quote the excellent docs, make the following amends to your <code>webpack.config.js</code>:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">const PnpWebpackPlugin = require(`pnp-webpack-plugin`);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">module.exports = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    module: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        rules: [{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            test: /\.ts$/,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            loader: require.resolve(&#x27;ts-loader&#x27;),</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            options: PnpWebpackPlugin.tsLoaderOptions(),</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }],</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    resolve: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        plugins: [ PnpWebpackPlugin, ],</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    resolveLoader: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        plugins: [ PnpWebpackPlugin.moduleLoader(module), ],</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">};</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>If you have any options you want to pass to <code>ts-loader</code>, just pass them as parameter of <code>pnp-webpack-plugin</code>&#x27;s <code>tsLoaderOptions</code> function and it will take care of forwarding them properly. Behind the scenes the <code>tsLoaderOptions</code> function is providing <code>ts-loader</code> with the options necessary to switch into Yarn PnP mode.</p><p>Congratulations; you now have <code>ts-loader</code> functioning with Yarn PnP support!</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="fork-ts-checker-webpack-plugin-with-ts-loader"><code>fork-ts-checker-webpack-plugin</code> with <code>ts-loader</code><a class="hash-link" href="#fork-ts-checker-webpack-plugin-with-ts-loader" title="Direct link to heading">‚Äã</a></h2><p>You may well be using <code>fork-ts-checker-webpack-plugin</code> to handle type checking whilst <code>ts-loader</code> gets on with the transpilation. This workflow is also supported using <code>pnp-webpack-plugin</code>. You&#x27;ll have needed to follow the same steps as the <code>ts-loader</code> setup. It&#x27;s just the <code>webpack.config.js</code> tweaks that will be different.</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">const PnpWebpackPlugin = require(`pnp-webpack-plugin`);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">module.exports = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    plugins: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        new ForkTsCheckerWebpackPlugin(PnpWebpackPlugin.forkTsCheckerOptions({</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            useTypescriptIncrementalApi: false, // not possible to use this until: https://github.com/microsoft/TypeScript/issues/31056</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        })),</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    module: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        rules: [{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            test: /\.ts$/,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            loader: require.resolve(&#x27;ts-loader&#x27;),</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            options: PnpWebpackPlugin.tsLoaderOptions({ transpileOnly: true }),</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }],</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    resolve: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        plugins: [ PnpWebpackPlugin, ],</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    resolveLoader: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        plugins: [ PnpWebpackPlugin.moduleLoader(module), ],</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">};</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Again if you have any options you want to pass to <code>ts-loader</code>, just pass them as parameter of <code>pnp-webpack-plugin</code>&#x27;s <code>tsLoaderOptions</code> function. As we&#x27;re using <code>fork-ts-checker-webpack-plugin</code> we&#x27;re going to want to stop <code>ts-loader</code> doing type checking with the <code>transpileOnly: true</code> option.</p><p>We&#x27;re now initialising <code>fork-ts-checker-webpack-plugin</code> with <code>pnp-webpack-plugin</code>&#x27;s <code>forkTsCheckerOptions</code> function. Behind the scenes the <code>forkTsCheckerOptions</code> function is providing the <code>fork-ts-checker-webpack-plugin</code> with the options necessary to switch into Yarn PnP mode.</p><p>And that&#x27;s it! You now have <code>ts-loader</code> and <code>fork-ts-checker-webpack-plugin</code> functioning with Yarn PnP support!</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="living-on-the-bleeding-edge">Living on the Bleeding Edge<a class="hash-link" href="#living-on-the-bleeding-edge" title="Direct link to heading">‚Äã</a></h2><p>Whilst you can happily develop and build using Yarn PnP, it&#x27;s worth bearing in mind that this is a new approach. As such, there&#x27;s some rough edges right now.</p><p>If you&#x27;re interested in Yarn PnP, it&#x27;s worth taking the v2 of Yarn (Berry) for a spin. You can find it here: <a href="https://github.com/yarnpkg/berry" target="_blank" rel="noopener noreferrer">https://github.com/yarnpkg/berry</a>. It&#x27;s where most of the Yarn PnP work happens, and it includes zip loading - two birds, one stone!</p><p>Because there isn&#x27;t first class support for Yarn PnP in TypeScript itself yet, you cannot make use of the Watch API through <code>fork-ts-checker-webpack-plugin</code>. (You can read about that issue <a href="https://github.com/microsoft/TypeScript/issues/31056" target="_blank" rel="noopener noreferrer">here</a>)</p><p>As you&#x27;ve likely noticed, the webpack configuration required makes for a noisy <code>webpack.config.js</code>. Further to that, VS Code (which is powered by TypeScript remember) has no support for Yarn PnP yet and so will present resolution errors to you. If you can ignore the sea of red squigglies all over your source files in the editor and just look at your webpack build you&#x27;ll be fine.</p><p>There is a tool called <code>PnPify</code> that adds support for PnP to TypeScript (in particular tsc). You can find more information here: <a href="https://yarnpkg.github.io/berry/advanced/pnpify" target="_blank" rel="noopener noreferrer">https://yarnpkg.github.io/berry/advanced/pnpify</a>. For tsc it would be:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">$&gt; yarn pnpify tsc [...]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The gist is that it simulates the existence of <code>node_modules</code> by leveraging the data from the PnP file. As such it&#x27;s not a perfect fix (<code>pnp-webpack-plugin</code> is a better integration), but it&#x27;s a very useful tool to have to unblock yourself when using a project that doesn&#x27;t support it.</p><p>PnPify actually allows us to use TypeScript in VSCode with PnP! Its documentation is here: <a href="https://yarnpkg.github.io/berry/advanced/pnpify#vscode-support" target="_blank" rel="noopener noreferrer">https://yarnpkg.github.io/berry/advanced/pnpify#vscode-support</a></p><p>All of these hindrances should hopefully be resolved in future. Ideally, one day a good developer experience can be the default experience. In the meantime, you can still dev - just be prepared for the rough edges. Here&#x27;s some useful resources to track the future of support:</p><ul><li>You can follow more on built in webpack support here: <a href="https://github.com/webpack/enhanced-resolve/issues/162" target="_blank" rel="noopener noreferrer">https://github.com/webpack/enhanced-resolve/issues/162</a></li><li>And on built in TypeScript support here: <a href="https://github.com/Microsoft/TypeScript/issues/18896" target="_blank" rel="noopener noreferrer">https://github.com/Microsoft/TypeScript/issues/18896</a></li><li>Finally, there it&#x27;s worth watching the <a href="https://github.com/nodejs/modules" target="_blank" rel="noopener noreferrer">nodejs/module</a> repository, which debates amongst other things how to properly integrate loaders with Node.</li></ul><p>This last one would be nice because:</p><ul><li>We&#x27;d stop having to patch require</li><li>We probably wouldn&#x27;t have to use yarn node if Node itself was able to find the loader somehow (such as if it was listed in the package.json metadata)</li></ul><p>Thanks to Ma√´l for his tireless work on Yarn. To my mind Ma√´l is certainly a candidate for the hardest worker in open source. I&#x27;ve been shamelessly borrowing his excellent docs for this post - thanks for writing so excellently Ma√´l!</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/type-script">TypeScript</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/yarn">yarn</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/webpack">Webpack</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/pn-p">PnP</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about TypeScript / webpack - you down with PnP? Yarn, you know me!" href="/2019/06/07/typescript-webpack-you-down-with-pnp"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_d4p0" itemprop="headline"><a itemprop="url" href="/2019/01/05/github-actions-and-yarn">GitHub Actions and Yarn</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2019-01-05T00:00:00.000Z" itemprop="datePublished">January 5, 2019</time> ¬∑ <!-- -->4 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>I&#x27;d been meaning to automate the npm publishing of <a href="https://github.com/TypeStrong/ts-loader" target="_blank" rel="noopener noreferrer"><code>ts-loader</code></a> for the longest time. I had attempted to use Travis to do this in the same way as <a href="https://github.com/Realytics/fork-ts-checker-webpack-plugin" target="_blank" rel="noopener noreferrer"><code>fork-ts-checker-webpack-plugin</code></a>. Alas using secure environment variables in Travis has unfortunate implications for ts-loader&#x27;s test pack.</p><p>Be not afeard. I&#x27;ve heard there&#x27;s a new shiny thing from GitHub that I could use instead... It&#x27;s a sign; I must use it!</p><p>GitHub Actions are still in beta. Technically Actions are <a href="https://developer.github.com/actions/creating-github-actions/" target="_blank" rel="noopener noreferrer">code run in Docker containers</a> in response to events. This didn&#x27;t mean a great deal to me until I started thinking about what I wanted to do with <code>ts-loader</code>&#x27;s publishing flow.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="automate-what">Automate What?<a class="hash-link" href="#automate-what" title="Direct link to heading">‚Äã</a></h2><p>Each time I publish a release of <code>ts-loader</code> I execute the following node commands by hand:</p><ol><li><code>yarn install</code> <!-- -->-<!-- --> to install <code>ts-loader</code>&#x27;s dependencies</li><li><code>yarn build</code> <!-- -->-<!-- --> to build <code>ts-loader</code></li><li><code>yarn test</code> <!-- -->-<!-- --> to run <code>ts-loader</code>&#x27;s test packs</li><li><code>npm publish</code> <!-- -->-<!-- --> to publish the release of <code>ts-loader</code> to npm</li></ol><p>Having read up on GitHub Actions it seemed like they were born to handle this sort of task.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="github-action-for-npm">GitHub Action for <code>npm</code><a class="hash-link" href="#github-action-for-npm" title="Direct link to heading">‚Äã</a></h2><p>I quickly discovered that someone out there <s>loves me</s></p><p>had <a href="https://github.com/actions/npm" target="_blank" rel="noopener noreferrer">already written a GitHub Action for <code>npm</code></a>.</p><p>The example in the <code>README/index.md</code> could be easily tweaked to meet my needs with one caveat: I had to use <code>npm</code> in place of <code>yarn</code>. I didn&#x27;t want to switch from <code>yarn</code>. What to do?</p><p>Well, remember when I said actions are code run in Docker containers? Another way to phrase that is to say: GitHub Actions are Docker images. Let&#x27;s look under the covers of the <code>npm</code> GitHub Action. As we peer inside the <a href="https://github.com/actions/npm/blob/e7aaefed7c9f2e83d493ff810f17fa5ccd7ed437/Dockerfile#L1" target="_blank" rel="noopener noreferrer"><code>Dockerfile</code></a> what do we find?</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">FROM node:10-slim</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Hmmmm.... Interesting. The base image of the <code>npm</code> GitHub Action is <code>node:10-slim</code>. Looking it up, it seems the <code>-slim</code> Docker images come with <a href="https://github.com/nodejs/docker-node/blob/master/Dockerfile-slim.template" target="_blank" rel="noopener noreferrer"><code>yarn</code> included</a>. Which means we should be able to use <code>yarn</code> inside the <code>npm</code> GitHub Action. Nice!</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="github-action-for-npm-for-yarn">GitHub Action for <code>npm</code> for <code>yarn</code><a class="hash-link" href="#github-action-for-npm-for-yarn" title="Direct link to heading">‚Äã</a></h2><p>Using <code>yarn</code> from the GitHub Action for <code>npm</code> is delightfully simple. Here&#x27;s what running <code>npm install</code> looks like:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain"># install with npm</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">action &quot;install&quot; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  uses = &quot;actions/npm@1.0.0&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  args = &quot;install&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Pivoting to use <code>yarn install</code> instead of <code>npm install</code> is as simple as:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain"># install with yarn</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">action &quot;install&quot; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  uses = &quot;actions/npm@1.0.0&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  runs = &quot;yarn&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  args = &quot;install&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>You can see we&#x27;ve introduced the <code>runs = &quot;yarn&quot;</code> and after that the <code>args</code> are whatever you need them to be.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="going-with-the-workflow">Going With The Workflow<a class="hash-link" href="#going-with-the-workflow" title="Direct link to heading">‚Äã</a></h2><p>A GitHub Workflow that implements the steps I need would look like this:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">workflow &quot;build, test and publish on release&quot; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  on = &quot;push&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  resolves = &quot;publish&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># install with yarn</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">action &quot;install&quot; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  uses = &quot;actions/npm@1.0.0&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  runs = &quot;yarn&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  args = &quot;install&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># build with yarn</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">action &quot;build&quot; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  needs = &quot;install&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  uses = &quot;actions/npm@1.0.0&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  runs = &quot;yarn&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  args = &quot;build&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># test with yarn</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">action &quot;test&quot; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  needs = &quot;build&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  uses = &quot;actions/npm@1.0.0&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  runs = &quot;yarn&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  args = &quot;test&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># filter for a new tag</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">action &quot;check for new tag&quot; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  needs = &quot;Test&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  uses = &quot;actions/bin/filter@master&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  args = &quot;tag&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># publish with npm</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">action &quot;publish&quot; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  needs = &quot;check for new tag&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  uses = &quot;actions/npm@1.0.0&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  args = &quot;publish&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  secrets = [&quot;NPM_AUTH_TOKEN&quot;]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>As you can see, this is a direct automation of steps 1-4 I listed earlier. Since all these actions are executed in the same container, we can skip from <code>yarn</code> to <code>npm</code> with gay abandon.</p><p>What&#x27;s absolutely amazing is, when I got access to GitHub Actions <a href="https://github.com/TypeStrong/ts-loader/blob/master/.github/main.workflow" target="_blank" rel="noopener noreferrer">my hand crafted workflow</a> looked like it should work first time! I know, right? Don&#x27;t you love it when that happens? <a href="https://github.com/actions/bin/issues/13" target="_blank" rel="noopener noreferrer">Alas there&#x27;s presently a problem with filters in GitHub Actions</a>. But that&#x27;s by the by, if you&#x27;re just looking to use a GitHub Action with yarn instead of npm then you are home free.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="you-dont-actually-need-the-npm-github-action">You Don&#x27;t Actually Need the npm GitHub Action<a class="hash-link" href="#you-dont-actually-need-the-npm-github-action" title="Direct link to heading">‚Äã</a></h2><p>You heard me right. Docker containers be Docker containers. You don&#x27;t actually need to use this:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">uses = &quot;actions/npm@1.0.0&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>You can use <em>any</em> Docker container which has node / npm installed! So if you&#x27;d like to use say node 11 instead you could just do this:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">uses = &quot;docker://node:11&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Which would use the node 11 image on <a href="https://hub.docker.com/_/node" target="_blank" rel="noopener noreferrer">docker hub</a>.</p><p>Which is pretty cool. You know what&#x27;s even more incredible? Inside a workflow you can switch <code>uses</code> mid-workflow and keep the output. That&#x27;s right; you can have a work flow with say three actions running <code>uses = &quot;docker://node:11&quot;</code> and then a fourth running <code>uses = &quot;actions/npm@1.0.0&quot;</code>. That&#x27;s <em>so</em> flexible and powerful!</p><p>Thanks to <a href="https://github.com/mcolyer" target="_blank" rel="noopener noreferrer">Matt Colyer</a> and <a href="https://github.com/LandonSchropp" target="_blank" rel="noopener noreferrer">Landon Schropp</a> for <a href="https://github.com/actions/npm/issues/9" target="_blank" rel="noopener noreferrer">schooling me on the intricicies of GitHub Actions</a>. Much ‚ù§</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/docker">docker</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/yarn">yarn</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/git-hub-actions">GitHub Actions</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about GitHub Actions and Yarn" href="/2019/01/05/github-actions-and-yarn"><b>Read More</b></a></div></footer></article></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Support me</div><ul class="footer__items"><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li><li class="footer__item"><div style="display: flex; align-items: center;"><iframe src="https://github.com/sponsors/johnnyreilly/button" title="Sponsor johnnyreilly" height="35" width="116" style="border: 0;"></iframe><div>&nbsp;on GitHub</div></div></li></ul></div><div class="col footer__col"><div class="footer__title">Feeds</div><ul class="footer__items"><li class="footer__item"><a href="https://blog.johnnyreilly.com/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>RSS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://blog.johnnyreilly.com/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Atom<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.43c338b2.js"></script>
<script src="/assets/js/main.b6be8dcb.js"></script>
</body>
</html>