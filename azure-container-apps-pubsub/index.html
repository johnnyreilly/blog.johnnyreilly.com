<!doctype html><html lang=en dir=ltr class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.6.1"><title data-rh=true>Azure Container Apps: dapr pubsub | johnnyreilly</title><meta data-rh=true name=viewport content="width=device-width,initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://johnnyreilly.com/azure-container-apps-pubsub><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docusaurus_tag content=default><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=docsearch:docusaurus_tag content=default><meta data-rh=true name=robots content=max-image-preview:large><meta data-rh=true name=monetization content=$ilp.uphold.com/LwQQhXdpwxeJ><meta data-rh=true property=og:title content="Azure Container Apps: dapr pubsub | johnnyreilly"><meta data-rh=true name=description content="This post shows how to build and deploy two Azure Container Apps using Bicep and GitHub Actions which communicate using daprs pubsub building block."><meta data-rh=true property=og:description content="This post shows how to build and deploy two Azure Container Apps using Bicep and GitHub Actions which communicate using daprs pubsub building block."><meta data-rh=true property=og:image content=https://johnnyreilly.com/assets/images/title-image-1083426a9aa76352a87988e08d382718.png><meta data-rh=true name=twitter:image content=https://johnnyreilly.com/assets/images/title-image-1083426a9aa76352a87988e08d382718.png><meta data-rh=true property=og:type content=article><meta data-rh=true property=article:published_time content=2022-06-21T00:00:00.000Z><meta data-rh=true property=article:author content=https://johnnyreilly.com/about><meta data-rh=true property=article:tag content="Azure Container Apps,Bicep"><link data-rh=true rel=icon href=/favicon.ico><link data-rh=true rel=canonical href=https://johnnyreilly.com/azure-container-apps-pubsub><link data-rh=true rel=alternate href=https://johnnyreilly.com/azure-container-apps-pubsub hreflang=en><link data-rh=true rel=alternate href=https://johnnyreilly.com/azure-container-apps-pubsub hreflang=x-default><link data-rh=true rel=preconnect href=https://J3MYR1INLT-dsn.algolia.net crossorigin><script data-rh=true type=application/ld+json>{"@context":"https://schema.org","@id":"https://johnnyreilly.com/azure-container-apps-pubsub","@type":"BlogPosting","author":{"@type":"Person","description":"OSS Engineer - TypeScript, Azure, React, Node.js, .NET","image":"https://johnnyreilly.com/img/profile.jpg","name":"John Reilly","url":"https://johnnyreilly.com/about"},"datePublished":"2022-06-21T00:00:00.000Z","description":"This post shows how to build and deploy two Azure Container Apps using Bicep and GitHub Actions which communicate using daprs pubsub building block.","headline":"Azure Container Apps: dapr pubsub","image":{"@id":"https://johnnyreilly.com/assets/images/title-image-1083426a9aa76352a87988e08d382718.png","@type":"ImageObject","caption":"title image for the blog post: Azure Container Apps: dapr pubsub","contentUrl":"https://johnnyreilly.com/assets/images/title-image-1083426a9aa76352a87988e08d382718.png","url":"https://johnnyreilly.com/assets/images/title-image-1083426a9aa76352a87988e08d382718.png"},"isPartOf":{"@id":"https://johnnyreilly.com/","@type":"Blog","name":"I CAN MAKE THIS WORK"},"keywords":[],"mainEntityOfPage":"https://johnnyreilly.com/azure-container-apps-pubsub","name":"Azure Container Apps: dapr pubsub","url":"https://johnnyreilly.com/azure-container-apps-pubsub"}</script><link rel=alternate type=application/rss+xml href=/rss.xml title="I CAN MAKE THIS WORK RSS Feed"><link rel=alternate type=application/atom+xml href=/atom.xml title="I CAN MAKE THIS WORK Atom Feed"><link rel=search type=application/opensearchdescription+xml title=johnnyreilly href=/opensearch.xml><link rel=icon href=/img/profile-64x64.jpg><link rel=manifest href=/manifest.json><meta name=theme-color content=#3578e5><meta name=apple-mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-status-bar-style content=#000><link rel=apple-touch-icon href=/apple-touch-icon.png><link rel=preload href=https://johnnyreilly.com/fonts/Poppins-Regular.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://johnnyreilly.com/fonts/Poppins-Bold.woff2 as=font type=font/woff2 crossorigin><link rel=preconnect href=https://res.cloudinary.com><link rel=monetization href=https://ilp.uphold.com/LwQQhXdpwxeJ><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@id":"https://johnnyreilly.com","@type":"WebSite","copyrightHolder":{"@id":"https://johnnyreilly.com/about"},"description":"This is John Reilly's blog. John is an Open Source Software Engineer working on TypeScript, Azure, React, Node.js, .NET and more.","inLanguage":"en-UK","name":"johnnyreilly","potentialAction":{"@type":"SearchAction","query-input":"required name=search_term_string","target":{"@type":"EntryPoint","urlTemplate":"https://johnnyreilly.com/search?q={search_term_string}"}},"publisher":{"@id":"https://johnnyreilly.com/about"},"url":"https://johnnyreilly.com"},{"@id":"https://johnnyreilly.com/about","@type":"Person","address":{"@type":"PostalAddress","addressCountry":"United Kingdom","addressLocality":"London","streetAddress":"Twickenham"},"alternateName":"Johnny Reilly","birthPlace":"Bristol","description":"John is an Open Source Software Engineer working on TypeScript, Azure, React, Node.js, .NET and more. As well as writing code, John is a speaker at meetups, one of the founders of the TS Congress conference, and the author of the history of Definitely Typed, which he worked on in the early days of TypeScript.","email":"johnny_reilly@hotmail.com","image":{"@id":"https://johnnyreilly.com/about#image","@type":"ImageObject","caption":"John Reilly","contentUrl":"https://johnnyreilly.com/img/profile.jpg","height":200,"inLanguage":"en-UK","url":"https://johnnyreilly.com/img/profile.jpg","width":200},"name":"John Reilly","sameAs":["https://github.com/johnnyreilly","https://fosstodon.org/@johnny_reilly","https://twitter.com/johnny_reilly","https://bsky.app/profile/johnnyreilly.com","https://dev.to/johnnyreilly","https://app.daily.dev/johnnyreilly","https://stackoverflow.com/users/761388/john-reilly","https://blog.logrocket.com/author/johnreilly/","https://www.reddit.com/user/johnny_reilly","https://uk.linkedin.com/in/johnnyreilly"],"url":"https://johnnyreilly.com"},{"@id":"https://johnnyreilly.com/about#organization","@type":["Organization","Brand"],"description":"This is John Reilly's blog. John is an Open Source Software Engineer working on TypeScript, Azure, React, Node.js, .NET and more.","image":{"@id":"https://johnnyreilly.com/#logo"},"logo":{"@id":"https://johnnyreilly.com/#logo","@type":"ImageObject","caption":"John Reilly","contentUrl":"https://johnnyreilly.com/img/profile.jpg","height":200,"inLanguage":"en-UK","url":"https://johnnyreilly.com/img/profile.jpg","width":200},"name":"johnnyreilly","sameAs":["https://github.com/johnnyreilly","https://fosstodon.org/@johnny_reilly","https://twitter.com/johnny_reilly","https://bsky.app/profile/johnnyreilly.com","https://dev.to/johnnyreilly","https://app.daily.dev/johnnyreilly","https://stackoverflow.com/users/761388/john-reilly","https://blog.logrocket.com/author/johnreilly/","https://www.reddit.com/user/johnny_reilly","https://uk.linkedin.com/in/johnnyreilly"],"url":"https://johnnyreilly.com"}]}</script><link rel=webmention href=https://webmention.io/johnnyreilly.com/webmention><link rel=stylesheet href=/assets/css/styles.72204ba3.css><script src=/assets/js/main.d01dfb1a.js defer></script><script src=/assets/js/runtime~main.1759814a.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><script type=application/ld+json>[{"@context":"https://schema.org","@id":"/azure-container-apps-pubsub#breadcrumb","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://johnnyreilly.com","name":"Home","position":1},{"@type":"ListItem","item":"https://johnnyreilly.com/blog","name":"Blog","position":2},{"@type":"ListItem","name":"Azure Container Apps: dapr pubsub","position":3}],"name":"Blog breadcrumb"}]</script><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><div class=navbar__logo><img src=/img/profile-64x64.jpg alt="Profile picture of John Reilly" class="themedComponent_mlkZ themedComponent--light_NVdE" height=32 width=32><img src=/img/profile-64x64.jpg alt="Profile picture of John Reilly" class="themedComponent_mlkZ themedComponent--dark_xIcU" height=32 width=32></div><b class="navbar__title text--truncate">John Reilly</b></a><a class="navbar__item navbar__link" href=/about>About</a><a class="navbar__item navbar__link" href=/blog>Blog</a><a class="navbar__item navbar__link" href=/talks>Talks</a></div><div class="navbar__items navbar__items--right"><a href=https://github.com/johnnyreilly target=_blank rel=me class="navbar__item navbar__link">GitHub<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><a href=https://bsky.app/profile/johnnyreilly.com target=_blank rel=me class="navbar__item navbar__link">Bluesky<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><a href=https://fosstodon.org/@johnny_reilly target=_blank rel=me class="navbar__item navbar__link">Mastodon<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><a href=https://twitter.com/johnny_reilly target=_blank rel=me class="navbar__item navbar__link">Twitter<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type=button disabled title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live=polite aria-pressed=false><svg viewBox="0 0 24 24" width=24 height=24 class=lightToggleIcon_pyhR><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 class=darkToggleIcon_wfgR><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg></button></div><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label=Search><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class=row><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role=group><h3 class=yearGroupHeading_rMGB>2024</h3><ul class="sidebarItemList_Yudw clean-list"><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/azure-artifacts-publish-private-npm-package-with-azure-devops>Azure Artifacts: Publish a private npm package with Azure DevOps</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/introducing-azdo-npm-auth>Introducing Azure DevOps npm auth</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/azure-devops-set-user-story-column-api>Azure DevOps API: Set User Story column with the Azure DevOps Client for Node.js</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/module-ws-does-not-provide-an-export-named-websocketserver>module ws does not provide an export named WebSocketServer</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/static-typing-for-mui-react-data-grid-columns>Static Typing for MUI React Data Grid Columns</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/typescript-eslint-with-jsdoc-js>typescript-eslint with JSDoc JavaScript</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/using-azd-for-faster-incremental-azure-static-web-app-deployments-in-github-actions>Using AZD for faster incremental Azure Static Web App deployments in GitHub Actions</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops>Using AZD for faster incremental Azure Container App deployments in Azure DevOps</a></ul></div></nav></aside><main class="col col--7"><article><header><h1 class=title_f1Hy>Azure Container Apps: dapr pubsub</h1><div class="container_mt6G margin-vert--md"><time datetime=2022-06-21T00:00:00.000Z>June 21, 2022</time> · <!-- -->21 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href=https://johnnyreilly.com/about target=_blank rel="noopener noreferrer" class=avatar__photo-link><img class="avatar__photo authorImage_XqGP" src=https://johnnyreilly.com/img/profile.jpg alt="John Reilly"></a><div class="avatar__intro authorDetails_lV9A"><div class=avatar__name><a href=https://johnnyreilly.com/about target=_blank rel="noopener noreferrer"><span class=authorName_yefp>John Reilly</span></a></div><small class=authorTitle_nd0D title="OSS Engineer - TypeScript, Azure, React, Node.js, .NET">OSS Engineer - TypeScript, Azure, React, Node.js, .NET</small><div class=authorSocials_rSDt></div></div></div></div></div></header><div id=__blog-post-container class=markdown><p>This post shows how to build and deploy two Azure Container Apps using Bicep and GitHub Actions. These apps will communicate using <a href=https://docs.dapr.io/ target=_blank rel="noopener noreferrer">dapr</a>'s <a href=https://docs.dapr.io/developing-applications/building-blocks/pubsub/howto-publish-subscribe/ target=_blank rel="noopener noreferrer">publish & subscribe (pubsub) building block</a>.</p>
<p><img decoding=async alt="title image reading &amp;quot;Azure Container Apps: dapr pubsub&amp;quot;  with the dapr, Bicep, Azure Container Apps and GitHub Actions logos" src=/assets/images/title-image-1083426a9aa76352a87988e08d382718.png width=1600 height=900 fetchpriority=high class=img_ev3q></p>
<p>This post will build upon code written in a <a href=/azure-container-apps-dapr-bicep-github-actions-debug-devcontainer>previous post</a> which built and deployed a simple web application to Azure Container Apps using Bicep and GitHub Actions using the GitHub container registry. Behind the scenes, that app was made up of a .NET app and a Node.js app communicating via dapr's <a href=https://docs.dapr.io/developing-applications/building-blocks/service-invocation/howto-invoke-discover-services/ target=_blank rel="noopener noreferrer">service invocation building block</a>.</p>
<p>There's a good chance you've just googled "pubsub dapr azure container apps" and you don't want to read through all this. You just want the code. That's fine. The code for this blogpost is <a href=https://github.com/johnnyreilly/dapr-devcontainer-debug-and-deploy/releases/tag/v2.0.0 target=_blank rel="noopener noreferrer">here</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=you-got-mail-service-invocation>You got mail: service invocation<a href=#you-got-mail-service-invocation class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>Right now we have a:</p>
<ul>
<li>Node.js web app and a</li>
<li>.NET app</li>
</ul>
<p>The web app, when called, uses dapr service invocation to acquire a weather forecast from a .NET app.</p>
<p>What we want to investigate is dapr's pubsub building block. But pubsub doesn't really "fit" into our current app. Let's alter it. Instead of showing users a weather forecast when they browse to the site, we'll instead look for our users to provide an email address, and we'll mail them a weather forecast.</p>
<p>This kind of app could work both using dapr service invocation or using pubsub. We're going to implement using our current service invocation approach first. Once that works, we'll then pivot that into using dapr pubsub.</p>
<p>This isn't rocket surgery; this is playing around with dapr and Azure Container Apps and seeing how they all hang together.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=net-meet-mailgun>.NET meet mailgun<a href=#net-meet-mailgun class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>Our existing .NET app needs the ability to send email. For that we're going to reach for <a href=https://app.mailgun.com/app/dashboard target=_blank rel="noopener noreferrer">mailgun</a>, and we'll use <a href=https://restsharp.dev/ target=_blank rel="noopener noreferrer">RestSharp</a> to call it. Let's add RestSharp as a dependency:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token plain">dotnet </span><span class="token function" style="color:rgb(250, 208, 0)">add</span><span class="token plain"> package RestSharp</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>With that in place, let's turn to our <code>WeatherForecastController</code> and make it send an email.</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Config</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Microsoft</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">AspNetCore</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Mvc</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Microsoft</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Extensions</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Options</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">RestSharp</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">RestSharp</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Authenticators</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">namespace</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">WeatherService</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Controllers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token attribute class-name" style="color:rgb(250, 208, 0)">ApiController</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">WeatherForecastController</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token type-list class-name" style="color:rgb(250, 208, 0)">ControllerBase</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">static</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> Summaries </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token string" style="color:rgb(165, 255, 144)">"Freezing"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Bracing"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Chilly"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Cool"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Mild"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Warm"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Balmy"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Hot"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Sweltering"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Scorching"</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">WeatherForecastController</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">></span><span class="token plain"> _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">MailConfig</span><span class="token plain"> _options</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">WeatherForecastController</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">WeatherForecastController</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">></span><span class="token plain"> logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">IOptions</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">MailConfig</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">></span><span class="token plain"> options</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        _logger </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        _options </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> options</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">record</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">SendWeatherForecastBody</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> Email</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token attribute class-name" style="color:rgb(250, 208, 0)">HttpPost</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token attribute attribute-arguments string" style="color:rgb(165, 255, 144)">"SendWeatherForecast"</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Task</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token return-type class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">></span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">SendWeatherForecast</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">SendWeatherForecastBody</span><span class="token plain"> body</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">try</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">string</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">IsNullOrEmpty</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">body</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Email</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">throw</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"Email required"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> weatherForecast </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> Enumerable</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Range</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token number" style="color:rgb(255, 98, 140)">1</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">5</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Select</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">index </span><span class="token operator" style="color:rgb(255, 157, 0)">=></span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">WeatherForecast</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                Date </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> DateTime</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Now</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AddDays</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">index</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                TemperatureC </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> Random</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Shared</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Next</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token operator" style="color:rgb(255, 157, 0)">-</span><span class="token number" style="color:rgb(255, 98, 140)">20</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">55</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                Summary </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> Summaries</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">Random</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Shared</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Next</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">Summaries</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">ToArray</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> toEmailAddress </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> body</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Email</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> text </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$@"The weather forecast is:</span><br></span><span class=token-line style=color:#9EFEFF><span class="token interpolation-string string" style="display:inline-block;color:rgb(165, 255, 144)"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"></span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">string</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp function" style="color:rgb(250, 208, 0)">Join</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp string" style="color:rgb(165, 255, 144)">"\n"</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token interpolation-string interpolation expression language-csharp"> weatherForecast</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp function" style="color:rgb(250, 208, 0)">Select</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">wf </span><span class="token interpolation-string interpolation expression language-csharp operator" style="color:rgb(255, 157, 0)">=></span><span class="token interpolation-string interpolation expression language-csharp"> </span><span class="token interpolation-string interpolation expression language-csharp interpolation-string string" style="color:rgb(165, 255, 144)">$"On </span><span class="token interpolation-string interpolation expression language-csharp interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp interpolation-string interpolation expression language-csharp">wf</span><span class="token interpolation-string interpolation expression language-csharp interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp interpolation-string interpolation expression language-csharp">Date</span><span class="token interpolation-string interpolation expression language-csharp interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string interpolation expression language-csharp interpolation-string string" style="color:rgb(165, 255, 144)"> the weather will be </span><span class="token interpolation-string interpolation expression language-csharp interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp interpolation-string interpolation expression language-csharp">wf</span><span class="token interpolation-string interpolation expression language-csharp interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp interpolation-string interpolation expression language-csharp">Summary</span><span class="token interpolation-string interpolation expression language-csharp interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string interpolation expression language-csharp interpolation-string string" style="color:rgb(165, 255, 144)">"</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">SendSimpleMessage</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">toEmailAddress</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> toEmailAddress</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">text</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> text</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"We have mailed </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">toEmailAddress</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> with the following:\n\n</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">text</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token plain"> exc</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogError</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">exc</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Problem!"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> exc</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Message</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Task</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">RestResponse</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">></span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">SendSimpleMessage</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> toEmailAddress</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> text</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">RestClient</span><span class="token plain"> client </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">RestClientOptions</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            BaseUrl </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Uri</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"https://api.mailgun.net/v3"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            Authenticator </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">HttpBasicAuthenticator</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"api"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> _options</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">MailgunApiKey</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">RestRequest</span><span class="token plain"> request </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        request</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AddParameter</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"domain"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"mg.priou.co.uk"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> ParameterType</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">UrlSegment</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        request</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Resource </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"{domain}/messages"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        request</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AddParameter</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"from"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"John Reilly &lt;johnny_reilly@hotmail.com>"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        request</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AddParameter</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"to"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> toEmailAddress</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        request</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AddParameter</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"subject"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Weather forecast"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        request</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AddParameter</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"text"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> text</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">PostAsync</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">request</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>In our new and improved controller we:</p>
<ul>
<li>Switch our <code>GET</code> endpoint to be a <code>POST</code> one instead, to reflect that we're going to take an action (sending an email) each time it's hit. (RESTful to the end)</li>
<li>Rather than returning the weather forecast to our caller, we take the email address supplied and we send the weather forecast to it</li>
</ul>
<p>You'll also notice we're passing a <code>IOptions&lt;MailConfig></code> to the constructor of our class, it's in this configuration object we store our Mailgun api key. So we're going to need to define a <code>MailConfig</code> class:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">MailConfig</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> MailgunApiKey </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">get</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">set</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">string</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Empty</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>And we need to update our <code>Program.cs</code> so it recognises <code>MailConfig</code> and configures it:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> builder </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> WebApplication</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">CreateBuilder</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">args</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">builder</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token generic-method function" style="color:rgb(250, 208, 0)">Configure</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)">MailConfig</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">></span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">builder</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Configuration</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetSection</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"Mail"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Thanks to the default setup of .NET, we'll now be able to populate this using <code>appsettings.json</code> files and environment variables. Since our API key is a secret we'll avoid putting it in source control, and instead populate an environment variable that .NET can read:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token plain">MAIL__MAILGUNAPIKEY=key-goes-here</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>The <code>__</code> above is the convention that .NET follows for nesting with environment variables; this is equivalent to the following structure in an <code>appsettings.json</code> file:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-json codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"Mail"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">"MailgunApiKey"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"api-key-goes-here"</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=webservice-gets-a-form>Webservice gets a form<a href=#webservice-gets-a-form class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>Now that we've tweaked our WeatherService, we need to tweak the web site that calls it. We'll do that by first adding some dependencies that allow our Koa web service to handle routing a little easier:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token function" style="color:rgb(250, 208, 0)">npm</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">install</span><span class="token plain"> @koa/router koa-body </span><span class="token parameter variable" style="color:rgb(255, 238, 128)">--save</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token function" style="color:rgb(250, 208, 0)">npm</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">install</span><span class="token plain"> @types/koa__router --save-dev</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Then we'll tweak our <code>index.ts</code> like so:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token keyword" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> Koa </span><span class="token keyword" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'koa'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> Router </span><span class="token keyword" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'@koa/router'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> koaBody </span><span class="token keyword" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'koa-body'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> axios </span><span class="token keyword" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'axios'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// How we connect to the dotnet service with dapr</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> daprSidecarBaseUrl </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token template-string string" style="color:rgb(165, 255, 144)">http://localhost:</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token template-string interpolation">  process</span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token template-string interpolation">env</span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token template-string interpolation constant" style="color:rgb(250, 208, 0)">DAPR_HTTP_PORT</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:rgb(255, 157, 0)">||</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation number" style="color:rgb(255, 98, 140)">3501</span><span class="token template-string interpolation"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token template-string interpolation"></span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// app id header for service discovery</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> weatherServiceAppIdHeaders </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token string-property property" style="color:rgb(255, 157, 0)">'dapr-app-id'</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> process</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">env</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token constant" style="color:rgb(250, 208, 0)">WEATHER_SERVICE_NAME</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">||</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'dotnet-app'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> app </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">Koa</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> router </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">Router</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">use</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> next</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=></span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">next</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> status </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">status </span><span class="token operator" style="color:rgb(255, 157, 0)">||</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">404</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">status </span><span class="token operator" style="color:rgb(255, 157, 0)">===</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">404</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">throw</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token number" style="color:rgb(255, 98, 140)">404</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">err</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(250, 208, 0)">any</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    ctx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">status </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> err</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">status </span><span class="token operator" style="color:rgb(255, 157, 0)">||</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">500</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    ctx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">body </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">status </span><span class="token operator" style="color:rgb(255, 157, 0)">===</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">404</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">?</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'not found alas'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token template-string string" style="color:rgb(165, 255, 144)">hmmm: </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation">ctx</span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token template-string interpolation">status</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:rgb(250, 208, 0)">formHtml</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">header</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(250, 208, 0)">string</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=></span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token template-string string" style="color:rgb(165, 255, 144)">&lt;!DOCTYPE html></span><br></span><span class=token-line style=color:#9EFEFF><span class="token template-string string" style="color:rgb(165, 255, 144)">&lt;html></span><br></span><span class=token-line style=color:#9EFEFF><span class="token template-string string" style="color:rgb(165, 255, 144)">&lt;head></span><br></span><span class=token-line style=color:#9EFEFF><span class="token template-string string" style="color:rgb(165, 255, 144)">&lt;title>Email me!&lt;/title></span><br></span><span class=token-line style=color:#9EFEFF><span class="token template-string string" style="color:rgb(165, 255, 144)">&lt;/head></span><br></span><span class=token-line style=color:#9EFEFF><span class="token template-string string" style="color:rgb(165, 255, 144)">&lt;body></span><br></span><span class=token-line style=color:#9EFEFF><span class="token template-string string" style="color:rgb(165, 255, 144)">&lt;form method="post"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token template-string string" style="color:rgb(165, 255, 144)">    &lt;h1></span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation">header</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string string" style="color:rgb(165, 255, 144)">&lt;/h1></span><br></span><span class=token-line style=color:#9EFEFF><span class="token template-string string" style="color:rgb(165, 255, 144)">    &lt;label for="email">Enter your email:&lt;/label></span><br></span><span class=token-line style=color:#9EFEFF><span class="token template-string string" style="color:rgb(165, 255, 144)">    &lt;input type="email" id="email" name="email" required></span><br></span><span class=token-line style=color:#9EFEFF><span class="token template-string string" style="color:rgb(165, 255, 144)">    &lt;button type="submit">Submit&lt;/button></span><br></span><span class=token-line style=color:#9EFEFF><span class="token template-string string" style="color:rgb(165, 255, 144)">&lt;/form></span><br></span><span class=token-line style=color:#9EFEFF><span class="token template-string string" style="color:rgb(165, 255, 144)">&lt;/body></span><br></span><span class=token-line style=color:#9EFEFF><span class="token template-string string" style="color:rgb(165, 255, 144)">&lt;/html></span><br></span><span class=token-line style=color:#9EFEFF><span class="token template-string string" style="color:rgb(165, 255, 144)"></span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">router</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">get</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">'/'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> next</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=></span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  ctx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">body </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">formHtml</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"We'd like to email you"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">router</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">post</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">'/'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">koaBody</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> next</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=></span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">request</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">body</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">email</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> axios</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">post</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation">daprSidecarBaseUrl</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string string" style="color:rgb(165, 255, 144)">/SendWeatherForecast</span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          email</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">request</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">body</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">email</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          headers</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> weatherServiceAppIdHeaders</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      ctx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">body </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">formHtml</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">'Message sent'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      ctx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">body </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">formHtml</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">'No email supplied'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">exc</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token builtin" style="color:rgb(250, 208, 0)">console</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">error</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">'Problem calling weather service'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> exc</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    ctx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">body </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'Something went wrong!'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">use</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">router</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">routes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">use</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">router</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">allowedMethods</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> portNumber </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">3000</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">listen</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">portNumber</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token builtin" style="color:rgb(250, 208, 0)">console</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">log</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token template-string string" style="color:rgb(165, 255, 144)">listening on port </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation">portNumber</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>The above leaves us with a very simple form based web app that sends an email containing weather forecast:</p>
<p><img decoding=async loading=lazy alt="A gif that demos entering an email address in the form, submitting it and seeing an email arrive with a weather forecast in" src=/assets/images/demo-send-email-8b9d6fdfb4709356c1b32bb2bfa592ee.gif width=1460 height=858 class=img_ev3q></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=secrets-in-bicep>Secrets in Bicep<a href=#secrets-in-bicep class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>Whilst we can run locally, we want to be able to deploy this. So we need to update our Bicep template to receive a <code>MAIL__MAILGUNAPIKEY</code> parameter:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> branchName </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> webServiceImage </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> webServicePort </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">int</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> webServiceIsExternalIngress </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">bool</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> weatherServiceImage </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> weatherServicePort </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">int</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> weatherServiceIsExternalIngress </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">bool</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> containerRegistry </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> containerRegistryUsername </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token decorator">@secure</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> containerRegistryPassword </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> tags </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">object</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token decorator">@secure</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> MAIL__MAILGUNAPIKEY </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> location </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">resourceGroup</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">location</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> minReplicas </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">1</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> maxReplicas </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">1</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> branch </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">toLower</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token function" style="color:rgb(250, 208, 0)">last</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token function" style="color:rgb(250, 208, 0)">split</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">branchName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'/'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> environmentName </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">'</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token interpolated-string interpolation expression">branch</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">-env'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> workspaceName </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">'</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token interpolated-string interpolation expression">branch</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">-log-analytics'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> appInsightsName </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">'</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token interpolated-string interpolation expression">branch</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">-app-insights'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> webServiceContainerAppName </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">'</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token interpolated-string interpolation expression">branch</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">-web'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> weatherServiceContainerAppName </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">'</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token interpolated-string interpolation expression">branch</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">-weather'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> containerRegistryPasswordRef </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'container-registry-password'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> mailgunApiKeyRef </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'mailgun-api-key'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> workspace </span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.OperationalInsights/workspaces@2021-12-01-preview'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> workspaceName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">location</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> location</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">tags</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> tags</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">properties</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">sku</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'PerGB2018'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">retentionInDays</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">30</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">workspaceCapping</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> appInsights </span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.Insights/components@2020-02-02'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> appInsightsName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">location</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> location</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">tags</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> tags</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">kind</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'web'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">properties</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">Application_Type</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'web'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">Flow_Type</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'Bluefield'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> environment </span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.App/managedEnvironments@2022-01-01-preview'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> environmentName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">location</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> location</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">tags</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> tags</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">properties</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">daprAIInstrumentationKey</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> appInsights</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">InstrumentationKey</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">appLogsConfiguration</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">destination</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'log-analytics'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">logAnalyticsConfiguration</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">customerId</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> workspace</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">customerId</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">sharedKey</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">listKeys</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">workspace</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">id</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> workspace</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">apiVersion</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">primarySharedKey</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> weatherServiceContainerApp </span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.App/containerApps@2022-01-01-preview'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> weatherServiceContainerAppName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">tags</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> tags</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">location</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> location</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">properties</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">kubeEnvironmentId</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> environment</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">id</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">configuration</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">secrets</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerRegistryPasswordRef</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerRegistryPassword</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> mailgunApiKeyRef</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> MAIL__MAILGUNAPIKEY</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">registries</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">server</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerRegistry</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">username</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerRegistryUsername</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">passwordSecretRef</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerRegistryPasswordRef</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">ingress</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">external</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> weatherServiceIsExternalIngress</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">targetPort</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> weatherServicePort</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">template</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">containers</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">image</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> weatherServiceImage</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> weatherServiceContainerAppName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">env</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'MAIL__MAILGUNAPIKEY'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">secretRef</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> mailgunApiKeyRef</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">scale</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">minReplicas</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> minReplicas</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">maxReplicas</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> maxReplicas</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">dapr</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">enabled</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">appPort</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> weatherServicePort</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">appId</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> weatherServiceContainerAppName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> webServiceContainerApp </span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.App/containerApps@2022-01-01-preview'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> webServiceContainerAppName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">tags</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> tags</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">location</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> location</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">properties</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">kubeEnvironmentId</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> environment</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">id</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">configuration</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">secrets</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerRegistryPasswordRef</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerRegistryPassword</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">registries</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">server</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerRegistry</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">username</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerRegistryUsername</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">passwordSecretRef</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerRegistryPasswordRef</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">ingress</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">external</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> webServiceIsExternalIngress</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">targetPort</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> webServicePort</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">template</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">containers</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">image</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> webServiceImage</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> webServiceContainerAppName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">env</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'WEATHER_SERVICE_NAME'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> weatherServiceContainerAppName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">scale</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">minReplicas</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> minReplicas</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">maxReplicas</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> maxReplicas</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">dapr</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">enabled</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">appPort</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> webServicePort</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">appId</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> webServiceContainerAppName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">output</span><span class="token plain"> webServiceUrl </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> webServiceContainerApp</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">latestRevisionFqdn</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>We can see that we treat the <code>MAIL__MAILGUNAPIKEY</code> as a secret. It's passed in using the <code>@secure</code> decorator and it's configured as a secret inside the <code>weatherServiceContainerApp</code> Azure Container App.</p>
<p>We have a GitHub Action that handles our deployment. We'll need to introduce the <code>MAIL__MAILGUNAPIKEY</code> secret both to the deploy step of the <code>build-and-deploy.yaml</code>:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token key atrule">deploy</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">runs-on</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">latest</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">needs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">build</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Checkout repository</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> actions/checkout@v2</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Azure Login</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> azure/login@v1</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">creds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> secrets.AZURE_CREDENTIALS </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Deploy bicep</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> azure/CLI@v2</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> github.event_name </span><span class="token tag" style="color:rgb(255, 157, 0)">!=</span><span class="token plain"> 'pull_request'</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token scalar string" style="color:rgb(165, 255, 144)"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">          REF_SHA='${{ github.ref }}.${{ github.sha }}'</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">          DEPLOYMENT_NAME="${REF_SHA////-}"</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">          echo "DEPLOYMENT_NAME=$DEPLOYMENT_NAME"</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          TAGS='</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain">"owner"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token string" style="color:rgb(165, 255, 144)">"johnnyreilly"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> "email"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token string" style="color:rgb(165, 255, 144)">"johnny_reilly@hotmail.com"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain">'</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          az deployment group create \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">resource</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">group $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> env.RESOURCE_GROUP </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">name "$DEPLOYMENT_NAME" \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">template</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">file ./infra/main.bicep \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">parameters \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                branchName='$</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> github.event.number == 0 </span><span class="token important">&&</span><span class="token plain"> 'main' </span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token plain">  format('pr</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token number" style="color:rgb(255, 98, 140)">0</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain">'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> github.event.number) </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain">' \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                webServiceImage='$</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> needs.build.outputs.image</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">node </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain">' \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                webServicePort=3000 \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                webServiceIsExternalIngress=true \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                weatherServiceImage='$</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> needs.build.outputs.image</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">dotnet </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain">' \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                weatherServicePort=5000 \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                weatherServiceIsExternalIngress=false \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                containerRegistry=$</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> env.REGISTRY </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                containerRegistryUsername=$</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> github.actor </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                containerRegistryPassword=$</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> secrets.PACKAGES_TOKEN </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                tags="$TAGS" \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                MAIL__MAILGUNAPIKEY="$</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> secrets.MAIL__MAILGUNAPIKEY </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain">"</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>And we'll need to create the associated secret as well:</p>
<p><img decoding=async loading=lazy alt="Screenshot of the secrets in the GitHub website that we need to create including MAIL__MAILGUNAPIKEY" src=/assets/images/screenshot-github-secrets-c7d53c9822c48d0f16997a6470264d0b.png width=1586 height=515 class=img_ev3q></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=you-got-mail-pubsub>You got mail: pubsub!<a href=#you-got-mail-pubsub class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>So we're now at the point where we have a pubsub style app - but still implemented using the service invocation approach. It's time to start migrating to using dapr's pubsub capabilities. Now, caveat emptor, pivoting from service invocation involves a fair amount of code. I'll try and be as brief as I can as we make the switch. However there will be big ol' lumps of code blocks as we do this. You may find it easier to just examine the finished code. I will in no way feel bad if that's the path you follow.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=publishing-with-dapr-client>Publishing with dapr-client<a href=#publishing-with-dapr-client class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>The first thing we need, is for our Node.js app to publish using the dapr pubsub mechanism. The easiest way to do that is with the <a href=https://docs.dapr.io/developing-applications/sdks/js/ target=_blank rel="noopener noreferrer">dapr-client</a>:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token function" style="color:rgb(250, 208, 0)">npm</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">install</span><span class="token plain"> dapr-client </span><span class="token parameter variable" style="color:rgb(255, 238, 128)">--save</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>We then switch out using axios to send our email command, to use <code>dapr-client</code> instead:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token keyword" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> Koa </span><span class="token keyword" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'koa'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> Router </span><span class="token keyword" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'@koa/router'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> koaBody </span><span class="token keyword" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'koa-body'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> DaprClient </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'dapr-client'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> daprHost </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'localhost'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// Dapr Sidecar Host</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> daprPort </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation">process</span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token template-string interpolation">env</span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token template-string interpolation constant" style="color:rgb(250, 208, 0)">DAPR_HTTP_PORT</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:rgb(255, 157, 0)">||</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation number" style="color:rgb(255, 98, 140)">3501</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// Dapr Sidecar Port</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> client </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">DaprClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">daprHost</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> daprPort</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> app </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">Koa</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> router </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">Router</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">use</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> next</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=></span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">next</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> status </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">status </span><span class="token operator" style="color:rgb(255, 157, 0)">||</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">404</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">status </span><span class="token operator" style="color:rgb(255, 157, 0)">===</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">404</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">throw</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token number" style="color:rgb(255, 98, 140)">404</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">err</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(250, 208, 0)">any</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    ctx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">status </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> err</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">status </span><span class="token operator" style="color:rgb(255, 157, 0)">||</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">500</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    ctx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">body </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">status </span><span class="token operator" style="color:rgb(255, 157, 0)">===</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">404</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">?</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'not found alas'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token template-string string" style="color:rgb(165, 255, 144)">hmmm: </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation">ctx</span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token template-string interpolation">status</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:rgb(250, 208, 0)">formHtml</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">header</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(250, 208, 0)">string</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=></span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token template-string string" style="color:rgb(165, 255, 144)">&lt;!DOCTYPE html></span><br></span><span class=token-line style=color:#9EFEFF><span class="token template-string string" style="color:rgb(165, 255, 144)">&lt;html></span><br></span><span class=token-line style=color:#9EFEFF><span class="token template-string string" style="color:rgb(165, 255, 144)">&lt;head></span><br></span><span class=token-line style=color:#9EFEFF><span class="token template-string string" style="color:rgb(165, 255, 144)">&lt;title>Email me!&lt;/title></span><br></span><span class=token-line style=color:#9EFEFF><span class="token template-string string" style="color:rgb(165, 255, 144)">&lt;/head></span><br></span><span class=token-line style=color:#9EFEFF><span class="token template-string string" style="color:rgb(165, 255, 144)">&lt;body></span><br></span><span class=token-line style=color:#9EFEFF><span class="token template-string string" style="color:rgb(165, 255, 144)">&lt;form method="post"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token template-string string" style="color:rgb(165, 255, 144)">    &lt;h1></span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation">header</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string string" style="color:rgb(165, 255, 144)">&lt;/h1></span><br></span><span class=token-line style=color:#9EFEFF><span class="token template-string string" style="color:rgb(165, 255, 144)">    &lt;label for="email">Enter your email:&lt;/label></span><br></span><span class=token-line style=color:#9EFEFF><span class="token template-string string" style="color:rgb(165, 255, 144)">    &lt;input type="email" id="email" name="email" required></span><br></span><span class=token-line style=color:#9EFEFF><span class="token template-string string" style="color:rgb(165, 255, 144)">    &lt;button type="submit">Submit&lt;/button></span><br></span><span class=token-line style=color:#9EFEFF><span class="token template-string string" style="color:rgb(165, 255, 144)">&lt;/form></span><br></span><span class=token-line style=color:#9EFEFF><span class="token template-string string" style="color:rgb(165, 255, 144)">&lt;/body></span><br></span><span class=token-line style=color:#9EFEFF><span class="token template-string string" style="color:rgb(165, 255, 144)">&lt;/html></span><br></span><span class=token-line style=color:#9EFEFF><span class="token template-string string" style="color:rgb(165, 255, 144)"></span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">router</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">get</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">'/'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> next</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=></span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  ctx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">body </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">formHtml</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"We'd like to email you"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">router</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">post</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">'/'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">koaBody</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> next</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=></span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">request</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">body</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">email</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// Send a message</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> sent </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">pubsub</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">publish</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">/* pubSubName */</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'weather-forecast-pub-sub'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">/* topic */</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'weather-forecasts'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">/* data */</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          email</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">request</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">body</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">email</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      ctx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">body </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">formHtml</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token template-string string" style="color:rgb(165, 255, 144)">Message sent: </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation">sent</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      ctx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">body </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">formHtml</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">'No email supplied'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">exc</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token builtin" style="color:rgb(250, 208, 0)">console</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">error</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">'Problem calling weather service'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> exc</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    ctx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">body </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'Something went wrong!'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">use</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">router</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">routes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">use</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">router</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">allowedMethods</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> portNumber </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">3000</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">listen</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">portNumber</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token builtin" style="color:rgb(250, 208, 0)">console</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">log</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token template-string string" style="color:rgb(165, 255, 144)">listening on port </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation">portNumber</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>The thing to note above is the <code>client.pubsub.publish</code>; our WebService will now be publishing using pubsub, instead of using axios and service invocation.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=subscribing>Subscribing<a href=#subscribing class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>Our WeatherService needs to be able to receive what is published. To make that happen, we'll make use of the following NuGet package in WeatherService:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token plain">dotnet </span><span class="token function" style="color:rgb(250, 208, 0)">add</span><span class="token plain"> package Dapr.AspNetCore </span><span class="token parameter variable" style="color:rgb(255, 238, 128)">--version</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">1.7</span><span class="token plain">.0</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Our <code>Program.cs</code> is adjusted to cater for this:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Config</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> builder </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> WebApplication</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">CreateBuilder</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">args</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">builder</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token generic-method function" style="color:rgb(250, 208, 0)">Configure</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)">MailConfig</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">></span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">builder</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Configuration</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetSection</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"Mail"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">builder</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AddControllers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AddDapr</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">builder</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AddEndpointsApiExplorer</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">builder</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AddSwaggerGen</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> app </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> builder</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Build</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// Configure the HTTP request pipeline.</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Environment</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">IsDevelopment</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">UseSwagger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">UseSwaggerUI</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">UseAuthorization</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">UseCloudEvents</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">MapSubscribeHandler</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// This is the Dapr subscribe handler</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">MapControllers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Run</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>The significant pieces above are:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token plain">builder</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AddControllers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AddDapr</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">UseCloudEvents</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">MapSubscribeHandler</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// This is the Dapr subscribe handler</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>We'll also need to update our <code>WeatherForecastController.cs</code>:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Config</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Microsoft</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">AspNetCore</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Mvc</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Microsoft</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Extensions</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Options</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">RestSharp</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">RestSharp</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Authenticators</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Dapr</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">namespace</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">WeatherService</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Controllers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token attribute class-name" style="color:rgb(250, 208, 0)">ApiController</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">WeatherForecastController</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token type-list class-name" style="color:rgb(250, 208, 0)">ControllerBase</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">static</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> Summaries </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token string" style="color:rgb(165, 255, 144)">"Freezing"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Bracing"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Chilly"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Cool"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Mild"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Warm"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Balmy"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Hot"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Sweltering"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Scorching"</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">WeatherForecastController</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">></span><span class="token plain"> _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">MailConfig</span><span class="token plain"> _options</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">WeatherForecastController</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">WeatherForecastController</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">></span><span class="token plain"> logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">IOptions</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">MailConfig</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">></span><span class="token plain"> options</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        _logger </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        _options </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> options</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">record</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">SendWeatherForecastBody</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> Email</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token attribute class-name" style="color:rgb(250, 208, 0)">Topic</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token attribute attribute-arguments named-parameter punctuation" style="color:rgb(255, 255, 255)">pubsubName</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token attribute attribute-arguments"> </span><span class="token attribute attribute-arguments string" style="color:rgb(165, 255, 144)">"weather-forecast-pub-sub"</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token attribute attribute-arguments"> </span><span class="token attribute attribute-arguments named-parameter punctuation" style="color:rgb(255, 255, 255)">name</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token attribute attribute-arguments"> </span><span class="token attribute attribute-arguments string" style="color:rgb(165, 255, 144)">"weather-forecasts"</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token attribute class-name" style="color:rgb(250, 208, 0)">HttpPost</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token attribute attribute-arguments string" style="color:rgb(165, 255, 144)">"SendWeatherForecast"</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Task</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">ActionResult</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token return-type class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">></span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">></span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">SendWeatherForecast</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">SendWeatherForecastBody</span><span class="token plain"> body</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">try</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">string</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">IsNullOrEmpty</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">body</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Email</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">throw</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"Email required"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> weatherForecast </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> Enumerable</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Range</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token number" style="color:rgb(255, 98, 140)">1</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">5</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Select</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">index </span><span class="token operator" style="color:rgb(255, 157, 0)">=></span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">WeatherForecast</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                Date </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> DateTime</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Now</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AddDays</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">index</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                TemperatureC </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> Random</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Shared</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Next</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token operator" style="color:rgb(255, 157, 0)">-</span><span class="token number" style="color:rgb(255, 98, 140)">20</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">55</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                Summary </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> Summaries</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">Random</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Shared</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Next</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">Summaries</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">ToArray</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> toEmailAddress </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> body</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Email</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> text </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$@"The weather forecast is:</span><br></span><span class=token-line style=color:#9EFEFF><span class="token interpolation-string string" style="display:inline-block;color:rgb(165, 255, 144)"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"></span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">string</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp function" style="color:rgb(250, 208, 0)">Join</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp string" style="color:rgb(165, 255, 144)">"\n"</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token interpolation-string interpolation expression language-csharp"> weatherForecast</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp function" style="color:rgb(250, 208, 0)">Select</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">wf </span><span class="token interpolation-string interpolation expression language-csharp operator" style="color:rgb(255, 157, 0)">=></span><span class="token interpolation-string interpolation expression language-csharp"> </span><span class="token interpolation-string interpolation expression language-csharp interpolation-string string" style="color:rgb(165, 255, 144)">$"On </span><span class="token interpolation-string interpolation expression language-csharp interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp interpolation-string interpolation expression language-csharp">wf</span><span class="token interpolation-string interpolation expression language-csharp interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp interpolation-string interpolation expression language-csharp">Date</span><span class="token interpolation-string interpolation expression language-csharp interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string interpolation expression language-csharp interpolation-string string" style="color:rgb(165, 255, 144)"> the weather will be </span><span class="token interpolation-string interpolation expression language-csharp interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp interpolation-string interpolation expression language-csharp">wf</span><span class="token interpolation-string interpolation expression language-csharp interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp interpolation-string interpolation expression language-csharp">Summary</span><span class="token interpolation-string interpolation expression language-csharp interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string interpolation expression language-csharp interpolation-string string" style="color:rgb(165, 255, 144)">"</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">SendSimpleMessage</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">toEmailAddress</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> toEmailAddress</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">text</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> text</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">Ok</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"We have mailed </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">toEmailAddress</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> with the following:\n\n</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">text</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">)"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token plain"> exc</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogError</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">exc</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Problem!"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">BadRequest</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">exc</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Message</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Task</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">RestResponse</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">></span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">SendSimpleMessage</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> toEmailAddress</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> text</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">RestClient</span><span class="token plain"> client </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">RestClientOptions</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            BaseUrl </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Uri</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"https://api.mailgun.net/v3"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            Authenticator </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">HttpBasicAuthenticator</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"api"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> _options</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">MailgunApiKey</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">RestRequest</span><span class="token plain"> request </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        request</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AddParameter</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"domain"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"mg.priou.co.uk"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> ParameterType</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">UrlSegment</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        request</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Resource </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"{domain}/messages"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        request</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AddParameter</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"from"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"John Reilly &lt;johnny_reilly@hotmail.com>"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        request</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AddParameter</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"to"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> toEmailAddress</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        request</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AddParameter</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"subject"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Weather forecast"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        request</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AddParameter</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"text"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> text</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">PostAsync</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">request</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Really the only new thing here is the <code>Topic</code> attribute on the <code>SendWeatherForecast</code> endpoint:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token attribute class-name" style="color:rgb(250, 208, 0)">Topic</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token attribute attribute-arguments named-parameter punctuation" style="color:rgb(255, 255, 255)">pubsubName</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token attribute attribute-arguments"> </span><span class="token attribute attribute-arguments string" style="color:rgb(165, 255, 144)">"weather-forecast-pub-sub"</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token attribute attribute-arguments"> </span><span class="token attribute attribute-arguments named-parameter punctuation" style="color:rgb(255, 255, 255)">name</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token attribute attribute-arguments"> </span><span class="token attribute attribute-arguments string" style="color:rgb(165, 255, 144)">"weather-forecasts"</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>This is used (as you might imagine) to route messages.</p>
<p>The real difference to call out in what we've done so far, is that both our publisher (Node.js) and our subscriber (.NET) have become "dapr aware". Although there have been changes in our code to achieve this, they have not been extensive. Noisy, yes. But not big changes.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=components>Components<a href=#components class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>In order to communicate via pubsub, dapr needs some <a href=https://docs.dapr.io/concepts/components-concept/ target=_blank rel="noopener noreferrer">components</a> in place. We'll create a folder in the root of our project named <code>components</code>, and in there create three files:</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=pubsubyaml><code>pubsub.yaml</code><a href=#pubsubyaml class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h4>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> dapr.io/v1alpha1</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Component</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> weather</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">forecast</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">pub</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">sub</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> default</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> pubsub.redis</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> v1</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> redisHost</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> localhost</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token number" style="color:rgb(255, 98, 140)">6379</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> redisPassword</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">''</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token key atrule">scopes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">app</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> dotnet</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">app</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=statestoreyaml><code>statestore.yaml</code><a href=#statestoreyaml class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h4>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> dapr.io/v1alpha1</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Component</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> statestore</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> default</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> state.redis</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> v1</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> redisHost</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> localhost</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token number" style="color:rgb(255, 98, 140)">6379</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> redisPassword</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">''</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> actorStateStore</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'true'</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=subscriptionyaml><code>subscription.yaml</code><a href=#subscriptionyaml class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h4>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> dapr.io/v1alpha1</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Subscription</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> weather</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">forecast</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">pub</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">sub</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">topic</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> weather</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">forecasts</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">route</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> /SendWeatherForecast</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">pubsubname</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> weather</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">forecast</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">pub</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">sub</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token key atrule">scopes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">app</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> dotnet</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">app</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>These three files are fairly self-explanatory. It's worth drawing attention to the following though:</p>
<ol>
<li>We're going to use these components when running locally and so we'll use Redis for our persistence. When we deploy to Azure Container Apps we'll use something more Azure specific.</li>
<li>We're granting access in these components to our node-app (WebService) and our dotnet-app (WeatherService)</li>
<li>We're wiring up our subscription in <code>subscription.yaml</code>- it's this that will be used to route traffic from publishing to subscription.</li>
</ol>
<p>With the above in place we're almost ready to be able to run this locally and debug using VS Code. The final tweak is to make our apps aware of the dapr components. This is achieved by adding <code>"componentsPath": "./components",</code> to the entries in our <code>tasks.json</code> file. In full it looks like this:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-json codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// See https://go.microsoft.com/fwlink/?LinkId=733558</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// for the documentation about the tasks.json format</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"version"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"2.0.0"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"tasks"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"label"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"dotnet-build"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"command"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"dotnet"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"type"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"process"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"args"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token string" style="color:rgb(165, 255, 144)">"build"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token string" style="color:rgb(165, 255, 144)">"${workspaceFolder}/WeatherService/WeatherService.csproj"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token string" style="color:rgb(165, 255, 144)">"/property:GenerateFullPaths=true"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token string" style="color:rgb(165, 255, 144)">"/consoleloggerparameters:NoSummary"</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"problemMatcher"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"$msCompile"</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"label"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"daprd-debug-dotnet"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"appId"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"dotnet-app"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"appPort"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">5000</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"httpPort"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">3500</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"grpcPort"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">50000</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"metricsPort"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">9090</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"componentsPath"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"./components"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"type"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"daprd"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"dependsOn"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">"dotnet-build"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"label"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"daprd-down-dotnet"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"appId"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"dotnet-app"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"type"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"daprd-down"</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"label"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"npm-install"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"type"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"shell"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"command"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"npm install"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"options"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">"cwd"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"${workspaceFolder}/WebService"</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"label"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"webservice-build"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"type"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"typescript"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"tsconfig"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"WebService/tsconfig.json"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"problemMatcher"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">"$tsc"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"group"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">"kind"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"build"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">"isDefault"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"dependsOn"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">"npm-install"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"label"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"daprd-debug-node"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"appId"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"node-app"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"appPort"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">3000</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"httpPort"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">3501</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"grpcPort"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">50001</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"metricsPort"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">9091</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"componentsPath"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"./components"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"type"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"daprd"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"dependsOn"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">"webservice-build"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"label"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"daprd-down-node"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"appId"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"node-app"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"type"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"daprd-down"</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>With this in place we're ready to run our apps locally using pubsub. We can publish from the WebService and receive in the WeatherService. This results in the expected email being sent, as we would hope.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=bicep>Bicep<a href=#bicep class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>The missing piece is Azure. How do we deploy this to Azure Container Apps? Well, we have everything we need to do this, save for the Bicep. We need to augment the Bicep we already have to include our Azure Container Apps dapr components. The full template looks like this:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> branchName </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> webServiceImage </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> webServicePort </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">int</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> webServiceIsExternalIngress </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">bool</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> weatherServiceImage </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> weatherServicePort </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">int</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> weatherServiceIsExternalIngress </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">bool</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> containerRegistry </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> containerRegistryUsername </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token decorator">@secure</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> containerRegistryPassword </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> tags </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">object</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token decorator">@secure</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> MAIL__MAILGUNAPIKEY </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> location </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">resourceGroup</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">location</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token decorator">@description</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">'Storage Account type'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token decorator">@allowed</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token string" style="color:rgb(165, 255, 144)">'Premium_LRS'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token string" style="color:rgb(165, 255, 144)">'Premium_ZRS'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token string" style="color:rgb(165, 255, 144)">'Standard_GRS'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token string" style="color:rgb(165, 255, 144)">'Standard_GZRS'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token string" style="color:rgb(165, 255, 144)">'Standard_LRS'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token string" style="color:rgb(165, 255, 144)">'Standard_RAGRS'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token string" style="color:rgb(165, 255, 144)">'Standard_RAGZRS'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token string" style="color:rgb(165, 255, 144)">'Standard_ZRS'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> storageAccountType </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'Standard_LRS'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token decorator">@description</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">'The name of the Storage Account'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> storageAccountName </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">'store</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token interpolated-string interpolation expression function" style="color:rgb(250, 208, 0)">uniqueString</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolated-string interpolation expression function" style="color:rgb(250, 208, 0)">resourceGroup</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolated-string interpolation expression">id</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> serviceBusNamespace </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'pubsub-namespace'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> storageAccount </span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.Storage/storageAccounts@2021-06-01'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> storageAccountName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">location</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> location</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">sku</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> storageAccountType</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">kind</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'StorageV2'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">properties</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> serviceBus </span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.ServiceBus/namespaces@2021-06-01-preview'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> serviceBusNamespace</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">location</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> location</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> servicebus_authrule </span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.ServiceBus/namespaces/AuthorizationRules@2021-06-01-preview'</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">existing</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'RootManageSharedAccessKey'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">parent</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> serviceBus</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> topic </span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.ServiceBus/namespaces/topics@2021-06-01-preview'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'weather-forecasts'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">parent</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> serviceBus</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> minReplicas </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">1</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> maxReplicas </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">1</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> branch </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">toLower</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token function" style="color:rgb(250, 208, 0)">last</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token function" style="color:rgb(250, 208, 0)">split</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">branchName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'/'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> environmentName </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'shared-env'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> workspaceName </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">'</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token interpolated-string interpolation expression">branch</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">-log-analytics'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> appInsightsName </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">'</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token interpolated-string interpolation expression">branch</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">-app-insights'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> webServiceContainerAppName </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">'</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token interpolated-string interpolation expression">branch</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">-web'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> weatherServiceContainerAppName </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">'</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token interpolated-string interpolation expression">branch</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">-weather'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> containerRegistryPasswordRef </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'container-registry-password'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> mailgunApiKeyRef </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'mailgun-api-key'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> workspace </span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.OperationalInsights/workspaces@2021-12-01-preview'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> workspaceName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">location</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> location</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">tags</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> tags</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">properties</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">sku</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'PerGB2018'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">retentionInDays</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">30</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">workspaceCapping</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> appInsights </span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.Insights/components@2020-02-02'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> appInsightsName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">location</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> location</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">tags</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> tags</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">kind</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'web'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">properties</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">Application_Type</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'web'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">Flow_Type</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'Bluefield'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> environment </span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.App/managedEnvironments@2022-01-01-preview'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> environmentName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">location</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> location</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">tags</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> tags</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">properties</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">daprAIInstrumentationKey</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> appInsights</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">InstrumentationKey</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">appLogsConfiguration</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">destination</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'log-analytics'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">logAnalyticsConfiguration</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">customerId</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> workspace</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">customerId</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">sharedKey</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">listKeys</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">workspace</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">id</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> workspace</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">apiVersion</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">primarySharedKey</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> statestoreComponent </span><span class="token string" style="color:rgb(165, 255, 144)">'daprComponents@2022-03-01'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'statestore'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">properties</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">componentType</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'state.azure.blobstorage'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">version</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'v1'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">ignoreErrors</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">false</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">initTimeout</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'5s'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">secrets</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'storageaccountkey'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">listKeys</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token function" style="color:rgb(250, 208, 0)">resourceId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.Storage/storageAccounts/'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> storageAccount</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> storageAccount</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">apiVersion</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">keys</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token number" style="color:rgb(255, 98, 140)">0</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">value</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">metadata</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'accountName'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> storageAccount</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">name</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'containerName'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'storage_container_name'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'accountKey'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">secretRef</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'storageaccountkey'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">scopes</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        weatherServiceContainerAppName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        webServiceContainerAppName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> pubsubComponent </span><span class="token string" style="color:rgb(165, 255, 144)">'daprComponents@2022-03-01'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'weather-forecast-pub-sub'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">properties</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">componentType</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'pubsub.azure.servicebus'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">version</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'v1'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">metadata</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'connectionString'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">secretRef</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'sb-root-connectionstring'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">secrets</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'sb-root-connectionstring'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">listKeys</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">'</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token interpolated-string interpolation expression">serviceBus</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolated-string interpolation expression">id</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">/AuthorizationRules/RootManageSharedAccessKey'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> serviceBus</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">apiVersion</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">primaryConnectionString</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">scopes</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        weatherServiceContainerAppName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        webServiceContainerAppName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> weatherServiceContainerApp </span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.App/containerApps@2022-01-01-preview'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> weatherServiceContainerAppName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">tags</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> tags</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">location</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> location</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">properties</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">managedEnvironmentId</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> environment</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">id</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">configuration</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">dapr</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">enabled</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">appPort</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> weatherServicePort</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">appId</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> weatherServiceContainerAppName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">secrets</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerRegistryPasswordRef</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerRegistryPassword</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> mailgunApiKeyRef</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> MAIL__MAILGUNAPIKEY</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">registries</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">server</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerRegistry</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">username</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerRegistryUsername</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">passwordSecretRef</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerRegistryPasswordRef</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">ingress</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">external</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> weatherServiceIsExternalIngress</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">targetPort</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> weatherServicePort</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">template</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">containers</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">image</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> weatherServiceImage</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> weatherServiceContainerAppName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">env</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'MAIL__MAILGUNAPIKEY'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">secretRef</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> mailgunApiKeyRef</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">scale</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">minReplicas</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> minReplicas</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">maxReplicas</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> maxReplicas</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> webServiceContainerApp </span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.App/containerApps@2022-01-01-preview'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> webServiceContainerAppName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">tags</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> tags</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">location</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> location</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">properties</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">managedEnvironmentId</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> environment</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">id</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">configuration</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">dapr</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">enabled</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">appPort</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> webServicePort</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">appId</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> webServiceContainerAppName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">secrets</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerRegistryPasswordRef</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerRegistryPassword</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">registries</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">server</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerRegistry</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">username</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerRegistryUsername</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">passwordSecretRef</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerRegistryPasswordRef</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">ingress</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">external</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> webServiceIsExternalIngress</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">targetPort</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> webServicePort</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">template</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">containers</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">image</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> webServiceImage</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> webServiceContainerAppName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">env</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'WEATHER_SERVICE_NAME'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> weatherServiceContainerAppName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">scale</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">minReplicas</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> minReplicas</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">maxReplicas</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> maxReplicas</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">output</span><span class="token plain"> webServiceUrl </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> webServiceContainerApp</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">latestRevisionFqdn</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Now this is undeniably a big lump of Bicep. Let's drill into the significant differences:</p>
<ol>
<li>We're creating an Azure storage account.</li>
<li>We're creating an Azure Service Bus and a topic under it named <code>'weather-forecasts'</code>.</li>
<li>Underneath our managed environment, we're creating a statestore (using the storage account) which is the Azure equivalent of our <code>statestore.yml</code>, but using Azure storage.</li>
<li>Also underneath our managed environment, we're creating a pubsub (using the service bus) which is the Azure equivalent of our <code>pubsub.yml</code>, but using our Azure ServiceBus.</li>
</ol>
<p>It's also worth noting that we always have an instance of the services running; <code>minReplicas: 1</code>. This is because when we dial it down to 0, the Weather Service will stop running. Probably there's a fancy KEDA trigger that prevents this; I haven't figured it out.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=no-declarative-pubsub-subscription-support>No declarative pubsub subscription support<a href=#no-declarative-pubsub-subscription-support class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>Whilst you might be thinking "we're home free now!" - it turns out we're not. Whilst we'd created Azure equivalents of our <code>statestore.yml</code> and <code>pubsub.yml</code>, you'll note there didn't seem to be an equivalent of the <code>subscriptions</code> component in Bicep.</p>
<p><a href="https://docs.microsoft.com/en-us/azure/container-apps/dapr-overview?tabs=bicep1%2Cyaml#known-limitations" target=_blank rel="noopener noreferrer">It turns out support for declarative pub/sub subscriptions is not yet available</a>:</p>
<blockquote>
<p>Known limitations
Declarative pub/sub subscriptions</p>
</blockquote>
<p>So whilst we can take the code we have here and run locally, we cannot deploy it to Azure.</p>
<p>However, whilst there's no declaritive support for subscriptions, there is programmatic support. It involves more of a pivot in how we put together our code. But since it's the only game in town, we'll give it a go.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=you-got-mail-programmatic-subscriptions>You got mail: programmatic subscriptions!<a href=#you-got-mail-programmatic-subscriptions class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>We can get rid of our <code>subscriptions.yaml</code> file now - we're going programmatic instead of declarative.</p>
<p>We're going to replace our <code>WeatherForecastController.cs</code> with a <code>WeatherForecastEndpoints.cs</code> which contains very similar code, but uses the .NET 6 minimal API approach instead: (There appears to be a way to work with MVC but it's not clear how to use it, and it appears to be a more confusing approach than the .NET 6 minimal API approach.)</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Config</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Microsoft</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Extensions</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Options</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">RestSharp</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">RestSharp</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Authenticators</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Dapr</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">namespace</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">WeatherService</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Endpoints</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">static</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">WeatherForecastEndpoints</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">static</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> Summaries </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token string" style="color:rgb(165, 255, 144)">"Freezing"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Bracing"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Chilly"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Cool"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Mild"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Warm"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Balmy"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Hot"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Sweltering"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Scorching"</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">record</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">SendWeatherForecastBody</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> Email</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">static</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">IEndpointRouteBuilder</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">MapWeatherForecastEndpoints</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">this</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">IEndpointRouteBuilder</span><span class="token plain"> endpoints</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        endpoints</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">MapPost</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"/SendWeatherForecast"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token attribute class-name" style="color:rgb(250, 208, 0)">Topic</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token attribute attribute-arguments string" style="color:rgb(165, 255, 144)">"weather-forecast-pub-sub"</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token attribute attribute-arguments"> </span><span class="token attribute attribute-arguments string" style="color:rgb(165, 255, 144)">"weather-forecasts"</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                </span><span class="token class-name" style="color:rgb(250, 208, 0)">SendWeatherForecastBody</span><span class="token plain"> body</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                </span><span class="token class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">SendWeatherForecastBody</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">></span><span class="token plain"> logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                </span><span class="token class-name" style="color:rgb(250, 208, 0)">IOptions</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">MailConfig</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">></span><span class="token plain"> options</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=></span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                </span><span class="token keyword" style="color:rgb(255, 157, 0)">try</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                    </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">string</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">IsNullOrEmpty</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">body</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Email</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">throw</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"Email required"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> weatherForecast </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> Enumerable</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Range</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token number" style="color:rgb(255, 98, 140)">1</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">5</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Select</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">index </span><span class="token operator" style="color:rgb(255, 157, 0)">=></span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">WeatherForecast</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                        Date </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> DateTime</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Now</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AddDays</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">index</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                        TemperatureC </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> Random</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Shared</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Next</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token operator" style="color:rgb(255, 157, 0)">-</span><span class="token number" style="color:rgb(255, 98, 140)">20</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">55</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                        Summary </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> Summaries</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">Random</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Shared</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Next</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">Summaries</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">ToArray</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> toEmailAddress </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> body</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Email</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> text </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$@"The weather forecast is:</span><br></span><span class=token-line style=color:#9EFEFF><span class="token interpolation-string string" style="display:inline-block;color:rgb(165, 255, 144)"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"></span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">string</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp function" style="color:rgb(250, 208, 0)">Join</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp string" style="color:rgb(165, 255, 144)">"\n"</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token interpolation-string interpolation expression language-csharp"> weatherForecast</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp function" style="color:rgb(250, 208, 0)">Select</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">wf </span><span class="token interpolation-string interpolation expression language-csharp operator" style="color:rgb(255, 157, 0)">=></span><span class="token interpolation-string interpolation expression language-csharp"> </span><span class="token interpolation-string interpolation expression language-csharp interpolation-string string" style="color:rgb(165, 255, 144)">$"On </span><span class="token interpolation-string interpolation expression language-csharp interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp interpolation-string interpolation expression language-csharp">wf</span><span class="token interpolation-string interpolation expression language-csharp interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp interpolation-string interpolation expression language-csharp">Date</span><span class="token interpolation-string interpolation expression language-csharp interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string interpolation expression language-csharp interpolation-string string" style="color:rgb(165, 255, 144)"> the weather will be </span><span class="token interpolation-string interpolation expression language-csharp interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp interpolation-string interpolation expression language-csharp">wf</span><span class="token interpolation-string interpolation expression language-csharp interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp interpolation-string interpolation expression language-csharp">Summary</span><span class="token interpolation-string interpolation expression language-csharp interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string interpolation expression language-csharp interpolation-string string" style="color:rgb(165, 255, 144)">"</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                    </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">SendSimpleMessage</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">mailgunApiKey</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> options</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">MailgunApiKey</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">toEmailAddress</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> toEmailAddress</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">text</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> text</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                    </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> Results</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Ok</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"We have mailed </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">toEmailAddress</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> with the following:\n\n</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">text</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">)"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token plain"> exc</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                    logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogError</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">exc</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Problem!"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                    </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> Results</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">BadRequest</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">exc</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Message</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> endpoints</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">static</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Task</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">RestResponse</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">></span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">SendSimpleMessage</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> mailgunApiKey</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> toEmailAddress</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> text</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">RestClient</span><span class="token plain"> client </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">RestClientOptions</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            BaseUrl </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Uri</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"https://api.mailgun.net/v3"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            Authenticator </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">HttpBasicAuthenticator</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"api"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> mailgunApiKey</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">RestRequest</span><span class="token plain"> request </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        request</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AddParameter</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"domain"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"mg.priou.co.uk"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> ParameterType</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">UrlSegment</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        request</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Resource </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"{domain}/messages"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        request</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AddParameter</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"from"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"John Reilly &lt;johnny_reilly@hotmail.com>"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        request</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AddParameter</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"to"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> toEmailAddress</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        request</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AddParameter</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"subject"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Weather forecast"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        request</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AddParameter</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"text"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> text</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">PostAsync</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">request</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>The significant thing to note above is the <code>[Topic("weather-forecast-pub-sub", "weather-forecasts")]</code> that we're adding to our <code>MapPost</code> in the <code>MapWeatherForecastEndpoints</code> method. This is the equivalent of the <code>subscriptions</code> component that we wanted to create in Bicep but couldn't. This is our programmatic subscription.</p>
<p>We also need to tweak our <code>Program.cs</code> to cater for the new <code>WeatherForecastEndpoints</code> class:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Config</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">WeatherService</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Endpoints</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> builder </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> WebApplication</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">CreateBuilder</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">args</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">builder</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token generic-method function" style="color:rgb(250, 208, 0)">Configure</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)">MailConfig</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">></span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">builder</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Configuration</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetSection</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"Mail"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">builder</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AddControllers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AddDapr</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">builder</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AddEndpointsApiExplorer</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">builder</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AddSwaggerGen</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> app </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> builder</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Build</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// Configure the HTTP request pipeline.</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Environment</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">IsDevelopment</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">UseSwagger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">UseSwaggerUI</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">UseAuthorization</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">UseCloudEvents</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">MapSubscribeHandler</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// This is the Dapr subscribe handler</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">MapWeatherForecastEndpoints</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Run</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>So the <code>app.MapWeatherForecastEndpoints();</code> is what wires up our <code>WeatherForecastEndpoints</code> class.</p>
<p>With that in place, we're ready to deploy to Azure.</p>
<p><img decoding=async loading=lazy alt="A gif that demos entering an email address in the form, submitting it and seeing an email arrive with a weather forecast in" src=/assets/images/demo-send-email-with-pubsub-42a65d1ab700b6145f6e994f87806c9f.gif width=1464 height=1228 class=img_ev3q></p>
<p>We now have Azure Container Apps running in Azure, using the dapr pubsub component. Hopefully in future declarative subscribtions will be available also, but for now we can use the programmatic approach.</div><footer class=docusaurus-mt-lg><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class=col><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class=tag_QGVx><a title="The Azure Container Apps service. Effectively a managed Kubernetes service." class="tag_zVej tagRegular_sFm0" href=/tags/azure-container-apps>Azure Container Apps</a><li class=tag_QGVx><a title="The Bicep language for Azure Resource Manager templates." class="tag_zVej tagRegular_sFm0" href=/tags/bicep>Bicep</a></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class=col><a href=https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2022-06-21-azure-container-apps-pubsub/index.md target=_blank rel="noopener noreferrer" class=theme-edit-this-page><svg fill=currentColor height=20 width=20 viewBox="0 0 40 40" class=iconEdit_Z9Sw aria-hidden=true><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"/></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href=/static-web-apps-failed-to-deploy-the-azure-functions><div class=pagination-nav__sublabel>Newer Post</div><div class=pagination-nav__label>Azure Static Web Apps: Failed to deploy the Azure Functions</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/typescript-4-7-and-ecmascript-module-support><div class=pagination-nav__sublabel>Older Post</div><div class=pagination-nav__label>TypeScript 4.7 and ECMAScript Module Support</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#you-got-mail-service-invocation class="table-of-contents__link toc-highlight">You got mail: service invocation</a><ul><li><a href=#net-meet-mailgun class="table-of-contents__link toc-highlight">.NET meet mailgun</a><li><a href=#webservice-gets-a-form class="table-of-contents__link toc-highlight">Webservice gets a form</a><li><a href=#secrets-in-bicep class="table-of-contents__link toc-highlight">Secrets in Bicep</a></ul><li><a href=#you-got-mail-pubsub class="table-of-contents__link toc-highlight">You got mail: pubsub!</a><ul><li><a href=#publishing-with-dapr-client class="table-of-contents__link toc-highlight">Publishing with dapr-client</a><li><a href=#subscribing class="table-of-contents__link toc-highlight">Subscribing</a><li><a href=#components class="table-of-contents__link toc-highlight">Components</a><li><a href=#bicep class="table-of-contents__link toc-highlight">Bicep</a><li><a href=#no-declarative-pubsub-subscription-support class="table-of-contents__link toc-highlight">No declarative pubsub subscription support</a></ul><li><a href=#you-got-mail-programmatic-subscriptions class="table-of-contents__link toc-highlight">You got mail: programmatic subscriptions!</a></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class=footer__title></div><ul class="footer__items clean-list"><li class=footer__item><div class=footer__title><a href=/tags/typescript class=footer__link-item>TypeScript<img src=/img/ts-logo-128.svg alt="TypeScript icon" class=footer__icon></a></div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=/typescript-vs-jsdoc-javascript class=footer__link-item>TypeScript vs JSDoc JavaScript</a><li class=footer__item><a href=/type-annotations-strong-types-weakly-held class=footer__link-item>Type annotations proposal: strong types, weakly held</a></li>
</ul><div class=footer__title><a href=/tags/azure class=footer__link-item>Azure<img src=/img/azure-logo.svg alt="Azure icon" class=footer__icon></a></div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=/azure-container-apps-easy-auth-and-dotnet-authentication class=footer__link-item>Azure Container Apps: Easy Auth and .NET</a><li class=footer__item><a href=/azure-static-web-apps-dynamic-redirects-azure-functions class=footer__link-item>Azure Static Web Apps: dynamic redirects with Azure Functions</a></li>
</ul><div class=footer__title><a href=/tags/asp-net class=footer__link-item>ASP.NET<img src=/img/dotnet-logo.svg alt="ASP.NET icon" class=footer__icon></a></div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=/eslint-your-csharp-in-vs-code-with-roslyn-analyzers class=footer__link-item>ESLint your C# with Roslyn Analyzers</a><li class=footer__item><a href=/aspnet-serilog-and-application-insights class=footer__link-item>ASP.NET, Serilog and Application Insights</a></li>
</ul><div class=footer__title><a href=/tags/react class=footer__link-item>React<img src=/img/react-logo.svg alt="React icon" class=footer__icon></a></div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=/structured-data-seo-and-react class=footer__link-item>Structured data and React</a><li class=footer__item><a href=/react-usesearchparamsstate class=footer__link-item>React: storing state in URL with URLSearchParams</a></li>
</ul></ul></div><div class="col footer__col"><div class=footer__title></div><ul class="footer__items clean-list"><li class=footer__item><div class=footer__title>Notable articles</div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=/definitely-typed-the-movie class=footer__link-item>The history of Definitely Typed<img src=/img/definitely-typed-logo.png alt="The history of Definitely Typed icon" class=footer__icon></a><li class=footer__item><a href=/typescript-documentary class=footer__link-item>TypeScript: the documentary<img src=/img/ts-logo-128.svg alt="TypeScript: the documentary icon" class=footer__icon></a><li class=footer__item><a href=/definitive-guide-to-migrating-from-blogger-to-docusaurus class=footer__link-item>The definitive guide to migrating from Blogger to Docusaurus<img src=/img/docusaurus-logo.svg alt="The definitive guide to migrating from Blogger to Docusaurus icon" class=footer__icon></a><li class=footer__item><a href=/how-we-fixed-my-seo class=footer__link-item>How we fixed my SEO</a></li>
</ul><div class=footer__title>Popular articles</div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=/aspnet-serilog-and-application-insights class=footer__link-item>ASP.NET, Serilog and Application Insights</a><li class=footer__item><a href=/eslint-your-csharp-in-vs-code-with-roslyn-analyzers class=footer__link-item>ESLint your C# with Roslyn Analyzers</a><li class=footer__item><a href=/prettier-your-csharp-with-dotnet-format-and-lint-staged class=footer__link-item>dotnet-format: Prettier your C# with lint-staged & husky</a></li>
</ul><div class=footer__title>Recently updated</div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops class=footer__link-item>Using AZD for faster incremental Azure Container App deployments in Azure DevOps</a><li class=footer__item><a href=azure-artifacts-publish-private-npm-package-with-azure-devops class=footer__link-item>Azure Artifacts: Publish a private npm package with Azure DevOps</a><li class=footer__item><a href=create-pipeline-with-azure-devops-api class=footer__link-item>Create a Pipeline with the Azure DevOps API</a></li>
</ul></ul></div><div class="col footer__col"><div class=footer__title>Learn more / support me</div><ul class="footer__items clean-list"><li class=footer__item><a href=https://github.com/johnnyreilly/blog.johnnyreilly.com target=_blank rel="noopener noreferrer" class=footer__link-item>Blog source code on GitHub<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a class=footer__link-item href=/tags>Blog categories</a><li class=footer__item><a href=https://johnnyreilly.com/rss.xml target=_blank rel="noopener noreferrer" class=footer__link-item>RSS feed<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://johnnyreilly.com/atom.xml target=_blank rel="noopener noreferrer" class=footer__link-item>Atom feed<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a class=footer__link-item href=/privacy-policy>Privacy Policy</a><li class=footer__item><iframe src=https://github.com/sponsors/johnnyreilly/card title="Sponsor johnnyreilly" style="margin-top: 20px; border: 0; border-radius: 10px; background-color: white; min-height: 400px;"></iframe><li class=footer__item><a href=https://www.buymeacoffee.com/qUBm0Wh rel=noopener target=_blank><img src=https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png loading=lazy alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></ul></div></div><div class="footer__bottom text--center"><div class=footer__copyright>Copyright © 2012 - 2024 John Reilly. Built with Docusaurus.</div></div></div></footer></div>