<!doctype html><html lang=en dir=ltr class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.7.0"><title data-rh=true>Task.WhenAll / Select is a footgun ðŸ‘ŸðŸ”« | johnnyreilly</title><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:image content=https://johnnyreilly.com/img/profile.jpg><meta data-rh=true name=twitter:image content=https://johnnyreilly.com/img/profile.jpg><meta data-rh=true property=og:url content=https://johnnyreilly.com/taskwhenall-select-is-footgun><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docusaurus_tag content=default><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=docsearch:docusaurus_tag content=default><meta data-rh=true name=robots content=max-image-preview:large><meta data-rh=true name=monetization content=$ilp.uphold.com/LwQQhXdpwxeJ><meta data-rh=true property=og:title content="Task.WhenAll / Select is a footgun ðŸ‘ŸðŸ”« | johnnyreilly"><meta data-rh=true name=description content="The writer warns against LINQ code that causes concurrent API requests and shares plans for better metrics and a development container."><meta data-rh=true property=og:description content="The writer warns against LINQ code that causes concurrent API requests and shares plans for better metrics and a development container."><meta data-rh=true property=og:type content=article><meta data-rh=true property=article:published_time content=2020-06-21T00:00:00.000Z><meta data-rh=true property=article:author content=https://johnnyreilly.com/about><meta data-rh=true property=article:tag content=C#><link data-rh=true rel=icon href=/favicon.ico><link data-rh=true rel=canonical href=https://johnnyreilly.com/taskwhenall-select-is-footgun><link data-rh=true rel=alternate href=https://johnnyreilly.com/taskwhenall-select-is-footgun hreflang=en><link data-rh=true rel=alternate href=https://johnnyreilly.com/taskwhenall-select-is-footgun hreflang=x-default><link data-rh=true rel=preconnect href=https://J3MYR1INLT-dsn.algolia.net crossorigin=anonymous><script data-rh=true type=application/ld+json>{"@context":"https://schema.org","@id":"https://johnnyreilly.com/taskwhenall-select-is-footgun","@type":"BlogPosting","author":{"@type":"Person","description":"OSS Engineer - TypeScript, Azure, React, Node.js, .NET","image":"https://johnnyreilly.com/img/profile.jpg","name":"John Reilly","url":"https://johnnyreilly.com/about"},"datePublished":"2020-06-21T00:00:00.000Z","description":"The writer warns against LINQ code that causes concurrent API requests and shares plans for better metrics and a development container.","headline":"Task.WhenAll / Select is a footgun ðŸ‘ŸðŸ”«","isPartOf":{"@id":"https://johnnyreilly.com/","@type":"Blog","name":"I CAN MAKE THIS WORK"},"keywords":[],"mainEntityOfPage":"https://johnnyreilly.com/taskwhenall-select-is-footgun","name":"Task.WhenAll / Select is a footgun ðŸ‘ŸðŸ”«","url":"https://johnnyreilly.com/taskwhenall-select-is-footgun"}</script><link rel=alternate type=application/rss+xml href=/rss.xml title="I CAN MAKE THIS WORK RSS Feed"><link rel=alternate type=application/atom+xml href=/atom.xml title="I CAN MAKE THIS WORK Atom Feed"><link rel=search type=application/opensearchdescription+xml title=johnnyreilly href=/opensearch.xml><link rel=icon href=/img/profile-64x64.jpg><link rel=manifest href=/manifest.json><meta name=theme-color content=#3578e5><meta name=apple-mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-status-bar-style content=#000><link rel=apple-touch-icon href=/apple-touch-icon.png><link rel=preload href=https://johnnyreilly.com/fonts/Poppins-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=https://johnnyreilly.com/fonts/Poppins-Bold.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preconnect href=https://res.cloudinary.com><link rel=monetization href=https://ilp.uphold.com/LwQQhXdpwxeJ><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@id":"https://johnnyreilly.com","@type":"WebSite","copyrightHolder":{"@id":"https://johnnyreilly.com/about"},"description":"This is John Reilly's blog. John is an Open Source Software Engineer working on TypeScript, Azure, React, Node.js, .NET and more.","inLanguage":"en-UK","name":"johnnyreilly","potentialAction":{"@type":"SearchAction","query-input":"required name=search_term_string","target":{"@type":"EntryPoint","urlTemplate":"https://johnnyreilly.com/search?q={search_term_string}"}},"publisher":{"@id":"https://johnnyreilly.com/about"},"url":"https://johnnyreilly.com"},{"@id":"https://johnnyreilly.com/about","@type":"Person","address":{"@type":"PostalAddress","addressCountry":"United Kingdom","addressLocality":"London","streetAddress":"Twickenham"},"alternateName":"Johnny Reilly","birthPlace":"Bristol","description":"John is an Open Source Software Engineer working on TypeScript, Azure, React, Node.js, .NET and more. As well as writing code, John is a speaker at meetups, one of the founders of the TS Congress conference, and the author of the history of Definitely Typed, which he worked on in the early days of TypeScript.","email":"johnny_reilly@hotmail.com","image":{"@id":"https://johnnyreilly.com/about#image","@type":"ImageObject","caption":"John Reilly","contentUrl":"https://johnnyreilly.com/img/profile.jpg","height":200,"inLanguage":"en-UK","url":"https://johnnyreilly.com/img/profile.jpg","width":200},"name":"John Reilly","sameAs":["https://github.com/johnnyreilly","https://fosstodon.org/@johnny_reilly","https://twitter.com/johnny_reilly","https://bsky.app/profile/johnnyreilly.com","https://dev.to/johnnyreilly","https://app.daily.dev/johnnyreilly","https://stackoverflow.com/users/761388/john-reilly","https://blog.logrocket.com/author/johnreilly/","https://www.reddit.com/user/johnny_reilly","https://uk.linkedin.com/in/johnnyreilly"],"url":"https://johnnyreilly.com"},{"@id":"https://johnnyreilly.com/about#organization","@type":["Organization","Brand"],"description":"This is John Reilly's blog. John is an Open Source Software Engineer working on TypeScript, Azure, React, Node.js, .NET and more.","image":{"@id":"https://johnnyreilly.com/#logo"},"logo":{"@id":"https://johnnyreilly.com/#logo","@type":"ImageObject","caption":"John Reilly","contentUrl":"https://johnnyreilly.com/img/profile.jpg","height":200,"inLanguage":"en-UK","url":"https://johnnyreilly.com/img/profile.jpg","width":200},"name":"johnnyreilly","sameAs":["https://github.com/johnnyreilly","https://fosstodon.org/@johnny_reilly","https://twitter.com/johnny_reilly","https://bsky.app/profile/johnnyreilly.com","https://dev.to/johnnyreilly","https://app.daily.dev/johnnyreilly","https://stackoverflow.com/users/761388/john-reilly","https://blog.logrocket.com/author/johnreilly/","https://www.reddit.com/user/johnny_reilly","https://uk.linkedin.com/in/johnnyreilly"],"url":"https://johnnyreilly.com"}]}</script><link rel=webmention href=https://webmention.io/johnnyreilly.com/webmention><link rel=stylesheet href=/assets/css/styles.e0b90897.css><script src=/assets/js/runtime~main.8c17f45e.js defer></script><script src=/assets/js/main.636cae87.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><link rel=preload as=image href=/img/profile-64x64.jpg><link rel=preload as=image href=https://johnnyreilly.com/img/profile.jpg><script type=application/ld+json>[{"@context":"https://schema.org","@id":"/taskwhenall-select-is-footgun#breadcrumb","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://johnnyreilly.com","name":"Home","position":1},{"@type":"ListItem","item":"https://johnnyreilly.com/blog","name":"Blog","position":2},{"@type":"ListItem","name":"Task.WhenAll / Select is a footgun ðŸ‘ŸðŸ”«","position":3}],"name":"Blog breadcrumb"}]</script><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><div class=navbar__logo><img src=/img/profile-64x64.jpg alt="Profile picture of John Reilly" class="themedComponent_mlkZ themedComponent--light_NVdE" height=32 width=32><img src=/img/profile-64x64.jpg alt="Profile picture of John Reilly" class="themedComponent_mlkZ themedComponent--dark_xIcU" height=32 width=32></div><b class="navbar__title text--truncate">John Reilly</b></a><a class="navbar__item navbar__link" href=/about>About</a><a class="navbar__item navbar__link" href=/blog>Blog</a><a class="navbar__item navbar__link" href=/talks>Talks</a></div><div class="navbar__items navbar__items--right"><a href=https://github.com/johnnyreilly target=_blank rel=me class="navbar__item navbar__link">GitHub<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><a href=https://bsky.app/profile/johnnyreilly.com target=_blank rel=me class="navbar__item navbar__link">Bluesky<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><a href=https://fosstodon.org/@johnny_reilly target=_blank rel=me class="navbar__item navbar__link">Mastodon<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><a href=https://twitter.com/johnny_reilly target=_blank rel=me class="navbar__item navbar__link">Twitter<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type=button disabled title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live=polite aria-pressed=false><svg viewBox="0 0 24 24" width=24 height=24 class=lightToggleIcon_pyhR><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 class=darkToggleIcon_wfgR><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg></button></div><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class=row><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role=group><h3 class=yearGroupHeading_rMGB>2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/nodejs-azure-appinsights-fastify>Node.js, Azure Application Insights, and Fastify</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/get-service-connections-with-azure-devops-api>Get Service Connections with the Azure DevOps API (REST and TypeScript)</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/slash-command-your-deployment-with-github-actions>Slash command your deployment with GitHub Actions</a></ul></div><div role=group><h3 class=yearGroupHeading_rMGB>2024</h3><ul class="sidebarItemList_Yudw clean-list"><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/smuggling-gitignore-npmrc-in-npm-packages>Smuggling .gitignore, .npmrc and friends in npm packages</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/npx-and-azure-artifacts-the-secret-cli-delivery-mechanism>npx and Azure Artifacts: the secret CLI delivery mechanism</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/azure-artifacts-publish-private-npm-package-with-azure-devops>Azure Artifacts: Publish a private npm package with Azure DevOps</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/introducing-azdo-npm-auth>Introducing azdo-npm-auth (Azure DevOps npm auth)</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/azure-devops-set-user-story-column-api>Azure DevOps API: Set User Story column with the Azure DevOps Client for Node.js</a></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class=title_f1Hy>Task.WhenAll / Select is a footgun ðŸ‘ŸðŸ”«</h1><div class="container_mt6G margin-vert--md"><time datetime=2020-06-21T00:00:00.000Z>June 21, 2020</time> Â· <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href=https://johnnyreilly.com/about target=_blank rel="noopener noreferrer" class=avatar__photo-link><img class="avatar__photo authorImage_XqGP" src=https://johnnyreilly.com/img/profile.jpg alt="John Reilly"></a><div class="avatar__intro authorDetails_lV9A"><div class=avatar__name><a href=https://johnnyreilly.com/about target=_blank rel="noopener noreferrer"><span class=authorName_yefp>John Reilly</span></a></div><small class=authorTitle_nd0D title="OSS Engineer - TypeScript, Azure, React, Node.js, .NET">OSS Engineer - TypeScript, Azure, React, Node.js, .NET</small><div class=authorSocials_rSDt></div></div></div></div></div></header><div id=__blog-post-container class=markdown><p>This post differs from my typical fayre. Most often I write "here's how to do a thing". This is not that. It's more "don't do this thing I did". And maybe also, "how can we avoid a situation like this happening again in future?". On this topic I very much don't have all the answers - but by putting my thoughts down maybe I'll learn and maybe others will educate me. I would love that!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=doing-things-that-dont-scale>Doing things that don't scale<a href=#doing-things-that-dont-scale class=hash-link aria-label="Direct link to heading" title="Direct link to heading">â€‹</a></h2>
<p>The platform that I work on once had zero users. We used to beg people to log in and see what we had built. Those days are (happily) but a memory. We're getting popular.</p>
<p>As our platform has grown in popularity it has revealed some bad choices we made. Approaches that look fine on the surface (and that work just dandy when you have no users) may start to cause problems as your number of users grows.</p>
<p>I wanted to draw attention to one approach in particular that impacted us severely. In this case "impacted us severely" is a euphemism for "brought the site down and caused a critical incident".</p>
<p>You don't want this to happen to you. Trust me. So, what follows is a cautionary tale. The purpose of which is simply this: reader, do you have code of this ilk in your codebase? If you do: out, damn'd spot! out, I say!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=so-cool-so-terrible>So cool, so terrible<a href=#so-cool-so-terrible class=hash-link aria-label="Direct link to heading" title="Direct link to heading">â€‹</a></h2>
<p>I love LINQ. I love a declarative / functional style of coding. It appeals to me on some gut level. I find it tremendously readable. Read any C# of mine and the odds are pretty good that you'll find some LINQ in the mix.</p>
<p>Imagine this scenario: you have a collection of user ids. You want to load the details of each user represented by their id from an API. You want to bag up all of those users into some kind of collection and send it back to the calling code.</p>
<p>Reading that, if you're like me, you're imagining some kind of map operation which loads the user details for each user id. Something like this:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> users </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> userIds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Select</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">userId </span><span class="token operator" style="color:rgb(255, 157, 0)">=></span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">GetUserDetails</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">userId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">ToArray</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// users is User[]</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Lovely. But you'll note that I'm loading users from an API. Oftentimes, APIs are asynchronous. Certainly, in my case they were. So rather than calling a <code>GetUserDetails</code> function I found myself calling a <code>GetUserDetailsAsync</code> function, behind which an HTTP request is being sent and, later, a response is being returned.</p>
<p>So how do we deal with this? <a href="https://docs.microsoft.com/en-us/dotnet/api/system.threading.tasks.task.whenall?view=netcore-3.1#System_Threading_Tasks_Task_WhenAll__1_System_Collections_Generic_IEnumerable_System_Threading_Tasks_Task___0___" target=_blank rel="noopener noreferrer"><code>Task.WhenAll</code></a> my friends!</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> userTasks </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> userIds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Select</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">userId </span><span class="token operator" style="color:rgb(255, 157, 0)">=></span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">GetUserDetailsAsync</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">userId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> users </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> Task</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">WhenAll</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">tasks</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// users is User[]</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>It worked great! Right up until to the point where it didn't. These sorts of shenanigans were fine when we had a minimal number of users... But there came a point where problems arose. It got to the point where that simple looking mapping operation became a cause of many, many, <em>many</em> HTTP requests being fired concurrently. Then bad things started to happen. Not only did we realise we were launching a denial of service attack on the API we were consuming, we were bringing our own application to collapse.</p>
<p>Not a proud day.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=what-is-the-problem>What is the problem?<a href=#what-is-the-problem class=hash-link aria-label="Direct link to heading" title="Direct link to heading">â€‹</a></h2>
<p>Through log analysis, code reading and speculation, (with the help of the invaluable <a href=https://www.linkedin.com/in/robert-grzankowski-53618114 target=_blank rel="noopener noreferrer">Robski</a>) we came to realise that the cause of our woes was the <code>Task.WhenAll</code> / <code>Select</code> combination. Exercising that codepath was a surefire way to bring the application to its knees.</p>
<p>As I read around on the topic I happened upon <a href=https://www.twitter.com/mark_heath target=_blank rel="noopener noreferrer">Mark Heath</a>'s excellent list of <a href=https://markheath.net/post/async-antipatterns target=_blank rel="noopener noreferrer">Async antipatterns</a>. Number #6 on the list is "Excessive parallelization". It describes a nearly identical scenario to my own:</p>
<blockquote>
<p>Now, this does "work", but what if there were 10,000 orders? We've flooded the thread pool with thousands of tasks, potentially preventing other useful work from completing. If <code>ProcessOrderAsync</code> makes downstream calls to another service like a database or a microservice, we'll potentially overload that with too high a volume of calls.</p>
</blockquote>
<p>We're definitely overloading the API we're consuming with too high a volume of calls. I have to admit that I'm less clear on the direct reason that a <code>Task.WhenAll</code> / <code>Select</code> combination could prove fatal to our application. Mark suggests this approach will flood the thread pool with tasks. As I read around on <code>async</code> and <code>await</code> it's repeated again and again that a <code>Task</code> is not the same thing as a <code>Thread</code>. I have to hold my hands up here and say that I don't understand the implementation of <code>async</code> / <code>await</code> in C# well enough. <a href=https://docs.microsoft.com/en-us/dotnet/standard/async-in-depth#deeper-dive-into-tasks-for-an-io-bound-operation target=_blank rel="noopener noreferrer">These docs are helpful but I still don't think the penny has fully dropped for me yet.</a> I will continue to read.</p>
<p>One thing we learned as we debugged the production k8s pod was that, prior to its collapse, our app appeared to be opening up 1 million connections to the API we were consuming. Which seemed a bit much. Worthy of investigation. It's worth saying that we're not certain this is exactly what is happening; we have less instrumentation in place than we'd like. But some fancy wc grepping on Robski's behalf suggested this was the case.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=what-will-we-change-in-future>What will we change in future?<a href=#what-will-we-change-in-future class=hash-link aria-label="Direct link to heading" title="Direct link to heading">â€‹</a></h2>
<p>A learning that came out of this for us was this: we need more metrics exposed. We don't understand our application's behaviour under load as well as we'd like. So we're planning to do some work with <a href=https://www.app-metrics.io/ target=_blank rel="noopener noreferrer">App Metrics</a> and <a href=https://grafana.com/ target=_blank rel="noopener noreferrer">Grafana</a> so we've a better idea of how our application performs. If you want to improve something, first measure it.</p>
<p>Another fly in the ointment was that we were unable to reproduce the issue when running locally. It's worth saying here that I develop on a Windows machine and, when deployed, our application runs in a (Linux) Docker container. So there's a difference and a distance between our development experience and our running one.</p>
<p>I'm planning to migrate to developing in a <a href=https://code.visualstudio.com/docs/remote/containers target=_blank rel="noopener noreferrer">devcontainer</a> where that's possible. That should narrow the gap between our production experience and our development one. Reducing the difference between the two is always useful as it means you're less likely to get different behaviour (ie "problems") in production as compared to development. I'm curious as to whether I'll be able to replicate that behaviour in a devcontainer.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=what-did-we-do-right-now>What did we do right now?<a href=#what-did-we-do-right-now class=hash-link aria-label="Direct link to heading" title="Direct link to heading">â€‹</a></h2>
<p>To solve the immediate issue we were able to pivot away to a completely different approach. We moved aggregation from our ASP.NET Core web application to our TypeScript / React client with a (pretty sweet) custom hook. The topic for a subsequent blog post.</p>
<p>Moving to a different approach solved my immediate issue. But it left me puzzling. What was actually going wrong? Is it thread pool exhaustion? Is it something else? So many possibilities!</p>
<p>If anyone has any insights they'd like to share that would be incredible! I've also <a href=https://stackoverflow.com/questions/62490098/task-whenall-with-select-is-a-footgun-but-why/62490705 target=_blank rel="noopener noreferrer">asked a question on Stack Overflow</a> which has kindly had answers from generous souls. <a href=https://twitter.com/jamesskimming target=_blank rel="noopener noreferrer">James Skimming</a>'s answer lead me to <a href=https://www.stevejgordon.co.uk/httpclient-connection-pooling-in-dotnet-core target=_blank rel="noopener noreferrer">Steve Gordon's excellent post on connection pooling</a> which I'm still absorbing and seems like it could be relevant.</div><footer class=docusaurus-mt-lg><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class=col><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class=tag_QGVx><a title="The C# programming language." class="tag_zVej tagRegular_sFm0" href=/tags/csharp>C#</a></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class=col><a href=https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2020-06-21-taskwhenall-select-is-footgun/index.md target=_blank rel="noopener noreferrer" class=theme-edit-this-page><svg fill=currentColor height=20 width=20 viewBox="0 0 40 40" class=iconEdit_Z9Sw aria-hidden=true><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"/></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href=/devcontainers-and-ssl-interception><div class=pagination-nav__sublabel>Newer Post</div><div class=pagination-nav__label>Devcontainers and SSL interception</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/autofac-webapplicationfactory-integration-tests><div class=pagination-nav__sublabel>Older Post</div><div class=pagination-nav__label>Autofac, WebApplicationFactory and integration tests</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#doing-things-that-dont-scale class="table-of-contents__link toc-highlight">Doing things that don't scale</a><li><a href=#so-cool-so-terrible class="table-of-contents__link toc-highlight">So cool, so terrible</a><li><a href=#what-is-the-problem class="table-of-contents__link toc-highlight">What is the problem?</a><li><a href=#what-will-we-change-in-future class="table-of-contents__link toc-highlight">What will we change in future?</a><li><a href=#what-did-we-do-right-now class="table-of-contents__link toc-highlight">What did we do right now?</a></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class=footer__title></div><ul class="footer__items clean-list"><li class=footer__item><div class=footer__title><a href=/tags/typescript class=footer__link-item>TypeScript<img src=/img/ts-logo-128.svg alt="TypeScript icon" class=footer__icon></a></div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=/typescript-vs-jsdoc-javascript class=footer__link-item>TypeScript vs JSDoc JavaScript</a><li class=footer__item><a href=/type-annotations-strong-types-weakly-held class=footer__link-item>Type annotations proposal: strong types, weakly held</a></li>
</ul><div class=footer__title><a href=/tags/azure class=footer__link-item>Azure<img src=/img/azure-logo.svg alt="Azure icon" class=footer__icon></a></div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=/azure-container-apps-easy-auth-and-dotnet-authentication class=footer__link-item>Azure Container Apps: Easy Auth and .NET</a><li class=footer__item><a href=/introducing-azdo-npm-auth class=footer__link-item>Introducing azdo-npm-auth (Azure DevOps npm auth)</a><li class=footer__item><a href=/npx-and-azure-artifacts-the-secret-cli-delivery-mechanism class=footer__link-item>npx and Azure Artifacts: the secret CLI delivery mechanism</a><li class=footer__item><a href=/azure-static-web-apps-dynamic-redirects-azure-functions class=footer__link-item>Azure Static Web Apps: dynamic redirects with Azure Functions</a></li>
</ul><div class=footer__title><a href=/tags/asp-net class=footer__link-item>ASP.NET<img src=/img/dotnet-logo.svg alt="ASP.NET icon" class=footer__icon></a></div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=/eslint-your-csharp-in-vs-code-with-roslyn-analyzers class=footer__link-item>ESLint your C# with Roslyn Analyzers</a><li class=footer__item><a href=/aspnet-serilog-and-application-insights class=footer__link-item>ASP.NET, Serilog and Application Insights</a></li>
</ul><div class=footer__title><a href=/tags/react class=footer__link-item>React<img src=/img/react-logo.svg alt="React icon" class=footer__icon></a></div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=/structured-data-seo-and-react class=footer__link-item>Structured data and React</a><li class=footer__item><a href=/react-usesearchparamsstate class=footer__link-item>React: storing state in URL with URLSearchParams</a></li>
</ul></ul></div><div class="col footer__col"><div class=footer__title></div><ul class="footer__items clean-list"><li class=footer__item><div class=footer__title>Notable articles</div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=/definitely-typed-the-movie class=footer__link-item>The history of Definitely Typed<img src=/img/definitely-typed-logo.png alt="The history of Definitely Typed icon" class=footer__icon></a><li class=footer__item><a href=/typescript-documentary class=footer__link-item>TypeScript: the documentary<img src=/img/ts-logo-128.svg alt="TypeScript: the documentary icon" class=footer__icon></a><li class=footer__item><a href=/how-we-fixed-my-seo class=footer__link-item>How we fixed my SEO</a></li>
</ul><div class=footer__title>Popular articles</div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=/aspnet-serilog-and-application-insights class=footer__link-item>ASP.NET, Serilog and Application Insights</a><li class=footer__item><a href=/eslint-your-csharp-in-vs-code-with-roslyn-analyzers class=footer__link-item>ESLint your C# with Roslyn Analyzers</a><li class=footer__item><a href=/prettier-your-csharp-with-dotnet-format-and-lint-staged class=footer__link-item>dotnet-format: Prettier your C# with lint-staged & husky</a></li>
</ul><div class=footer__title>Recently updated</div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=static-web-apps-cli-node-18-could-not-connect-to-api class=footer__link-item>Static Web Apps CLI and Node.js 18: could not connect to API</a><li class=footer__item><a href=static-web-apps-cli-improve-performance-with-vite-server-proxy class=footer__link-item>Static Web Apps CLI: improve performance with Vite server proxy</a><li class=footer__item><a href=web-workers-comlink-vite-tanstack-query class=footer__link-item>Web Workers, Comlink, Vite and TanStack Query</a></li>
</ul></ul></div><div class="col footer__col"><div class=footer__title>Learn more / support me</div><ul class="footer__items clean-list"><li class=footer__item><a class=footer__link-item href=/about>About me</a><li class=footer__item><a href=https://github.com/johnnyreilly/blog.johnnyreilly.com target=_blank rel="noopener noreferrer" class=footer__link-item>Blog source code on GitHub<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a class=footer__link-item href=/tags>Blog categories</a><li class=footer__item><a href=https://johnnyreilly.com/rss.xml target=_blank rel="noopener noreferrer" class=footer__link-item>RSS feed<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://johnnyreilly.com/atom.xml target=_blank rel="noopener noreferrer" class=footer__link-item>Atom feed<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a class=footer__link-item href=/privacy-policy>Privacy Policy</a><li class=footer__item><iframe src=https://github.com/sponsors/johnnyreilly/card title="Sponsor johnnyreilly" style="margin-top: 20px; border: 0; border-radius: 10px; background-color: white; min-height: 400px;"></iframe><li class=footer__item><a href=https://www.buymeacoffee.com/qUBm0Wh rel=noopener target=_blank><img src=https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png loading=lazy alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></ul></div></div><div class="footer__bottom text--center"><div class=footer__copyright>Copyright Â© 2012 - 2025 John Reilly. Built with Docusaurus.</div></div></div></footer></div>