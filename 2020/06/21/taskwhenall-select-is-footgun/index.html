<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-226F0LR9KE"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-226F0LR9KE",{anonymize_ip:!0})</script>
<link rel="search" type="application/opensearchdescription+xml" title="I CAN MAKE THIS WORK" href="/opensearch.xml">
<link rel="icon" href="/img/favicon/profile.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#3578e5">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/favicon/apple-touch-icon.png"><title data-rh="true">Task.WhenAll / Select is a footgun ðŸ‘ŸðŸ”« | I CAN MAKE THIS WORK</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://blog.johnnyreilly.com/img/profile.jpg"><meta data-rh="true" name="twitter:image" content="https://blog.johnnyreilly.com/img/profile.jpg"><meta data-rh="true" property="og:url" content="https://blog.johnnyreilly.com/2020/06/21/taskwhenall-select-is-footgun"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="robots" content="max-image-preview:large"><meta data-rh="true" property="og:title" content="Task.WhenAll / Select is a footgun ðŸ‘ŸðŸ”« | I CAN MAKE THIS WORK"><meta data-rh="true" name="description" content="This post differs from my typical fayre. Most often I write &quot;here&#x27;s how to do a thing&quot;. This is not that. It&#x27;s more &quot;don&#x27;t do this thing I did&quot;. And maybe also, &quot;how can we avoid a situation like this happening again in future?&quot;. On this topic I very much don&#x27;t have all the answers - but by putting my thoughts down maybe I&#x27;ll learn and maybe others will educate me. I would love that!"><meta data-rh="true" property="og:description" content="This post differs from my typical fayre. Most often I write &quot;here&#x27;s how to do a thing&quot;. This is not that. It&#x27;s more &quot;don&#x27;t do this thing I did&quot;. And maybe also, &quot;how can we avoid a situation like this happening again in future?&quot;. On this topic I very much don&#x27;t have all the answers - but by putting my thoughts down maybe I&#x27;ll learn and maybe others will educate me. I would love that!"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2020-06-21T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://twitter.com/johnny_reilly"><meta data-rh="true" property="article:tag" content="CSharp,LINQ,Task.WhenAll,Select"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://blog.johnnyreilly.com/2020/06/21/taskwhenall-select-is-footgun"><link data-rh="true" rel="alternate" href="https://blog.johnnyreilly.com/2020/06/21/taskwhenall-select-is-footgun" hreflang="en"><link data-rh="true" rel="alternate" href="https://blog.johnnyreilly.com/2020/06/21/taskwhenall-select-is-footgun" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://J3MYR1INLT-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.ccaeaa27.css">
<link rel="preload" href="/assets/js/runtime~main.38dd742c.js" as="script">
<link rel="preload" href="/assets/js/main.72483867.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">I CAN MAKE THIS WORK</b></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/archive">Blog Archive</a><a class="navbar__item navbar__link" href="/talks">Talks</a></div><div class="navbar__items navbar__items--right"><a href="https://polywork.johnnyreilly.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Polywork<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2022/04/06/eslint-your-csharp-in-vs-code-with-roslyn-analyzers">ESLint your C# in VS Code with Roslyn Analyzers</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2022/03/30/azure-devops-consume-private-nuget-artifact-feed">Azure DevOps: consume a private artifact feed</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2022/03/20/lighthouse-meet-github-actions">Lighthouse meet GitHub Actions</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2022/03/06/swashbuckle-inheritance-multiple-return-types">Swashbuckle &amp; inheritance: Give. Me. The. Types</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2022/02/08/azure-static-web-apps-a-netlify-alternative">Azure Static Web Apps - a Netlify alternative</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">Task.WhenAll / Select is a footgun ðŸ‘ŸðŸ”«</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-06-21T00:00:00.000Z" itemprop="datePublished">June 21, 2020</time> Â· <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>This post differs from my typical fayre. Most often I write &quot;here&#x27;s how to do a thing&quot;. This is not that. It&#x27;s more &quot;don&#x27;t do this thing I did&quot;. And maybe also, &quot;how can we avoid a situation like this happening again in future?&quot;. On this topic I very much don&#x27;t have all the answers - but by putting my thoughts down maybe I&#x27;ll learn and maybe others will educate me. I would love that!</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="doing-things-that-dont-scale">Doing things that don&#x27;t scale<a class="hash-link" href="#doing-things-that-dont-scale" title="Direct link to heading">â€‹</a></h2><p>The platform that I work on once had zero users. We used to beg people to log in and see what we had built. Those days are (happily) but a memory. We&#x27;re getting popular.</p><p>As our platform has grown in popularity it has revealed some bad choices we made. Approaches that look fine on the surface (and that work just dandy when you have no users) may start to cause problems as your number of users grows.</p><p>I wanted to draw attention to one approach in particular that impacted us severely. In this case &quot;impacted us severely&quot; is a euphemism for &quot;brought the site down and caused a critical incident&quot;.</p><p>You don&#x27;t want this to happen to you. Trust me. So, what follows is a cautionary tale. The purpose of which is simply this: reader, do you have code of this ilk in your codebase? If you do: out, damn&#x27;d spot! out, I say!</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="so-cool-so-terrible">So cool, so terrible<a class="hash-link" href="#so-cool-so-terrible" title="Direct link to heading">â€‹</a></h2><p>I love LINQ. I love a declarative / functional style of coding. It appeals to me on some gut level. I find it tremendously readable. Read any C# of mine and the odds are pretty good that you&#x27;ll find some LINQ in the mix.</p><p>Imagine this scenario: you have a collection of user ids. You want to load the details of each user represented by their id from an API. You want to bag up all of those users into some kind of collection and send it back to the calling code.</p><p>Reading that, if you&#x27;re like me, you&#x27;re imagining some kind of map operation which loads the user details for each user id. Something like this:</p><div class="codeBlockContainer_I0IT language-cs theme-code-block"><div class="codeBlockContent_wNvx" style="color:#d6deeb;background-color:#011627"><pre tabindex="0" class="prism-code language-cs codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token class-name keyword" style="color:rgb(127, 219, 202)">var</span><span class="token plain"> users </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> userIds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">Select</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">userId </span><span class="token operator" style="color:rgb(127, 219, 202)">=&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">GetUserDetails</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">userId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">ToArray</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// users is User[]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Lovely. But you&#x27;ll note that I&#x27;m loading users from an API. Oftentimes, APIs are asynchronous. Certainly, in my case they were. So rather than calling a <code>GetUserDetails</code> function I found myself calling a <code>GetUserDetailsAsync</code> function, behind which an HTTP request is being sent and, later, a response is being returned.</p><p>So how do we deal with this? <a href="https://docs.microsoft.com/en-us/dotnet/api/system.threading.tasks.task.whenall?view=netcore-3.1#System_Threading_Tasks_Task_WhenAll__1_System_Collections_Generic_IEnumerable_System_Threading_Tasks_Task___0___" target="_blank" rel="noopener noreferrer"><code>Task.WhenAll</code></a> my friends!</p><div class="codeBlockContainer_I0IT language-cs theme-code-block"><div class="codeBlockContent_wNvx" style="color:#d6deeb;background-color:#011627"><pre tabindex="0" class="prism-code language-cs codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token class-name keyword" style="color:rgb(127, 219, 202)">var</span><span class="token plain"> userTasks </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> userIds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">Select</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">userId </span><span class="token operator" style="color:rgb(127, 219, 202)">=&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">GetUserDetailsAsync</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">userId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token class-name keyword" style="color:rgb(127, 219, 202)">var</span><span class="token plain"> users </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">await</span><span class="token plain"> Task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">WhenAll</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">tasks</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// users is User[]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>It worked great! Right up until to the point where it didn&#x27;t. These sorts of shenanigans were fine when we had a minimal number of users... But there came a point where problems arose. It got to the point where that simple looking mapping operation became a cause of many, many, <em>many</em> HTTP requests being fired concurrently. Then bad things started to happen. Not only did we realise we were launching a denial of service attack on the API we were consuming, we were bringing our own application to collapse.</p><p>Not a proud day.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="what-is-the-problem">What is the problem?<a class="hash-link" href="#what-is-the-problem" title="Direct link to heading">â€‹</a></h2><p>Through log analysis, code reading and speculation, (with the help of the invaluable <a href="https://www.linkedin.com/in/robert-grzankowski-53618114" target="_blank" rel="noopener noreferrer">Robski</a>) we came to realise that the cause of our woes was the <code>Task.WhenAll</code> / <code>Select</code> combination. Exercising that codepath was a surefire way to bring the application to its knees.</p><p>As I read around on the topic I happened upon <a href="https://www.twitter.com/mark_heath" target="_blank" rel="noopener noreferrer">Mark Heath</a>&#x27;s excellent list of <a href="https://markheath.net/post/async-antipatterns" target="_blank" rel="noopener noreferrer">Async antipatterns</a>. Number #6 on the list is &quot;Excessive parallelization&quot;. It describes a nearly identical scenario to my own:</p><blockquote><p>Now, this does &quot;work&quot;, but what if there were 10,000 orders? We&#x27;ve flooded the thread pool with thousands of tasks, potentially preventing other useful work from completing. If <code>ProcessOrderAsync</code> makes downstream calls to another service like a database or a microservice, we&#x27;ll potentially overload that with too high a volume of calls.</p></blockquote><p>We&#x27;re definitely overloading the API we&#x27;re consuming with too high a volume of calls. I have to admit that I&#x27;m less clear on the direct reason that a <code>Task.WhenAll</code> / <code>Select</code> combination could prove fatal to our application. Mark suggests this approach will flood the thread pool with tasks. As I read around on <code>async</code> and <code>await</code> it&#x27;s repeated again and again that a <code>Task</code> is not the same thing as a <code>Thread</code>. I have to hold my hands up here and say that I don&#x27;t understand the implementation of <code>async</code> / <code>await</code> in C# well enough. <a href="https://docs.microsoft.com/en-us/dotnet/standard/async-in-depth#deeper-dive-into-tasks-for-an-io-bound-operation" target="_blank" rel="noopener noreferrer">These docs are helpful but I still don&#x27;t think the penny has fully dropped for me yet.</a> I will continue to read.</p><p>One thing we learned as we debugged the production k8s pod was that, prior to its collapse, our app appeared to be opening up 1 million connections to the API we were consuming. Which seemed a bit much. Worthy of investigation. It&#x27;s worth saying that we&#x27;re not certain this is exactly what is happening; we have less instrumentation in place than we&#x27;d like. But some fancy wc grepping on Robski&#x27;s behalf suggested this was the case.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="what-will-we-change-in-future">What will we change in future?<a class="hash-link" href="#what-will-we-change-in-future" title="Direct link to heading">â€‹</a></h2><p>A learning that came out of this for us was this: we need more metrics exposed. We don&#x27;t understand our application&#x27;s behaviour under load as well as we&#x27;d like. So we&#x27;re planning to do some work with <a href="https://www.app-metrics.io/" target="_blank" rel="noopener noreferrer">App Metrics</a> and <a href="https://grafana.com/" target="_blank" rel="noopener noreferrer">Grafana</a> so we&#x27;ve a better idea of how our application performs. If you want to improve something, first measure it.</p><p>Another fly in the ointment was that we were unable to reproduce the issue when running locally. It&#x27;s worth saying here that I develop on a Windows machine and, when deployed, our application runs in a (Linux) Docker container. So there&#x27;s a difference and a distance between our development experience and our running one.</p><p>I&#x27;m planning to migrate to developing in a <a href="https://code.visualstudio.com/docs/remote/containers" target="_blank" rel="noopener noreferrer">devcontainer</a> where that&#x27;s possible. That should narrow the gap between our production experience and our development one. Reducing the difference between the two is always useful as it means you&#x27;re less likely to get different behaviour (ie &quot;problems&quot;) in production as compared to development. I&#x27;m curious as to whether I&#x27;ll be able to replicate that behaviour in a devcontainer.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="what-did-we-do-right-now">What did we do right now?<a class="hash-link" href="#what-did-we-do-right-now" title="Direct link to heading">â€‹</a></h2><p>To solve the immediate issue we were able to pivot away to a completely different approach. We moved aggregation from our ASP.NET Core web application to our TypeScript / React client with a (pretty sweet) custom hook. The topic for a subsequent blog post.</p><p>Moving to a different approach solved my immediate issue. But it left me puzzling. What was actually going wrong? Is it thread pool exhaustion? Is it something else? So many possibilities!</p><p>If anyone has any insights they&#x27;d like to share that would be incredible! I&#x27;ve also <a href="https://stackoverflow.com/questions/62490098/task-whenall-with-select-is-a-footgun-but-why/62490705" target="_blank" rel="noopener noreferrer">asked a question on Stack Overflow</a> which has kindly had answers from generous souls. <a href="https://twitter.com/jamesskimming" target="_blank" rel="noopener noreferrer">James Skimming</a>&#x27;s answer lead me to <a href="https://www.stevejgordon.co.uk/httpclient-connection-pooling-in-dotnet-core" target="_blank" rel="noopener noreferrer">Steve Gordon&#x27;s excellent post on connection pooling</a> which I&#x27;m still absorbing and seems like it could be relevant.</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_h6_j"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/c-sharp">CSharp</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/linq">LINQ</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/task-when-all">Task.WhenAll</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/select">Select</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/blog/2020-06-21-taskwhenall-select-is-footgun/index.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/2020/07/11/devcontainers-and-ssl-interception"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Devcontainers and SSL interception</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/2020/05/21/autofac-webapplicationfactory-integration-tests"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Autofac, WebApplicationFactory and integration tests</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_cNA8 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#doing-things-that-dont-scale" class="table-of-contents__link toc-highlight">Doing things that don&#39;t scale</a></li><li><a href="#so-cool-so-terrible" class="table-of-contents__link toc-highlight">So cool, so terrible</a></li><li><a href="#what-is-the-problem" class="table-of-contents__link toc-highlight">What is the problem?</a></li><li><a href="#what-will-we-change-in-future" class="table-of-contents__link toc-highlight">What will we change in future?</a></li><li><a href="#what-did-we-do-right-now" class="table-of-contents__link toc-highlight">What did we do right now?</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Support me</div><ul class="footer__items"><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" rel="noopener" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" loading="lazy" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li><li class="footer__item"><div style="display: flex; align-items: center;"><iframe src="https://github.com/sponsors/johnnyreilly/button" title="Sponsor johnnyreilly" height="35" width="116" style="border: 0;"></iframe><div>&nbsp;on GitHub</div></div></li></ul></div><div class="col footer__col"><div class="footer__title">Feeds</div><ul class="footer__items"><li class="footer__item"><a href="https://blog.johnnyreilly.com/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item">RSS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://blog.johnnyreilly.com/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item">Atom<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.38dd742c.js"></script>
<script src="/assets/js/main.72483867.js"></script>
</body>
</html>