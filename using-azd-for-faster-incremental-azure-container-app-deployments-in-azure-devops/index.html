<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">Using AZD for faster incremental Azure Container App deployments in Azure DevOps | johnnyreilly</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://johnnyreilly.com/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="robots" content="max-image-preview:large"><meta data-rh="true" name="monetization" content="$ilp.uphold.com/LwQQhXdpwxeJ"><meta data-rh="true" property="og:title" content="Using AZD for faster incremental Azure Container App deployments in Azure DevOps | johnnyreilly"><meta data-rh="true" name="description" content="Learn how to speed up deployments using the AZD command."><meta data-rh="true" property="og:description" content="Learn how to speed up deployments using the AZD command."><meta data-rh="true" property="og:image" content="https://johnnyreilly.com/assets/images/title-image-ca63b951ef232f0eede02c6a48f0d39b.png"><meta data-rh="true" name="twitter:image" content="https://johnnyreilly.com/assets/images/title-image-ca63b951ef232f0eede02c6a48f0d39b.png"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-07-15T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://johnnyreilly.com/about"><meta data-rh="true" property="article:tag" content="Azure,Bicep,Azure Container Apps,Azure DevOps,Azure Pipelines"><link data-rh="true" rel="icon" href="/favicon.ico"><link data-rh="true" rel="canonical" href="https://johnnyreilly.com/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops"><link data-rh="true" rel="alternate" href="https://johnnyreilly.com/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops" hreflang="en"><link data-rh="true" rel="alternate" href="https://johnnyreilly.com/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://J3MYR1INLT-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://johnnyreilly.com/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops","mainEntityOfPage":"https://johnnyreilly.com/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops","url":"https://johnnyreilly.com/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops","headline":"Using AZD for faster incremental Azure Container App deployments in Azure DevOps","name":"Using AZD for faster incremental Azure Container App deployments in Azure DevOps","description":"Learn how to speed up deployments using the AZD command.","datePublished":"2024-07-15T00:00:00.000Z","author":{"@type":"Person","name":"John Reilly","description":"OSS Engineer - TypeScript, Azure, React, Node.js, .NET","url":"https://johnnyreilly.com/about","image":"https://johnnyreilly.com/img/profile.jpg"},"image":{"@type":"ImageObject","@id":"https://johnnyreilly.com/assets/images/title-image-ca63b951ef232f0eede02c6a48f0d39b.png","url":"https://johnnyreilly.com/assets/images/title-image-ca63b951ef232f0eede02c6a48f0d39b.png","contentUrl":"https://johnnyreilly.com/assets/images/title-image-ca63b951ef232f0eede02c6a48f0d39b.png","caption":"title image for the blog post: Using AZD for faster incremental Azure Container App deployments in Azure DevOps"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://johnnyreilly.com/","name":"I CAN MAKE THIS WORK"}}</script><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="johnnyreilly" href="/opensearch.xml">

<link rel="icon" href="/img/profile-64x64.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#3578e5">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="preload" href="https://johnnyreilly.com/fonts/Poppins-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://johnnyreilly.com/fonts/Poppins-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preconnect" href="https://res.cloudinary.com">
<link rel="monetization" href="https://ilp.uphold.com/LwQQhXdpwxeJ">
<script type="application/ld+json">{"@context":"https://schema.org","@graph":[{"@id":"https://johnnyreilly.com","@type":"WebSite","url":"https://johnnyreilly.com","name":"johnnyreilly","description":"This is John Reilly's blog. John is an Open Source Software Engineer working on TypeScript, Azure, React, Node.js, .NET and more.","copyrightHolder":{"@id":"https://johnnyreilly.com/about"},"publisher":{"@id":"https://johnnyreilly.com/about"},"potentialAction":{"@type":"SearchAction","target":{"@type":"EntryPoint","urlTemplate":"https://johnnyreilly.com/search?q={search_term_string}"},"query-input":"required name=search_term_string"},"inLanguage":"en-UK"},{"@id":"https://johnnyreilly.com/about","@type":"Person","name":"John Reilly","alternateName":"Johnny Reilly","image":{"@type":"ImageObject","inLanguage":"en-UK","@id":"https://johnnyreilly.com/about#image","url":"https://johnnyreilly.com/img/profile.jpg","contentUrl":"https://johnnyreilly.com/img/profile.jpg","width":200,"height":200,"caption":"John Reilly"},"description":"John is an Open Source Software Engineer working on TypeScript, Azure, React, Node.js, .NET and more. As well as writing code, John is a speaker at meetups, one of the founders of the TS Congress conference, and the author of the history of Definitely Typed, which he worked on in the early days of TypeScript.","url":"https://johnnyreilly.com","address":{"@type":"PostalAddress","streetAddress":"Twickenham","addressLocality":"London","addressCountry":"United Kingdom"},"email":"johnny_reilly@hotmail.com","birthPlace":"Bristol","sameAs":["https://github.com/johnnyreilly","https://fosstodon.org/@johnny_reilly","https://twitter.com/johnny_reilly","https://dev.to/johnnyreilly","https://app.daily.dev/johnnyreilly","https://stackoverflow.com/users/761388/john-reilly","https://blog.logrocket.com/author/johnreilly/","https://www.reddit.com/user/johnny_reilly","https://uk.linkedin.com/in/johnnyreilly"]},{"@id":"https://johnnyreilly.com/about#organization","@type":["Organization","Brand"],"url":"https://johnnyreilly.com","name":"johnnyreilly","description":"This is John Reilly's blog. John is an Open Source Software Engineer working on TypeScript, Azure, React, Node.js, .NET and more.","logo":{"@type":"ImageObject","inLanguage":"en-UK","@id":"https://johnnyreilly.com/#logo","url":"https://johnnyreilly.com/img/profile.jpg","contentUrl":"https://johnnyreilly.com/img/profile.jpg","width":200,"height":200,"caption":"John Reilly"},"image":{"@id":"https://johnnyreilly.com/#logo"},"sameAs":["https://github.com/johnnyreilly","https://fosstodon.org/@johnny_reilly","https://twitter.com/johnny_reilly","https://dev.to/johnnyreilly","https://app.daily.dev/johnnyreilly","https://stackoverflow.com/users/761388/john-reilly","https://blog.logrocket.com/author/johnreilly/","https://www.reddit.com/user/johnny_reilly","https://uk.linkedin.com/in/johnnyreilly"]}]}</script>
<link rel="webmention" href="https://webmention.io/johnnyreilly.com/webmention"><link rel="stylesheet" href="/assets/css/styles.9cd8158f.css">
<script src="/assets/js/runtime~main.41b38c25.js" defer="defer"></script>
<script src="/assets/js/main.ae785171.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><script type="application/ld+json">[{"@context":"https://schema.org","@type":"BreadcrumbList","@id":"/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops#breadcrumb","name":"Blog breadcrumb","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https://johnnyreilly.com"},{"@type":"ListItem","position":2,"name":"Blog","item":"https://johnnyreilly.com/blog"},{"@type":"ListItem","position":3,"name":"Using AZD for faster incremental Azure Container App deployments in Azure DevOps"}]}]</script><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile-64x64.jpg" alt="Profile picture of John Reilly" class="themedComponent_mlkZ themedComponent--light_NVdE" height="32" width="32"><img src="/img/profile-64x64.jpg" alt="Profile picture of John Reilly" class="themedComponent_mlkZ themedComponent--dark_xIcU" height="32" width="32"></div><b class="navbar__title text--truncate">John Reilly</b></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/talks">Talks</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/johnnyreilly" target="_blank" rel="me" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="me" class="navbar__item navbar__link">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://fosstodon.org/@johnny_reilly" target="_blank" rel="me" class="navbar__item navbar__link">Mastodon<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops">Using AZD for faster incremental Azure Container App deployments in Azure DevOps</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/mui-react-tree-view-pass-data-to-treeitem">MUI React Tree View: pass data to TreeItem</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/web-workers-comlink-vite-tanstack-query">Web Workers, Comlink, Vite and TanStack Query</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/static-web-apps-cli-improve-performance-with-vite-server-proxy">Static Web Apps CLI: improve performance with Vite server proxy</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/dual-publishing-esm-cjs-modules-with-tsup-and-are-the-types-wrong">Dual Publishing ESM and CJS Modules with tsup and Are the Types Wrong?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/mui-react-tree-view-check-children-uncheck-parents">MUI React Tree View: check children, uncheck parents</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/serialising-aspnet-method-calls-for-later-execution">Serialising ASP.NET method calls for later execution</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/large-language-models-view-models-backend-for-frontend">Large Language Models, Open API, View Models and the Backend for Frontend Pattern</a></li></ul></nav></aside><main class="col col--7"><article><header><h1 class="title_f1Hy">Using AZD for faster incremental Azure Container App deployments in Azure DevOps</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-07-15T00:00:00.000Z">July 15, 2024</time> · <!-- -->14 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://johnnyreilly.com/about" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://johnnyreilly.com/about" target="_blank" rel="noopener noreferrer"><span>John Reilly</span></a></div><small class="avatar__subtitle">OSS Engineer - TypeScript, Azure, React, Node.js, .NET</small></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>When deploying Azure Container Apps from Azure DevOps, you can use the <code>azd</code> command to speed up deployments that do not affect infrastructure. Given that when you&#x27;re deploying, it&#x27;s far more common to be making a code and / or content change and not an infrastructure one, this can be a significant time saver.</p>
<p><img decoding="async" loading="eager" alt="title image reading &amp;quot;Using AZD for faster incremental Azure Container App deployments in Azure DevOps&amp;quot; with the Azure Container Apps logo" src="/assets/images/title-image-ca63b951ef232f0eede02c6a48f0d39b.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="faster-deployments-from-azd-14-and-beyond">Faster deployments from <code>azd</code> 1.4 and beyond<a class="hash-link" aria-label="Direct link to heading" title="Direct link to heading" href="/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops#faster-deployments-from-azd-14-and-beyond">​</a></h2>
<p>The <code>azd</code> v1.4.0 release contained a significant feature: <code>azd provision</code> is now faster when there are no infrastructure changes.</p>
<p>To quote a trimmed down version of the <a href="https://devblogs.microsoft.com/azure-sdk/azure-developer-cli-azd-october-2023-release/#azd-provision-is-now-faster-when-there-are-no-infrastructure-changes" target="_blank" rel="noopener noreferrer">announcement</a>:</p>
<blockquote>
<p>If you’ve been using the Azure Developer CLI for a while, you may have noticed that sometimes <code>azd provision</code> takes a long time to complete when it may not need to. The wait time was because, prior to version 1.4.0, <code>azd provision</code> would always reprovision regardless of whether the underlying Infrastructure as Code had changed... As of today’s 1.4.0 release, <code>azd provision</code> now checks the most recent deployment upstream on Azure to see if the state is the same as what’s represented in the Infrastructure as Code that’s been used to provision. If the state is the same, the provision is skipped... with this new experience, you should also notice improved performance when running <code>azd up</code> in a CI/CD pipeline as provisioning will be automatically skipped when there are no changes.</p>
</blockquote>
<p>I want this. We&#x27;re going to unpack how to use this feature in the context of an Azure DevOps pipeline with Azure Container Apps. It turns out that there&#x27;s a little more to it than just running <code>azd provision</code> and hoping for the best. In fact, there&#x27;s gotchas aplenty - but it&#x27;s totally achievable.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-about-bicep-what-if">What about Bicep <code>what-if</code>?<a class="hash-link" aria-label="Direct link to heading" title="Direct link to heading" href="/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops#what-about-bicep-what-if">​</a></h2>
<p>You might be thinking at this point: &quot;What about Bicep <code>what-if</code>?&quot; It&#x27;s a good question. <code>what-if</code> is a feature of the Azure CLI that allows you to see what changes would be made if you were to deploy a Bicep file. Unfortunately, my own experience of using <code>what-if</code> has been that it&#x27;s quite unreliable. It will detect changes where there are none, and it will fail to detect changes where there are some. I&#x27;d love to use it, but I can&#x27;t trust it. If you&#x27;d like to watch a more in depth discussion of the issue, <a href="https://www.youtube.com/watch?v=jlkwH-fP--M" target="_blank" rel="noopener noreferrer">this video is a good place to start</a>.</p>
<p>There appear to be some known issues with <code>what-if</code> that you can follow the progress of here:</p>
<ul>
<li><a href="https://github.com/Azure/arm-template-whatif/issues/83" target="_blank" rel="noopener noreferrer">https://github.com/Azure/arm-template-whatif/issues/83</a></li>
<li><a href="https://github.com/Azure/arm-template-whatif/issues/157" target="_blank" rel="noopener noreferrer">https://github.com/Azure/arm-template-whatif/issues/157</a></li>
</ul>
<p>Given that <code>what-if</code> is not reliable, we&#x27;re going to use <code>azd</code> to speed up our deployments.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="embracing-azd-in-an-existing-azure-devops-pipeline">Embracing <code>azd</code> in an existing Azure DevOps pipeline<a class="hash-link" aria-label="Direct link to heading" title="Direct link to heading" href="/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops#embracing-azd-in-an-existing-azure-devops-pipeline">​</a></h2>
<p>I&#x27;m going to start with a pre-existing Azure Pipeline that deploys an Azure Container App. It uses the classic <a href="https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/azure-resource-manager-template-deployment-v3?view=azure-pipelines" target="_blank" rel="noopener noreferrer"><code>AzureResourceManagerTemplateDeployment@3</code> ARM template deployment v3 task</a> to deploy our infrastructure in the form of a <code>main.bicep</code> (and it&#x27;s submodules) file.</p>
<p>This existing pipeline and infrastructure as code payload is in a good state. But it&#x27;s slow. Every time the pipeline runs, the bicep section takes <strong>8 minutes</strong>. We&#x27;re going to make it faster. Spoiler: we&#x27;re going to get it down to <strong>1 minute</strong>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="hello-azureyml">Hello <code>azure.yml</code><a class="hash-link" aria-label="Direct link to heading" title="Direct link to heading" href="/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops#hello-azureyml">​</a></h2>
<p>Our project has no integration with <code>azd</code>. But we need <code>azd</code> to take advantage of the new <code>azd provision</code> feature. We&#x27;re going to add a new file to our project: <code>azure.yml</code>. This file is going to contain the configuration for our <code>azd</code> project.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">container</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">app</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">template</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> azd</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">init@1.9.4</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">web</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> myregistry.azurecr.io/my</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">project/my</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">container</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain">$</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain">WEB_VERSION_TAG</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">host</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> containerapp</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The yaml above describes a container app service called <code>web</code> that uses an image from an Azure Container Registry. The <code>WEB_VERSION_TAG</code> is a variable that we&#x27;ll need to provide in our Azure DevOps pipeline. It&#x27;s worth noticing the link at the top to the schema for the <code>azure.yml</code> file: <a href="https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json" target="_blank" rel="noopener noreferrer">https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json</a> - much of the work around figuring out how to use <code>azd</code> was achieved by looking at the schema for the <code>azure.yml</code> file.</p>
<p>One thing we learned, as we looked at the schema, was that many parameters support environment variable substitution at runtime:</p>
<p><img decoding="async" loading="lazy" alt="screenshot of schema file" src="/assets/images/screenshot-azure-yml-schema-993e66df439d83bf81c6e6439f964776.png" width="1996" height="1834" class="img_ev3q"></p>
<p>The screenshot above is taken from the Docker section of the configuration where environment variable substitution is widely supported. You might imagine that the <code>WEB_VERSION_TAG</code> used in the <code>image</code> parameter we pass would also be one of those variables. But, alas, at the time of writing it is not.</p>
<p><img decoding="async" loading="lazy" alt="screenshot of the image section of schema file" src="/assets/images/screenshot-azure-yml-image-a4f57e534631486648a4251fe4f3cd43.png" width="2016" height="1642" class="img_ev3q"></p>
<p>RAISE A GITHUB ISSUE</p>
<p>We&#x27;ll find another way to pass the <code>WEB_VERSION_TAG</code> value to <code>azd</code> later on.</p>
<p>Incidentally, we&#x27;re using an approach whereby the image is built and pushed to the registry independently of <code>azd</code>. You could equally use <code>azd</code> to build and push the image. But we&#x27;re not doing that here.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="bicep-modifications">Bicep modifications<a class="hash-link" aria-label="Direct link to heading" title="Direct link to heading" href="/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops#bicep-modifications">​</a></h2>
<p>I mentioned that we&#x27;re adding a level of <code>azd</code> support to an existing pipeline. As part of that, we need to make modifications to our existing Bicep modules.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="using-resource-group-scoped-deployments-with-azd">Using resource group scoped deployments with azd<a class="hash-link" aria-label="Direct link to heading" title="Direct link to heading" href="/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops#using-resource-group-scoped-deployments-with-azd">​</a></h3>
<p>We&#x27;re going to start off with a minor tweak to our <code>main.bicep</code> file; the entry point to our Bicep deployments.</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">targetScope</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&#x27;resourceGroup&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The change above allows us to use <code>azd</code> deployments targeted at existing resource groups. The default mode of operation for <code>azd</code> deployments is deploying a resource group to a subscription. We are seeking to <a href="https://learn.microsoft.com/en-us/azure/developer/azure-developer-cli/resource-group-scoped-deployments" target="_blank" rel="noopener noreferrer">deploy to an existing resource group</a>.</p>
<p>Now, strictly speaking, this isn&#x27;t necessary for speeding up deployments with <code>azd</code>. But if you&#x27;re not one for creating a resource group per deployment (as I am not), then this is a good idea. This kind of deployment requires less permissions and may well better align with your organisation&#x27;s security posture.</p>
<p>We&#x27;ll need to opt into using this feature with <code>azd</code> later on in the pipeline; at present resource group scoped deployments are considered &quot;alpha&quot;.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-does-your-service-exist-parameter">The &quot;does your service exist?&quot; parameter<a class="hash-link" aria-label="Direct link to heading" title="Direct link to heading" href="/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops#the-does-your-service-exist-parameter">​</a></h3>
<p>We&#x27;re going to add a &quot;magic&quot; parameter to our <code>main.bicep</code> file. This parameter is going to be used to determine whether the container app we&#x27;re deploying already exists. This is important because if the container app already exists, we will reuse the existing deployed container image during the <code>azd provision</code> stage. If it does not, then we&#x27;ll deploy a new container image.</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token decorator">@description</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">&#x27;Specifies if the container app exists - azd will provide this&#x27;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> containerAppExists </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">bool</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">false</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We&#x27;ll look later at where this value comes from, but for now, we&#x27;re just adding it to our <code>main.bicep</code> file. How do we use this parameter? In the module where we deploy our container app, we&#x27;re going to make a couple of changes:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">module</span><span class="token plain"> fetchLatestImage </span><span class="token string" style="color:rgb(165, 255, 144)">&#x27;../modules/fetch-container-image.bicep&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">&#x27;</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token interpolated-string interpolation expression">name</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">-fetch-image&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">params</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">exists</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerAppExists</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> name</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> app </span><span class="token string" style="color:rgb(165, 255, 144)">&#x27;Microsoft.App/containerApps@2023-05-01&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> name</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">location</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">tags</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">union</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">tags</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token string" style="color:rgb(165, 255, 144)">&#x27;azd-service-name&#x27;</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain">  </span><span class="token string" style="color:rgb(165, 255, 144)">&#x27;web&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// note the &quot;web&quot; matches the service name in azure.yml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">properties</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">template</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">containers</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">image</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> fetchLatestImage</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">outputs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token operator" style="color:rgb(255, 157, 0)">?</span><span class="token plain">containers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token operator" style="color:rgb(255, 157, 0)">?</span><span class="token number" style="color:rgb(255, 98, 140)">0</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token operator" style="color:rgb(255, 157, 0)">?</span><span class="token plain">image </span><span class="token operator" style="color:rgb(255, 157, 0)">??</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&#x27;mcr.microsoft.com/azuredocs/containerapps-helloworld:latest&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can see we tag the container app with the service name from the <code>azure.yml</code> file (<code>web</code>). This is important because it allows <code>azd</code> to determine whether the container app already exists and so power the <code>containerAppExists</code> parameter we added to our <code>main.bicep</code> file.</p>
<p>We&#x27;re using the <code>containerAppExists</code> parameter to determine whether we should fetch the currently deployed image from the existing container app. If the container app exists, we&#x27;ll use the existing image. If it does not, we&#x27;ll use a default image. We&#x27;d typically only expect to use the default image when we&#x27;re deploying the container app to an environment for the first time. (You might be wondering how the new version of the application gets deployed; given that we&#x27;re not using the new container image. It turns out that <code>azd deploy</code> is the command responsible for deploying the new image; we&#x27;ll get to that later.)</p>
<p>You&#x27;ll have noticed that we&#x27;re using a new module called <code>fetch-container-image.bicep</code>. This module is responsible for attempting to fetch the existing image from the currently deployed container app:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> exists </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> name </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> existingApp </span><span class="token string" style="color:rgb(165, 255, 144)">&#x27;Microsoft.App/containerApps@2023-05-01&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">existing</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">exists</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> name</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">output</span><span class="token plain"> containers </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">array</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> exists </span><span class="token operator" style="color:rgb(255, 157, 0)">?</span><span class="token plain"> existingApp</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">template</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">containers </span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is based on what files are generated when you perform an <code>azd init</code>, but has been customised for the specific version of the <code>Microsoft.App/containerApps</code> resource we&#x27;re using.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tagging-resources-with-the-environment-name">Tagging resources with the environment name<a class="hash-link" aria-label="Direct link to heading" title="Direct link to heading" href="/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops#tagging-resources-with-the-environment-name">​</a></h3>
<p>Another addition we&#x27;re going to make to our <code>main.bicep</code> file is to tag our resources with the environment name. This allows <code>azd</code> to determine the environment of a given resource. It&#x27;s achieved by using the our already existing <code>envName</code> parameter and adding it to the tags of our resources:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token decorator">@description</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">&#x27;Environment eg dev, prod&#x27;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> envName </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> combinedTags </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">union</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">tags</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&#x27;azd-env-name&#x27;</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> envName </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="parameters-in-mainbicep-must-be-immutable-per-environment">Parameters in <code>main.bicep</code> must be immutable per environment<a class="hash-link" aria-label="Direct link to heading" title="Direct link to heading" href="/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops#parameters-in-mainbicep-must-be-immutable-per-environment">​</a></h3>
<p>It&#x27;s gotcha time! One thing we learned the hard way is that parameters in <code>main.bicep</code> must be <strong>immutable per environment</strong>. This means that you can&#x27;t change the value of a parameter in a <code>main.bicep</code> file between deployments to an environment. This is because <code>azd</code> uses the <code>main.bicep</code> file to determine whether a deployment is incremental or not. If the parameters change, then <code>azd</code> will assume that the deployment requires infrastructure changes, and will reprovision the resources.</p>
<p>What&#x27;s more, as things stand, <code>azd</code> only has the ability to <strong>fully</strong> reprovision your resources. If your app consists of a database and a container app, and you only want to deploy a new version of the container app, you&#x27;re out of luck. <code>azd</code> will deploy the database again too. This is a limitation of <code>azd</code> at the time of writing.</p>
<p>I&#x27;ve <a href="https://github.com/Azure/azure-dev/issues/4123" target="_blank" rel="noopener noreferrer">raised a GitHub issue</a> in the hope that this feature might one day land. Perhaps it&#x27;s super hard - quite possibly.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="welcome-mainbicepparam">Welcome <code>main.bicepparam</code><a class="hash-link" aria-label="Direct link to heading" title="Direct link to heading" href="/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops#welcome-mainbicepparam">​</a></h2>
<p>Prior to using <code>azd</code>, we were using a <code>main.bicep</code> file to deploy our infrastructure and we provided parameters to this file via our Azure DevOps pipeline. We&#x27;re going to make a change to our pipeline to use a <a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/parameter-files?tabs=Bicep" target="_blank" rel="noopener noreferrer"><code>main.bicepparam</code></a> file instead. This file is going to contain the parameters that we were previously providing to our <code>main.bicep</code> file.</p>
<p>The <code>main.bicepparam</code> file is going to contain the parameters that we were previously providing to our <code>main.bicep</code> file. It&#x27;s going to pick these up from environment variables that we&#x27;ll declare. We&#x27;re also going to add our new <code>containerAppExists</code> parameter to this file, which will also collect its value from an environment variable. But it won&#x27;t be us that provides that value; it will be <code>azd</code>.</p>
<p>Consider the following (cut down) <code>main.bicepparam</code> file:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token plain">using </span><span class="token string" style="color:rgb(165, 255, 144)">&#x27;./main.bicep&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> envName </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">readEnvironmentVariable</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">&#x27;AZURE_ENV_NAME&#x27;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> location </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">readEnvironmentVariable</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">&#x27;AZURE_LOCATION&#x27;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> serviceConnectionPrincipalId </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">readEnvironmentVariable</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">&#x27;AZURE_PRINCIPAL_ID&#x27;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> tags </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">branch</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">readEnvironmentVariable</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">&#x27;TAGS_BRANCH&#x27;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">repo</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">readEnvironmentVariable</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">&#x27;TAGS_REPO&#x27;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// azd will provide the following parameters</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> containerAppExists </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">bool</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token function" style="color:rgb(250, 208, 0)">readEnvironmentVariable</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">&#x27;SERVICE_WEB_RESOURCE_EXISTS&#x27;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&#x27;false&#x27;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>containerAppExists</code> parameter is determined by the <code>SERVICE_WEB_RESOURCE_EXISTS</code> environment variable to provide this value. What&#x27;s happening here is that we&#x27;re picking up on a convention that <code>azd</code> uses to provide confirmation that a service already exists. <code>SERVICE_[SERVICENAME]_RESOURCE_EXISTS</code> is the pattern that <code>azd</code> uses to provide this information; where <code>[SERVICENAME]</code> is the name of the service as defined in the <code>azure.yml</code> file. In our case, it&#x27;s <code>web</code> (or rather <code>WEB</code>).</p>
<p>If you&#x27;re curious about how this actually works <a href="https://github.com/Azure/azure-dev/blob/837d4e8592c53375c7d9aa6df8b134c23cdeb487/cli/azd/pkg/project/service_target_containerapp.go#L174-L190" target="_blank" rel="noopener noreferrer">you can read the source code here</a> in the <code>azd</code> project. Here&#x27;s the relevant code snippet:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">func</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">at </span><span class="token operator" style="color:rgb(255, 157, 0)">*</span><span class="token plain">containerAppTarget</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">addPreProvisionChecks</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> serviceConfig </span><span class="token operator" style="color:rgb(255, 157, 0)">*</span><span class="token plain">ServiceConfig</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(250, 208, 0)">error</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// Attempt to retrieve the target resource for the current service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// This allows the resource deployment to detect whether or not to pull existing container image during</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// provision operation to avoid resetting the container app back to a default image</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> serviceConfig</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Project</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AddHandler</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">&quot;preprovision&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">func</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> args ProjectLifecycleEventArgs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(250, 208, 0)">error</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    exists </span><span class="token operator" style="color:rgb(255, 157, 0)">:=</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// Check if the target resource already exists</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    targetResource</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> err </span><span class="token operator" style="color:rgb(255, 157, 0)">:=</span><span class="token plain"> at</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">resourceManager</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetTargetResource</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> at</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">env</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetSubscriptionId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> serviceConfig</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> targetResource </span><span class="token operator" style="color:rgb(255, 157, 0)">!=</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">nil</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">&amp;&amp;</span><span class="token plain"> err </span><span class="token operator" style="color:rgb(255, 157, 0)">==</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      exists </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    at</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">env</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">SetServiceProperty</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">serviceConfig</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&quot;RESOURCE_EXISTS&quot;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> strconv</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">FormatBool</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">exists</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> at</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">envManager</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Save</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> at</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">env</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now that we have our <code>main.bicepparam</code> file, we&#x27;re ready to migrate to our pipeline to use <code>azd</code>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="azure-devops-pipeline-modifications">Azure DevOps pipeline modifications<a class="hash-link" aria-label="Direct link to heading" title="Direct link to heading" href="/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops#azure-devops-pipeline-modifications">​</a></h2>
<p>There&#x27;s no two ways about it; our Azure DevOps pipeline modifications are pretty extensive. Where we were previously using the <code>AzureResourceManagerTemplateDeployment@3</code> task to deploy our Bicep files, we&#x27;re now going to use the <code>azd</code> command to deploy our infrastructure and our container app.</p>
<p>Here&#x27;s a cut down version of our pipeline replacing the single <code>AzureResourceManagerTemplateDeployment@3</code> task with a series of tasks that use the <code>azd</code> command:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> setup</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">azd@0</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Install azd</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># If you can&#x27;t use above task in your organization, you can remove it and uncomment below task to install azd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># - task: Bash@3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">#   displayName: Install azd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">#   inputs:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">#     targetType: &quot;inline&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">#     script: |</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">#       curl -fsSL https://aka.ms/install-azd.sh | bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">pwsh</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token scalar string" style="color:rgb(165, 255, 144)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token scalar string" style="color:rgb(165, 255, 144)">    azd config set auth.useAzCliAuth &quot;true&quot;</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token scalar string" style="color:rgb(165, 255, 144)">    azd config set alpha.resourceGroupDeployments on</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Configure `azd` config options.</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> AzureCLI@2</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Login to ACR</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $(registryServiceConnection)</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> bash</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> inlineScript</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token scalar string" style="color:rgb(165, 255, 144)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token scalar string" style="color:rgb(165, 255, 144)">      az acr login -n myregistry</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> AzureCLI@2</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Provision Infra</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $(serviceConnection)</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> bash</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> inlineScript</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token scalar string" style="color:rgb(165, 255, 144)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token scalar string" style="color:rgb(165, 255, 144)">      azd provision --no-prompt</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># See https://learn.microsoft.com/en-gb/azure/developer/azure-developer-cli/configure-devops-pipeline?tabs=azdo</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">AZURE_LOCATION</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $(location)</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">AZURE_SUBSCRIPTION_ID</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $(subscriptionId)</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">AZURE_ENV_NAME</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain">parameters.env</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># https://learn.microsoft.com/en-us/azure/developer/azure-developer-cli/manage-environment-variables#user-provided-environment-variables</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">AZURE_RESOURCE_GROUP</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $(resourceGroupName)</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">AZURE_PRINCIPAL_ID</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $(serviceConnectionPrincipalId)</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># Define the additional variables or secrets that are required only for provision</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">TAGS_BRANCH</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $(Build.SourceBranch)</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">TAGS_REPO</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $(repo)</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">bash</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token scalar string" style="color:rgb(165, 255, 144)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token scalar string" style="color:rgb(165, 255, 144)">    sed -i &quot;s/\${WEB_VERSION_TAG}/$(containerImageTag)/g&quot; azure.yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">&#x27;Update WEB_VERSION_TAG in azure.yaml&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> AzureCLI@2</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Deploy Application</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">retryCountOnTaskFailure</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $(serviceConnection)</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> bash</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> inlineScript</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token scalar string" style="color:rgb(165, 255, 144)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token scalar string" style="color:rgb(165, 255, 144)">      azd deploy --no-prompt</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># See https://learn.microsoft.com/en-gb/azure/developer/azure-developer-cli/configure-devops-pipeline?tabs=azdo</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">AZURE_LOCATION</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $(location)</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">AZURE_SUBSCRIPTION_ID</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $(subscriptionId)</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">AZURE_ENV_NAME</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain">parameters.env</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># https://learn.microsoft.com/en-us/azure/developer/azure-developer-cli/manage-environment-variables#user-provided-environment-variables</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">AZURE_RESOURCE_GROUP</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $(resourceGroupName)</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># Define the additional variables or secrets that are required only for deploy</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>What&#x27;s happening here? We&#x27;ll take it step by step:</p>
<ul>
<li>We&#x27;re installing <code>azd</code> using the <code>setup-azd@0</code> task.</li>
<li>We&#x27;re configuring <code>azd</code> to use the Azure CLI for authentication and to enable resource group scoped deployments.</li>
<li>We&#x27;re logging into our Azure Container Registry. (If you&#x27;re not building your image independently of <code>azd</code>, then you may not need this step.)</li>
<li>We&#x27;re provisioning our infrastructure using <code>azd provision --no-prompt</code>. Note that we&#x27;re providing a number of environment variables to <code>azd</code> which will be detected in our <code>main.bicepparam</code> file.</li>
<li>We&#x27;re updating the <code>azure.yml</code> file with the <code>WEB_VERSION_TAG</code> that we need to provide. This is us working around the lack of support for environment variables in the <code>azure.yml</code> file for the <code>image</code> parameter.</li>
<li>We&#x27;re deploying our application using <code>azd deploy --no-prompt</code>.</li>
</ul>
<p>You&#x27;ll note that as we use <code>azd</code>, we make heavy use of environment variables. These environment variables will be picked up in the <code>main.bicepparam</code> file and passed through to the <code>main.bicep</code>. And of course there&#x27;s the runtime <code>SERVICE_[SERVICENAME]_RESOURCE_EXISTS</code> parameter which <code>azd</code> will provide. Much of what you see here is inspired by <a href="https://learn.microsoft.com/en-gb/azure/developer/azure-developer-cli/configure-devops-pipeline?tabs=azdo" target="_blank" rel="noopener noreferrer">this documentation</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-does-it-look-like-when-it-works">What does it look like when it works?<a class="hash-link" aria-label="Direct link to heading" title="Direct link to heading" href="/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops#what-does-it-look-like-when-it-works">​</a></h2>
<p>That is the question! Like this:</p>
<p><img decoding="async" loading="lazy" alt="screenshot of azd detecting no changes and so not provisioning" src="/assets/images/screenshot-of-azd-detecting-no-changes-4a38419f8f4697892fd6f67d0b151543.avif" width="1434" height="932" class="img_ev3q"></p>
<p>The magic sentence in the above screenshot is: <code>SUCCESS: There are no changes to provision for your application.</code> This is what we&#x27;re looking for. This is what makes our deployments faster.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a class="hash-link" aria-label="Direct link to heading" title="Direct link to heading" href="/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops#conclusion">​</a></h2>
<p>So we&#x27;ve done it, we&#x27;ve speeded up our subsequent deployments by using <code>azd</code> in our Azure DevOps pipeline to avoid unnecessary infrastructure provisioning when there are no changes. This is a significant time saver. However, as we&#x27;ve also seen, this is very easy to get wrong and quite hard to get right! Hopefully this will help you implement <code>azd</code> in your Azure DevOps pipelines.</p>
<p>I couldn&#x27;t have written this without <a href="https://twitter.com/MarcelMichau" target="_blank" rel="noopener noreferrer">Marcel Michau</a> who did much of the heavy lifting on this project. I am the Boswell to his Johnson. Or something like that.</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a title="The Microsoft cloud platform." class="tag_zVej tagRegular_sFm0" href="/tags/azure">Azure</a></li><li class="tag_QGVx"><a title="The Bicep language for Azure Resource Manager templates." class="tag_zVej tagRegular_sFm0" href="/tags/bicep">Bicep</a></li><li class="tag_QGVx"><a title="The Azure Container Apps service. Effectively a managed Kubernetes service." class="tag_zVej tagRegular_sFm0" href="/tags/azure-container-apps">Azure Container Apps</a></li><li class="tag_QGVx"><a title="The Azure DevOps suite of tools." class="tag_zVej tagRegular_sFm0" href="/tags/azure-devops">Azure DevOps</a></li><li class="tag_QGVx"><a title="The Azure Pipelines CI / CD service." class="tag_zVej tagRegular_sFm0" href="/tags/azure-pipelines">Azure Pipelines</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2024-07-15-using-azd-for-faster-incremental-azure-deployments/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/mui-react-tree-view-pass-data-to-treeitem"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">MUI React Tree View: pass data to TreeItem</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a class="table-of-contents__link toc-highlight" href="/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops#faster-deployments-from-azd-14-and-beyond">Faster deployments from <code>azd</code> 1.4 and beyond</a></li><li><a class="table-of-contents__link toc-highlight" href="/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops#what-about-bicep-what-if">What about Bicep <code>what-if</code>?</a></li><li><a class="table-of-contents__link toc-highlight" href="/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops#embracing-azd-in-an-existing-azure-devops-pipeline">Embracing <code>azd</code> in an existing Azure DevOps pipeline</a></li><li><a class="table-of-contents__link toc-highlight" href="/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops#hello-azureyml">Hello <code>azure.yml</code></a></li><li><a class="table-of-contents__link toc-highlight" href="/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops#bicep-modifications">Bicep modifications</a><ul><li><a class="table-of-contents__link toc-highlight" href="/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops#using-resource-group-scoped-deployments-with-azd">Using resource group scoped deployments with azd</a></li><li><a class="table-of-contents__link toc-highlight" href="/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops#the-does-your-service-exist-parameter">The &quot;does your service exist?&quot; parameter</a></li><li><a class="table-of-contents__link toc-highlight" href="/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops#tagging-resources-with-the-environment-name">Tagging resources with the environment name</a></li><li><a class="table-of-contents__link toc-highlight" href="/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops#parameters-in-mainbicep-must-be-immutable-per-environment">Parameters in <code>main.bicep</code> must be immutable per environment</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops#welcome-mainbicepparam">Welcome <code>main.bicepparam</code></a></li><li><a class="table-of-contents__link toc-highlight" href="/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops#azure-devops-pipeline-modifications">Azure DevOps pipeline modifications</a></li><li><a class="table-of-contents__link toc-highlight" href="/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops#what-does-it-look-like-when-it-works">What does it look like when it works?</a></li><li><a class="table-of-contents__link toc-highlight" href="/using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops#conclusion">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title"></div><ul class="footer__items clean-list"><li class="footer__item"><div class="footer__title"><a href="/tags/typescript" class="footer__link-item">TypeScript<img src="/img/ts-logo-128.svg" alt="TypeScript icon" class="footer__icon"></a></div>
<ul class="footer__items clean-list">
  <li class="footer__item"><a href="/typescript-vs-jsdoc-javascript" class="footer__link-item">TypeScript vs JSDoc JavaScript</a></li><li class="footer__item"><a href="/type-annotations-strong-types-weakly-held" class="footer__link-item">Type annotations proposal: strong types, weakly held</a></li>
</ul><div class="footer__title"><a href="/tags/azure" class="footer__link-item">Azure<img src="/img/azure-logo.svg" alt="Azure icon" class="footer__icon"></a></div>
<ul class="footer__items clean-list">
  <li class="footer__item"><a href="/azure-container-apps-easy-auth-and-dotnet-authentication" class="footer__link-item">Azure Container Apps: Easy Auth and .NET</a></li><li class="footer__item"><a href="/azure-static-web-apps-dynamic-redirects-azure-functions" class="footer__link-item">Azure Static Web Apps: dynamic redirects with Azure Functions</a></li>
</ul><div class="footer__title"><a href="/tags/asp-net" class="footer__link-item">ASP.NET<img src="/img/dotnet-logo.svg" alt="ASP.NET icon" class="footer__icon"></a></div>
<ul class="footer__items clean-list">
  <li class="footer__item"><a href="/eslint-your-csharp-in-vs-code-with-roslyn-analyzers" class="footer__link-item">ESLint your C# with Roslyn Analyzers</a></li><li class="footer__item"><a href="/aspnet-serilog-and-application-insights" class="footer__link-item">ASP.NET, Serilog and Application Insights</a></li>
</ul><div class="footer__title"><a href="/tags/react" class="footer__link-item">React<img src="/img/react-logo.svg" alt="React icon" class="footer__icon"></a></div>
<ul class="footer__items clean-list">
  <li class="footer__item"><a href="/structured-data-seo-and-react" class="footer__link-item">Structured data and React</a></li><li class="footer__item"><a href="/react-usesearchparamsstate" class="footer__link-item">React: storing state in URL with URLSearchParams</a></li>
</ul></li></ul></div><div class="col footer__col"><div class="footer__title"></div><ul class="footer__items clean-list"><li class="footer__item"><div class="footer__title">Notable articles</div>
<ul class="footer__items clean-list">
  <li class="footer__item"><a href="/definitely-typed-the-movie" class="footer__link-item">The history of Definitely Typed<img src="/img/definitely-typed-logo.png" alt="The history of Definitely Typed icon" class="footer__icon"></a></li><li class="footer__item"><a href="/typescript-documentary" class="footer__link-item">TypeScript: the documentary<img src="/img/ts-logo-128.svg" alt="TypeScript: the documentary icon" class="footer__icon"></a></li><li class="footer__item"><a href="/definitive-guide-to-migrating-from-blogger-to-docusaurus" class="footer__link-item">The definitive guide to migrating from Blogger to Docusaurus<img src="/img/docusaurus-logo.svg" alt="The definitive guide to migrating from Blogger to Docusaurus icon" class="footer__icon"></a></li><li class="footer__item"><a href="/how-we-fixed-my-seo" class="footer__link-item">How we fixed my SEO</a></li>
</ul><div class="footer__title">Popular articles</div>
<ul class="footer__items clean-list">
  <li class="footer__item"><a href="/aspnet-serilog-and-application-insights" class="footer__link-item">ASP.NET, Serilog and Application Insights</a></li><li class="footer__item"><a href="/eslint-your-csharp-in-vs-code-with-roslyn-analyzers" class="footer__link-item">ESLint your C# with Roslyn Analyzers</a></li><li class="footer__item"><a href="/prettier-your-csharp-with-dotnet-format-and-lint-staged" class="footer__link-item">dotnet-format: Prettier your C# with lint-staged & husky</a></li>
</ul><div class="footer__title">Recently updated</div>
<ul class="footer__items clean-list">
  <li class="footer__item"><a href="using-azd-for-faster-incremental-azure-container-app-deployments-in-azure-devops" class="footer__link-item">Using AZD for faster incremental Azure Container App deployments in Azure DevOps</a></li><li class="footer__item"><a href="azure-container-apps-dapr-bicep-github-actions-debug-devcontainer" class="footer__link-item">Azure Container Apps: dapr, devcontainer, debug and deploy</a></li><li class="footer__item"><a href="playwright-github-actions-and-azure-static-web-apps-staging-environments" class="footer__link-item">Playwright, GitHub Actions and Azure Static Web Apps staging environments</a></li>
</ul></li></ul></div><div class="col footer__col"><div class="footer__title">Learn more / support me</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/johnnyreilly/blog.johnnyreilly.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog source code on GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/tags">Blog categories</a></li><li class="footer__item"><a href="https://johnnyreilly.com/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item">RSS feed<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://johnnyreilly.com/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item">Atom feed<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/privacy-policy">Privacy Policy</a></li><li class="footer__item"><iframe src="https://github.com/sponsors/johnnyreilly/card" title="Sponsor johnnyreilly" style="margin-top: 20px; border: 0; border-radius: 10px; background-color: white; min-height: 400px;"></iframe></li><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" rel="noopener" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" loading="lazy" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2012 - 2024 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>