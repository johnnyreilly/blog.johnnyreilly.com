<!doctype html><html lang=en dir=ltr class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.7.0"><title data-rh=true>Azure Container Apps: build and deploy with Bicep and GitHub Actions | johnnyreilly</title><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://johnnyreilly.com/azure-container-apps-build-and-deploy-with-bicep-and-github-actions><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docusaurus_tag content=default><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=docsearch:docusaurus_tag content=default><meta data-rh=true name=robots content=max-image-preview:large><meta data-rh=true name=monetization content=$ilp.uphold.com/LwQQhXdpwxeJ><meta data-rh=true property=og:title content="Azure Container Apps: build and deploy with Bicep and GitHub Actions | johnnyreilly"><meta data-rh=true name=description content="Learn how to deploy a web app to Azure Container Apps using Bicep and GitHub Actions. This post covers the configuration and deployment of secrets."><meta data-rh=true property=og:description content="Learn how to deploy a web app to Azure Container Apps using Bicep and GitHub Actions. This post covers the configuration and deployment of secrets."><meta data-rh=true property=og:image content=https://johnnyreilly.com/assets/images/title-image-7df6bacd073b7bc881e2ae3c4512f415.png><meta data-rh=true name=twitter:image content=https://johnnyreilly.com/assets/images/title-image-7df6bacd073b7bc881e2ae3c4512f415.png><meta data-rh=true property=og:type content=article><meta data-rh=true property=article:published_time content=2021-12-27T00:00:00.000Z><meta data-rh=true property=article:author content=https://johnnyreilly.com/about><meta data-rh=true property=article:tag content="Bicep,GitHub Actions,Azure Container Apps"><link data-rh=true rel=icon href=/favicon.ico><link data-rh=true rel=canonical href=https://johnnyreilly.com/azure-container-apps-build-and-deploy-with-bicep-and-github-actions><link data-rh=true rel=alternate href=https://johnnyreilly.com/azure-container-apps-build-and-deploy-with-bicep-and-github-actions hreflang=en><link data-rh=true rel=alternate href=https://johnnyreilly.com/azure-container-apps-build-and-deploy-with-bicep-and-github-actions hreflang=x-default><link data-rh=true rel=preconnect href=https://J3MYR1INLT-dsn.algolia.net crossorigin=anonymous><script data-rh=true type=application/ld+json>{"@context":"https://schema.org","@id":"https://johnnyreilly.com/azure-container-apps-build-and-deploy-with-bicep-and-github-actions","@type":"BlogPosting","author":{"@type":"Person","description":"OSS Engineer - TypeScript, Azure, React, Node.js, .NET","image":"https://johnnyreilly.com/img/profile.jpg","name":"John Reilly","url":"https://johnnyreilly.com/about"},"datePublished":"2021-12-27T00:00:00.000Z","description":"Learn how to deploy a web app to Azure Container Apps using Bicep and GitHub Actions. This post covers the configuration and deployment of secrets.","headline":"Azure Container Apps: build and deploy with Bicep and GitHub Actions","image":{"@id":"https://johnnyreilly.com/assets/images/title-image-7df6bacd073b7bc881e2ae3c4512f415.png","@type":"ImageObject","caption":"title image for the blog post: Azure Container Apps: build and deploy with Bicep and GitHub Actions","contentUrl":"https://johnnyreilly.com/assets/images/title-image-7df6bacd073b7bc881e2ae3c4512f415.png","url":"https://johnnyreilly.com/assets/images/title-image-7df6bacd073b7bc881e2ae3c4512f415.png"},"isPartOf":{"@id":"https://johnnyreilly.com/","@type":"Blog","name":"I CAN MAKE THIS WORK"},"keywords":[],"mainEntityOfPage":"https://johnnyreilly.com/azure-container-apps-build-and-deploy-with-bicep-and-github-actions","name":"Azure Container Apps: build and deploy with Bicep and GitHub Actions","url":"https://johnnyreilly.com/azure-container-apps-build-and-deploy-with-bicep-and-github-actions"}</script><link rel=alternate type=application/rss+xml href=/rss.xml title="I CAN MAKE THIS WORK RSS Feed"><link rel=alternate type=application/atom+xml href=/atom.xml title="I CAN MAKE THIS WORK Atom Feed"><link rel=search type=application/opensearchdescription+xml title=johnnyreilly href=/opensearch.xml><link rel=icon href=/img/profile-64x64.jpg><link rel=manifest href=/manifest.json><meta name=theme-color content=#3578e5><meta name=apple-mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-status-bar-style content=#000><link rel=apple-touch-icon href=/apple-touch-icon.png><link rel=preload href=https://johnnyreilly.com/fonts/Poppins-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=https://johnnyreilly.com/fonts/Poppins-Bold.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preconnect href=https://res.cloudinary.com><link rel=monetization href=https://ilp.uphold.com/LwQQhXdpwxeJ><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@id":"https://johnnyreilly.com","@type":"WebSite","copyrightHolder":{"@id":"https://johnnyreilly.com/about"},"description":"This is John Reilly's blog. John is an Open Source Software Engineer working on TypeScript, Azure, React, Node.js, .NET and more.","inLanguage":"en-UK","name":"johnnyreilly","potentialAction":{"@type":"SearchAction","query-input":"required name=search_term_string","target":{"@type":"EntryPoint","urlTemplate":"https://johnnyreilly.com/search?q={search_term_string}"}},"publisher":{"@id":"https://johnnyreilly.com/about"},"url":"https://johnnyreilly.com"},{"@id":"https://johnnyreilly.com/about","@type":"Person","address":{"@type":"PostalAddress","addressCountry":"United Kingdom","addressLocality":"London","streetAddress":"Twickenham"},"alternateName":"Johnny Reilly","birthPlace":"Bristol","description":"John is an Open Source Software Engineer working on TypeScript, Azure, React, Node.js, .NET and more. As well as writing code, John is a speaker at meetups, one of the founders of the TS Congress conference, and the author of the history of Definitely Typed, which he worked on in the early days of TypeScript.","email":"johnny_reilly@hotmail.com","image":{"@id":"https://johnnyreilly.com/about#image","@type":"ImageObject","caption":"John Reilly","contentUrl":"https://johnnyreilly.com/img/profile.jpg","height":200,"inLanguage":"en-UK","url":"https://johnnyreilly.com/img/profile.jpg","width":200},"name":"John Reilly","sameAs":["https://github.com/johnnyreilly","https://fosstodon.org/@johnny_reilly","https://twitter.com/johnny_reilly","https://bsky.app/profile/johnnyreilly.com","https://dev.to/johnnyreilly","https://app.daily.dev/johnnyreilly","https://stackoverflow.com/users/761388/john-reilly","https://blog.logrocket.com/author/johnreilly/","https://www.reddit.com/user/johnny_reilly","https://uk.linkedin.com/in/johnnyreilly"],"url":"https://johnnyreilly.com"},{"@id":"https://johnnyreilly.com/about#organization","@type":["Organization","Brand"],"description":"This is John Reilly's blog. John is an Open Source Software Engineer working on TypeScript, Azure, React, Node.js, .NET and more.","image":{"@id":"https://johnnyreilly.com/#logo"},"logo":{"@id":"https://johnnyreilly.com/#logo","@type":"ImageObject","caption":"John Reilly","contentUrl":"https://johnnyreilly.com/img/profile.jpg","height":200,"inLanguage":"en-UK","url":"https://johnnyreilly.com/img/profile.jpg","width":200},"name":"johnnyreilly","sameAs":["https://github.com/johnnyreilly","https://fosstodon.org/@johnny_reilly","https://twitter.com/johnny_reilly","https://bsky.app/profile/johnnyreilly.com","https://dev.to/johnnyreilly","https://app.daily.dev/johnnyreilly","https://stackoverflow.com/users/761388/john-reilly","https://blog.logrocket.com/author/johnreilly/","https://www.reddit.com/user/johnny_reilly","https://uk.linkedin.com/in/johnnyreilly"],"url":"https://johnnyreilly.com"}]}</script><link rel=webmention href=https://webmention.io/johnnyreilly.com/webmention><link rel=stylesheet href=/assets/css/styles.172d8ff3.css><script src=/assets/js/runtime~main.0f61f64d.js defer></script><script src=/assets/js/main.3de36613.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><link rel=preload as=image href=/img/profile-64x64.jpg><link rel=preload as=image href=https://johnnyreilly.com/img/profile.jpg><link rel=preload as=image href=/assets/images/title-image-7df6bacd073b7bc881e2ae3c4512f415.png><script type=application/ld+json>[{"@context":"https://schema.org","@id":"/azure-container-apps-build-and-deploy-with-bicep-and-github-actions#breadcrumb","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://johnnyreilly.com","name":"Home","position":1},{"@type":"ListItem","item":"https://johnnyreilly.com/blog","name":"Blog","position":2},{"@type":"ListItem","name":"Azure Container Apps: build and deploy with Bicep and GitHub Actions","position":3}],"name":"Blog breadcrumb"}]</script><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><div class=navbar__logo><img src=/img/profile-64x64.jpg alt="Profile picture of John Reilly" class="themedComponent_mlkZ themedComponent--light_NVdE" height=32 width=32><img src=/img/profile-64x64.jpg alt="Profile picture of John Reilly" class="themedComponent_mlkZ themedComponent--dark_xIcU" height=32 width=32></div><b class="navbar__title text--truncate">John Reilly</b></a><a class="navbar__item navbar__link" href=/about>About</a><a class="navbar__item navbar__link" href=/blog>Blog</a><a class="navbar__item navbar__link" href=/talks>Talks</a></div><div class="navbar__items navbar__items--right"><a href=https://github.com/johnnyreilly target=_blank rel=me class="navbar__item navbar__link">GitHub<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><a href=https://bsky.app/profile/johnnyreilly.com target=_blank rel=me class="navbar__item navbar__link">Bluesky<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><a href=https://fosstodon.org/@johnny_reilly target=_blank rel=me class="navbar__item navbar__link">Mastodon<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><a href=https://twitter.com/johnny_reilly target=_blank rel=me class="navbar__item navbar__link">Twitter<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type=button disabled title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live=polite aria-pressed=false><svg viewBox="0 0 24 24" width=24 height=24 class=lightToggleIcon_pyhR><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 class=darkToggleIcon_wfgR><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg></button></div><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class=row><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role=group><h3 class=yearGroupHeading_rMGB>2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/typescript-go-pragmatic-choice>TypeScript is going Go: Why it’s the pragmatic choice</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/microsoft-graphclient-filter-endswith-consistencylevel-eventual-header>Microsoft Graph client: how to filter by endswith</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/list-pipelines-with-azure-devops-api>List Pipelines with the Azure DevOps API</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/static-web-apps-cli-local-auth-emulator-with-dotnet-authentication>Static Web Apps CLI: local authentication emulation with ASP.NET</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/nodejs-azure-appinsights-fastify>Node.js, Azure Application Insights, and Fastify</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/get-service-connections-with-azure-devops-api>Get Service Connections with the Azure DevOps API (REST and TypeScript)</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/slash-command-your-deployment-with-github-actions>Slash command your deployment with GitHub Actions</a></ul></div><div role=group><h3 class=yearGroupHeading_rMGB>2024</h3><ul class="sidebarItemList_Yudw clean-list"><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/smuggling-gitignore-npmrc-in-npm-packages>Smuggling .gitignore, .npmrc and friends in npm packages</a></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class=title_f1Hy>Azure Container Apps: build and deploy with Bicep and GitHub Actions</h1><div class="container_mt6G margin-vert--md"><time datetime=2021-12-27T00:00:00.000Z>December 27, 2021</time> · <!-- -->14 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href=https://johnnyreilly.com/about target=_blank rel="noopener noreferrer" class=avatar__photo-link><img class="avatar__photo authorImage_XqGP" src=https://johnnyreilly.com/img/profile.jpg alt="John Reilly"></a><div class="avatar__intro authorDetails_lV9A"><div class=avatar__name><a href=https://johnnyreilly.com/about target=_blank rel="noopener noreferrer"><span class=authorName_yefp>John Reilly</span></a></div><small class=authorTitle_nd0D title="OSS Engineer - TypeScript, Azure, React, Node.js, .NET">OSS Engineer - TypeScript, Azure, React, Node.js, .NET</small><div class=authorSocials_rSDt></div></div></div></div></div></header><div id=__blog-post-container class=markdown><p>This post shows how to build and deploy a simple web application to Azure Container Apps using Bicep and GitHub Actions. This includes the configuration and deployment of secrets.</p>
<p>This post follows on from the <a href=/azure-container-apps-bicep-and-github-actions>previous post</a> which deployed infrastructure and a "hello world" container, this time introducing the building of an image and storing it in the <a href=https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry target=_blank rel="noopener noreferrer">GitHub container registry</a> so it can be deployed.</p>
<p>If you'd like to learn more about using dapr with Azure Container Apps then you might want to read <a href=/azure-container-apps-dapr-bicep-github-actions-debug-devcontainer>this post</a>.</p>
<p><img decoding=async loading=eager alt="title image reading &amp;quot;Azure Container Apps: build and deploy with Bicep and GitHub Actions&amp;quot; with the Bicep, Azure Container Apps and GitHub Actions logos" src=/assets/images/title-image-7df6bacd073b7bc881e2ae3c4512f415.png width=1600 height=900 fetchpriority=high class=img_ev3q></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=updated-02052022>Updated 02/05/2022<a href=#updated-02052022 class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>This post has been updated to reflect the migration of Azure Container Apps from the Microsoft.Web namespace to the Microsoft.App namespace in March 2022. See: <a href=https://github.com/microsoft/azure-container-apps/issues/109 target=_blank rel="noopener noreferrer">https://github.com/microsoft/azure-container-apps/issues/109</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=the-containerised-convent>The containerised convent<a href=#the-containerised-convent class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>I learn the most about a technology when I'm using it to build something. It so happens that I have an aunt that's a nun, and long ago she persuaded me to build her convent a website. I'm a good nephew and I complied. Since that time I've been merrily overengineering it for fun and non-profit.</p>
<p>My aunts website is a pretty vanilla node app. Significantly it is already containerised and runs on <a href=https://azure.microsoft.com/en-gb/services/app-service/containers/ target=_blank rel="noopener noreferrer">Azure App Service Web App for Containers</a>. Given it lives in the context of a container, this makes it a great candidate for porting to Azure Container Apps.</p>
<p>So that's what we'll do in this post. But where I'm building and deploying my aunt's container, you could equally be substituting your own; with some minimal changes.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=bicep>Bicep<a href=#bicep class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>Let's begin with the Bicep required to deploy our Azure Container App.</p>
<p>In our repository we'll create an <code>infra</code> directory, into which we'll place a <code>main.bicep</code> file which will contain our Bicep template:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> nodeImage </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> nodePort </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">int</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> nodeIsExternalIngress </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">bool</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> containerRegistry </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> containerRegistryUsername </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token decorator">@secure</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> containerRegistryPassword </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> tags </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">object</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token decorator">@secure</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> APPSETTINGS_API_KEY </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> APPSETTINGS_DOMAIN </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> APPSETTINGS_FROM_EMAIL </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> APPSETTINGS_RECIPIENT_EMAIL </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> location </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">resourceGroup</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">location</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> environmentName </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">'env-</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token interpolated-string interpolation expression function" style="color:rgb(250, 208, 0)">uniqueString</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolated-string interpolation expression function" style="color:rgb(250, 208, 0)">resourceGroup</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolated-string interpolation expression">id</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> minReplicas </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">0</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> nodeServiceAppName </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'node-app'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> workspaceName </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">'</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token interpolated-string interpolation expression">nodeServiceAppName</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">-log-analytics'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> appInsightsName </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">'</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token interpolated-string interpolation expression">nodeServiceAppName</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">-app-insights'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> containerRegistryPasswordRef </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'container-registry-password'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> mailgunApiKeyRef </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'mailgun-api-key'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> workspace </span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.OperationalInsights/workspaces@2021-12-01-preview'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> workspaceName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">location</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> location</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">tags</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> tags</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">properties</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">sku</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'PerGB2018'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">retentionInDays</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">30</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">workspaceCapping</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> appInsights </span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.Insights/components@2020-02-02'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> appInsightsName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">location</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> location</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">tags</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> tags</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">kind</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'web'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">properties</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">Application_Type</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'web'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">Flow_Type</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'Bluefield'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> environment </span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.App/managedEnvironments@2022-01-01-preview'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> environmentName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">location</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> location</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">tags</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> tags</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">properties</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">appLogsConfiguration</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">destination</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'log-analytics'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">logAnalyticsConfiguration</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">customerId</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> workspace</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">customerId</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">sharedKey</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">listKeys</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">workspace</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">id</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> workspace</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">apiVersion</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">primarySharedKey</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">containerAppsConfiguration</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">daprAIInstrumentationKey</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> appInsights</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">InstrumentationKey</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> containerApp </span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.App/containerApps@2022-01-01-preview'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> nodeServiceAppName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">kind</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'containerapps'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">tags</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> tags</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">location</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> location</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">properties</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">managedEnvironmentId</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> environment</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">id</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">configuration</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">secrets</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerRegistryPasswordRef</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerRegistryPassword</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> mailgunApiKeyRef</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> APPSETTINGS_API_KEY</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">registries</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">server</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerRegistry</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">username</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerRegistryUsername</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">passwordSecretRef</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerRegistryPasswordRef</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">ingress</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">'external'</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> nodeIsExternalIngress</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">'targetPort'</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> nodePort</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">template</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">containers</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">image</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> nodeImage</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> nodeServiceAppName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">transport</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'auto'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">env</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'APPSETTINGS_API_KEY'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">secretref</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> mailgunApiKeyRef</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'APPSETTINGS_DOMAIN'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> APPSETTINGS_DOMAIN</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'APPSETTINGS_FROM_EMAIL'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> APPSETTINGS_FROM_EMAIL</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'APPSETTINGS_RECIPIENT_EMAIL'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> APPSETTINGS_RECIPIENT_EMAIL</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">scale</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">minReplicas</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> minReplicas</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Let's talk through this template. The environment, workspace and app insights resources are fairly self explanatory. The <code>containerApp</code> resource is where the action is. We'll drill into that resource and the parameters used to configure it.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=the-node-container-app>The node container app<a href=#the-node-container-app class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>We're going to create a single container app for our node web application. This is configured with these parameters:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> nodeImage </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> nodePort </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">int</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> nodeIsExternalIngress </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">bool</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>The above parameters relate to the node application that represents the website. The <code>nodeImage</code> is the container image which should be deployed to a container app. The <code>nodePort</code> is the port from the app which should be exposed (<code>3000</code> in our case). <code>nodeIsExternalIngress</code> is <a href="https://docs.microsoft.com/en-us/azure/container-apps/ingress?tabs=bash#configuration" target=_blank rel="noopener noreferrer">whether the container should be accessible on the internet</a>. (Always <code>true</code> incidentally.)</p>
<p>When these parameters are applied to the <code>containerApp</code> resource, it looks like this:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> nodeServiceAppName </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'node-app'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> containerApp </span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.App/containerApps@2022-01-01-preview'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">properties</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">ingress</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">'external'</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> nodeIsExternalIngress</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">'targetPort'</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> nodePort</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">template</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">containers</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">image</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> nodeImage</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> nodeServiceAppName</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=accessing-the-github-container-registry>Accessing the GitHub Container Registry<a href=#accessing-the-github-container-registry class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>Given that we've told Bicep to deploy an <code>image</code>, we're going to need to tell it what registry it can use to acquire that image. Our template takes these parameters:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> containerRegistry </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> containerRegistryUsername </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token decorator">@secure</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> containerRegistryPassword </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> tags </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">object</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>With the exception of the <code>tags</code> object which is metadata to apply to resources, these parameters are related to the container registry where our images will be stored. GitHub's in our case. Remember, what we deploy to Azure Container Apps are container images. To get something running in an ACA, it first has to reside in a container registry. There's a multitude of container registries out there and we're using the one directly available in GitHub. As an alternative, we could use an <a href=https://azure.microsoft.com/en-us/services/container-registry/ target=_blank rel="noopener noreferrer">Azure Container Registry</a>, or <a href=https://hub.docker.com/ target=_blank rel="noopener noreferrer">Docker Hub</a> - or something else entirely.</p>
<p>Do note the <a href=https://docs.microsoft.com/en-us/azure/azure-resource-manager/bicep/parameters#secure-parameters target=_blank rel="noopener noreferrer"><code>@secure()</code></a> decorator. This marks the <code>containerRegistryPassword</code> parameter as secure. The value for a secure parameter isn't saved to the deployment history and isn't logged. Typically you'll want to mark secrets with the <code>@secure()</code> decorator for this very reason.</p>
<p>We use the parameters to configure the <code>registries</code> property of our container app. This tells the ACA where it can go to collect the image it needs. You can also see our first usage of secrets here. We declare the <code>containerRegistryPassword</code> as a secret which is stored against the ref <code>'container-registry-password'</code>; captured as the variable <code>containerRegistryPasswordRef</code>. That variable is then referenced in the <code>passwordSecretRef</code> property - thus telling ACA where it can find the password.</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> containerRegistryPasswordRef </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'container-registry-password'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> containerApp </span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.App/containerApps@2022-01-01-preview'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">properties</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">configuration</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">secrets</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerRegistryPasswordRef</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerRegistryPassword</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">registries</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">server</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerRegistry</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">username</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerRegistryUsername</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">passwordSecretRef</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> containerRegistryPasswordRef</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=secrets--configuration>Secrets / Configuration<a href=#secrets--configuration class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>The final collection of parameters are unrelated to the infrastructure of deployment, rather they are the things required to configure our running application:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token decorator">@secure</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> APPSETTINGS_API_KEY </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> APPSETTINGS_DOMAIN </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> APPSETTINGS_FROM_EMAIL </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">param</span><span class="token plain"> APPSETTINGS_RECIPIENT_EMAIL </span><span class="token datatype class-name" style="color:rgb(250, 208, 0)">string</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Again we've got a secret marked with <code>@secure()</code> in the form of our <code>APPSETTINGS_API_KEY</code>. Just as we did with <code>containerRegistryPassword</code>, we declare <code>APPSETTINGS_API_KEY</code> to be a secret, which is stored against the ref <code>'mailgun-api-key'</code>; captured as the variable <code>mailgunApiKeyRef</code>.</p>
<p>All of our configuration is exposed to the running application through environment variables. By and large this is achieved through the mechanism of key / value pairs (well technically <code>name</code> / <code>value</code>) with a slight variation for secrets. Similar to the <code>passwordSecretRef</code> mechanism we used for the registry password, we use a <code>secretref</code> in place of <code>value</code> when passing a secret, and the value will be the ref that was set up in the <code>secrets</code> section; <code>mailgunApiKeyRef</code> in this case.</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> mailgunApiKeyRef </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'mailgun-api-key'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> containerApp </span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.App/containerApps@2022-01-01-preview'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">properties</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">configuration</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">secrets</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> mailgunApiKeyRef</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> APPSETTINGS_API_KEY</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">template</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">containers</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">env</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'APPSETTINGS_API_KEY'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">secretref</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> mailgunApiKeyRef</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'APPSETTINGS_DOMAIN'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> APPSETTINGS_DOMAIN</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'APPSETTINGS_FROM_EMAIL'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> APPSETTINGS_FROM_EMAIL</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'APPSETTINGS_RECIPIENT_EMAIL'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> APPSETTINGS_RECIPIENT_EMAIL</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=setting-up-a-resource-group>Setting up a resource group<a href=#setting-up-a-resource-group class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>With our Bicep in place, we're going to need a resource group to send it to. Right now, Azure Container Apps aren't available everywhere. So we're going to create ourselves a resource group in North Europe which does support ACAs:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token plain">az group create </span><span class="token parameter variable" style="color:rgb(255, 238, 128)">-g</span><span class="token plain"> rg-aca </span><span class="token parameter variable" style="color:rgb(255, 238, 128)">-l</span><span class="token plain"> northeurope</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=secrets-for-github-actions>Secrets for GitHub Actions<a href=#secrets-for-github-actions class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>We're aiming to set up a GitHub Action to handle our deployment. This will depend upon a number of secrets:</p>
<p><img decoding=async loading=lazy alt="Screenshot of the secrets in the GitHub website that we need to create" src=/assets/images/screenshot-github-secrets-3033a56320387aa46bc91fdf09828bcb.png width=1544 height=842 class=img_ev3q></p>
<p>We'll need to create each of these secrets.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=azure_credentials---github-logging-into-azure><code>AZURE_CREDENTIALS</code> - GitHub logging into Azure<a href=#azure_credentials---github-logging-into-azure class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>So GitHub Actions can interact with Azure on our behalf, we need to provide it with some credentials. We'll use the Azure CLI to create these:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token plain">az ad sp create-for-rbac </span><span class="token parameter variable" style="color:rgb(255, 238, 128)">--name</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"myApp"</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(255, 238, 128)">--role</span><span class="token plain"> contributor </span><span class="token punctuation" style="color:rgb(255, 255, 255)">\</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token parameter variable" style="color:rgb(255, 238, 128)">--scopes</span><span class="token plain"> /subscriptions/</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain">subscription-id</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain">/resourceGroups/</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain">resource-group</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">\</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    --sdk-auth</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Remember to replace the <code>{subscription-id}</code> with your subscription id and <code>{resource-group}</code> with the name of your resource group (<code>rg-aca</code> if you're following along). This command will pump out a lump of JSON that looks something like this:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-json codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"clientId"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"a-client-id"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"clientSecret"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"a-client-secret"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"subscriptionId"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"a-subscription-id"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"tenantId"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"a-tenant-id"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"activeDirectoryEndpointUrl"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"https://login.microsoftonline.com"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"resourceManagerEndpointUrl"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"https://management.azure.com/"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"activeDirectoryGraphResourceId"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"https://graph.windows.net/"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"sqlManagementEndpointUrl"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"https://management.core.windows.net:8443/"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"galleryEndpointUrl"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"https://gallery.azure.com/"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"managementEndpointUrl"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"https://management.core.windows.net/"</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Take this and save it as the <code>AZURE_CREDENTIALS</code> secret in Azure.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=packages_token---azure-accessing-the-github-container-registry><code>PACKAGES_TOKEN</code> - Azure accessing the GitHub container registry<a href=#packages_token---azure-accessing-the-github-container-registry class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>We also need a secret for accessing packages from Azure. We're going to be publishing packages to the GitHub container registry. Azure is going to need to be able to access this when we're deploying. ACA deployment works by telling Azure where to look for an image and providing any necessary credentials to do the acquisition. To facilitate this we'll set up a <code>PACKAGES_TOKEN</code> secret. This is a GitHub personal access token with the <code>read:packages</code> scope. <a href=https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token target=_blank rel="noopener noreferrer">Follow the instructions here to create the token.</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=secrets-for-the-app>Secrets for the app<a href=#secrets-for-the-app class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>Alongside these infrastructure / deployment related secrets, we'll need ones to configure the app at runtime:</p>
<ul>
<li><code>APPSETTINGS_API_KEY</code> - an API key for Mailgun which will be used to send emails</li>
<li><code>APPSETTINGS_DOMAIN</code> - the domain for the email eg <code>mg.poorclaresarundel.org</code></li>
<li><code>APPSETTINGS_FROM_EMAIL</code> - who automated emails should come from eg <code>noreply@mg.poorclaresarundel.org</code></li>
<li><code>APPSETTINGS_RECIPIENT_EMAIL</code> - the email address emails should be sent to</li>
</ul>
<p>Strictly speaking, only the API key is a secret. But to simplify this post we'll configure all of these as secrets in GitHub.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=deploying-with-github-actions>Deploying with GitHub Actions<a href=#deploying-with-github-actions class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>With our secrets configured, we're now well placed to write our GitHub Action. We'll create a <code>.github/workflows/deploy.yaml</code> file in our repository and populate it thusly:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># yaml-language-server: $schema=./build.yaml</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Build and Deploy</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token key atrule">on</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># Trigger the workflow on push or pull request,</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># but only for the main branch</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">push</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">branches</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> main</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">pull_request</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">branches</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> main</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># Publish semver tags as releases.</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">tags</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'v*.*.*'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">workflow_dispatch</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">RESOURCE_GROUP</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> rg</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">aca</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">REGISTRY</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> ghcr.io</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">IMAGE_NAME</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> github.repository </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token key atrule">jobs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">build</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">runs-on</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">latest</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">strategy</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">matrix</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> </span><span class="token key atrule">'imageName'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'node-service'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token key atrule">'directory'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'./node-service'</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">permissions</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">contents</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> read</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">packages</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> write</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">outputs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">containerImage-node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> steps.image</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">tag.outputs.image</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">service </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Checkout repository</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> actions/checkout@v2</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># Login against a Docker registry except on PR</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># https://github.com/docker/login-action</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Log into registry $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> env.REGISTRY </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> github.event_name </span><span class="token tag" style="color:rgb(255, 157, 0)">!=</span><span class="token plain"> 'pull_request'</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> docker/login</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">action@v1</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">registry</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> env.REGISTRY </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">username</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> github.actor </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">password</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> secrets.GITHUB_TOKEN </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># Extract metadata (tags, labels) for Docker</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># https://github.com/docker/metadata-action</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Extract Docker metadata</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> meta</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> docker/metadata</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">action@v3</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">images</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> env.REGISTRY </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain">/$</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> env.IMAGE_NAME </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain">/$</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> matrix.services.imageName </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">tags</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token scalar string" style="color:rgb(165, 255, 144)"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            type=semver,pattern={{version}}</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            type=semver,pattern={{major}}.{{minor}}</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            type=semver,pattern={{major}}</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            type=ref,event=branch</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            type=sha</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># Build and push Docker image with Buildx (don't push on PR)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># https://github.com/docker/build-push-action</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Build and push Docker image</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> docker/build</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">push</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">action@v2</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">context</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> matrix.services.directory </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">push</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> github.event_name </span><span class="token tag" style="color:rgb(255, 157, 0)">!=</span><span class="token plain"> 'pull_request' </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">tags</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> steps.meta.outputs.tags </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> steps.meta.outputs.labels </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Output image tag</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> image</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">tag</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">run</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token scalar string" style="color:rgb(165, 255, 144)"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">          name=$(echo "image-${{ matrix.services.imageName }}" | tr '[:upper:]' '[:lower:]')</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">          value=$(echo "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.services.imageName }}:sha-$(git rev-parse --short HEAD)" | tr '[:upper:]' '[:lower:]')</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">          echo "setting output: $name=$value"</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">          echo "$name=$value" >> $GITHUB_OUTPUT</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">deploy</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">runs-on</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">latest</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">needs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">build</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Checkout repository</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> actions/checkout@v2</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Azure Login</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> azure/login@v1</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">creds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> secrets.AZURE_CREDENTIALS </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Deploy bicep</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> azure/CLI@v2</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> github.event_name </span><span class="token tag" style="color:rgb(255, 157, 0)">!=</span><span class="token plain"> 'pull_request'</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token scalar string" style="color:rgb(165, 255, 144)"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            tags='{"owner":"johnnyreilly", "email":"johnny_reilly@hotmail.com"}'</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            az deployment group create \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">              --resource-group ${{ env.RESOURCE_GROUP }} \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">              --template-file ./infra/main.bicep \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">              --parameters \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">                  nodeImage='${{ needs.build.outputs.containerImage-node }}' \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">                  nodePort=3000 \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">                  nodeIsExternalIngress=true \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">                  containerRegistry=${{ env.REGISTRY }} \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">                  containerRegistryUsername=${{ github.actor }} \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">                  containerRegistryPassword=${{ secrets.PACKAGES_TOKEN }} \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">                  tags="$tags" \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">                  APPSETTINGS_API_KEY="${{ secrets.APPSETTINGS_API_KEY }}" \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">                  APPSETTINGS_DOMAIN="${{ secrets.APPSETTINGS_DOMAIN }}" \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">                  APPSETTINGS_FROM_EMAIL="${{ secrets.APPSETTINGS_FROM_EMAIL }}" \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">                  APPSETTINGS_RECIPIENT_EMAIL="${{ secrets.APPSETTINGS_RECIPIENT_EMAIL }}"</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> What</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">if bicep</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> azure/CLI@v2</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> github.event_name == 'pull_request'</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token scalar string" style="color:rgb(165, 255, 144)"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            tags='{"owner":"johnnyreilly", "email":"johnny_reilly@hotmail.com"}'</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            az deployment group what-if \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">              --resource-group ${{ env.RESOURCE_GROUP }} \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">              --template-file ./infra/main.bicep \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">              --parameters \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">                  nodeImage='${{ needs.build.outputs.containerImage-node }}' \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">                  nodePort=3000 \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">                  nodeIsExternalIngress=true \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">                  containerRegistry=${{ env.REGISTRY }} \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">                  containerRegistryUsername=${{ github.actor }} \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">                  containerRegistryPassword=${{ secrets.PACKAGES_TOKEN }} \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">                  tags="$tags" \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">                  APPSETTINGS_API_KEY="${{ secrets.APPSETTINGS_API_KEY }}" \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">                  APPSETTINGS_DOMAIN="${{ secrets.APPSETTINGS_DOMAIN }}" \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">                  APPSETTINGS_FROM_EMAIL="${{ secrets.APPSETTINGS_FROM_EMAIL }}" \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">                  APPSETTINGS_RECIPIENT_EMAIL="${{ secrets.APPSETTINGS_RECIPIENT_EMAIL }}"</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>There's a lot in this workflow. Let's dig into the <code>build</code> and <code>deploy</code> jobs to see what's happening.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=build---building-our-image><code>build</code> - building our image<a href=#build---building-our-image class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>The <code>build</code> job is all about building our container images and pushing then to the GitHub registry. It's heavily inspired by <a href=https://twitter.com/jeffhollan target=_blank rel="noopener noreferrer">Jeff Hollan</a>'s <a href=https://github.com/Azure-Samples/container-apps-store-api-microservice target=_blank rel="noopener noreferrer">Azure sample app GHA</a>. When we look at the <code>strategy</code> we can see a <code>matrix</code> of <code>services</code> consisting of a single service; our node app:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token key atrule">strategy</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">matrix</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> </span><span class="token key atrule">'imageName'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'node-service'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token key atrule">'directory'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'./node-service'</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>This is a matrix because a typical use case of an Azure Container App will be multi-container, so we're starting generic from the beginning. The <code>outputs</code> pumps out the details of our <code>containerImage-node</code> image to be used later:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token key atrule">outputs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">containerImage-node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> steps.image</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">tag.outputs.image</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">service </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>With that understanding in place, let's examine what each of the steps in the <code>build</code> job does</p>
<ul>
<li><code>Log into registry</code> - logs into the GitHub container registry</li>
<li><code>Extract Docker metadata</code> - acquire tags which will be used for versioning</li>
<li><code>Build and push Docker image</code> - build the docker image and if this is not a PR: tag, label and push it to the registry</li>
<li><code>Output image tag</code> - write out the image tag for usage in deployment</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=deploy---shipping-our-image-to-azure><code>deploy</code> - shipping our image to Azure<a href=#deploy---shipping-our-image-to-azure class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>The <code>deploy</code> job does two possible things with our Bicep template; <code>main.bicep</code>.</p>
<p>In the case of a pull request, it runs the <a href="https://docs.microsoft.com/en-us/cli/azure/deployment/group?view=azure-cli-latest#az_deployment_group_what_if" target=_blank rel="noopener noreferrer"><code>az deployment group what-if</code></a> - this allows us to see what the effect would be of applying a PR to our infrastructure.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> What</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">if bicep</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> azure/CLI@v2</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> github.event_name == 'pull_request'</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token scalar string" style="color:rgb(165, 255, 144)"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">      tags='{"owner":"johnnyreilly", "email":"johnny_reilly@hotmail.com"}'</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">      az deployment group what-if \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">        --resource-group ${{ env.RESOURCE_GROUP }} \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">        --template-file ./infra/main.bicep \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">        --parameters \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            nodeImage='${{ needs.build.outputs.containerImage-node }}' \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            nodePort=3000 \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            nodeIsExternalIngress=true \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            containerRegistry=${{ env.REGISTRY }} \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            containerRegistryUsername=${{ github.actor }} \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            containerRegistryPassword=${{ secrets.PACKAGES_TOKEN }} \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            tags="$tags" \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            APPSETTINGS_API_KEY="${{ secrets.APPSETTINGS_API_KEY }}" \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            APPSETTINGS_DOMAIN="${{ secrets.APPSETTINGS_DOMAIN }}" \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            APPSETTINGS_FROM_EMAIL="${{ secrets.APPSETTINGS_FROM_EMAIL }}" \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            APPSETTINGS_RECIPIENT_EMAIL="${{ secrets.APPSETTINGS_RECIPIENT_EMAIL }}"</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>When it's not a pull request, it runs the <a href="https://docs.microsoft.com/en-us/cli/azure/deployment/group?view=azure-cli-latest#az_deployment_group_create" target=_blank rel="noopener noreferrer"><code>az deployment group create</code></a> command which performs a deployment of our <code>main.bicep</code> file.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Deploy bicep</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> azure/CLI@v2</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> github.event_name </span><span class="token tag" style="color:rgb(255, 157, 0)">!=</span><span class="token plain"> 'pull_request'</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token scalar string" style="color:rgb(165, 255, 144)"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">      tags='{"owner":"johnnyreilly", "email":"johnny_reilly@hotmail.com"}'</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">      az deployment group create \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">        --resource-group ${{ env.RESOURCE_GROUP }} \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">        --template-file ./infra/main.bicep \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">        --parameters \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            nodeImage='${{ needs.build.outputs.containerImage-node }}' \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            nodePort=3000 \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            nodeIsExternalIngress=true \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            containerRegistry=${{ env.REGISTRY }} \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            containerRegistryUsername=${{ github.actor }} \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            containerRegistryPassword=${{ secrets.PACKAGES_TOKEN }} \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            tags="$tags" \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            APPSETTINGS_API_KEY="${{ secrets.APPSETTINGS_API_KEY }}" \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            APPSETTINGS_DOMAIN="${{ secrets.APPSETTINGS_DOMAIN }}" \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            APPSETTINGS_FROM_EMAIL="${{ secrets.APPSETTINGS_FROM_EMAIL }}" \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            APPSETTINGS_RECIPIENT_EMAIL="${{ secrets.APPSETTINGS_RECIPIENT_EMAIL }}"</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>In either case we pass the same set of parameters:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token assign-left variable" style="color:rgb(255, 238, 128)">nodeImage</span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token string" style="color:rgb(165, 255, 144)">'${{ needs.build.outputs.containerImage-node }}'</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">\</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(255, 238, 128)">nodePort</span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token number" style="color:rgb(255, 98, 140)">3000</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">\</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(255, 238, 128)">nodeIsExternalIngress</span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain">true </span><span class="token punctuation" style="color:rgb(255, 255, 255)">\</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(255, 238, 128)">containerRegistry</span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token variable" style="color:rgb(255, 238, 128)">${{ env.REGISTRY }</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">\</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(255, 238, 128)">containerRegistryUsername</span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token variable" style="color:rgb(255, 238, 128)">${{ github.actor }</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">\</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(255, 238, 128)">containerRegistryPassword</span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token variable" style="color:rgb(255, 238, 128)">${{ secrets.PACKAGES_TOKEN }</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">\</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(255, 238, 128)">tags</span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token string" style="color:rgb(165, 255, 144)">"</span><span class="token string variable" style="color:rgb(255, 238, 128)">$tags</span><span class="token string" style="color:rgb(165, 255, 144)">"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">\</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(255, 238, 128)">APPSETTINGS_API_KEY</span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token string" style="color:rgb(165, 255, 144)">"</span><span class="token string variable" style="color:rgb(255, 238, 128)">${{ secrets.APPSETTINGS_API_KEY }</span><span class="token string" style="color:rgb(165, 255, 144)">}"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">\</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(255, 238, 128)">APPSETTINGS_DOMAIN</span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token string" style="color:rgb(165, 255, 144)">"</span><span class="token string variable" style="color:rgb(255, 238, 128)">${{ secrets.APPSETTINGS_DOMAIN }</span><span class="token string" style="color:rgb(165, 255, 144)">}"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">\</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(255, 238, 128)">APPSETTINGS_FROM_EMAIL</span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token string" style="color:rgb(165, 255, 144)">"</span><span class="token string variable" style="color:rgb(255, 238, 128)">${{ secrets.APPSETTINGS_FROM_EMAIL }</span><span class="token string" style="color:rgb(165, 255, 144)">}"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">\</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(255, 238, 128)">APPSETTINGS_RECIPIENT_EMAIL</span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token string" style="color:rgb(165, 255, 144)">"</span><span class="token string variable" style="color:rgb(255, 238, 128)">${{ secrets.APPSETTINGS_RECIPIENT_EMAIL }</span><span class="token string" style="color:rgb(165, 255, 144)">}"</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>These are either:</p>
<ul>
<li>secrets we set up earlier</li>
<li>environment variables declared at the start of the script or</li>
<li>outputs from the build step - this is where we acquire our node image</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=running-it>Running it<a href=#running-it class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>When the GitHub Action has been run you'll find that Azure Container App is now showing up inside the Azure Portal in your resource group, alongside the other resources:</p>
<p><img decoding=async loading=lazy alt="screenshot of the Azure Container App&amp;#39;s resource group in the Azure Portal" src=/assets/images/screenshot-azure-portal-container-app-49e8c53b98212824e2d1bdc70f2cee58.png width=2507 height=420 class=img_ev3q></p>
<p>And when we take a closer look at the container app, we find a URL we can navigate to:</p>
<p><img decoding=async loading=lazy alt="screenshot of the Azure Container App in the Azure Portal revealing it&amp;#39;s URL" src=/assets/images/screenshot-azure-portal-container-app-url-5bea8416dd5cb87d01a310bdb78ffd3c.png width=1404 height=388 class=img_ev3q></p>
<p>Congratulations! You've built and deployed a simple web app to Azure Container Apps with Bicep and GitHub Actions and secrets.</div><footer class=docusaurus-mt-lg><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class=col><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class=tag_QGVx><a title="The Bicep language for Azure Resource Manager templates." class="tag_zVej tagRegular_sFm0" href=/tags/bicep>Bicep</a><li class=tag_QGVx><a title="The GitHub Actions CI / CD service." class="tag_zVej tagRegular_sFm0" href=/tags/github-actions>GitHub Actions</a><li class=tag_QGVx><a title="The Azure Container Apps service. Effectively a managed Kubernetes service." class="tag_zVej tagRegular_sFm0" href=/tags/azure-container-apps>Azure Container Apps</a></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class=col><a href=https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2021-12-27-azure-container-apps-build-and-deploy-with-bicep-and-github-actions/index.md target=_blank rel="noopener noreferrer" class=theme-edit-this-page><svg fill=currentColor height=20 width=20 viewBox="0 0 40 40" class=iconEdit_Z9Sw aria-hidden=true><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"/></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href=/azure-cli-show-query-output-properties><div class=pagination-nav__sublabel>Newer Post</div><div class=pagination-nav__label>Query deployment outputs with the Azure CLI</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/azure-container-apps-bicep-and-github-actions><div class=pagination-nav__sublabel>Older Post</div><div class=pagination-nav__label>Azure Container Apps, Bicep and GitHub Actions</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#updated-02052022 class="table-of-contents__link toc-highlight">Updated 02/05/2022</a><li><a href=#the-containerised-convent class="table-of-contents__link toc-highlight">The containerised convent</a><li><a href=#bicep class="table-of-contents__link toc-highlight">Bicep</a><ul><li><a href=#the-node-container-app class="table-of-contents__link toc-highlight">The node container app</a><li><a href=#accessing-the-github-container-registry class="table-of-contents__link toc-highlight">Accessing the GitHub Container Registry</a><li><a href=#secrets--configuration class="table-of-contents__link toc-highlight">Secrets / Configuration</a></ul><li><a href=#setting-up-a-resource-group class="table-of-contents__link toc-highlight">Setting up a resource group</a><li><a href=#secrets-for-github-actions class="table-of-contents__link toc-highlight">Secrets for GitHub Actions</a><ul><li><a href=#azure_credentials---github-logging-into-azure class="table-of-contents__link toc-highlight"><code>AZURE_CREDENTIALS</code> - GitHub logging into Azure</a><li><a href=#packages_token---azure-accessing-the-github-container-registry class="table-of-contents__link toc-highlight"><code>PACKAGES_TOKEN</code> - Azure accessing the GitHub container registry</a><li><a href=#secrets-for-the-app class="table-of-contents__link toc-highlight">Secrets for the app</a></ul><li><a href=#deploying-with-github-actions class="table-of-contents__link toc-highlight">Deploying with GitHub Actions</a><ul><li><a href=#build---building-our-image class="table-of-contents__link toc-highlight"><code>build</code> - building our image</a><li><a href=#deploy---shipping-our-image-to-azure class="table-of-contents__link toc-highlight"><code>deploy</code> - shipping our image to Azure</a></ul><li><a href=#running-it class="table-of-contents__link toc-highlight">Running it</a></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class=footer__title></div><ul class="footer__items clean-list"><li class=footer__item><div class=footer__title><a href=/tags/typescript class=footer__link-item>TypeScript<img src=/img/ts-logo-128.svg alt="TypeScript icon" class=footer__icon></a></div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=/typescript-vs-jsdoc-javascript class=footer__link-item>TypeScript vs JSDoc JavaScript</a><li class=footer__item><a href=/type-annotations-strong-types-weakly-held class=footer__link-item>Type annotations proposal: strong types, weakly held</a></li>
</ul><div class=footer__title><a href=/tags/azure class=footer__link-item>Azure<img src=/img/azure-logo.svg alt="Azure icon" class=footer__icon></a></div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=/azure-container-apps-easy-auth-and-dotnet-authentication class=footer__link-item>Azure Container Apps: Easy Auth and .NET</a><li class=footer__item><a href=/introducing-azdo-npm-auth class=footer__link-item>Introducing azdo-npm-auth (Azure DevOps npm auth)</a><li class=footer__item><a href=/npx-and-azure-artifacts-the-secret-cli-delivery-mechanism class=footer__link-item>npx and Azure Artifacts: the secret CLI delivery mechanism</a><li class=footer__item><a href=/azure-static-web-apps-dynamic-redirects-azure-functions class=footer__link-item>Azure Static Web Apps: dynamic redirects with Azure Functions</a></li>
</ul><div class=footer__title><a href=/tags/asp-net class=footer__link-item>ASP.NET<img src=/img/dotnet-logo.svg alt="ASP.NET icon" class=footer__icon></a></div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=/eslint-your-csharp-in-vs-code-with-roslyn-analyzers class=footer__link-item>ESLint your C# with Roslyn Analyzers</a><li class=footer__item><a href=/aspnet-serilog-and-application-insights class=footer__link-item>ASP.NET, Serilog and Application Insights</a></li>
</ul><div class=footer__title><a href=/tags/react class=footer__link-item>React<img src=/img/react-logo.svg alt="React icon" class=footer__icon></a></div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=/structured-data-seo-and-react class=footer__link-item>Structured data and React</a><li class=footer__item><a href=/react-usesearchparamsstate class=footer__link-item>React: storing state in URL with URLSearchParams</a></li>
</ul></ul></div><div class="col footer__col"><div class=footer__title></div><ul class="footer__items clean-list"><li class=footer__item><div class=footer__title>Notable articles</div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=/definitely-typed-the-movie class=footer__link-item>The history of Definitely Typed<img src=/img/definitely-typed-logo.png alt="The history of Definitely Typed icon" class=footer__icon></a><li class=footer__item><a href=/typescript-documentary class=footer__link-item>TypeScript: the documentary<img src=/img/ts-logo-128.svg alt="TypeScript: the documentary icon" class=footer__icon></a><li class=footer__item><a href=/how-we-fixed-my-seo class=footer__link-item>How we fixed my SEO</a></li>
</ul><div class=footer__title>Popular articles</div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=/aspnet-serilog-and-application-insights class=footer__link-item>ASP.NET, Serilog and Application Insights</a><li class=footer__item><a href=/eslint-your-csharp-in-vs-code-with-roslyn-analyzers class=footer__link-item>ESLint your C# with Roslyn Analyzers</a><li class=footer__item><a href=/prettier-your-csharp-with-dotnet-format-and-lint-staged class=footer__link-item>dotnet-format: Prettier your C# with lint-staged & husky</a></li>
</ul><div class=footer__title>Recently updated</div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=typescript-go-pragmatic-choice class=footer__link-item>TypeScript is going Go: Why it’s the pragmatic choice</a><li class=footer__item><a href=azure-ad-claims-static-web-apps-azure-functions class=footer__link-item>Azure AD Claims with Static Web Apps and Azure Functions</a><li class=footer__item><a href=microsoft-graphclient-filter-endswith-consistencylevel-eventual-header class=footer__link-item>Microsoft Graph client: how to filter by endswith</a></li>
</ul></ul></div><div class="col footer__col"><div class=footer__title>Learn more / support me</div><ul class="footer__items clean-list"><li class=footer__item><a class=footer__link-item href=/about>About me</a><li class=footer__item><a href=https://github.com/johnnyreilly/blog.johnnyreilly.com target=_blank rel="noopener noreferrer" class=footer__link-item>Blog source code on GitHub<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a class=footer__link-item href=/tags>Blog categories</a><li class=footer__item><a href=https://johnnyreilly.com/rss.xml target=_blank rel="noopener noreferrer" class=footer__link-item>RSS feed<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://johnnyreilly.com/atom.xml target=_blank rel="noopener noreferrer" class=footer__link-item>Atom feed<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a class=footer__link-item href=/privacy-policy>Privacy Policy</a><li class=footer__item><iframe src=https://github.com/sponsors/johnnyreilly/card title="Sponsor johnnyreilly" style="margin-top: 20px; border: 0; border-radius: 10px; background-color: white; min-height: 400px;"></iframe><li class=footer__item><a href=https://www.buymeacoffee.com/qUBm0Wh rel=noopener target=_blank><img src=https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png loading=lazy alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></ul></div></div><div class="footer__bottom text--center"><div class=footer__copyright>Copyright © 2012 - 2025 John Reilly. Built with Docusaurus.</div></div></div></footer></div>