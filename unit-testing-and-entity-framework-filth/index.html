<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.0-rc.1">
<title data-rh="true">Unit Testing and Entity Framework: The Filth and the Fury | johnnyreilly</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://res.cloudinary.com/priou/image/fetch/f_auto,q_auto,w_auto,dpr_auto/https://johnnyreilly.com/img/profile.jpg"><meta data-rh="true" name="twitter:image" content="https://res.cloudinary.com/priou/image/fetch/f_auto,q_auto,w_auto,dpr_auto/https://johnnyreilly.com/img/profile.jpg"><meta data-rh="true" property="og:url" content="https://johnnyreilly.com/unit-testing-and-entity-framework-filth"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="robots" content="max-image-preview:large"><meta data-rh="true" name="monetization" content="$ilp.uphold.com/LwQQhXdpwxeJ"><meta data-rh="true" property="og:title" content="Unit Testing and Entity Framework: The Filth and the Fury | johnnyreilly"><meta data-rh="true" name="description" content="Controversy arises over Unit Testing with Entity Framework &amp; MOQ. A simple class could be used to wrap all Entity Framework code."><meta data-rh="true" property="og:description" content="Controversy arises over Unit Testing with Entity Framework &amp; MOQ. A simple class could be used to wrap all Entity Framework code."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2012-10-03T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://johnnyreilly.com/about"><meta data-rh="true" property="article:tag" content="automated testing,sql server"><link data-rh="true" rel="icon" href="/favicon.ico"><link data-rh="true" rel="canonical" href="https://johnnyreilly.com/unit-testing-and-entity-framework-filth"><link data-rh="true" rel="alternate" href="https://johnnyreilly.com/unit-testing-and-entity-framework-filth" hreflang="en"><link data-rh="true" rel="alternate" href="https://johnnyreilly.com/unit-testing-and-entity-framework-filth" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://J3MYR1INLT-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="johnnyreilly" href="/opensearch.xml">

<link rel="icon" href="/img/profile-64x64.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#3578e5">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="preload" href="https://johnnyreilly.com/fonts/Poppins-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://johnnyreilly.com/fonts/Poppins-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preconnect" href="https://res.cloudinary.com">
<link rel="monetization" href="https://ilp.uphold.com/LwQQhXdpwxeJ">
<script type="application/ld+json">{"@context":"https://schema.org","@graph":[{"@id":"https://johnnyreilly.com","@type":"WebSite","url":"https://johnnyreilly.com","name":"johnnyreilly","description":"This is John Reilly's blog. John is an Open Source Software Engineer working on TypeScript, Azure, React, Node.js, .NET and more.","copyrightHolder":{"@id":"https://johnnyreilly.com/about"},"publisher":{"@id":"https://johnnyreilly.com/about"},"potentialAction":{"@type":"SearchAction","target":{"@type":"EntryPoint","urlTemplate":"https://johnnyreilly.com/search?q={search_term_string}"},"query-input":"required name=search_term_string"},"inLanguage":"en-UK"},{"@id":"https://johnnyreilly.com/about","@type":"Person","name":"John Reilly","alternateName":"Johnny Reilly","image":{"@type":"ImageObject","inLanguage":"en-UK","@id":"https://johnnyreilly.com/about#image","url":"https://johnnyreilly.com/img/profile.jpg","contentUrl":"https://johnnyreilly.com/img/profile.jpg","width":200,"height":200,"caption":"John Reilly"},"description":"John is an Open Source Software Engineer working on TypeScript, Azure, React, Node.js, .NET and more. As well as writing code, John is a speaker at meetups, one of the founders of the TS Congress conference, and the author of the history of Definitely Typed, which he worked on in the early days of TypeScript.","url":"https://johnnyreilly.com","address":{"@type":"PostalAddress","streetAddress":"Twickenham","addressLocality":"London","addressCountry":"United Kingdom"},"email":"johnny_reilly@hotmail.com","birthPlace":"Bristol","sameAs":["https://github.com/johnnyreilly","https://fosstodon.org/@johnny_reilly","https://twitter.com/johnny_reilly","https://dev.to/johnnyreilly","https://app.daily.dev/johnnyreilly","https://stackoverflow.com/users/761388/john-reilly","https://blog.logrocket.com/author/johnreilly/","https://polywork.com/johnnyreilly","https://uk.linkedin.com/in/johnnyreilly"]},{"@id":"https://johnnyreilly.com/about#organization","@type":["Organization","Brand"],"url":"https://johnnyreilly.com","name":"johnnyreilly","description":"This is John Reilly's blog. John is an Open Source Software Engineer working on TypeScript, Azure, React, Node.js, .NET and more.","logo":{"@type":"ImageObject","inLanguage":"en-UK","@id":"https://johnnyreilly.com/#logo","url":"https://johnnyreilly.com/img/profile.jpg","contentUrl":"https://johnnyreilly.com/img/profile.jpg","width":200,"height":200,"caption":"John Reilly"},"image":{"@id":"https://johnnyreilly.com/#logo"},"sameAs":["https://github.com/johnnyreilly","https://fosstodon.org/@johnny_reilly","https://twitter.com/johnny_reilly","https://dev.to/johnnyreilly","https://app.daily.dev/johnnyreilly","https://stackoverflow.com/users/761388/john-reilly","https://blog.logrocket.com/author/johnreilly/","https://polywork.com/johnnyreilly","https://uk.linkedin.com/in/johnnyreilly"]}]}</script><link rel="stylesheet" href="/assets/css/styles.2ff0c239.css">
<script src="/assets/js/runtime~main.af937d66.js" defer="defer"></script>
<script src="/assets/js/main.ca86c8d0.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><script type="application/ld+json">[{"@context":"https://schema.org","@type":"BreadcrumbList","@id":"/unit-testing-and-entity-framework-filth#breadcrumb","name":"Blog breadcrumb","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https://johnnyreilly.com"},{"@type":"ListItem","position":2,"name":"Blog","item":"https://johnnyreilly.com/blog"},{"@type":"ListItem","position":3,"name":"Unit Testing and Entity Framework: The Filth and the Fury"}]}]</script><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile-64x64.jpg" alt="Profile picture of John Reilly" class="themedComponent_mlkZ themedComponent--light_NVdE" height="32" width="32"><img src="/img/profile-64x64.jpg" alt="Profile picture of John Reilly" class="themedComponent_mlkZ themedComponent--dark_xIcU" height="32" width="32"></div><b class="navbar__title text--truncate">John Reilly</b></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/talks">Talks</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://fosstodon.org/@johnny_reilly" target="_blank" rel="me" class="navbar__item navbar__link">Mastodon<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/migrating-azure-functions-node-js-v4-typescript">Migrating to v4 Azure Functions Node.js with TypeScript</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/bicep-link-azure-application-insights-to-static-web-apps">Bicep: Link Azure Application Insights to Static Web Apps</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docusaurus-3-how-to-migrate-rehype-plugins">Docusaurus 3: how to migrate rehype plugins</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure-open-ai-generate-article-metadata-with-typescript">Azure Open AI: generate article metadata with TypeScript</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/typescript-documentary">TypeScript: The Movie</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure-open-ai-capacity-quota-bicep">Azure Open AI: handling capacity and quota limits with Bicep</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure-pipelines-meet-vitest">Azure Pipelines meet Vitest</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure-container-apps-bicep-bring-your-own-certificates-custom-domains">Azure Container Apps, Bicep, bring your own certificates and custom domains</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="Controversy arises over Unit Testing with Entity Framework &amp; MOQ. A simple class could be used to wrap all Entity Framework code."><header><h1 class="title_f1Hy" itemprop="headline">Unit Testing and Entity Framework: The Filth and the Fury</h1><div class="container_mt6G margin-vert--md"><time datetime="2012-10-03T00:00:00.000Z" itemprop="datePublished">October 3, 2012</time> · <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://johnnyreilly.com/about" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://johnnyreilly.com/img/profile.jpg" alt="John Reilly" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://johnnyreilly.com/about" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div><small class="avatar__subtitle" itemprop="description">OSS Engineer - TypeScript, Azure, React, Node.js, .NET</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>Just recently I&#x27;ve noticed that there appears to be something of a controversy around Unit Testing and Entity Framework. I first came across it as I was Googling around for useful posts on using MOQ in conjunction with EF. I&#x27;ve started to notice the topic more and more and as I have mixed feelings on the subject (that is to say I don&#x27;t have a settled opinion) I thought I&#x27;d write about this and see if I came to any kind of conclusion...</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-setup">The Setup<a href="#the-setup" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>It started as I was working on a new project. We were using ASP.NET MVC 3 and Entity Framework with DbContext as our persistence layer. Rather than crowbarring the tests in afterwards the intention was to write tests to support the ongoing development. Not quite test driven development but certainly <a href="http://blog.troyd.net/Test+Supported+Development+TSD+Is+NOT+Test+Driven+Development+TDD.aspx" target="_blank" rel="noopener noreferrer">test supported development</a>. (Let&#x27;s not get into the internecine conflict as to whether this is black belt testable code or not - it isn&#x27;t but he who pays the piper etc.) Oh and we were planning to use MOQ as our mocking library.</p>
<p>It was the first time I&#x27;d used DbContext rather than ObjectContext and so I thought I&#x27;d do a little research on how people were using DbContext with regards to testability. I had expected to find that there was some kind of consensus and an advised way forwards. I didn&#x27;t get that at all. Instead I found a number of conflicting opinions.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-the-repository--unit-of-work-patterns">Using the Repository / Unit of Work Patterns<a href="#using-the-repository--unit-of-work-patterns" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>One thread of advice that came out was that people advised using the Repository / Unit of Work patterns as wrappers when it came to making testable code. This is kind of interesting in itself as to the best of my understanding ObjectSet / ObjectContext and DbSet / DbContext are both in themselves implementations of the Repository / Unit of Work patterns. So the advice was to build a Repository / Unit of Work pattern to wrap an existing Repository / Unit of Work pattern.</p>
<p>Not as mad as it sounds. The reason for the extra abstraction is that ObjectContext / DbContext in the raw are not MOQ-able.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="or-maybe-im-wrong-maybe-you-can-moq-dbcontext">Or maybe I&#x27;m wrong, maybe you can MOQ DbContext?<a href="#or-maybe-im-wrong-maybe-you-can-moq-dbcontext" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>No you can&#x27;t. Well that&#x27;s not true. You can and it&#x27;s documented <a href="http://romiller.com/2012/02/14/testing-with-a-fake-dbcontext/" target="_blank" rel="noopener noreferrer">here</a> but there&#x27;s a &quot;but&quot;. You need to be using Entity Frameworks Code First approach; actually coding up your DbContext yourself. Before I&#x27;d got on board the project had already begun and we were already some way down the road of using the Database First approach. So this didn&#x27;t seem to be a go-er really.</p>
<p>The best article I found on testability and Entity Framework was <a href="http://msdn.microsoft.com/en-us/library/ff714955.aspx" target="_blank" rel="noopener noreferrer">this one</a> by <a href="http://odetocode.com/" target="_blank" rel="noopener noreferrer">K. Scott Allen</a> which essentially detailed how you could implement the Repository / Unit of Work patterns on top of ObjectSet / ObjectContext. In the end I adapted this to do the same thing sat on top of DbSet / DbContext instead.</p>
<p>With this in place I had me my testable code. I was quite happy with this as it seemed quite intelligible. My new approach looked similar to the existing DbSet / DbContext code and so there wasn&#x27;t a great deal of re-writing to do. Sorted, right?</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="here-come-the-nagging-doubts">Here come the nagging doubts...<a href="#here-come-the-nagging-doubts" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>I did wonder, given that I found a number of articles about applying the Repository / Unit of Work patterns on top of ObjectSet / ObjectContext that there didn&#x27;t seem to be many examples to do the same for DbSet / DbContext. (I did find a few examples of this but none that felt satisfactory to me for a variety of reasons.) This puzzled me.</p>
<p>I also started to notice that a 1 man war was being waged against the approach I was using by <a href="http://www.ladislavmrnka.com/about/" target="_blank" rel="noopener noreferrer">Ladislav Mrnka</a>. Here are a couple of examples of his crusade:</p>
<ul>
<li><a href="http://stackoverflow.com/a/6904479/761388" target="_blank" rel="noopener noreferrer">An answer on StackOverflow</a> (there&#x27;s quite a few similar answers around on StackOverflow saying similar)</li>
<li><a href="http://romiller.com/2012/02/14/testing-with-a-fake-dbcontext/#div-comment-1620" target="_blank" rel="noopener noreferrer">A comment on Rowan Millers post about fake DbContexts</a></li>
</ul>
<p>Ladislav is quite strongly of the opinion that wrapping DbSet / DbContext (and I presume ObjectSet / ObjectContext too) in a further Repository / Unit of Work is an antipattern. To quote him: <em>&quot;The reason why I don’t like it is leaky abstraction in Linq-to-entities queries ... In your test you have Linq-to-Objects which is superset of Linq-to-entities and only subset of queries written in L2O is translatable to L2E&quot;</em>. It&#x27;s worth looking at <a href="http://www.youtube.com/watch?v=gNeSZYke-_Q" target="_blank" rel="noopener noreferrer">Jon Skeets explanation of &quot;leaky abstractions&quot;</a> which he did for TekPub.</p>
<p>As much as I didn&#x27;t want to admit it - I have come to the conclusion Ladislav probably has a point for a number of reasons:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-just-because-it-compiles-and-passes-unit-tests-dont-imagine-that-means-it-works">1. Just because it compiles and passes unit tests don&#x27;t imagine that means it works...<a href="#1-just-because-it-compiles-and-passes-unit-tests-dont-imagine-that-means-it-works" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>Unfortunately, a LINQ query that looks right, compiles and has passing unit tests written for it doesn&#x27;t necessarily work. You can take a query that fails when executed against Entity Framework and come up with test data that will pass that unit test. As Ladislav rightly points out: <code>LINQ-to-Objects != LINQ-to-Entities</code>.</p>
<p>So in this case unit tests of this sort don&#x27;t provide you with any security. What you need are **<u>integration</u></p>
<p>** tests. Tests that run against an instance of the database and demonstrate that LINQ will actually translate queries / operations into valid SQL.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-complex-queries">2. Complex queries<a href="#2-complex-queries" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>You can write some pretty complex LINQ queries if you want. This is made particularly easy if you&#x27;re using <a href="https://blogs.msdn.com/b/ericlippert/archive/2009/12/07/query-transformations-are-syntactic.aspx" target="_blank" rel="noopener noreferrer">comprehension syntax</a>. Whilst these queries may be simple to write it can be uphill work to generate test data to satisfy this. So much so that at times it can feel you&#x27;ve made a rod for your own back using this approach.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-lazy-loading">3. Lazy Loading<a href="#3-lazy-loading" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3>
<p>By default Entity Framework employs lazy loading. This a useful approach which reduces the amount of data that is transported. Sometimes this approach forces you to specify up front if you require a particular entity through use of <code>Include</code> statements. This again doesn&#x27;t lend itself to testing particularly well.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="where-does-this-leave-us">Where does this leave us?<a href="#where-does-this-leave-us" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>Having considered all of the above for a while and tried out various different approaches I think I&#x27;m coming to the conclusion that Ladislav is probably right. Implementing the Repository / Unit of Work patterns on top of ObjectSet / ObjectContext or DbSet / DbContext doesn&#x27;t seem a worthwhile effort in the end.</p>
<p>So what&#x27;s a better idea? I think that in the name of simplicity you might as well have a simple class which wraps all of your Entity Framework code. This class could implement an interface and hence be straightforwardly MOQ-able (or alternatively all methods could be virtual and you could forego the interface). Along with this you should have integration tests in place which test the execution of the actual Entity Framework code against a test database.</p>
<p>Now I should say this approach is not necessarily my final opinion. It seems sensible and practical. I think it is likely to simplify the tests that are written around a project. It will certainly be more reliable than just having unit tests in place.</p>
<p>In terms of the project I&#x27;m working on at the moment we&#x27;re kind of doing this in a halfway house sense. That is to say, we&#x27;re still using our Repository / Unit of Work wrappers for DbSet / DbContext but where things move away from simple operations we&#x27;re adding extra methods to our Unit of Work class or Repository classes which wrap this functionality and then testing it using our integration tests.</p>
<p>I&#x27;m open to the possibility that my opinion may be modified further. And I&#x27;d be very interested to know what other people think on the subject.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="update">Update<a href="#update" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>It turns out that I&#x27;m not alone in thinking about this issue and indeed others have expressed this rather better than me - take a look at Jimmy Bogard&#x27;s post for an example: <a href="http://lostechies.com/jimmybogard/2012/09/20/limiting-your-abstractions/" target="_blank" rel="noopener noreferrer">http://lostechies.com/jimmybogard/2012/09/20/limiting-your-abstractions/</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="updated-2">Updated 2<a href="#updated-2" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>I&#x27;ve also recently watched the following Pluralsight course by Julie Lerman: <a href="http://pluralsight.com/training/Courses/TableOfContents/efarchitecture#efarchitecture-m3-archrepo" target="_blank" rel="noopener noreferrer">http://pluralsight.com/training/Courses/TableOfContents/efarchitecture#efarchitecture-m3-archrepo</a>. In this course Julie talks about different implementations of the Repository and Unit of Work patterns in conjunction with Entity Framework. Julie is in favour of using this approach but in this module she elaborates on different &quot;flavours&quot; of these patterns that you might want to use for different reasons (bounded contexts / reference contexts etc). She makes a compelling case and helpfully she is open enough to say that this a point of contention in the community. At the end of watching this I think I felt happy that our &quot;halfway house&quot; approach seems to fit and seems to work. More than anything else Julie made clear that there isn&#x27;t one definitively &quot;true&quot; approach. Rather many different but similar approaches for achieving the same goal. Good stuff Julie!</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/automated-testing">automated testing</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/sql-server">sql server</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2012-10-03-unit-testing-and-entity-framework-filth/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/using-web-optimization-with-mvc-3"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Using Web Optimization with MVC 3</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/giving-odata-to-crm-40"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Giving OData to CRM 4.0</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#the-setup" class="table-of-contents__link toc-highlight">The Setup</a></li><li><a href="#using-the-repository--unit-of-work-patterns" class="table-of-contents__link toc-highlight">Using the Repository / Unit of Work Patterns</a></li><li><a href="#or-maybe-im-wrong-maybe-you-can-moq-dbcontext" class="table-of-contents__link toc-highlight">Or maybe I&#39;m wrong, maybe you can MOQ DbContext?</a></li><li><a href="#here-come-the-nagging-doubts" class="table-of-contents__link toc-highlight">Here come the nagging doubts...</a><ul><li><a href="#1-just-because-it-compiles-and-passes-unit-tests-dont-imagine-that-means-it-works" class="table-of-contents__link toc-highlight">1. Just because it compiles and passes unit tests don&#39;t imagine that means it works...</a></li><li><a href="#2-complex-queries" class="table-of-contents__link toc-highlight">2. Complex queries</a></li><li><a href="#3-lazy-loading" class="table-of-contents__link toc-highlight">3. Lazy Loading</a></li></ul></li><li><a href="#where-does-this-leave-us" class="table-of-contents__link toc-highlight">Where does this leave us?</a></li><li><a href="#update" class="table-of-contents__link toc-highlight">Update</a></li><li><a href="#updated-2" class="table-of-contents__link toc-highlight">Updated 2</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title"></div><ul class="footer__items clean-list"><li class="footer__item"><div class="footer__title"><a href="/tags/typescript" class="footer__link-item">TypeScript<img src="/img/ts-logo-128.svg" alt="TypeScript icon" class="footer__icon"></a></div>
<ul class="footer__items clean-list">
  <li class="footer__item"><a href="/typescript-vs-jsdoc-javascript" class="footer__link-item">TypeScript vs JSDoc JavaScript</a></li><li class="footer__item"><a href="/type-annotations-strong-types-weakly-held" class="footer__link-item">Type annotations proposal: strong types, weakly held</a></li>
</ul><div class="footer__title"><a href="/tags/azure" class="footer__link-item">Azure<img src="/img/azure-logo.svg" alt="Azure icon" class="footer__icon"></a></div>
<ul class="footer__items clean-list">
  <li class="footer__item"><a href="/azure-container-apps-easy-auth-and-dotnet-authentication" class="footer__link-item">Azure Container Apps: Easy Auth and .NET</a></li><li class="footer__item"><a href="/azure-static-web-apps-dynamic-redirects-azure-functions" class="footer__link-item">Azure Static Web Apps: dynamic redirects with Azure Functions</a></li>
</ul><div class="footer__title"><a href="/tags/asp-net" class="footer__link-item">ASP.NET<img src="/img/dotnet-logo.svg" alt="ASP.NET icon" class="footer__icon"></a></div>
<ul class="footer__items clean-list">
  <li class="footer__item"><a href="/eslint-your-csharp-in-vs-code-with-roslyn-analyzers" class="footer__link-item">ESLint your C# with Roslyn Analyzers</a></li><li class="footer__item"><a href="/aspnet-serilog-and-application-insights" class="footer__link-item">ASP.NET, Serilog and Application Insights</a></li>
</ul><div class="footer__title"><a href="/tags/react" class="footer__link-item">React<img src="/img/react-logo.svg" alt="React icon" class="footer__icon"></a></div>
<ul class="footer__items clean-list">
  <li class="footer__item"><a href="/structured-data-seo-and-react" class="footer__link-item">Structured data and React</a></li><li class="footer__item"><a href="/react-usesearchparamsstate" class="footer__link-item">React: storing state in URL with URLSearchParams</a></li>
</ul></li></ul></div><div class="col footer__col"><div class="footer__title"></div><ul class="footer__items clean-list"><li class="footer__item"><div class="footer__title">Notable articles</div>
<ul class="footer__items clean-list">
  <li class="footer__item"><a href="/definitely-typed-the-movie" class="footer__link-item">The history of Definitely Typed<img src="/img/definitely-typed-logo.png" alt="The history of Definitely Typed icon" class="footer__icon"></a></li><li class="footer__item"><a href="/typescript-documentary" class="footer__link-item">TypeScript: the documentary<img src="/img/ts-logo-128.svg" alt="TypeScript: the documentary icon" class="footer__icon"></a></li><li class="footer__item"><a href="/definitive-guide-to-migrating-from-blogger-to-docusaurus" class="footer__link-item">The definitive guide to migrating from Blogger to Docusaurus<img src="/img/docusaurus-logo.svg" alt="The definitive guide to migrating from Blogger to Docusaurus icon" class="footer__icon"></a></li><li class="footer__item"><a href="/teams-notification-webhooks" class="footer__link-item">Teams notification webhooks</a></li>
</ul><div class="footer__title">Popular articles</div>
<ul class="footer__items clean-list">
  <li class="footer__item"><a href="/aspnet-serilog-and-application-insights" class="footer__link-item">ASP.NET, Serilog and Application Insights</a></li><li class="footer__item"><a href="/eslint-your-csharp-in-vs-code-with-roslyn-analyzers" class="footer__link-item">ESLint your C# with Roslyn Analyzers</a></li><li class="footer__item"><a href="/prettier-your-csharp-with-dotnet-format-and-lint-staged" class="footer__link-item">dotnet-format: Prettier your C# with lint-staged & husky</a></li>
</ul><div class="footer__title">Recently updated</div>
<ul class="footer__items clean-list">
  <li class="footer__item"><a href="output-connection-strings-and-keys-from-azure-bicep" class="footer__link-item">Output connection strings and keys from Azure Bicep</a></li><li class="footer__item"><a href="docusaurus-3-how-to-migrate-rehype-plugins" class="footer__link-item">Docusaurus 3: how to migrate rehype plugins</a></li><li class="footer__item"><a href="docusaurus-createfeeditems-api-git-commit-date" class="footer__link-item">Docusaurus blogs: using the createFeedItems API with git commit date</a></li>
</ul></li></ul></div><div class="col footer__col"><div class="footer__title">Learn more / support me</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/johnnyreilly/blog.johnnyreilly.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog source code on GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/tags">Blog categories</a></li><li class="footer__item"><a href="https://johnnyreilly.com/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item">RSS feed<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://johnnyreilly.com/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item">Atom feed<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/privacy-policy">Privacy Policy</a></li><li class="footer__item"><iframe src="https://github.com/sponsors/johnnyreilly/card" title="Sponsor johnnyreilly" style="margin-top: 20px; border: 0; border-radius: 10px; background-color: white; min-height: 400px;"></iframe></li><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" rel="noopener" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" loading="lazy" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2012 - 2023 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>