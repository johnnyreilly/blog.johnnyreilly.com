<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>I CAN MAKE THIS WORK</title>
        <link>https://johnnyreilly.com/</link>
        <description>The blog of John Reilly ‚ù§Ô∏èüåª</description>
        <lastBuildDate>Tue, 28 Nov 2023 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <copyright>Copyright ¬© 2012 - 2023 John Reilly.</copyright>
        <item>
            <title><![CDATA[How we fixed my SEO]]></title>
            <link>https://johnnyreilly.com/how-we-fixed-my-seo</link>
            <guid>https://johnnyreilly.com/how-we-fixed-my-seo</guid>
            <pubDate>Tue, 28 Nov 2023 05:15:10 GMT</pubDate>
            <description><![CDATA[In October 2022 traffic to my site tanked. Growtika collaborated with me to fix it. This is what we did. Read it if you're trying to improve your SEO.]]></description>
            <content:encoded><![CDATA[<p>This is a follow up to my <a href="https://johnnyreilly.com/how-i-ruined-my-seo">"How I ruined my SEO"</a> post. That was about how my site stopped ranking in Google's search results around October 2022. This post is about how <a href="https://growtika.com/" target="_blank" rel="noopener noreferrer">Growtika</a> and I worked together to fix it.</p>
<p>As we'll see, the art of SEO (Search Engine Optimisation) is a mysterious one. We made a number of changes that we believe helped. All told, my site spent about a year out in the cold - barely surfacing in search results. But in October 2023 it started ranking again. And it's been ranking ever since.</p>
<p>I put that down to the assistance rendered by Growtika. What was the nature of that assistance? I'll tell you. This post is a biggie; so buckle up!</p>
<p><img loading="eager" alt="title image reading &amp;quot;How we fixed my SEO&amp;quot; with images of graphs trending upwards in the background" src="https://johnnyreilly.com/assets/images/title-image-0c20a57cb29b05a6a5ebae9048331c25.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="growtika-steps-up">Growtika steps up!<a href="https://johnnyreilly.com/how-we-fixed-my-seo#growtika-steps-up" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>I wrote <a href="https://johnnyreilly.com/how-i-ruined-my-seo">"How I ruined my SEO"</a> almost as self therapy. I was frustrated that my site's traffic had dropped. I knew it didn't really matter; my motivation for writing my blog is, in large part, about creating a long term memory for myself. But I was still frustrated. I write things that I know people find useful, and so it was suboptimal that my posts were no longer being found.</p>
<p>I should include myself in that. When I'm trying to remember how to do something (and I know I once knew how to do it) I'll often Google it. Hoping to see a blog post I once wrote that answers my question. But, no more. My own site was no longer being found by me. I was missing me. Vanity.</p>
<p>I shared the post on Hacker News, not really expecting much to happen. But it ranked, and in amongst the conversation that followed, <a href="https://news.ycombinator.com/item?id=34389421#34390189" target="_blank" rel="noopener noreferrer">someone named Growtika offered to help</a>.</p>
<p><img loading="lazy" alt="screenshot of the Hacker News conversation with Growtika" src="https://johnnyreilly.com/assets/images/screenshot-hacker-news-growtika-45a8b0116e760013c58ae40fa16426b5.webp" width="1552" height="711" class="img_ev3q"></p>
<p>I hadn't heard of Growtika before; SEO is not my world. But it turned out that Growtika specialise in helping organisations with that. Out of the goodness of their hearts, they offered to assist me. Never one to look a gift horse in the mouth, I leapt at the offer.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-mysterious-seo-feedback-loop">The mysterious SEO feedback loop<a href="https://johnnyreilly.com/how-we-fixed-my-seo#the-mysterious-seo-feedback-loop" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>I spent some time with Growtika talking through my site. They made some suggestions around getting my site to align with best practices. They also schooled me on some of the basics of SEO. I was very much a novice in this area, and so I was grateful for the education.</p>
<p>Here's the thing: SEO is a mystery. Or at least, it's not fully understood. Like Coke haven't published their recipe, Google doesn't publish its (ever evolving) algorithm. They do publish <a href="https://developers.google.com/search/docs/fundamentals/seo-starter-guide" target="_blank" rel="noopener noreferrer">SEO guidelines</a>, but they are just that: guidelines. And so, whilst there are best practices, there is no guarantee that following them will result in success.</p>
<p>What's more, the feedback loop for changes is <strong>long</strong>. It's not like fixing a program with a bug, where you tweak the code, run the tests and see if it's fixed. It's more like making a change to a program, and then waiting weeks or months to see if it's fixed. And if it's not, you have to wait again to see if the next change you make fixes it.</p>
<p>Cause and effect are just not as obvious as you might like, when it comes to SEO. So whilst I'm going to share what we did, I can't say for sure what actually lead to the improvement in my site's SEO. I'm confident that they were all good things to do. But I cannot be certain which of them made the difference.</p>
<p>As an aside, Growtika think that it's pretty absurd that developers who write high quality technical articles (and for the sake of this point, let's say mine fit into this category sometimes), need to run the gauntlet of SEO best practices to get ranked. It really shouldn't be necessary. With one of the recent Google algorithm updates; <a href="https://developers.google.com/search/docs/appearance/helpful-content-system" target="_blank" rel="noopener noreferrer">the helpful content algorithm update</a>, it feels like Google are starting to understand that it and prioritize it in their search engine. But there's still a long way to go.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-changes-we-made">The changes we made<a href="https://johnnyreilly.com/how-we-fixed-my-seo#the-changes-we-made" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Over the time we worked together, Growtika made a number of suggestions. Changes we might make that could improve my SEO. I'm going to go through the suggestions over the rest of the post. I'll also share some of the rationale as I go along.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="e-e-a-t-all-you-can">E-E-A-T all you can!<a href="https://johnnyreilly.com/how-we-fixed-my-seo#e-e-a-t-all-you-can" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>There's a concept used by Google for ranking known as Experience, Expertise, Authoritativeness, and Trust (E-E-A-T). It's about how much Google trusts the content on your site. When evaluating an author's profile for a blog post, it's worth considering the following E-E-A-T aspects:</p>
<ul>
<li><strong>Experience</strong>: What is the author's practical experience in the topic area?</li>
<li><strong>Expertise</strong>: Does the author have specialized knowledge or educational background in the subject?</li>
<li><strong>Authoritativeness</strong>: How is the author recognized by peers or industry experts? Are there publications or professional achievements highlighting their authority?</li>
<li><strong>Trustworthiness</strong>: Can the reader rely on the author for accurate and ethical information? Consider their track record and any endorsements by credible sources.</li>
</ul>
<p>I didn't have much that addressed these points on my site.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-author-profile">1. Author profile<a href="https://johnnyreilly.com/how-we-fixed-my-seo#1-author-profile" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h4>
<p>On each blog post I had a profile picture. But it wasn't being all it could be; it looked like this:</p>
<p><img loading="lazy" alt="picture of the profile image of this blog&amp;#39;s author" src="https://johnnyreilly.com/assets/images/screenshot-profile-picture-before-1f29cd5f0861c90939a843438cf60fff.webp" width="204" height="74" class="img_ev3q"></p>
<p>It's my face and the text <em>"John Reilly"</em> which linked through to my Twitter (now X) profile page. Nice enough but not really demonstrating my expertise and authority on topics. I updated it to look like this:</p>
<p><img loading="lazy" alt="picture of the profile image of this blog&amp;#39;s author with a byline" src="https://johnnyreilly.com/assets/images/screenshot-profile-picture-after-b83094c478b5ef3f4b082b527179e912.webp" width="434" height="76" class="img_ev3q"></p>
<p>Alongside my picture and name I added a byline to demonstrate my expertise and authority on topics: <em>"OSS Engineer - TypeScript, Azure, React, Node.js, .NET"</em>. Alongside that, I switched the link to the about page on my site instead of Twitter.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-about-page">2. About page<a href="https://johnnyreilly.com/how-we-fixed-my-seo#2-about-page" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h4>
<p>Since the author profile at the top of each post didn't answer all the E-E-A-T points, enriching my about page was the way forward. I updated the <a href="https://johnnyreilly.com/about">about</a> page to include a richer bio and a list of places where my site has been featured:</p>
<p><img loading="lazy" alt="screenshot of the &amp;quot;where has this blog featured section&amp;quot;" src="https://johnnyreilly.com/assets/images/screenshot-where-has-this-blog-featured-86eaf8c6332d00177a8a5eb13e247377.webp" width="1184" height="709" class="img_ev3q"></p>
<p>This was to demonstrate my expertise and authority on topics. We even snuck in some structured data - more on that later!</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="duplicate-content">Duplicate content<a href="https://johnnyreilly.com/how-we-fixed-my-seo#duplicate-content" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>My site is built using <a href="https://docusaurus.io/" target="_blank" rel="noopener noreferrer">Docusaurus</a>. Now I love Docusaurus, but it's not perfect. One of the problems with it is that it generates a number of pages that are not helpful for SEO as they <strong>duplicate content</strong>. (This is a bad thing for SEO.) Consider this report:</p>
<p><img loading="lazy" alt="screenshot of duplicate content report" src="https://johnnyreilly.com/assets/images/screenshot-duplicate-content-c3f6e850faa4ec65d5aa36c716cb57bb.webp" width="870" height="338" class="img_ev3q"></p>
<p>The report suggests there was a good amount of duplicate content on my site. This was because Docusaurus generates "pagination" pages which allow you to navigate click by click through the whole history of a blog.</p>
<p><img loading="lazy" alt="screenshot of the Docusaurus pagination mechanism" src="https://johnnyreilly.com/assets/images/screenshot-docusaurus-pagination-79b9ab66f92fc1028c04886f1f2063ff.webp" width="1119" height="861" class="img_ev3q"></p>
<p>Also Docusaurus creates "tag" (or category) pages that reproduce blog posts under tags that have been used to categorise the posts:</p>
<p><img loading="lazy" alt="screenshot of the Docusaurus tags mechanism" src="https://johnnyreilly.com/assets/images/screenshot-docusaurus-tags-8f690ea3e6a3cf8787a4133f6aaabc85.webp" width="1120" height="575" class="img_ev3q"></p>
<p>In both cases, these pages duplicate content - which lead to the above report. Rather frustratingly, the pages also feature <code>canonical</code> link tags which rather suggest that they are the canonical source of the content:</p>
<p><img loading="lazy" alt="screenshot of a canonical tag which reads: link rel=&amp;quot;canonical&amp;quot; href=&amp;quot;https://johnnyreilly.com/page/2&amp;quot;" src="https://johnnyreilly.com/assets/images/screenshot-not-helpful-canonical-d047647d683a8a446cd17ce647f4285b.png" width="796" height="324" class="img_ev3q"></p>
<p>In my case, some of these pagination or tags pages were being prioritised over the original blog posts. This felt quite strange from a readers point of view. We took a number of steps to address this.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-remove-or-noindex-unnecessary-pages">1. Remove or <code>noindex</code> unnecessary pages<a href="https://johnnyreilly.com/how-we-fixed-my-seo#1-remove-or-noindex-unnecessary-pages" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h4>
<p>I wanted to remove or <code>noindex</code> the pagination and tags pages to provide a clear signal to search engines about which pages were the most important. I couldn't remove the pages without breaking the navigation on my site, so I chose instead to <code>noindex</code> them. My site is hosted on <a href="https://johnnyreilly.com/migrating-from-github-pages-to-azure-static-web-apps">Azure Static Web Apps</a> and so I was able to achieve this fairly easily by adding the following to my <a href="https://learn.microsoft.com/en-us/azure/static-web-apps/configuration" target="_blank" rel="noopener noreferrer"><code>staticwebapp.config.json</code></a> file:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">staticwebapp.config.json</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">"route"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"/page/*"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">"headers"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">"X-Robots-Tag"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"noindex"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">"route"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"/tags/*"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">"headers"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">"X-Robots-Tag"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"noindex"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This meant that the pagination and tags pages (which were served up under URLs beginning <code>/page/</code> and <code>/tags/</code> respectively) were still available, but search engines were encouraged <a href="https://developers.google.com/search/docs/crawling-indexing/robots-meta-tag#xrobotstag" target="_blank" rel="noopener noreferrer">not to index them by the <code>X-Robots-Tag: noindex</code> header</a> that these pages now served.</p>
<p>I might see if I could land a change like this in Docusaurus itself. I think it would be helpful for others. The mechanism would need to be slightly different, as Docusaurus doesn't have control over headers your site serves. But I think it would be possible to add a <code>noindex</code> meta tag to the pagination and tags pages HTML as is <a href="https://developers.google.com/search/docs/crawling-indexing/block-indexing#implementing-noindex" target="_blank" rel="noopener noreferrer">suggested here</a>:</p>
<div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token tag punctuation" style="color:#f8f8f2">&lt;</span><span class="token tag" style="color:#f92672">meta</span><span class="token tag" style="color:#f92672"> </span><span class="token tag attr-name" style="color:#a6e22e !important">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#f8f8f2">=</span><span class="token tag attr-value punctuation" style="color:#f8f8f2">"</span><span class="token tag attr-value" style="color:#f92672">robots</span><span class="token tag attr-value punctuation" style="color:#f8f8f2">"</span><span class="token tag" style="color:#f92672"> </span><span class="token tag attr-name" style="color:#a6e22e !important">content</span><span class="token tag attr-value punctuation attr-equals" style="color:#f8f8f2">=</span><span class="token tag attr-value punctuation" style="color:#f8f8f2">"</span><span class="token tag attr-value" style="color:#f92672">noindex</span><span class="token tag attr-value punctuation" style="color:#f8f8f2">"</span><span class="token tag" style="color:#f92672"> </span><span class="token tag punctuation" style="color:#f8f8f2">/&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-docusaurus-truncate">2. Docusaurus truncate<a href="https://johnnyreilly.com/how-we-fixed-my-seo#2-docusaurus-truncate" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h4>
<p>As I've mentioned, we have pagination and tags pages that duplicate content. It's possible to make this slightly better by truncating the content on the pagination and tags pages. It amounts to adding a <code>truncate</code> marker early into the content of each blog post.</p>
<p>With this in place, the pagination and tags pages don't duplicate the content of the blog posts in full, but instead just feature a snippet of the content. There's documentation on how to do this in <a href="https://docusaurus.io/docs/blog#blog-list" target="_blank" rel="noopener noreferrer">Docusaurus here</a>.</p>
<p>I did this for every page on my blog. Given I have quite a lot of posts, doing it manually would have been tedious. So I scripted the insertion of a truncate marker after the first paragraph of each post, and it was done in a jiffy.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tags-review">Tags review<a href="https://johnnyreilly.com/how-we-fixed-my-seo#tags-review" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>I also performed something of a tag rationalisation. I had a lot of tags, and many of them were not used on more than one blog post. Also, many of them were not the greatest of tags, as this slightly embarrassing screenshot demonstrates:</p>
<p><img loading="lazy" alt="screenshot of the tags before my rationalisation" src="https://johnnyreilly.com/assets/images/screenshot-tags-before-cd940d4b05751675d6810e0bf3b5e5d7.png" width="762" height="856" class="img_ev3q"></p>
<p>As is probably apparent, I'd not really thought about tags much. I'd just added them as I'd written blog posts. I'd tagged first, asked questions later. I removed a lot of the (rather pointless) tags I had and also added a tags to blog posts that were missing them. This removed the "noise", so search engines understand the content of my blog posts, and readers also. Less is more.</p>
<p><img loading="lazy" alt="screenshot of the tags after my rationalisation" src="https://johnnyreilly.com/assets/images/screenshot-tags-after-e6f21a185490d7c20df28e1977283e50.png" width="779" height="661" class="img_ev3q"></p>
<p>Much better!</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sitemapxml-and-robotstxt"><code>sitemap.xml</code> and <code>robots.txt</code><a href="https://johnnyreilly.com/how-we-fixed-my-seo#sitemapxml-and-robotstxt" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Alongside <code>noindex</code>ing the pagination and tags pages, we took a look at my <code>sitemap.xml</code> - this is automatically generated by Docusaurus. I removed the pagination and tags pages from the <code>sitemap.xml</code> as it's a little confusing to <code>noindex</code> a page and then include it in the <code>sitemap.xml</code>.</p>
<p>Further to that, I write posts for other websites sometimes and cross post it on my own blog, with a canonical pointing to the original post. Having these posts in the <code>sitemap.xml</code> wasn't quite right as they are not the canonical source of the content. I removed them.</p>
<p>I've a number of post processing steps that run in my build step of my site, and I included this filtering in it. In the end it amounted to <a href="https://johnnyreilly.com/xml-read-and-write-with-node-js">filtering an XML file; which is pretty straightforward - I wrote about it to demonstrate</a>.</p>
<p>As well as filtering my <code>sitemap.xml</code>, I went a little further and added <code>lastmod</code> timestamps to the <code>sitemap.xml</code> based on the git commit date of the markdown file that the blog post was generated from. This was to help search engines understand how recent the content on my site is. <a href="https://johnnyreilly.com/adding-lastmod-to-sitemap-git-commit-date">I wrote about how I did this</a>. Google have subsequently announced that they use <a href="https://developers.google.com/search/blog/2023/06/sitemaps-lastmod-ping#the-lastmod-element" target="_blank" rel="noopener noreferrer"><code>lastmod</code> as a signal for scheduling re-crawling URLs</a> and so this turns out to have been a helpful change to make.</p>
<p>Alongside this, I added a <code>robots.txt</code> to my site. These are files that search engines use to understand the structure of a site and what they should and should not index. I didn't previously have one and the one I added was pretty rudimentary:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">robots.txt</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">User-agent: *</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">Allow: /</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">Sitemap: https://johnnyreilly.com/sitemap.xml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>I don't know how much this helped, but it certainly didn't hurt.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="internal-linking--footer-links">Internal linking / footer links<a href="https://johnnyreilly.com/how-we-fixed-my-seo#internal-linking--footer-links" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>We next looked at our internal linking strategy. This is about how we link to other pages on our blog from within our blog posts. The idea is that we should link to other pages on our blog that are relevant to the topic of the blog post. This helps search engines understand the structure of our blog and the relationships between the pages.</p>
<p>This was something that I did a little, but I didn't really think about. I'm now much more intentional around internal linking. I'm very much an editor of my content, and as I'm editing my posts / writing new posts I'll take a look at whether I'm linking to other relevant posts on my blog and whether perhaps I should be.</p>
<p>You'll possibly have noticed a good number of internal links in this post! I'm careful about how I do this - I have internal links where they are relevant and where I think it adds value. I don't have internal links for the sake of it. Whilst I want to improve my SEO, the main readers of my blog are humans, and I want to make sure that I'm not making the experience worse for them.</p>
<p>Alongside upping my internal linking game, Growtika suggested that the footer of my site was a prime place to add links to notable posts on my site, and also to provide an indication of topics that this site seeks to cover.</p>
<p>A picture is worth a thousand words, so here's what the footer of my site used to look like:</p>
<p><img loading="lazy" alt="screenshot of the site with very few links or much at all in the footer" src="https://johnnyreilly.com/assets/images/screenshot-footer-before-2c5131d6d96f0c101b86f8ac14cea7f0.webp" width="1259" height="384" class="img_ev3q"></p>
<p>And here is what it looks like now:</p>
<p><img loading="lazy" alt="screenshot of the site with a good number of links in the footer" src="https://johnnyreilly.com/assets/images/screenshot-footer-after-c6037d490bd0116a8175761c42ed2f53.png" width="1259" height="758" class="img_ev3q"></p>
<p>As you can see, the difference is significant. With the new enhanced footer I can call out particular articles around themes that I cover, I can highlight popular articles, and I can also emphasise articles that I think are particularly important, or recently updated. This is both about helping search engines understand what I consider to be important in my site, it's also helpful for humans that might scroll that far down. And goshdarnit, I think it looks rather fine too!</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="pages-crawl-depth">Pages crawl depth<a href="https://johnnyreilly.com/how-we-fixed-my-seo#pages-crawl-depth" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>You likely know that a primary way that search engines find content on your site is by following links. They have <a href="https://developers.google.com/search/docs/crawling-indexing/overview-google-crawlers" target="_blank" rel="noopener noreferrer">crawlers</a> that do this. The more links that a crawler has to follow to get to a page, the more difficult it is for the crawler to find that page. This is known as the pages crawl depth.</p>
<p>My initial site structure was not great. I had a number of pages that were 4+ clicks away from the home page:</p>
<p><img loading="lazy" alt="screenshot of a pages depth report" src="https://johnnyreilly.com/assets/images/screenshot-pages-depth-24758a42e1782166bceaa28325bf81be.webp" width="617" height="215" class="img_ev3q"></p>
<p>A primary reason for my pages crawl depth this was the pagination and tags pages I mentioned earlier. We originally displayed a single full length (not truncated) blog post per page, and so the pagination pages were many. Likewise, we had a lot of tags, and so the tags pages were many. This meant that the pages crawl depth was high. You want to keep the pages crawl depth as low as possible. Less is more.</p>
<p>We increased the number of blog posts displayed per page from <strong>1</strong> to <strong>20</strong> which dramatically reduced the amount of work the crawlers had to do. So instead of having few hundred pagination pages we reduced it to 16. Much better.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="remove-date-from-urls">Remove date from urls<a href="https://johnnyreilly.com/how-we-fixed-my-seo#remove-date-from-urls" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>It used to be the case that the URLs for my blog posts always featured the date of publication. This was a hangover from when I used to use Blogger as my blogging platform. I'd <a href="https://johnnyreilly.com/definitive-guide-to-migrating-from-blogger-to-docusaurus">migrated from Blogger to Docusaurus</a>, and I'd kept the date in the URL. It so happens that Docusaurus has a similar behaviour too.</p>
<p>Growtika suggested that I remove the date from the URL. This was to make the URLs shorter and more readable. Search engines also have a preference both for shorter URLs and for pages that are recent, rather than pages that are old. So removing the date from the URL would help with both of those things. Or at least it would stop search engines that looked for the date in the URL from thinking that older content was irrelevant. (And with our <code>lastmod</code> timestamps in the <code>sitemap.xml</code> we were already helping search engines understand how recent the content on my site was.)</p>
<p>I must admit, I didn't really want to make this change. I rather liked having the date in the URL. But, in Growtika we trust. I did it.</p>
<p>Where you used to go to:</p>
<p><a href="https://johnnyreilly.com/2019/10/08/definitely-typed-movie" target="_blank" rel="noopener noreferrer">https://johnnyreilly.com/2019/10/08/definitely-typed-movie</a></p>
<p>You now go to:</p>
<p><a href="https://johnnyreilly.com/definitely-typed-the-movie" target="_blank" rel="noopener noreferrer">https://johnnyreilly.com/definitely-typed-the-movie</a></p>
<p>And of course, we made sure a redirect mechanism was in place to ensure that the old URLs still worked. More on that later - you can test the redirect if you like!</p>
<p><img loading="lazy" alt="screenshot of 301 redirect from the old url to the dateless one" src="https://johnnyreilly.com/assets/images/screenshot-301-redirect-3b90c16058c8c9207bdeb13f5c144e74.webp" width="766" height="451" class="img_ev3q"></p>
<p>To implement this we used the <a href="https://docusaurus.io/docs/api/plugins/@docusaurus/plugin-content-blog#slug" target="_blank" rel="noopener noreferrer">slug feature of Docusaurus</a>. If you want to see the mega PR that implemented this on nearly 300 blog posts <a href="https://github.com/johnnyreilly/blog.johnnyreilly.com/pull/423/files" target="_blank" rel="noopener noreferrer">it's here</a>. You won't be surprised to learn I scripted this change - life's too short to do boring things by hand.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="blog-archive-renamed-to-blog">Blog archive renamed to blog<a href="https://johnnyreilly.com/how-we-fixed-my-seo#blog-archive-renamed-to-blog" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>As I've said, Docusaurus is <em>great</em> but it historically has had some defaults that hurt SEO from a blogging perspective. One of these I identified when I was first planning to migrate from Blogger to Docusaurus. Docusaurus didn't ship with a blog archive. This is a page that allows you to browse through your historic blog posts. A place where you can see all that you've written and when. I find this very helpful. It's also helpful for search engines to understand the structure of your site.</p>
<p>I hand-rolled <a href="https://johnnyreilly.com/blog-archive-for-docusaurus">my own blog archive for Docusaurus</a> before I migrated. It looked like this:</p>
<p><img loading="lazy" alt="screenshot of the original blog archive functionality" src="https://johnnyreilly.com/assets/images/docusaurus-blog-archive-small-bd329602845b234668d34dd7fce47bb2.webp" width="1507" height="613" class="img_ev3q"></p>
<p>My implementation was later made part of Docusaurus itself by <a href="https://github.com/gabrielcsapo" target="_blank" rel="noopener noreferrer">Gabriel Csapo</a> in <a href="https://github.com/facebook/docusaurus/pull/5428" target="_blank" rel="noopener noreferrer">this PR</a>. So now by default, all Docusaurus sites have a blog archive that lives at <code>/archive</code> in the blog. This is great news for Docusaurus users!</p>
<p>In one if the more speculative changes we made, we changed the URL of the blog archive from <code>/archive</code> to <code>/blog</code> (and the associated navbar label).
It was a wild guess (and it may not have made any difference) but the thinking was that it might affect the CTA (call to action) of people who see my site on Google. If they saw old date in the URL and "archive" in the breadcrumbs, maybe they'd think the site is "not relevant for the search I have now"?</p>
<p>So our tweaked blog archive page now looked like this:</p>
<p><img loading="lazy" alt="screenshot of the blog archive functionality as it looks now" src="https://johnnyreilly.com/assets/images/screenshot-blog-archive-now-a1d8a655d412bcaacb875a49acd21da3.png" width="1165" height="849" class="img_ev3q"></p>
<p>We also added a <code>301</code> redirect from <code>/archive</code> to <code>/blog</code> to ensure that any links to the old URL would still work.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="structured-data">Structured data<a href="https://johnnyreilly.com/how-we-fixed-my-seo#structured-data" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>One of the most intriguing strategies we followed was to build on the structured data support in my site. Structured data is a way of providing metadata about a page in a machine readable format. It's a way of providing a clear signal to search engines about the content of a page; it makes their lives easier.</p>
<p>As it turned out, I already had some structured data support in my site; <a href="https://johnnyreilly.com/structured-data-seo-and-react">I'd written about how to add it previously</a>. But we were to go further!</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-faqs-with-structured-data">1. FAQs with Structured Data<a href="https://johnnyreilly.com/how-we-fixed-my-seo#1-faqs-with-structured-data" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h4>
<p>One of the experiments we ran was to add FAQs to a post, and with that, the equivalent FAQ Structured Data. The intent being to see if this would help with the SEO for that post. So, because I'm super meta, I wrote a <a href="https://johnnyreilly.com/docusaurus-structured-data-faqs-mdx">post about how to do that</a> which included FAQs and the equivalent structured data.</p>
<p>I also added FAQ structured data to another post and Growtika resubmitted it to Google for indexing. Then two things happened. Firstly, the page was indexed:</p>
<p><img loading="lazy" alt="screenshot showing the page featuring in search results" src="https://johnnyreilly.com/assets/images/screenshot-faqs-structured-data-indexed-4641360df4ff4e644a499221e4e21a85.webp" width="620" height="481" class="img_ev3q"></p>
<p>And then the page started featuring FAQs in the search results:</p>
<p><img loading="lazy" alt="screenshot showing the page featuring in search results and showing FAQs as well" src="https://johnnyreilly.com/assets/images/screenshot-faqs-structured-data-a8611a34cbf2eb5e8ca801fa6c59ff42.webp" width="625" height="390" class="img_ev3q"></p>
<p>I've included the reactions at the bottom of each screenshot above - we were quite excited!</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-site-wide-structured-data">2. Site wide structured data<a href="https://johnnyreilly.com/how-we-fixed-my-seo#2-site-wide-structured-data" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h4>
<p>Beyond adding individual structured data to each page and post, I added site wide structured data. This would proclaim from the rooftops about the nature of my site.</p>
<p>So I decided to add site wide structured data of the following types: (there are many types of structured data which you can read about at <a href="https://schema.org/" target="_blank" rel="noopener noreferrer">https://schema.org/</a> and in <a href="https://developers.google.com/search/docs/appearance/structured-data/search-gallery" target="_blank" rel="noopener noreferrer">this Google document on the topic</a>)</p>
<ul>
<li>Website</li>
<li>Organisation / Brand</li>
<li>Person</li>
</ul>
<p>You can see how the structured data is implemented in <a href="https://github.com/johnnyreilly/blog.johnnyreilly.com/pull/676" target="_blank" rel="noopener noreferrer">this PR</a>. We used the <a href="https://docusaurus.io/docs/api/docusaurus-config#headTags" target="_blank" rel="noopener noreferrer"><code>headTags</code> API in Docusaurus</a> to add site wide JSON-LD structured data. Funnily enough, <a href="https://github.com/facebook/docusaurus/pull/8151" target="_blank" rel="noopener noreferrer">I contributed the <code>headTags</code> API to Docusaurus</a> long before I thought I'd end up using it for this!</p>
<p>In this change we are <em>heavily</em> inspired by the full structured data graph work <a href="https://yoast.com/rich-results-schema-structured-data-story/" target="_blank" rel="noopener noreferrer">Yoast have done</a>. With site wide structured data in place, every page that search engines index on my site will have structured data that describes the site as a whole.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-breadcrumbs-with-structured-data">3. Breadcrumbs with Structured Data<a href="https://johnnyreilly.com/how-we-fixed-my-seo#3-breadcrumbs-with-structured-data" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h4>
<p>Finally I added breadcrumbs to my blog posts. Breadcrumbs are a way of indicating to search engines where a page sits in the hierarchy of a site. <a href="https://johnnyreilly.com/docusaurus-blogs-adding-breadcrumb-structured-data">I wrote about how I did this</a>. It's worth noting that the approach outlined in that post I've subsequently simplified. Originally I added a breadcrumb for the page structure and also one per tag on the post. I've since removed the tag breadcrumbs as they were not adding much value. Less is more.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="do-backlinks-better">Do backlinks better!<a href="https://johnnyreilly.com/how-we-fixed-my-seo#do-backlinks-better" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>I mentioned in <a href="https://johnnyreilly.com/how-i-ruined-my-seo">"How I ruined my SEO"</a> that I had a number of backlinks to my site. I also mentioned that I had broken a number of the backlinks by my carelessness. I planned to fix the broken backlinks and also do a better job of backlinks in general.</p>
<p>I'd already implemented support for dynamic redirects on my site. What this meant was, if someone linked through to a non-existent page on my site, rather than having just a 404 Not Found, I could do some fairly sophisticated work to redirect them to the correct URL. Thus protecting (and unbreaking previously broken) backlinks. By the way, using Azure Static Web Apps as my hosting mechanism really helped me out here as the dynamic redirect mechanism I had was super powerful - I wasn't limited to regexes. If you want see how I did that <a href="https://johnnyreilly.com/azure-static-web-apps-dynamic-redirects-azure-functions">have a read of this</a>.</p>
<p>What I had was good, but I could do better. I did the following:</p>
<ul>
<li>exhaustively fix all my broken backlinks; getting them all to redirect to the correct place. This meant logging broken backlinks and repairing them over time. Tedious, but worth it.</li>
<li>add a redirect from my old site domain to my new one (blog.johnnyreilly.com -&gt; johnnyreilly.com)</li>
<li>redirect <strong>only once</strong>. I had a number of redirects that were chained together. I had a 301 leading to 301 leading to 301 (yes!) and only then leading to a 200. Redirecting only once would be better. This would ensure that search engines didn't have to follow a chain of redirects to get to the content they were looking for. Search engines don't like that; you lose "link juice" the more redirects there are. Also, multi redirects make my website work harder than it needs to.</li>
</ul>
<p>Again, less is more. With these changes made, I had a much better backlink story.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="improving-site-performance">Improving site performance<a href="https://johnnyreilly.com/how-we-fixed-my-seo#improving-site-performance" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Another aspect which factors into SEO is performance. Google has a <a href="https://web.dev/articles/vitals" target="_blank" rel="noopener noreferrer">Core Web Vitals</a> measurement which is about evaluating the performance of websites. It covers how fast a website loads, how responsive it is / how quickly it becomes interactive.</p>
<p>The thing that was hurting my site's performance was images. The images on my site were generally not optimised at all. They were also not lazy loaded. This meant that the images were slowing down the loading of my site, and this reflected in my <a href="https://developer.chrome.com/docs/lighthouse/overview/" target="_blank" rel="noopener noreferrer">Lighthouse</a> scores.</p>
<p>I took a number of actions to improve the site image performance.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-improved-performance-using-tinypngs-image-optimisation-api">1. Improved performance using TinyPNG's image optimisation API<a href="https://johnnyreilly.com/how-we-fixed-my-seo#1-improved-performance-using-tinypngs-image-optimisation-api" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h4>
<p>The first, and most obvious, was to optimise the images on my site. There's many ways you can do this; I chose to use <a href="https://tinypng.com/developers" target="_blank" rel="noopener noreferrer">TinyPNG's API</a>. I wrote about <a href="https://johnnyreilly.com/image-optimisation-tinypng-api">how I did this</a>. Ultimately I wrote a script that optimised all the images on my site, and allowed me to run it on demand for the images of a particular post.</p>
<p>This shrunk the file size of images on my site served significantly, and improved the performance. Once again, less is more.</p>
<p>I also <a href="https://johnnyreilly.com/lighthouse-meet-github-actions">added Lighthouse to my site's build step</a>, so I could get some performance measurements surfaced into my pull requests. This made it easy to catch potential regressions, where I might accidentally add unoptimised images to my site.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-improved-performance-using-cloudinarys-on-demand-image-transformation-cdn">2. Improved performance using Cloudinary's on demand image transformation CDN<a href="https://johnnyreilly.com/how-we-fixed-my-seo#2-improved-performance-using-cloudinarys-on-demand-image-transformation-cdn" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h4>
<p>Having tackled the low hanging fruit of images not being optimal in the first place, I then went further. Cloudinary offer a <a href="https://cloudinary.com/documentation/image_transformations" target="_blank" rel="noopener noreferrer">CDN that can transform images on demand</a>. This means that you can serve the same image in different sizes, formats and qualities depending on the device that is requesting it. This is a great way to improve performance.</p>
<p>I was able to plug the Cloudinary CDN into my site using by building a the <a href="https://github.com/johnnyreilly/rehype-cloudinary-docusaurus" target="_blank" rel="noopener noreferrer"><code>rehype-cloudinary-docusaurus</code> plugin</a> which can be used to integrate Cloudinary into Docusaurus. You can <a href="https://johnnyreilly.com/docusaurus-image-cloudinary-rehype-plugin">read more about how it works here</a>.</p>
<p>Now when my site serves an image, it serves the optimal image for the device that is requesting it. This improves the performance of my site. (And you can do this too if you're using Docusaurus!)</p>
<p>In fact I went a little further and scripted the patching of my <a href="https://johnnyreilly.com/open-graph-sharing-previews-guide">Open Graph images</a> to make use of Cloudinary too. This meant that the images that were shared on social media were also optimised for the device that was requesting them. I don't think this helped with SEO, but I'd noticed that large and / or slow loading Open Graph images aren't always used by platforms that support the Open Graph protocol. With the Cloudinary image transformation CDN in place, this became much less of an issue.</p>
<p>Incidentally, Cloudinary got wind of this change and invited me onto their <a href="https://youtube.com/watch?v=G4WTEEwI6Qs" target="_blank" rel="noopener noreferrer">DevJams live stream to talk about it</a>. I was very flattered to be asked and it was a lot of fun!</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-improved-performance-using-fetchpriorityhigh-and-loadinglazy">3. Improved performance using <code>fetchpriority="high"</code> and <code>loading="lazy"</code><a href="https://johnnyreilly.com/how-we-fixed-my-seo#3-improved-performance-using-fetchpriorityhigh-and-loadinglazy" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h4>
<p>So far we'd handled the performance of images on my site by optimising them and serving them in an optimal way. But there was more we could do. We could also make sure that the images on my site were loaded in an optimal way.</p>
<p>We did this by adding <code>fetchpriority="high"</code> to the first image on each blog post; the "title" image if you will. This is a hint to the browser that the image is important and should be loaded as soon as possible. We also added <code>loading="lazy"</code> to all the other images on a given blog post. This is a hint to the browser that those images (the "below the fold" images) are not as important, and can be loaded later if and when they are required.</p>
<p>The effect of these two changes combined, is that when a browser lands on a blog post it loads the first image as soon as possible, and then it doesn't immediately load the rest images; it focuses on giving the user a usable page. The upshot of this is that the Largest Contentful Paint (LCP) is loaded as soon as possible and the browser remains more responsive. The remaining images may be loaded... Or they may not - it depends on whether people scroll down to them. This translates into improved perceived performance / user experience.</p>
<p>And again: less is more. <a href="https://johnnyreilly.com/docusaurus-improve-core-web-vitals-fetchpriority">I've written about how using <code>fetchpriority="high"</code> and <code>loading="lazy"</code> was implemented in depth here</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="be-careful-publishing-your-content-on-other-sites">Be careful publishing your content on other sites<a href="https://johnnyreilly.com/how-we-fixed-my-seo#be-careful-publishing-your-content-on-other-sites" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>One of the ideas I'd had as I attempted to fix my SEO was to publish my content on other sites. I'd seen other people do this, and I thought it might be a good idea. So I set up a mechanism that published my blog posts to <a href="https://dev.to/johnnyreilly" target="_blank" rel="noopener noreferrer">dev.to</a> with the canonical pointing back to my site. I was so pleased with my idea I even wrote about <a href="https://johnnyreilly.com/publishing-docusaurus-to-devto-with-devto-api">how I did it</a>.</p>
<p>Publishing content on other sites isn't inherently negative. However, in my case, it created confusion. I'd hoped that publishing my content on dev.to would help my SEO. It didn't. My content on dev.to ranked higher than the original content on my own website (most times my site didn't rank at all).</p>
<p>Growtika were keen to "cancel the noise", which would improve their understanding of my ranking situation. Since dev.to was ranking instead of my site, it was difficult to analyze how long it took for articles to rank on my site. Stopping the submission of content to external sites would help clarify the situation.</p>
<p>I turned the mechanism off. This helped them determine the time it took for my site to achieve a ranking.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="get-your-site-featured-in-relevant-places">Get your site featured in relevant places<a href="https://johnnyreilly.com/how-we-fixed-my-seo#get-your-site-featured-in-relevant-places" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Whilst actually publishing your content on other sites with a canonical turns out not to be the best idea, getting your site featured in relevant places is a good idea. This is about getting your site linked to from other sites. This is a signal to search engines that your site is relevant and important.</p>
<p>I already had a number of links to my site from other sites. For instance, I'd regularly show up in <a href="https://azureweekly.info/" target="_blank" rel="noopener noreferrer">Azure Weekly</a>, <a href="https://blog.cwa.me.uk/" target="_blank" rel="noopener noreferrer">The Morning Brew</a> and a number of other sites. Many of these use my RSS feed.</p>
<p>I also submitted my site to a number of other places. For instance, I submitted my site to <a href="https://daily.dev/" target="_blank" rel="noopener noreferrer">daily.dev</a>. A good rule of thumb here for picking places tended to be "where do you go to read about the topics you write about?". But crucially I didn't place my content on others sites, I just linked to my site from other sites.</p>
<p>As a side note, I rather wish that RSS still thrived. I support it - people still use it to read my blog. But it's not as popular as it once was.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="add-meta-description-to-blog-posts">Add meta description to blog posts<a href="https://johnnyreilly.com/how-we-fixed-my-seo#add-meta-description-to-blog-posts" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>The final tweak we're going to cover, is adding meta descriptions to my posts. This is a short description of the content of the blog post that is included in the HTML of the page:</p>
<div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token tag punctuation" style="color:#f8f8f2">&lt;</span><span class="token tag" style="color:#f92672">meta</span><span class="token tag" style="color:#f92672"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token tag" style="color:#f92672">  </span><span class="token tag attr-name" style="color:#a6e22e !important">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#f8f8f2">=</span><span class="token tag attr-value punctuation" style="color:#f8f8f2">"</span><span class="token tag attr-value" style="color:#f92672">description</span><span class="token tag attr-value punctuation" style="color:#f8f8f2">"</span><span class="token tag" style="color:#f92672"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token tag" style="color:#f92672">  </span><span class="token tag attr-name" style="color:#a6e22e !important">content</span><span class="token tag attr-value punctuation attr-equals" style="color:#f8f8f2">=</span><span class="token tag attr-value punctuation" style="color:#f8f8f2">"</span><span class="token tag attr-value" style="color:#f92672">In October 2022 traffic to my site tanked. Growtika collaborated with me to fix it. This is what we did. Read it if you're trying to improve your SEO.</span><span class="token tag attr-value punctuation" style="color:#f8f8f2">"</span><span class="token tag" style="color:#f92672"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token tag" style="color:#f92672"></span><span class="token tag punctuation" style="color:#f8f8f2">/&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It's not visible to humans, but it is visible to search engines. And it's kind of visible to humans at one remove, in that it is often used as the description of the page in search results.</p>
<p>We followed these meta description guidelines:</p>
<ul>
<li>Keep it between 150-155 characters</li>
<li>Use an active voice and make it actionable / include a call to action</li>
<li>Use a focused keyphrase</li>
<li>Make sure it matches the content of the page</li>
<li>Make it unique.</li>
</ul>
<p>I'd previously not included meta descriptions on my blog posts. I found myself with the daunting task of writing meta descriptions for nearly 300 blog posts. I decided to script it. I wrote a script that would generate a meta description for each blog post based on the content of the blog post, powered by Azure Open AI. I then ran the script and added the meta descriptions to my blog posts. I wrote about <a href="https://johnnyreilly.com/azure-open-ai-generate-article-metadata-with-typescript">how I did this here</a>.</p>
<p>This left me with meta descriptions for all my blog posts. It was also rather fun to use AI for something that was not GPT or copilot related!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="drop-off-and-recovery-in-numbers-and-graphs">Drop off and recovery in numbers and graphs<a href="https://johnnyreilly.com/how-we-fixed-my-seo#drop-off-and-recovery-in-numbers-and-graphs" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>As I mentioned earlier, my SEO has now recovered. I'm ranking again in search results. I'm not ranking quite as highly as I was before; I think my site is possibly still in the throes of recovery. But without a doubt, it's definitely trending in the right direction. I want to show you some graphs and numbers to demonstrate this.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ahrefs">Ahrefs<a href="https://johnnyreilly.com/how-we-fixed-my-seo#ahrefs" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Here's a graph from Ahrefs showing my site's performance over the last two years:</p>
<p><img loading="lazy" alt="gif from ahrefs showing a massive drop off then recovery" src="https://johnnyreilly.com/assets/images/screenshot-ahrefs-two-years-7df86ac3269fb2d53f4625dae23d0479.gif" width="2155" height="1574" class="img_ev3q"></p>
<p>Notably, you can see the drop off happened around the time of a Google algorithm update. Likewise, it's really important to highlight that the traffic <strong>increased</strong> around the time Google made <em>another</em> algorithm update. It's impossible to know if the traffic would still have gone up if we had not made our changes. Perhaps it would, maybe to a lesser extent. We just don't know. It does demonstrate the power of Google's algorithm updates though. The graph alone tells a story, a phenomenal drop off in traffic followed by a recovery.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="google-search-console">Google Search Console<a href="https://johnnyreilly.com/how-we-fixed-my-seo#google-search-console" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>A couple of simpler graphs from Google Search Console tell a similar story. Here's a graph showing my site's performance over time:</p>
<p><img loading="lazy" alt="screenshot from Google Search Console showing performance over time" src="https://johnnyreilly.com/assets/images/screenshot-of-performance-18493275b3b00e779ce1894577884b40.webp" width="900" height="294" class="img_ev3q"></p>
<p>Observe the massive drop off in February 2023. And then the recovery in October / November 2023. It's a similar story to the ahrefs graph above. Further to that, here is the traffic for 28 days in February 2023 vs 28 days in October / November 2023:</p>
<p><img loading="lazy" alt="screenshot from Google Search Console showing few results in February 2023 vs lots of results in October / November 2023" src="https://johnnyreilly.com/assets/images/screenshot-google-search-console-af96833d6ddd48eca6d90e75d54083b1.webp" width="1392" height="576" class="img_ev3q"></p>
<p>If you're reading on a mobile device you may not even realise that there are two lines on the graph; the February 2023 line is so low and flat as to be almost invisible.</p>
<p>The difference is stark. I couldn't get arrested from a search perspective in February 2023; showing up a mere <strong>5,000</strong> times in search results. That sounds like a big number, but in search terms it's really not. But by October / November 2023 I was back in the game, showing up <strong>274,000</strong> times in search results. That's a <strong>55x</strong> increase!</p>
<p>An interesting aside, that I've excluded from the graph, is that my total clicks increased from <strong>1,160</strong> to <strong>5,470</strong> when comparing Februray to October / November. This is a mere factor of <strong>4</strong>. What does that mean? It means when my site was showing up very rarely in search results, it enjoyed a very healthy click through rate. People clicked on my search results when they saw them!</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="bing-webmaster-tools">Bing webmaster tools<a href="https://johnnyreilly.com/how-we-fixed-my-seo#bing-webmaster-tools" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>This post has mostly been driven by discussing how Google stopped ranking my site in their search results. What I haven't really mentioned is that other search engines <strong>did not</strong> stop ranking my site. I was still showing up in Bing and DuckDuckGo's search results. Here's a graph from Bing webmaster tools (Bing's equivalent to Google Search Console) showing my site's performance over the last six months:</p>
<p><img loading="lazy" alt="screenshot from Bing webmaster tools" src="https://johnnyreilly.com/assets/images/screenshot-bing-webmaster-tools-graph-2223f31d2a70d62d1fcc9c7a67e37589.webp" width="977" height="391" class="img_ev3q"></p>
<p>There's two things to take from the above graph:</p>
<ol>
<li>My site consistently ranked (and ranks) in Bing search results. There was no drop off in Bing as there was in Google.</li>
<li>The numbers from Bing are much lower than the numbers from Google. So whilst I was still ranking in Bing, it wasn't making up for the loss of traffic from Google. This is probably a reflection of the fact that Google is the dominant search engine.</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="google-analytics">Google Analytics<a href="https://johnnyreilly.com/how-we-fixed-my-seo#google-analytics" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>You might be curious as to what the actual impact of that is on my sites traffic. It's fairly significant; around 80% of my sites traffic comes from search engines. So when my Google SEO tanked, my traffic was significantly (but not terminally) impacted. Consider the graph below from Google Analytics:</p>
<p><img loading="lazy" alt="screenshot of Google Analytics graph showing higher traffic now as compared to earlier" src="https://johnnyreilly.com/assets/images/screenshot-google-analytics-32297924765de274119ee025e907933e.png" width="717" height="418" class="img_ev3q"></p>
<p>It covers a similar time frame to the Google Search Console and ahrefs graphs above. It shows that now, on a weekday (weekends are quieter) I get around <strong>350</strong> unique visitors to my site. Whereas for the comparison period it was more like <strong>100</strong> unique users per day. That's roughly a <strong>3.5x%</strong> increase in traffic; which is not to be sniffed at.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://johnnyreilly.com/how-we-fixed-my-seo#conclusion" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>This is not a post I'd expected to write. SEO used to be something I didn't think about much. But it turns out that a way to get my attention, is taking away my traffic! I'm actually rather grateful that all this happened as it got me to thinking and learning about SEO in a way that I quite enjoyed.</p>
<p>As I say, whilst I can't be certain which of the changes we made made the difference, I'm confident that my site now is better than my site a year ago. It loads faster, it's more performant, it's more structured, it's better linked, it's better optimised. It's better. It looks the part too. I'm really quite proud of it.</p>
<p>I'm also phenomenally grateful to Growtika for their help. I should say that a few others offered pointers and suggestions which I was thankful for. But it was Growtika who stuck by my side for the long haul. For nearly a year they worked with me; and for a long time saw no improvements in my sites traffic at all. They didn't give up. They were patient with me, and they were generous with their time and expertise. I'm very grateful to them for all their help.</p>
<p>If you're looking for help with SEO, I'd recommend you check out <a href="https://growtika.com/" target="_blank" rel="noopener noreferrer">Growtika</a>. They're fantastic folk!</p>]]></content:encoded>
            <category>seo</category>
            <category>docusaurus</category>
            <category>azure static web apps</category>
        </item>
        <item>
            <title><![CDATA[Docusaurus 3: how to migrate rehype plugins]]></title>
            <link>https://johnnyreilly.com/docusaurus-3-how-to-migrate-rehype-plugins</link>
            <guid>https://johnnyreilly.com/docusaurus-3-how-to-migrate-rehype-plugins</guid>
            <pubDate>Sat, 28 Oct 2023 04:32:07 GMT</pubDate>
            <description><![CDATA[Learn how to migrate rehype plugins to Docusaurus 3.]]></description>
            <content:encoded><![CDATA[<p>Docusaurus v3 is on the way. One of the big changes that is coming with Docusaurus 3 is MDX 3. My blog has been built with Docusaurus 2 and I have a number of rehype plugins that I use to improve the experience of the blog. These include:</p>
<ul>
<li><a href="https://johnnyreilly.com/docusaurus-improve-core-web-vitals-fetchpriority">a plugin to improve Core Web Vitals with fetchpriority / lazy loading</a></li>
<li><a href="https://johnnyreilly.com/docusaurus-image-cloudinary-rehype-plugin">a plugin to serving Docusaurus images with Cloudinary</a></li>
</ul>
<p>I wanted to migrate these plugins to Docusaurus 3. This post is about how I did that - and if you've got a rehype plugin it could probably provide some guidance on the changes you'd need to make.</p>
<p><img loading="eager" alt="title image reading &amp;quot;Migrating rehype plugins to Docusaurus 3&amp;quot; with the Docusaurus logos" src="https://johnnyreilly.com/assets/images/title-image-f54fd33f2e27f07de2f06c9b9217eeeb.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-needs-to-change">What needs to change?<a href="https://johnnyreilly.com/docusaurus-3-how-to-migrate-rehype-plugins#what-needs-to-change" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>The Docusaurus team put out a blog post on preparing for the Docusaurus 3 migration. <a href="https://docusaurus.io/blog/preparing-your-site-for-docusaurus-v3#mdx-plugins" target="_blank" rel="noopener noreferrer">Part of that post mentions MDX plugins</a>:</p>
<blockquote>
<p>All the official packages (Unified, Remark, Rehype...) in the MDX ecosystem are now <strong>ES Modules</strong> only and do not support CommonJS anymore.</p>
</blockquote>
<p>This affects how you write your plugins. It also has a bearing on how you import your plugins, given that the Docusaurus configuration file itself is still CommonJS. The post adds:</p>
<blockquote>
<p>If you created custom Remark or Rehype plugins, you may need to refactor those, or eventually rewrite them completely, due to how the new AST is structured.</p>
</blockquote>
<p>This turned out to be the case for me. I had to rewrite my plugins completely. I'll go through each of them in turn.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="migrating-the-fetchpriority-plugin">Migrating the <code>fetchpriority</code> plugin<a href="https://johnnyreilly.com/docusaurus-3-how-to-migrate-rehype-plugins#migrating-the-fetchpriority-plugin" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>The <code>fetchpriority</code> plugin is a rehype plugin that I wrote to improve the Core Web Vitals of my blog. It does this by making the first image on a page eager loaded with <code>fetchpriority="high"</code> and lazy loading all other images. The Docusaurus 2 / MDX 1 code looked like this:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">image-fetch-priority-rehype-plugin.js</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#8292a2;font-style:italic">// @ts-check</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> visit </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">require</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">'unist-util-visit'</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic">/**</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> * Create a rehype plugin that will make the first image eager loaded with fetchpriority="high" and lazy load all other images</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:#66d9ef;font-style:italic">@returns</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> rehype plugin that will make the first image eager loaded with fetchpriority="high" and lazy load all other images</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">function</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">imageFetchPriorityRehypePlugin</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic">/** </span><span class="token doc-comment comment keyword" style="color:#66d9ef;font-style:italic">@type</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">{</span><span class="token doc-comment comment class-name" style="color:#e6db74;font-style:italic">Map</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">&lt;</span><span class="token doc-comment comment class-name" style="color:#e6db74;font-style:italic">string</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">,</span><span class="token doc-comment comment class-name" style="color:#e6db74;font-style:italic"> string</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">&gt;</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">}</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> */</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> files </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">Map</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic">/** </span><span class="token doc-comment comment keyword" style="color:#66d9ef;font-style:italic">@type</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">{</span><span class="token doc-comment comment class-name keyword" style="color:#66d9ef;font-style:italic">import</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">(</span><span class="token doc-comment comment class-name string" style="color:#a6e22e;font-style:italic">'unified'</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">)</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">.</span><span class="token doc-comment comment class-name" style="color:#e6db74;font-style:italic">Transformer</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">}</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token parameter">tree</span><span class="token parameter punctuation" style="color:#f8f8f2">,</span><span class="token parameter"> vfile</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#66d9ef">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token function" style="color:#e6db74">visit</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">tree</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'element'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'jsx'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token parameter">node</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#66d9ef">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">node</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">===</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'element'</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">&amp;&amp;</span><span class="token plain"> node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'tagName'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">===</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'img'</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">// handles nodes like this:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">// {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//   type: 'element',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//   tagName: 'img',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//   properties: {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//     src: 'https://some.website.com/cat.gif',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//     alt: null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//   },</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//   ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">// }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> key </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">img|</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">vfile</span><span class="token template-string interpolation punctuation" style="color:#f8f8f2">.</span><span class="token template-string interpolation property-access">history</span><span class="token template-string interpolation punctuation" style="color:#f8f8f2">[</span><span class="token template-string interpolation number" style="color:#ae81ff">0</span><span class="token template-string interpolation punctuation" style="color:#f8f8f2">]</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> imageAlreadyProcessed </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> files</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#e6db74">get</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> fetchpriorityThisImage </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token operator" style="color:#66d9ef">!</span><span class="token plain">imageAlreadyProcessed </span><span class="token operator" style="color:#66d9ef">||</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          imageAlreadyProcessed </span><span class="token operator" style="color:#66d9ef">===</span><span class="token plain"> node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'properties'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'src'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#66d9ef">!</span><span class="token plain">imageAlreadyProcessed</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          files</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#e6db74">set</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'properties'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'src'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">fetchpriorityThisImage</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'properties'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">fetchpriority</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'high'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'properties'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">loading</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'eager'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#66d9ef">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'properties'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">loading</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'lazy'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#66d9ef">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">node</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">===</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'jsx'</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">&amp;&amp;</span><span class="token plain"> node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'value'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token operator" style="color:#66d9ef">?.</span><span class="token method function property-access" style="color:#e6db74">includes</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">'&lt;img '</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">// handles nodes like this:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">// {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//   type: 'jsx',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//   value: '&lt;img src={require("!/workspaces/blog.johnnyreilly.com/blog-website/node_modules/url-loader/dist/cjs.js?limit=10000&amp;name=assets/images/[name]-[hash].[ext]&amp;fallback=/workspaces/blog.johnnyreilly.com/blog-website/node_modules/file-loader/dist/cjs.js!./bower-with-the-long-paths.png").default} width="640" height="497" /&gt;'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">// }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">// if (!vfile.history[0].includes('blog/2023-01-15')) return;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> key </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">jsx|</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">vfile</span><span class="token template-string interpolation punctuation" style="color:#f8f8f2">.</span><span class="token template-string interpolation property-access">history</span><span class="token template-string interpolation punctuation" style="color:#f8f8f2">[</span><span class="token template-string interpolation number" style="color:#ae81ff">0</span><span class="token template-string interpolation punctuation" style="color:#f8f8f2">]</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> imageAlreadyProcessed </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> files</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#e6db74">get</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> fetchpriorityThisImage </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token operator" style="color:#66d9ef">!</span><span class="token plain">imageAlreadyProcessed </span><span class="token operator" style="color:#66d9ef">||</span><span class="token plain"> imageAlreadyProcessed </span><span class="token operator" style="color:#66d9ef">===</span><span class="token plain"> node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'value'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#66d9ef">!</span><span class="token plain">imageAlreadyProcessed</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          files</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#e6db74">set</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'value'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">fetchpriorityThisImage</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'value'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'value'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#e6db74">replace</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">&lt;img </span><span class="token regex regex-delimiter">/</span><span class="token regex regex-flags">g</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token string" style="color:#a6e22e">'&lt;img loading="eager" fetchpriority="high" '</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#66d9ef">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'value'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'value'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#e6db74">replace</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">&lt;img </span><span class="token regex regex-delimiter">/</span><span class="token regex regex-flags">g</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token string" style="color:#a6e22e">'&lt;img loading="lazy" '</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">module</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> imageFetchPriorityRehypePlugin</span><span class="token punctuation" style="color:#f8f8f2">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The new plugin looks like this:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">image-fetch-priority-rehype-plugin.mjs</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#8292a2;font-style:italic">// @ts-check</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword module" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#f8f8f2">{</span><span class="token imports"> visit </span><span class="token imports punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#66d9ef">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'unist-util-visit'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic">/**</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> * Create a rehype plugin that will make the first image eager loaded with fetchpriority="high" and lazy load all other images</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:#66d9ef;font-style:italic">@returns</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> rehype plugin that will make the first image eager loaded with fetchpriority="high" and lazy load all other images</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword module" style="color:#66d9ef">export</span><span class="token plain"> </span><span class="token keyword module" style="color:#66d9ef">default</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">function</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">imageFetchPriorityRehypePlugin</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic">/** </span><span class="token doc-comment comment keyword" style="color:#66d9ef;font-style:italic">@type</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">{</span><span class="token doc-comment comment class-name" style="color:#e6db74;font-style:italic">Map</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">&lt;</span><span class="token doc-comment comment class-name" style="color:#e6db74;font-style:italic">string</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">,</span><span class="token doc-comment comment class-name" style="color:#e6db74;font-style:italic"> string</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">&gt;</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">}</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> */</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> files </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">Map</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic">/** </span><span class="token doc-comment comment keyword" style="color:#66d9ef;font-style:italic">@type</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">{</span><span class="token doc-comment comment class-name keyword" style="color:#66d9ef;font-style:italic">import</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">(</span><span class="token doc-comment comment class-name string" style="color:#a6e22e;font-style:italic">'unified'</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">)</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">.</span><span class="token doc-comment comment class-name" style="color:#e6db74;font-style:italic">Transformer</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">}</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token parameter">tree</span><span class="token parameter punctuation" style="color:#f8f8f2">,</span><span class="token parameter"> vfile</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#66d9ef">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token function" style="color:#e6db74">visit</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">tree</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'mdxJsxTextElement'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token parameter">node</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#66d9ef">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">node</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">===</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'mdxJsxTextElement'</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">&amp;&amp;</span><span class="token plain"> node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'name'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">===</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'img'</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">// handles nodes like this:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">// {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//   type: 'mdxJsxTextElement',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//   name: 'img',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//   attributes: [</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//     {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//       type: 'mdxJsxAttribute',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//       name: 'alt',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//       value: 'title image reading &amp;quot;Azure Container Apps, Bicep, managed certificates and custom domains&amp;quot; with the Azure Container App logos'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//     },</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//     {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//       type: 'mdxJsxAttribute',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//       name: 'src',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//       value: {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//         type: 'mdxJsxAttributeValueExpression',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//         value: 'require("!/home/john/code/github/blog.johnnyreilly.com/blog-website/node_modules/url-loader/dist/cjs.js?limit=10000&amp;name=assets/images/[name]-[contenthash].[ext]&amp;fallback=/home/john/code/github/blog.johnnyreilly.com/blog-website/node_modules/file-loader/dist/cjs.js!./screenshot-azure-portal-bring-your-own-certificates.webp").default',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//         data: [Object]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//       }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//     },</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//     { type: 'mdxJsxAttribute', name: 'width', value: '800' },</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//     { type: 'mdxJsxAttribute', name: 'height', value: '450' }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//   ],</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//   children: []</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">// }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> srcIndex </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'attributes'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#e6db74">findIndex</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token parameter">attr</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#66d9ef">=&gt;</span><span class="token plain"> attr</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">name</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">===</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'src'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> requireString </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'attributes'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">srcIndex</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">value</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">value</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> key </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">jsx|</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">vfile</span><span class="token template-string interpolation punctuation" style="color:#f8f8f2">.</span><span class="token template-string interpolation property-access">history</span><span class="token template-string interpolation punctuation" style="color:#f8f8f2">[</span><span class="token template-string interpolation number" style="color:#ae81ff">0</span><span class="token template-string interpolation punctuation" style="color:#f8f8f2">]</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> imageAlreadyProcessed </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> files</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#e6db74">get</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> fetchpriorityThisImage </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token operator" style="color:#66d9ef">!</span><span class="token plain">imageAlreadyProcessed </span><span class="token operator" style="color:#66d9ef">||</span><span class="token plain"> imageAlreadyProcessed </span><span class="token operator" style="color:#66d9ef">===</span><span class="token plain"> requireString</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#66d9ef">!</span><span class="token plain">imageAlreadyProcessed</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          files</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#e6db74">set</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> requireString</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">// expect to be -1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> loadingIndex </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'attributes'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#e6db74">findIndex</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token parameter">attr</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#66d9ef">=&gt;</span><span class="token plain"> attr</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">name</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">===</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'loading'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">fetchpriorityThisImage</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token comment" style="color:#8292a2;font-style:italic">// expect to be -1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> fetchpriorityIndex </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'attributes'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#e6db74">findIndex</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token parameter">attr</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#66d9ef">=&gt;</span><span class="token plain"> attr</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">name</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">===</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'fetchpriority'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token keyword control-flow" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">loadingIndex </span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">-</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'attributes'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">loadingIndex</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">value</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'eager'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#66d9ef">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'attributes'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#e6db74">push</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">              </span><span class="token literal-property property" style="color:#f92672">type</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'mdxJsxAttribute'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">              </span><span class="token literal-property property" style="color:#f92672">name</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'loading'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">              </span><span class="token literal-property property" style="color:#f92672">value</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'eager'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token keyword control-flow" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">fetchpriorityIndex </span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">-</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'attributes'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">fetchpriorityIndex</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">value</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'high'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#66d9ef">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'attributes'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#e6db74">push</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">              </span><span class="token literal-property property" style="color:#f92672">type</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'mdxJsxAttribute'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">              </span><span class="token literal-property property" style="color:#f92672">name</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'fetchpriority'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">              </span><span class="token literal-property property" style="color:#f92672">value</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'high'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#66d9ef">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token keyword control-flow" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">loadingIndex </span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">-</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'attributes'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">loadingIndex</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">value</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'lazy'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#66d9ef">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'attributes'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#e6db74">push</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">              </span><span class="token literal-property property" style="color:#f92672">type</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'mdxJsxAttribute'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">              </span><span class="token literal-property property" style="color:#f92672">name</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'loading'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">              </span><span class="token literal-property property" style="color:#f92672">value</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'lazy'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>What's different? Well, a number of things; let's go through them.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="commonjs-to-es-module">CommonJS to ES Module<a href="https://johnnyreilly.com/docusaurus-3-how-to-migrate-rehype-plugins#commonjs-to-es-module" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>You'll note the old plugin has the name <code>image-fetch-priority-rehype-plugin.js</code> and the new plugin has the name <code>image-fetch-priority-rehype-plugin.mjs</code>. This is because the new plugin is an ES Module and the old plugin is CommonJS.</p>
<p>Further to that, the old plugin used <code>module.exports = imageFetchPriorityRehypePlugin</code> to expose functionality and the new plugin uses <code>export default imageFetchPriorityRehypePlugin</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="different-ast">Different AST<a href="https://johnnyreilly.com/docusaurus-3-how-to-migrate-rehype-plugins#different-ast" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>The abstract syntax tree (AST) is different. MDX 1 and MDX 3 make different ASTs and we must migrate to the new one. Interestingly, it seems to be slightly simpler in some ways. MDX 1 surfaced both <code>element</code> / <code>img</code> nodes and <code>jsx</code> nodes. By contrast, MDX 3 appears to surface just <code>mdxJsxTextElement</code> which are similar to MDX 1's <code>jsx</code> nodes, but come with their own AST representation of expression based attributes in the <code>data</code> property.</p>
<p>The logic of the new plugin is similar to the old plugin, but the code is different to cater for the different AST.</p>
<p>And that's it - we have a new <code>fetchpriority</code> plugin that works with Docusaurus 3 and MDX 3!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="migrating-the-cloudinary-plugin">Migrating the <code>cloudinary</code> plugin<a href="https://johnnyreilly.com/docusaurus-3-how-to-migrate-rehype-plugins#migrating-the-cloudinary-plugin" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Firstly, let's remind ourselves what the <code>cloudinary</code> plugin does. It takes an image URL and transforms it into a Cloudinary URL. So like this:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic">https://my.website.com/cat.gif</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">https://res.cloudinary.com/demo/image/fetch/https://my.website.com/cat.gif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And at runtime, Cloudinary's <a href="https://cloudinary.com/documentation/fetch_remote_images#fetch_and_deliver_remote_files" target="_blank" rel="noopener noreferrer">Fetch mechanism</a> will handle transforming the image into a format that is optimised for the browser that is requesting it.</p>
<p>It turns out that the <code>fetchpriority</code> plugin is a much more straightforward migration than the <code>cloudinary</code> plugin. And the reason for that is related to the aforementioned AST changes. Let's start with the old plugin:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">cloudinary-rehype-plugin.js</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#8292a2;font-style:italic">//@ts-check</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> visit </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">require</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">'unist-util-visit'</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic">/**</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> * Create a rehype plugin that will replace image URLs with Cloudinary URLs</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:#66d9ef;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">{</span><span class="token doc-comment comment class-name operator" style="color:#66d9ef;font-style:italic">*</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">}</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> </span><span class="token doc-comment comment parameter" style="color:#8292a2;font-style:italic">options</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> cloudName your Cloudinary‚Äôs cloud name eg demo, baseUrl the base URL of your website eg https://johnnyreilly.com - should not include a trailing slash, will likely be the same as the config.url in your docusaurus.config.js</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:#66d9ef;font-style:italic">@returns</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> rehype plugin that will replace image URLs with Cloudinary URLs</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">function</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">imageCloudinaryRehypePlugin</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic">/** </span><span class="token doc-comment comment keyword" style="color:#66d9ef;font-style:italic">@type</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">{</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">{</span><span class="token doc-comment comment class-name" style="color:#e6db74;font-style:italic"> cloudName</span><span class="token doc-comment comment class-name operator" style="color:#66d9ef;font-style:italic">:</span><span class="token doc-comment comment class-name" style="color:#e6db74;font-style:italic"> string</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">;</span><span class="token doc-comment comment class-name" style="color:#e6db74;font-style:italic"> baseUrl</span><span class="token doc-comment comment class-name operator" style="color:#66d9ef;font-style:italic">:</span><span class="token doc-comment comment class-name" style="color:#e6db74;font-style:italic"> string </span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">}</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">}</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> */</span><span class="token plain"> options</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> cloudName</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> baseUrl </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> options</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> srcRegex </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex"> src={</span><span class="token regex regex-source language-regex group punctuation" style="color:#f8f8f2">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:#e6db74">.</span><span class="token regex regex-source language-regex quantifier number" style="color:#ae81ff">*</span><span class="token regex regex-source language-regex group punctuation" style="color:#f8f8f2">)</span><span class="token regex regex-source language-regex">}</span><span class="token regex regex-delimiter">/</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic">/** </span><span class="token doc-comment comment keyword" style="color:#66d9ef;font-style:italic">@type</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">{</span><span class="token doc-comment comment class-name keyword" style="color:#66d9ef;font-style:italic">import</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">(</span><span class="token doc-comment comment class-name string" style="color:#a6e22e;font-style:italic">'unified'</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">)</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">.</span><span class="token doc-comment comment class-name" style="color:#e6db74;font-style:italic">Plugin</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">&lt;</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">[</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">]</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">,</span><span class="token doc-comment comment class-name" style="color:#e6db74;font-style:italic"> </span><span class="token doc-comment comment class-name keyword" style="color:#66d9ef;font-style:italic">import</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">(</span><span class="token doc-comment comment class-name string" style="color:#a6e22e;font-style:italic">'hast'</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">)</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">.</span><span class="token doc-comment comment class-name" style="color:#e6db74;font-style:italic">Root</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">&gt;</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">}</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token parameter">tree</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#66d9ef">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token function" style="color:#e6db74">visit</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">tree</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'element'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'jsx'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token parameter">node</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#66d9ef">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">node</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">===</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'element'</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">&amp;&amp;</span><span class="token plain"> node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'tagName'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">===</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'img'</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">// handles nodes like this:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">// {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//   type: 'element',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//   tagName: 'img',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//   properties: {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//     src: 'https://some.website.com/cat.gif',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//     alt: null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//   },</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//   ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">// }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> url </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'properties'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">src</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token string" style="color:#a6e22e">'properties'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">src</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">https://res.cloudinary.com/</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">cloudName</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string string" style="color:#a6e22e">/image/fetch/</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">url</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#66d9ef">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">node</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">===</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'jsx'</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">&amp;&amp;</span><span class="token plain"> node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'value'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token operator" style="color:#66d9ef">?.</span><span class="token method function property-access" style="color:#e6db74">includes</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">'&lt;img '</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">// handles nodes like this:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">// {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//   type: 'jsx',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//   value: '&lt;img src={require("!/workspaces/blog.johnnyreilly.com/blog-website/node_modules/url-loader/dist/cjs.js?limit=10000&amp;name=assets/images/[name]-[hash].[ext]&amp;fallback=/workspaces/blog.johnnyreilly.com/blog-website/node_modules/file-loader/dist/cjs.js!./bower-with-the-long-paths.png").default} width="640" height="497" /&gt;'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">// }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> match </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'value'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#e6db74">match</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">srcRegex</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">match</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> urlOrRequire </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> match</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'value'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> node</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'value'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#e6db74">replace</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            srcRegex</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e"> src={</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string interpolation template-string string" style="color:#a6e22e">\`https://res.cloudinary.com/</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation template-string interpolation">cloudName</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string interpolation template-string string" style="color:#a6e22e">/image/fetch/</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation template-string interpolation">baseUrl</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string interpolation template-string string" style="color:#a6e22e">\$\{</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation template-string interpolation">urlOrRequire</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string interpolation template-string string" style="color:#a6e22e">\}\`</span><span class="token template-string interpolation template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string string" style="color:#a6e22e">}</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">module</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> imageCloudinaryRehypePlugin</span><span class="token punctuation" style="color:#f8f8f2">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The old plugin had two kinds of nodes it had to deal with, <code>element</code> and <code>jsx</code>. The new plugin will have to deal with just one kind of node, <code>mdxJsxTextElement</code>. (Just the same as with the <code>fetchpriority</code> plugin.)</p>
<p>Now you may have noticed that the JSX node in the old plugin has a slightly more complex <code>src</code> attribute:</p>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token tag punctuation" style="color:#f8f8f2">&lt;</span><span class="token tag" style="color:#f92672">img</span><span class="token tag" style="color:#f92672"> </span><span class="token tag attr-name" style="color:#a6e22e !important">src</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#f8f8f2">=</span><span class="token tag script language-javascript punctuation" style="color:#f8f8f2">{</span><span class="token tag script language-javascript function" style="color:#e6db74">require</span><span class="token tag script language-javascript punctuation" style="color:#f8f8f2">(</span><span class="token tag script language-javascript string" style="color:#a6e22e">"!/workspaces/blog.johnnyreilly.com/blog-website/node_modules/url-loader/dist/cjs.js?limit=10000&amp;name=assets/images/[name]-[hash].[ext]&amp;fallback=/workspaces/blog.johnnyreilly.com/blog-website/node_modules/file-loader/dist/cjs.js!./bower-with-the-long-paths.png"</span><span class="token tag script language-javascript punctuation" style="color:#f8f8f2">)</span><span class="token tag script language-javascript punctuation" style="color:#f8f8f2">.</span><span class="token tag script language-javascript keyword module" style="color:#66d9ef">default</span><span class="token tag script language-javascript punctuation" style="color:#f8f8f2">}</span><span class="token tag" style="color:#f92672"> </span><span class="token tag attr-name" style="color:#a6e22e !important">width</span><span class="token tag attr-value punctuation attr-equals" style="color:#f8f8f2">=</span><span class="token tag attr-value punctuation" style="color:#f8f8f2">"</span><span class="token tag attr-value" style="color:#f92672">640</span><span class="token tag attr-value punctuation" style="color:#f8f8f2">"</span><span class="token tag" style="color:#f92672"> </span><span class="token tag attr-name" style="color:#a6e22e !important">height</span><span class="token tag attr-value punctuation attr-equals" style="color:#f8f8f2">=</span><span class="token tag attr-value punctuation" style="color:#f8f8f2">"</span><span class="token tag attr-value" style="color:#f92672">497</span><span class="token tag attr-value punctuation" style="color:#f8f8f2">"</span><span class="token tag" style="color:#f92672"> </span><span class="token tag punctuation" style="color:#f8f8f2">/&gt;</span><span class="token plain">`</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>That <code>src</code> attribute is a JavaScript expression. It's not a string. It's a JavaScript expression that will be evaluated later by webpack, and will return the path to the image in the final (webpack-based) Docusaurus build.</p>
<p>So transformation into a Cloudinary URL for JSX nodes is a little tougher. In the MDX 1 plugin, we needed to wrap the <code>require</code> expression in backticks and prefix it with <code>https://res.cloudinary.com/${cloudName}/image/fetch/${baseUrl}</code> where <code>${baseUrl}</code> is the base URL of our website. We also need to prefix the expression with a <code>$</code> to indicate that it's a JavaScript expression. Tough to read but it works.</p>
<p>Rereading that paragraph, I realise it's hard to understand. Perhaps easier to see it in action. Here's what we want our plugin to do to the JSX node above:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic">require("!/home/john/code/github/blog.johnnyreilly.com/blog-website/node_modules/url-loader/dist/cjs.js?limit=10000&amp;name=assets/images/[name]-[contenthash].[ext]&amp;fallback=/home/john/code/github/blog.johnnyreilly.com/blog-website/node_modules/file-loader/dist/cjs.js!./screenshot-azure-portal-bring-your-own-certificates.webp").default</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">`https://res.cloudinary.com/demo/image/fetch/f_auto,q_auto,w_auto,dpr_auto/https://johnnyreilly.com${require("!/home/john/code/github/blog.johnnyreilly.com/blog-website/node_modules/url-loader/dist/cjs.js?limit=10000&amp;name=assets/images/[name]-[contenthash].[ext]&amp;fallback=/home/john/code/github/blog.johnnyreilly.com/blog-website/node_modules/file-loader/dist/cjs.js!./screenshot-azure-portal-bring-your-own-certificates.webp").default}`</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It turns out it's even tougher doing this with MDX 3 as compared to MDX 1. This is because MDX 3's AST includes all kinds of metadata around the <code>mdxJsxAttributeValueExpression</code>:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token literal-property property" style="color:#f92672">type</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'mdxJsxAttribute'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token literal-property property" style="color:#f92672">name</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'src'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token literal-property property" style="color:#f92672">value</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token literal-property property" style="color:#f92672">type</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'mdxJsxAttributeValueExpression'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token literal-property property" style="color:#f92672">value</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'require("!/home/john/code/github/blog.johnnyreilly.com/blog-website/node_modules/url-loader/dist/cjs.js?limit=10000&amp;name=assets/images/[name]-[contenthash].[ext]&amp;fallback=/home/john/code/github/blog.johnnyreilly.com/blog-website/node_modules/file-loader/dist/cjs.js!./screenshot-azure-portal-bring-your-own-certificates.webp").default'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token literal-property property" style="color:#f92672">data</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token known-class-name class-name" style="color:#e6db74">Object</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// &lt;--- There's a lot of metadata in here!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>data</code> object above is a full on AST representation of the <code>require</code> expression. And to make a plugin that works with MDX 3, we need to use that AST representation to build up the new <code>src</code> attribute. This involves some string manipulation and some AST traversal. It's not pretty but it works.</p>
<p>Here's the new plugin:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">cloudinary-rehype-plugin.mjs</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#8292a2;font-style:italic">//@ts-check</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword module" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#f8f8f2">{</span><span class="token imports"> visit </span><span class="token imports punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#66d9ef">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'unist-util-visit'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword module" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token imports operator" style="color:#66d9ef">*</span><span class="token imports"> </span><span class="token imports keyword module" style="color:#66d9ef">as</span><span class="token imports"> acorn</span><span class="token plain"> </span><span class="token keyword module" style="color:#66d9ef">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'acorn'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword module" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#f8f8f2">{</span><span class="token imports"> mdxJsx </span><span class="token imports punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#66d9ef">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'micromark-extension-mdx-jsx'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword module" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#f8f8f2">{</span><span class="token imports"> fromMarkdown </span><span class="token imports punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#66d9ef">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'mdast-util-from-markdown'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword module" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#f8f8f2">{</span><span class="token imports"> mdxJsxFromMarkdown</span><span class="token imports punctuation" style="color:#f8f8f2">,</span><span class="token imports"> mdxJsxToMarkdown </span><span class="token imports punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#66d9ef">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'mdast-util-mdx-jsx'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword module" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#f8f8f2">{</span><span class="token imports"> toMarkdown </span><span class="token imports punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#66d9ef">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'mdast-util-to-markdown'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic">/**</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:#66d9ef;font-style:italic">@typedef</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">{</span><span class="token doc-comment comment class-name" style="color:#e6db74;font-style:italic">object</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">}</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> </span><span class="token doc-comment comment class-name" style="color:#e6db74;font-style:italic">Params</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> a label and an href</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:#66d9ef;font-style:italic">@property</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">{</span><span class="token doc-comment comment class-name" style="color:#e6db74;font-style:italic">string</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">}</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> </span><span class="token doc-comment comment parameter" style="color:#8292a2;font-style:italic">cloudName</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> your Cloudinary‚Äôs cloud name eg demo</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:#66d9ef;font-style:italic">@property</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">{</span><span class="token doc-comment comment class-name" style="color:#e6db74;font-style:italic">string</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">}</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> </span><span class="token doc-comment comment parameter" style="color:#8292a2;font-style:italic">baseUrl</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> the base URL of your website eg https://johnnyreilly.com - should not include a trailing slash, will likely be the same as the config.url in your docusaurus.config.js</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic">/**</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> * Create a rehype plugin that will replace image URLs with Cloudinary URLs</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:#66d9ef;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">{</span><span class="token doc-comment comment class-name" style="color:#e6db74;font-style:italic">Params</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">}</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> </span><span class="token doc-comment comment parameter" style="color:#8292a2;font-style:italic">params</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:#66d9ef;font-style:italic">@returns</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> rehype plugin that will replace image URLs with Cloudinary URLs</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword module" style="color:#66d9ef">export</span><span class="token plain"> </span><span class="token keyword module" style="color:#66d9ef">default</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">function</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">imageCloudinaryRehypePlugin</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token parameter punctuation" style="color:#f8f8f2">{</span><span class="token parameter"> cloudName</span><span class="token parameter punctuation" style="color:#f8f8f2">,</span><span class="token parameter"> baseUrl </span><span class="token parameter punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> imageCloudinaryRehypeVisitor </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">imageCloudinaryRehypeVisitor</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    cloudName</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    baseUrl</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token parameter">tree</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#66d9ef">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#8292a2;font-style:italic">// eslint-disable-next-line @typescript-eslint/no-unsafe-call</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token function" style="color:#e6db74">visit</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">tree</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'mdxJsxTextElement'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> imageCloudinaryRehypeVisitor</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic">/**</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> * Create a rehype visitor that will replace image URLs with Cloudinary URLs - exposed for testing purposes</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:#66d9ef;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">{</span><span class="token doc-comment comment class-name" style="color:#e6db74;font-style:italic">Params</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">}</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> </span><span class="token doc-comment comment parameter" style="color:#8292a2;font-style:italic">params</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:#66d9ef;font-style:italic">@returns</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> rehype plugin that will replace image URLs with Cloudinary URLs</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword module" style="color:#66d9ef">export</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">function</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">imageCloudinaryRehypeVisitor</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token parameter punctuation" style="color:#f8f8f2">{</span><span class="token parameter"> cloudName</span><span class="token parameter punctuation" style="color:#f8f8f2">,</span><span class="token parameter"> baseUrl </span><span class="token parameter punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> srcRegex </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex"> src=</span><span class="token regex regex-source language-regex special-escape escape">\{</span><span class="token regex regex-source language-regex group punctuation" style="color:#f8f8f2">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:#e6db74">.</span><span class="token regex regex-source language-regex quantifier number" style="color:#ae81ff">*</span><span class="token regex regex-source language-regex group punctuation" style="color:#f8f8f2">)</span><span class="token regex regex-source language-regex special-escape escape">\}</span><span class="token regex regex-delimiter">/</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">function</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">imageCloudinaryRehypeVisitor</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token parameter">node</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> imgWithAttributes </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> node</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      imgWithAttributes</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">===</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'mdxJsxTextElement'</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">&amp;&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      imgWithAttributes</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">name</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">===</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'img'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">// handles nodes like this:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">// {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">//   type: 'mdxJsxTextElement',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">//   name: 'img',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">//   attributes: [</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">//     {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">//       type: 'mdxJsxAttribute',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">//       name: 'alt',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">//       value: 'title image reading &amp;quot;Azure Container Apps, Bicep, managed certificates and custom domains&amp;quot; with the Azure Container App logos'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">//     },</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">//     {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">//       type: 'mdxJsxAttribute',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">//       name: 'src',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">//       value: {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">//         type: 'mdxJsxAttributeValueExpression',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">//         value: 'require("!/home/john/code/github/blog.johnnyreilly.com/blog-website/node_modules/url-loader/dist/cjs.js?limit=10000&amp;name=assets/images/[name]-[contenthash].[ext]&amp;fallback=/home/john/code/github/blog.johnnyreilly.com/blog-website/node_modules/file-loader/dist/cjs.js!./screenshot-azure-portal-bring-your-own-certificates.webp").default',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">//         data: [Object]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">//       }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">//     },</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">//     { type: 'mdxJsxAttribute', name: 'width', value: '800' },</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">//     { type: 'mdxJsxAttribute', name: 'height', value: '450' }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">//   ],</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">//   children: []</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">// }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> srcIndex </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> imgWithAttributes</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">attributes</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#e6db74">findIndex</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token parameter">attr</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#66d9ef">=&gt;</span><span class="token plain"> attr</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">name</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">===</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'src'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> requireAttribute </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> imgWithAttributes</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">attributes</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">srcIndex</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">value</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">typeof</span><span class="token plain"> requireAttribute </span><span class="token operator" style="color:#66d9ef">!==</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'string'</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> asMarkdown </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">toMarkdown</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">imgWithAttributes</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token literal-property property" style="color:#f92672">extensions</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token function" style="color:#e6db74">mdxJsxToMarkdown</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">// &lt;img</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//    alt="screenshot of typescript playground saying &amp;#39;ComponentThatReturnsANumber&amp;#39; cannot be used as a JSX component. Its return type &amp;#39;number&amp;#39; is not a valid JSX element.(2786)"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//    src={require("!/home/john/code/github/blog.johnnyreilly.com/blog-website/node_modules/url-loader/dist/cjs.js?limit=10000&amp;name=assets/images/[name]-[contenthash].[ext]&amp;fallback=/home/john/code/github/blog.johnnyreilly.com/blog-website/node_modules/file-loader/dist/cjs.js!./screenshot-typescript-playground.png").default}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//    width="690" height="298" /&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> match </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> asMarkdown</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#e6db74">match</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">srcRegex</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">match</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> urlOrRequire </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> match</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> cloudinaryRequireString </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">\`https://res.cloudinary.com/</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">cloudName</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string string" style="color:#a6e22e">/image/fetch/f_auto,q_auto,w_auto,dpr_auto/</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">baseUrl</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string string" style="color:#a6e22e">\$\{</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">urlOrRequire</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string string" style="color:#a6e22e">\}\`</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> newMarkdown </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> asMarkdown</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#e6db74">replace</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            srcRegex</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e"> src={</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">cloudinaryRequireString</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string string" style="color:#a6e22e">}</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token comment" style="color:#8292a2;font-style:italic">// &lt;img</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token comment" style="color:#8292a2;font-style:italic">//    alt="screenshot of typescript playground saying &amp;#39;ComponentThatReturnsANumber&amp;#39; cannot be used as a JSX component. Its return type &amp;#39;number&amp;#39; is not a valid JSX element.(2786)"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token comment" style="color:#8292a2;font-style:italic">//    src={`https://res.cloudinary.com/priou/image/fetch/f_auto,q_auto,w_auto,dpr_auto/https://johnnyreilly.com${require("!/home/john/code/github/blog.johnnyreilly.com/blog-website/node_modules/url-loader/dist/cjs.js?limit=10000&amp;name=assets/images/[name]-[contenthash].[ext]&amp;fallback=/home/john/code/github/blog.johnnyreilly.com/blog-website/node_modules/file-loader/dist/cjs.js!./screenshot-typescript-playground.png").default}`}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token comment" style="color:#8292a2;font-style:italic">//    width="690" height="298" /&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> tree </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">fromMarkdown</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">newMarkdown</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token literal-property property" style="color:#f92672">extensions</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token function" style="color:#e6db74">mdxJsx</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> acorn</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token literal-property property" style="color:#f92672">addResult</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token boolean" style="color:#ae81ff">true</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token literal-property property" style="color:#f92672">mdastExtensions</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token function" style="color:#e6db74">mdxJsxFromMarkdown</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> newSrcAttributeIndex </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> tree</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">children</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'attributes'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#e6db74">findIndex</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token parameter">attr</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#66d9ef">=&gt;</span><span class="token plain"> attr</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">name</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">===</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'src'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token keyword control-flow" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">newSrcAttributeIndex </span><span class="token operator" style="color:#66d9ef">!==</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">-</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            imgWithAttributes</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">attributes</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">srcIndex</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">              tree</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">children</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'attributes'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">newSrcAttributeIndex</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Much is happening here. Let's go through it.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="commonjs-to-es-module-1">CommonJS to ES Module<a href="https://johnnyreilly.com/docusaurus-3-how-to-migrate-rehype-plugins#commonjs-to-es-module-1" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>This amounts to the same changes as the <code>fetchpriority</code> plugin. The old plugin has the name <code>cloudinary-rehype-plugin.js</code> and the new plugin has the name <code>cloudinary-rehype-plugin.mjs</code>. This is because the new plugin is an ES Module and the old plugin is CommonJS. Related to this, the old plugin used <code>module.exports = imageCloudinaryRehypePlugin</code> to expose functionality and the new plugin uses <code>export default imageCloudinaryRehypePlugin</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="different-ast-1">Different AST<a href="https://johnnyreilly.com/docusaurus-3-how-to-migrate-rehype-plugins#different-ast-1" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>We're dealing with a different AST and just need to tackle the <code>mdxJsxTextElement</code> which are similar to MDX 1's <code>jsx</code> nodes, but come with their own AST representation of expression based attributes in the <code>data</code> property.</p>
<p>The hardest part of this (and it is hard / confusing) is dealing with the <code>require</code> expression in the <code>src</code> attribute. What we do is:</p>
<ol>
<li>Convert the <code>mdxJsxTextElement</code> to back to markdown - this is the full <code>img</code> element in its AST form</li>
<li>Use a regex to find the <code>require</code> expression in the <code>src</code> attribute of the markdown</li>
<li>Transform the <code>require</code> expression to a Cloudinary URL using the same mechanism as with the MDX 1 plugin</li>
<li>Convert the markdown back to an <code>mdxJsxTextElement</code> using a technique adapted from <a href="https://github.com/syntax-tree/mdast-util-mdx-jsx#use" target="_blank" rel="noopener noreferrer"><code>mdast-util-mdx-jsx</code></a></li>
<li>Replace the <code>src</code> attribute with the new <code>src</code> attribute including the updated <code>require</code> expression AST in the <code>mdxJsxAttributeValueExpression</code> attributes <code>data</code> property.</li>
</ol>
<p>If you were to compare the MDX 1 plugin with the MDX 3 plugin, 2 and 3 from the above points are the same. Points 1, 4 and 5 are new.</p>
<p>With this in place we have a new plugin that works with Docusaurus 3 and MDX 3!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="rehype-cloudinary-docusaurus2"><code>rehype-cloudinary-docusaurus@2</code><a href="https://johnnyreilly.com/docusaurus-3-how-to-migrate-rehype-plugins#rehype-cloudinary-docusaurus2" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>You may recall that I published an npm package named <a href="https://www.npmjs.com/package/rehype-cloudinary-docusaurus" target="_blank" rel="noopener noreferrer"><code>rehype-cloudinary-docusaurus</code></a> which packages up the plugin to make it easy for people to use. I've updated that package to use the new plugin and it is available now. You can see the <a href="https://github.com/johnnyreilly/rehype-cloudinary-docusaurus/pull/9" target="_blank" rel="noopener noreferrer">pull request here</a>. The new version is <code>3.0.0</code>.</p>]]></content:encoded>
            <category>docusaurus</category>
        </item>
        <item>
            <title><![CDATA[Azure Container Apps, Easy Auth and .NET authentication]]></title>
            <link>https://johnnyreilly.com/azure-container-apps-easy-auth-and-dotnet-authentication</link>
            <guid>https://johnnyreilly.com/azure-container-apps-easy-auth-and-dotnet-authentication</guid>
            <pubDate>Tue, 28 Nov 2023 05:15:10 GMT</pubDate>
            <description><![CDATA[Azure Container Apps support Easy Auth. However, .NET applications run in ACAs do not recognise Easy Auth authentication. This post explains the issue and solves it.]]></description>
            <content:encoded><![CDATA[<p>Easy Auth is a great way to authenticate your users. However, when used in the context of Azure Container Apps, .NET applications do not, by default, recognise that Easy Auth is in place. You might be authenticated but .NET will still act as if you aren't. <code>builder.Services.AddAuthentication()</code> and <code>app.UseAuthentication()</code> doesn't change that. This post explains the issue and solves it through the implementation of an <code>AuthenticationHandler</code>.</p>
<p><img loading="eager" alt="title image reading &amp;quot;Azure Container Apps, Easy Auth and .NET authentication&amp;quot; with the Azure Container App logos" src="https://johnnyreilly.com/assets/images/title-image-facfbcdb151b42a982caa55673771963.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<p>If you're looking for information about Easy Auth and roles with .NET and Azure App Service, you can find it here:</p>
<ul>
<li><a href="https://johnnyreilly.com/azure-easy-auth-and-roles-with-dotnet-and-core">Azure App Service, Easy Auth and Roles with .NET</a></li>
<li><a href="https://johnnyreilly.com/azure-easy-auth-and-roles-with-net-and-microsoft-identity-web">Azure App Service, Easy Auth and Roles with .NET and Microsoft.Identity.Web</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="useridentityisauthenticated--false"><code>User.Identity.IsAuthenticated == false</code><a href="https://johnnyreilly.com/azure-container-apps-easy-auth-and-dotnet-authentication#useridentityisauthenticated--false" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>When I'm building an application, I want to focus on the problem I'm solving. I don't want to think about how to implement my own authentication system. Rather, I lean on an auth provider for that, and if I'm working in the Azure ecosystem, that often means Easy Auth, usually with Azure AD.</p>
<p>I recently started building a .NET application using Easy Auth and deploying to Azure Container Apps. One thing that surprised me when I tested it out was that, whilst I was being authenticated, my app didn't seem to be aware of it. When I inspected the <code>User.Identity.IsAuthenticated</code> property in my application, it was <code>false</code>. The reason why lies <a href="https://learn.microsoft.com/en-us/azure/container-apps/authentication#access-user-claims-in-application-code" target="_blank" rel="noopener noreferrer">in the documentation</a>:</p>
<blockquote>
<p>For all language frameworks, Container Apps makes the claims in the incoming token available to your application code. The claims are injected into the request headers, which are present whether from an authenticated end user or a client application. External requests aren't allowed to set these headers, so they're present only if set by Container Apps. Some example headers include:</p>
<p><code>X-MS-CLIENT-PRINCIPAL-NAME</code></p>
<p><code>X-MS-CLIENT-PRINCIPAL-ID</code></p>
<p><em>Code that is written in any language or framework can get the information that it needs from these headers.</em></p>
</blockquote>
<p>The emphasis above is mine. What it's saying here is this: <strong>you need to implement this yourself</strong>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="easy-auth-azure-container-app-headers">Easy Auth Azure Container App headers<a href="https://johnnyreilly.com/azure-container-apps-easy-auth-and-dotnet-authentication#easy-auth-azure-container-app-headers" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Sure enough, when I inspected the headers in my application, I could see these:</p>
<p><img loading="lazy" alt="screenshot of easy auth headers including X-MS-CLIENT-PRINCIPAL-NAME, X-MS-CLIENT-PRINCIPAL-ID, X-MS-CLIENT-PRINCIPAL-IDPandX-MS-CLIENT-PRINCIPAL`" src="https://johnnyreilly.com/assets/images/screenshot-easy-auth-headers-b826a8617eaecc9b499e2d07251c87a9.webp" width="692" height="864" class="img_ev3q"></p>
<p>The <code>X-MS-CLIENT-PRINCIPAL</code> header is particularly interesting. From the appearance, you might assume it's a <a href="https://jwt.io/" target="_blank" rel="noopener noreferrer">JWT</a>. It's not. It's actually a base 64 encoded JSON string that represents the signed in user and their claims. It's actually super easy to decode in your browser devtools:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token known-class-name class-name" style="color:#e6db74">JSON</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#e6db74">parse</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token function" style="color:#e6db74">atob</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">xMsClientPrincipal</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you decode it, you'll see something like this:</p>
<p><img loading="lazy" alt="a screenshot of the decoded object" src="https://johnnyreilly.com/assets/images/screenshot-decoded-x-ms-client-principal-header-428b02c5b788925da639d5f50b5fc560.png" width="1196" height="974" class="img_ev3q"></p>
<p>Given that this information is present, what we can do is tell .NET about it.</p>
<p>But before we do that, let's pause to talk about a current limitation with Easy Auth on Azure Container Apps; JWT support.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="lack-of-jwt--token-support">Lack of JWT / Token support<a href="https://johnnyreilly.com/azure-container-apps-easy-auth-and-dotnet-authentication#lack-of-jwt--token-support" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>The problem is, there's not JWT token that we can make use of in the headers of an Azure Container App. This is supported in <a href="https://learn.microsoft.com/en-us/azure/app-service/overview-authentication-authorization#token-store" target="_blank" rel="noopener noreferrer">App Service which has a token store</a> and supports the <a href="https://learn.microsoft.com/en-us/azure/app-service/configure-authentication-oauth-tokens#retrieve-tokens-in-app-code" target="_blank" rel="noopener noreferrer">following headers</a>:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">X-MS-TOKEN-AAD-ID-TOKEN</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">X-MS-TOKEN-AAD-ACCESS-TOKEN</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">X-MS-TOKEN-AAD-EXPIRES-ON</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">X-MS-TOKEN-AAD-REFRESH-TOKEN</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If there was a populated <code>X-MS-TOKEN-AAD-ACCESS-TOKEN</code> then it would unlock all manner of possibilities. Let's say I want to make use of the Graph API on behalf of my logged in user. I cannot.</p>
<p>Reading <a href="https://learn.microsoft.com/en-us/graph/sdks/choose-authentication-providers?tabs=csharp#on-behalf-of-provider" target="_blank" rel="noopener noreferrer">the docs</a> I believe I should be trying to use the "on behalf of" approach:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> scopes </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"https://graph.microsoft.com/.default"</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">// Multi-tenant apps can use "common",</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">// single-tenant apps must use the tenant ID from the Azure portal</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> tenantId </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"common"</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">// Values from app registration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> clientId </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"YOUR_CLIENT_ID"</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> clientSecret </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"YOUR_CLIENT_SECRET"</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">// using Azure.Identity;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> options </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">OnBehalfOfCredentialOptions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    AuthorityHost </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> AzureAuthorityHosts</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">AzurePublicCloud</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">// This is the incoming token to exchange using on-behalf-of flow</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> oboToken </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"JWT_TOKEN_TO_EXCHANGE"</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> onBehalfOfCredential </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">OnBehalfOfCredential</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    tenantId</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> clientId</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> clientSecret</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> oboToken</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> options</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> graphClient </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">GraphServiceClient</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">onBehalfOfCredential</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> scopes</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>But because we have no token to exchange, we can't make use of delegated permissions in the Graph API. This is a current limitation of using Easy Auth and Azure Container Apps. Keep an eye on <a href="https://github.com/microsoft/azure-container-apps/issues/479" target="_blank" rel="noopener noreferrer">this GitHub issue if this is interesting to you</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="implementing-addazurecontainerappseasyauth">Implementing <code>AddAzureContainerAppsEasyAuth()</code><a href="https://johnnyreilly.com/azure-container-apps-easy-auth-and-dotnet-authentication#implementing-addazurecontainerappseasyauth" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>We're going to implement an <code>AuthenticationHandler</code> that takes the information from the <code>X-MS-CLIENT-PRINCIPAL</code> header and uses it to create a <code>ClaimsPrincipal</code>:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">AzureContainerAppsEasyAuth.cs</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Microsoft</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">AspNetCore</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Authentication</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Microsoft</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Extensions</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Logging</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Microsoft</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Extensions</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Options</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">System</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Security</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Claims</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">System</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Text</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Encodings</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Web</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">System</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Text</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Json</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">System</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Text</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Json</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Serialization</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">/// &lt;summary&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">/// Support for EasyAuth authentication in Azure Container Apps</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">/// &lt;/summary&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">namespace</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Azure</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">ContainerApps</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">EasyAuth</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">class</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">EasyAuthAuthenticationBuilderExtensions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#66d9ef">string</span><span class="token plain"> EASYAUTHSCHEMENAME </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"EasyAuth"</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#e6db74">AuthenticationBuilder</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">AddAzureContainerAppsEasyAuth</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">this</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">AuthenticationBuilder</span><span class="token plain"> builder</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token class-name" style="color:#e6db74">Action</span><span class="token class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token class-name" style="color:#e6db74">EasyAuthAuthenticationOptions</span><span class="token class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token class-name punctuation" style="color:#f8f8f2">?</span><span class="token plain"> configure </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">null</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">configure </span><span class="token operator" style="color:#66d9ef">==</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">null</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> configure </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> o </span><span class="token operator" style="color:#66d9ef">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> builder</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token generic-method function" style="color:#e6db74">AddScheme</span><span class="token generic-method generic class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token generic-method generic class-name" style="color:#e6db74">EasyAuthAuthenticationOptions</span><span class="token generic-method generic class-name punctuation" style="color:#f8f8f2">,</span><span class="token generic-method generic class-name" style="color:#e6db74"> EasyAuthAuthenticationHandler</span><span class="token generic-method generic class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            EASYAUTHSCHEMENAME</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            EASYAUTHSCHEMENAME</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            configure</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">class</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">EasyAuthAuthenticationOptions</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token type-list class-name" style="color:#e6db74">AuthenticationSchemeOptions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">EasyAuthAuthenticationOptions</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        Events </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name keyword" style="color:#66d9ef">object</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">class</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">EasyAuthAuthenticationHandler</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token type-list class-name" style="color:#e6db74">AuthenticationHandler</span><span class="token type-list class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token type-list class-name" style="color:#e6db74">EasyAuthAuthenticationOptions</span><span class="token type-list class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">EasyAuthAuthenticationHandler</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token class-name" style="color:#e6db74">IOptionsMonitor</span><span class="token class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token class-name" style="color:#e6db74">EasyAuthAuthenticationOptions</span><span class="token class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain"> options</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token class-name" style="color:#e6db74">ILoggerFactory</span><span class="token plain"> logger</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token class-name" style="color:#e6db74">UrlEncoder</span><span class="token plain"> encoder</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token class-name" style="color:#e6db74">ISystemClock</span><span class="token plain"> clock</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">base</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">options</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> logger</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> encoder</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> clock</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">protected</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">override</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#e6db74">Task</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token return-type class-name" style="color:#e6db74">AuthenticateResult</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">HandleAuthenticateAsync</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">try</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> easyAuthProvider </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> Context</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Headers</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">"X-MS-CLIENT-PRINCIPAL-IDP"</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">FirstOrDefault</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">??</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"aad"</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> msClientPrincipalEncoded </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> Context</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Headers</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">"X-MS-CLIENT-PRINCIPAL"</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">FirstOrDefault</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">string</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">IsNullOrWhiteSpace</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">msClientPrincipalEncoded</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> AuthenticateResult</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">NoResult</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> decodedBytes </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> Convert</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">FromBase64String</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">msClientPrincipalEncoded</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> memoryStream </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">MemoryStream</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">decodedBytes</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> clientPrincipal </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">await</span><span class="token plain"> JsonSerializer</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token generic-method function" style="color:#e6db74">DeserializeAsync</span><span class="token generic-method generic class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token generic-method generic class-name" style="color:#e6db74">MsClientPrincipal</span><span class="token generic-method generic class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">memoryStream</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">clientPrincipal </span><span class="token operator" style="color:#66d9ef">==</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">null</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">||</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">!</span><span class="token plain">clientPrincipal</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Claims</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">Any</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> AuthenticateResult</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">NoResult</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> claims </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> clientPrincipal</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Claims</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">Select</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">claim </span><span class="token operator" style="color:#66d9ef">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">Claim</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">claim</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Type</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> claim</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token comment" style="color:#8292a2;font-style:italic">// remap "roles" claims from easy auth to the more standard ClaimTypes.Role / "http://schemas.microsoft.com/ws/2008/06/identity/claims/role"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> easyAuthRoleClaims </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> claims</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">Where</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">claim </span><span class="token operator" style="color:#66d9ef">=&gt;</span><span class="token plain"> claim</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Type </span><span class="token operator" style="color:#66d9ef">==</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"roles"</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> claimsAndRoles </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> claims</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">Concat</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">easyAuthRoleClaims</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">Select</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">role </span><span class="token operator" style="color:#66d9ef">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">Claim</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">ClaimTypes</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Role</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> role</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> principal </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">ClaimsPrincipal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            principal</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">AddIdentity</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">ClaimsIdentity</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">claimsAndRoles</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> clientPrincipal</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">AuthenticationType</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> clientPrincipal</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">NameType</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> ClaimTypes</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Role</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> ticket </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">AuthenticationTicket</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">principal</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> easyAuthProvider</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> success </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> AuthenticateResult</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">Success</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">ticket</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            Context</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">User </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> principal</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> success</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">Exception</span><span class="token plain"> ex</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> AuthenticateResult</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">Fail</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">ex</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">class</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">MsClientPrincipal</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token attribute class-name" style="color:#e6db74">JsonPropertyName</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">(</span><span class="token attribute attribute-arguments string" style="color:#a6e22e">"auth_typ"</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#66d9ef">string</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">?</span><span class="token plain"> AuthenticationType </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">get</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">set</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token attribute class-name" style="color:#e6db74">JsonPropertyName</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">(</span><span class="token attribute attribute-arguments string" style="color:#a6e22e">"claims"</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#e6db74">IEnumerable</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token return-type class-name" style="color:#e6db74">UserClaim</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain"> Claims </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">get</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">set</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token generic-method function" style="color:#e6db74">Empty</span><span class="token generic-method generic class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token generic-method generic class-name" style="color:#e6db74">UserClaim</span><span class="token generic-method generic class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token attribute class-name" style="color:#e6db74">JsonPropertyName</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">(</span><span class="token attribute attribute-arguments string" style="color:#a6e22e">"name_typ"</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#66d9ef">string</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">?</span><span class="token plain"> NameType </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">get</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">set</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token attribute class-name" style="color:#e6db74">JsonPropertyName</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">(</span><span class="token attribute attribute-arguments string" style="color:#a6e22e">"role_typ"</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#66d9ef">string</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">?</span><span class="token plain"> RoleType </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">get</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">set</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">class</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">UserClaim</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token attribute class-name" style="color:#e6db74">JsonPropertyName</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">(</span><span class="token attribute attribute-arguments string" style="color:#a6e22e">"typ"</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#66d9ef">string</span><span class="token plain"> Type </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">get</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">set</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">string</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Empty</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token attribute class-name" style="color:#e6db74">JsonPropertyName</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">(</span><span class="token attribute attribute-arguments string" style="color:#a6e22e">"val"</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#66d9ef">string</span><span class="token plain"> Value </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">get</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">set</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">string</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Empty</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>There's a few things to note from the above:</p>
<ul>
<li><code>EasyAuthAuthenticationHandler</code> is an <code>AuthenticationHandler</code> that takes the information from the <code>X-MS-CLIENT-PRINCIPAL</code> header and uses it to create a <code>ClaimsPrincipal</code>.</li>
<li>The <code>MsClientPrincipal</code> class is a representation of the decoded <code>X-MS-CLIENT-PRINCIPAL</code> header.</li>
<li><code>AddAzureContainerAppsEasyAuth</code> is an extension method for the <code>AuthenticationBuilder</code> object - this allows users to make use of the handler in their application.</li>
<li>With Easy Auth, role claims arrive in the custom <code>"roles"</code> claim. This is somewhat non-standard and so we remap <code>"roles"</code> claims to be <code>ClaimTypes.Role</code> / <code>"http://schemas.microsoft.com/ws/2008/06/identity/claims/role"</code> claims as well. This should ensure that anything built with the expectation of that type of claim behaves in the way you'd expect.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-addazurecontainerappseasyauth">Using <code>AddAzureContainerAppsEasyAuth()</code><a href="https://johnnyreilly.com/azure-container-apps-easy-auth-and-dotnet-authentication#using-addazurecontainerappseasyauth" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Now we've written our handler, we can use it in our application. We do this by calling <code>AddAzureContainerAppsEasyAuth()</code> in our <code>Program.cs</code>:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">Program.cs</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#8292a2;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">builder</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Services</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">AddAuthentication</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">EasyAuthAuthenticationBuilderExtensions</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">EASYAUTHSCHEMENAME</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">AddAzureContainerAppsEasyAuth</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// &lt;-- here</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">builder</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Services</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">AddAuthorization</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> app </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> builder</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">Build</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">app</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">UseAuthentication</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">app</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">UseAuthorization</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">//...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now when we run our application, we'll see that <code>User.Identity.IsAuthenticated</code> is <code>true</code> when we're authenticated in Azure Container Apps!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="easy-auth-differs-azure-app-service-azure-container-apps-azure-static-web-apps-and-azure-functions">Easy Auth differs Azure App Service, Azure Container Apps, Azure Static Web Apps and Azure Functions<a href="https://johnnyreilly.com/azure-container-apps-easy-auth-and-dotnet-authentication#easy-auth-differs-azure-app-service-azure-container-apps-azure-static-web-apps-and-azure-functions" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>One thing that became very clear to me as I worked on this, is that Easy Auth is implemented differently in Azure App Service, Azure Container Apps, Azure Static Web Apps and Azure Functions. Whilst the authentication appears to be the same, the headers are different across the services. So the code above will work in Azure Container Apps; for other Azure services I can't vouch for it.</p>
<p>The code in this post is very similar to that in <a href="https://github.com/MaximRouiller/MaximeRouiller.Azure.AppService.EasyAuth" target="_blank" rel="noopener noreferrer"><code>MaximeRouiller.Azure.AppService.EasyAuth</code></a>. But it's not quite the same, as that library depends upon a <code>WEBSITE_AUTH_ENABLED</code> environment variable, which isn't present in Azure Container Apps.</p>
<p>Likewise, the <code>Microsoft.Identity.Web</code> package <a href="https://github.com/AzureAD/microsoft-identity-web/wiki/1.2.0#integration-with-azure-app-services-authentication-of-web-apps-running-with-microsoftidentityweb" target="_blank" rel="noopener noreferrer">supports Easy Auth, but for Azure App Service</a>. If you <a href="https://github.com/AzureAD/microsoft-identity-web/blob/c7f146e93180deece63f879453e98a872cdda658/src/Microsoft.Identity.Web/AppServicesAuth/AppServicesAuthenticationInformation.cs#L38" target="_blank" rel="noopener noreferrer">take a look at the code</a>, you'll see it is powered by environment variables and headers, which aren't present in Azure Container Apps.</p>
<p>So whilst it would be tremendous if this was built into .NET, or in a NuGet package somewhere. I'm not aware of one at the time of writing, so I made this. Perhaps this should become a NuGet package? Let me know if you think so!</p>
<p>I've also raised a <a href="https://github.com/AzureAD/microsoft-identity-web/issues/2274" target="_blank" rel="noopener noreferrer">feature request in the <code>Microsoft.Identity.Web</code> repo to support Azure Container Apps</a>. If you'd like to see this, please upvote it!</p>]]></content:encoded>
            <category>azure</category>
            <category>azure container apps</category>
            <category>easy auth</category>
            <category>asp.net</category>
            <category>auth</category>
        </item>
        <item>
            <title><![CDATA[Migrating to v4 Azure Functions Node.js with TypeScript]]></title>
            <link>https://johnnyreilly.com/migrating-azure-functions-node-js-v4-typescript</link>
            <guid>https://johnnyreilly.com/migrating-azure-functions-node-js-v4-typescript</guid>
            <pubDate>Tue, 24 Oct 2023 07:54:38 GMT</pubDate>
            <description><![CDATA[Learn how to migrate a TypeScript Azure Functions app to the v4 Node.js programming model.]]></description>
            <content:encoded><![CDATA[<p>There's a new programming model available for Node.js Azure Functions known as v4. There's documentation out there for <a href="https://learn.microsoft.com/en-us/azure/azure-functions/functions-node-upgrade-v4?tabs=v4" target="_blank" rel="noopener noreferrer">how to migrate JavaScript Azure Functions from v3 to v4</a>, but at the time of writing, TypeScript wasn't covered.</p>
<p>This post fills in the gaps for a TypeScript Azure Function. It's probably worth mentioning that <a href="https://johnnyreilly.com/" target="_blank" rel="noopener noreferrer">my blog</a> is an <a href="https://learn.microsoft.com/en-us/azure/static-web-apps/overview" target="_blank" rel="noopener noreferrer">Azure Static Web App</a> with a TypeScript Node.js Azure Functions back end. So, this post is based on my experience migrating my blog to v4.</p>
<p><img loading="eager" alt="title image reading &amp;quot;Link Azure Application Insights to Static Web Apps with Bicep&amp;quot; with the Bicep and Azure Static Web App logos" src="https://johnnyreilly.com/assets/images/title-image-e16bb3c85ded7aa934b9ef8a41a2541a.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<p>I'm going to walk through the migration of my blog from v3 to v4. This takes place in <a href="https://github.com/johnnyreilly/blog.johnnyreilly.com/pull/728/files" target="_blank" rel="noopener noreferrer">this pull request</a>. I'll probably cover some of the ground of the offical JavaScript upgrade docs, but I'll also cover some of the TypeScript specific stuff.</p>
<p>There will be two main parts to this post:</p>
<ol>
<li>Changes to make to <code>package.json</code></li>
<li>Migrating a Function</li>
</ol>
<p>The second part will be the bulk of the post, but the first part is important too.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-changes-to-make-to-the-packagejson">1. Changes to make to the <code>package.json</code><a href="https://johnnyreilly.com/migrating-azure-functions-node-js-v4-typescript#1-changes-to-make-to-the-packagejson" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>So, starting with the first part, there are three changes to make to the <code>package.json</code>:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> "dependencies": {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">    "@azure/functions": "^4.0.1",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> },</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> "devDependencies": {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic">    "@azure/functions": "^3.5.0",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> },</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">  "main": "dist/src/functions/*/index.js"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol>
<li>Update the <code>@azure/functions</code> dependency to <code>^4.0.1</code> (or later)</li>
<li>The <code>@azure/functions</code> dev dependency becomes a regular dependency - this is because we'll be using the package at runtime now - previously we just used it to get the types at build time</li>
<li>Add a <code>main</code> property to the <code>package.json</code> with a glob that matches the functions in your project; in my case <code>dist/src/functions/*/index.js</code> - which will be our output from the TypeScript build</li>
</ol>
<p>As I took care of <strong>3.</strong>, I found myself changing the folder structure of my functions. Actually, this isn't mandatory, but it was tricky for me to come up with a glob for my current structure. So I moved things around - you may not need to. All that matters is that your glob matches the output of your build.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-migrating-a-function">2. Migrating a Function<a href="https://johnnyreilly.com/migrating-azure-functions-node-js-v4-typescript#2-migrating-a-function" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>In order that we can understand what migration looks like, we must first take a look at the v3 version of a function. Here's the <code>fallback</code> function from my blog:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">type</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> AzureFunction</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> Context</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> HttpRequest </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'@azure/functions'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> redirect </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'./redirect'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> saveToDatabase </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'./saveToDatabase'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> httpTrigger</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token function-variable function" style="color:#e6db74">AzureFunction</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">async</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  context</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> Context</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  req</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> HttpRequest</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token builtin" style="color:#e6db74">Promise</span><span class="token operator" style="color:#66d9ef">&lt;</span><span class="token keyword" style="color:#66d9ef">void</span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> originalUrl </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> req</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">headers</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'x-ms-original-url'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> status</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> location </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">redirect</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">originalUrl</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">log</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">await</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">saveToDatabase</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">originalUrl</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> status</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> location </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">log</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    context</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">res </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      status</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      headers</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        location</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">error</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    context</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">log</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">error</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token string" style="color:#a6e22e">'Problem with fallback'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      error</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      req</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">headers</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'x-ms-original-url'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">export</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">default</span><span class="token plain"> httpTrigger</span><span class="token punctuation" style="color:#f8f8f2">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The above is the code I use to power <a href="https://johnnyreilly.com/azure-static-web-apps-dynamic-redirects-azure-functions">dynamic redirects in my Azure Static Web App with the Azure Function back-end</a>. It's a TypeScript Azure Function that takes a request, redirects to a new location and saves metadata about the redirect to a database.</p>
<p>Looking at the code now, I rather think I should have called the function <code>redirect</code> rather than <code>fallback</code>. I'll leave it as is for now, but I'll probably change it in the future.</p>
<p>What the <code>fallback</code> function does isn't significant for this post, but the structure is. Now let's look at the migrated version:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">type</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  HttpRequest</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  HttpResponseInit</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  InvocationContext</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'@azure/functions'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> app </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'@azure/functions'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> redirect </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'./redirect'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> saveToDatabase </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'./saveToDatabase'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">export</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">async</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">function</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">fallback</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  request</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> HttpRequest</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  context</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> InvocationContext</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token builtin" style="color:#e6db74">Promise</span><span class="token operator" style="color:#66d9ef">&lt;</span><span class="token plain">HttpResponseInit</span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> originalUrl </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> request</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">headers</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">get</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">'x-ms-original-url'</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">||</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">''</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> status</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> location </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">redirect</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">originalUrl</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">await</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">saveToDatabase</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">originalUrl</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> status</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> location </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      status</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      headers</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        location</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">error</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    context</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">error</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token string" style="color:#a6e22e">'Problem with fallback'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      error</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      request</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">headers</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">get</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">'x-ms-original-url'</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      status</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">500</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      body</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'something went wrong'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">app</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">http</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">'fallback'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  methods</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'GET'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  handler</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> fallback</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As we can see, the logic looks pretty much the same. But a lot has changed. What's different? We'll go through the changes one by one.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="imports-used"><code>import</code>s used<a href="https://johnnyreilly.com/migrating-azure-functions-node-js-v4-typescript#imports-used" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Starting at the top, the <code>import</code>s we use are different:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic">import type { AzureFunction, Context, HttpRequest } from '@azure/functions';</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">import type {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">  HttpRequest,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">  HttpResponseInit,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">  InvocationContext,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">} from '@azure/functions';</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">import { app } from '@azure/functions';</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We're no longer just importing types, we're importing the <code>app</code> function from <code>@azure/functions</code> also. The types that are being imported are different too. We're no longer importing <code>AzureFunction, Context, HttpRequest</code> - instead we're importing <code>HttpRequest, HttpResponseInit,  InvocationContext</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="hello-app-goodbye-functionjson">Hello <code>app</code>, goodbye <code>function.json</code><a href="https://johnnyreilly.com/migrating-azure-functions-node-js-v4-typescript#hello-app-goodbye-functionjson" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>As we saw, we're making use of the <code>app</code> function from <code>@azure/functions</code>. This is a new function that we use to register our Azure Functions. We no longer use <code>function.json</code>. Instead we use <code>app</code>. In the case of my <code>fallback</code> Azure Functions, we register it like this:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">app</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">http</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">'fallback'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  methods</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'GET'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  handler</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> fallback</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We're registering an HTTP trigger called <code>fallback</code> that responds to <code>GET</code> requests. The <code>handler</code> is the function that will be called when the trigger is invoked. There's more options available, but this is the minimum we need to register our function.</p>
<p>This minimal TypeScript/JavaScript replaces the more verbose <code>function.json</code> that used to sit alongside:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">"bindings"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">"authLevel"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"anonymous"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">"type"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"httpTrigger"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">"direction"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"in"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">"name"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"req"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">"methods"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">"get"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"post"</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">"type"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"http"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">"direction"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"out"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">"name"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"res"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">"scriptFile"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"../dist/fallback/index.js"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>All of this is gone, replaced by the <code>app</code> function usage. There's one part of the <code>function.json</code> that isn't covered by the <code>app</code> function, and that's the <code>scriptFile</code> property. This is covered by the <code>main</code> property we added to the <code>package.json</code> earlier.</p>
<p>The rest of the <code>function.json</code> is covered by the <code>app.http</code> call. Much terser.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="signature-and-types-of-our-function">Signature and types of our <code>function</code><a href="https://johnnyreilly.com/migrating-azure-functions-node-js-v4-typescript#signature-and-types-of-our-function" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>The signature of our function has changed too:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic">const httpTrigger: AzureFunction = async function (</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic">  context: Context,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic">  req: HttpRequest</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic">): Promise&lt;void&gt; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">export async function fallback(</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">  request: HttpRequest,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">  context: InvocationContext,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">): Promise&lt;HttpResponseInit&gt; {</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You'll see here that we're using a function declaration rather than a function expression. Our new function takes our new types, the subtly different <code>HttpRequest</code> and <code>InvocationContext</code>, which are similar to, but different from, the previous <code>Context</code> and <code>HttpRequest</code> types. The order of these parameters has changed also.</p>
<p>The return type of the function is now <code>Promise&lt;HttpResponseInit&gt;</code> rather than <code>Promise&lt;void&gt;</code>. What this means is, we're going to return values from our function, which we didn't do previously. Let's look at the implications of this.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="from-contextres-to-promisehttpresponseinit">From <code>context.res</code> to <code>Promise&lt;HttpResponseInit&gt;</code><a href="https://johnnyreilly.com/migrating-azure-functions-node-js-v4-typescript#from-contextres-to-promisehttpresponseinit" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>With a v3 function, we'd set the <code>context.res</code> property to return values from our function. With a v4 function, we return values from our function directly. What does this look like?</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic">    context.res = {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic">      status,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic">      headers: {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic">        location,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic">      },</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic">    };</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">    return {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">      status,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">      headers: {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">        location,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">      },</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">    };</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>I rather like this change. My reasoning is that, in the event that there is subsequent code that would otherwise run after <code>context.res</code> was set, we no longer need to remember to subsequently <code>return</code> to prevent that running. (And yes, I have made that mistake on multiple occasions.) All we need do is return the value we want to return from our function.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="body---jsonbody"><code>body -&gt; jsonBody</code><a href="https://johnnyreilly.com/migrating-azure-functions-node-js-v4-typescript#body---jsonbody" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Another difference is that we no longer set the <code>body</code> property of the <code>context.res</code>. Instead we return an object with a <code>jsonBody</code> property, assuming we're returning JSON from our API. (And that's the most common case, right?)</p>
<p>This wasn't illustrated in the <code>fallback</code> function above, but here's an example of migrating a function that returns JavaScript object literal named <code>redirectSummary</code>:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic">    context.res = {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic">      status: 200,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic">      body: redirectSummary,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic">    };</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">    return {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">      status: 200,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">      jsonBody: redirectSummary,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">    };</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>body</code> property still exists, but it's for returning strings and other things, rather than JSON. If you're returning JSON, the easiest approach is to use the <code>jsonBody</code> property.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="runtime-apis">Runtime APIs<a href="https://johnnyreilly.com/migrating-azure-functions-node-js-v4-typescript#runtime-apis" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Finally, the APIs offered by the <code>request</code> and <code>context</code> objects are different. I shan't go into detail here as it's <a href="https://learn.microsoft.com/en-us/azure/azure-functions/functions-node-upgrade-v4?tabs=v4#review-your-usage-of-http-types" target="_blank" rel="noopener noreferrer">well covered in the official documentation</a>. But I will show you one of the changes I made to my <code>fallback</code> function:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic">    const originalUrl = req.headers['x-ms-original-url'];</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">    const originalUrl = request.headers.get('x-ms-original-url') || '';</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Not too significant a tweak, but there's a number of slight changes like this to make. (Related to this, the logging API on the <code>context</code> object is also different - but not significantly.)</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://johnnyreilly.com/migrating-azure-functions-node-js-v4-typescript#conclusion" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Migrating an Azure Function from v3 to v4 with TypeScript is a little more involved than I'd expected. But I do like that this moves us to a code style that feels more "Node-y". The official documentation is good, but it's not complete right now.</p>
<p>Hopefully this post will help you migrate your TypeScript Azure Functions to v4.</p>]]></content:encoded>
            <category>typescript</category>
            <category>azure</category>
            <category>azure functions</category>
            <category>azure static web apps</category>
        </item>
        <item>
            <title><![CDATA[Azure Open AI: generate article metadata with TypeScript]]></title>
            <link>https://johnnyreilly.com/azure-open-ai-generate-article-metadata-with-typescript</link>
            <guid>https://johnnyreilly.com/azure-open-ai-generate-article-metadata-with-typescript</guid>
            <pubDate>Sun, 24 Sep 2023 12:15:05 GMT</pubDate>
            <description><![CDATA[Use the TypeScript Azure Open AI SDK to generate article metadata.]]></description>
            <content:encoded><![CDATA[<p>This post grew out of my desire to improve the metadata for my blog posts. I have been blogging for more than ten years, and the majority of my posts lack descriptions. A description is meta tag that sits in a page and describes the contents of the page. This is what this posts description meta tag looks like in HTML:</p>
<div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token tag punctuation" style="color:#f8f8f2">&lt;</span><span class="token tag" style="color:#f92672">meta</span><span class="token tag" style="color:#f92672"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token tag" style="color:#f92672">  </span><span class="token tag attr-name" style="color:#a6e22e !important">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#f8f8f2">=</span><span class="token tag attr-value punctuation" style="color:#f8f8f2">"</span><span class="token tag attr-value" style="color:#f92672">description</span><span class="token tag attr-value punctuation" style="color:#f8f8f2">"</span><span class="token tag" style="color:#f92672"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token tag" style="color:#f92672">  </span><span class="token tag attr-name" style="color:#a6e22e !important">content</span><span class="token tag attr-value punctuation attr-equals" style="color:#f8f8f2">=</span><span class="token tag attr-value punctuation" style="color:#f8f8f2">"</span><span class="token tag attr-value" style="color:#f92672">Use the TypeScript Azure Open AI SDK to generate article metadata.</span><span class="token tag attr-value punctuation" style="color:#f8f8f2">"</span><span class="token tag" style="color:#f92672"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token tag" style="color:#f92672"></span><span class="token tag punctuation" style="color:#f8f8f2">/&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Descriptions are important for search engine optimisation (SEO) and for accessibility. You can <a href="https://developers.google.com/search/docs/appearance/snippet" target="_blank" rel="noopener noreferrer">read up more on the topic here</a>. I wanted to have descriptions for <em>all</em> my blog posts. But writing around 230 descriptions for my existing posts was not something I wanted to do manually. I wanted to automate it.</p>
<p><img loading="eager" alt="title image reading &amp;quot;Azure Open AI: generate article metadata with TypeScript&amp;quot; with the Azure Open AI / TypeScript logos" src="https://johnnyreilly.com/assets/images/title-image-8073436bce980c6c577b07d612072b84.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="typescript-azure-open-ai-sdk">TypeScript Azure Open AI SDK<a href="https://johnnyreilly.com/azure-open-ai-generate-article-metadata-with-typescript#typescript-azure-open-ai-sdk" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>I've been using Azure Open AI for a while now, and I've been using the <a href="https://github.com/Azure/azure-sdk-for-js/blob/main/sdk/openai/openai/README.md" target="_blank" rel="noopener noreferrer">TypeScript SDK in the <code>@azure/openai</code> package</a> to interact with it. What I wanted to do, was to use the SDK to generate descriptions for my blog posts based on the content. Since my blog is powered by Docusaurus and each post is a Markdown file, I had easy access to a individual files that could be summarised.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-i-wanted-to-do">What I wanted to do<a href="https://johnnyreilly.com/azure-open-ai-generate-article-metadata-with-typescript#what-i-wanted-to-do" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>The plan was, to build a script to do the following:</p>
<ul>
<li>read all of my blog posts without descriptions</li>
<li>for each one, generate a description using Azure Open AI</li>
<li>write the description to the Markdown file</li>
</ul>
<p>I wanted to use <a href="https://bun.sh/" target="_blank" rel="noopener noreferrer">Bun</a> for this as it supports TypeScript by default. Using Node.js would equally be possible; but it wouldn't have been so easy to use TypeScript.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="reading-the-blog-posts">Reading the blog posts<a href="https://johnnyreilly.com/azure-open-ai-generate-article-metadata-with-typescript#reading-the-blog-posts" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>I started off by creating a new Bun project:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token function" style="color:#e6db74">mkdir</span><span class="token plain"> open-ai-description</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token builtin class-name" style="color:#e6db74">cd</span><span class="token plain"> open-ai-description</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">bun init</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then adding the various packages we needed, including the Azure Open AI one:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">bun </span><span class="token function" style="color:#e6db74">add</span><span class="token plain"> @azure/openai @azure/identity</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">bun </span><span class="token function" style="color:#e6db74">add</span><span class="token plain"> </span><span class="token parameter variable" style="color:#f8f8f2">--dev</span><span class="token plain"> bun-types typescript</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>I then created an <code>index.ts</code> file and added the following code:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">import</span><span class="token plain"> fs </span><span class="token keyword" style="color:#66d9ef">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'fs'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">import</span><span class="token plain"> path </span><span class="token keyword" style="color:#66d9ef">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'path'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> produceSummary </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'./summarizer'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> docusaurusDirectory </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'../blog-website'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">async</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">function</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">getBlogDirsOrderedDescending</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> rootBlogPath </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> path</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">resolve</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">docusaurusDirectory</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'blog'</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> blogDirs </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">await</span><span class="token plain"> fs</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">promises</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">readdir</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">rootBlogPath</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">filter</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">file</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=&gt;</span><span class="token plain"> fs</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">statSync</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">path</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">join</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">rootBlogPath</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> file</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">isDirectory</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">map</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">file</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=&gt;</span><span class="token plain"> path</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">join</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">rootBlogPath</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> file</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  blogDirs</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">sort</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">reverse</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> blogDirs</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">interface</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BlogPost</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  path</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token builtin" style="color:#e6db74">string</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  content</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token builtin" style="color:#e6db74">string</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">interface</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BlogPostWithDescription</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">extends</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BlogPost</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  description</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token builtin" style="color:#e6db74">string</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">async</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">function</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">generatePostsWithDescription</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> blogDirs </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">await</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">getBlogDirsOrderedDescending</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> postsWithoutDescription</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> BlogPost</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> blogDir </span><span class="token keyword" style="color:#66d9ef">of</span><span class="token plain"> blogDirs</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token builtin" style="color:#e6db74">console</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">log</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">Processing </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">blogDir</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> indexMdPath </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> path</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">join</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">blogDir</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'index.md'</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> blogPostContent </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">await</span><span class="token plain"> fs</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">promises</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">readFile</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">indexMdPath</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'utf-8'</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> frontMatter </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> blogPostContent</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">split</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">'---'</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> hasDescription </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> frontMatter</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">includes</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">'\ndescription: '</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#66d9ef">!</span><span class="token plain">hasDescription</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      postsWithoutDescription</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">push</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        path</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> indexMdPath</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        content</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> blogPostContent</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token builtin" style="color:#e6db74">console</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">log</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">Found </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">postsWithoutDescription</span><span class="token template-string interpolation punctuation" style="color:#f8f8f2">.</span><span class="token template-string interpolation">length</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string string" style="color:#a6e22e"> posts without description</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> postsWithDescription</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> BlogPostWithDescription</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> post </span><span class="token keyword" style="color:#66d9ef">of</span><span class="token plain"> postsWithoutDescription</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> frontmatter</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> article</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> post</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">content</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">split</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">'---'</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token builtin" style="color:#e6db74">console</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">log</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">** Generating description for </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">post</span><span class="token template-string interpolation punctuation" style="color:#f8f8f2">.</span><span class="token template-string interpolation">path</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token template-string interpolation">        </span><span class="token template-string interpolation punctuation" style="color:#f8f8f2">.</span><span class="token template-string interpolation function" style="color:#e6db74">replace</span><span class="token template-string interpolation punctuation" style="color:#f8f8f2">(</span><span class="token template-string interpolation string" style="color:#a6e22e">'/index.md'</span><span class="token template-string interpolation punctuation" style="color:#f8f8f2">,</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation string" style="color:#a6e22e">''</span><span class="token template-string interpolation punctuation" style="color:#f8f8f2">)</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token template-string interpolation">        </span><span class="token template-string interpolation punctuation" style="color:#f8f8f2">.</span><span class="token template-string interpolation function" style="color:#e6db74">split</span><span class="token template-string interpolation punctuation" style="color:#f8f8f2">(</span><span class="token template-string interpolation string" style="color:#a6e22e">'/'</span><span class="token template-string interpolation punctuation" style="color:#f8f8f2">)</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token template-string interpolation">        </span><span class="token template-string interpolation punctuation" style="color:#f8f8f2">.</span><span class="token template-string interpolation function" style="color:#e6db74">pop</span><span class="token template-string interpolation punctuation" style="color:#f8f8f2">(</span><span class="token template-string interpolation punctuation" style="color:#f8f8f2">)</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> description </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">await</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">produceSummary</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">article</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">description</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      postsWithDescription</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">push</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">...</span><span class="token plain">post</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> description </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token builtin" style="color:#e6db74">console</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">log</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">** description: </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">description</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#66d9ef">await</span><span class="token plain"> fs</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">promises</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">writeFile</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        post</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">path</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">---</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">frontmatter</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string string" style="color:#a6e22e">description: '</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">description</span><span class="token template-string interpolation punctuation" style="color:#f8f8f2">.</span><span class="token template-string interpolation function" style="color:#e6db74">replaceAll</span><span class="token template-string interpolation punctuation" style="color:#f8f8f2">(</span><span class="token template-string interpolation string" style="color:#a6e22e">"'"</span><span class="token template-string interpolation punctuation" style="color:#f8f8f2">,</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation string" style="color:#a6e22e">''</span><span class="token template-string interpolation punctuation" style="color:#f8f8f2">)</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string string" style="color:#a6e22e">'</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token template-string string" style="color:#a6e22e">---</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">article</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token builtin" style="color:#e6db74">console</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">log</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">** no description generated</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> postsWithDescription</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">async</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">function</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">main</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> startedAt </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">Date</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> postsWithDescription</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> BlogPostWithDescription</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">await</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">generatePostsWithDescription</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> finishedAt </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">Date</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> duration </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">finishedAt</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">getTime</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">-</span><span class="token plain"> startedAt</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">getTime</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">/</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">1000</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token builtin" style="color:#e6db74">console</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">log</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">postsWithDescription</span><span class="token template-string interpolation punctuation" style="color:#f8f8f2">.</span><span class="token template-string interpolation">length</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string string" style="color:#a6e22e"> summaries generated in </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">duration</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string string" style="color:#a6e22e"> seconds</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">await</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">main</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The code above does the following:</p>
<ul>
<li>reads all of the blog posts in my blog; they're all directories in the <code>blog</code> directory with an <code>index.md</code> underneath so it's pretty easy</li>
<li>for each post, it checks to see if there is a description in the front matter (<a href="https://docusaurus.io/docs/markdown-features#front-matter" target="_blank" rel="noopener noreferrer">front matter is a metadata section at the top of the Markdown file</a>)</li>
<li>if there is no description, it adds the post to a list of posts without descriptions</li>
<li>it then loops through the posts without descriptions and generates a description for each one using the <code>produceSummary</code> function - more on that in a moment</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="generating-the-descriptions">Generating the descriptions<a href="https://johnnyreilly.com/azure-open-ai-generate-article-metadata-with-typescript#generating-the-descriptions" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>So far, so text wrangling. Let's look at the <code>produceSummary</code> function in the <code>summarizer.ts</code> file:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> OpenAIClient </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'@azure/openai'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> AzureCliCredential </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'@azure/identity'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">// Make sure you have az login'd and have the correct subscription selected</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">// debug with:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">// bun --inspect-brk open-ai-description/index.ts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">// or:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">// cd open-ai-description</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">// bun --inspect-brk index.ts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">interface</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">OpenAiClientAndDeploymentName</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  openAIClient</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> OpenAIClient</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  deploymentName</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token builtin" style="color:#e6db74">string</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">let</span><span class="token plain"> openAiClientAndDeploymentName</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> OpenAiClientAndDeploymentName </span><span class="token operator" style="color:#66d9ef">|</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">undefined</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">function</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">getClientAndDeploymentName</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> OpenAiClientAndDeploymentName </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">openAiClientAndDeploymentName</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> openAiClientAndDeploymentName</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#8292a2;font-style:italic">// You will need to set these environment variables or edit the following values</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> endpoint </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> process</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">env</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#a6e22e">'ENDPOINT'</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#66d9ef">!</span><span class="token plain">endpoint</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">Error</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token string" style="color:#a6e22e">'Missing ENDPOINT environment variable with a value like https://&lt;resource name&gt;.openai.azure.com'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#8292a2;font-style:italic">// This will use the Azure CLI's currently logged in user;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#8292a2;font-style:italic">// make sure you've done `az login` and have the correct subscription selected</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> credential </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">AzureCliCredential</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> openAIClient </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">OpenAIClient</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">endpoint</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> credential</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> deploymentName </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'OpenAi-gpt-35-turbo'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  openAiClientAndDeploymentName </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> openAIClient</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> deploymentName </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> openAiClientAndDeploymentName</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">export</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">async</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">function</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">produceSummary</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">article</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token builtin" style="color:#e6db74">string</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token builtin" style="color:#e6db74">Promise</span><span class="token operator" style="color:#66d9ef">&lt;</span><span class="token builtin" style="color:#e6db74">string</span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> openAIClient</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> deploymentName </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">getClientAndDeploymentName</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> minChars </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">120</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> maxChars </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">156</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> messages </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      role</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'system'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      content</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">You are a summarizer. You will be given the text of an article and will produce a summary / meta description which summarizes the article. The summary / meta descriptions you produce must be between </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">minChars</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string string" style="color:#a6e22e"> and </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">maxChars</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string string" style="color:#a6e22e"> characters long. If they are longer or shorter than that they cannot be used. Avoid using the \`'\` character as it is not supported by the blog website - you may use the \`‚Äô\` character instead. Do not use the expression "the author" or "the writer" in your summary.</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      role</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'user'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      content</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">Here is an article to summarize:</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token template-string string" style="display:inline-block;color:#a6e22e"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token template-string string" style="color:#a6e22e"></span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">article</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">let</span><span class="token plain"> attempts </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> maxAttempts </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">10</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">let</span><span class="token plain"> summary </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">''</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">attempts</span><span class="token operator" style="color:#66d9ef">++</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">&lt;</span><span class="token plain"> maxAttempts</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token builtin" style="color:#e6db74">console</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">log</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">Attempt </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">attempts</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string string" style="color:#a6e22e"> of </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">maxAttempts</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#8292a2;font-style:italic">// This will use the Azure CLI's currently logged in user;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#8292a2;font-style:italic">// make sure you've done `az login` and have the correct subscription selected</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> result </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">await</span><span class="token plain"> openAIClient</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">getChatCompletions</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      deploymentName</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      messages</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        temperature</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0.9</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> choice </span><span class="token keyword" style="color:#66d9ef">of</span><span class="token plain"> result</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">choices</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      summary </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> choice</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">message</span><span class="token operator" style="color:#66d9ef">?.</span><span class="token plain">content </span><span class="token operator" style="color:#66d9ef">||</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">''</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">summary</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">length </span><span class="token operator" style="color:#66d9ef">&gt;=</span><span class="token plain"> minChars </span><span class="token operator" style="color:#66d9ef">&amp;&amp;</span><span class="token plain"> summary</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">length </span><span class="token operator" style="color:#66d9ef">&lt;=</span><span class="token plain"> maxChars</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> summary</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token builtin" style="color:#e6db74">console</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">log</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">Summary was </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">summary</span><span class="token template-string interpolation punctuation" style="color:#f8f8f2">.</span><span class="token template-string interpolation">length</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string string" style="color:#a6e22e"> characters long; no good</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    messages</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">push</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        role</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'assistant'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        content</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> summary</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        role</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'user'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        content</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          summary</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">length </span><span class="token operator" style="color:#66d9ef">&lt;</span><span class="token plain"> minChars</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token operator" style="color:#66d9ef">?</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">Too short; try again please - we require a summary that is between </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">minChars</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string string" style="color:#a6e22e"> and </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">maxChars</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string string" style="color:#a6e22e"> characters long.</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">Too long; try again please - we require a summary that is between </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">minChars</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string string" style="color:#a6e22e"> and </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">maxChars</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string string" style="color:#a6e22e"> characters long.</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token builtin" style="color:#e6db74">console</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">log</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">messages</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">await</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">sleep</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">500</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token builtin" style="color:#e6db74">console</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">log</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">Failed to produce a summary in </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">maxAttempts</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string string" style="color:#a6e22e"> attempts</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">''</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">function</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">sleep</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">ms</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token builtin" style="color:#e6db74">number</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name builtin" style="color:#e6db74">Promise</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">resolve</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=&gt;</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">setTimeout</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">resolve</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> ms</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>There's a lot going on here, so let's break it down.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="authentication">Authentication<a href="https://johnnyreilly.com/azure-open-ai-generate-article-metadata-with-typescript#authentication" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Oftentimes the fiddliest part of using Azure Open AI is authentication. In this case, I'm using the Azure CLI credential. So to run this you need to authenticate with the Azure CLI with <code>az login</code>. (Remember to make sure you have the correct subscription selected. You can check this by running <code>az account show</code> and checking that the <code>isDefault</code> property is set to <code>true</code>.)</p>
<p>Once you're logged in, this code will use the currently logged in user to authenticate with Azure Open AI.</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> credential </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">AzureCliCredential</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> openAIClient </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">OpenAIClient</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">endpoint</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> credential</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> deploymentName </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'OpenAi-gpt-35-turbo'</span><span class="token punctuation" style="color:#f8f8f2">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You need to set the <code>endpoint</code> variable to the endpoint of your Azure Open AI resource. You can find this in the Azure Portal by going to your Azure Open AI resource. Look for something like <code>https://&lt;resource name&gt;.openai.azure.com</code>. You'll also need to get the name of your deployment. In my case this is <code>OpenAi-gpt-35-turbo</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="producing-the-summary">Producing the summary<a href="https://johnnyreilly.com/azure-open-ai-generate-article-metadata-with-typescript#producing-the-summary" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Once you've authenticated and got the client you can start to summarise. The first thing to do is provide a system message to prime the model with context on what we're trying to do. As part of writing a good description, there's a sweet spot to hit in terms of length; too short and it's not useful, too long and it gets truncated. So we're going to aim for between 120 and 156 characters. We're also going to encourage the AI to avoid certain wording constructs and also avoid using the <code>'</code> character as it upsets the front matter.</p>
<p>Once primed, we hand over the blog content to the AI and ask it to produce a summary.</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> minChars </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">120</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> maxChars </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">156</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> messages </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    role</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'system'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    content</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">You are a summarizer. You will be given the text of an article and will produce a summary / meta description which summarizes the article. The summary / meta descriptions you produce must be between </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">minChars</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string string" style="color:#a6e22e"> and </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">maxChars</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string string" style="color:#a6e22e"> characters long. If they are longer or shorter than that they cannot be used. Avoid using the \`'\` character as it is not supported by the blog website - you may use the \`‚Äô\` character instead. Do not use the expression "the author" or "the writer" in your summary.</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    role</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'user'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    content</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">Here is an article to summarize:</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token template-string string" style="display:inline-block;color:#a6e22e"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token template-string string" style="color:#a6e22e"></span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">article</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The way we interact with the Azure Open AI is with the <code>getChatCompletions</code> method, which is effectively a strongly typed wrapper for the <a href="https://learn.microsoft.com/en-us/azure/ai-services/openai/reference#chat-completions" target="_blank" rel="noopener noreferrer">chat-completions endpoint in Azure</a>.</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">let</span><span class="token plain"> attempts </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> maxAttempts </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">10</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">let</span><span class="token plain"> summary </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">''</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">attempts</span><span class="token operator" style="color:#66d9ef">++</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">&lt;</span><span class="token plain"> maxAttempts</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token builtin" style="color:#e6db74">console</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">log</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">Attempt </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">attempts</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string string" style="color:#a6e22e"> of </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">maxAttempts</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#8292a2;font-style:italic">// This will use the Azure CLI's currently logged in user;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#8292a2;font-style:italic">// make sure you've done `az login` and have the correct subscription selected</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> result </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">await</span><span class="token plain"> openAIClient</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">getChatCompletions</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    deploymentName</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    messages</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      temperature</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0.9</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// the closer to 1, the more creative the AI will be</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> choice </span><span class="token keyword" style="color:#66d9ef">of</span><span class="token plain"> result</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">choices</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    summary </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> choice</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">message</span><span class="token operator" style="color:#66d9ef">?.</span><span class="token plain">content </span><span class="token operator" style="color:#66d9ef">||</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">''</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">summary</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">length </span><span class="token operator" style="color:#66d9ef">&gt;=</span><span class="token plain"> minChars </span><span class="token operator" style="color:#66d9ef">&amp;&amp;</span><span class="token plain"> summary</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">length </span><span class="token operator" style="color:#66d9ef">&lt;=</span><span class="token plain"> maxChars</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> summary</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token builtin" style="color:#e6db74">console</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">log</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">Summary was </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">summary</span><span class="token template-string interpolation punctuation" style="color:#f8f8f2">.</span><span class="token template-string interpolation">length</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string string" style="color:#a6e22e"> characters long; no good</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  messages</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">push</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      role</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'assistant'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      content</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> summary</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      role</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'user'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      content</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        summary</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">length </span><span class="token operator" style="color:#66d9ef">&lt;</span><span class="token plain"> minChars</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token operator" style="color:#66d9ef">?</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">Too short; try again please - we require a summary that is between </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">minChars</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string string" style="color:#a6e22e"> and </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">maxChars</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string string" style="color:#a6e22e"> characters long.</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">Too long; try again please - we require a summary that is between </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">minChars</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string string" style="color:#a6e22e"> and </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">maxChars</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string string" style="color:#a6e22e"> characters long.</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token builtin" style="color:#e6db74">console</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">log</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">messages</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token builtin" style="color:#e6db74">console</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">log</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e">Failed to produce a summary in </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">maxAttempts</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#f8f8f2">}</span><span class="token template-string string" style="color:#a6e22e"> attempts</span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">''</span><span class="token punctuation" style="color:#f8f8f2">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>What's quite interesting, is that you really can't rely on the AI do what you ask it to do. It <em>may</em> create a description of an appropriate length. It may not. So we need to check what it gives us, and if it doesn't satisfy our needs, then we ask it to try again. We'll give it a maximum of 10 attempts per post, as surprisingly, every now and then it struggles to meet the brief and infinite loops are to be avoided.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="running-the-script">Running the script<a href="https://johnnyreilly.com/azure-open-ai-generate-article-metadata-with-typescript#running-the-script" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>When the script ran (after I'd <code>az login</code>-ed) it produced descriptions for all my blog posts. I reviewed each summary and tweaked them where necessary. If I really didn't like a description I'd delete and run the script again. In the end I had descriptions for all my blog posts that I was pretty happy with. If you take a look at <a href="https://github.com/johnnyreilly/blog.johnnyreilly.com/pull/656" target="_blank" rel="noopener noreferrer">this giant PR</a> you can see them all landing.</p>
<p>Hopefully this post provides a useful example of how to use the TypeScript Azure Open AI SDK to generate article metadata. You can see the raw code <a href="https://github.com/johnnyreilly/blog.johnnyreilly.com/tree/main/open-ai-description" target="_blank" rel="noopener noreferrer">here</a>.</p>]]></content:encoded>
            <category>azure</category>
            <category>typescript</category>
        </item>
        <item>
            <title><![CDATA[Graph API: getting users Active Directory group names and ids with the C# SDK]]></title>
            <link>https://johnnyreilly.com/graph-api-ad-users-group-name-ids-csharp-sdk</link>
            <guid>https://johnnyreilly.com/graph-api-ad-users-group-name-ids-csharp-sdk</guid>
            <pubDate>Thu, 23 Nov 2023 09:30:18 GMT</pubDate>
            <description><![CDATA[Learn how to get the Azure Active Directory group names and ids from the Graph API using the C# SDK.]]></description>
            <content:encoded><![CDATA[<p>The Graph API is a great way to get information about users in Azure Active Directory. I recently needed to get the names and ids of the Active Directory groups that a user was a member of. Here's how to do it with the C# SDK.</p>
<p>I'm writing this post as, whilst it ends up being a relatively small amount of code and configuration required, if you don't know what that is, you can end up somewhat stuck. This should hopefully unstick you.</p>
<p><img loading="eager" alt="title image reading &amp;quot;Graph API: getting users AD group names and ids with the C# SDK&amp;quot; with the Azure Graph and C# logos" src="https://johnnyreilly.com/assets/images/title-image-6d92def2e18c2d0c25e0676cc8c1525a.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="azure-ad-app-registration-api-permissions">Azure AD app registration API permissions<a href="https://johnnyreilly.com/graph-api-ad-users-group-name-ids-csharp-sdk#azure-ad-app-registration-api-permissions" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>To query the Graph API, we'll need:</p>
<ul>
<li>an Azure AD app registration</li>
<li>a client id and client secret for that app registration</li>
<li>the tenant id for the Azure AD tenant that the app registration is in</li>
<li><code>GroupMember.Read.All</code> and <code>User.Read.All</code> API application permissions</li>
</ul>
<p>Of the above, it's the API permissions that I want to draw your attention to. Ultimately, you'll need to get your Azure AD admin to grant consent to these permissions for your app registration so you have the necessary permissions to query the Graph API:</p>
<p><img loading="lazy" alt="screenshot of the Azure Portal showing the API permissions we require" src="https://johnnyreilly.com/assets/images/screenshot-azure-app-registration-api-permissions-481a37148442bfa0ae49d95ab40dbeab.png" width="3576" height="1074" class="img_ev3q"></p>
<p>How did I know that I needed these permissions? Great question! I found the answer in the <a href="https://learn.microsoft.com/en-us/graph/api/directoryobject-getmembergroups?view=graph-rest-1.0&amp;tabs=http#group-memberships-for-a-user" target="_blank" rel="noopener noreferrer">"directoryObject: getMemberGroups / group memberships for a user" documentation</a>.</p>
<p>The Application <code>User.Read.All</code> and <code>GroupMember.Read.All</code> permissions are the least privileged permissions that allow you to query the Graph API for the information we need. If you're interested in the other permissions available, check out the <a href="https://learn.microsoft.com/en-us/graph/permissions-reference" target="_blank" rel="noopener noreferrer">Microsoft Graph permissions reference</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="querying-the-graph-api">Querying the Graph API<a href="https://johnnyreilly.com/graph-api-ad-users-group-name-ids-csharp-sdk#querying-the-graph-api" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Now we've configured our app registration, we can query the Graph API. I'm going to show you how to do this with the C# SDK. If you're using a different language, you'll need to find the equivalent SDK for your language.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="install-the-sdk">Install the SDK<a href="https://johnnyreilly.com/graph-api-ad-users-group-name-ids-csharp-sdk#install-the-sdk" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>The first thing we need to do is install the SDK. I'm using the <a href="https://www.nuget.org/packages/Microsoft.Graph/" target="_blank" rel="noopener noreferrer">Microsoft.Graph</a> package. At the time of writing, the latest version is 5.35.0.</p>
<p>Once you have added it, you'll have an entry in your <code>.csproj</code> along these lines:</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">MyApp.csproj</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token tag punctuation" style="color:#f8f8f2">&lt;</span><span class="token tag" style="color:#f92672">PackageReference</span><span class="token tag" style="color:#f92672"> </span><span class="token tag attr-name" style="color:#a6e22e !important">Include</span><span class="token tag attr-value punctuation attr-equals" style="color:#f8f8f2">=</span><span class="token tag attr-value punctuation" style="color:#f8f8f2">"</span><span class="token tag attr-value" style="color:#f92672">Microsoft.Graph</span><span class="token tag attr-value punctuation" style="color:#f8f8f2">"</span><span class="token tag" style="color:#f92672"> </span><span class="token tag attr-name" style="color:#a6e22e !important">Version</span><span class="token tag attr-value punctuation attr-equals" style="color:#f8f8f2">=</span><span class="token tag attr-value punctuation" style="color:#f8f8f2">"</span><span class="token tag attr-value" style="color:#f92672">5.35.0</span><span class="token tag attr-value punctuation" style="color:#f8f8f2">"</span><span class="token tag" style="color:#f92672"> </span><span class="token tag punctuation" style="color:#f8f8f2">/&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you're interested in the underlying project, you can find it as <a href="https://github.com/microsoftgraph/msgraph-sdk-dotnet" target="_blank" rel="noopener noreferrer"><code>msgraph-sdk-dotnet</code> on GitHub</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-a-graphserviceclient">Create a GraphServiceClient<a href="https://johnnyreilly.com/graph-api-ad-users-group-name-ids-csharp-sdk#create-a-graphserviceclient" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Next, we need to create a <code>GraphServiceClient</code>. This is the object that we'll use to query the Graph API. For that we'll need a credential which we'll construct using the <code>tenantId</code>, <code>clientId</code> and <code>clientSecret</code> that we got from our app registration:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Azure</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Identity</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Microsoft</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Graph</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">// The client credentials flow requires that you request the</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">// /.default scope, and pre-configure your permissions on the</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">// app registration in Azure. An administrator must grant consent</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">// to those permissions beforehand.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> scopes </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"https://graph.microsoft.com/.default"</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">// using Azure.Identity;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> options </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">ClientSecretCredentialOptions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    AuthorityHost </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> AzureAuthorityHosts</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">AzurePublicCloud</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">// https://learn.microsoft.com/en-us/graph/sdks/choose-authentication-providers?tabs=csharp#using-a-client-secret</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">// https://learn.microsoft.com/dotnet/api/azure.identity.clientsecretcredential</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> clientSecretCredential </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">ClientSecretCredential</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    tenantId</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> clientId</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> clientSecret</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> options</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">_graphClient </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">GraphServiceClient</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">clientSecretCredential</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> scopes</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The above code is based on the <a href="https://learn.microsoft.com/en-us/graph/sdks/choose-authentication-providers?tabs=csharp#using-a-client-secret" target="_blank" rel="noopener noreferrer">"client credentials provider / using a client secret" documentation</a>. It's possible that you might want to use a different authentication provider. If so, check out the <a href="https://learn.microsoft.com/en-us/graph/sdks/choose-authentication-providers?tabs=csharp" target="_blank" rel="noopener noreferrer">"choose authentication providers" documentation</a>. Because we're querying for application permissions, we need to use the client credentials provider. We could, if we wanted to, use the client certificate approach instead. I'm not going to cover that here.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="query-the-graph-api">Query the Graph API<a href="https://johnnyreilly.com/graph-api-ad-users-group-name-ids-csharp-sdk#query-the-graph-api" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Now we come to the fun part. We're going to query the Graph API for the groups that a user is a member of. We'll need to pass in the <code>usernameOrId</code> of the user that we're interested in. I'm using the user's email address as the <code>usernameOrId</code> in my application. You might want to use the user's id instead. It's up to you.</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token class-name" style="color:#e6db74">List</span><span class="token class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token class-name" style="color:#e6db74">GroupIdDisplayName</span><span class="token class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain"> groupIds </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token class-name" style="color:#e6db74">Microsoft</span><span class="token class-name punctuation" style="color:#f8f8f2">.</span><span class="token class-name" style="color:#e6db74">Graph</span><span class="token class-name punctuation" style="color:#f8f8f2">.</span><span class="token class-name" style="color:#e6db74">Models</span><span class="token class-name punctuation" style="color:#f8f8f2">.</span><span class="token class-name" style="color:#e6db74">GroupCollectionResponse</span><span class="token class-name punctuation" style="color:#f8f8f2">?</span><span class="token plain"> response </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">await</span><span class="token plain"> _graphClient</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Users</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">usernameOrId</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">MemberOf</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">GraphGroup</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">GetAsync</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">requestConfiguration </span><span class="token operator" style="color:#66d9ef">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    requestConfiguration</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">QueryParameters</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Select </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name keyword" style="color:#66d9ef">string</span><span class="token constructor-invocation class-name punctuation" style="color:#f8f8f2">[</span><span class="token constructor-invocation class-name punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"id"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"displayName"</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    requestConfiguration</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">QueryParameters</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Top </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">100</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> pageIterator </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> PageIterator</span><span class="token operator" style="color:#66d9ef">&lt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    Microsoft</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Graph</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Models</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Group</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    Microsoft</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Graph</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Models</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">GroupCollectionResponse</span><span class="token punctuation" style="color:#f8f8f2">?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">CreatePageIterator</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">_graphClient</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> response</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">group</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    groupIds</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">Add</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">GroupIdDisplayName</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token named-parameter punctuation" style="color:#f8f8f2">Id</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">group</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Id</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token named-parameter punctuation" style="color:#f8f8f2">DisplayName</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">group</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">DisplayName</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token boolean" style="color:#ae81ff">true</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">await</span><span class="token plain"> pageIterator</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">IterateAsync</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Let's unpack the code above. It does the following:</p>
<ol>
<li>Creates an empty list of <code>GroupIdDisplayName</code> objects. This is the type that I'm using to store the group ids and display names. You can use whatever type you want.</li>
<li>It indexes into the <code>Users</code> collection on the <code>GraphServiceClient</code> using the <code>usernameOrId</code> that we passed in. From there we make use of <code>MemberOf.GraphGroup</code> and call <code>GetAsync</code> on that, passing in a request configuration method. This is where we specify the <code>Select</code> and <code>Top</code> query parameters. We're using <code>Select</code> to specify only the properties that we want to return - by default lots more data would come back than we require. We're using <code>Top</code> to specify the maximum number of results that we want to return. I'm using 100 as that's the maximum that the Graph API will allow. We'll need to use a <code>PageIterator</code> to get all of the results. More on that in a moment.</li>
<li>Because we want to get all of the results, we need to use a <code>PageIterator</code>. We create one using the <code>CreatePageIterator</code> method on the <code>PageIterator</code> class. We pass in the <code>GraphServiceClient</code> that we created earlier, the <code>response</code> that we got from the <code>GetAsync</code> call and a delegate that will be called for each result. In our delegate, we add the <code>GroupIdDisplayName</code> to our list and return <code>true</code> to indicate that we want to continue iterating. If we wanted to stop iterating, we'd return <code>false</code>. Finally we call <code>IterateAsync</code> on the <code>PageIterator</code> to get all of the results.</li>
</ol>
<p>The <code>PageIterator</code> is somewhat confusing, in my opinion. I'm used to paging through results, but this way of doing it did puzzle me. If you're interested in learning more about the <code>PageIterator</code>, check out the <a href="https://learn.microsoft.com/en-us/graph/sdks/paging?tabs=csharp" target="_blank" rel="noopener noreferrer">"paging" documentation</a>. I also found <a href="https://github.com/microsoftgraph/msgraph-sdk-dotnet/blob/dev/docs/upgrade-to-v5.md#pageiterator" target="_blank" rel="noopener noreferrer">this documentation helpful</a>.</p>
<p>Initially the <code>PageIterator</code> was throwing an exception when I used it. <a href="https://stackoverflow.com/questions/75860298/graphserviceclient-pageitarator-failes-with-the-parsable-does-not-contain-a-col" target="_blank" rel="noopener noreferrer">I found the answer to that on StackOverflow</a>. It turns out that the types you specify for the <code>PageIterator</code> need to be correct for the request above; and if not you may be impaced by type mismatches at runtime. The entries that are returned from the API may be wider or simply different to what you require. I've the correct types in my code now - but I mention it just in case.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="putting-it-all-together">Putting it all together<a href="https://johnnyreilly.com/graph-api-ad-users-group-name-ids-csharp-sdk#putting-it-all-together" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Ultimately I wrote a <code>GroupService</code> that I could use to get the groups for a user. That service looks like this:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">GroupService.cs</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Azure</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Identity</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Microsoft</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Graph</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">namespace</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">ZebraGptContainerApp</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Services</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Implementations</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">record</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">GroupIdDisplayName</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token class-name keyword" style="color:#66d9ef">string</span><span class="token class-name punctuation" style="color:#f8f8f2">?</span><span class="token plain"> Id</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token class-name keyword" style="color:#66d9ef">string</span><span class="token class-name punctuation" style="color:#f8f8f2">?</span><span class="token plain"> DisplayName</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">interface</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">IGroupService</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token return-type class-name" style="color:#e6db74">Task</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token return-type class-name" style="color:#e6db74">List</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token return-type class-name" style="color:#e6db74">GroupIdDisplayName</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">GetGroups</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name keyword" style="color:#66d9ef">string</span><span class="token plain"> usernameOrId</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">class</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">GroupService</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token type-list class-name" style="color:#e6db74">IGroupService</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">private</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">GraphServiceClient</span><span class="token plain"> _graphClient</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">private</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">ILogger</span><span class="token class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token class-name" style="color:#e6db74">GroupService</span><span class="token class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain"> _logger</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#8292a2;font-style:italic">// new this up in program.cs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">GroupService</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">ILogger</span><span class="token class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token class-name" style="color:#e6db74">GroupService</span><span class="token class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain"> logger</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#66d9ef">string</span><span class="token plain"> tenantId</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#66d9ef">string</span><span class="token plain"> clientId</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#66d9ef">string</span><span class="token plain"> clientSecret</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        _logger </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> logger</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">// The client credentials flow requires that you request the</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">// /.default scope, and pre-configure your permissions on the</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">// app registration in Azure. An administrator must grant consent</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">// to those permissions beforehand.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> scopes </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"https://graph.microsoft.com/.default"</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">// using Azure.Identity;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> options </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">ClientSecretCredentialOptions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            AuthorityHost </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> AzureAuthorityHosts</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">AzurePublicCloud</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">// https://learn.microsoft.com/en-us/graph/sdks/choose-authentication-providers?tabs=csharp#using-a-client-secret</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">// https://learn.microsoft.com/dotnet/api/azure.identity.clientsecretcredential</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> clientSecretCredential </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">ClientSecretCredential</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            tenantId</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> clientId</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> clientSecret</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> options</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        _graphClient </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">GraphServiceClient</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">clientSecretCredential</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> scopes</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#e6db74">Task</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token return-type class-name" style="color:#e6db74">List</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token return-type class-name" style="color:#e6db74">GroupIdDisplayName</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">GetGroups</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name keyword" style="color:#66d9ef">string</span><span class="token plain"> usernameOrId</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">// https://stackoverflow.com/questions/75860298/graphserviceclient-pageitarator-failes-with-the-parsable-does-not-contain-a-col</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">try</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name" style="color:#e6db74">List</span><span class="token class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token class-name" style="color:#e6db74">GroupIdDisplayName</span><span class="token class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain"> groupIds </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name" style="color:#e6db74">Microsoft</span><span class="token class-name punctuation" style="color:#f8f8f2">.</span><span class="token class-name" style="color:#e6db74">Graph</span><span class="token class-name punctuation" style="color:#f8f8f2">.</span><span class="token class-name" style="color:#e6db74">Models</span><span class="token class-name punctuation" style="color:#f8f8f2">.</span><span class="token class-name" style="color:#e6db74">GroupCollectionResponse</span><span class="token class-name punctuation" style="color:#f8f8f2">?</span><span class="token plain"> response </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">await</span><span class="token plain"> _graphClient</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Users</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">usernameOrId</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">MemberOf</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">GraphGroup</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">GetAsync</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">requestConfiguration </span><span class="token operator" style="color:#66d9ef">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                requestConfiguration</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">QueryParameters</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Select </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name keyword" style="color:#66d9ef">string</span><span class="token constructor-invocation class-name punctuation" style="color:#f8f8f2">[</span><span class="token constructor-invocation class-name punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"id"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"displayName"</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                requestConfiguration</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">QueryParameters</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Top </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">100</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> pageIterator </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> PageIterator</span><span class="token operator" style="color:#66d9ef">&lt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                Microsoft</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Graph</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Models</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Group</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                Microsoft</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Graph</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Models</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">GroupCollectionResponse</span><span class="token punctuation" style="color:#f8f8f2">?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">CreatePageIterator</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">_graphClient</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> response</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">group</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                groupIds</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">Add</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">GroupIdDisplayName</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token named-parameter punctuation" style="color:#f8f8f2">Id</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">group</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Id</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token named-parameter punctuation" style="color:#f8f8f2">DisplayName</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">group</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">DisplayName</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token boolean" style="color:#ae81ff">true</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">await</span><span class="token plain"> pageIterator</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">IterateAsync</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> groupIds</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">Exception</span><span class="token plain"> ex</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            _logger</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">LogError</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">ex</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"Problem getting groups with usernameOrId {usernameOrId}"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> usernameOrId</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">Exception</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token interpolation-string string" style="color:#a6e22e">$"Problem getting groups with usernameOrId </span><span class="token interpolation-string interpolation punctuation" style="color:#f8f8f2">{</span><span class="token interpolation-string interpolation expression language-csharp">usernameOrId</span><span class="token interpolation-string interpolation punctuation" style="color:#f8f8f2">}</span><span class="token interpolation-string string" style="color:#a6e22e">"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> ex</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It is constructed in <code>Program.cs</code>:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">Program.cs</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#8292a2;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">builder</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Services</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token generic-method function" style="color:#e6db74">AddSingleton</span><span class="token generic-method generic class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token generic-method generic class-name" style="color:#e6db74">IGroupService</span><span class="token generic-method generic class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">serviceProvider </span><span class="token operator" style="color:#66d9ef">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#e6db74">GroupService</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token named-parameter punctuation" style="color:#f8f8f2">logger</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> serviceProvider</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token generic-method function" style="color:#e6db74">GetRequiredService</span><span class="token generic-method generic class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token generic-method generic class-name" style="color:#e6db74">ILogger</span><span class="token generic-method generic class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token generic-method generic class-name" style="color:#e6db74">GroupService</span><span class="token generic-method generic class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token generic-method generic class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token named-parameter punctuation" style="color:#f8f8f2">tenantId</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> builder</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Configuration</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token generic-method function" style="color:#e6db74">GetValue</span><span class="token generic-method generic class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token generic-method generic class-name keyword" style="color:#66d9ef">string</span><span class="token generic-method generic class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">"TenantId"</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token operator" style="color:#66d9ef">!</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token named-parameter punctuation" style="color:#f8f8f2">clientId</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> builder</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Configuration</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token generic-method function" style="color:#e6db74">GetValue</span><span class="token generic-method generic class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token generic-method generic class-name keyword" style="color:#66d9ef">string</span><span class="token generic-method generic class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">"ClientId"</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token operator" style="color:#66d9ef">!</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token named-parameter punctuation" style="color:#f8f8f2">clientSecret</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> builder</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Configuration</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token generic-method function" style="color:#e6db74">GetValue</span><span class="token generic-method generic class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token generic-method generic class-name keyword" style="color:#66d9ef">string</span><span class="token generic-method generic class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">"ClientSecret"</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token operator" style="color:#66d9ef">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">// ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then I can use it in my controller:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">GroupsController.cs</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Microsoft</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">AspNetCore</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Mvc</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">namespace</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">MyApp</span><span class="token namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token namespace" style="color:rgb(178, 204, 214);opacity:0.7">Controllers</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token attribute class-name" style="color:#e6db74">ApiController</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">class</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">GroupsController</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token type-list class-name" style="color:#e6db74">ControllerBase</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">IGroupService</span><span class="token plain"> _groupService</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">ILogger</span><span class="token class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token class-name" style="color:#e6db74">MeController</span><span class="token class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain"> _log</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">GroupsController</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">IGroupService</span><span class="token plain"> groupService</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">ILogger</span><span class="token class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token class-name" style="color:#e6db74">MeController</span><span class="token class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain"> log</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        _groupService </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> groupService</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        _log </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> log</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token attribute class-name" style="color:#e6db74">HttpGet</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">(</span><span class="token attribute attribute-arguments string" style="color:#a6e22e">"api/groups"</span><span class="token attribute attribute-arguments punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#e6db74">Task</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&lt;</span><span class="token return-type class-name" style="color:#e6db74">IActionResult</span><span class="token return-type class-name punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">GetGroups</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token class-name keyword" style="color:#66d9ef">string</span><span class="token class-name punctuation" style="color:#f8f8f2">?</span><span class="token plain"> email </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> User</span><span class="token punctuation" style="color:#f8f8f2">?.</span><span class="token plain">Identity</span><span class="token punctuation" style="color:#f8f8f2">?.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// email in my context</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">try</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">string</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">IsNullOrEmpty</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">email</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">Unauthorized</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token class-name keyword" style="color:#66d9ef">var</span><span class="token plain"> groups </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">await</span><span class="token plain"> _groupService</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">GetGroups</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">email</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">Ok</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">groups</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">Exception</span><span class="token plain"> ex</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            _log</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">LogError</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">ex</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"Problem getting groups for {email}"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> email</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">BadRequest</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token interpolation-string string" style="color:#a6e22e">$"Problem getting groups for </span><span class="token interpolation-string interpolation punctuation" style="color:#f8f8f2">{</span><span class="token interpolation-string interpolation expression language-csharp">email</span><span class="token interpolation-string interpolation punctuation" style="color:#f8f8f2">}</span><span class="token interpolation-string string" style="color:#a6e22e">"</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When you browse to <code>/api/groups</code>, you'll get a JSON response with the group ids and display names:</p>
<p><img loading="lazy" alt="screenshot of the JSON returned from the controller displaying ids and displayNames" src="https://johnnyreilly.com/assets/images/screenshot-group-ids-and-display-names-dc6000021cbc2b95498002e5ce2a42dc.png" width="926" height="468" class="img_ev3q"></p>
<p>And if you're anything like me, you'll discover that you are in <em>way</em> more groups than you thought you were.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://johnnyreilly.com/graph-api-ad-users-group-name-ids-csharp-sdk#conclusion" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>This post has demonstrated both the configuration and the code required to query the Graph API for the groups that a user is a member of. Hopefully it also provides something of a reference for acquiring different types of Graph API permissions and using the C# SDK to query the Graph API.</p>]]></content:encoded>
            <category>auth</category>
            <category>azure</category>
            <category>c#</category>
            <category>asp.net</category>
        </item>
        <item>
            <title><![CDATA[TypeScript: The Movie]]></title>
            <link>https://johnnyreilly.com/typescript-documentary</link>
            <guid>https://johnnyreilly.com/typescript-documentary</guid>
            <pubDate>Thu, 21 Sep 2023 20:04:41 GMT</pubDate>
            <description><![CDATA[A documentary has been made about TypeScript and I feature in the story of how it came to be what it is today.]]></description>
            <content:encoded><![CDATA[<p>I am excited to announce that a documentary has been made about TypeScript! It premiered on YouTube at 5pm British Summertime September 21st 2023.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/U6s2pdxebSo?si=7X3eRhmSXLUnlGr5" title="TypeScript Origins documentary" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen=""></iframe>
<p>I had the good fortune to be involved in the making of the documentary. In part this was thanks to my work on Definitely Typed. Another reason was my work on recording <a href="https://johnnyreilly.com/definitely-typed-the-movie">the history of DefinitelyTyped</a>.</p>
<p>You can <a href="https://youtu.be/U6s2pdxebSo?si=Bw6scRpzmmSw5J2j" target="_blank" rel="noopener noreferrer">see it on YouTube here</a> or hit play on the embedded video above. Thanks to the <a href="https://www.keyboard-stories.com/" target="_blank" rel="noopener noreferrer">Keyboard Stories</a> team for making this happen!</p>]]></content:encoded>
            <category>typescript</category>
        </item>
        <item>
            <title><![CDATA[Azure Open AI: handling capacity and quota limits with Bicep]]></title>
            <link>https://johnnyreilly.com/azure-open-ai-capacity-quota-bicep</link>
            <guid>https://johnnyreilly.com/azure-open-ai-capacity-quota-bicep</guid>
            <pubDate>Tue, 19 Sep 2023 19:13:26 GMT</pubDate>
            <description><![CDATA[This post details how to control the capacity of an Azure Open AI deployment with Bicep so that you don't exceed your quota.]]></description>
            <content:encoded><![CDATA[<p>We're currently in the gold rush period of AI. The world cannot get enough. A consequence of this, is that rationing is in force. It's like the end of the second world war, but with GPUs. This is a good thing, because it means that we can't just spin up as many resources as we like. It's a bad thing, for the exact same reason.</p>
<p>If you're making use of Azure's Open AI resources for your AI needs, you'll be aware that there are <a href="https://learn.microsoft.com/en-us/azure/ai-services/openai/how-to/quota?tabs=bicep" target="_blank" rel="noopener noreferrer">limits known as "quotas"</a> in place. If you're looking to control how many resources you're using, you'll want to be able to control the capacity of your deployments. This is possible with Bicep.</p>
<p>This post grew out of a <a href="https://github.com/Azure/bicep-types-az/issues/1660#issuecomment-1643484703" target="_blank" rel="noopener noreferrer">GitHub issue</a> around the topic where people were bumping on the message <code>the capacity should be null for standard deployment</code> as they attempted to deploy. At the time that issue was raised, there was very little documentation on how to handle this. Since then, things have improved, but I thought it would be useful to have a post on the topic.</p>
<p><img loading="eager" alt="title image reading &amp;quot;Azure Open AI: handling capacity and quota limits with Bicep&amp;quot; with the Azure Open AI / Bicep logos" src="https://johnnyreilly.com/assets/images/title-image-015ac7f920c42c69f461711f0fd46156.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="viewing-capacity-and-quota-limits-in-the-azure-open-ai-studio">Viewing capacity and quota limits in the Azure Open AI Studio<a href="https://johnnyreilly.com/azure-open-ai-capacity-quota-bicep#viewing-capacity-and-quota-limits-in-the-azure-open-ai-studio" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>If you take a look at the <a href="https://oai.azure.com/" target="_blank" rel="noopener noreferrer">Azure Open AI Studio</a> you'll notice a "Quotas" section:</p>
<p><img loading="lazy" alt="screenshot of azure open ai studio with quotas highlighted" src="https://johnnyreilly.com/assets/images/screenshot-azure-ai-studio-75ce4e148dad67f942e31aaa9874030d.webp" width="3076" height="1290" class="img_ev3q"></p>
<p>You'll see above that we've got two deployments of GPT-35-Turbo in our subscription. Both of these contribute towards an overall limit of 360K TPM. If we try and deploy resources and have an overall capacity total that exceeds that, our deployment will fail.</p>
<p>That being the case, we need to be able to control the capacity of our deployments. This is possible with Bicep.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="controlling-capacity-and-quota-limits-with-bicep">Controlling capacity and quota limits with Bicep<a href="https://johnnyreilly.com/azure-open-ai-capacity-quota-bicep#controlling-capacity-and-quota-limits-with-bicep" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Consider the following <code>account-deployments.bicep</code>:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token decorator">@description</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">'Name of the Cognitive Services resource'</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">param</span><span class="token plain"> cognitiveServicesName </span><span class="token datatype class-name" style="color:#e6db74">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token decorator">@description</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">'Name of the deployment resource.'</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">param</span><span class="token plain"> deploymentName </span><span class="token datatype class-name" style="color:#e6db74">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token decorator">@description</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">'Deployment model format.'</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">param</span><span class="token plain"> format </span><span class="token datatype class-name" style="color:#e6db74">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token decorator">@description</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">'Deployment model name.'</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">param</span><span class="token plain"> name </span><span class="token datatype class-name" style="color:#e6db74">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token decorator">@description</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">'Deployment model version.'</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">param</span><span class="token plain"> version </span><span class="token datatype class-name" style="color:#e6db74">string</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'1'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token decorator">@description</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">'The name of RAI policy.'</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">param</span><span class="token plain"> raiPolicyName </span><span class="token datatype class-name" style="color:#e6db74">string</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'Default'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token decorator">@allowed</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token string" style="color:#a6e22e">'NoAutoUpgrade'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token string" style="color:#a6e22e">'OnceCurrentVersionExpired'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token string" style="color:#a6e22e">'OnceNewDefaultVersionAvailable'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token decorator">@description</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">'Deployment model version upgrade option. see https://learn.microsoft.com/en-us/azure/templates/microsoft.cognitiveservices/2023-05-01/accounts/deployments?pivots=deployment-language-bicep#deploymentproperties'</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">param</span><span class="token plain"> versionUpgradeOption </span><span class="token datatype class-name" style="color:#e6db74">string</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'OnceNewDefaultVersionAvailable'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token decorator">@description</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">'''Deployments SKU see: https://learn.microsoft.com/en-us/azure/templates/microsoft.cognitiveservices/2023-05-01/accounts/deployments?pivots=deployment-language-bicep#sku</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token string" style="color:#a6e22e">eg:</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token string" style="color:#a6e22e"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token string" style="color:#a6e22e">sku: {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token string" style="color:#a6e22e">  name: 'Standard'</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token string" style="color:#a6e22e">  capacity: 10</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token string" style="color:#a6e22e">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token string" style="color:#a6e22e"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token string" style="color:#a6e22e">'''</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">param</span><span class="token plain"> sku </span><span class="token datatype class-name" style="color:#e6db74">object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">// https://learn.microsoft.com/en-us/azure/templates/microsoft.cognitiveservices/2023-05-01/accounts?pivots=deployment-language-bicep</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">resource</span><span class="token plain"> cog </span><span class="token string" style="color:#a6e22e">'Microsoft.CognitiveServices/accounts@2023-05-01'</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">existing</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">name</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> cognitiveServicesName</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">// https://learn.microsoft.com/en-us/azure/templates/microsoft.cognitiveservices/2023-05-01/accounts/deployments?pivots=deployment-language-bicep</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">resource</span><span class="token plain"> deployment </span><span class="token string" style="color:#a6e22e">'Microsoft.CognitiveServices/accounts/deployments@2023-05-01'</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">name</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> deploymentName</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">parent</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> cog</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">sku</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> sku</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">properties</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">model</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">format</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> format</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">name</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> name</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">version</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> version</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">raiPolicyName</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> raiPolicyName</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">versionUpgradeOption</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> versionUpgradeOption</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">output</span><span class="token plain"> deploymentName </span><span class="token datatype class-name" style="color:#e6db74">string</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> deployment</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">name</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">output</span><span class="token plain"> deploymentResourceId </span><span class="token datatype class-name" style="color:#e6db74">string</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> deployment</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">id</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We can use this to deploy.... deployments (naming here is definitely confusing) to Azure like so:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">var</span><span class="token plain"> cognitiveServicesDeployments </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">name</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'OpenAi-gpt-35-turbo'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">shortName</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'gpt35t'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">model</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">format</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'OpenAI'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">name</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'gpt-35-turbo'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">version</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'0301'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">sku</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">name</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'Standard'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">capacity</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> repositoryBranch </span><span class="token operator" style="color:#66d9ef">==</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'refs/heads/main'</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">?</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">100</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">10</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// capacity in thousands of TPM</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">// Model Deployment - one at a time as parallel deployments are not supported</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token decorator">@batchSize</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">module</span><span class="token plain"> openAiAccountsDeployments35Turbo </span><span class="token string" style="color:#a6e22e">'account-deployments.bicep'</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token keyword" style="color:#66d9ef">for</span><span class="token plain"> deployment </span><span class="token keyword" style="color:#66d9ef">in</span><span class="token plain"> cognitiveServicesDeployments</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">name</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:#a6e22e">'</span><span class="token interpolated-string interpolation punctuation" style="color:#f8f8f2">${</span><span class="token interpolated-string interpolation expression">deployment</span><span class="token interpolated-string interpolation expression punctuation" style="color:#f8f8f2">.</span><span class="token interpolated-string interpolation expression">shortName</span><span class="token interpolated-string interpolation punctuation" style="color:#f8f8f2">}</span><span class="token interpolated-string string" style="color:#a6e22e">-cog-accounts-deployments'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">params</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">cognitiveServicesName</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> openAi</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">outputs</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">cognitiveServicesName</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">deploymentName</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> deployment</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">name</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">format</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> deployment</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">model</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">format</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">name</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> deployment</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">model</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">name</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">version</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> deployment</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">model</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">version</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">sku</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> deployment</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">sku</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We're currently only deploying a single account deployment in our array, but we do it this way as it's not unusual to deploy multiple deployments together. Notice the <code>sku</code> portion above:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">    sku</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">name</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'Standard'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">capacity</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> repositoryBranch </span><span class="token operator" style="color:#66d9ef">==</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'refs/heads/main'</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">?</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">100</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here we provision a larger <code>capacity</code> for our feature branch deployments than our <code>main</code> branch deployments. This demonstrates our own usage, whereby we deploy a smaller capacity for our feature branches so that we can test things out, but then deploy a larger capacity for our main branch deployments.</p>
<p>Significantly, we're controlling the capacity of our deployments. The way in which you choose to decide on the capacity of your deployments is up to you, but the above demonstrates how you can do it with Bicep and stick within your quota limits.</p>]]></content:encoded>
            <category>azure</category>
            <category>bicep</category>
        </item>
        <item>
            <title><![CDATA[Azure Pipelines meet Vitest]]></title>
            <link>https://johnnyreilly.com/azure-pipelines-meet-vitest</link>
            <guid>https://johnnyreilly.com/azure-pipelines-meet-vitest</guid>
            <pubDate>Tue, 19 Sep 2023 19:13:26 GMT</pubDate>
            <description><![CDATA[This post details how to integrate the test runner Vitest with Azure Pipelines.]]></description>
            <content:encoded><![CDATA[<p>This post explains how to integrate the tremendous test runner <a href="https://vitest.dev/" target="_blank" rel="noopener noreferrer">Vitest</a> with the continuous integration platform <a href="https://azure.microsoft.com/en-gb/products/devops/pipelines/" target="_blank" rel="noopener noreferrer">Azure Pipelines</a>. If you read <a href="https://johnnyreilly.com/azure-pipelines-meet-jest">the post on integrating with Jest</a>, you'll recognise a lot of common ground with this. Once again we want:</p>
<ol>
<li>Tests run as part of our pipeline</li>
<li>A failing test fails the build</li>
<li>Test results reported in Azure Pipelines UI</li>
</ol>
<p><img loading="eager" alt="title image reading &amp;quot;Azure Pipelines meet Vitest&amp;quot; with the Pipelines and Vitest logos" src="https://johnnyreilly.com/assets/images/title-image-29f5f663eb5da2a98325dc6ad5967e95.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<p>This post assumes we have a Vitest project set up and an Azure Pipeline in place. Let's get started.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="tests-run-as-part-of-our-pipeline">Tests run as part of our pipeline<a href="https://johnnyreilly.com/azure-pipelines-meet-vitest#tests-run-as-part-of-our-pipeline" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>First of all, lets get the tests running. We'll crack open our <code>azure-pipelines.yml</code> file and, in the appropriate place add the following:</p>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">bash</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> npm run test</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain">ci</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'npm test'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">workingDirectory</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> src/client</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">app</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The above will, when run, trigger a <code>npm run test:ci</code> in the <code>src/client-app</code> folder of the project (it's here where the app lives). What does <code>test:ci</code> do? Well, it's a script in the <code>package.json</code> that looks like this:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token property" style="color:#f92672">"test"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"vitest"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token property" style="color:#f92672">"test:ci"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"vitest run --reporter=default --reporter=junit --outputFile=reports/junit.xml"</span><span class="token punctuation" style="color:#f8f8f2">,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You'll note above we've got 2 scripts; <code>test</code> and <code>test:ci</code>. The former is the default script that Vitest will run when you run <code>npm test</code>. The latter is the script that we'll use in our pipeline. The difference between the two is that the <code>test:ci</code> script will:</p>
<ol>
<li>Doesn't run in watch mode</li>
<li>Fail the build if any tests fail</li>
<li>Produce a JUnit XML report which details test results. This is the format that Azure Pipelines can use to ingest test results.</li>
</ol>
<p>The test results are written to <code>reports/junit.xml</code> which is a path relative to the <code>src/client-app</code> folder. Because you may test this locally, it's probably worth adding the <code>reports</code> folder to your <code>.gitignore</code> file to avoid it accidentally being committed.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="report-test-results-in-azure-pipelines-ui">Report test results in Azure Pipelines UI<a href="https://johnnyreilly.com/azure-pipelines-meet-vitest#report-test-results-in-azure-pipelines-ui" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Our tests are running, but we're not seeing the results in the Azure Pipelines UI. For that we need the <a href="https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/publish-test-results-v2" target="_blank" rel="noopener noreferrer"><code>PublishTestResults</code> task</a>.</p>
<p>We need to add a new step to our <code>azure-pipelines.yml</code> file <em>after</em> our <code>npm run test:ci</code> step:</p>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> PublishTestResults@2</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'supply npm test results to pipelines'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">condition</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> succeededOrFailed() </span><span class="token comment" style="color:#8292a2;font-style:italic"># because otherwise we won't know what tests failed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">testResultsFiles</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'src/client-app/reports/junit.xml'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This will read the test results from our <code>src/client-app/reports/junit.xml</code> file and pump them into Pipelines. Do note that we're <em>always</em> running this step; so if the previous step failed (as it would in the case of a failing test) we still pump out the details of what that failure was.</p>
<p>And that's it! Azure Pipelines and Jest integrated.</p>
<p><img loading="lazy" alt="screenshot of test results published to Azure Pipelines" src="https://johnnyreilly.com/assets/images/test-results-af22126afcf8abe740b04d2878c16418.webp" width="2996" height="1084" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="putting-it-all-together">Putting it all together<a href="https://johnnyreilly.com/azure-pipelines-meet-vitest#putting-it-all-together" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>The complete <code>azure-pipelines.yml</code> additions look like this:</p>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">bash</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> npm run test</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain">ci</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'npm test'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">workingDirectory</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> src/client</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">app</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> PublishTestResults@2</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'supply npm test results to pipelines'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">condition</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> succeededOrFailed() </span><span class="token comment" style="color:#8292a2;font-style:italic"># because otherwise we won't know what tests failed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">testResultsFiles</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'src/client-app/reports/junit.xml'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Please note, there's nothing special about the <code>reports/junit.xml</code> file. You can change the name of the file and/or the location of the file. Just make sure you update the <code>testResultsFiles</code> value in the <code>PublishTestResults</code> task to match.</p>]]></content:encoded>
            <category>azure pipelines</category>
            <category>automated testing</category>
        </item>
        <item>
            <title><![CDATA[Azure Container Apps, Bicep, bring your own certificates and custom domains]]></title>
            <link>https://johnnyreilly.com/azure-container-apps-bicep-bring-your-own-certificates-custom-domains</link>
            <guid>https://johnnyreilly.com/azure-container-apps-bicep-bring-your-own-certificates-custom-domains</guid>
            <pubDate>Tue, 19 Sep 2023 19:13:26 GMT</pubDate>
            <description><![CDATA[Azure Container Apps supports custom domains with "bring your own certificates" and this post demonstrates how to do it with Bicep.]]></description>
            <content:encoded><![CDATA[<p>Azure Container Apps supports custom domains via certificates. If you're looking to make use of the managed certificates in Azure Container Apps using Bicep, then you might want to take a look at <a href="https://johnnyreilly.com/azure-container-apps-bicep-managed-certificates-custom-domains">this post on the topic</a>.</p>
<p>This post will instead look at how we can use the "bring your own certificates" approach in Azure Container Apps using Bicep. Well, as much as that is possible; there appear to be limitations in what can be achieved with Bicep at the time of writing.</p>
<p><img loading="eager" alt="title image reading &amp;quot;Azure Container Apps, Bicep, bring your own certificates and custom domains&amp;quot; with the Azure Container App logos" src="https://johnnyreilly.com/assets/images/title-image-e7c5444789e1c0a09f5a45243fbc0b18.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<p>This post assumes you already have an Azure Container App in place and you want to bind a custom domain to it. If you don't have an Azure Container App in place, then you might want to take a look at <a href="https://johnnyreilly.com/azure-container-apps-build-and-deploy-with-bicep-and-github-actions">this post on the topic</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="make-a-certificate">Make a certificate<a href="https://johnnyreilly.com/azure-container-apps-bicep-bring-your-own-certificates-custom-domains#make-a-certificate" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>So the first thing we need to do is make a certificate. This is pretty simple, and in my case amounts to the following command:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token function" style="color:#e6db74">sudo</span><span class="token plain"> openssl req </span><span class="token parameter variable" style="color:#f8f8f2">-x509</span><span class="token plain"> </span><span class="token parameter variable" style="color:#f8f8f2">-newkey</span><span class="token plain"> rsa:4096 </span><span class="token parameter variable" style="color:#f8f8f2">-sha256</span><span class="token plain"> </span><span class="token parameter variable" style="color:#f8f8f2">-days</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">3650</span><span class="token plain"> </span><span class="token parameter variable" style="color:#f8f8f2">-nodes</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token parameter variable" style="color:#f8f8f2">-keyout</span><span class="token plain"> poorclaresarundel.org.key </span><span class="token parameter variable" style="color:#f8f8f2">-out</span><span class="token plain"> poorclaresarundel.org.crt </span><span class="token parameter variable" style="color:#f8f8f2">-subj</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"/CN=poorclaresarundel.org"</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token parameter variable" style="color:#f8f8f2">-addext</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"subjectAltName=DNS:poorclaresarundel.org,DNS:www.poorclaresarundel.org,IP:8.8.8.8"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token function" style="color:#e6db74">sudo</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">chmod</span><span class="token plain"> +r poorclaresarundel.org.key</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token function" style="color:#e6db74">cat</span><span class="token plain"> poorclaresarundel.org.crt poorclaresarundel.org.key </span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token plain"> poorclaresarundel.org.pem</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This makes a certificate with a 10 year expiry date. You'll note the <code>8.8.8.8</code> listed as the IP address above. You should replace that with the static IP address of your Container Apps Environment. You can find that in the Azure Portal. It's listed on the "Overview" tab of your Azure Container App. It's the "Static IP" value:</p>
<p><img loading="lazy" alt="screenshot of the Azure Portal with the static IP address highlighted" src="https://johnnyreilly.com/assets/images/screenshot-azure-portal-static-ip-address-845e392170e60a85ab9c466e79094c1e.webp" width="1328" height="462" class="img_ev3q"></p>
<p>You'll also note the <code>poorclaresarundel.org</code> listed as the domain name above. You should replace that with your domain name. You'll need to do that in two places; in the <code>openssl</code> command and in the <code>subjectAltName</code> value. More on the significance of that particular domain name later.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="container-apps-environment-and-certificates">Container apps environment and certificates<a href="https://johnnyreilly.com/azure-container-apps-bicep-bring-your-own-certificates-custom-domains#container-apps-environment-and-certificates" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Now, we'll crack open our Azure Container App's environment in the Azure Portal and navigate to the "Certificates" tab. Then we need to click on the "Bring your own certificates (.pfx)" tab, and we are presented with a screen like this:</p>
<p><img loading="lazy" alt="Screenshot of Azure Portal on the certificates screen" src="https://johnnyreilly.com/assets/images/screenshot-azure-portal-bring-your-own-certificates-73f945036b44ae00886462b8797363a8.webp" width="1328" height="462" class="img_ev3q"></p>
<p>Note the "Add certificate" button. Use that to upload your certificate - in my case that's the <code>poorclaresarundel.org.pem</code> file. You'll need to provide the password for the certificate too. Oh and you'll be asked for a friendly name. We'll remember the friendly name you use - we'll need it later.</p>
<p>This is a real world example; my aunt's website. My aunt is Poor Clare nun and, for years, I've done an average job of maintaining her <a href="https://www.poorclaresarundel.org/" target="_blank" rel="noopener noreferrer">convent's website</a>. If I was her, I'd be wishing her nephew was a designer rather than an engineer. Or maybe an engineer with more of a sense what looks good. But here we are - she's a nun and so consequently much too nice to say that. Anyway, I digress. The point is, I've got a certificate for her website and I'm going to use it here.</p>
<p><img loading="lazy" alt="screenshot of uploaded certificate in the Azure Portal" src="https://johnnyreilly.com/assets/images/screenshot-azure-portal-bring-your-own-certificates-uploaded-5b18c325a196cf1fbaac764d0849513f.webp" width="1277" height="569" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="bicep-for-the-custom-domain">Bicep for the custom domain<a href="https://johnnyreilly.com/azure-container-apps-bicep-bring-your-own-certificates-custom-domains#bicep-for-the-custom-domain" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>I haven't managed to work out how one would handle the certificate upload in Bicep (and I rather suspect it is not supported). However, I have worked out how to handle the certificate in the Azure Container App once it's been uploaded with regards to custom domains. Find the <code>Microsoft.App/containerApps</code> resource in your Bicep and add a <code>customDomains</code> property to it. It should look something like this:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">resource</span><span class="token plain"> environment </span><span class="token string" style="color:#a6e22e">'Microsoft.App/managedEnvironments@2022-10-01'</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">name</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> environmentName</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#8292a2;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">resource</span><span class="token plain"> webServiceContainerApp </span><span class="token string" style="color:#a6e22e">'Microsoft.App/containerApps@2022-10-01'</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">name</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> webServiceContainerAppName</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">tags</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> tags</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">location</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">properties</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#8292a2;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">configuration</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">ingress</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token property" style="color:#f92672">customDomains</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">              </span><span class="token property" style="color:#f92672">name</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'www.poorclaresarundel.org'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">              </span><span class="token comment" style="color:#8292a2;font-style:italic">// note the friendly name of "poorclaresarundel.org" forms the last segment of the id below</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">              </span><span class="token property" style="color:#f92672">certificateId</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:#a6e22e">'</span><span class="token interpolated-string interpolation punctuation" style="color:#f8f8f2">${</span><span class="token interpolated-string interpolation expression">environment</span><span class="token interpolated-string interpolation expression punctuation" style="color:#f8f8f2">.</span><span class="token interpolated-string interpolation expression">id</span><span class="token interpolated-string interpolation punctuation" style="color:#f8f8f2">}</span><span class="token interpolated-string string" style="color:#a6e22e">/certificates/poorclaresarundel.org'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">              </span><span class="token property" style="color:#f92672">bindingType</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'SniEnabled'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#8292a2;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://johnnyreilly.com/azure-container-apps-bicep-bring-your-own-certificates-custom-domains#conclusion" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>With the above post you should be able to deploy an Azure Container App with a custom domain and provide your own certificate, which is then referenced using Bicep. If you'd like to see the full Bicep file, then you can find it <a href="https://github.com/johnnyreilly/poorclaresarundel-aca/blob/main/infra/main.bicep" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="attributions">Attributions<a href="https://johnnyreilly.com/azure-container-apps-bicep-bring-your-own-certificates-custom-domains#attributions" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<a href="https://www.flaticon.com/free-icons/certificate" title="certificate icons">Certificate icon in title image created by Freepik - Flaticon</a>]]></content:encoded>
            <category>azure container apps</category>
            <category>bicep</category>
        </item>
        <item>
            <title><![CDATA[TypeScript 5.1: declaring JSX element types]]></title>
            <link>https://johnnyreilly.com/typescript-5-1-declaring-jsx-element-types</link>
            <guid>https://johnnyreilly.com/typescript-5-1-declaring-jsx-element-types</guid>
            <pubDate>Tue, 19 Sep 2023 19:13:26 GMT</pubDate>
            <description><![CDATA[With TypeScript 5.1, it becomes possible for libraries to control what types are used for JSX elements. This post looks at why this matters.]]></description>
            <content:encoded><![CDATA[<p>A new feature arrives with TypeScript 5.1, <a href="https://devblogs.microsoft.com/typescript/announcing-typescript-5-1-beta/#decoupled-type-checking-between-jsx-elements-and-jsx-tag-types" target="_blank" rel="noopener noreferrer">it is described as "Decoupled Type-Checking Between JSX Elements and JSX Tag Types"</a>.</p>
<p>It's all about handing control of JSX type definitions to libraries. With this feature, libraries can control what types are used for JSX elements. Why does this matter? Great question! Until version 5.1, TypeScript did an imperfect job of representing what is possible with JSX. This feature allows libraries to do a better job of that, and we'll look into it in this post.</p>
<p>It's probably worth saying, that this is a complicated feature. If you don't understand it (and as the author of this post I'll confess that I had to work quite hard to understand it), <strong>that is okay</strong>. This is a low level feature that is only likely to be used by library / type definition authors. It's a primitive that will unlock possibilites for people writing JSX - but it's something that people will mainly feel the benefit of, without directly doing anything themselves, or necessarily noticing that things have changed for the better.</p>
<p><img loading="eager" alt="title image reading &amp;quot;TypeScript 5.1: declaring JSX element types&amp;quot; with the TypeScript logo" src="https://johnnyreilly.com/assets/images/title-image-c27519b13ccfb42822abd1b70624ae01.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="whats-the-problem">What's the problem?<a href="https://johnnyreilly.com/typescript-5-1-declaring-jsx-element-types#whats-the-problem" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>TypeScript creates a type system which sits on top of JavaScript, and provides static typing capabilities. As the language has grown more sophisticated, it has been able to get closer and closer to representing the full range of possibilities that JavaScript offers. As an example of this evolution, if you remember the early days of TypeScript, you'll remember a time before union types. Back then, you had to use <code>any</code> to represent a value that could be one of a number of types. That imperfect representation of JavaScript was solved with union types:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic">function printStringOrNumber(stringOrNumber: any) {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">function printStringOrNumber(stringOrNumber: string | number) {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   console.log(stringOrNumber);</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The problem we're looking at here is in the same vein. But it specifically applies to JSX; which is widely used in libraries like React. With JSX support in TypeScript (up to and including 5.0), it was not possible to accurately represent all JSX possibilities. This is because the type of a JSX element returned from a function component was always <code>JSX.Element | null</code>. This is a type that is defined in the TypeScript compiler, and is not something that can be changed by a library author.</p>
<p>How does this play out? Well, let's take a look at a simple example. Let's say we have a function component that returns a number. We might write something like this:</p>
<div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">function</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">ComponentThatReturnsANumber</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">42</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token tag punctuation" style="color:#f8f8f2">&lt;</span><span class="token tag class-name" style="color:#e6db74">ComponentThatReturnsANumber</span><span class="token tag" style="color:#f92672"> </span><span class="token tag punctuation" style="color:#f8f8f2">/&gt;</span><span class="token punctuation" style="color:#f8f8f2">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The above is legitimate JSX, but it is not legitimate TypeScript. The TypeScript compiler will complain:</p>
<p><img loading="lazy" alt="screenshot of typescript playground saying &amp;#39;ComponentThatReturnsANumber&amp;#39; cannot be used as a JSX component. Its return type &amp;#39;number&amp;#39; is not a valid JSX element.(2786)" src="https://johnnyreilly.com/assets/images/screenshot-typescript-playground-8ad019b0cc457082ad80d30c000bc42c.png" width="690" height="298" class="img_ev3q"></p>
<p><a href="https://www.typescriptlang.org/play?#code/JYWwDg9gTgLgBAJQKYEMDG8BmUIjgIilQ3wG4AoczAVwDsNgJa4BhXSWpWmAFQAsUMZDGpRaAZwCCAOWogARkigAKAJRwA3uThwiIsXAAsAJgoBfSgB424Jl14ChSfRJlzFUOAHoAfOSA" target="_blank" rel="noopener noreferrer">You can see this in the TypeScript Playground</a></p>
<p>This errors because function components that return anything but <code>JSX.Element | null</code> are not allowed as element types in React according to TypeScript. However, in React, function components <strong>can</strong> return a <code>ReactNode</code>. That type includes <code>number | string | Iterable&lt;ReactNode&gt; | undefined</code> (<a href="https://github.com/reactjs/rfcs/pull/229" target="_blank" rel="noopener noreferrer">and will likely include <code>Promise&lt;ReactNode&gt;</code> in the future</a>).</p>
<p>As an aside, a return value of <code>number</code> would be perfectly fine in class components - the restrictions are different there. I spoke to Sebastian about this and he said:</p>
<blockquote>
<p>An interesting note is that before function components we did have full control. Due to <code>ElementClass</code>, class components already could return <code>ReactNode</code> at the type level. It was just function components that were missing full control (or any other component types Suspense or Profiler).</p>
</blockquote>
<p>So this is the problem: is not possible to represent in TypeScript today what is actually possible in React (or other JSX libraries). Furthermore, what's returned from JSX may change over time, and TypeScript needs to be able to represent that.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-arrival-of-jsxelementtype">The arrival of <code>JSX.ElementType</code><a href="https://johnnyreilly.com/typescript-5-1-declaring-jsx-element-types#the-arrival-of-jsxelementtype" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Sebastian Silbermann <a href="https://github.com/microsoft/TypeScript/pull/51328" target="_blank" rel="noopener noreferrer">opened a pull request to TypeScript</a>. It had the title "RFC: Consult new JSX.ElementType for valid JSX element types". In that PR Sebastian explained the issue we've just looked at above, and proposed a solution. The solution was to introduce a new type, <code>JSX.ElementType</code>.</p>
<p>To illustrate the what <code>JSX.ElementType</code> actually is as compared to a JSX element, consider this illustration:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">// &lt;Component /&gt;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">//  ^^^^^^^^^    JSX element type</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">// ^^^^^^^^^^^^^ JSX element</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The significance of <code>JSX.ElementType</code> is that it is used to represent the type of a JSX element and <strong>allow library authors to control what types are used for JSX elements</strong>. This control was not available before.</p>
<p>The TypeScript pull request was merged, and so Sebastian (who helps maintain the React type definitions) exercised the new powers in <a href="https://github.com/DefinitelyTyped/DefinitelyTyped/pull/65135" target="_blank" rel="noopener noreferrer">this pull request to the DefinitelyTyped repository for the React type definitions</a>. At the time of writing, this pull request is still open, but once merged and shipped the React community will feel the benefits.</p>
<p>The changes are subtle; You can see in this pull request that <code>ReactElement | null</code> is generally replaced with <code>ReactNode</code>:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">    type JSXElementConstructor&lt;P&gt; =</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic">        | ((props: P) =&gt; ReactElement&lt;any, any&gt; | null)</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">        | ((props: P) =&gt; ReactNode)</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">        | (new (props: P) =&gt; Component&lt;any, any&gt;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Remember how we mentioned earlier on that function components couldn't return numbers? Let's look at the updated tests in the PR:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   const ReturnNumber = () =&gt; 0xeac1;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">   const FCNumber: React.FC = ReturnNumber;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   class RenderNumber extends React.Component {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">       render() {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">         return 0xeac1;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">       }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With this change, React components that return numbers are now valid JSX elements. This is because <code>JSX.ElementType</code> is now <code>ReactNode</code>, which includes numbers. Essentially this represents that new things are possible as a consequence of this change. The library and type definition author now has more control over what is possible in JSX.</p>
<p>To quote Sebastian again:</p>
<blockquote>
<p>Now we have control over any potential component type.</p>
</blockquote>
<p>Let's look again at our component that produces a number again:</p>
<div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">function</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">ComponentThatReturnsANumber</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">42</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token tag punctuation" style="color:#f8f8f2">&lt;</span><span class="token tag class-name" style="color:#e6db74">ComponentThatReturnsANumber</span><span class="token tag" style="color:#f92672"> </span><span class="token tag punctuation" style="color:#f8f8f2">/&gt;</span><span class="token punctuation" style="color:#f8f8f2">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With Sebastian's changes, this becomes valid TypeScript. And as React, and other JSX libraries evolve, TypeScript compatibility can also.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="https://johnnyreilly.com/typescript-5-1-declaring-jsx-element-types#summary" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>The TL;DR of this post is "TypeScript will better allow for the modelling of JSX in TypeScript 5.1". I'm indebted to <a href="https://github.com/eps1lon" target="_blank" rel="noopener noreferrer">Sebastian Silbermann</a> and <a href="https://github.com/DanielRosenwasser" target="_blank" rel="noopener noreferrer">Daniel Rosenwasser</a> for their explanations of this feature. Thanks in particular to Sebastian for implementing this feature and for reviewing this post.</p>
<p>I hope this post helps you understand the feature a little better.</p>
<p><a href="https://blog.logrocket.com/declaring-jsx-types-typescript-5-1/" target="_blank" rel="noopener noreferrer">This post was originally published on LogRocket.</a></p>
]]></content:encoded>
            <category>react</category>
            <category>typescript</category>
        </item>
        <item>
            <title><![CDATA[Azure Container Apps, Bicep, managed certificates and custom domains]]></title>
            <link>https://johnnyreilly.com/azure-container-apps-bicep-managed-certificates-custom-domains</link>
            <guid>https://johnnyreilly.com/azure-container-apps-bicep-managed-certificates-custom-domains</guid>
            <pubDate>Tue, 19 Sep 2023 19:13:26 GMT</pubDate>
            <description><![CDATA[Azure Container Apps support managed certificates and custom domains. However, deploying them with Bicep is not straightforward. This post explains how to do it.]]></description>
            <content:encoded><![CDATA[<p>Azure Container Apps support managed certificates and custom domains. However, deploying them with Bicep is not straightforward - although it is possible. It seems likely there's a bug in the implementation in Azure, but I'm not sure. Either way, it's possible to deploy managed certificates and custom domains using Bicep. You just need to know how.</p>
<p>If, instead, you're looking to make use of the "bring your own certificates" approach in Azure Container Apps using Bicep, then you might want to take a look at <a href="https://johnnyreilly.com/azure-container-apps-bicep-bring-your-own-certificates-custom-domains">this post on the topic</a>.</p>
<p>I've facetiously subtitled this post "a three pipe(line) problem" because it took three Azure Pipelines to get it working. This is not Azure Pipelines specific though, it's just that I was using Azure Pipelines to deploy the Bicep. Really, this applies to any way of deploying Bicep. GitHub Actions, Azure CLI or whatever.</p>
<p>If you're here because you've encountered the dread message:</p>
<blockquote>
<p><code>Creating managed certificate requires hostname '....' added as a custom hostname to a container app in environment 'caenv-appname-dev'</code></p>
</blockquote>
<p>Then you're in the right place. I'm going to explain how to get past that error message and get your custom domain working with your Azure Container App whilst still using Bicep. It's going to get ugly. But it will work.</p>
<p><img loading="eager" alt="title image reading &amp;quot;Azure Container Apps, Bicep, managed certificates and custom domains&amp;quot; with the Azure Container App logos" src="https://johnnyreilly.com/assets/images/title-image-99eeb529f7c75744d9f6863f82b04880.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="a-three-pipeline-problem">A three pipe(line) problem<a href="https://johnnyreilly.com/azure-container-apps-bicep-managed-certificates-custom-domains#a-three-pipeline-problem" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>I spent much of the last week attempting to attach a custom domain to an Azure Container App. I was using Bicep to deploy the infrastructure and I was using Azure DevOps to deploy the Bicep.</p>
<p>There wasn't any documentation I could find about this, and so I decided to try and work it out for myself. I was able to get it working, but it was a bit of a journey. I'm going to share the steps I took here in the hope that it helps someone else.</p>
<p>I titled this section "A three pipe(line) problem" because it turned out it required three Azure Pipeline runs to deploy a custom domain with a managed certificate. That, and the fact that it seemed a great way to get a Sherlock Holmes pun into the mix. I feel justified; there was no small amount of detective work involved.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="reverse-engineering-the-bicep-from-the-azure-portal">Reverse engineering the Bicep from the Azure Portal<a href="https://johnnyreilly.com/azure-container-apps-bicep-managed-certificates-custom-domains#reverse-engineering-the-bicep-from-the-azure-portal" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>I knew that to get a custom domain working with an Azure Container App I would need to do two things:</p>
<ol>
<li>Create a managed certificate on my managed environment</li>
<li>Create a custom domain on my container app</li>
</ol>
<p>So I fired up the Azure Portal and did those two things. Then I went to the export template option and downloaded the ARM template. I was hoping to see how the Azure Portal did it. Since my eyes bleed a little when I attempt to read ARM templates, I <a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/decompile?tabs=azure-cli" target="_blank" rel="noopener noreferrer">decompiled the ARM template into the Bicep equivalent</a>.</p>
<p>It actually seemed relatively simple. First there was a <a href="https://learn.microsoft.com/en-us/azure/templates/microsoft.app/2022-11-01-preview/managedenvironments/managedcertificates?pivots=deployment-language-bicep" target="_blank" rel="noopener noreferrer"><code>Microsoft.App/managedEnvironments/managedCertificates</code></a> resource which created the managed certificate:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">resource</span><span class="token plain"> managedEnvironmentManagedCertificate </span><span class="token string" style="color:#a6e22e">'Microsoft.App/managedEnvironments/managedCertificates@2022-11-01-preview'</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">parent</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> managedEnvironment</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">name</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:#a6e22e">'</span><span class="token interpolated-string interpolation punctuation" style="color:#f8f8f2">${</span><span class="token interpolated-string interpolation expression">managedEnvironment</span><span class="token interpolated-string interpolation expression punctuation" style="color:#f8f8f2">.</span><span class="token interpolated-string interpolation expression">name</span><span class="token interpolated-string interpolation punctuation" style="color:#f8f8f2">}</span><span class="token interpolated-string string" style="color:#a6e22e">-certificate'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">location</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">tags</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> tags</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">properties</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">subjectName</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> customDomainName</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">domainControlValidation</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'CNAME'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then there was the addition of a <a href="https://learn.microsoft.com/en-us/azure/templates/microsoft.app/containerapps?pivots=deployment-language-bicep#customdomain" target="_blank" rel="noopener noreferrer"><code>customDomains</code></a> property to the <code>Microsoft.App/containerApps</code> resource which referenced the managed certificate:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">resource</span><span class="token plain"> containerApp </span><span class="token string" style="color:#a6e22e">'Microsoft.App/containerApps@2022-11-01-preview'</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#8292a2;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">properties</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">configuration</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">ingress</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token property" style="color:#f92672">customDomains</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token property" style="color:#f92672">name</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> managedEnvironmentManagedCertificate</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">subjectName</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token property" style="color:#f92672">certificateId</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> managedEnvironmentManagedCertificate</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">id</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token property" style="color:#f92672">bindingType</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'SniEnabled'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#8292a2;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#8292a2;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It looked simple enough. I added those two resources to my Bicep file and ran the pipeline. It failed. I got this error:</p>
<blockquote>
<p><code>Creating managed certificate requires hostname '....' added as a custom hostname to a container app in environment 'caenv-appname-dev'</code></p>
</blockquote>
<p>Googling that error message didn't lead me to <a href="https://github.com/microsoft/azure-container-apps/issues/607" target="_blank" rel="noopener noreferrer">this issue</a> on the Azure Container Apps GitHub repo. Other people were having similar issues. I was able to gather enough clues from that issue to get me to a working approach. I may be the first person in the world to have got this far... Wouldn't that be special?</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-three-pipeline-solution">The three pipe(line) solution<a href="https://johnnyreilly.com/azure-container-apps-bicep-managed-certificates-custom-domains#the-three-pipeline-solution" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>So whilst the original approach I came up with looked like it should work, it did not. What succeeded was an approach where I ran one pipeline to deploy some Bicep, a second pipeline to deploy some tweaked Bicep, and a third pipeline to deploy some more tweaked Bicep. Then profit.</p>
<p>Herewith the details of the three pipelines / three Bicep deployments:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="bicep-template-1-create-a-disabled-custom-domain">Bicep template 1: Create a disabled custom domain<a href="https://johnnyreilly.com/azure-container-apps-bicep-managed-certificates-custom-domains#bicep-template-1-create-a-disabled-custom-domain" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Our first Bicep template is going to create a custom domain on our container app. However, we're going to set the <code>bindingType</code> property to <code>Disabled</code>.</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">resource</span><span class="token plain"> containerApp </span><span class="token string" style="color:#a6e22e">'Microsoft.App/containerApps@2022-11-01-preview'</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#8292a2;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">properties</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">configuration</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">ingress</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token property" style="color:#f92672">customDomains</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token property" style="color:#f92672">name</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> customDomainName</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token property" style="color:#f92672">bindingType</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'Disabled'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#8292a2;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#8292a2;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Deploy the above template and you'll have a custom domain on your container app, but it won't be active. This will be graduated to an active custom domain in the third Bicep template.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="bicep-template-2-create-the-managed-certificate">Bicep template 2: Create the managed certificate<a href="https://johnnyreilly.com/azure-container-apps-bicep-managed-certificates-custom-domains#bicep-template-2-create-the-managed-certificate" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Now we're going to create the managed certificate by adding the following resource to our Bicep template:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">resource</span><span class="token plain"> managedEnvironmentManagedCertificate </span><span class="token string" style="color:#a6e22e">'Microsoft.App/managedEnvironments/managedCertificates@2022-11-01-preview'</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">parent</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> managedEnvironment</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">name</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:#a6e22e">'</span><span class="token interpolated-string interpolation punctuation" style="color:#f8f8f2">${</span><span class="token interpolated-string interpolation expression">managedEnvironment</span><span class="token interpolated-string interpolation expression punctuation" style="color:#f8f8f2">.</span><span class="token interpolated-string interpolation expression">name</span><span class="token interpolated-string interpolation punctuation" style="color:#f8f8f2">}</span><span class="token interpolated-string string" style="color:#a6e22e">-certificate'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">location</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">tags</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> tags</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">properties</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">subjectName</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> customDomainName</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">domainControlValidation</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'CNAME'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>At present there's no relation between the managed certificate and the custom domain. We'll fix that in the third Bicep template. Deploy this template and you'll have a managed certificate. However, the deployment will likely fail with an following error of the following form:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">"status"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"Failed"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">"error"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">"code"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"AuthorizationFailed"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">"message"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"The client 'GUID-GOES-HERE' with object id 'GUID-GOES-HERE' does not have authorization to perform action 'Microsoft.App/locations/managedCertificateOperationStatuses/read' over scope '/subscriptions/SUBSCRIPTION-ID-GOES-HERE/providers/Microsoft.App/locations/West Europe/managedCertificateOperationStatuses/GUID-GOES-HERE' or the scope is invalid. If access was recently granted, please refresh your credentials."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Don't sweat it. You should have a managed certificate. That's what we need.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="bicep-template-3-create-an-active-custom-domain">Bicep template 3: Create an active custom domain<a href="https://johnnyreilly.com/azure-container-apps-bicep-managed-certificates-custom-domains#bicep-template-3-create-an-active-custom-domain" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Ready for the big finish? We're going to take our Bicep template back to what we originally tried:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">resource</span><span class="token plain"> managedEnvironmentManagedCertificate </span><span class="token string" style="color:#a6e22e">'Microsoft.App/managedEnvironments/managedCertificates@2022-11-01-preview'</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">parent</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> managedEnvironment</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">name</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:#a6e22e">'</span><span class="token interpolated-string interpolation punctuation" style="color:#f8f8f2">${</span><span class="token interpolated-string interpolation expression">managedEnvironment</span><span class="token interpolated-string interpolation expression punctuation" style="color:#f8f8f2">.</span><span class="token interpolated-string interpolation expression">name</span><span class="token interpolated-string interpolation punctuation" style="color:#f8f8f2">}</span><span class="token interpolated-string string" style="color:#a6e22e">-certificate'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">location</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">tags</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> tags</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">properties</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">subjectName</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> customDomainName</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">domainControlValidation</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'CNAME'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">resource</span><span class="token plain"> containerApp </span><span class="token string" style="color:#a6e22e">'Microsoft.App/containerApps@2022-11-01-preview'</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#8292a2;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">properties</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">configuration</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">ingress</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token property" style="color:#f92672">customDomains</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token property" style="color:#f92672">name</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> managedEnvironmentManagedCertificate</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">subjectName</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token property" style="color:#f92672">certificateId</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> managedEnvironmentManagedCertificate</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">id</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token property" style="color:#f92672">bindingType</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'SniEnabled'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#8292a2;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#8292a2;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#8292a2;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Note that the <code>customDomains</code> property of the <code>Microsoft.App/containerApps</code> resource now references the managed certificate and is <code>SniEnabled</code>. Deploy this template and you'll have a working managed certificate and a working custom domain on your container app. Huzzah!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://johnnyreilly.com/azure-container-apps-bicep-managed-certificates-custom-domains#conclusion" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>I write this post purely to help others who may be struggling with this. I'm assuming this is some kind of bug, and I'm hoping the Azure Container Apps team will fix it soon. I've raised a specific issue on the Azure Container Apps GitHub repo for this problem. You can find it <a href="https://github.com/microsoft/azure-container-apps/issues/796" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="attributions">Attributions<a href="https://johnnyreilly.com/azure-container-apps-bicep-managed-certificates-custom-domains#attributions" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<a href="https://www.flaticon.com/free-icons/bad-habit" title="bad habit icons">Pipe icon in title image created by Freepik - Flaticon</a>]]></content:encoded>
            <category>azure container apps</category>
            <category>bicep</category>
        </item>
        <item>
            <title><![CDATA[Private Bicep registry authentication with AzureResourceManagerTemplateDeployment@3]]></title>
            <link>https://johnnyreilly.com/private-bicep-registry-authentication-azureresourcemanagertemplatedeployment</link>
            <guid>https://johnnyreilly.com/private-bicep-registry-authentication-azureresourcemanagertemplatedeployment</guid>
            <pubDate>Tue, 19 Sep 2023 19:13:26 GMT</pubDate>
            <description><![CDATA[You can deploy Bicep to Azure with the dedicated Azure DevOps task; however authentication to private Bicep registries is not supported.  This post shares a workaround.]]></description>
            <content:encoded><![CDATA[<p>If you deploy Bicep templates to Azure in Azure DevOps, you'll likely use the dedicated Azure DevOps task; the catchily named <a href="https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/azure-resource-manager-template-deployment-v3?view=azure-pipelines" target="_blank" rel="noopener noreferrer"><code>AzureResourceManagerTemplateDeployment@3</code></a>. This task has had support for deploying Bicep since early 2022. But whilst vanilla Bicep is supported, there's a use case which isn't supported; private Bicep registries.</p>
<p><img loading="eager" alt="title image reading &amp;quot;Private Bicep registry authentication with AzureResourceManagerTemplateDeployment@3&amp;quot; with the Bicep, Azure and Azure DevOps logos" src="https://johnnyreilly.com/assets/images/title-image-b1eca5c7e68137b8d193bf8181039de0.png" width="1600" height="900" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="unable-to-restore-the-module-status-401-unauthorized">"Unable to restore the module... Status: 401 (Unauthorized)"<a href="https://johnnyreilly.com/private-bicep-registry-authentication-azureresourcemanagertemplatedeployment#unable-to-restore-the-module-status-401-unauthorized" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p><a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/private-module-registry?tabs=azure-powershell" target="_blank" rel="noopener noreferrer">Private Bicep registries</a> are a great way to share Bicep modules across your organisation. We use them in the organisation that I'm part of; it's a good a way to help us move faster and to share common security baselines.</p>
<p>Alas it turns out that the <code>AzureResourceManagerTemplateDeployment@3</code> task doesn't presently play well with private Bicep registries. This is because it's necessary to authenticate to a private registry before you can consume modules. And that's not supported by the <code>AzureResourceManagerTemplateDeployment@3</code> task. What does that mean? Well take a look at the following Azure Pipeline:</p>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> AzureResourceManagerTemplateDeployment@3</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> DeployInfra</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Deploy infra</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">retryCountOnTaskFailure</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">deploymentScope</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Resource Group</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">azureResourceManagerConnection</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> variables.serviceConnection </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">subscriptionId</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $(subscriptionId)</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">action</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Create Or Update Resource Group</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">resourceGroupName</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $(resourceGroupName)</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">location</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $(location)</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">templateLocation</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Linked artifact</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">csmFile</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'infra/main.bicep'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You'll note that it passes a Bicep file to the <code>csmFile</code> property. This is the file that will be deployed. But what if that file references modules from a private registry? Well, you'll see an error like this:</p>
<p><img loading="lazy" alt="screenshot of the failing pipeline including the text &amp;#39;Error BCP192: Unable to restore the module with reference &amp;quot;br.azurecr.io/bicep/ice/providers/document-db/database-accounts.3&amp;quot;: Service request failed.&amp;#39;" src="https://johnnyreilly.com/assets/images/screenshot-authentication-failure-6d2c5403c6ded939008de620567adabd.png" width="2016" height="740" class="img_ev3q"></p>
<p>As you can see from the <code>Status: 401 (Unauthorized)</code>, we have an authentication problem; the task doesn't know how to authenticate to the private registry.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="workaround">Workaround<a href="https://johnnyreilly.com/private-bicep-registry-authentication-azureresourcemanagertemplatedeployment#workaround" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>You might think, "oh well that's it then, I can't use private Bicep registries with the <code>AzureResourceManagerTemplateDeployment@3</code> task". But you'd be wrong. There's a workaround. Essentially, when the <code>AzureResourceManagerTemplateDeployment@3</code> task runs, it attempts to restore the modules it needs as a first step to compiling the Bicep in to ARM. But it only does this if it needs to. If we perform the restore manually first, then the task won't need to do it again. That's the trick.</p>
<p>Before the <code>AzureResourceManagerTemplateDeployment@3</code> task runs, we can run a task to restore the modules. We can use the <code>AzureCLI@2</code> task to do this. Here's an example:</p>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> AzureCLI@2</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Bicep restore</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> service</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">connection</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">with</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">access</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">to</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">registry</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> bash</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> inlineScript</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">|</span><span class="token scalar string" style="color:#a6e22e"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">      bicep restore infra/main.bicep</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Where <code>service-connection-with-access-to-registry</code> is an Azure Resource Manager service connection using service principal authentication which has access to the private Bicep registry.</p>
<p><img loading="lazy" alt="screenshot of service connection" src="https://johnnyreilly.com/assets/images/screenshot-service-connection-48c335e1124eb2d6e48ed253fcb67782.webp" width="640" height="524" class="img_ev3q"></p>
<p>So if the above task runs <em>prior</em> to the <code>AzureResourceManagerTemplateDeployment@3</code> task, then the modules will be restored and the <code>AzureResourceManagerTemplateDeployment@3</code> task will be able to compile the Bicep in to ARM and deploy it to Azure. This solves the problem; albeit at the cost of an extra task in the pipeline.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="in-the-box-in-the-future">In the box, in the future?<a href="https://johnnyreilly.com/private-bicep-registry-authentication-azureresourcemanagertemplatedeployment#in-the-box-in-the-future" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>It would be tremendous if authentication to private Bicep registries was supported by the <code>AzureResourceManagerTemplateDeployment@3</code> task. I've raised a feature request for this <a href="https://github.com/microsoft/azure-pipelines-tasks/issues/18426" target="_blank" rel="noopener noreferrer">here</a>. If you'd like to see this too, please do add your voice to the issue.</p>]]></content:encoded>
            <category>bicep</category>
            <category>azure devops</category>
        </item>
        <item>
            <title><![CDATA[Static Web Apps CLI and Node.js 18: could not connect to API]]></title>
            <link>https://johnnyreilly.com/static-web-apps-cli-node-18-could-not-connect-to-api</link>
            <guid>https://johnnyreilly.com/static-web-apps-cli-node-18-could-not-connect-to-api</guid>
            <pubDate>Tue, 19 Sep 2023 19:13:26 GMT</pubDate>
            <description><![CDATA[With Node.js 18, the Static Web Apps CLI fails to connect to the API - there is a way to fix this.]]></description>
            <content:encoded><![CDATA[<p>I make use of Azure Static Web Apps a lot. I recently upgraded to Node.js 18 and found that the Static Web Apps CLI no longer worked when trying to run locally; the API would not connect when running <code>swa start</code>:</p>
<p><code>[swa] ‚ùå Could not connect to "http://localhost:7071/". Is the server up and running?</code></p>
<p>This post shares a workaround.</p>
<p><img loading="eager" alt="title image reading &amp;quot;Static Web Apps CLI and Node.js 18: could not connect to API&amp;quot; with the Static Web Apps CLI and Node.js logos" src="https://johnnyreilly.com/assets/images/title-image-031d0022a4207916571018334832963d.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-issue">The issue<a href="https://johnnyreilly.com/static-web-apps-cli-node-18-could-not-connect-to-api#the-issue" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>My own setup is a Vite front end and a Function App back end. I have a <code>package.json</code> in the folder of the front end app with the following scripts:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token property" style="color:#f92672">"dev"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"vite"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token property" style="color:#f92672">"start"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"swa start http://localhost:5173 --run \"npm run dev\" --api-location ../FunctionApp"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>I could see both front end and back end starting up in the console, but inevitably the SWA CLI would report:</p>
<p><code>[swa] ‚ùå Could not connect to "http://localhost:7071/". Is the server up and running?</code></p>
<p>It turned out this came down to the version of Node.js I was using. I was using Node.js 18. Or rather it was due to an issue with a dependency of the Static Web Apps CLI; the <a href="https://github.com/jeffbski/wait-on" target="_blank" rel="noopener noreferrer">wait-on</a> library which waits for endpoints to become available. <a href="https://github.com/jeffbski/wait-on/issues/137" target="_blank" rel="noopener noreferrer">With Node.js 18 this is broken</a>. It's not clear a fix is imminent.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-workaround">The workaround<a href="https://johnnyreilly.com/static-web-apps-cli-node-18-could-not-connect-to-api#the-workaround" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Various workarounds are suggested in <a href="https://github.com/Azure/static-web-apps-cli/issues/663" target="_blank" rel="noopener noreferrer">this GitHub issue</a>. I shared my own there, and I'm sharing it here too. (Mostly for me, I'll lay money I need this again and again.)</p>
<p>In the root of my project I installed <a href="https://www.npmjs.com/package/concurrently" target="_blank" rel="noopener noreferrer">concurrently</a>:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">npm i concurrently</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then, again in the root of my project I added the following scripts:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token property" style="color:#f92672">"debug"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"concurrently -n \"staticwebapp,functionapp\" -c \"bgBlue.bold,bgMagenta.bold\" \"npm run debug:staticwebapp\" \"npm run debug:functionapp\""</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token property" style="color:#f92672">"debug:staticwebapp"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"cd src/StaticWebApp &amp;&amp; npm run debug"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token property" style="color:#f92672">"debug:functionapp"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"cd src/FunctionApp &amp;&amp; func start"</span><span class="token punctuation" style="color:#f8f8f2">,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>What's happening here is that I'm running the Static Web Apps CLI and the Function App CLI in separate processes, and running them concurrently when we run <code>npm run debug</code>. You'll note that the <code>debug:staticwebapp</code> script is running another <code>debug</code> script with the Static Web Apps CLI in the <code>src/StaticWebApp</code> folder:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token property" style="color:#f92672">"debug"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"swa start http://localhost:5173 --run \"npm run dev\" --api-location http://127.0.0.1:7071"</span><span class="token punctuation" style="color:#f8f8f2">,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>--api-location</code> flag is pointing to the endpoint the Function App is surfaced at. This is the key to the workaround.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="https://johnnyreilly.com/static-web-apps-cli-node-18-could-not-connect-to-api#summary" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>This takes us back to having a setup that will work with Node.js 18. Hopefully this is only needed for a short while, but it's good to have a workaround in the meantime.</p>]]></content:encoded>
            <category>azure static web apps</category>
            <category>node.js</category>
        </item>
        <item>
            <title><![CDATA[TypeScript 5: importsNotUsedAsValues replaced by ESLint consistent-type-imports]]></title>
            <link>https://johnnyreilly.com/typescript-5-importsnotusedasvalues-error-eslint-consistent-type-imports</link>
            <guid>https://johnnyreilly.com/typescript-5-importsnotusedasvalues-error-eslint-consistent-type-imports</guid>
            <pubDate>Tue, 19 Sep 2023 19:13:26 GMT</pubDate>
            <description><![CDATA[TypeScript deprecated tsconfig.json option "importsNotUsedAsValues": "error" in 5. You can make type imports explicit with CommonJS if you use ESLint consistent-type-imports.]]></description>
            <content:encoded><![CDATA[<p>I really like type imports that are unambiguous. For this reason, I've made use of the <code>"importsNotUsedAsValues": "error"</code> option in <code>tsconfig.json</code> for a while now. This option has been deprecated in TypeScript 5.0.0, and will be removed in TypeScript 5.5.0. This post will look at what you can do instead.</p>
<p><img loading="eager" alt="title image reading &amp;quot;TypeScript 5: importsNotUsedAsValues replaced by ESLint consistent-type-imports&amp;quot; with the ESLint and TypeScript logo" src="https://johnnyreilly.com/assets/images/title-image-be1079a13c4ed4213afb6c3bc59929f8.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-importsnotusedasvalues-error-provided">What <code>"importsNotUsedAsValues": "error"</code> provided<a href="https://johnnyreilly.com/typescript-5-importsnotusedasvalues-error-eslint-consistent-type-imports#what-importsnotusedasvalues-error-provided" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Prior to TypeScript 5.0, if you wanted to make your type imports explicit, you could use the <code>"importsNotUsedAsValues": "error"</code> option in <code>tsconfig.json</code>. This would mean that you would need to use <code>import type</code> for type imports, and <code>import</code> for value imports. Consider the following:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> ResourceGraphClient </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'@azure/arm-resourcegraph'</span><span class="token punctuation" style="color:#f8f8f2">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In my code I was only using <code>ResourceGraphClient</code> as a type, so I would need to change it to:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">type</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> ResourceGraphClient </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'@azure/arm-resourcegraph'</span><span class="token punctuation" style="color:#f8f8f2">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><em>or</em></p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">type</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">ResourceGraphClient</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'@azure/arm-resourcegraph'</span><span class="token punctuation" style="color:#f8f8f2">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And if I rebelled, the TypeScript compiler would complain:</p>
<blockquote>
<p><code>This import is never used as a value and must use 'import type' because 'importsNotUsedAsValues' is set to 'error'.ts(1371)</code></p>
</blockquote>
<p><img loading="lazy" alt="screenshot of VS Code displaying the error message" src="https://johnnyreilly.com/assets/images/screenshot-importsnotusedasvalues-error-fcc2dbd3e13f8b925176a36b1775e0ec.png" width="1634" height="136" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="typescript-5-deprecates-importsnotusedasvalues">TypeScript 5 deprecates <code>importsNotUsedAsValues</code><a href="https://johnnyreilly.com/typescript-5-importsnotusedasvalues-error-eslint-consistent-type-imports#typescript-5-deprecates-importsnotusedasvalues" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>However, when I upgraded to TypeScript 5, I started seeing the following error:</p>
<blockquote>
<p><code>Option 'importsNotUsedAsValues' is deprecated and will stop functioning in TypeScript 5.5. Specify compilerOption '"ignoreDeprecations": "5.0"' to silence this error. Use 'verbatimModuleSyntax' instead.</code></p>
</blockquote>
<p><img loading="lazy" alt="screenshot of VS Code displaying the error message" src="https://johnnyreilly.com/assets/images/screenshot-importsnotusedasvalues-deprecated-e487158e065f86b9861edd1b79f934a1.png" width="1996" height="288" class="img_ev3q"></p>
<p>The error was the result of <a href="https://github.com/microsoft/TypeScript/pull/52203" target="_blank" rel="noopener noreferrer">this pull request</a>. The message made me think I just needed to migrate to <code>verbatimModuleSyntax</code>, like so:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">tsconfig.json</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic">    "importsNotUsedAsValues": "error",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">    "verbatimModuleSyntax": true,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>However, when I did so, my terminal became a sea of errors:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">src/telemetry.ts:7:13 - error TS1286: ESM syntax is not allowed </span><span class="token keyword" style="color:#66d9ef">in</span><span class="token plain"> a CommonJS module when </span><span class="token string" style="color:#a6e22e">'verbatimModuleSyntax'</span><span class="token plain"> is enabled.</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token function" style="color:#e6db74">import</span><span class="token plain"> * as task from </span><span class="token string" style="color:#a6e22e">'./task.json'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            ~~~~</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">src/telemetry.ts:9:1 - error TS1287: A top-level </span><span class="token string" style="color:#a6e22e">'export'</span><span class="token plain"> modifier cannot be used on value declarations </span><span class="token keyword" style="color:#66d9ef">in</span><span class="token plain"> a CommonJS module when </span><span class="token string" style="color:#a6e22e">'verbatimModuleSyntax'</span><span class="token plain"> is enabled.</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token builtin class-name" style="color:#e6db74">export</span><span class="token plain"> async </span><span class="token keyword" style="color:#66d9ef">function</span><span class="token plain"> sendTelemetry</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">{</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It turns out that in <code>verbatimModuleSyntax</code>, you can't write ESM syntax in files that will emit as CommonJS - which is exactly what my codebase is doing. <a href="https://github.com/andrewbranch" target="_blank" rel="noopener noreferrer">Andrew Branch</a>, who is part of the TypeScript team, sent me an explanation from a draft of some new TypeScript docs:</p>
<blockquote>
<p>In TypeScript 5.0, a new compiler option called <code>verbatimModuleSyntax</code> was introduced to help TypeScript authors know exactly how their <code>import</code> and <code>export</code> statements will be emitted. When enabled, the flag requires imports and exports in input files to be written in the form that will undergo the least amount of transformation before emit. So if a file will be emitted as ESM, imports and exports must be written in ESM syntax; if a file will be emitted as CJS, it must be written in the CommonJS-inspired TypeScript syntax (<code>import fs = require("fs")</code> and <code>export = {}</code>). This setting is particularly recommended for Node projects that use mostly ESM, but have a select few CJS files. It is not recommended for projects that currently target CJS, but may want to target ESM in the future.</p>
</blockquote>
<p>It further turns out that <code>importsNotUsedAsValues</code> was never intended to be used in in the way that I did; effectively as a linting mechanism. Andrew <a href="https://github.com/microsoft/TypeScript/pull/52203#issuecomment-1476574601" target="_blank" rel="noopener noreferrer">said this on the topic</a>:</p>
<blockquote>
<p><code>importsNotUsedAsValues</code> was made to serve the opposite purpose you (and basically everyone) were using it for. By default, TypeScript elides unneeded import statements from JS emit even without marking them as <code>type</code> imports. <code>importsNotUsedAsValues</code> was created as a way to escape that behavior, not (primarily) to make it more explicit. <code>verbatimModuleSyntax</code> allows you to escape the elision behavior, and takes the explicitness of what your imports mean a step further by making you write CJS-style imports when emitting to CJS. So in my book, all the important cases that <code>importsNotUsedAsValues</code> (and <code>preserveValueImports</code>) covered, plus more, are covered by <code>verbatimModuleSyntax</code>, which is way more explainable. It‚Äôs mostly a matter of reducing complexity for the sake of explanation.</p>
</blockquote>
<p>Until the world has finished migrating to ES Modules (which will be a while), I'm going to need to stick with CommonJS as my emit target, whilst still planning to write ES Module imports in my code. But I really like being explicit about my imports. So what can I do?</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="eslint-and-typescript-eslintconsistent-type-imports-to-the-rescue">ESLint and <code>@typescript-eslint/consistent-type-imports</code> to the rescue<a href="https://johnnyreilly.com/typescript-5-importsnotusedasvalues-error-eslint-consistent-type-imports#eslint-and-typescript-eslintconsistent-type-imports-to-the-rescue" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>I mentioned that I was using <code>importsNotUsedAsValues</code> essentially as a linting mechanism. And it transpires that the answer to my need lives in ESLint itself. There's a rule named <a href="https://typescript-eslint.io/rules/consistent-type-imports/" target="_blank" rel="noopener noreferrer"><code>@typescript-eslint/consistent-type-imports</code></a> which tackles exactly this. If you're using <a href="https://eslint.org/" target="_blank" rel="noopener noreferrer">ESLint</a> and <a href="https://typescript-eslint.io/" target="_blank" rel="noopener noreferrer">typescript-eslint</a>, you can add this rule to your <code>.eslintrc.js</code>:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">eslintrc.js</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">module</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#8292a2;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token literal-property property" style="color:#f92672">rules</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#8292a2;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token string-property property" style="color:#f92672">'@typescript-eslint/consistent-type-imports'</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'error'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// the replacement of "importsNotUsedAsValues": "error"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Or if you prefer to have the type imports inline, you can use:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">eslintrc.js</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">module</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#8292a2;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token literal-property property" style="color:#f92672">rules</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#8292a2;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token string-property property" style="color:#f92672">'@typescript-eslint/consistent-type-imports'</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token string" style="color:#a6e22e">'error'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token literal-property property" style="color:#f92672">fixStyle</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'inline-type-imports'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// the replacement of "importsNotUsedAsValues": "error"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With this in place, we're back to where we were before; just with a different engine:</p>
<blockquote>
<p>All imports in the declaration are only used as types. Use <code>import type</code>.eslint@typescript-eslint/consistent-type-imports</p>
</blockquote>
<p><img loading="lazy" alt="screenshot of VS Code displaying the error message" src="https://johnnyreilly.com/assets/images/screenshot-consistent-type-imports-error-59b29a8f0f9abd25698909d03e1804a1.png" width="1662" height="142" class="img_ev3q"></p>
<p>And we even have the ability to auto-fix the errors as well now. Thanks <code>typescript-eslint</code>!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="no-import-type-side-effects"><code>no-import-type-side-effects</code><a href="https://johnnyreilly.com/typescript-5-importsnotusedasvalues-error-eslint-consistent-type-imports#no-import-type-side-effects" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>We are not quite done. There's another typescript-eslint rule that we can use to help us. <a href="https://typescript-eslint.io/rules/no-import-type-side-effects/" target="_blank" rel="noopener noreferrer"><code>no-import-type-side-effects</code></a> is a rule that will warn you if you have any side effects in your type imports. What does that mean? Well, consider the following code:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">type</span><span class="token plain"> </span><span class="token class-name constant" style="color:#e6db74">A</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">type</span><span class="token plain"> </span><span class="token class-name constant" style="color:#e6db74">B</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'mod'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">// is transpiled to</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'mod'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">// which is the same as</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'mod'</span><span class="token punctuation" style="color:#f8f8f2">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You may not want a runtime import at all. You can do that by using a <strong>top-level</strong> <code>type</code> qualifier for imports when it only imports specifiers with an inline <code>type</code> qualifier:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">type</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> </span><span class="token constant" style="color:#e6db74">A</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token constant" style="color:#e6db74">B</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'mod'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">// is transpiled to.... nothing! Hence no side effects</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>So if side effects is something you're concerned about, consider this rule as well. Note that whether <code>import { type A } from 'mod'</code> transpiles to a side-effect import or gets completely removed depends on your <code>tsc</code> options, or what transpiler you‚Äôre using. But <code>import type</code> statements <em>always</em> get removed.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="https://johnnyreilly.com/typescript-5-importsnotusedasvalues-error-eslint-consistent-type-imports#summary" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Thanks to Andrew Branch for reviewing this post, and massively improving it! Any mistakes are mine, not his.</p>]]></content:encoded>
            <category>typescript</category>
            <category>javascript</category>
        </item>
        <item>
            <title><![CDATA[Migrating Azure Functions from JSDoc JavaScript to TypeScript]]></title>
            <link>https://johnnyreilly.com/migrating-azure-functions-from-jsdoc-javascript-to-typescript</link>
            <guid>https://johnnyreilly.com/migrating-azure-functions-from-jsdoc-javascript-to-typescript</guid>
            <pubDate>Tue, 19 Sep 2023 19:13:26 GMT</pubDate>
            <description><![CDATA[Azure Functions can be written in JavaScript or TypeScript. This post will demonstrate how to migrate an Azure Function from JSDoc JavaScript to TypeScript.]]></description>
            <content:encoded><![CDATA[<p>I wrote previously about how to implement a <a href="https://johnnyreilly.com/azure-static-web-apps-dynamic-redirects-azure-functions">dynamic redirect mechanism for Azure Static Web Apps using Azure Functions</a>. I implemented this using JSDoc JavaScript. I've since migrated this to TypeScript and I thought it would be interesting to share the process.</p>
<p><img loading="eager" alt="title image reading &amp;quot;Migrating Azure Functions from JSDoc JavaScript to TypeScript&amp;quot; with the JS and TS logos and Azure Functions logo" src="https://johnnyreilly.com/assets/images/title-image-5eea9bdd73ed508fa201183e5a711590.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="why-migrate-from-jsdoc-javascript-to-typescript">Why migrate from JSDoc JavaScript to TypeScript?<a href="https://johnnyreilly.com/migrating-azure-functions-from-jsdoc-javascript-to-typescript#why-migrate-from-jsdoc-javascript-to-typescript" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>As regular readers will know, I'm both a big fan of TypeScript and a big fan of JSDoc JavaScript. I think both are great. So why migrate from JSDoc JavaScript to TypeScript? For me it's mostly about the developer experience; JSDoc is more verbose, and the wider ecosystem does a lot more TypeScript than it does JSDoc JavaScript. So when you get beyond a simple application, for me at least, TypeScript is a better choice.</p>
<p><a href="https://johnnyreilly.com/" target="_blank" rel="noopener noreferrer">My blog</a> is an <a href="https://docs.microsoft.com/en-us/azure/static-web-apps/overview" target="_blank" rel="noopener noreferrer">Azure Static Web App</a> with an Azure Functions back end. I've been using JSDoc JavaScript for my Azure Functions. This post will take the back end and migrate it to TypeScript. There's various affordances that I have in place already that I don't want to lose along the way:</p>
<ul>
<li>I can debug in VS Code</li>
<li>I deploy using GitHub Actions</li>
<li>I have automated tests in place using Jest</li>
</ul>
<p>All of these affordances are available to me with TypeScript, and I want to keep them. Let's begin migrating. Incidentally, the code for this migration <a href="https://github.com/johnnyreilly/blog.johnnyreilly.com/pull/558" target="_blank" rel="noopener noreferrer">lies in this PR</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="migrating-the-tsconfigjson">Migrating the <code>tsconfig.json</code><a href="https://johnnyreilly.com/migrating-azure-functions-from-jsdoc-javascript-to-typescript#migrating-the-tsconfigjson" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Our <code>tsconfig.json</code> manages the way the TypeScript compiler interacts with our code. We'll start by migrating this:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">tsconfig.json</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> "compilerOptions": {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic">    "noEmit": true,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">    "noEmit": false,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">    "outDir": "dist",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">    "rootDir": ".",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">    "sourceMap": true,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">    "allowJs": false,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">    "checkJs": false,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">    "moduleResolution": "node",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Let's look at the changes we've made:</p>
<ul>
<li>We're now emitting files from our compilation thanks to <code>noEmit</code> being set to <code>false</code>. We will no longer be actually running the code we write, but we will run the JavaScript we emit.</li>
<li>We're specifying an <code>outDir</code> of <code>dist</code> - this is where our compiled JavaScript will be emitted.</li>
<li>We're specifying a <code>rootDir</code> of <code>.</code> - this is the root of our TypeScript source files.</li>
<li>We're creating source maps for our emitted JavaScript files - this will help us debug our original source code. (Even though we're not running it.)</li>
<li>We're no longer allowing JavaScript files to be part of our program thanks to <code>allowJs</code> being set to <code>false</code>. (And we're not checking them either thanks to <code>checkJs</code> being set to <code>false</code> - I suspect this is implicitly set to <code>false</code> to <code>allowJs</code> being <code>false</code> - just to be clear I've specified it.)</li>
<li>We're specifying a <code>moduleResolution</code> of <code>node</code> - this is how TypeScript will look up a file from a given module specifier.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="migrating-the-packagejson">Migrating the <code>package.json</code><a href="https://johnnyreilly.com/migrating-azure-functions-from-jsdoc-javascript-to-typescript#migrating-the-packagejson" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>To migrate our <code>package.json</code> we'll need to add some dependencies and tweak our scripts:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">package.json</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> "scripts": {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   "build": "tsc",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">    "watch": "tsc -w",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">    "prestart": "npm run build",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   "start": "func start",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   "test": "jest"</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> },</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> "devDependencies": {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   "@azure/functions": "^3.5.0",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">    "@types/jest": "^29.2.5",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">    "@types/node": "^18.x",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   "jest": "^29.3.1",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">    "ts-jest": "^29.1.0",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   "typescript": "^5.0.0"</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We're adding two scripts:</p>
<ul>
<li><code>watch</code> - this will watch our TypeScript files and recompile them when they change - we don't need this really; but it can be useful depending on your preferred workflow.</li>
<li><code>prestart</code> - this will run before <code>start</code> and will ensure our TypeScript files are compiled, and we have up to date JavaScript to run.</li>
</ul>
<p>In our <code>devDependencies</code> we're adding dependencies for Jest and Node.js. We're also adding <code>ts-jest</code> which will allow us to run Jest tests written in TypeScript.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="migrating-vscodesettingsjson-and-vscodetasksjson">Migrating <code>.vscode/settings.json</code> and <code>.vscode/tasks.json</code><a href="https://johnnyreilly.com/migrating-azure-functions-from-jsdoc-javascript-to-typescript#migrating-vscodesettingsjson-and-vscodetasksjson" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>I mentioned debugging earlier - to get that in place we need to work on the <code>settings.json</code> and <code>tasks.json</code> files in the <code>.vscode</code> folder. First the <code>settings.json</code>:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">settings.json</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic">  "azureFunctions.projectLanguage": "JavaScript",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">  "azureFunctions.projectLanguage": "TypeScript",</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The above is pretty self explanatory. We're changing the language of our Azure Functions project from JavaScript to TypeScript. Now the <code>tasks.json</code>:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">tasks.json</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> "version": "2.0.0",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> "tasks": [</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">    {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">      "type": "shell",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">      "label": "npm build (functions)",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">      "command": "npm run build",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">      "dependsOn": "npm install (functions)",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">      "problemMatcher": "$tsc",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">      "options": {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">        "cwd": "${workspaceFolder}/blog-website/api"</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">      }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">    },</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> ]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We've got a new task in place here that runs our <code>npm run build</code> script. This will compile our TypeScript files to JavaScript. We've also got a <code>cwd</code> set to <code>blog-website/api</code> - this is the folder where our Azure Functions live - your own will likely be different. Alongside this new script, there's some tweaks to existing tasks to make them depend on our new build task:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">tasks.json</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> "version": "2.0.0",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> "tasks": [</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     "type": "func",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     "label": "func: host start",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     "command": "host start",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     "problemMatcher": "$func-node-watch",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     "isBackground": true,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">      "dependsOn": "npm build (functions)",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">      "options": {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">        "cwd": "${workspaceFolder}/blog-website/api"</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">      }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   },</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   // ...</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     "type": "shell",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     "label": "npm prune (functions)",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     "command": "npm prune --production",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">      "dependsOn": "npm build (functions)",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     "problemMatcher": [],</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     "options": {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">       "cwd": "${workspaceFolder}/blog-website/api"</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> ]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="migrate-our-azure-functions">Migrate our Azure Functions<a href="https://johnnyreilly.com/migrating-azure-functions-from-jsdoc-javascript-to-typescript#migrate-our-azure-functions" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>This isn't going to be an exhaustive guide of migrating from JSDoc JavaScript to TypeScript. I'm going to focus on the things that I found most relevant to Azure Functions. Let's start with the <code>fallback/function.json</code> file that powers our dynamic redirects and lives at <code>/api/fallback</code>:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">fallback/function.json</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> "bindings": [</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     "authLevel": "anonymous",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     "type": "httpTrigger",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     "direction": "in",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     "name": "req",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     "methods": ["get", "post"]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   },</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     "type": "http",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     "direction": "out",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     "name": "res"</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> ],</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token unchanged line"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">  "scriptFile": "../dist/fallback/index.js"</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>There's one addition here, to repoint the <code>scriptFile</code> to the compiled JavaScript.</p>
<p>Now let's look at the code for the function. Originally a JavaScript file named <code>index.js</code>; it must be renamed to <code>index.ts</code>. The original code looked like this:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">fallback/index.js</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> redirect </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">require</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">'./redirect'</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> saveToDatabase </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">require</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">'./saveToDatabase'</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic">/**</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> *</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:#66d9ef;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">{</span><span class="token doc-comment comment class-name" style="color:#e6db74;font-style:italic"> </span><span class="token doc-comment comment class-name keyword" style="color:#66d9ef;font-style:italic">import</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">(</span><span class="token doc-comment comment class-name string" style="color:#a6e22e;font-style:italic">"@azure/functions"</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">)</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">.</span><span class="token doc-comment comment class-name" style="color:#e6db74;font-style:italic">Context </span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">}</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> </span><span class="token doc-comment comment parameter" style="color:#8292a2;font-style:italic">context</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:#66d9ef;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">{</span><span class="token doc-comment comment class-name" style="color:#e6db74;font-style:italic"> </span><span class="token doc-comment comment class-name keyword" style="color:#66d9ef;font-style:italic">import</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">(</span><span class="token doc-comment comment class-name string" style="color:#a6e22e;font-style:italic">"@azure/functions"</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">)</span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">.</span><span class="token doc-comment comment class-name" style="color:#e6db74;font-style:italic">HttpRequest </span><span class="token doc-comment comment class-name punctuation" style="color:#f8f8f2;font-style:italic">}</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> </span><span class="token doc-comment comment parameter" style="color:#8292a2;font-style:italic">req</span><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token doc-comment comment" style="color:#8292a2;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">async</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">function</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">fallback</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token parameter">context</span><span class="token parameter punctuation" style="color:#f8f8f2">,</span><span class="token parameter"> req</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#8292a2;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">module</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> fallback</span><span class="token punctuation" style="color:#f8f8f2">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After renaming to <code>index.ts</code> and adding some TypeScript types, it looks like this:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">fallback/index.ts</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">type</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> AzureFunction</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> Context</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> HttpRequest </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'@azure/functions'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> redirect </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'./redirect'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> saveToDatabase </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'./saveToDatabase'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> httpTrigger</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token function-variable function" style="color:#e6db74">AzureFunction</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">async</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  context</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> Context</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  req</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> HttpRequest</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token builtin" style="color:#e6db74">Promise</span><span class="token operator" style="color:#66d9ef">&lt;</span><span class="token keyword" style="color:#66d9ef">void</span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#8292a2;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">export</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">default</span><span class="token plain"> httpTrigger</span><span class="token punctuation" style="color:#f8f8f2">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As we can see, the type importing becomes much more succinct. We're also exporting the function as <code>default</code> rather than <code>module.exports</code>. This is because we're using ES Modules rather than CommonJS modules for authoring. We can also see that we're using <code>import</code> rather than <code>require</code> to import our functions. Whilst CommonJS was more straightforward to use, the syntax for ES Modules feels much nicer to use; at least to me. (It's worth noting that we're not using ES Modules in our compiled JavaScript - we're still using CommonJS there; but we don't need to think about that when we're writing our code.)</p>
<p>I won't walk through migrating the other files, but the process is the same. Rename the file to <code>.ts</code>, add TypeScript types, and use <code>import</code> rather than <code>require</code>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="migrating-our-tests">Migrating our tests<a href="https://johnnyreilly.com/migrating-azure-functions-from-jsdoc-javascript-to-typescript#migrating-our-tests" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>We're pretty much on the home stretch now; we just need to migrate our tests. Let's start with the <code>jest.config.js</code>:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">jest.config.js</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">  preset: 'ts-jest',</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">  testPathIgnorePatterns: ['&lt;rootDir&gt;/node_modules/', '&lt;rootDir&gt;/dist/'],</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We're adding a <code>preset</code> of <code>ts-jest</code> which will allow us to run TypeScript tests. If you recall we added the <code>ts-jest</code> dependency earlier; it was for this.</p>
<p>We're also adding <code>dist</code> to our <code>testPathIgnorePatterns</code> - this is because we don't want to run our tests against our compiled JavaScript - we'd end up running the tests twice without this.</p>
<p>Let's turn our attention to the tests directly. Again we do the classic rename from <code>.js</code> to <code>.ts</code>, and our imports become terser and more ES Module-y:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">redirect.test.ts</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic">/**</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"> * @typedef { import("@azure/functions").Logger } Logger</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"> */</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">import type { Logger } from '@azure/functions';</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic">const { describe, expect, test } = require('@jest/globals');</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">import { describe, expect, test } from '@jest/globals';</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic">const redirect = require('./redirect');</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">import { redirect } from './redirect';</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Beautiful. Finally we've got some tweaks to the code of the tests themselves. Firstly, declaring our mock becomes much easier:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">redirect.test.ts</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic">/** @type {jest.Mock&lt;Logger&gt;} */ const mockLogger = jest.fn();</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">const mockLogger: jest.Mock&lt;Logger&gt; = jest.fn();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Secondly, casting our mock to the type we want is much more straightforward:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">redirect.test.ts</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted prefix deleted" style="color:#f92672;font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic">/** @type {any} */ (mockLogger)</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-sign deleted line" style="color:#f92672;font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">mockLogger as unknown as Logger</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>I have no real how to <code>as</code> cast twice in JSDoc - and now I don't need to.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://johnnyreilly.com/migrating-azure-functions-from-jsdoc-javascript-to-typescript#conclusion" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>We now have a TypeScript Azure Functions codebase, with all of the debugging / testing / deployment affordances we had before. We didn't have to do anything around deployment, because it just works‚Ñ¢Ô∏è. I hope this post has been useful to you!</p>]]></content:encoded>
            <category>azure functions</category>
            <category>typescript</category>
            <category>javascript</category>
        </item>
        <item>
            <title><![CDATA[Docusaurus: Structured Data FAQs with MDX]]></title>
            <link>https://johnnyreilly.com/docusaurus-structured-data-faqs-mdx</link>
            <guid>https://johnnyreilly.com/docusaurus-structured-data-faqs-mdx</guid>
            <pubDate>Tue, 19 Sep 2023 19:13:26 GMT</pubDate>
            <description><![CDATA[This demos how to make an MDX component that renders FAQs into a page, and the same information as Structured Data. It also shows how to use it with Docusaurus.]]></description>
            <content:encoded><![CDATA[<p>I've written previously about <a href="https://johnnyreilly.com/structured-data-seo-and-react">using Structured Data with React</a>. This post goes a little further and talks about how to use Structured Data with Docusaurus and MDX. More specifically it looks at how to create a component that both renders FAQs into a page, and the same information as Structured Data.</p>
<p><img loading="eager" alt="title image reading &amp;quot;Docusaurus: Structured Data FAQs with MDX&amp;quot; with a Docusaurus logo" src="https://johnnyreilly.com/assets/images/title-image-1744a099fb4f8f7d7022a2936756dcb7.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="faqs-and-structured-data">FAQs and Structured Data<a href="https://johnnyreilly.com/docusaurus-structured-data-faqs-mdx#faqs-and-structured-data" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>I've been working with <a href="https://growtika.com/" target="_blank" rel="noopener noreferrer">Growtika</a> to repair my SEO after <a href="https://johnnyreilly.com/how-i-ruined-my-seo">shredding it somehow last year</a>. One of the experiments we ran was to add <a href="https://johnnyreilly.com/migrating-from-github-pages-to-azure-static-web-apps">FAQs to a post</a>, and with that, the equivalent FAQ Structured Data. The intent being to see if this would help with the SEO for that post.</p>
<p>My blog is written in <a href="https://mdxjs.com/" target="_blank" rel="noopener noreferrer">MDX</a>, and hosted on <a href="https://docusaurus.io/" target="_blank" rel="noopener noreferrer">Docusaurus</a>. I wanted to see if I could create an MDX component that would render the FAQs into a page, and the same information as Structured Data. The <a href="https://docusaurus.io/docs/markdown-features/react" target="_blank" rel="noopener noreferrer">Docusaurus docs suggested this was feasible</a>, and I wanted to see if I could make it work.</p>
<p>And it turns out that other people are interested in this too; there's a feature request on <a href="https://docusaurus.io/feature-requests/p/creation-of-structured-faq" target="_blank" rel="noopener noreferrer">Docusaurus's Canny</a> for exactly this.</p>
<p>So I created a component that could be used to render FAQs into a page as markdown, and the same information as Structured Data. I thought it would be useful to share that component with the world. Hello world, herewith the component:</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-faqstructureddata-mdx-component">The FAQStructuredData MDX component<a href="https://johnnyreilly.com/docusaurus-structured-data-faqs-mdx#the-faqstructureddata-mdx-component" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>I created a directory called <code>FAQStructuredData</code> in the ``src/theme/MDXComponents<code>directory. This directory is where I keep my custom MDX components. I then created an</code>index.js` file in that directory. This is the file that contains the component:</p>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">src/theme/MDXComponents/FAQStructuredData/index.js</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#8292a2;font-style:italic">/**</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#8292a2;font-style:italic"> * @typedef { import('./types').FAQStructuredDataProps } FAQStructuredDataProps</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#8292a2;font-style:italic"> * @typedef { import('./types').FAQStructuredData } FAQStructuredData</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#8292a2;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword module" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">React</span><span class="token plain"> </span><span class="token keyword module" style="color:#66d9ef">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'react'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">/**</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#8292a2;font-style:italic"> * A component that renders a FAQ structured data and markdown entries</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#8292a2;font-style:italic"> *</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#8292a2;font-style:italic"> * @see https://developers.google.com/search/docs/appearance/structured-data/faqpage</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#8292a2;font-style:italic"> * @param {FAQStructuredDataProps} props</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#8292a2;font-style:italic"> * @returns</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#8292a2;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword module" style="color:#66d9ef">export</span><span class="token plain"> </span><span class="token keyword module" style="color:#66d9ef">default</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">function</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#e6db74">FAQStructuredData</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token parameter">props</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#8292a2;font-style:italic">/** @type {FAQStructuredData} */</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> faqStructuredData </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token string-property property" style="color:#f92672">'@context'</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'https://schema.org'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token string-property property" style="color:#f92672">'@type'</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'FAQPage'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token literal-property property" style="color:#f92672">mainEntity</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> props</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">faqs</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#e6db74">map</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token parameter">faq</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#66d9ef">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token string-property property" style="color:#f92672">'@type'</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'Question'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token literal-property property" style="color:#f92672">name</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> faq</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">question</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token literal-property property" style="color:#f92672">acceptedAnswer</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token string-property property" style="color:#f92672">'@type'</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'Answer'</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token literal-property property" style="color:#f92672">text</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> faq</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">answer</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token tag punctuation" style="color:#f8f8f2">&lt;</span><span class="token tag punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:#f8f8f2">&lt;</span><span class="token tag" style="color:#f92672">script</span><span class="token tag" style="color:#f92672"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token tag" style="color:#f92672">        </span><span class="token tag attr-name" style="color:#a6e22e !important">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#f8f8f2">=</span><span class="token tag attr-value punctuation" style="color:#f8f8f2">"</span><span class="token tag attr-value" style="color:#f92672">application/ld+json</span><span class="token tag attr-value punctuation" style="color:#f8f8f2">"</span><span class="token tag" style="color:#f92672"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token tag" style="color:#f92672">        </span><span class="token tag attr-name" style="color:#a6e22e !important">dangerouslySetInnerHTML</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#f8f8f2">=</span><span class="token tag script language-javascript punctuation" style="color:#f8f8f2">{</span><span class="token tag script language-javascript punctuation" style="color:#f8f8f2">{</span><span class="token tag script language-javascript" style="color:#f92672"> </span><span class="token tag script language-javascript literal-property property" style="color:#f92672">__html</span><span class="token tag script language-javascript operator" style="color:#66d9ef">:</span><span class="token tag script language-javascript" style="color:#f92672"> </span><span class="token tag script language-javascript known-class-name class-name" style="color:#e6db74">JSON</span><span class="token tag script language-javascript punctuation" style="color:#f8f8f2">.</span><span class="token tag script language-javascript method function property-access" style="color:#e6db74">stringify</span><span class="token tag script language-javascript punctuation" style="color:#f8f8f2">(</span><span class="token tag script language-javascript" style="color:#f92672">faqStructuredData</span><span class="token tag script language-javascript punctuation" style="color:#f8f8f2">)</span><span class="token tag script language-javascript" style="color:#f92672"> </span><span class="token tag script language-javascript punctuation" style="color:#f8f8f2">}</span><span class="token tag script language-javascript punctuation" style="color:#f8f8f2">}</span><span class="token tag" style="color:#f92672"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token tag" style="color:#f92672">      </span><span class="token tag punctuation" style="color:#f8f8f2">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain-text"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:#f8f8f2">&lt;</span><span class="token tag" style="color:#f92672">h2</span><span class="token tag punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain-text">FAQs</span><span class="token tag punctuation" style="color:#f8f8f2">&lt;/</span><span class="token tag" style="color:#f92672">h2</span><span class="token tag punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain-text">      </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain">faqStructuredData</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">mainEntity</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#e6db74">map</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token parameter">faq</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#66d9ef">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token tag punctuation" style="color:#f8f8f2">&lt;</span><span class="token tag class-name" style="color:#e6db74">React.Fragment</span><span class="token tag" style="color:#f92672"> </span><span class="token tag attr-name" style="color:#a6e22e !important">key</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#f8f8f2">=</span><span class="token tag script language-javascript punctuation" style="color:#f8f8f2">{</span><span class="token tag script language-javascript" style="color:#f92672">faq</span><span class="token tag script language-javascript punctuation" style="color:#f8f8f2">.</span><span class="token tag script language-javascript property-access" style="color:#f92672">name</span><span class="token tag script language-javascript punctuation" style="color:#f8f8f2">}</span><span class="token tag punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain-text">          </span><span class="token tag punctuation" style="color:#f8f8f2">&lt;</span><span class="token tag" style="color:#f92672">h3</span><span class="token tag punctuation" style="color:#f8f8f2">&gt;</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain">faq</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">name</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token tag punctuation" style="color:#f8f8f2">&lt;/</span><span class="token tag" style="color:#f92672">h3</span><span class="token tag punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain-text">          </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain">faq</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">acceptedAnswer</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">text</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain-text">        </span><span class="token tag punctuation" style="color:#f8f8f2">&lt;/</span><span class="token tag class-name" style="color:#e6db74">React.Fragment</span><span class="token tag punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:#f8f8f2">&lt;/</span><span class="token tag punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">src/theme/MDXComponents/FAQStructuredData/types.d.ts</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">export</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">interface</span><span class="token plain"> </span><span class="token class-name constant" style="color:#e6db74">FAQ</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  question</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token builtin" style="color:#e6db74">string</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  answer</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token builtin" style="color:#e6db74">string</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">export</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">interface</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">FAQStructuredDataProps</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  faqs</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token constant" style="color:#e6db74">FAQ</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">export</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">interface</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">FAQStructuredData</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token string-property property" style="color:#f92672">'@context'</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token builtin" style="color:#e6db74">string</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token string-property property" style="color:#f92672">'@type'</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token builtin" style="color:#e6db74">string</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  mainEntity</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> FAQQuestionStructuredData</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">export</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">interface</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">FAQQuestionStructuredData</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token string-property property" style="color:#f92672">'@type'</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'Question'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  name</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token builtin" style="color:#e6db74">string</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  acceptedAnswer</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token string-property property" style="color:#f92672">'@type'</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'Answer'</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    text</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token builtin" style="color:#e6db74">string</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Some things to note about this component:</p>
<ul>
<li>The code is written in JavaScript, but it's using <a href="https://johnnyreilly.com/typescript-vs-jsdoc-javascript">TypeScript types via JSDoc</a>. I don't believe you can write MDX components in TypeScript (please someone let me know if it turns out this is possible). But static typing is useful, and still possible thanks to JSDoc.</li>
<li>On that, we have a <code>types.d.ts</code> file that contains the types for the component. Using TypeScript directly is still possible alongside JSDoc, as long as there is no runtime code in the file, and a definition file (which the <code>types.d.ts</code> file is), has no runtime code. We can simply use it to store types that we import into the component.</li>
<li>The component expects an <code>faqs</code> prop. This is an array of FAQs. Each FAQ is an object with a <code>question</code> and <code>answer</code> property. The component then renders the FAQs as markdown, and the same information as JSON-LD Structured Data. We're using the Google guidelines for <a href="https://developers.google.com/search/docs/appearance/structured-data/faqpage#examples" target="_blank" rel="noopener noreferrer">FAQ Structured Data</a>.</li>
<li>The component renders a <code>h2</code> tag titled "FAQs". Under that, each FAQ is rendered with a <code>h3</code> tag and the answer sits directly below it.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="importing-our-mdx-component">Importing our MDX component<a href="https://johnnyreilly.com/docusaurus-structured-data-faqs-mdx#importing-our-mdx-component" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Now the <code>FAQStructuredData</code> component is created, we can use it in our MDX (or straight MD) files. We can import the component and create an array called <code>faqs</code> like so:</p>
<div class="language-mdx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-mdx codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">---</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">slug: docusaurus-structured-data-faqs-mdx</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">title: 'Docusaurus: Structured Data FAQs with MDX'</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">authors: johnnyreilly</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">tags: [Docusaurus, Structured Data]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">image: ./title-image.png</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">description: 'This demos how to make an MDX component that renders FAQs into a page, and the same information as Structured Data. It also shows how to use it with Docusaurus.'</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">hide_table_of_contents: false</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">---</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">import FAQStructuredData from '../../src/theme/MDXComponents/FAQStructuredData';</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">export const faqs = [</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    question: 'How do I use the FAQ Structured Data component?',</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    answer:</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      "Simply create an import statement for the component and then use it in your MDX file. You'll need to pass in an array of FAQs. This array can be inline, you can declare it as a variable, or you can import it from another file.",</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    question: 'How do I use the FAQ Structured Data component in a blog post?',</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    answer:</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      'The usage is the same as in a regular MDX file. But the import statement will sit after the frontmatter of the blog post.',</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    question:</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      'Can I use the FAQ Structured Data component in a regular MD file?',</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    answer: 'Yes! It just works‚Ñ¢Ô∏è.',</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">];</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Note we're doing this in a blog post and the import statement is after the frontmatter. Then we can use the component like so:</p>
<div class="language-mdx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-mdx codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">&lt;FAQStructuredData faqs={faqs} /&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We'll do that, right here, right now:</p>
<script type="application/ld+json">{"@context":"https://schema.org","@type":"FAQPage","mainEntity":[{"@type":"Question","name":"How do I use the FAQ Structured Data component?","acceptedAnswer":{"@type":"Answer","text":"Simply create an import statement for the component and then use it in your MDX file. You'll need to pass in an array of FAQs. This array can be inline, you can declare it as a variable, or you can import it from another file."}},{"@type":"Question","name":"How do I use the FAQ Structured Data component in a blog post?","acceptedAnswer":{"@type":"Answer","text":"The usage is the same as in a regular MDX file. But the import statement will sit after the frontmatter of the blog post."}},{"@type":"Question","name":"Can I use the FAQ Structured Data component in a regular MD file?","acceptedAnswer":{"@type":"Answer","text":"Yes! It just works‚Ñ¢Ô∏è."}}]}</script><h2>FAQs</h2><h3>How do I use the FAQ Structured Data component?</h3>Simply create an import statement for the component and then use it in your MDX file. You'll need to pass in an array of FAQs. This array can be inline, you can declare it as a variable, or you can import it from another file.<h3>How do I use the FAQ Structured Data component in a blog post?</h3>The usage is the same as in a regular MDX file. But the import statement will sit after the frontmatter of the blog post.<h3>Can I use the FAQ Structured Data component in a regular MD file?</h3>Yes! It just works‚Ñ¢Ô∏è.<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="testing-the-structured-data">Testing the Structured Data<a href="https://johnnyreilly.com/docusaurus-structured-data-faqs-mdx#testing-the-structured-data" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>You can see, we have FAQs rendered in the body of our blog post. If we put the URL of the post into the <a href="https://search.google.com/test/rich-results?url=https%3A%2F%2Fjohnnyreilly.com%2Fdocusaurus-structured-data-faqs-mdx" target="_blank" rel="noopener noreferrer">Google Structured Data Testing Tool</a>, we can see that the Structured Data is being rendered correctly:</p>
<p><img loading="lazy" alt="Screenshot of rich results test showing FAQs are detected" src="https://johnnyreilly.com/assets/images/screenshot-rich-results-test-c50a3d132af9bb640a6a9dc706b85ac3.webp" width="686" height="259" class="img_ev3q"></p>
<p>We can even go one better, shortly after I posted this article, I did a search in Google for "how do you have Docusaurus with Structured Data FAQs with MDX" and I got this:</p>
<p><img loading="lazy" alt="A screenshot of the Google search window with the search &amp;#39;how do you have Docusaurus with Structured Data FAQs with MDX&amp;#39; and the FAQs showing up as a featured snippet" src="https://johnnyreilly.com/assets/images/screenshot-featured-snippets-faqs-9fc55a288126bae232305c9c43f19194.webp" width="889" height="445" class="img_ev3q"></p>
<p>That's our FAQs being surfaced as a <a href="https://support.google.com/websearch/answer/9351707?hl=en-GB&amp;visit_id=638180439903372599-4066254776&amp;p=featured_snippets&amp;rd=1#zippy=%2Cwhy-featured-snippets-may-be-removed" target="_blank" rel="noopener noreferrer">featured snippet</a>. Nice!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://johnnyreilly.com/docusaurus-structured-data-faqs-mdx#conclusion" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>We've now got a reusable FAQs component that renders the FAQs as markdown, and the same information as Structured Data. We can use it in our MDX files, and we can use it in our blog posts. We can also use it in regular MD files. Yay! I've only used this in the context of Docusaurus, but I suspect it can be used in other contexts too.</p>
<p>I'd rather like it if this was built into Docusaurus, and if it could read directly from the Markdown files. But this is a good start. I hope you find it useful.</p>]]></content:encoded>
            <category>docusaurus</category>
            <category>seo</category>
        </item>
        <item>
            <title><![CDATA[Bicep user defined types and Bash single item arrays]]></title>
            <link>https://johnnyreilly.com/bicep-user-defined-types-and-bash-single-item-arrays</link>
            <guid>https://johnnyreilly.com/bicep-user-defined-types-and-bash-single-item-arrays</guid>
            <pubDate>Tue, 19 Sep 2023 19:13:26 GMT</pubDate>
            <description><![CDATA[The error "Expected a value of type \'Array\', but received a value of type \'String\'", presents when wrestling with the AZ CLI, Bash single item arrays and Bicep.]]></description>
            <content:encoded><![CDATA[<p>When sending a single item array to a Bicep template you may get an error like this:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">ERROR: InvalidTemplate - Deployment template validation failed: </span><span class="token string" style="color:#a6e22e">'Template parameter '</span><span class="token plain">allowedIPAddresses</span><span class="token string" style="color:#a6e22e">' was provided an invalid value. Expected a value of type '</span><span class="token plain">Array</span><span class="token string" style="color:#a6e22e">', but received a value of type '</span><span class="token plain">String'.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is down to the fact that Bash arrays when used with the Azure CLI can be a little surprising. If we initialise a single item array then it's not an array. It's a string. This is a bit of a pain when you're trying to pass a single item array to a Bicep template. It's possible to work around this with JSON and Bicep user defined types. Let's see how.</p>
<p><img loading="eager" alt="title image reading &amp;quot;Bicep user defined types and Bash single item arrays&amp;quot; with a Bicep logo" src="https://johnnyreilly.com/assets/images/title-image-ad052f8c8859dde8b4c7d099dcd82943.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="expected-a-value-of-type-array-but-received-a-value-of-type-string">Expected a value of type 'Array', but received a value of type 'String'<a href="https://johnnyreilly.com/bicep-user-defined-types-and-bash-single-item-arrays#expected-a-value-of-type-array-but-received-a-value-of-type-string" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>I had a Bicep template that took a parameter of type <code>array</code>:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">param</span><span class="token plain"> allowedIPAddresses </span><span class="token datatype class-name" style="color:#e6db74">array</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>I was invoking this template using the Azure CLI, in a Bash script. (Technically using GitHub Actions; but that's somewhat by the by.) I wanted to pass a single item array to the template. I did this:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">az deployment group create </span><span class="token punctuation" style="color:#f8f8f2">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  --resource-group testgroup </span><span class="token punctuation" style="color:#f8f8f2">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  --template-file </span><span class="token operator" style="color:#66d9ef">&lt;</span><span class="token plain">path-to-template</span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token parameter variable" style="color:#f8f8f2">--parameters</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#f8f8f2">allowedIPAddresses</span><span class="token operator" style="color:#66d9ef">=</span><span class="token string" style="color:#a6e22e">'("8.8.8.8")'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Surprisingly, this resulted in the error:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">ERROR: InvalidTemplate - Deployment template validation failed: </span><span class="token string" style="color:#a6e22e">'Template parameter '</span><span class="token plain">allowedIPAddresses</span><span class="token string" style="color:#a6e22e">' was provided an invalid value. Expected a value of type '</span><span class="token plain">Array</span><span class="token string" style="color:#a6e22e">', but received a value of type '</span><span class="token plain">String'.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Despite following the <a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/templates/deploy-cli#inline-parameters" target="_blank" rel="noopener noreferrer">documentation for passing arrays</a>, passing a single item array to the template did not work.</p>
<p>I'm not the only person who has wrestled with this. There's a <a href="https://github.com/Azure/bicep/issues/5936" target="_blank" rel="noopener noreferrer">GitHub issue</a> on the Bicep repo that discusses this. The issue is that Bash arrays when used with the Azure CLI can be a little surprising. If I initialise a single item array then it's not an array. It's a string. This is a bit of a pain when you're trying to pass a single item array to a Bicep template.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="workaround-json-and-bicep-user-defined-types">Workaround: JSON and Bicep user defined types<a href="https://johnnyreilly.com/bicep-user-defined-types-and-bash-single-item-arrays#workaround-json-and-bicep-user-defined-types" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>There are ways to make the array syntax work, but they're not very intuitive. I wanted to avoid this; I put a premium on understanding my code and make choices to optimise for that. The solution I came up with was to use JSON and Bicep user defined types.</p>
<p>Passing JSON to the Azure CLI is pretty easy. You just need to wrap the JSON in single quotes. I could do this:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token assign-left variable" style="color:#f8f8f2">anArrayInJSON</span><span class="token operator" style="color:#66d9ef">=</span><span class="token string" style="color:#a6e22e">'{"allowedIPAddresses":["8.8.8.8"]}'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">az deployment group create </span><span class="token punctuation" style="color:#f8f8f2">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token parameter variable" style="color:#f8f8f2">--name</span><span class="token plain"> showJSON  </span><span class="token punctuation" style="color:#f8f8f2">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    --resource-group myResourceGroup </span><span class="token punctuation" style="color:#f8f8f2">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    --template-file </span><span class="token variable" style="color:#f8f8f2">$templateFile</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token parameter variable" style="color:#f8f8f2">--parameters</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#f8f8f2">anArrayInJSON</span><span class="token operator" style="color:#66d9ef">=</span><span class="token string" style="color:#a6e22e">"</span><span class="token string variable" style="color:#f8f8f2">$anArrayInJSON</span><span class="token string" style="color:#a6e22e">"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The syntax is very simple and, as we can see, it's possible to have properties which are arrays. This is great. I can pass a JSON object to the Azure CLI and it'll be parsed correctly. So I can do this:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">param</span><span class="token plain"> anArrayInJSON </span><span class="token datatype class-name" style="color:#e6db74">object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">var</span><span class="token plain"> allowedIPAddresses </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> anArrayInJSON</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">allowedIPAddresses</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This works, but I miss the type safety of Bicep. I want to be able to say that <code>allowedIPAddresses</code> is an array. And if I can go further, I'd like to say it's a <code>string</code> array also. I can do this with a <a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/user-defined-data-types" target="_blank" rel="noopener noreferrer">Bicep user defined type</a>. It's worth noting that user defined types are a new feature in Bicep and you'll need to use the latest version of Bicep to use them and opt in by putting this option in your <code>bicepconfig.json</code> file:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">"experimentalFeaturesEnabled"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">"userDefinedTypes"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token boolean" style="color:#ae81ff">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With that in place we can redefine <code>anArrayInJSON</code> as a user defined type:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">param</span><span class="token plain"> anArrayInJSON </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">allowedIPAddresses</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is a little more verbose, but it's a lot more explicit. We're saying that <code>anArrayInJSON</code> is an object with a property called <code>allowedIPAddresses</code> which is an array of strings. This is great. We can now use <code>anArrayInJSON.allowedIPAddresses</code> in our template and we'll get type safety. We'll also get helpful error messages if we pass the wrong type of data to the template:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">ERROR: InvalidTemplate - Deployment template validation failed: </span><span class="token string" style="color:#a6e22e">'Template parameter '</span><span class="token plain">anArrayInJSON.allowedIPAddresses</span><span class="token string" style="color:#a6e22e">' was provided an invalid value. Expected a value of type '</span><span class="token plain">Array</span><span class="token string" style="color:#a6e22e">', but received a value of type '</span><span class="token plain">Null</span><span class="token string" style="color:#a6e22e">'. Please see https://aka.ms/arm-create-parameter-file for usage details.'</span><span class="token builtin class-name" style="color:#e6db74">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://johnnyreilly.com/bicep-user-defined-types-and-bash-single-item-arrays#conclusion" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Interestingly, I'd say that I'm unlikely to ever use a Bicep parameter of type <code>array</code> again, precisely for the reason that I've outlined here. So none of this:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">param</span><span class="token plain"> anArray </span><span class="token datatype class-name" style="color:#e6db74">array</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And none of its user defined type equivalent:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">param</span><span class="token plain"> anArray </span><span class="token datatype class-name" style="color:#e6db74">string</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token punctuation" style="color:#f8f8f2">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>I'll probably use the approach I've outlined here instead. I'll pass a JSON object to the template and then use a user defined type to define the properties of that object. This is a little more verbose, but it's a lot more explicit. I think that's a good trade-off.</p>]]></content:encoded>
            <category>bicep</category>
        </item>
        <item>
            <title><![CDATA[Bicep: Link Azure Application Insights to Static Web Apps]]></title>
            <link>https://johnnyreilly.com/bicep-link-azure-application-insights-to-static-web-apps</link>
            <guid>https://johnnyreilly.com/bicep-link-azure-application-insights-to-static-web-apps</guid>
            <pubDate>Tue, 17 Oct 2023 19:35:54 GMT</pubDate>
            <description><![CDATA[Learn how to link Azure Application Insights to an Azure Static Web App using Bicep.]]></description>
            <content:encoded><![CDATA[<p>If you're looking into a Production issue with your Azure Static Web App, you'll want to be able to get to your logs as fast as possible. You can do this by linking your Static Web App to an Azure Application Insights instance. If you've used the Azure Portal to create your Static Web App, the setup phase will likely have done this for you already. But if you're using Bicep to create your Static Web App, you'll need to do this yourself.</p>
<p>This post will show you how to do that using Bicep.</p>
<p><img loading="eager" alt="title image reading &amp;quot;Link Azure Application Insights to Static Web Apps with Bicep&amp;quot; with the Bicep and Azure Static Web App logos" src="https://johnnyreilly.com/assets/images/title-image-bd6790656cd89e64fd25edbe986a6759.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="a-linked-azure-application-insights-instance">A linked Azure Application Insights instance<a href="https://johnnyreilly.com/bicep-link-azure-application-insights-to-static-web-apps#a-linked-azure-application-insights-instance" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>What we want to achieve can be summmed up by this screenshot:</p>
<p><img loading="lazy" alt="screenshot of the Azure Portal displaying the App Insights tab of a Static Web App, with a linked App Insights in view" src="https://johnnyreilly.com/assets/images/screenshot-azure-portal-open-in-application-insights-3bebf715a5d08241d7e350bb8915b347.png" width="919" height="464" class="img_ev3q"></p>
<p>Inside the Azure Portal, inside our Static Web App, we want to see the App Insights tab and we want to see a linked App Insights instance. We do. But how?</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="bicep-linking">Bicep linking<a href="https://johnnyreilly.com/bicep-link-azure-application-insights-to-static-web-apps#bicep-linking" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>The Bicep code to achieve this is pretty simple:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">static-web-app.bicep</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">var</span><span class="token plain"> tagsWithHiddenLinks </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">union</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">'hidden-link: /app-insights-resource-id'</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> appInsightsId</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">'hidden-link: /app-insights-instrumentation-key'</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> appInsightsInstrumentationKey</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">'hidden-link: /app-insights-conn-string'</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> appInsightsConnectionString</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> tags</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">resource</span><span class="token plain"> staticWebApp </span><span class="token string" style="color:#a6e22e">'Microsoft.Web/staticSites@2022-09-01'</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">name</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> staticWebAppName</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">location</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">tags</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> tagsWithHiddenLinks </span><span class="token comment" style="color:#8292a2;font-style:italic">// &lt;--- here</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">sku</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">name</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'Free'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">tier</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'Free'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">properties</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">repositoryUrl</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'https://github.com/johnnyreilly/blog.johnnyreilly.com'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">repositoryToken</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> repositoryToken</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">branch</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> branch</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">provider</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'GitHub'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">stagingEnvironmentPolicy</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">'Enabled'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">allowConfigFileUpdates</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token boolean" style="color:#ae81ff">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">buildProperties</span><span class="token operator" style="color:#66d9ef">:</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">skipGithubActionWorkflowGeneration</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token boolean" style="color:#ae81ff">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Consider the code above; it's a fairly standard Bicep resource declaration for a Static Web App. The only difference is the <code>tags</code> property. We're using the <code>union</code> function to add three additional tags to the <code>tags</code> property that has been passed into the <code>static-web-app.bicep</code> module. These tags are the <code>hidden-link</code> tags that link the Static Web App to the App Insights instance.</p>
<p>Luke Murray has a great post on <a href="https://luke.geek.nz/azure/hidden-tags-in-azure/" target="_blank" rel="noopener noreferrer"><code>hidden-</code> tags in Azure</a> that I recommend you read if you want to know more about them. Essentially, hidden tags are tags that don't show up in the Azure Portal and have some metadata purpose. <code>hidden-link</code> tags are a subset of those that are used to link resources together.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="where-would-you-get-the-values-for-the-hidden-link-tags">Where would you get the values for the <code>hidden-link</code> tags?<a href="https://johnnyreilly.com/bicep-link-azure-application-insights-to-static-web-apps#where-would-you-get-the-values-for-the-hidden-link-tags" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>In the case of the <code>hidden-link</code> tags we're using here, we need to know the <code>id</code>, <code>InstrumentationKey</code> and <code>ConnectionString</code> of the App Insights instance we want to link to. We can get these values from the App Insights instance itself. Because of the way Bicep works, it's necessary to get those in a parent module to the Static Web App module. Here's an example:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">resource</span><span class="token plain"> appInsightsResource </span><span class="token string" style="color:#a6e22e">'Microsoft.Insights/components@2020-02-02'</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">existing</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">name</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> appInsightsName</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">module</span><span class="token plain"> staticWebApp </span><span class="token string" style="color:#a6e22e">'./static-web-app.bicep'</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">name</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:#a6e22e">'</span><span class="token interpolated-string interpolation punctuation" style="color:#f8f8f2">${</span><span class="token interpolated-string interpolation expression function" style="color:#e6db74">deployment</span><span class="token interpolated-string interpolation expression punctuation" style="color:#f8f8f2">(</span><span class="token interpolated-string interpolation expression punctuation" style="color:#f8f8f2">)</span><span class="token interpolated-string interpolation expression punctuation" style="color:#f8f8f2">.</span><span class="token interpolated-string interpolation expression">name</span><span class="token interpolated-string interpolation punctuation" style="color:#f8f8f2">}</span><span class="token interpolated-string string" style="color:#a6e22e">-staticWebApp'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">params</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#8292a2;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">appInsightsId</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> appInsightsResource</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">id</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">appInsightsConnectionString</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> appInsightsResource</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ConnectionString</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">appInsightsInstrumentationKey</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> appInsightsResource</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">InstrumentationKey</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#8292a2;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="https://johnnyreilly.com/bicep-link-azure-application-insights-to-static-web-apps#summary" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>With this is place we have the linking we need to get to our logs quickly as we navigate around inside the Azure Portal. And we have it in place in a way that's repeatable and consistent. I hope you find this useful.</p>]]></content:encoded>
            <category>azure</category>
            <category>bicep</category>
            <category>azure static web apps</category>
        </item>
        <item>
            <title><![CDATA[Teams Direct Message API with Power Automate]]></title>
            <link>https://johnnyreilly.com/ms-teams-direct-message-api</link>
            <guid>https://johnnyreilly.com/ms-teams-direct-message-api</guid>
            <pubDate>Tue, 12 Sep 2023 19:17:41 GMT</pubDate>
            <description><![CDATA[Teams does not have a public API for sending direct messages to people rather than channels. This post describes a workaround using Power Automate and the Teams Notification API.]]></description>
            <content:encoded><![CDATA[<p>I've written previously about <a href="https://johnnyreilly.com/teams-notification-webhooks">sending Teams notifications using a webhook</a>, and it's a technique I've used a lot. But I've always wanted to be able to send a direct message to a user, and that's not possible with the webhook approach. I work with a marvellous fellow named Chris Tacey-Green, and he's figured out a way to do this using Power Automate and the Teams Notification API. I'm going to describe how he did it here, with a little help from him.</p>
<p>It's probably worth saying, both Chris and I work for Investec, and we're going to share some of the things we've learned about using Teams and Power Automate in the hope that it's useful to others. But we're not speaking on behalf of Investec, and we're not suggesting that this is the best way to do things. This is likely in the "do things that do not scale" category. Significantly though, it works!</p>
<p>You will see some screenshots of our internal Teams environment, but we've tried to keep them to a minimum, and we're not going to share any sensitive information.</p>
<p><img loading="eager" alt="title image reading &amp;quot;Teams Direct Message API with Power Automate&amp;quot; with a Teams logo" src="https://johnnyreilly.com/assets/images/title-image-a6e4f918adb5839bf03ac87c472924d7.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-are-we-trying-to-do">What are we trying to do?<a href="https://johnnyreilly.com/ms-teams-direct-message-api#what-are-we-trying-to-do" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Teams is a great way to keep people informed of what's going on. But sometimes you want to send a message to a specific person. You can @mention them in a channel, but that's not the same as a direct message. And you can send them an email, but that's not the same as a direct message either. What we want is a way to send a direct message to a user in Teams, via an API. Because we want to automate. Tragically, sending DMs in Teams via an API is not supported at the time of writing (or if it is - please let us know!)</p>
<p>All is not lost.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="power-automate">Power Automate<a href="https://johnnyreilly.com/ms-teams-direct-message-api#power-automate" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Power Automate is a tool that allows you to automate tasks. It's a low-code/no-code tool that allows you to create workflows that can be triggered by events. It's a great tool for automating tasks. And it's a great tool for sending direct messages in Teams. Or so it turns out.</p>
<p>You see, it's possible to send a notification to a user in Teams using the Teams Notification API. And it's possible to trigger a Power Automate workflow using the "when a new channel message is added" trigger. So if we can get a notification to the Teams Notification API, we can trigger a Power Automate workflow. And if we can trigger a Power Automate workflow, we can send a direct message to a user in Teams.</p>
<p>This post will do two things:</p>
<ol>
<li>Describe how to set up a Power Automate workflow that sends a direct message to a user in Teams</li>
<li>Describe how to trigger that workflow using the Teams Notification API and Adaptive Card messages</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="setting-up-the-power-automate-workflow">Setting up the Power Automate workflow<a href="https://johnnyreilly.com/ms-teams-direct-message-api#setting-up-the-power-automate-workflow" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>First things first, we need to create a Power Automate workflow that sends a direct message to a user in Teams. This is pretty straightforward, but when it came to doing this, I knew <em>nothing</em>.</p>
<p>Before we start this, I should warn you there's going to be lots of screenshots. As far as I'm aware, there's not a code-first way to create Power Automate flows, so point and click is the only game in town.</p>
<p>The first thing to do, is fire up Teams and install the Power Automate app:</p>
<p><img loading="lazy" alt="screenshot of installing the Power Automate app" src="https://johnnyreilly.com/assets/images/screenshot-power-automate-app-93008b2c2df59ecd1e4240befd8fc089.webp" width="1808" height="600" class="img_ev3q"></p>
<p>This allows us to access the Power Automate app. There we can create a new workflow (from blank) with the "when a new channel message is added" trigger:</p>
<p><img loading="lazy" alt="screenshot of creating the Power Automate flow with the when a new channel message is added trigger" src="https://johnnyreilly.com/assets/images/screenshot-power-automate-when-a-new-channel-message-is-added-9acde451426fcf22b86a9fff4b7fc335.webp" width="2692" height="1152" class="img_ev3q"></p>
<p>We then need to select the team and channel that we want to trigger the workflow:</p>
<p><img loading="lazy" alt="screenshot of selecting the team and channel" src="https://johnnyreilly.com/assets/images/screenshot-power-automate-team-and-channel-630a906c51baeb51d01e32f138e5b633.webp" width="2692" height="692" class="img_ev3q"></p>
<p>You'll note in the screenshot above, we've got a dedicated channel for this workflow. This is because we don't want to disturb channels people are already using with the messages we will write to this channel. To all intents and purposes, this channel could actually be invisible to users - we just need it to exist to be our carrier pidgeon.</p>
<p>With the trigger in place, we need to create the action. We're going to use the "apply to each" control, which will run for every message that comes through. We want to use the "Message mentions" output, which will give us the user that was mentioned in the message. We don't want to use the similarly named "Message mentions item":</p>
<p><img loading="lazy" alt="screenshot of selecting the output from previous steps" src="https://johnnyreilly.com/assets/images/screenshot-power-automate-select-output-previous-steps-ee81326b0a8ea1edfba388c90da51d5a.webp" width="2702" height="1410" class="img_ev3q"></p>
<p>The message mention gives us our user, we'll then use the "Get user profile (V2)" operation so we can look up that user up.</p>
<p>It's at this point, that we start to do something slightly more complicated in the Power Automate UI. We're going to need to supply an id to the "Get user profile (V2)" operation. We're going to use an expression to determine this id. The expression we're going to use is:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">triggerOutputs()?['body/mentions'][0].mentioned.user.id</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This expression is operating on JSON similar to the following:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">"@odata.type"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"#microsoft.graph.chatMessage"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">"etag"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"1683099494281"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">"messageType"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"message"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">"createdDateTime"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"2023-05-03T07:38:14.281Z"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">"lastModifiedDateTime"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"2023-05-03T07:38:14.281Z"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#8292a2;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">"mentions"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">"id"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">"mentionText"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"John Reilly"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">"mentioned"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token property" style="color:#f92672">"application"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token null keyword" style="color:#66d9ef">null</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token property" style="color:#f92672">"device"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token null keyword" style="color:#66d9ef">null</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token property" style="color:#f92672">"conversation"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token null keyword" style="color:#66d9ef">null</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token property" style="color:#f92672">"tag"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token null keyword" style="color:#66d9ef">null</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token property" style="color:#f92672">"user"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token property" style="color:#f92672">"@odata.type"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"#microsoft.graph.teamworkUserIdentity"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token property" style="color:#f92672">"id"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"my-id-it-is-a-guid"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token property" style="color:#f92672">"displayName"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"John Reilly"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token property" style="color:#f92672">"userIdentityType"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"aadUser"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#8292a2;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>So that expression is just some JavaScript that gets us to the value we need; the id of the first mentioned user. We provide that in the "Expression" field and then click the "OK" button:</p>
<p><img loading="lazy" alt="screenshot of entering that into PA" src="https://johnnyreilly.com/assets/images/screenshot-power-automate-expression1-ce474f69aee8463faeaeae87a29e0d75.webp" width="2702" height="1410" class="img_ev3q"></p>
<p>Now it's time for our final action - sending on the message with the "post card in chat or channel" operation:</p>
<p><img loading="lazy" alt="screenshot of adding a post card entry" src="https://johnnyreilly.com/assets/images/screenshot-power-automate-post-card-3a126a984889704f0a60fe98812f22e4.webp" width="2702" height="1622" class="img_ev3q"></p>
<p>We'll post as the Flow bot, post in a chat with the Flow bot and make our recipient "Mail" (which behind the scenes is the expression <code>outputs('Get_user_profile_(V2)')?['body/mail']</code>).</p>
<p><img loading="lazy" alt="screenshot of adding the recipient mail" src="https://johnnyreilly.com/assets/images/screenshot-power-automate-recipient-mail-f1b5de50e8651cc1643403275627140f.webp" width="2702" height="1642" class="img_ev3q"></p>
<p>Finally, it's once more expression time, as we use this value for our Adaptive Card:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">triggerOutputs()?['body/attachments'][0]['content']</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img loading="lazy" alt="screenshot of entering expression" src="https://johnnyreilly.com/assets/images/screenshot-power-automate-expression2-90b50b16b563542f6f4f837e91c85e27.webp" width="2702" height="1714" class="img_ev3q"></p>
<p>Hopefully, what you've realised is that we're just taking the Adaptive Card from the message that triggered the workflow and passing it on to the recipient. We're intentionally doing as little as possible in the Power Automate workflow, as it's the trickiest part of our solution to work with. (Debugging Power Automate workflows is possible, but it's not the most fun you'll ever have.)</p>
<p>We now have our complete workflow, and it looks like this:</p>
<p><img loading="lazy" alt="screenshot of the Power Automate workflow" src="https://johnnyreilly.com/assets/images/screenshot-power-automate-workflow-7dc937469082c29ba7d6b13a7f1b8db4.webp" width="1324" height="1522" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="triggering-the-power-automate-workflow">Triggering the Power Automate workflow<a href="https://johnnyreilly.com/ms-teams-direct-message-api#triggering-the-power-automate-workflow" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Whilst we have a workflow, we don't have anything to trigger it yet. To do that, we'll need to send a message to the channel we created earlier. We can do this using the Teams Notification API. And it needs to be a special kind of message; it needs to be an Adaptive Card, which includes a mention of the person we want to direct message.</p>
<p>My post on <a href="https://johnnyreilly.com/teams-notification-webhooks">sending Teams notifications using a webhook</a> describes how to send a message to a channel using the Teams Notification API. We're going to use the same technique, but we're going to send an <a href="https://github.com/Microsoft/AdaptiveCards/" target="_blank" rel="noopener noreferrer">Adaptive Card</a> instead of a plain message. I won't repeat the details of creating a webhook connector here, instead let's just focus on what we need to send to the API.</p>
<p>Ultimately, it's just a <a href="https://johnnyreilly.com/node-18-axios-and-unsafe-legacy-renegotiation-disabled">POST request to the webhook connector</a>, with a JSON body that looks like this:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">"type"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"message"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">"attachments"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">"contentType"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"application/vnd.microsoft.card.adaptive"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">"contentUrl"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token null keyword" style="color:#66d9ef">null</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token property" style="color:#f92672">"content"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token property" style="color:#f92672">"type"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"AdaptiveCard"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token property" style="color:#f92672">"version"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"1.0"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token property" style="color:#f92672">"body"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token property" style="color:#f92672">"type"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"TextBlock"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token property" style="color:#f92672">"size"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"medium"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token property" style="color:#f92672">"text"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"Hey &lt;at&gt;John Reilly&lt;/at&gt;!\n\nYou have 102 unresolved secret findings! Click on the button below to view them."</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token property" style="color:#f92672">"wrap"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token boolean" style="color:#ae81ff">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token property" style="color:#f92672">"$schema"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"http://adaptivecards.io/schemas/adaptive-card.json"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token property" style="color:#f92672">"msteams"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token property" style="color:#f92672">"entities"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">              </span><span class="token property" style="color:#f92672">"type"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"mention"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">              </span><span class="token property" style="color:#f92672">"text"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"&lt;at&gt;John Reilly&lt;/at&gt;"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">              </span><span class="token property" style="color:#f92672">"mentioned"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token property" style="color:#f92672">"id"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"John.Reilly@investec.co.uk"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token property" style="color:#f92672">"name"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"John Reilly"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">              </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token property" style="color:#f92672">"actions"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token property" style="color:#f92672">"type"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"Action.OpenUrl"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token property" style="color:#f92672">"title"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"View findings"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token property" style="color:#f92672">"url"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"https://some.url.com/"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token property" style="color:#f92672">"role"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">"button"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The part that's relevant to us is the <code>msteams</code> property. This is where we specify the user we want to mention. We do this by specifying the <code>id</code> and <code>name</code> properties. The <code>id</code> property is the email address of the user we want to mention. The <code>name</code> property is the display name of the user we want to mention.</p>
<p>This is the secret sauce that allows our Power Automate flow to work. It reads these values and uses them to send a message to the user we want to mention. Alongside that, the <code>msteams.entities[].text</code> property must be in your message body. That's what Teams uses to link the mention to the part of the message that's "doing the mentioning" (thanks Chris for pointing this out).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="testing-it-out">Testing it out<a href="https://johnnyreilly.com/ms-teams-direct-message-api#testing-it-out" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>So far, so screenshots and code. Does it work? Let's find out.</p>
<p>When we run our tool for triggering the Teams Notification API, we get a message in our channel:</p>
<p><img loading="lazy" alt="screenshot of the adaptive card in the shared teams channel" src="https://johnnyreilly.com/assets/images/screenshot-adaptive-card-in-channel-62b838ceffbf213ac73137981438ebd5.webp" width="1108" height="528" class="img_ev3q"></p>
<p>Note that it has the @mention of the user: me. Now that this message in the relevant channel exists, our Power Automate workflow will be triggered. I've seen it take between 2 and 10 minutes for the trigger to fire. When it does, the flow runs and we get a direct message from the Flow bot:</p>
<p><img loading="lazy" alt="screenshot of the adaptive card in a teams direct chat" src="https://johnnyreilly.com/assets/images/screenshot-teams-direct-message-ee88aa5153ef11a2dbfeee64ff3b5401.webp" width="1108" height="440" class="img_ev3q"></p>
<p>And this is our handrolled direct message to a user in Microsoft Teams. It's the same message we sent to the channel, just forwarded on by the Flow bot. Brilliant. The eagle eyed amongst you will note the ugly <code>&lt;at id="0"&gt;John Reilly&lt;/at&gt;</code>; we're losing something in our forwarding. This could be remedied if we made our Power Automate flow a little more complex, but as mentioned, we're trying to keep our flow as simple as possible. The <code>&lt;at id="0"&gt;</code> is a small price to pay for the simplicity of our flow.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="user-blocked-the-conversation-with-the-bot">User blocked the conversation with the bot<a href="https://johnnyreilly.com/ms-teams-direct-message-api#user-blocked-the-conversation-with-the-bot" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>As you look at your Power Automate Flow runs, you can sometimes spot failures along these lines:</p>
<p><img loading="lazy" alt="screenshot of a failed run of the power automate flow" src="https://johnnyreilly.com/assets/images/screenshot-power-automate-flow-failure-50afaf30d2224e5204af76dc527bd23a.webp" width="2892" height="1460" class="img_ev3q"></p>
<p>If you look to the right on that screenshot you can see the error message:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">Request to the Bot framework failed with error</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token property" style="color:#f92672">"error"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">"code"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token string" style="color:#a6e22e">"ConversationBlockedByUser"</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property" style="color:#f92672">"message"</span><span class="token operator" style="color:#66d9ef">:</span><span class="token string" style="color:#a6e22e">"User blocked the conversation with the bot."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>These kinds of failures appear to be a consequence of someone having blocked the Power Automate Flow bot. If you dig into the inputs ("Click to download" in the screenshot) you can discover the user who blocked the bot and have a conversation with them about it. Unblocking seems to be fairly straightforward; you just need to right-click / ctrl-click on the Power Automate app in Teams and select "Unblock":</p>
<p><img loading="lazy" alt="screenshot of unblocking the bot" src="https://johnnyreilly.com/assets/images/screenshot-unblock-the-bot-14f3e24135908174b39e6ef4b0fa8660.webp" width="552" height="372" class="img_ev3q"></p>
<p>In our experience, this is a rare occurrence, but it's worth being aware of.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://johnnyreilly.com/ms-teams-direct-message-api#conclusion" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Together we've built a mechanism for sending a direct message to a user in Microsoft Teams. We've used the Teams Notification API to send a message to a channel, and we've used Power Automate to pick up that message and send it on to the user we want to mention.</p>
<p>Thanks so much to Chris for coming up with this novel way of sending a direct message to a user in Microsoft Teams. I hope you've found this post useful.</p>]]></content:encoded>
        </item>
    </channel>
</rss>