<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>I CAN MAKE THIS WORK</title>
        <link>https://johnnyreilly.com/</link>
        <description>The blog of John Reilly ‚ù§Ô∏èüåª</description>
        <lastBuildDate>Sun, 12 May 2024 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <copyright>Copyright ¬© 2012 - 2024 John Reilly.</copyright>
        <item>
            <title><![CDATA[Bicep lint with Azure Pipelines and GitHub Actions]]></title>
            <link>https://johnnyreilly.com/bicep-lint-azure-pipelines-github-actions</link>
            <guid>https://johnnyreilly.com/bicep-lint-azure-pipelines-github-actions</guid>
            <pubDate>Wed, 31 Jan 2024 08:01:08 GMT</pubDate>
            <description><![CDATA[Bicep lint allows you to lint bicep files to ensure they conform to best practices. In this post we'll look at how to run bicep lint in Azure Pipelines and GitHub Actions.]]></description>
            <content:encoded><![CDATA[<p>Bicep has had linting <a href="https://github.com/Azure/bicep/releases/tag/v0.4.1" target="_blank" rel="noopener noreferrer">since version 0.4.1</a>. It's a great way to ensure that your bicep files conform to best practices. Interestingly, when the linting feature first shipped, there wasn't an explicit lint command as part of the CLI. Instead, you had to run <code>bicep build</code> and it would run the linter as part of the build process. This was a little confusing as it was not obvious that the linter was running.</p>
<p>As of <a href="https://github.com/Azure/bicep/releases/tag/v0.21.1" target="_blank" rel="noopener noreferrer">version 0.21.1</a> there is a dedicated <a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/linter" target="_blank" rel="noopener noreferrer"><code>bicep lint</code></a> command. This is a nice step forwards; it allows you to explicitly lint your your code, rather than have it happen as a side effect of build. And it is useful if you want to run the linter as part of a CI/CD pipeline. What's more the <code>bicep lint</code> command is now available in the Azure CLI as well. You can run <a href="https://docs.microsoft.com/en-us/cli/azure/bicep?view=azure-cli-latest#az-bicep-lint" target="_blank" rel="noopener noreferrer"><code>az bicep lint</code></a> to lint your bicep files.</p>
<p>In this post we'll look at how to run lint Bicep in Azure Pipelines and GitHub Actions, and surface the output in the UI.</p>
<p><img decoding="async" loading="eager" alt="title image reading &amp;quot;Bicep lint with Azure Pipelines and GitHub Actions&amp;quot; with the Bicep logo" src="https://johnnyreilly.com/assets/images/title-image-af67d61370c2d04c19f5f6065b7d64c7.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-general-approach">The general approach<a href="https://johnnyreilly.com/bicep-lint-azure-pipelines-github-actions#the-general-approach" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>The general approach is the same for both Azure Pipelines and GitHub Actions. One way or another, we'll run the Bicep <code>lint</code> command to lint our Bicep files and capture the output. As yet, there is no option to export the results of the lint command as a file. This may come, and <a href="https://github.com/Azure/bicep/issues/11960" target="_blank" rel="noopener noreferrer">there is a discussion about it</a>. However, there is a way to achieve our goal, which came out in discussion with <a href="https://github.com/anthony-c-martin" target="_blank" rel="noopener noreferrer">Anthony Martin</a> of the Bicep team. We can write the output of the <code>lint</code> command to a file like so:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token plain">bicep lint main.bicep --diagnostics-format sarif &gt; lint.sarif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This will write the output of the <code>lint</code> command to a file called <code>lint.sarif</code>. This is a <a href="https://sarifweb.azurewebsites.net/" target="_blank" rel="noopener noreferrer">SARIF</a> file. SARIF stands for Static Analysis Results Interchange Format. It's a standard for representing the results of static analysis tools. It's a JSON file, easy to parse and has integrations with GitHub Actions / Azure Pipelines. An example SARIF output is below:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"$schema"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"https://schemastore.azurewebsites.net/schemas/json/sarif-2.1.0-rtm.6.json"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"version"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"2.1.0"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"runs"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"tool"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">"driver"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">"name"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"bicep"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"results"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">"ruleId"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"no-unused-vars"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">"message"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token property" style="color:rgb(255, 157, 0)">"text"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Variable \"unusedVar\" is declared but never used. [https://aka.ms/bicep/linter/no-unused-vars]"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">"locations"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">"physicalLocation"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token property" style="color:rgb(255, 157, 0)">"artifactLocation"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                  </span><span class="token property" style="color:rgb(255, 157, 0)">"uri"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"file:///home/runner/work/blog.johnnyreilly.com/blog.johnnyreilly.com/./infra/main.bicep"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token property" style="color:rgb(255, 157, 0)">"region"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                  </span><span class="token property" style="color:rgb(255, 157, 0)">"startLine"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">19</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                  </span><span class="token property" style="color:rgb(255, 157, 0)">"charOffset"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"columnKind"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"utf16CodeUnits"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In the example above we directly used the <code>bicep lint</code> command. An alternative approach is to use the Azure CLI like so:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token plain">az bicep lint --file main.bicep --diagnostics-format sarif &gt; lint.sarif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is a little more verbose, but it does mean that you don't need to install the Bicep CLI on your build agent. You can use the Azure CLI instead; and this is already a first class citizen of Azure Pipelines and GitHub Actions, with dedicated support. (That said, there is a slight issue with this approach at the time of writing, which we'll come to later.)</p>
<p>However we generate it, we can take the SARIF file and use it to surface the results of the linting process in Azure Pipelines and GitHub Actions.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="linting-bicep-in-github-actions-with-the-azure-cli">Linting Bicep in GitHub Actions with the Azure CLI<a href="https://johnnyreilly.com/bicep-lint-azure-pipelines-github-actions#linting-bicep-in-github-actions-with-the-azure-cli" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>We'll start off by looking at how to lint Bicep in GitHub Actions with the Azure CLI. But before we do that, we need something to lint. Within your <code>main.bicep</code> file you should have something like this:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> unusedVar </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">1</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// unused variable</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As it suggests, this is an unused variable. We're just using this to demonstrate the linting process. And alongside that, we want a <a href="https://aka.ms/bicep/config" target="_blank" rel="noopener noreferrer"><code>bicepconfig.json</code></a> file that looks like this:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"analyzers"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">"core"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"rules"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">"no-unused-vars"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">"level"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"warning"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This explicitly enables the <a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/linter-rule-no-unused-variables" target="_blank" rel="noopener noreferrer"><code>no-unused-vars</code></a> rule, and sets it to <code>warning</code> level. This means that the linter will warn us about unused variables, but it won't fail the build. We could set it to <code>error</code> level, and then the build would fail if there were any unused variables. We'll come back to this later.</p>
<p>In a GitHub workflow in your repository you should have steps like these:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Lint Bicep</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> azure/CLI@v1</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token scalar string" style="color:rgb(165, 255, 144)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token scalar string" style="color:rgb(165, 255, 144)">      az bicep install</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token scalar string" style="color:rgb(165, 255, 144)">      az bicep lint --file ./infra/main.bicep --diagnostics-format sarif &gt; bicep.sarif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Upload SARIF</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> (success() </span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token plain"> failure())</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> github/codeql</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">action/upload</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">sarif@v3</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">category</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> bicep</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">sarif_file</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> bicep.sarif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The above:</p>
<ul>
<li>Installs Bicep to the Azure CLI</li>
<li>Runs the <code>lint</code> command and writes the results to a file called <code>bicep.sarif</code></li>
<li>Uploads the SARIF file to GitHub</li>
</ul>
<p>The <code>upload-sarif</code> action is provided by GitHub. <a href="https://docs.github.com/en/code-security/code-scanning/integrating-with-code-scanning/uploading-a-sarif-file-to-github" target="_blank" rel="noopener noreferrer">It allows surfacing the results of static analysis tools in GitHub</a>. Doing this will show the results of the linting process in the GitHub UI, and it will also show them in the GitHub Security / Code Scanning UI, like so:</p>
<p><img decoding="async" loading="lazy" alt="screenshot of the no-unused-vars rule in GitHub UI" src="https://johnnyreilly.com/assets/images/screenshot-github-actions-no-unused-vars-9c962eb6271f0d866be70b2de97a9928.webp" width="1922" height="726" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="linting-bicep-in-github-actions-with-the-bicep-cli">Linting Bicep in GitHub Actions with the Bicep CLI<a href="https://johnnyreilly.com/bicep-lint-azure-pipelines-github-actions#linting-bicep-in-github-actions-with-the-bicep-cli" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>We can also lint Bicep in GitHub Actions with the Bicep CLI. At the time of writing, there's a reason you might want to favour this approach over the Azure CLI approach. I won't drill into it in depth, but at present if <code>az bicep lint</code> fails / returns a non-0 exit code then no output is produced. We could make this happen by updating the <code>bicepconfig.json</code> to dial up the <code>no-unused-vars</code> rule to <code>error</code> level, like so:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"analyzers"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">"core"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"rules"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">"no-unused-vars"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">"level"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"error"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now an unused variable will cause the build to fail. But the output of the <code>lint</code> command will not be surfaced in the GitHub UI. This is because the Azure CLI is not surfacing the output of the <code>lint</code> command when it fails.</p>
<p>The issue with the Azure CLI will hopefully be remedied; <a href="https://github.com/Azure/azure-cli/issues/28259" target="_blank" rel="noopener noreferrer">you can track that here</a>. For now you can use the Bicep CLI directly, where this isn't an issue. We'll do that now.</p>
<p>I'm basing this approach on Anthony Martin's example of <a href="https://github.com/anthony-c-martin/bicep-on-k8s/blob/e6dfa61fe7eae6fd6b148670f940041f3e294b20/.github/workflows/ci.yml#L36-L50" target="_blank" rel="noopener noreferrer">Bicep linting with GitHub Actions</a>:</p>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Setup Bicep</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> anthony</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">c</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">martin/setup</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">bicep@v0.3</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Lint Bicep</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">run</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token scalar string" style="color:rgb(165, 255, 144)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token scalar string" style="color:rgb(165, 255, 144)">    bicep lint ./infra/main.bicep --diagnostics-format sarif &gt; bicep.sarif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Upload SARIF</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> always()</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> github/codeql</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">action/upload</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">sarif@v3</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">category</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> bicep</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">sarif_file</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> bicep.sarif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The above does the same as the Azure CLI approach, but it uses the Bicep CLI directly. The <a href="https://github.com/marketplace/actions/setup-bicep" target="_blank" rel="noopener noreferrer"><code>setup-bicep</code> action</a> is provided by Anthony Martin and installs the Bicep CLI on your build agent.</p>
<p>As I say, right now you may want to favour this approach over the Azure CLI approach to cover both surfacing warnings and errors. But hopefully that will change soon.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="linting-bicep-in-azure-pipelines-with-the-azure-cli">Linting Bicep in Azure Pipelines with the Azure CLI<a href="https://johnnyreilly.com/bicep-lint-azure-pipelines-github-actions#linting-bicep-in-azure-pipelines-with-the-azure-cli" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>We've now seen how to lint Bicep in GitHub Actions with both the Azure CLI and the Bicep CLI. We can do the same in Azure Pipelines; but only the Azure CLI approach (as I'm not sure if there's a <code>setup-bicep</code> equivalent for Azure Pipelines).</p>
<p>How you want to surface the results in Azure Pipelines is up to you. You could surface into the "Scans" portion of Azure Pipelines UI or into "Tests". I'll show you how to do both.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="surface-the-results-in-scans">Surface the results in Scans<a href="https://johnnyreilly.com/bicep-lint-azure-pipelines-github-actions#surface-the-results-in-scans" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>To surface the results in the scans part of Azure Pipelines you need to publish the SARIF file as a build artifact. You can do that like so:</p>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token key atrule">jobs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">job</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> LintInfra</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Lint Infra</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">dependsOn</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">pool</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token key atrule">vmImage</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'ubuntu-latest'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> AzureCLI@2</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Lint main.bicep</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> service</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">connection</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">with</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">access</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">to</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">registry </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># you may not need this</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> bash</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> inlineScript</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token scalar string" style="color:rgb(165, 255, 144)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token scalar string" style="color:rgb(165, 255, 144)">            az bicep install</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token scalar string" style="color:rgb(165, 255, 144)">            az bicep lint --file infra/main.bicep --diagnostics-format sarif &gt; $(System.DefaultWorkingDirectory)/bicep.sarif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> PublishBuildArtifacts@1</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token key atrule">condition</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> always()</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token key atrule">pathToPublish</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $(System.DefaultWorkingDirectory)/bicep.sarif</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token key atrule">artifactName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> CodeAnalysisLogs </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># required to show up in the scans tab</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The above is essentially the same as the GitHub Actions example, but it uses the Azure CLI instead of the Bicep CLI. The <code>PublishBuildArtifacts</code> task is provided by Azure Pipelines. It allows you to publish build artifacts, which will show up in the Scans part of Azure Pipelines. You can see the results of the linting process in Scans, like so:</p>
<p><img decoding="async" loading="lazy" alt="screenshot of the no-unused-vars rule in Azure Pipelines scans" src="https://johnnyreilly.com/assets/images/screenshot-azure-pipelines-scans-no-unused-vars-02bddbe30ec71064cded5894dbbc70e2.webp" width="2944" height="842" class="img_ev3q"></p>
<p>You'll notice that the path above has a <code>file:///home/vsts/work/1/s</code> prefix before the bicep path report of <code>infra/main.bicep</code>. This is unfortunate and breaks "clickability". You cannot click on this and be taken to the file. It's possible to remedy this behaviour by doing a little find and replace magic on the SARIF file. You don't need to do this, but it does add to the developer experience.</p>
<p>Below is the same portion of the Azure Pipelines yaml file but with some additional bash that will use <code>sed</code> to replace all instances of the <code>file:///home/vsts/work/1/s</code> prefix with an empty string:</p>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token key atrule">jobs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">job</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> LintInfra</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Lint Infra</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">dependsOn</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">pool</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token key atrule">vmImage</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'ubuntu-latest'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> AzureCLI@2</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Lint main.bicep</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> service</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">connection</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">with</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">access</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">to</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">registry </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># you may not need this</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> bash</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> inlineScript</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token scalar string" style="color:rgb(165, 255, 144)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token scalar string" style="color:rgb(165, 255, 144)">            az bicep install</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token scalar string" style="color:rgb(165, 255, 144)">            az bicep lint --file infra/main.bicep --diagnostics-format sarif &gt; $(System.DefaultWorkingDirectory)/bicep.sarif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            STRING_TO_REPLACE='file</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain">//$(Build.SourcesDirectory)/'</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            echo "</span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">##[group]Bicep linting results before $STRING_TO_REPLACE replace:"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            cat $(System.DefaultWorkingDirectory)/bicep.sarif</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            echo "</span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">##[endgroup]"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            sed </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">i "s</span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token plain">$STRING_TO_REPLACE</span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token plain">g" $(System.DefaultWorkingDirectory)/bicep.sarif</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            echo "</span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">##[group]Bicep linting results after $STRING_TO_REPLACE replace:"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            cat $(System.DefaultWorkingDirectory)/bicep.sarif</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            echo "</span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">##[endgroup]"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> PublishBuildArtifacts@1</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token key atrule">condition</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> always()</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token key atrule">pathToPublish</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $(System.DefaultWorkingDirectory)/bicep.sarif</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token key atrule">artifactName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> CodeAnalysisLogs </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># required to show up in the scans tab</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And hey presto! Clickability restored.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="surface-the-results-in-tests">Surface the results in Tests<a href="https://johnnyreilly.com/bicep-lint-azure-pipelines-github-actions#surface-the-results-in-tests" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>You can also surface the results in the tests part of Azure Pipelines. To do that we're going to borrow a <a href="https://github.com/Azure/bicep/issues/11960#issuecomment-1737226501" target="_blank" rel="noopener noreferrer">suggestion from Anthony Martin</a> and use the <a href="https://www.npmjs.com/package/sarif-junit" target="_blank" rel="noopener noreferrer"><code>sarif-junit</code></a> package. This package allows us to convert a SARIF file to a JUnit file. JUnit is a standard for representing test results and can be used with the <code>PublishTestResults</code> task.</p>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token key atrule">jobs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">job</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> LintInfra</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Lint Infra</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">dependsOn</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">pool</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token key atrule">vmImage</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'ubuntu-latest'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> NodeTool@0</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'Install Node.js'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token key atrule">versionSpec</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'18.x'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> AzureCLI@2</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Lint main.bicep</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> service</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">connection</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">with</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">access</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">to</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">registry </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># you may not need this</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> bash</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> inlineScript</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token scalar string" style="color:rgb(165, 255, 144)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token scalar string" style="color:rgb(165, 255, 144)">            az bicep install</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token scalar string" style="color:rgb(165, 255, 144)">            az bicep lint --file infra/main.bicep --diagnostics-format sarif &gt; $(System.DefaultWorkingDirectory)/bicep.sarif</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token scalar string" style="color:rgb(165, 255, 144)">            npx -y sarif-junit -i $(System.DefaultWorkingDirectory)/bicep.sarif -o $(System.DefaultWorkingDirectory)/bicep.xml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> PublishTestResults@2</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token key atrule">condition</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> always()</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token key atrule">testResultsFormat</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'JUnit'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token key atrule">testResultsFiles</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'$(System.DefaultWorkingDirectory)/bicep.xml'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>So the above is the same approach again but requires Node.js to be installed, and the results end up in the Tests part of Azure Pipelines. You can see the results of the linting process in Tests, like so:</p>
<p><img decoding="async" loading="lazy" alt="screenshot of the no-unused-vars rule in Azure Pipelines tests" src="https://johnnyreilly.com/assets/images/screenshot-azure-pipelines-tests-no-unused-vars-9ca250203edc598ea166d326ad6675d6.webp" width="2944" height="1042" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="https://johnnyreilly.com/bicep-lint-azure-pipelines-github-actions#summary" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>That's it! We've seen how to lint Bicep in Azure Pipelines and GitHub Actions. We've seen how to surface the results in the scans and tests parts of Azure Pipelines and in GitHub. We've seen how to do it with the Azure CLI and the Bicep CLI. And we've seen how to do it with warnings and errors. Hopefully this will help you to ensure that your Bicep files conform to best practices.</p>
<p>Many thanks to Anthony Martin for his help, which laid the groundwork for much of what we explored in this post.</p>]]></content:encoded>
            <category>bicep</category>
            <category>github actions</category>
            <category>azure pipelines</category>
            <category>azure devops</category>
        </item>
        <item>
            <title><![CDATA[Docusaurus 3: how to migrate rehype plugins]]></title>
            <link>https://johnnyreilly.com/docusaurus-3-how-to-migrate-rehype-plugins</link>
            <guid>https://johnnyreilly.com/docusaurus-3-how-to-migrate-rehype-plugins</guid>
            <pubDate>Sat, 28 Oct 2023 04:32:07 GMT</pubDate>
            <description><![CDATA[Learn how to migrate rehype plugins to Docusaurus 3.]]></description>
            <content:encoded><![CDATA[<p>Docusaurus v3 is on the way. One of the big changes that is coming with Docusaurus 3 is MDX 3. My blog has been built with Docusaurus 2 and I have a number of rehype plugins that I use to improve the experience of the blog. These include:</p>
<ul>
<li><a href="https://johnnyreilly.com/docusaurus-improve-core-web-vitals-fetchpriority">a plugin to improve Core Web Vitals with fetchpriority / lazy loading</a></li>
<li><a href="https://johnnyreilly.com/docusaurus-image-cloudinary-rehype-plugin">a plugin to serving Docusaurus images with Cloudinary</a></li>
</ul>
<p>I wanted to migrate these plugins to Docusaurus 3. This post is about how I did that - and if you've got a rehype plugin it could probably provide some guidance on the changes you'd need to make.</p>
<p><img decoding="async" loading="eager" alt="title image reading &amp;quot;Migrating rehype plugins to Docusaurus 3&amp;quot; with the Docusaurus logos" src="https://johnnyreilly.com/assets/images/title-image-f54fd33f2e27f07de2f06c9b9217eeeb.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-needs-to-change">What needs to change?<a href="https://johnnyreilly.com/docusaurus-3-how-to-migrate-rehype-plugins#what-needs-to-change" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>The Docusaurus team put out a blog post on preparing for the Docusaurus 3 migration. <a href="https://docusaurus.io/blog/preparing-your-site-for-docusaurus-v3#mdx-plugins" target="_blank" rel="noopener noreferrer">Part of that post mentions MDX plugins</a>:</p>
<blockquote>
<p>All the official packages (Unified, Remark, Rehype...) in the MDX ecosystem are now <strong>ES Modules</strong> only and do not support CommonJS anymore.</p>
</blockquote>
<p>This affects how you write your plugins. It also has a bearing on how you import your plugins, given that the Docusaurus configuration file itself is still CommonJS. The post adds:</p>
<blockquote>
<p>If you created custom Remark or Rehype plugins, you may need to refactor those, or eventually rewrite them completely, due to how the new AST is structured.</p>
</blockquote>
<p>This turned out to be the case for me. I had to rewrite my plugins completely. I'll go through each of them in turn.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="migrating-the-fetchpriority-plugin">Migrating the <code>fetchpriority</code> plugin<a href="https://johnnyreilly.com/docusaurus-3-how-to-migrate-rehype-plugins#migrating-the-fetchpriority-plugin" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>The <code>fetchpriority</code> plugin is a rehype plugin that I wrote to improve the Core Web Vitals of my blog. It does this by making the first image on a page eager loaded with <code>fetchpriority="high"</code> and lazy loading all other images. The Docusaurus 2 / MDX 1 code looked like this:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockTitle_Ktv7">image-fetch-priority-rehype-plugin.js</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// @ts-check</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> visit </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">require</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">'unist-util-visit'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic">/**</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> * Create a rehype plugin that will make the first image eager loaded with fetchpriority="high" and lazy load all other images</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:rgb(255, 157, 0);font-style:italic">@returns</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> rehype plugin that will make the first image eager loaded with fetchpriority="high" and lazy load all other images</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">imageFetchPriorityRehypePlugin</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic">/** </span><span class="token doc-comment comment keyword" style="color:rgb(255, 157, 0);font-style:italic">@type</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">{</span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic">Map</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">&lt;</span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic">string</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">,</span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic"> string</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">&gt;</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">}</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> */</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> files </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">Map</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic">/** </span><span class="token doc-comment comment keyword" style="color:rgb(255, 157, 0);font-style:italic">@type</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">{</span><span class="token doc-comment comment class-name keyword" style="color:rgb(255, 157, 0);font-style:italic">import</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">(</span><span class="token doc-comment comment class-name string" style="color:rgb(165, 255, 144);font-style:italic">'unified'</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">)</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">.</span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic">Transformer</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">}</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token parameter">tree</span><span class="token parameter punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token parameter"> vfile</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token function" style="color:rgb(250, 208, 0)">visit</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">tree</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'element'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'jsx'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token parameter">node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'element'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">&amp;&amp;</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'tagName'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'img'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// handles nodes like this:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//   type: 'element',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//   tagName: 'img',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//   properties: {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//     src: 'https://some.website.com/cat.gif',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//     alt: null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//   },</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//   ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> key </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token template-string string" style="color:rgb(165, 255, 144)">img|</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation">vfile</span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token template-string interpolation property-access">history</span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token template-string interpolation number" style="color:rgb(255, 98, 140)">0</span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> imageAlreadyProcessed </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> files</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token method function property-access" style="color:rgb(250, 208, 0)">get</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">key</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> fetchpriorityThisImage </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token operator" style="color:rgb(255, 157, 0)">!</span><span class="token plain">imageAlreadyProcessed </span><span class="token operator" style="color:rgb(255, 157, 0)">||</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          imageAlreadyProcessed </span><span class="token operator" style="color:rgb(255, 157, 0)">===</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'properties'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'src'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token operator" style="color:rgb(255, 157, 0)">!</span><span class="token plain">imageAlreadyProcessed</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          files</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token method function property-access" style="color:rgb(250, 208, 0)">set</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">key</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'properties'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'src'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">fetchpriorityThisImage</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'properties'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">fetchpriority</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'high'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'properties'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">loading</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'eager'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'properties'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">loading</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'lazy'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'jsx'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">&amp;&amp;</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'value'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token operator" style="color:rgb(255, 157, 0)">?.</span><span class="token method function property-access" style="color:rgb(250, 208, 0)">includes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">'&lt;img '</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// handles nodes like this:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//   type: 'jsx',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//   value: '&lt;img src={require("!/workspaces/blog.johnnyreilly.com/blog-website/node_modules/url-loader/dist/cjs.js?limit=10000&amp;name=assets/images/[name]-[hash].[ext]&amp;fallback=/workspaces/blog.johnnyreilly.com/blog-website/node_modules/file-loader/dist/cjs.js!./bower-with-the-long-paths.png").default} width="640" height="497" /&gt;'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// if (!vfile.history[0].includes('blog/2023-01-15')) return;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> key </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token template-string string" style="color:rgb(165, 255, 144)">jsx|</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation">vfile</span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token template-string interpolation property-access">history</span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token template-string interpolation number" style="color:rgb(255, 98, 140)">0</span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> imageAlreadyProcessed </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> files</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token method function property-access" style="color:rgb(250, 208, 0)">get</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">key</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> fetchpriorityThisImage </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token operator" style="color:rgb(255, 157, 0)">!</span><span class="token plain">imageAlreadyProcessed </span><span class="token operator" style="color:rgb(255, 157, 0)">||</span><span class="token plain"> imageAlreadyProcessed </span><span class="token operator" style="color:rgb(255, 157, 0)">===</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'value'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token operator" style="color:rgb(255, 157, 0)">!</span><span class="token plain">imageAlreadyProcessed</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          files</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token method function property-access" style="color:rgb(250, 208, 0)">set</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">key</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'value'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">fetchpriorityThisImage</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'value'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'value'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token method function property-access" style="color:rgb(250, 208, 0)">replace</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">&lt;img </span><span class="token regex regex-delimiter">/</span><span class="token regex regex-flags">g</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token string" style="color:rgb(165, 255, 144)">'&lt;img loading="eager" fetchpriority="high" '</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'value'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'value'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token method function property-access" style="color:rgb(250, 208, 0)">replace</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">&lt;img </span><span class="token regex regex-delimiter">/</span><span class="token regex regex-flags">g</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token string" style="color:rgb(165, 255, 144)">'&lt;img loading="lazy" '</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">module</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> imageFetchPriorityRehypePlugin</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The new plugin looks like this:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockTitle_Ktv7">image-fetch-priority-rehype-plugin.mjs</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// @ts-check</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword module" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token imports"> visit </span><span class="token imports punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'unist-util-visit'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic">/**</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> * Create a rehype plugin that will make the first image eager loaded with fetchpriority="high" and lazy load all other images</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:rgb(255, 157, 0);font-style:italic">@returns</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> rehype plugin that will make the first image eager loaded with fetchpriority="high" and lazy load all other images</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword module" style="color:rgb(255, 157, 0)">export</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(255, 157, 0)">default</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">imageFetchPriorityRehypePlugin</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic">/** </span><span class="token doc-comment comment keyword" style="color:rgb(255, 157, 0);font-style:italic">@type</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">{</span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic">Map</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">&lt;</span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic">string</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">,</span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic"> string</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">&gt;</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">}</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> */</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> files </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">Map</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic">/** </span><span class="token doc-comment comment keyword" style="color:rgb(255, 157, 0);font-style:italic">@type</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">{</span><span class="token doc-comment comment class-name keyword" style="color:rgb(255, 157, 0);font-style:italic">import</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">(</span><span class="token doc-comment comment class-name string" style="color:rgb(165, 255, 144);font-style:italic">'unified'</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">)</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">.</span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic">Transformer</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">}</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token parameter">tree</span><span class="token parameter punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token parameter"> vfile</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token function" style="color:rgb(250, 208, 0)">visit</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">tree</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'mdxJsxTextElement'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token parameter">node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'mdxJsxTextElement'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">&amp;&amp;</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'name'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'img'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// handles nodes like this:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//   type: 'mdxJsxTextElement',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//   name: 'img',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//   attributes: [</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//     {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//       type: 'mdxJsxAttribute',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//       name: 'alt',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//       value: 'title image reading &amp;quot;Azure Container Apps, Bicep, managed certificates and custom domains&amp;quot; with the Azure Container App logos'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//     },</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//     {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//       type: 'mdxJsxAttribute',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//       name: 'src',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//       value: {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//         type: 'mdxJsxAttributeValueExpression',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//         value: 'require("!/home/john/code/github/blog.johnnyreilly.com/blog-website/node_modules/url-loader/dist/cjs.js?limit=10000&amp;name=assets/images/[name]-[contenthash].[ext]&amp;fallback=/home/john/code/github/blog.johnnyreilly.com/blog-website/node_modules/file-loader/dist/cjs.js!./screenshot-azure-portal-bring-your-own-certificates.webp").default',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//         data: [Object]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//       }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//     },</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//     { type: 'mdxJsxAttribute', name: 'width', value: '800' },</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//     { type: 'mdxJsxAttribute', name: 'height', value: '450' }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//   ],</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//   children: []</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> srcIndex </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'attributes'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token method function property-access" style="color:rgb(250, 208, 0)">findIndex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token parameter">attr</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> attr</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">name</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'src'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> requireString </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'attributes'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">srcIndex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> key </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token template-string string" style="color:rgb(165, 255, 144)">jsx|</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation">vfile</span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token template-string interpolation property-access">history</span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token template-string interpolation number" style="color:rgb(255, 98, 140)">0</span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> imageAlreadyProcessed </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> files</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token method function property-access" style="color:rgb(250, 208, 0)">get</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">key</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> fetchpriorityThisImage </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token operator" style="color:rgb(255, 157, 0)">!</span><span class="token plain">imageAlreadyProcessed </span><span class="token operator" style="color:rgb(255, 157, 0)">||</span><span class="token plain"> imageAlreadyProcessed </span><span class="token operator" style="color:rgb(255, 157, 0)">===</span><span class="token plain"> requireString</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token operator" style="color:rgb(255, 157, 0)">!</span><span class="token plain">imageAlreadyProcessed</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          files</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token method function property-access" style="color:rgb(250, 208, 0)">set</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">key</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> requireString</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// expect to be -1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> loadingIndex </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'attributes'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token method function property-access" style="color:rgb(250, 208, 0)">findIndex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token parameter">attr</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> attr</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">name</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'loading'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">fetchpriorityThisImage</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// expect to be -1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> fetchpriorityIndex </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'attributes'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token method function property-access" style="color:rgb(250, 208, 0)">findIndex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token parameter">attr</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> attr</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">name</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'fetchpriority'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">loadingIndex </span><span class="token operator" style="color:rgb(255, 157, 0)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">-</span><span class="token number" style="color:rgb(255, 98, 140)">1</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'attributes'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">loadingIndex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">value</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'eager'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'attributes'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token method function property-access" style="color:rgb(250, 208, 0)">push</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">              </span><span class="token literal-property property" style="color:rgb(255, 157, 0)">type</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'mdxJsxAttribute'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">              </span><span class="token literal-property property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'loading'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">              </span><span class="token literal-property property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'eager'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">fetchpriorityIndex </span><span class="token operator" style="color:rgb(255, 157, 0)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">-</span><span class="token number" style="color:rgb(255, 98, 140)">1</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'attributes'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">fetchpriorityIndex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">value</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'high'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'attributes'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token method function property-access" style="color:rgb(250, 208, 0)">push</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">              </span><span class="token literal-property property" style="color:rgb(255, 157, 0)">type</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'mdxJsxAttribute'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">              </span><span class="token literal-property property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'fetchpriority'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">              </span><span class="token literal-property property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'high'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">loadingIndex </span><span class="token operator" style="color:rgb(255, 157, 0)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">-</span><span class="token number" style="color:rgb(255, 98, 140)">1</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'attributes'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">loadingIndex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">value</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'lazy'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'attributes'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token method function property-access" style="color:rgb(250, 208, 0)">push</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">              </span><span class="token literal-property property" style="color:rgb(255, 157, 0)">type</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'mdxJsxAttribute'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">              </span><span class="token literal-property property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'loading'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">              </span><span class="token literal-property property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'lazy'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>What's different? Well, a number of things; let's go through them.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="commonjs-to-es-module">CommonJS to ES Module<a href="https://johnnyreilly.com/docusaurus-3-how-to-migrate-rehype-plugins#commonjs-to-es-module" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>You'll note the old plugin has the name <code>image-fetch-priority-rehype-plugin.js</code> and the new plugin has the name <code>image-fetch-priority-rehype-plugin.mjs</code>. This is because the new plugin is an ES Module and the old plugin is CommonJS.</p>
<p>Further to that, the old plugin used <code>module.exports = imageFetchPriorityRehypePlugin</code> to expose functionality and the new plugin uses <code>export default imageFetchPriorityRehypePlugin</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="different-ast">Different AST<a href="https://johnnyreilly.com/docusaurus-3-how-to-migrate-rehype-plugins#different-ast" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>The abstract syntax tree (AST) is different. MDX 1 and MDX 3 make different ASTs and we must migrate to the new one. Interestingly, it seems to be slightly simpler in some ways. MDX 1 surfaced both <code>element</code> / <code>img</code> nodes and <code>jsx</code> nodes. By contrast, MDX 3 appears to surface just <code>mdxJsxTextElement</code> which are similar to MDX 1's <code>jsx</code> nodes, but come with their own AST representation of expression based attributes in the <code>data</code> property.</p>
<p>The logic of the new plugin is similar to the old plugin, but the code is different to cater for the different AST.</p>
<p>And that's it - we have a new <code>fetchpriority</code> plugin that works with Docusaurus 3 and MDX 3!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="migrating-the-cloudinary-plugin">Migrating the <code>cloudinary</code> plugin<a href="https://johnnyreilly.com/docusaurus-3-how-to-migrate-rehype-plugins#migrating-the-cloudinary-plugin" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Firstly, let's remind ourselves what the <code>cloudinary</code> plugin does. It takes an image URL and transforms it into a Cloudinary URL. So like this:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted prefix deleted" style="color:rgba(239, 83, 80, 0.56)">-</span><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)">https://my.website.com/cat.gif</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">https://res.cloudinary.com/demo/image/fetch/https://my.website.com/cat.gif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And at runtime, Cloudinary's <a href="https://cloudinary.com/documentation/fetch_remote_images#fetch_and_deliver_remote_files" target="_blank" rel="noopener noreferrer">Fetch mechanism</a> will handle transforming the image into a format that is optimised for the browser that is requesting it.</p>
<p>It turns out that the <code>fetchpriority</code> plugin is a much more straightforward migration than the <code>cloudinary</code> plugin. And the reason for that is related to the aforementioned AST changes. Let's start with the old plugin:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockTitle_Ktv7">cloudinary-rehype-plugin.js</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//@ts-check</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> visit </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">require</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">'unist-util-visit'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic">/**</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> * Create a rehype plugin that will replace image URLs with Cloudinary URLs</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:rgb(255, 157, 0);font-style:italic">@param</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">{</span><span class="token doc-comment comment class-name operator" style="color:rgb(255, 157, 0);font-style:italic">*</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">}</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> </span><span class="token doc-comment comment parameter" style="color:rgb(179, 98, 255);font-style:italic">options</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> cloudName your Cloudinary‚Äôs cloud name eg demo, baseUrl the base URL of your website eg https://johnnyreilly.com - should not include a trailing slash, will likely be the same as the config.url in your docusaurus.config.js</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:rgb(255, 157, 0);font-style:italic">@returns</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> rehype plugin that will replace image URLs with Cloudinary URLs</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">imageCloudinaryRehypePlugin</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic">/** </span><span class="token doc-comment comment keyword" style="color:rgb(255, 157, 0);font-style:italic">@type</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">{</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">{</span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic"> cloudName</span><span class="token doc-comment comment class-name operator" style="color:rgb(255, 157, 0);font-style:italic">:</span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic"> string</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">;</span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic"> baseUrl</span><span class="token doc-comment comment class-name operator" style="color:rgb(255, 157, 0);font-style:italic">:</span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic"> string </span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">}</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">}</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> */</span><span class="token plain"> options</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> cloudName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> baseUrl </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> options</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> srcRegex </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex"> src={</span><span class="token regex regex-source language-regex group punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:rgb(250, 208, 0)">.</span><span class="token regex regex-source language-regex quantifier number" style="color:rgb(255, 98, 140)">*</span><span class="token regex regex-source language-regex group punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token regex regex-source language-regex">}</span><span class="token regex regex-delimiter">/</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic">/** </span><span class="token doc-comment comment keyword" style="color:rgb(255, 157, 0);font-style:italic">@type</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">{</span><span class="token doc-comment comment class-name keyword" style="color:rgb(255, 157, 0);font-style:italic">import</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">(</span><span class="token doc-comment comment class-name string" style="color:rgb(165, 255, 144);font-style:italic">'unified'</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">)</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">.</span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic">Plugin</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">&lt;</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">[</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">]</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">,</span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic"> </span><span class="token doc-comment comment class-name keyword" style="color:rgb(255, 157, 0);font-style:italic">import</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">(</span><span class="token doc-comment comment class-name string" style="color:rgb(165, 255, 144);font-style:italic">'hast'</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">)</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">.</span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic">Root</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">&gt;</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">}</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token parameter">tree</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token function" style="color:rgb(250, 208, 0)">visit</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">tree</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'element'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'jsx'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token parameter">node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'element'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">&amp;&amp;</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'tagName'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'img'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// handles nodes like this:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//   type: 'element',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//   tagName: 'img',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//   properties: {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//     src: 'https://some.website.com/cat.gif',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//     alt: null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//   },</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//   ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> url </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'properties'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">src</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token string" style="color:rgb(165, 255, 144)">'properties'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">src</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token template-string string" style="color:rgb(165, 255, 144)">https://res.cloudinary.com/</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation">cloudName</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string string" style="color:rgb(165, 255, 144)">/image/fetch/</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation">url</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'jsx'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">&amp;&amp;</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'value'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token operator" style="color:rgb(255, 157, 0)">?.</span><span class="token method function property-access" style="color:rgb(250, 208, 0)">includes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">'&lt;img '</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// handles nodes like this:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//   type: 'jsx',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//   value: '&lt;img src={require("!/workspaces/blog.johnnyreilly.com/blog-website/node_modules/url-loader/dist/cjs.js?limit=10000&amp;name=assets/images/[name]-[hash].[ext]&amp;fallback=/workspaces/blog.johnnyreilly.com/blog-website/node_modules/file-loader/dist/cjs.js!./bower-with-the-long-paths.png").default} width="640" height="497" /&gt;'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> match </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'value'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token method function property-access" style="color:rgb(250, 208, 0)">match</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">srcRegex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">match</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> urlOrRequire </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> match</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token number" style="color:rgb(255, 98, 140)">1</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'value'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'value'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token method function property-access" style="color:rgb(250, 208, 0)">replace</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            srcRegex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token template-string string" style="color:rgb(165, 255, 144)"> src={</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token template-string interpolation template-string string" style="color:rgb(165, 255, 144)">\`https://res.cloudinary.com/</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation template-string interpolation">cloudName</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string interpolation template-string string" style="color:rgb(165, 255, 144)">/image/fetch/</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation template-string interpolation">baseUrl</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string interpolation template-string string" style="color:rgb(165, 255, 144)">\$\{</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation template-string interpolation">urlOrRequire</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string interpolation template-string string" style="color:rgb(165, 255, 144)">\}\`</span><span class="token template-string interpolation template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string string" style="color:rgb(165, 255, 144)">}</span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">module</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> imageCloudinaryRehypePlugin</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The old plugin had two kinds of nodes it had to deal with, <code>element</code> and <code>jsx</code>. The new plugin will have to deal with just one kind of node, <code>mdxJsxTextElement</code>. (Just the same as with the <code>fetchpriority</code> plugin.)</p>
<p>Now you may have noticed that the JSX node in the old plugin has a slightly more complex <code>src</code> attribute:</p>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag" style="color:rgb(255, 157, 0)">img</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">src</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript function" style="color:rgb(250, 208, 0)">require</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token tag script language-javascript string" style="color:rgb(165, 255, 144)">"!/workspaces/blog.johnnyreilly.com/blog-website/node_modules/url-loader/dist/cjs.js?limit=10000&amp;name=assets/images/[name]-[hash].[ext]&amp;fallback=/workspaces/blog.johnnyreilly.com/blog-website/node_modules/file-loader/dist/cjs.js!./bower-with-the-long-paths.png"</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token tag script language-javascript keyword module" style="color:rgb(255, 157, 0)">default</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">width</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(255, 255, 255)">=</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag attr-value" style="color:rgb(255, 157, 0)">640</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">height</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(255, 255, 255)">=</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag attr-value" style="color:rgb(255, 157, 0)">497</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">/&gt;</span><span class="token plain">`</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>That <code>src</code> attribute is a JavaScript expression. It's not a string. It's a JavaScript expression that will be evaluated later by webpack, and will return the path to the image in the final (webpack-based) Docusaurus build.</p>
<p>So transformation into a Cloudinary URL for JSX nodes is a little tougher. In the MDX 1 plugin, we needed to wrap the <code>require</code> expression in backticks and prefix it with <code>https://res.cloudinary.com/${cloudName}/image/fetch/${baseUrl}</code> where <code>${baseUrl}</code> is the base URL of our website. We also need to prefix the expression with a <code>$</code> to indicate that it's a JavaScript expression. Tough to read but it works.</p>
<p>Rereading that paragraph, I realise it's hard to understand. Perhaps easier to see it in action. Here's what we want our plugin to do to the JSX node above:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted prefix deleted" style="color:rgba(239, 83, 80, 0.56)">-</span><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)">require("!/home/john/code/github/blog.johnnyreilly.com/blog-website/node_modules/url-loader/dist/cjs.js?limit=10000&amp;name=assets/images/[name]-[contenthash].[ext]&amp;fallback=/home/john/code/github/blog.johnnyreilly.com/blog-website/node_modules/file-loader/dist/cjs.js!./screenshot-azure-portal-bring-your-own-certificates.webp").default</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">`https://res.cloudinary.com/demo/image/fetch/f_auto,q_auto,w_auto,dpr_auto/https://johnnyreilly.com${require("!/home/john/code/github/blog.johnnyreilly.com/blog-website/node_modules/url-loader/dist/cjs.js?limit=10000&amp;name=assets/images/[name]-[contenthash].[ext]&amp;fallback=/home/john/code/github/blog.johnnyreilly.com/blog-website/node_modules/file-loader/dist/cjs.js!./screenshot-azure-portal-bring-your-own-certificates.webp").default}`</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It turns out it's even tougher doing this with MDX 3 as compared to MDX 1. This is because MDX 3's AST includes all kinds of metadata around the <code>mdxJsxAttributeValueExpression</code>:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token literal-property property" style="color:rgb(255, 157, 0)">type</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'mdxJsxAttribute'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token literal-property property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'src'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token literal-property property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token literal-property property" style="color:rgb(255, 157, 0)">type</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'mdxJsxAttributeValueExpression'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token literal-property property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'require("!/home/john/code/github/blog.johnnyreilly.com/blog-website/node_modules/url-loader/dist/cjs.js?limit=10000&amp;name=assets/images/[name]-[contenthash].[ext]&amp;fallback=/home/john/code/github/blog.johnnyreilly.com/blog-website/node_modules/file-loader/dist/cjs.js!./screenshot-azure-portal-bring-your-own-certificates.webp").default'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token literal-property property" style="color:rgb(255, 157, 0)">data</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token known-class-name class-name" style="color:rgb(250, 208, 0)">Object</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// &lt;--- There's a lot of metadata in here!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>data</code> object above is a full on AST representation of the <code>require</code> expression. And to make a plugin that works with MDX 3, we need to use that AST representation to build up the new <code>src</code> attribute. This involves some string manipulation and some AST traversal. It's not pretty but it works.</p>
<p>Here's the new plugin:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockTitle_Ktv7">cloudinary-rehype-plugin.mjs</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//@ts-check</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword module" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token imports"> visit </span><span class="token imports punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'unist-util-visit'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword module" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> </span><span class="token imports operator" style="color:rgb(255, 157, 0)">*</span><span class="token imports"> </span><span class="token imports keyword module" style="color:rgb(255, 157, 0)">as</span><span class="token imports"> acorn</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'acorn'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword module" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token imports"> mdxJsx </span><span class="token imports punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'micromark-extension-mdx-jsx'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword module" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token imports"> fromMarkdown </span><span class="token imports punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'mdast-util-from-markdown'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword module" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token imports"> mdxJsxFromMarkdown</span><span class="token imports punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token imports"> mdxJsxToMarkdown </span><span class="token imports punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'mdast-util-mdx-jsx'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword module" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token imports"> toMarkdown </span><span class="token imports punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'mdast-util-to-markdown'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic">/**</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:rgb(255, 157, 0);font-style:italic">@typedef</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">{</span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic">object</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">}</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> </span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic">Params</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> a label and an href</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:rgb(255, 157, 0);font-style:italic">@property</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">{</span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic">string</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">}</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> </span><span class="token doc-comment comment parameter" style="color:rgb(179, 98, 255);font-style:italic">cloudName</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> your Cloudinary‚Äôs cloud name eg demo</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:rgb(255, 157, 0);font-style:italic">@property</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">{</span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic">string</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">}</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> </span><span class="token doc-comment comment parameter" style="color:rgb(179, 98, 255);font-style:italic">baseUrl</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> the base URL of your website eg https://johnnyreilly.com - should not include a trailing slash, will likely be the same as the config.url in your docusaurus.config.js</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic">/**</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> * Create a rehype plugin that will replace image URLs with Cloudinary URLs</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:rgb(255, 157, 0);font-style:italic">@param</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">{</span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic">Params</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">}</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> </span><span class="token doc-comment comment parameter" style="color:rgb(179, 98, 255);font-style:italic">params</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:rgb(255, 157, 0);font-style:italic">@returns</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> rehype plugin that will replace image URLs with Cloudinary URLs</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword module" style="color:rgb(255, 157, 0)">export</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(255, 157, 0)">default</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">imageCloudinaryRehypePlugin</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token parameter punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token parameter"> cloudName</span><span class="token parameter punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token parameter"> baseUrl </span><span class="token parameter punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> imageCloudinaryRehypeVisitor </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">imageCloudinaryRehypeVisitor</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    cloudName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    baseUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token parameter">tree</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// eslint-disable-next-line @typescript-eslint/no-unsafe-call</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token function" style="color:rgb(250, 208, 0)">visit</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">tree</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'mdxJsxTextElement'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> imageCloudinaryRehypeVisitor</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic">/**</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> * Create a rehype visitor that will replace image URLs with Cloudinary URLs - exposed for testing purposes</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:rgb(255, 157, 0);font-style:italic">@param</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">{</span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic">Params</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">}</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> </span><span class="token doc-comment comment parameter" style="color:rgb(179, 98, 255);font-style:italic">params</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:rgb(255, 157, 0);font-style:italic">@returns</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> rehype plugin that will replace image URLs with Cloudinary URLs</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword module" style="color:rgb(255, 157, 0)">export</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">imageCloudinaryRehypeVisitor</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token parameter punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token parameter"> cloudName</span><span class="token parameter punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token parameter"> baseUrl </span><span class="token parameter punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> srcRegex </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex"> src=</span><span class="token regex regex-source language-regex special-escape escape">\{</span><span class="token regex regex-source language-regex group punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:rgb(250, 208, 0)">.</span><span class="token regex regex-source language-regex quantifier number" style="color:rgb(255, 98, 140)">*</span><span class="token regex regex-source language-regex group punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token regex regex-source language-regex special-escape escape">\}</span><span class="token regex regex-delimiter">/</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">imageCloudinaryRehypeVisitor</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token parameter">node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> imgWithAttributes </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      imgWithAttributes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'mdxJsxTextElement'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">&amp;&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      imgWithAttributes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">name</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'img'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// handles nodes like this:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//   type: 'mdxJsxTextElement',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//   name: 'img',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//   attributes: [</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//     {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//       type: 'mdxJsxAttribute',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//       name: 'alt',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//       value: 'title image reading &amp;quot;Azure Container Apps, Bicep, managed certificates and custom domains&amp;quot; with the Azure Container App logos'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//     },</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//     {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//       type: 'mdxJsxAttribute',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//       name: 'src',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//       value: {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//         type: 'mdxJsxAttributeValueExpression',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//         value: 'require("!/home/john/code/github/blog.johnnyreilly.com/blog-website/node_modules/url-loader/dist/cjs.js?limit=10000&amp;name=assets/images/[name]-[contenthash].[ext]&amp;fallback=/home/john/code/github/blog.johnnyreilly.com/blog-website/node_modules/file-loader/dist/cjs.js!./screenshot-azure-portal-bring-your-own-certificates.webp").default',</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//         data: [Object]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//       }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//     },</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//     { type: 'mdxJsxAttribute', name: 'width', value: '800' },</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//     { type: 'mdxJsxAttribute', name: 'height', value: '450' }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//   ],</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//   children: []</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> srcIndex </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> imgWithAttributes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">attributes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token method function property-access" style="color:rgb(250, 208, 0)">findIndex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token parameter">attr</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> attr</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">name</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'src'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> requireAttribute </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> imgWithAttributes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">attributes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">srcIndex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">typeof</span><span class="token plain"> requireAttribute </span><span class="token operator" style="color:rgb(255, 157, 0)">!==</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'string'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> asMarkdown </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">toMarkdown</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">imgWithAttributes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token literal-property property" style="color:rgb(255, 157, 0)">extensions</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token function" style="color:rgb(250, 208, 0)">mdxJsxToMarkdown</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// &lt;img</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//    alt="screenshot of typescript playground saying &amp;#39;ComponentThatReturnsANumber&amp;#39; cannot be used as a JSX component. Its return type &amp;#39;number&amp;#39; is not a valid JSX element.(2786)"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//    src={require("!/home/john/code/github/blog.johnnyreilly.com/blog-website/node_modules/url-loader/dist/cjs.js?limit=10000&amp;name=assets/images/[name]-[contenthash].[ext]&amp;fallback=/home/john/code/github/blog.johnnyreilly.com/blog-website/node_modules/file-loader/dist/cjs.js!./screenshot-typescript-playground.png").default}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//    width="690" height="298" /&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> match </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> asMarkdown</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token method function property-access" style="color:rgb(250, 208, 0)">match</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">srcRegex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">match</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> urlOrRequire </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> match</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token number" style="color:rgb(255, 98, 140)">1</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> cloudinaryRequireString </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token template-string string" style="color:rgb(165, 255, 144)">\`https://res.cloudinary.com/</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation">cloudName</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string string" style="color:rgb(165, 255, 144)">/image/fetch/f_auto,q_auto,w_auto,dpr_auto/</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation">baseUrl</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string string" style="color:rgb(165, 255, 144)">\$\{</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation">urlOrRequire</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string string" style="color:rgb(165, 255, 144)">\}\`</span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> newMarkdown </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> asMarkdown</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token method function property-access" style="color:rgb(250, 208, 0)">replace</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            srcRegex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token template-string string" style="color:rgb(165, 255, 144)"> src={</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation">cloudinaryRequireString</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string string" style="color:rgb(165, 255, 144)">}</span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// &lt;img</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//    alt="screenshot of typescript playground saying &amp;#39;ComponentThatReturnsANumber&amp;#39; cannot be used as a JSX component. Its return type &amp;#39;number&amp;#39; is not a valid JSX element.(2786)"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//    src={`https://res.cloudinary.com/priou/image/fetch/f_auto,q_auto,w_auto,dpr_auto/https://johnnyreilly.com${require("!/home/john/code/github/blog.johnnyreilly.com/blog-website/node_modules/url-loader/dist/cjs.js?limit=10000&amp;name=assets/images/[name]-[contenthash].[ext]&amp;fallback=/home/john/code/github/blog.johnnyreilly.com/blog-website/node_modules/file-loader/dist/cjs.js!./screenshot-typescript-playground.png").default}`}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//    width="690" height="298" /&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> tree </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">fromMarkdown</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">newMarkdown</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token literal-property property" style="color:rgb(255, 157, 0)">extensions</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token function" style="color:rgb(250, 208, 0)">mdxJsx</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> acorn</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token literal-property property" style="color:rgb(255, 157, 0)">addResult</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token literal-property property" style="color:rgb(255, 157, 0)">mdastExtensions</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token function" style="color:rgb(250, 208, 0)">mdxJsxFromMarkdown</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> newSrcAttributeIndex </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> tree</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">children</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token number" style="color:rgb(255, 98, 140)">0</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'attributes'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token method function property-access" style="color:rgb(250, 208, 0)">findIndex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token parameter">attr</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> attr</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">name</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'src'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">newSrcAttributeIndex </span><span class="token operator" style="color:rgb(255, 157, 0)">!==</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">-</span><span class="token number" style="color:rgb(255, 98, 140)">1</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            imgWithAttributes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">attributes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">srcIndex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">              tree</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">children</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token number" style="color:rgb(255, 98, 140)">0</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'attributes'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">newSrcAttributeIndex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Much is happening here. Let's go through it.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="commonjs-to-es-module-1">CommonJS to ES Module<a href="https://johnnyreilly.com/docusaurus-3-how-to-migrate-rehype-plugins#commonjs-to-es-module-1" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>This amounts to the same changes as the <code>fetchpriority</code> plugin. The old plugin has the name <code>cloudinary-rehype-plugin.js</code> and the new plugin has the name <code>cloudinary-rehype-plugin.mjs</code>. This is because the new plugin is an ES Module and the old plugin is CommonJS. Related to this, the old plugin used <code>module.exports = imageCloudinaryRehypePlugin</code> to expose functionality and the new plugin uses <code>export default imageCloudinaryRehypePlugin</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="different-ast-1">Different AST<a href="https://johnnyreilly.com/docusaurus-3-how-to-migrate-rehype-plugins#different-ast-1" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>We're dealing with a different AST and just need to tackle the <code>mdxJsxTextElement</code> which are similar to MDX 1's <code>jsx</code> nodes, but come with their own AST representation of expression based attributes in the <code>data</code> property.</p>
<p>The hardest part of this (and it is hard / confusing) is dealing with the <code>require</code> expression in the <code>src</code> attribute. What we do is:</p>
<ol>
<li>Convert the <code>mdxJsxTextElement</code> to back to markdown - this is the full <code>img</code> element in its AST form</li>
<li>Use a regex to find the <code>require</code> expression in the <code>src</code> attribute of the markdown</li>
<li>Transform the <code>require</code> expression to a Cloudinary URL using the same mechanism as with the MDX 1 plugin</li>
<li>Convert the markdown back to an <code>mdxJsxTextElement</code> using a technique adapted from <a href="https://github.com/syntax-tree/mdast-util-mdx-jsx#use" target="_blank" rel="noopener noreferrer"><code>mdast-util-mdx-jsx</code></a></li>
<li>Replace the <code>src</code> attribute with the new <code>src</code> attribute including the updated <code>require</code> expression AST in the <code>mdxJsxAttributeValueExpression</code> attributes <code>data</code> property.</li>
</ol>
<p>If you were to compare the MDX 1 plugin with the MDX 3 plugin, 2 and 3 from the above points are the same. Points 1, 4 and 5 are new.</p>
<p>With this in place we have a new plugin that works with Docusaurus 3 and MDX 3!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="rehype-cloudinary-docusaurus2"><code>rehype-cloudinary-docusaurus@2</code><a href="https://johnnyreilly.com/docusaurus-3-how-to-migrate-rehype-plugins#rehype-cloudinary-docusaurus2" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>You may recall that I published an npm package named <a href="https://www.npmjs.com/package/rehype-cloudinary-docusaurus" target="_blank" rel="noopener noreferrer"><code>rehype-cloudinary-docusaurus</code></a> which packages up the plugin to make it easy for people to use. I've updated that package to use the new plugin and it is available now. You can see the <a href="https://github.com/johnnyreilly/rehype-cloudinary-docusaurus/pull/9" target="_blank" rel="noopener noreferrer">pull request here</a>. The new version is <code>3.0.0</code>.</p>]]></content:encoded>
            <category>docusaurus</category>
        </item>
        <item>
            <title><![CDATA[Using Kernel Memory to Chunk Documents into Azure AI Search]]></title>
            <link>https://johnnyreilly.com/using-kernel-memory-to-chunk-documents-into-azure-ai-search</link>
            <guid>https://johnnyreilly.com/using-kernel-memory-to-chunk-documents-into-azure-ai-search</guid>
            <pubDate>Sun, 21 Apr 2024 08:47:49 GMT</pubDate>
            <description><![CDATA[To build RAG (Retrieval Augmented Generation) experiences, where LLMs can query documents, you need a strategy to chunk those documents. Kernel Memory supports this.]]></description>
            <content:encoded><![CDATA[<p>I've recently been working on building retrieval augmented generation (RAG) experiences into applications; building systems where large language models (LLMs) can query documents. To achieve this, we first need a strategy to chunk those documents and make them LLM-friendly. <a href="https://github.com/microsoft/kernel-memory" target="_blank" rel="noopener noreferrer">Kernel Memory</a>, a sister project of <a href="https://github.com/microsoft/semantic-kernel" target="_blank" rel="noopener noreferrer">Semantic Kernel</a> supports this.</p>
<p><img decoding="async" loading="eager" alt="title image reading &amp;quot;Using Kernel Memory to Chunk Documents into Azure AI Search&amp;quot; with the Azure Open AI / Azure AI Search logos" src="https://johnnyreilly.com/assets/images/title-image-337c58e5e55f92f59a1d1db49366ec04.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<p>If you haven't heard of Kernel Memory before, it's a library that, amongst other things, provides a way to chunk documents into smaller pieces. To quote the <a href="https://github.com/microsoft/kernel-memory?tab=readme-ov-file#kernel-memory-km-and-semantic-memory-sm" target="_blank" rel="noopener noreferrer">Kernel Memory GitHub repository</a>:</p>
<blockquote>
<p>Kernel Memory (KM) is a service built on the feedback received and lessons learned from developing Semantic Kernel (SK) and Semantic Memory (SM). It provides several features that would otherwise have to be developed manually, such as storing files, extracting text from files, providing a framework to secure users' data, etc. The KM codebase is entirely in .NET, which eliminates the need to write and maintain features in multiple languages. As a service, KM can be used from any language, tool, or platform, e.g. browser extensions and ChatGPT assistants.</p>
</blockquote>
<p>In this post, I'll show you how to use Kernel Memory to chunk documents in the background of an ASP.NET application.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="kernel-memory-serverless-vs-service">Kernel Memory: Serverless vs Service<a href="https://johnnyreilly.com/using-kernel-memory-to-chunk-documents-into-azure-ai-search#kernel-memory-serverless-vs-service" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>There's two ways that we can run Kernel Memory: "Serverless" and "Service".</p>
<p>Running the full service is more powerful, but effectively requires running a separate application. We would then need to integrate our main app with that. Given that I'm building with ASP.NET, I'll be using the serverless approach, which allows us to run Kernel Memory within the context of a single application (which will contain our main app code as well). We can then manage our integrations with Kernel Memory as simple method calls.</p>
<p>This is simpler and more cost-effective, but it does have some limitations. The service approach offers more features; including persistent retry logic. The documentation states that if we want to scale then we'll likely want to consider the service approach. But my own experience has been that serverless works very well for small to medium-sized applications.</p>
<p>Perhaps surprisingly, using serverless we can still have the experience of running Kernel Memory as a <strong>non-blocking</strong> separate service within the context of our ASP.NET application. This is achieved by running Kernel Memory as a <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/host/hosted-services?view=aspnetcore-8.0" target="_blank" rel="noopener noreferrer">hosted service</a> - this is the standard ASP.NET mechanism for running background tasks. That's what we're going to use.</p>
<p>There's four parts to bring this to life:</p>
<ol>
<li>Our Kernel Memory serverless instance - this is where the integration between Kernel Memory, Azure Open AI, Azure AI Search and the actual chunking takes place</li>
<li>A queue which we'll use to provide documents for chunking with Kernel Memory</li>
<li>Our hosted service which will bring together the queue and the Kernel Memory integration to manage our background document processing</li>
<li>An endpoint in our ASP.NET application to add documents to the queue</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-setting-up-kernel-memory-serverless">1. Setting up Kernel Memory serverless<a href="https://johnnyreilly.com/using-kernel-memory-to-chunk-documents-into-azure-ai-search#1-setting-up-kernel-memory-serverless" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>There's a number of dependencies that we need to add to our project to get Kernel Memory working. These are:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token plain">dotnet </span><span class="token function" style="color:rgb(250, 208, 0)">add</span><span class="token plain"> Azure.AI.OpenAI</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">dotnet </span><span class="token function" style="color:rgb(250, 208, 0)">add</span><span class="token plain"> Azure.AI.FormRecognizer </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># if we want to use Document Intelligence - not mandatory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">dotnet </span><span class="token function" style="color:rgb(250, 208, 0)">add</span><span class="token plain"> Azure.Identity</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">dotnet </span><span class="token function" style="color:rgb(250, 208, 0)">add</span><span class="token plain"> Azure.Storage.Blobs</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">dotnet </span><span class="token function" style="color:rgb(250, 208, 0)">add</span><span class="token plain"> Microsoft.KernelMemory.Core</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">dotnet </span><span class="token function" style="color:rgb(250, 208, 0)">add</span><span class="token plain"> Microsoft.SemanticKernel</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With this in place we'll start to integrate with Kernel Memory. We will first construct ourselves an <code>IKernelMemory</code> like so:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token plain">_memory </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">KernelMemoryBuilder</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">WithAzureOpenAITextEmbeddingGeneration</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">AzureOpenAIConfig</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        APIType </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> AzureOpenAIConfig</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">APITypes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">EmbeddingGeneration</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        Auth </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> AzureOpenAIConfig</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AuthTypes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AzureIdentity</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        Endpoint </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"https://cog-ourapp-dev.openai.azure.com/"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        Deployment </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"OpenAi-text-embedding-ada2"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// text-embedding-ada-002</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">WithAzureOpenAITextGeneration</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">AzureOpenAIConfig</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        APIType </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> AzureOpenAIConfig</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">APITypes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">ChatCompletion</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        Auth </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> AzureOpenAIConfig</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AuthTypes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AzureIdentity</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        Endpoint </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"https://cog-ourapp-dev.openai.azure.com/"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        Deployment </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"OpenAi-gpt-35-turbo-16k"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// gpt-3.5-turbo-16k</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">WithAzureAISearchMemoryDb</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">AzureAISearchConfig</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        Auth </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> AzureAISearchConfig</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AuthTypes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AzureIdentity</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        Endpoint </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"https://srch-ourapp-dev.search.windows.net"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// Only necessary if you want to add Document Intelligence</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">WithAzureAIDocIntel</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">AzureAIDocIntelConfig</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        Auth </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> AzureAIDocIntelConfig</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AuthTypes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AzureIdentity</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        Endpoint </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"https://cog-ourapp-dev.cognitiveservices.azure.com/"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Build</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>What we're doing here, is creating an <code>IKernelMemory</code> instance and making it aware of all our deployed Azure resources. Going through how to deploy those is out of the scope of this post, but it's probably worth highlighting that we're using <code>AzureIdentity</code> for auth as it's particularly secure, if you would like to use other options, you certainly can.</p>
<p>It's probably worth highlighting that we're using the <code>text-embedding-ada-002</code> model for text embedding and the <code>gpt-3.5-turbo-16k</code> model for text generation. These are the models that I've found to be most effective for my use cases. Of these, the text embedding model is the most important - it's the one that will be used to chunk documents.</p>
<p>You'll also note we're using Azure AI Document Intelligence; this is optional and just tackles a few more document chunking scenarios. It's not mandatory.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="chunking-with-kernel-memory-serverless">Chunking with Kernel Memory serverless<a href="https://johnnyreilly.com/using-kernel-memory-to-chunk-documents-into-azure-ai-search#chunking-with-kernel-memory-serverless" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>With our <code>IKernelMemory</code> ready to go, we now need a way to chunk documents. Deep down, this is achieved by acquiring the document we want to chunk from blob storage and passing it to <code>_memory.ImportDocumentAsync</code> with the name of the index we want to process into. You can see examples of this usage in the <a href="https://microsoft.github.io/kernel-memory/serverless" target="_blank" rel="noopener noreferrer">Kernel Memory docs</a>. You can also see how it works in the <a href="https://github.com/microsoft/kernel-memory/blob/9112757f4fe25edd7bfbf10222621f11422bd3b5/service/Core/MemoryServerless.cs#L89" target="_blank" rel="noopener noreferrer">Kernel Memory repository itself</a>.</p>
<p>However, it's often helpful to have a number of other things in place to manage:</p>
<ol>
<li>Applying tags to documents (this gives us more power when querying later)</li>
<li>Creating acceptable names / ids for the Azure AI Search Service</li>
<li>Handling rate limiting - more on that in a moment</li>
</ol>
<p>To that end, I tend to end up implementing a <code>Process</code> method that looks something like this:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Task</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">Process</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> index</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> documentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name" style="color:rgb(250, 208, 0)">TokenCredential</span><span class="token plain"> credential </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> _env</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">IsDevelopment</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">AzureCliCredential</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">DefaultAzureCredential</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">DefaultAzureCredentialOptions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        ManagedIdentityClientId </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"[Managed Identity ClientId Here]"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name" style="color:rgb(250, 208, 0)">BlobServiceClient</span><span class="token plain"> azureBlobServiceClient </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Uri</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"https://stourappdev.blob.core.windows.net"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> credential</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> containerClient </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> azureBlobServiceClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetBlobContainerClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">index</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// eg DocumentUrl: https://stourappdev.blob.core.windows.net/my-index/A%20Booklet.pdf</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> fileName </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> System</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Web</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">HttpUtility</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">UrlDecode</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">DocumentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Split</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token char" style="color:rgb(250, 208, 0)">'/'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Last</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> blobClient </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> containerClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetBlobClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">fileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name" style="color:rgb(250, 208, 0)">MemoryStream</span><span class="token plain"> documentContent </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> response </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> blobClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">DownloadToAsync</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">documentContent</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// example documentUrl:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// Chunking, getting embeddings for and storing for documentUrl consisting of 103469 characters in https://stourappdev.blob.core.windows.net/my-index/A%20Booklet.pdf</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogInformation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Chunking, getting embeddings for and storing for {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">documentUrl</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} consisting of {{count}} characters in {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">index</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}}"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentContent</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> index</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> documentId </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">MakeDocumentId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">documentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name" style="color:rgb(250, 208, 0)">TagCollection</span><span class="token plain"> tags </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"DocumentUrl"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentUrl </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"FileName"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> fileName </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> stopwatch </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Stopwatch</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    stopwatch</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Start</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">int</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">bool</span><span class="token plain"> done </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">false</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">int</span><span class="token plain"> attempt </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">0</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        attempt</span><span class="token operator" style="color:rgb(255, 157, 0)">++</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">attempt </span><span class="token operator" style="color:rgb(255, 157, 0)">==</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">4</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// if we've tried 3 times, give up</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">throw</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Failed to store document </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">documentUrl</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> after </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">attempt </span><span class="token interpolation-string interpolation expression language-csharp operator" style="color:rgb(255, 157, 0)">-</span><span class="token interpolation-string interpolation expression language-csharp"> </span><span class="token interpolation-string interpolation expression language-csharp number" style="color:rgb(255, 98, 140)">1</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> attempts and </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">stopwatch</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Elapsed</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">TotalSeconds</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> seconds"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">try</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">!=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogInformation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Waiting {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">waitForSeconds</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} seconds"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> waitForSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> Task</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Delay</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">TimeSpan</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">FromSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">waitForSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogInformation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"Importing documentId {documentId} attempt {attempt}"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> attempt</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> _memory</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">ImportDocumentAsync</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">content</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> documentContent</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">fileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> fileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">documentId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> documentId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">index</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> index</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">tags</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> tags</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            done </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">Microsoft</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token class-name" style="color:rgb(250, 208, 0)">SemanticKernel</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token class-name" style="color:rgb(250, 208, 0)">HttpOperationException</span><span class="token plain"> e</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">when</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">e</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">InnerException </span><span class="token keyword" style="color:rgb(255, 157, 0)">is</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">Azure</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token class-name" style="color:rgb(250, 208, 0)">RequestFailedException</span><span class="token plain"> azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">HandleRequestFailed</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">Azure</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token class-name" style="color:rgb(250, 208, 0)">RequestFailedException</span><span class="token plain"> azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">HandleRequestFailed</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token plain"> ex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">throw</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Error storing document </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">documentUrl</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> on attempt </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">attempt</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> after </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">stopwatch</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Elapsed</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">TotalSeconds</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> seconds"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> ex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">while</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token operator" style="color:rgb(255, 157, 0)">!</span><span class="token plain">done</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    stopwatch</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Stop</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogInformation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Processed {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">documentId</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} into {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">index</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} index in {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">stopwatch</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Elapsed</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">TotalSeconds</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} seconds"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> index</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> stopwatch</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Elapsed</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">TotalSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token return-type class-name keyword" style="color:rgb(255, 157, 0)">int</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">HandleRequestFailed</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">Azure</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token class-name" style="color:rgb(250, 208, 0)">RequestFailedException</span><span class="token plain"> azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">int</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> waitForSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> response </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetRawResponse</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> retryAfterSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> response</span><span class="token punctuation" style="color:rgb(255, 255, 255)">?.</span><span class="token plain">Headers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">FirstOrDefault</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">h </span><span class="token operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> h</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Name </span><span class="token operator" style="color:rgb(255, 157, 0)">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"x-ratelimit-reset-requests"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Value</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token operator" style="color:rgb(255, 157, 0)">??</span><span class="token plain"> response</span><span class="token punctuation" style="color:rgb(255, 255, 255)">?.</span><span class="token plain">Headers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">FirstOrDefault</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">h </span><span class="token operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> h</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Name </span><span class="token operator" style="color:rgb(255, 157, 0)">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Retry-After"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//x-ratelimit-reset-requests: 4,x-ms-client-request-id: XXXX,apim-request-id: 69569dd5-2e4a-4bfa-9b52-f3eb08481a83,Strict-Transport-Security: max-age=31536000; includeSubDomains; preload,X-Content-Type-Options: nosniff,policy-id: DeploymentRatelimit-Call,x-ms-region: West Europe,Date: Fri, 01 Dec 2023 13:29:12 GMT,Content-Length: 85,Content-Type: application/json</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> retryAfterSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">!=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">int</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Parse</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">retryAfterSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">==</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> pattern </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">@"Try again in (\d+) seconds"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> match </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> Regex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Match</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Message</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> pattern</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// wait for 60 seconds if a specific value is not provided</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> match</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Success </span><span class="token operator" style="color:rgb(255, 157, 0)">&amp;&amp;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">int</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">TryParse</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">match</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Groups</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token number" style="color:rgb(255, 98, 140)">1</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">out</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">int</span><span class="token plain"> seconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> seconds </span><span class="token operator" style="color:rgb(255, 157, 0)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">1</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">60</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Status </span><span class="token operator" style="color:rgb(255, 157, 0)">==</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">int</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain">System</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Net</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">HttpStatusCode</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">TooManyRequests</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// var headers = response?.Headers.Select(h =&gt; $"{h.Name}: {h.Value}").ToList() ?? new List&lt;string&gt;();</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// _logger.LogWarning(azureRequestFailedException, $"429 - too many requests, will wait {{{nameof(waitForSeconds)}}} seconds - HEADERS: {{{nameof(headers)}}}", waitForSeconds, string.Join(",", headers));</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogWarning</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"429 - too many requests, will wait {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">waitForSeconds</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} seconds"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> waitForSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> headers </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> response</span><span class="token punctuation" style="color:rgb(255, 255, 255)">?.</span><span class="token plain">Headers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Select</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">h </span><span class="token operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> </span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">h</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Name</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">: </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">h</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Value</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">ToList</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">??</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogError</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Azure.RequestFailedException - {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">azureRequestFailedException</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Status</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} status code, will wait {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">waitForSeconds</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} seconds - HEADERS: {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">headers</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}}"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Status</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> waitForSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">string</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Join</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">","</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> headers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> waitForSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">/// &lt;summary&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">/// Make a documentId from a fileName; remove all characters except A-Z, a-z, 0-9, ., _, -</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">/// &lt;/summary&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">MakeDocumentId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> fileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> Regex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Replace</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">fileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"[^A-Za-z0-9._-]"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">""</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// eg "A Booklet.pdf"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Much of the code above concerns rate limiting / 429s. It's not uncommon when chunking to be hit by 429s - "Too many requests". Chunking documents requires use of Azure Open AI resources, and the level of access we have is typically restricted and controlled via quotas. There's an element of this that we can avoid by controlling the quota available on our Azure Open AI deployments (<a href="https://johnnyreilly.com/azure-open-ai-capacity-quota-bicep">you can read more about this here</a>), and we can implement a certain amount of retry logic also.</p>
<p>The code above tries to handle a number of re-attempts as wisely as it can, and using the information that Azure APIs surface around when re-attempting is allowed. Interestingly you'll see a variety of strategies employed here around retry times, as the way information is surfaced to support this keeps changing! We can likely have less code in future when a final standard is committed to.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="bringing-it-together">Bringing it together<a href="https://johnnyreilly.com/using-kernel-memory-to-chunk-documents-into-azure-ai-search#bringing-it-together" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>We're going to put this all together in a single class called <code>RagGestionService</code>.</p>
<p>You might be puzzled by the name "RagGestion" - this is a term my good friend <a href="https://medium.com/@georgekarsas" target="_blank" rel="noopener noreferrer">George Karsas</a> coined to describe the process of preparing documents for Retrieval Augmented Generation. It's a great term, and I've adopted it!</p>
<p>The <code>RagGestionService</code> will look like this:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Azure</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Storage</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Blobs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Azure</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Core</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Azure</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Identity</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Microsoft</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">KernelMemory</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">OurApp</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Model</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">System</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Diagnostics</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">System</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Text</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">RegularExpressions</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">System</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Text</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Json</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">namespace</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">OurApp</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">interface</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">IRagGestionService</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Task</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">Process</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> indexName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> documentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">RagGestionService</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token type-list class-name" style="color:rgb(250, 208, 0)">IRagGestionService</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">IKernelMemory</span><span class="token plain"> _memory</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">RagGestionService</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">RagGestionService</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">RagGestionService</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> logger</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _logger </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _memory </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">KernelMemoryBuilder</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">WithAzureOpenAITextEmbeddingGeneration</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">AzureOpenAIConfig</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                APIType </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> AzureOpenAIConfig</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">APITypes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">EmbeddingGeneration</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                Auth </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> AzureOpenAIConfig</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AuthTypes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AzureIdentity</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                Endpoint </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"https://cog-ourapp-dev.openai.azure.com/"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                Deployment </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"OpenAi-text-embedding-ada2"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">WithAzureOpenAITextGeneration</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">AzureOpenAIConfig</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                APIType </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> AzureOpenAIConfig</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">APITypes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">ChatCompletion</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                Auth </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> AzureOpenAIConfig</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AuthTypes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AzureIdentity</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                Endpoint </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"https://cog-ourapp-dev.openai.azure.com/"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                Deployment </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"OpenAi-gpt-35-turbo-16k"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">WithAzureAISearchMemoryDb</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">AzureAISearchConfig</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                Auth </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> AzureAISearchConfig</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AuthTypes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AzureIdentity</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                Endpoint </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"https://srch-ourapp-dev.search.windows.net"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// Only necessary if we want to add Document Intelligence</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">WithAzureAIDocIntel</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">AzureAIDocIntelConfig</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                Auth </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> AzureAIDocIntelConfig</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AuthTypes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AzureIdentity</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                Endpoint </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"https://cog-ourapp-dev.cognitiveservices.azure.com/"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Build</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Task</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">Process</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> index</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> documentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">TokenCredential</span><span class="token plain"> credential </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> _env</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">IsDevelopment</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">AzureCliCredential</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">DefaultAzureCredential</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">DefaultAzureCredentialOptions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            ManagedIdentityClientId </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"[Managed Identity ClientId Here]"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">BlobServiceClient</span><span class="token plain"> azureBlobServiceClient </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Uri</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"https://stourappdev.blob.core.windows.net"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> credential</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> containerClient </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> azureBlobServiceClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetBlobContainerClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">index</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// eg DocumentUrl: https://stourappdev.blob.core.windows.net/my-index/A%20Booklet.pdf</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> fileName </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> System</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Web</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">HttpUtility</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">UrlDecode</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">DocumentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Split</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token char" style="color:rgb(250, 208, 0)">'/'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Last</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> blobClient </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> containerClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetBlobClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">fileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">MemoryStream</span><span class="token plain"> documentContent </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> response </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> blobClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">DownloadToAsync</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">documentContent</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// example documentUrl:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// Chunking, getting embeddings for and storing for documentUrl consisting of 103469 characters in https://stourappdev.blob.core.windows.net/my-index/A%20Booklet.pdf</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogInformation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Chunking, getting embeddings for and storing for {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">documentUrl</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} consisting of {{count}} characters in {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">index</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}}"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentContent</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> index</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> documentId </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">MakeDocumentId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">documentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">TagCollection</span><span class="token plain"> tags </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"DocumentUrl"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentUrl </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"FileName"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> fileName </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> stopwatch </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Stopwatch</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        stopwatch</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Start</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">int</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">bool</span><span class="token plain"> done </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">false</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">int</span><span class="token plain"> attempt </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">0</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            attempt</span><span class="token operator" style="color:rgb(255, 157, 0)">++</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">attempt </span><span class="token operator" style="color:rgb(255, 157, 0)">==</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">4</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// if we've tried 3 times, give up</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token keyword" style="color:rgb(255, 157, 0)">throw</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Failed to store document </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">documentUrl</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> after </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">attempt </span><span class="token interpolation-string interpolation expression language-csharp operator" style="color:rgb(255, 157, 0)">-</span><span class="token interpolation-string interpolation expression language-csharp"> </span><span class="token interpolation-string interpolation expression language-csharp number" style="color:rgb(255, 98, 140)">1</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> attempts and </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">stopwatch</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Elapsed</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">TotalSeconds</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> seconds"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">try</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">!=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogInformation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Waiting {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">waitForSeconds</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} seconds"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> waitForSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> Task</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Delay</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">TimeSpan</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">FromSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">waitForSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogInformation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"Importing documentId {documentId} attempt {attempt}"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> attempt</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> _memory</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">ImportDocumentAsync</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">content</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> documentContent</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">fileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> fileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">documentId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> documentId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">index</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> index</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">tags</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> tags</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                done </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">Microsoft</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token class-name" style="color:rgb(250, 208, 0)">SemanticKernel</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token class-name" style="color:rgb(250, 208, 0)">HttpOperationException</span><span class="token plain"> e</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">when</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">e</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">InnerException </span><span class="token keyword" style="color:rgb(255, 157, 0)">is</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">Azure</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token class-name" style="color:rgb(250, 208, 0)">RequestFailedException</span><span class="token plain"> azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">HandleRequestFailed</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">Azure</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token class-name" style="color:rgb(250, 208, 0)">RequestFailedException</span><span class="token plain"> azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">HandleRequestFailed</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token plain"> ex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token keyword" style="color:rgb(255, 157, 0)">throw</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Error storing document </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">documentUrl</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> on attempt </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">attempt</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> after </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">stopwatch</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Elapsed</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">TotalSeconds</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> seconds"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> ex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">while</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token operator" style="color:rgb(255, 157, 0)">!</span><span class="token plain">done</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        stopwatch</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Stop</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogInformation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Processed {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">documentId</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} into {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">index</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} index in {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">stopwatch</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Elapsed</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">TotalSeconds</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} seconds"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> index</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> stopwatch</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Elapsed</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">TotalSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token return-type class-name keyword" style="color:rgb(255, 157, 0)">int</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">HandleRequestFailed</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">Azure</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token class-name" style="color:rgb(250, 208, 0)">RequestFailedException</span><span class="token plain"> azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">int</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> waitForSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> response </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetRawResponse</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> retryAfterSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> response</span><span class="token punctuation" style="color:rgb(255, 255, 255)">?.</span><span class="token plain">Headers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">FirstOrDefault</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">h </span><span class="token operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> h</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Name </span><span class="token operator" style="color:rgb(255, 157, 0)">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"x-ratelimit-reset-requests"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Value</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token operator" style="color:rgb(255, 157, 0)">??</span><span class="token plain"> response</span><span class="token punctuation" style="color:rgb(255, 255, 255)">?.</span><span class="token plain">Headers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">FirstOrDefault</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">h </span><span class="token operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> h</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Name </span><span class="token operator" style="color:rgb(255, 157, 0)">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Retry-After"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//x-ratelimit-reset-requests: 4,x-ms-client-request-id: XXXX,apim-request-id: 69569dd5-2e4a-4bfa-9b52-f3eb08481a83,Strict-Transport-Security: max-age=31536000; includeSubDomains; preload,X-Content-Type-Options: nosniff,policy-id: DeploymentRatelimit-Call,x-ms-region: West Europe,Date: Fri, 01 Dec 2023 13:29:12 GMT,Content-Length: 85,Content-Type: application/json</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> retryAfterSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">!=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">int</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Parse</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">retryAfterSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">==</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> pattern </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">@"Try again in (\d+) seconds"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> match </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> Regex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Match</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Message</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> pattern</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// wait for 60 seconds if a specific value is not provided</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            waitForSeconds </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> match</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Success </span><span class="token operator" style="color:rgb(255, 157, 0)">&amp;&amp;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">int</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">TryParse</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">match</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Groups</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token number" style="color:rgb(255, 98, 140)">1</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">out</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">int</span><span class="token plain"> seconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> seconds </span><span class="token operator" style="color:rgb(255, 157, 0)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">1</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">60</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Status </span><span class="token operator" style="color:rgb(255, 157, 0)">==</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">int</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain">System</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Net</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">HttpStatusCode</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">TooManyRequests</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// var headers = response?.Headers.Select(h =&gt; $"{h.Name}: {h.Value}").ToList() ?? new List&lt;string&gt;();</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// _logger.LogWarning(azureRequestFailedException, $"429 - too many requests, will wait {{{nameof(waitForSeconds)}}} seconds - HEADERS: {{{nameof(headers)}}}", waitForSeconds, string.Join(",", headers));</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogWarning</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"429 - too many requests, will wait {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">waitForSeconds</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} seconds"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> waitForSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> headers </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> response</span><span class="token punctuation" style="color:rgb(255, 255, 255)">?.</span><span class="token plain">Headers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Select</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">h </span><span class="token operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> </span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">h</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Name</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">: </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">h</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Value</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">ToList</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">??</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogError</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Azure.RequestFailedException - {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">azureRequestFailedException</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Status</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} status code, will wait {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">waitForSeconds</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} seconds - HEADERS: {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">headers</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}}"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> azureRequestFailedException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Status</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> waitForSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">string</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Join</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">","</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> headers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> waitForSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">/// &lt;summary&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">/// Make a documentId from a fileName; remove all characters except A-Z, a-z, 0-9, ., _, -</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">/// &lt;/summary&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">MakeDocumentId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> fileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> Regex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Replace</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">fileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"[^A-Za-z0-9._-]"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">""</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// eg "A Booklet.pdf"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>By the way, I don't advise hard-coding the Azure resources as I have here, but rather passing them in as configuration. Incidentally, we could also use dependency injection to inject a prepared <code>IKernelMemory</code> instance into the service, but again, I'm keeping it simple here for clarity.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-our-document-processor-queue">2. Our document processor queue<a href="https://johnnyreilly.com/using-kernel-memory-to-chunk-documents-into-azure-ai-search#2-our-document-processor-queue" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>In order that we have a way to provide documents for chunking, we need a queue. This is a simple queue that we can add documents to, and then process them in the background. We're going to use a <code>ConcurrentQueue</code> for this, with a little wrapper around it so we can encapsulate the queue for sharing between our UI and our background task, and also to do some logging.</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">System</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Collections</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Concurrent</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">OurApp</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Model</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">namespace</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">OurApp</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Services</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Implementations</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">record</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">DocumentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> DocumentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> IndexName</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">interface</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">IDocumentProcessorQueue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">DocumentToProcess</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">DequeueDocumentUri</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token return-type class-name keyword" style="color:rgb(255, 157, 0)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">EnqueueDocumentUri</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">DocumentToProcess</span><span class="token plain"> documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">DocumentProcessorQueue</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token type-list class-name" style="color:rgb(250, 208, 0)">IDocumentProcessorQueue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">ConcurrentQueue</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">DocumentToProcess</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> _documentUrlQueue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">DocumentProcessorQueue</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">DocumentProcessorQueue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">DocumentProcessorQueue</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _documentUrlQueue </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _logger </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:rgb(255, 157, 0)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">EnqueueDocumentUri</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">DocumentToProcess</span><span class="token plain"> documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogInformation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Adding document for background processing onto {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">documentToProcess</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">IndexName</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} index later: {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">documentToProcess</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">DocumentUrl</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} ({{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">_documentUrlQueue</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Count</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} items on queue)"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">IndexName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">DocumentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> _documentUrlQueue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Count</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _documentUrlQueue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Enqueue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">DocumentToProcess</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">DequeueDocumentUri</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">_documentUrlQueue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">TryDequeue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">out</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogInformation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Document picked up for background processing onto {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">documentToProcess</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">IndexName</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} index: {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">documentToProcess</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">DocumentUrl</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} ({{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">_documentUrlQueue</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Count</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} items remain on queue)"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">IndexName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">DocumentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> _documentUrlQueue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Count</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>EnqueueDocumentUri</code> method above will be called from the context of our UI - from an ASP.NET controller. This will be invoked when someone uploads a file and will also be responsible for adding the file to a BlobService for storage prior to processing.</p>
<p>By contrast, the <code>DequeueDocumentUri</code> method will be called from the context of our background service; it will call this method to pick up a file for processing.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-our-background-service">3. Our background service<a href="https://johnnyreilly.com/using-kernel-memory-to-chunk-documents-into-azure-ai-search#3-our-background-service" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Next, we need a background service to bring together our <code>DocumentProcessorQueue</code> and our <code>RagGestionService</code>. This is a standard ASP.NET hosted service. It will look like this:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">OurApp</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Model</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">OurApp</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">namespace</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">OurApp</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">BackgroundServices</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">DocumentProcessorBackgroundService</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token type-list class-name" style="color:rgb(250, 208, 0)">BackgroundService</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">DocumentProcessorBackgroundService</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">IServiceProvider</span><span class="token plain"> _services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">DocumentProcessorBackgroundService</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">IServiceProvider</span><span class="token plain"> services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">DocumentProcessorBackgroundService</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _services </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _logger </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">protected</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">override</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Task</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">ExecuteAsync</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">CancellationToken</span><span class="token plain"> stoppingToken</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">try</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogInformation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"Starting RagGestion"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> ragGestionService </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> _services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token generic-method function" style="color:rgb(250, 208, 0)">GetRequiredService</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)">IRagGestionService</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> documentProcessorQueue </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> _services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token generic-method function" style="color:rgb(250, 208, 0)">GetRequiredService</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)">IDocumentProcessorQueue</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">PerformRagGestion</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">env</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> chunkerService</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentProcessorQueue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> stoppingToken</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogError</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">e</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Error processing document"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Task</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">PerformRagGestion</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">IRagGestionService</span><span class="token plain"> ragGestionService</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">IDocumentProcessorQueue</span><span class="token plain"> documentProcessorQueue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">CancellationToken</span><span class="token plain"> stoppingToken</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">while</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token operator" style="color:rgb(255, 157, 0)">!</span><span class="token plain">stoppingToken</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">IsCancellationRequested</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> Task</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Delay</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">TimeSpan</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">FromSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token number" style="color:rgb(255, 98, 140)">5</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> stoppingToken</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token class-name" style="color:rgb(250, 208, 0)">DocumentToProcess</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> documentToProcess </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> documentProcessorQueue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">DequeueDocumentUri</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">documentToProcess </span><span class="token operator" style="color:rgb(255, 157, 0)">==</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogDebug</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"No documents to process"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token keyword" style="color:rgb(255, 157, 0)">continue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">try</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> watch </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> System</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Diagnostics</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Stopwatch</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">StartNew</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogInformation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Processing document: {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">documentToProcess</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">DocumentUrl</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}}"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">DocumentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> ragGestionService</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Process</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">indexName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">IndexName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">documentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">DocumentUrl</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                watch</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Stop</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogInformation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Chunked and stored {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">documentToProcess</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">DocumentUrl</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} into Azure AI Search {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">documentToProcess</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">IndexName</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} index in {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">watch</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Elapsed</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">Seconds</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}} seconds"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">DocumentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">IndexName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> watch</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Elapsed</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">TotalSeconds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogError</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">e</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Error processing document: {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">documentToProcess</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}}"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> documentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This service will run in the background of the ASP.NET application, will pick up documents from the queue (if there are any) and pass them to the <code>RagGestionService</code> for processing. It will trigger every 5 seconds, running for the lifetime of the application.</p>
<p>You'll see we're doing some timing here - this is because it's useful to know how long the process takes. If we're processing a lot of documents, we'll want to know how long it's taking to process each one.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-adding-documents-to-the-queue">4. Adding documents to the queue<a href="https://johnnyreilly.com/using-kernel-memory-to-chunk-documents-into-azure-ai-search#4-adding-documents-to-the-queue" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>To add documents to the queue, we'll need to create an endpoint in our ASP.NET application. This endpoint will accept files and add them to the queue. Here's an example of how we might do that:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Microsoft</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">AspNetCore</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Mvc</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Azure</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Storage</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Blobs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Azure</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Identity</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Azure</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Core</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">namespace</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">OurApp</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Controllers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">record</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">UploadedFile</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> FileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">bool</span><span class="token plain"> Succeeded</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">long</span><span class="token plain"> Size</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> DocumentUrl</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token attribute class-name" style="color:rgb(250, 208, 0)">ApiController</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">UploadController</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token type-list class-name" style="color:rgb(250, 208, 0)">ControllerBase</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">IDocumentProcessorQueue</span><span class="token plain"> _documentProcessorQueue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">UploadController</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> _log</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">IHostEnvironment</span><span class="token plain"> _env</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">UploadController</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">UploadController</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> log</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">IHostEnvironment</span><span class="token plain"> env</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">IDocumentProcessorQueue</span><span class="token plain"> documentProcessorQueue</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _log </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> log</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _env </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> env</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _documentProcessorQueue </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> documentProcessorQueue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token attribute class-name" style="color:rgb(250, 208, 0)">RequestSizeLimit</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token attribute attribute-arguments number" style="color:rgb(255, 98, 140)">104857600</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// For files of up to 100 MB - perhaps larger than you'd want to upload in a single go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token function" style="color:rgb(250, 208, 0)">HttpPost</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"api/</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">UploadFiles</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token attribute class-name" style="color:rgb(250, 208, 0)">ProducesResponseType</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token attribute attribute-arguments">StatusCodes</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token attribute attribute-arguments">Status200OK</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token attribute attribute-arguments"> Type </span><span class="token attribute attribute-arguments operator" style="color:rgb(255, 157, 0)">=</span><span class="token attribute attribute-arguments"> </span><span class="token attribute attribute-arguments keyword" style="color:rgb(255, 157, 0)">typeof</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token attribute attribute-arguments type-expression class-name" style="color:rgb(250, 208, 0)">List</span><span class="token attribute attribute-arguments type-expression class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token attribute attribute-arguments type-expression class-name" style="color:rgb(250, 208, 0)">UploadedFile</span><span class="token attribute attribute-arguments type-expression class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token attribute class-name" style="color:rgb(250, 208, 0)">ProducesResponseType</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token attribute attribute-arguments">StatusCodes</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token attribute attribute-arguments">Status403Forbidden</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token attribute attribute-arguments"> Type </span><span class="token attribute attribute-arguments operator" style="color:rgb(255, 157, 0)">=</span><span class="token attribute attribute-arguments"> </span><span class="token attribute attribute-arguments keyword" style="color:rgb(255, 157, 0)">typeof</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token attribute attribute-arguments type-expression class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token attribute class-name" style="color:rgb(250, 208, 0)">ProducesResponseType</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token attribute attribute-arguments">StatusCodes</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token attribute attribute-arguments">Status404NotFound</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token attribute attribute-arguments"> Type </span><span class="token attribute attribute-arguments operator" style="color:rgb(255, 157, 0)">=</span><span class="token attribute attribute-arguments"> </span><span class="token attribute attribute-arguments keyword" style="color:rgb(255, 157, 0)">typeof</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token attribute attribute-arguments type-expression class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Task</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">ActionResult</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">List</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">UploadedFile</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">UploadFiles</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token attribute class-name" style="color:rgb(250, 208, 0)">FromQuery</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> indexName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">List</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">IFormFile</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> files</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> processedFiles </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">List</span><span class="token constructor-invocation class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">UploadedFile</span><span class="token constructor-invocation class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">try</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">foreach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> formFile </span><span class="token keyword" style="color:rgb(255, 157, 0)">in</span><span class="token plain"> files</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token keyword" style="color:rgb(255, 157, 0)">try</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token class-name" style="color:rgb(250, 208, 0)">TokenCredential</span><span class="token plain"> credential </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> _env</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">IsDevelopment</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">AzureCliCredential</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">DefaultAzureCredential</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">DefaultAzureCredentialOptions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                        ManagedIdentityClientId </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"[Managed Identity ClientId Here]"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token class-name" style="color:rgb(250, 208, 0)">BlobServiceClient</span><span class="token plain"> azureBlobServiceClient </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                        </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Uri</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"https://stourappdev.blob.core.windows.net"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> credential</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> containerClient </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> azureBlobServiceClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetBlobContainerClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">indexName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token operator" style="color:rgb(255, 157, 0)">!</span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> containerClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">ExistsAsync</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                        </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> containerClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">CreateIfNotExistsAsync</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> blobClient </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> containerClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetBlobClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">formFile</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">FileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token class-name" style="color:rgb(250, 208, 0)">StreamReader</span><span class="token plain"> streamReader </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">formFile</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">OpenReadStream</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> uploaded </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> blobClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">UploadAsync</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">streamReader</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">BaseStream</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">overwrite</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> uploadedFile </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">UploadedFile</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">FileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> formFile</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">FileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">Succeeded</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">Size</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> formFile</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">DocumentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> blobClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Uri</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AbsoluteUri</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    processedFiles</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Add</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">uploadedFile</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    _documentProcessorQueue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">EnqueueDocumentUri</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                        </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">DocumentToProcess</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                            </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">DocumentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> uploadedFile</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">DocumentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                            </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">IndexName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> indexName</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token plain"> ex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    processedFiles</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Add</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">UploadedFile</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">FileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> formFile</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">FileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">Succeeded</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">false</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">Size</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> formFile</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">DocumentUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">string</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Empty</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    _log</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogError</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">ex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Failed to upload {file}"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> formFile</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">FileName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">Ok</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">processedFiles</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token plain"> ex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            _log</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogError</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">ex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Problem uploading files"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">BadRequest</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"Problem uploading files"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As we can see, this endpoint:</p>
<ol>
<li>Accepts files from a POST request with an index name in the querystring</li>
<li>Uploads them to Blob Storage (matching the container name to the index they will be processed into in future)</li>
<li>Adds them to the queue with <code>_documentProcessorQueue.EnqueueDocumentUri</code>. This will then be picked up by the background service and processed.</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="registering-our-services">Registering our services<a href="https://johnnyreilly.com/using-kernel-memory-to-chunk-documents-into-azure-ai-search#registering-our-services" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Finally, we'll need to register our services in the <code>Program.cs</code> file. We'll want to add the following:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token plain">builder</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Services</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token generic-method function" style="color:rgb(250, 208, 0)">AddSingleton</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)">IRagGestionService</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)"> RagGestionService</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token generic-method function" style="color:rgb(250, 208, 0)">AddSingleton</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)">IDocumentProcessorQueue</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)"> DocumentProcessorQueue</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token generic-method function" style="color:rgb(250, 208, 0)">AddHostedService</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)">DocumentProcessorBackgroundService</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With this in place we have an application that can upload documents and chunk them in the background.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://johnnyreilly.com/using-kernel-memory-to-chunk-documents-into-azure-ai-search#conclusion" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>And that's it! This is an ASP.NET application that can chunk documents (or RagGest üòâ) in the background using Kernel Memory running in serverless mode. I haven't yet had the need to upgrade to the full Kernel Memory service. Perhaps the day will come, but the mileage we can get with this approach is considerable.</p>
<p>Many thanks to <a href="https://github.com/drosevear" target="_blank" rel="noopener noreferrer">David Rosevear</a> and <a href="https://www.linkedin.com/in/george-karsas" target="_blank" rel="noopener noreferrer">George Karsas</a> for their help working on this mechanism. And George for "RagGestion" - I love it!</p>]]></content:encoded>
            <category>azure</category>
            <category>c#</category>
            <category>asp.net</category>
            <category>ai</category>
        </item>
        <item>
            <title><![CDATA[Text-first MUI Tabs]]></title>
            <link>https://johnnyreilly.com/text-first-mui-tabs</link>
            <guid>https://johnnyreilly.com/text-first-mui-tabs</guid>
            <pubDate>Wed, 20 Mar 2024 11:34:49 GMT</pubDate>
            <description><![CDATA[Learn how to use the MUI tabs component in a text first way that remains strongly typed.]]></description>
            <content:encoded><![CDATA[<p>I love the Material-UI (MUI) library for React. Hand on heart, I'm not very good at making UIs that are attractive. So I always grab for something to paper over the cracks. MUI is awesome for that.</p>
<p>One of the components that I use frequently is the <a href="https://mui.com/material-ui/react-tabs/" target="_blank" rel="noopener noreferrer">tabs component</a>. However, I've found that it can be a little tricky to use in a "text-first" way, that also remains strongly typed. This post documents how to do just that!</p>
<p><img decoding="async" loading="eager" alt="title image reading &amp;quot;Text-first MUI Tabs&amp;quot; with the MUI logo" src="https://johnnyreilly.com/assets/images/title-image-fae370d4476e00436aeda389c5ff8423.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="official-example">Official example<a href="https://johnnyreilly.com/text-first-mui-tabs#official-example" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>What does the tabs component look like? Well, here's a screenshot of it in action:</p>
<p><img decoding="async" loading="lazy" alt="screenshot of the tabs component" src="https://johnnyreilly.com/assets/images/screenshot-mui-tabs-5d4bdd365e8a259d3de2651bec27d630.png" width="690" height="312" class="img_ev3q"></p>
<p>It's very useful if you'd like your users to be able to switch between different views easily. The official MUI documentation provides an example of how to use the tabs component:</p>
<div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> </span><span class="token imports operator" style="color:rgb(255, 157, 0)">*</span><span class="token imports"> </span><span class="token imports keyword module" style="color:rgb(255, 157, 0)">as</span><span class="token imports"> </span><span class="token imports maybe-class-name">React</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'react'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">Tabs</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'@mui/material/Tabs'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">Tab</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'@mui/material/Tab'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">Typography</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'@mui/material/Typography'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">Box</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'@mui/material/Box'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">interface</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">TabPanelProps</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  children</span><span class="token operator" style="color:rgb(255, 157, 0)">?</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access maybe-class-name">ReactNode</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  index</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(250, 208, 0)">number</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(250, 208, 0)">number</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">CustomTabPanel</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">props</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token maybe-class-name">TabPanelProps</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> children</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> index</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token spread operator" style="color:rgb(255, 157, 0)">...</span><span class="token plain">other </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> props</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag" style="color:rgb(255, 157, 0)">div</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">      </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">role</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(255, 255, 255)">=</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag attr-value" style="color:rgb(255, 157, 0)">tabpanel</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">      </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">hidden</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)">value </span><span class="token tag script language-javascript operator" style="color:rgb(255, 157, 0)">!==</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> index</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">      </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">id</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token tag script language-javascript template-string string" style="color:rgb(165, 255, 144)">simple-tabpanel-</span><span class="token tag script language-javascript template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token tag script language-javascript template-string interpolation" style="color:rgb(255, 157, 0)">index</span><span class="token tag script language-javascript template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag script language-javascript template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">      </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">aria-labelledby</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token tag script language-javascript template-string string" style="color:rgb(165, 255, 144)">simple-tab-</span><span class="token tag script language-javascript template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token tag script language-javascript template-string interpolation" style="color:rgb(255, 157, 0)">index</span><span class="token tag script language-javascript template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag script language-javascript template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">      </span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag spread operator" style="color:rgb(255, 157, 0)">...</span><span class="token tag spread" style="color:rgb(255, 157, 0)">other</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">    </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain">value </span><span class="token operator" style="color:rgb(255, 157, 0)">===</span><span class="token plain"> index </span><span class="token operator" style="color:rgb(255, 157, 0)">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Box</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">sx</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> p</span><span class="token tag script language-javascript operator" style="color:rgb(255, 157, 0)">:</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> </span><span class="token tag script language-javascript number" style="color:rgb(255, 98, 140)">3</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> </span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">          </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Typography</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain">children</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Typography</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">        </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Box</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag" style="color:rgb(255, 157, 0)">div</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">a11yProps</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">index</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(250, 208, 0)">number</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    id</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token template-string string" style="color:rgb(165, 255, 144)">simple-tab-</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation">index</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token string-property property" style="color:rgb(255, 157, 0)">'aria-controls'</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token template-string string" style="color:rgb(165, 255, 144)">simple-tabpanel-</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation">index</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">export</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">default</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">BasicTabs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> setValue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token method function property-access" style="color:rgb(250, 208, 0)">useState</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token number" style="color:rgb(255, 98, 140)">0</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:rgb(250, 208, 0)">handleChange</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">event</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access maybe-class-name">SyntheticEvent</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> newValue</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(250, 208, 0)">number</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token function" style="color:rgb(250, 208, 0)">setValue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">newValue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Box</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">sx</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> width</span><span class="token tag script language-javascript operator" style="color:rgb(255, 157, 0)">:</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> </span><span class="token tag script language-javascript string" style="color:rgb(165, 255, 144)">'100%'</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> </span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Box</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">sx</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> borderBottom</span><span class="token tag script language-javascript operator" style="color:rgb(255, 157, 0)">:</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> </span><span class="token tag script language-javascript number" style="color:rgb(255, 98, 140)">1</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> borderColor</span><span class="token tag script language-javascript operator" style="color:rgb(255, 157, 0)">:</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> </span><span class="token tag script language-javascript string" style="color:rgb(165, 255, 144)">'divider'</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> </span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">        </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Tabs</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">          </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">value</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)">value</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">          </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">onChange</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)">handleChange</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">          </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">aria-label</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(255, 255, 255)">=</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag attr-value" style="color:rgb(255, 157, 0)">basic tabs example</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">        </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">          </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Tab</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">label</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(255, 255, 255)">=</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag attr-value" style="color:rgb(255, 157, 0)">Item One</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag spread operator" style="color:rgb(255, 157, 0)">...</span><span class="token tag spread method function property-access" style="color:rgb(250, 208, 0)">a11yProps</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token tag spread number" style="color:rgb(255, 98, 140)">0</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">          </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Tab</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">label</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(255, 255, 255)">=</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag attr-value" style="color:rgb(255, 157, 0)">Item Two</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag spread operator" style="color:rgb(255, 157, 0)">...</span><span class="token tag spread method function property-access" style="color:rgb(250, 208, 0)">a11yProps</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token tag spread number" style="color:rgb(255, 98, 140)">1</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">          </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Tab</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">label</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(255, 255, 255)">=</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag attr-value" style="color:rgb(255, 157, 0)">Item Three</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag spread operator" style="color:rgb(255, 157, 0)">...</span><span class="token tag spread method function property-access" style="color:rgb(250, 208, 0)">a11yProps</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token tag spread number" style="color:rgb(255, 98, 140)">2</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">        </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Tabs</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Box</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">CustomTabPanel</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">value</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)">value</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">index</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript number" style="color:rgb(255, 98, 140)">0</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">        Item One</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">CustomTabPanel</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">CustomTabPanel</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">value</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)">value</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">index</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript number" style="color:rgb(255, 98, 140)">1</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">        Item Two</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">CustomTabPanel</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">CustomTabPanel</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">value</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)">value</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">index</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript number" style="color:rgb(255, 98, 140)">2</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">        Item Three</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">CustomTabPanel</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Box</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This example is great, but (personally) I find it a little hard to read. There's a direct relationship between the tabs and the tab panels, but it's not immediately obvious. When you see the <code>0</code> passed to <code>a11yProps</code> and the <code>0</code> passed to <code>CustomTabPanel</code>, it's not clear that they're related. And if the <code>a11yProps</code> function call was not present, it would be even less clear.</p>
<p>I'd like to see the tabs and tab panels presented together in a more text-first way, that makes the relationship between tab and tab panel more apparent.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="text-first-tabs">Text-first tabs<a href="https://johnnyreilly.com/text-first-mui-tabs#text-first-tabs" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>The code I'd like to see would look something like this:</p>
<div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Box</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">sx</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> width</span><span class="token tag script language-javascript operator" style="color:rgb(255, 157, 0)">:</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> </span><span class="token tag script language-javascript string" style="color:rgb(165, 255, 144)">'100%'</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> </span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">  </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Box</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">sx</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> borderBottom</span><span class="token tag script language-javascript operator" style="color:rgb(255, 157, 0)">:</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> </span><span class="token tag script language-javascript number" style="color:rgb(255, 98, 140)">1</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> borderColor</span><span class="token tag script language-javascript operator" style="color:rgb(255, 157, 0)">:</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> </span><span class="token tag script language-javascript string" style="color:rgb(165, 255, 144)">'divider'</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> </span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Tabs</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">      </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">value</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)">selectedTab</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">      </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">onChange</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)">handleChange</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">      </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">aria-label</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(255, 255, 255)">=</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag attr-value" style="color:rgb(255, 157, 0)">basic tabs example</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">    </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Tab</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag spread operator" style="color:rgb(255, 157, 0)">...</span><span class="token tag spread method function property-access" style="color:rgb(250, 208, 0)">customTabProps</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token tag spread string" style="color:rgb(165, 255, 144)">'Item One'</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Tab</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag spread operator" style="color:rgb(255, 157, 0)">...</span><span class="token tag spread method function property-access" style="color:rgb(250, 208, 0)">customTabProps</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token tag spread string" style="color:rgb(165, 255, 144)">'Item Two'</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Tab</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag spread operator" style="color:rgb(255, 157, 0)">...</span><span class="token tag spread method function property-access" style="color:rgb(250, 208, 0)">customTabProps</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token tag spread string" style="color:rgb(165, 255, 144)">'Item Three'</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Tabs</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">  </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Box</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">  </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">CustomTabPanel</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">selectedTab</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)">selectedTab</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">tab</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(255, 255, 255)">=</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag attr-value" style="color:rgb(255, 157, 0)">Item One</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">    Item One</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">  </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">CustomTabPanel</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">  </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">CustomTabPanel</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">selectedTab</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)">selectedTab</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">tab</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(255, 255, 255)">=</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag attr-value" style="color:rgb(255, 157, 0)">Item Two</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">    Item Two</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">  </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">CustomTabPanel</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">  </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">CustomTabPanel</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">selectedTab</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)">selectedTab</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">tab</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(255, 255, 255)">=</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag attr-value" style="color:rgb(255, 157, 0)">Item Three</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">    Item Three</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">  </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">CustomTabPanel</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text"></span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Box</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this code snippet, the tabs and tab panels have more of a linkage, in a text-first way. It's hopefully clear that the "Item One" <code>Tab</code> and the "Item One" <code>CustomTabPanel</code> are related.</p>
<p>In the code above, the <code>customTabProps</code> function is used to generate the props for the tabs (it's an evolution of the <code>a11yProps</code> function that handles accessibility props as well as all others). Meanwhile, the <code>CustomTabPanel</code> component is used to render the tab panels. The <code>selectedTab</code> state is used to keep track of the selected tab.</p>
<p>How does this work? And is it strongly typed? Let's find out.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="strongly-typed-tabs">Strongly typed tabs<a href="https://johnnyreilly.com/text-first-mui-tabs#strongly-typed-tabs" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Yes, it's strongly typed! We achieve this by defining a mapping of tab text to tab index:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> tabs </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token string-property property" style="color:rgb(255, 157, 0)">'Item One'</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">0</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token string-property property" style="color:rgb(255, 157, 0)">'Item Two'</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">1</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token string-property property" style="color:rgb(255, 157, 0)">'Item Three'</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">2</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">as</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">type</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">TabText</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">keyof</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">typeof</span><span class="token plain"> tabs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">type</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">TabIndex</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">typeof</span><span class="token plain"> tabs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">TabText</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>So "Item One" is <code>0</code>, "Item Two" is <code>1</code>, and "Item Three" is <code>2</code>.</p>
<p>We then do some TypeScript magic to strongly type this. We use <code>as const</code> to tell TypeScript this is an immutable object. With that done we can then extract the keys and values from the object and use them to create the derived types <code>TabText</code> and <code>TabIndex</code>.</p>
<p><code>TabText</code> is the keys of the <code>tabs</code> object and <code>TabIndex</code> is the values. So <code>TabText</code> is <code>"Item One" | "Item Two" | "Item Three"</code> and <code>TabIndex</code> is <code>0 | 1 | 2</code>. If we should subsequently amend the <code>tabs</code> object in our code, TypeScript will ensure that the <code>TabText</code> and <code>TabIndex</code> types are updated accordingly.</p>
<p>We can then use these types in our components:</p>
<div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">customTabProps</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">tab</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token maybe-class-name">TabText</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> index </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> tabs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">tab</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    id</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token template-string string" style="color:rgb(165, 255, 144)">simple-tab-tab-</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation">index</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token string-property property" style="color:rgb(255, 157, 0)">'aria-controls'</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token template-string string" style="color:rgb(165, 255, 144)">simple-tab-tabpanel-</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation">index</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    label</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> tab</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">interface</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">CustomTabPanelProps</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  children</span><span class="token operator" style="color:rgb(255, 157, 0)">?</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access maybe-class-name">ReactNode</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  tab</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token maybe-class-name">TabText</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  selectedTab</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token maybe-class-name">TabIndex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">CustomTabPanel</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">props</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token maybe-class-name">CustomTabPanelProps</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> children</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> selectedTab</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> tab</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token spread operator" style="color:rgb(255, 157, 0)">...</span><span class="token plain">other </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> props</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> index </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> tabs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">tab</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag" style="color:rgb(255, 157, 0)">div</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">      </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">role</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(255, 255, 255)">=</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag attr-value" style="color:rgb(255, 157, 0)">tabpanel</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">      </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">hidden</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)">selectedTab </span><span class="token tag script language-javascript operator" style="color:rgb(255, 157, 0)">!==</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> index</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">      </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">id</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token tag script language-javascript template-string string" style="color:rgb(165, 255, 144)">simple-tab-tabpanel-</span><span class="token tag script language-javascript template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token tag script language-javascript template-string interpolation" style="color:rgb(255, 157, 0)">index</span><span class="token tag script language-javascript template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag script language-javascript template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">      </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">aria-labelledby</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token tag script language-javascript template-string string" style="color:rgb(165, 255, 144)">simple-tab-tab-</span><span class="token tag script language-javascript template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token tag script language-javascript template-string interpolation" style="color:rgb(255, 157, 0)">index</span><span class="token tag script language-javascript template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag script language-javascript template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">      </span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag spread operator" style="color:rgb(255, 157, 0)">...</span><span class="token tag spread" style="color:rgb(255, 157, 0)">other</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">    </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain">selectedTab </span><span class="token operator" style="color:rgb(255, 157, 0)">===</span><span class="token plain"> index </span><span class="token operator" style="color:rgb(255, 157, 0)">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Box</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">sx</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> p</span><span class="token tag script language-javascript operator" style="color:rgb(255, 157, 0)">:</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> </span><span class="token tag script language-javascript number" style="color:rgb(255, 98, 140)">3</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> </span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">          </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Typography</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain">children</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Typography</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">        </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Box</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag" style="color:rgb(255, 157, 0)">div</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then our final example code looks like this:</p>
<div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">export</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">default</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">BasicTabs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">selectedTab</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> setSelectedTab</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">useState</span><span class="token operator" style="color:rgb(255, 157, 0)">&lt;</span><span class="token maybe-class-name">TabIndex</span><span class="token operator" style="color:rgb(255, 157, 0)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    tabs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'Item One'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:rgb(250, 208, 0)">handleChange</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">event</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access maybe-class-name">SyntheticEvent</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> newValue</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token maybe-class-name">TabIndex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token function" style="color:rgb(250, 208, 0)">setSelectedTab</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">newValue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Box</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">sx</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> width</span><span class="token tag script language-javascript operator" style="color:rgb(255, 157, 0)">:</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> </span><span class="token tag script language-javascript string" style="color:rgb(165, 255, 144)">'100%'</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> </span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Box</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">sx</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> borderBottom</span><span class="token tag script language-javascript operator" style="color:rgb(255, 157, 0)">:</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> </span><span class="token tag script language-javascript number" style="color:rgb(255, 98, 140)">1</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> borderColor</span><span class="token tag script language-javascript operator" style="color:rgb(255, 157, 0)">:</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> </span><span class="token tag script language-javascript string" style="color:rgb(165, 255, 144)">'divider'</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> </span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">        </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Tabs</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">          </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">value</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)">selectedTab</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">          </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">onChange</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)">handleChange</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">          </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">aria-label</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(255, 255, 255)">=</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag attr-value" style="color:rgb(255, 157, 0)">basic tabs example</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">        </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">          </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Tab</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag spread operator" style="color:rgb(255, 157, 0)">...</span><span class="token tag spread method function property-access" style="color:rgb(250, 208, 0)">customTabProps</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token tag spread string" style="color:rgb(165, 255, 144)">'Item One'</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">          </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Tab</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag spread operator" style="color:rgb(255, 157, 0)">...</span><span class="token tag spread method function property-access" style="color:rgb(250, 208, 0)">customTabProps</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token tag spread string" style="color:rgb(165, 255, 144)">'Item Two'</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">          </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Tab</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag spread operator" style="color:rgb(255, 157, 0)">...</span><span class="token tag spread method function property-access" style="color:rgb(250, 208, 0)">customTabProps</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token tag spread string" style="color:rgb(165, 255, 144)">'Item Three'</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">        </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Tabs</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Box</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">CustomTabPanel</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">selectedTab</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)">selectedTab</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">tab</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(255, 255, 255)">=</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag attr-value" style="color:rgb(255, 157, 0)">Item One</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">        Item One</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">CustomTabPanel</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">CustomTabPanel</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">selectedTab</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)">selectedTab</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">tab</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(255, 255, 255)">=</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag attr-value" style="color:rgb(255, 157, 0)">Item Two</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">        Item Two</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">CustomTabPanel</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">CustomTabPanel</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">selectedTab</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)">selectedTab</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">tab</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(255, 255, 255)">=</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag attr-value" style="color:rgb(255, 157, 0)">Item Three</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">        Item Three</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">CustomTabPanel</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Box</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Note how we use our <code>TabIndex</code> types to strongly type the <code>selectedTab</code> state and the <code>handleChange</code> function. And also how the <code>TabText</code> type is used to strongly type the <code>tab</code> prop in the <code>CustomTabPanel</code> component and the <code>tab</code> argument in the <code>customTabProps</code> function. With this in place, we cannot provide invalid tab text to the <code>customTabProps</code> function or the <code>CustomTabPanel</code> component. TypeScript would fight us every step of the way if we tried.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://johnnyreilly.com/text-first-mui-tabs#conclusion" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>So now we have a strongly typed, text-first way to use the MUI tabs component. We've used TypeScript to ensure that our tabs and tab panels are related in a way that is clear and easy to understand. This approach makes our code more maintainable and easier to work with. The full code is below:</p>
<div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> </span><span class="token imports operator" style="color:rgb(255, 157, 0)">*</span><span class="token imports"> </span><span class="token imports keyword module" style="color:rgb(255, 157, 0)">as</span><span class="token imports"> </span><span class="token imports maybe-class-name">React</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'react'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">Tabs</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'@mui/material/Tabs'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">Tab</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'@mui/material/Tab'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">Typography</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'@mui/material/Typography'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">Box</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'@mui/material/Box'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> tabs </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token string-property property" style="color:rgb(255, 157, 0)">'Item One'</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">0</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token string-property property" style="color:rgb(255, 157, 0)">'Item Two'</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">1</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token string-property property" style="color:rgb(255, 157, 0)">'Item Three'</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">2</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">as</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">type</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">TabText</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">keyof</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">typeof</span><span class="token plain"> tabs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">type</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">TabIndex</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">typeof</span><span class="token plain"> tabs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token maybe-class-name">TabText</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">customTabProps</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">tab</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token maybe-class-name">TabText</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> index </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> tabs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">tab</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    id</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token template-string string" style="color:rgb(165, 255, 144)">simple-tab-tab-</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation">index</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token string-property property" style="color:rgb(255, 157, 0)">'aria-controls'</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token template-string string" style="color:rgb(165, 255, 144)">simple-tab-tabpanel-</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation">index</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    label</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> tab</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">interface</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">CustomTabPanelProps</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  children</span><span class="token operator" style="color:rgb(255, 157, 0)">?</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access maybe-class-name">ReactNode</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  tab</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token maybe-class-name">TabText</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  selectedTab</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token maybe-class-name">TabIndex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">CustomTabPanel</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">props</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token maybe-class-name">CustomTabPanelProps</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> children</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> selectedTab</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> tab</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token spread operator" style="color:rgb(255, 157, 0)">...</span><span class="token plain">other </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> props</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> index </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> tabs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">tab</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag" style="color:rgb(255, 157, 0)">div</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">      </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">role</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(255, 255, 255)">=</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag attr-value" style="color:rgb(255, 157, 0)">tabpanel</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">      </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">hidden</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)">selectedTab </span><span class="token tag script language-javascript operator" style="color:rgb(255, 157, 0)">!==</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> index</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">      </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">id</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token tag script language-javascript template-string string" style="color:rgb(165, 255, 144)">simple-tab-tabpanel-</span><span class="token tag script language-javascript template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token tag script language-javascript template-string interpolation" style="color:rgb(255, 157, 0)">index</span><span class="token tag script language-javascript template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag script language-javascript template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">      </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">aria-labelledby</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token tag script language-javascript template-string string" style="color:rgb(165, 255, 144)">simple-tab-tab-</span><span class="token tag script language-javascript template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token tag script language-javascript template-string interpolation" style="color:rgb(255, 157, 0)">index</span><span class="token tag script language-javascript template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag script language-javascript template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">      </span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag spread operator" style="color:rgb(255, 157, 0)">...</span><span class="token tag spread" style="color:rgb(255, 157, 0)">other</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">    </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain">selectedTab </span><span class="token operator" style="color:rgb(255, 157, 0)">===</span><span class="token plain"> index </span><span class="token operator" style="color:rgb(255, 157, 0)">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Box</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">sx</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> p</span><span class="token tag script language-javascript operator" style="color:rgb(255, 157, 0)">:</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> </span><span class="token tag script language-javascript number" style="color:rgb(255, 98, 140)">3</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> </span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">          </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Typography</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain">children</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Typography</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">        </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Box</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag" style="color:rgb(255, 157, 0)">div</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">export</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">default</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">BasicTabs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">selectedTab</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> setSelectedTab</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">useState</span><span class="token operator" style="color:rgb(255, 157, 0)">&lt;</span><span class="token maybe-class-name">TabIndex</span><span class="token operator" style="color:rgb(255, 157, 0)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    tabs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'Item One'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:rgb(250, 208, 0)">handleChange</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">event</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access maybe-class-name">SyntheticEvent</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> newValue</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token maybe-class-name">TabIndex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token function" style="color:rgb(250, 208, 0)">setSelectedTab</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">newValue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Box</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">sx</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> width</span><span class="token tag script language-javascript operator" style="color:rgb(255, 157, 0)">:</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> </span><span class="token tag script language-javascript string" style="color:rgb(165, 255, 144)">'100%'</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> </span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Box</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">sx</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> borderBottom</span><span class="token tag script language-javascript operator" style="color:rgb(255, 157, 0)">:</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> </span><span class="token tag script language-javascript number" style="color:rgb(255, 98, 140)">1</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> borderColor</span><span class="token tag script language-javascript operator" style="color:rgb(255, 157, 0)">:</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> </span><span class="token tag script language-javascript string" style="color:rgb(165, 255, 144)">'divider'</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)"> </span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">        </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Tabs</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">          </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">value</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)">selectedTab</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">          </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">onChange</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)">handleChange</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">          </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">aria-label</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(255, 255, 255)">=</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag attr-value" style="color:rgb(255, 157, 0)">basic tabs example</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">        </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">          </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Tab</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag spread operator" style="color:rgb(255, 157, 0)">...</span><span class="token tag spread method function property-access" style="color:rgb(250, 208, 0)">customTabProps</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token tag spread string" style="color:rgb(165, 255, 144)">'Item One'</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">          </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Tab</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag spread operator" style="color:rgb(255, 157, 0)">...</span><span class="token tag spread method function property-access" style="color:rgb(250, 208, 0)">customTabProps</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token tag spread string" style="color:rgb(165, 255, 144)">'Item Two'</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">          </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Tab</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag spread operator" style="color:rgb(255, 157, 0)">...</span><span class="token tag spread method function property-access" style="color:rgb(250, 208, 0)">customTabProps</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token tag spread string" style="color:rgb(165, 255, 144)">'Item Three'</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token tag spread punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">        </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Tabs</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Box</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">CustomTabPanel</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">selectedTab</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)">selectedTab</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">tab</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(255, 255, 255)">=</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag attr-value" style="color:rgb(255, 157, 0)">Item One</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">        Item One</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">CustomTabPanel</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">CustomTabPanel</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">selectedTab</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)">selectedTab</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">tab</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(255, 255, 255)">=</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag attr-value" style="color:rgb(255, 157, 0)">Item Two</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">        Item Two</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">CustomTabPanel</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">CustomTabPanel</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">selectedTab</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(255, 255, 255)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 157, 0)">selectedTab</span><span class="token tag script language-javascript punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">tab</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(255, 255, 255)">=</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag attr-value" style="color:rgb(255, 157, 0)">Item Three</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">        Item Three</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">CustomTabPanel</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;/</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">Box</span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It's certainly more complicated than the official example (and this may well be why the official example is the way it is), but it matches my preferences.</p>
<p>As an aside, I'd like the code even more if I had the following instead of using <code>Tab</code> with <code>customTabProps</code>:</p>
<div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag class-name" style="color:rgb(250, 208, 0)">CustomTab</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">tab</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(255, 255, 255)">=</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag attr-value" style="color:rgb(255, 157, 0)">Item One</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">/&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>I avoided that in this post because it would have made the example more complicated. But I think it would be a nice improvement.</p>]]></content:encoded>
            <category>react</category>
        </item>
        <item>
            <title><![CDATA[Generate a Word document in ASP.NET]]></title>
            <link>https://johnnyreilly.com/generate-word-doc-in-asp-net</link>
            <guid>https://johnnyreilly.com/generate-word-doc-in-asp-net</guid>
            <pubDate>Tue, 19 Mar 2024 18:59:22 GMT</pubDate>
            <description><![CDATA[Learn how to generate a Word document using the Open XML library in ASP.NET.]]></description>
            <content:encoded><![CDATA[<p>Generating a Word document in the context of an ASP.NET controller is quite simple to do. However, it took me a little experimentation to work out just what was required. This post documents (pun <strong>very</strong> much intended) what we need to do.</p>
<p><img decoding="async" loading="eager" alt="title image reading &amp;quot;Generate a Word document in ASP.NET&amp;quot; with the Word and ASP.NET logos" src="https://johnnyreilly.com/assets/images/title-image-712677834ebf7d35a976a9ef66b32c70.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="open-xml">Open XML<a href="https://johnnyreilly.com/generate-word-doc-in-asp-net#open-xml" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>To generate a Word document in .NET, the most straightforward way is to use the <a href="https://github.com/dotnet/Open-XML-SDK" target="_blank" rel="noopener noreferrer">Open XML library</a>. We can install the library using the following command:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token plain">dotnet </span><span class="token function" style="color:rgb(250, 208, 0)">add</span><span class="token plain"> package DocumentFormat.OpenXml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="generating-a-word-document-in-an-aspnet-controller">Generating a Word document in an ASP.NET controller<a href="https://johnnyreilly.com/generate-word-doc-in-asp-net#generating-a-word-document-in-an-aspnet-controller" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>With the Open XML library installed, we can create a new Word document in the context of an ASP.NET controller. The following code demonstrates how to do this:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Microsoft</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">AspNetCore</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Mvc</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">DocumentFormat</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">OpenXml</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">DocumentFormat</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">OpenXml</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Packaging</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">DocumentFormat</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">OpenXml</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Wordprocessing</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">namespace</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">MyApp</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Controllers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token attribute class-name" style="color:rgb(250, 208, 0)">ApiController</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">WordDocumentController</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> ControllerBase</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token attribute class-name" style="color:rgb(250, 208, 0)">HttpGet</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token attribute attribute-arguments string" style="color:rgb(165, 255, 144)">"api/generate-word-document"</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">IActionResult</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">GetWordDocument</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// Create a new Word document</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> stream </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">MemoryStream</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> document </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> WordprocessingDocument</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Create</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">stream</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> WordprocessingDocumentType</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Document</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> mainPart </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> document</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AddMainDocumentPart</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        mainPart</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Document </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Document</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// Add content to the document</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> body </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> mainPart</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Document</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AppendChild</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Body</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> paragraph </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> body</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AppendChild</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Paragraph</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> run </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> paragraph</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AppendChild</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Run</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        run</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">AppendChild</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Text</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"Hello, World!"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// Save the document to a memory stream</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        document</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Save</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> byteArray </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> stream</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">ToArray</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// Return the document as a file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">File</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">byteArray</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"application/vnd.openxmlformats-officedocument.wordprocessingml.document"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"document.docx"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this example, the <code>GetWordDocument</code> method creates a new Word document and adds the text "Hello, World!" to it. If we navigate to the <code>/api/generate-word-document</code> endpoint, we will receive a Word document with the text "Hello, World!" in it.</p>
<p>The document is then saved to a memory stream and returned as a file. The <code>File</code> method is used to return the document as a file with the MIME type <code>application/vnd.openxmlformats-officedocument.wordprocessingml.document</code> (which basically is the server saying "Hey! This is a Word document!").</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://johnnyreilly.com/generate-word-doc-in-asp-net#conclusion" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Generating a Word document in an ASP.NET controller is quite simple to do using the Open XML library. We can create a new Word document, add content to it, and return it as a file using the <code>File</code> method.</p>
<p>To learn more about how to add content to a Word document using the Open XML library, it's worth reading the <a href="https://learn.microsoft.com/en-us/office/open-xml/word/overview" target="_blank" rel="noopener noreferrer">Open XML SDK documentation</a>.</p>
<p>I hope this post helps you to generate Word documents in your ASP.NET applications!</p>]]></content:encoded>
            <category>asp.net</category>
        </item>
        <item>
            <title><![CDATA[Graph API: getting users Active Directory group names and ids with the C# SDK]]></title>
            <link>https://johnnyreilly.com/graph-api-ad-users-group-name-ids-csharp-sdk</link>
            <guid>https://johnnyreilly.com/graph-api-ad-users-group-name-ids-csharp-sdk</guid>
            <pubDate>Mon, 18 Dec 2023 15:51:14 GMT</pubDate>
            <description><![CDATA[Learn how to get the Azure Active Directory group names and ids from the Graph API using the C# SDK.]]></description>
            <content:encoded><![CDATA[<p>The Graph API is a great way to get information about users in Azure Active Directory. I recently needed to get the names and ids of the Active Directory groups that a user was a member of. Here's how to do it with the C# SDK.</p>
<p>I'm writing this post as, whilst it ends up being a relatively small amount of code and configuration required, if you don't know what that is, you can end up somewhat stuck. This should hopefully unstick you.</p>
<p><img decoding="async" loading="eager" alt="title image reading &amp;quot;Graph API: getting users AD group names and ids with the C# SDK&amp;quot; with the Azure Graph and C# logos" src="https://johnnyreilly.com/assets/images/title-image-6d92def2e18c2d0c25e0676cc8c1525a.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="azure-ad-app-registration-api-permissions">Azure AD app registration API permissions<a href="https://johnnyreilly.com/graph-api-ad-users-group-name-ids-csharp-sdk#azure-ad-app-registration-api-permissions" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>To query the Graph API, we'll need:</p>
<ul>
<li>an Azure AD app registration</li>
<li>a client id and client secret for that app registration</li>
<li>the tenant id for the Azure AD tenant that the app registration is in</li>
<li><code>GroupMember.Read.All</code> and <code>User.Read.All</code> API application permissions</li>
</ul>
<p>Of the above, it's the API permissions that I want to draw your attention to. Ultimately, you'll need to get your Azure AD admin to grant consent to these permissions for your app registration so you have the necessary permissions to query the Graph API:</p>
<p><img decoding="async" loading="lazy" alt="screenshot of the Azure Portal showing the API permissions we require" src="https://johnnyreilly.com/assets/images/screenshot-azure-app-registration-api-permissions-481a37148442bfa0ae49d95ab40dbeab.png" width="3576" height="1074" class="img_ev3q"></p>
<p>How did I know that I needed these permissions? Great question! I found the answer in the <a href="https://learn.microsoft.com/en-us/graph/api/directoryobject-getmembergroups?view=graph-rest-1.0&amp;tabs=http#group-memberships-for-a-user" target="_blank" rel="noopener noreferrer">"directoryObject: getMemberGroups / group memberships for a user" documentation</a>.</p>
<p>The Application <code>User.Read.All</code> and <code>GroupMember.Read.All</code> permissions are the least privileged permissions that allow you to query the Graph API for the information we need. If you're interested in the other permissions available, check out the <a href="https://learn.microsoft.com/en-us/graph/permissions-reference" target="_blank" rel="noopener noreferrer">Microsoft Graph permissions reference</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="querying-the-graph-api">Querying the Graph API<a href="https://johnnyreilly.com/graph-api-ad-users-group-name-ids-csharp-sdk#querying-the-graph-api" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Now we've configured our app registration, we can query the Graph API. I'm going to show you how to do this with the C# SDK. If you're using a different language, you'll need to find the equivalent SDK for your language.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="install-the-sdk">Install the SDK<a href="https://johnnyreilly.com/graph-api-ad-users-group-name-ids-csharp-sdk#install-the-sdk" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>The first thing we need to do is install the SDK. I'm using the <a href="https://www.nuget.org/packages/Microsoft.Graph/" target="_blank" rel="noopener noreferrer">Microsoft.Graph</a> package. At the time of writing, the latest version is 5.35.0.</p>
<p>Once you have added it, you'll have an entry in your <code>.csproj</code> along these lines:</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockTitle_Ktv7">MyApp.csproj</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag" style="color:rgb(255, 157, 0)">PackageReference</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">Include</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(255, 255, 255)">=</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag attr-value" style="color:rgb(255, 157, 0)">Microsoft.Graph</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">Version</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(255, 255, 255)">=</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag attr-value" style="color:rgb(255, 157, 0)">5.35.0</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">/&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you're interested in the underlying project, you can find it as <a href="https://github.com/microsoftgraph/msgraph-sdk-dotnet" target="_blank" rel="noopener noreferrer"><code>msgraph-sdk-dotnet</code> on GitHub</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-a-graphserviceclient">Create a GraphServiceClient<a href="https://johnnyreilly.com/graph-api-ad-users-group-name-ids-csharp-sdk#create-a-graphserviceclient" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Next, we need to create a <code>GraphServiceClient</code>. This is the object that we'll use to query the Graph API. For that we'll need a credential which we'll construct using the <code>tenantId</code>, <code>clientId</code> and <code>clientSecret</code> that we got from our app registration:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Azure</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Identity</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Microsoft</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Graph</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// The client credentials flow requires that you request the</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// /.default scope, and pre-configure your permissions on the</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// app registration in Azure. An administrator must grant consent</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// to those permissions beforehand.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> scopes </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"https://graph.microsoft.com/.default"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// using Azure.Identity;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> options </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">ClientSecretCredentialOptions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    AuthorityHost </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> AzureAuthorityHosts</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AzurePublicCloud</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// https://learn.microsoft.com/en-us/graph/sdks/choose-authentication-providers?tabs=csharp#using-a-client-secret</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// https://learn.microsoft.com/dotnet/api/azure.identity.clientsecretcredential</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> clientSecretCredential </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">ClientSecretCredential</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    tenantId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> clientId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> clientSecret</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> options</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">_graphClient </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">GraphServiceClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">clientSecretCredential</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> scopes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The above code is based on the <a href="https://learn.microsoft.com/en-us/graph/sdks/choose-authentication-providers?tabs=csharp#using-a-client-secret" target="_blank" rel="noopener noreferrer">"client credentials provider / using a client secret" documentation</a>. It's possible that you might want to use a different authentication provider. If so, check out the <a href="https://learn.microsoft.com/en-us/graph/sdks/choose-authentication-providers?tabs=csharp" target="_blank" rel="noopener noreferrer">"choose authentication providers" documentation</a>. Because we're querying for application permissions, we need to use the client credentials provider. We could, if we wanted to, use the client certificate approach instead. I'm not going to cover that here.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="query-the-graph-api">Query the Graph API<a href="https://johnnyreilly.com/graph-api-ad-users-group-name-ids-csharp-sdk#query-the-graph-api" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Now we come to the fun part. We're going to query the Graph API for the groups that a user is a member of. We'll need to pass in the <code>usernameOrId</code> of the user that we're interested in. I'm using the user's email address as the <code>usernameOrId</code> in my application. You might want to use the user's id instead. It's up to you.</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token class-name" style="color:rgb(250, 208, 0)">List</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">GroupIdDisplayName</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> groupIds </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token class-name" style="color:rgb(250, 208, 0)">Microsoft</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token class-name" style="color:rgb(250, 208, 0)">Graph</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token class-name" style="color:rgb(250, 208, 0)">Models</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token class-name" style="color:rgb(250, 208, 0)">GroupCollectionResponse</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> response </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> _graphClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Users</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">usernameOrId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">MemberOf</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">GraphGroup</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetAsync</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">requestConfiguration </span><span class="token operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    requestConfiguration</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">QueryParameters</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Select </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">"id"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"displayName"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    requestConfiguration</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">QueryParameters</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Top </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">100</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> pageIterator </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> PageIterator</span><span class="token operator" style="color:rgb(255, 157, 0)">&lt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    Microsoft</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Graph</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Models</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Group</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    Microsoft</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Graph</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Models</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">GroupCollectionResponse</span><span class="token punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token operator" style="color:rgb(255, 157, 0)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">CreatePageIterator</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">_graphClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> response</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">group</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    groupIds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Add</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">GroupIdDisplayName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">Id</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">group</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Id</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">DisplayName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">group</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">DisplayName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> pageIterator</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">IterateAsync</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Let's unpack the code above. It does the following:</p>
<ol>
<li>Creates an empty list of <code>GroupIdDisplayName</code> objects. This is the type that I'm using to store the group ids and display names. You can use whatever type you want.</li>
<li>It indexes into the <code>Users</code> collection on the <code>GraphServiceClient</code> using the <code>usernameOrId</code> that we passed in. From there we make use of <code>MemberOf.GraphGroup</code> and call <code>GetAsync</code> on that, passing in a request configuration method. This is where we specify the <code>Select</code> and <code>Top</code> query parameters. We're using <code>Select</code> to specify only the properties that we want to return - by default lots more data would come back than we require. We're using <code>Top</code> to specify the maximum number of results that we want to return. I'm using 100 as that's the maximum that the Graph API will allow. We'll need to use a <code>PageIterator</code> to get all of the results. More on that in a moment.</li>
<li>Because we want to get all of the results, we need to use a <code>PageIterator</code>. We create one using the <code>CreatePageIterator</code> method on the <code>PageIterator</code> class. We pass in the <code>GraphServiceClient</code> that we created earlier, the <code>response</code> that we got from the <code>GetAsync</code> call and a delegate that will be called for each result. In our delegate, we add the <code>GroupIdDisplayName</code> to our list and return <code>true</code> to indicate that we want to continue iterating. If we wanted to stop iterating, we'd return <code>false</code>. Finally we call <code>IterateAsync</code> on the <code>PageIterator</code> to get all of the results.</li>
</ol>
<p>The <code>PageIterator</code> is somewhat confusing, in my opinion. I'm used to paging through results, but this way of doing it did puzzle me. If you're interested in learning more about the <code>PageIterator</code>, check out the <a href="https://learn.microsoft.com/en-us/graph/sdks/paging?tabs=csharp" target="_blank" rel="noopener noreferrer">"paging" documentation</a>. I also found <a href="https://github.com/microsoftgraph/msgraph-sdk-dotnet/blob/dev/docs/upgrade-to-v5.md#pageiterator" target="_blank" rel="noopener noreferrer">this documentation helpful</a>.</p>
<p>Initially the <code>PageIterator</code> was throwing an exception when I used it. <a href="https://stackoverflow.com/questions/75860298/graphserviceclient-pageitarator-failes-with-the-parsable-does-not-contain-a-col" target="_blank" rel="noopener noreferrer">I found the answer to that on StackOverflow</a>. It turns out that the types you specify for the <code>PageIterator</code> need to be correct for the request above; and if not you may be impaced by type mismatches at runtime. The entries that are returned from the API may be wider or simply different to what you require. I've the correct types in my code now - but I mention it just in case.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="putting-it-all-together">Putting it all together<a href="https://johnnyreilly.com/graph-api-ad-users-group-name-ids-csharp-sdk#putting-it-all-together" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Ultimately I wrote a <code>GroupService</code> that I could use to get the groups for a user. That service looks like this:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockTitle_Ktv7">GroupService.cs</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Azure</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Identity</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Microsoft</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Graph</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">namespace</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">ZebraGptContainerApp</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Services</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Implementations</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">record</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">GroupIdDisplayName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> Id</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> DisplayName</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">interface</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">IGroupService</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Task</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">List</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">GroupIdDisplayName</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">GetGroups</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> usernameOrId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">GroupService</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token type-list class-name" style="color:rgb(250, 208, 0)">IGroupService</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">GraphServiceClient</span><span class="token plain"> _graphClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">GroupService</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// new this up in program.cs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">GroupService</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">GroupService</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> tenantId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> clientId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> clientSecret</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _logger </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// The client credentials flow requires that you request the</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// /.default scope, and pre-configure your permissions on the</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// app registration in Azure. An administrator must grant consent</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// to those permissions beforehand.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> scopes </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"https://graph.microsoft.com/.default"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// using Azure.Identity;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> options </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">ClientSecretCredentialOptions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            AuthorityHost </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> AzureAuthorityHosts</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AzurePublicCloud</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// https://learn.microsoft.com/en-us/graph/sdks/choose-authentication-providers?tabs=csharp#using-a-client-secret</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// https://learn.microsoft.com/dotnet/api/azure.identity.clientsecretcredential</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> clientSecretCredential </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">ClientSecretCredential</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            tenantId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> clientId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> clientSecret</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> options</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _graphClient </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">GraphServiceClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">clientSecretCredential</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> scopes</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Task</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">List</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">GroupIdDisplayName</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">GetGroups</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> usernameOrId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// https://stackoverflow.com/questions/75860298/graphserviceclient-pageitarator-failes-with-the-parsable-does-not-contain-a-col</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">try</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token class-name" style="color:rgb(250, 208, 0)">List</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">GroupIdDisplayName</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> groupIds </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token class-name" style="color:rgb(250, 208, 0)">Microsoft</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token class-name" style="color:rgb(250, 208, 0)">Graph</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token class-name" style="color:rgb(250, 208, 0)">Models</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token class-name" style="color:rgb(250, 208, 0)">GroupCollectionResponse</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> response </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> _graphClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Users</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">usernameOrId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">MemberOf</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">GraphGroup</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetAsync</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">requestConfiguration </span><span class="token operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                requestConfiguration</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">QueryParameters</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Select </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">"id"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"displayName"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                requestConfiguration</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">QueryParameters</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Top </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">100</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> pageIterator </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> PageIterator</span><span class="token operator" style="color:rgb(255, 157, 0)">&lt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                Microsoft</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Graph</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Models</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Group</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                Microsoft</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Graph</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Models</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">GroupCollectionResponse</span><span class="token punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token operator" style="color:rgb(255, 157, 0)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">CreatePageIterator</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">_graphClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> response</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">group</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                groupIds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Add</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">GroupIdDisplayName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">Id</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">group</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Id</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">DisplayName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">group</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">DisplayName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> pageIterator</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">IterateAsync</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> groupIds</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token plain"> ex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogError</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">ex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Problem getting groups with usernameOrId {usernameOrId}"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> usernameOrId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">throw</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Problem getting groups with usernameOrId </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">usernameOrId</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> ex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It is constructed in <code>Program.cs</code>:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockTitle_Ktv7">Program.cs</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">builder</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token generic-method function" style="color:rgb(250, 208, 0)">AddSingleton</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)">IGroupService</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">serviceProvider </span><span class="token operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">GroupService</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> serviceProvider</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token generic-method function" style="color:rgb(250, 208, 0)">GetRequiredService</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)">GroupService</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">tenantId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> builder</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Configuration</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token generic-method function" style="color:rgb(250, 208, 0)">GetValue</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"TenantId"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token operator" style="color:rgb(255, 157, 0)">!</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">clientId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> builder</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Configuration</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token generic-method function" style="color:rgb(250, 208, 0)">GetValue</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"ClientId"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token operator" style="color:rgb(255, 157, 0)">!</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">clientSecret</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> builder</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Configuration</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token generic-method function" style="color:rgb(250, 208, 0)">GetValue</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"ClientSecret"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token operator" style="color:rgb(255, 157, 0)">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then I can use it in my controller:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockTitle_Ktv7">GroupsController.cs</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Microsoft</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">AspNetCore</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Mvc</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">namespace</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">MyApp</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Controllers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token attribute class-name" style="color:rgb(250, 208, 0)">ApiController</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">GroupsController</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token type-list class-name" style="color:rgb(250, 208, 0)">ControllerBase</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">IGroupService</span><span class="token plain"> _groupService</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">MeController</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> _log</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">GroupsController</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">IGroupService</span><span class="token plain"> groupService</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">MeController</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> log</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _groupService </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> groupService</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _log </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> log</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token attribute class-name" style="color:rgb(250, 208, 0)">HttpGet</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token attribute attribute-arguments string" style="color:rgb(165, 255, 144)">"api/groups"</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Task</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">IActionResult</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">GetGroups</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> email </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> User</span><span class="token punctuation" style="color:rgb(255, 255, 255)">?.</span><span class="token plain">Identity</span><span class="token punctuation" style="color:rgb(255, 255, 255)">?.</span><span class="token plain">Name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// email in my context</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">try</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">string</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">IsNullOrEmpty</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">email</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">Unauthorized</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> groups </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> _groupService</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetGroups</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">email</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">Ok</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">groups</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token plain"> ex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            _log</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogError</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">ex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Problem getting groups for {email}"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> email</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">BadRequest</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Problem getting groups for </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">email</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When you browse to <code>/api/groups</code>, you'll get a JSON response with the group ids and display names:</p>
<p><img decoding="async" loading="lazy" alt="screenshot of the JSON returned from the controller displaying ids and displayNames" src="https://johnnyreilly.com/assets/images/screenshot-group-ids-and-display-names-dc6000021cbc2b95498002e5ce2a42dc.png" width="926" height="468" class="img_ev3q"></p>
<p>And if you're anything like me, you'll discover that you are in <em>way</em> more groups than you thought you were.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://johnnyreilly.com/graph-api-ad-users-group-name-ids-csharp-sdk#conclusion" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>This post has demonstrated both the configuration and the code required to query the Graph API for the groups that a user is a member of. Hopefully it also provides something of a reference for acquiring different types of Graph API permissions and using the C# SDK to query the Graph API.</p>]]></content:encoded>
            <category>auth</category>
            <category>azure</category>
            <category>c#</category>
            <category>asp.net</category>
        </item>
        <item>
            <title><![CDATA[Overview of Bun, a JavaScript runtime]]></title>
            <link>https://johnnyreilly.com/bun-overview</link>
            <guid>https://johnnyreilly.com/bun-overview</guid>
            <pubDate>Sun, 17 Dec 2023 07:07:36 GMT</pubDate>
            <description><![CDATA[Bun is a new, fast, TypeScript-first, npm compatible-first JavaScript runtime. This is a walkthrough of it!]]></description>
            <content:encoded><![CDATA[<p>Like Node.js and Deno, Bun is a JavaScript runtime that provides a faster development experience while you‚Äôre building frontend applications. It‚Äôs gaining ground as a competitor to these widely used runtime environments ‚Äî and for good reason.</p>
<p>In this evaluation guide, we‚Äôll explore the features that make Bun an excellent choice for developing fast, performant, error-free frontend apps. By the end of this article, you‚Äôll have a clear understanding of when and why you should use Bun in your projects.</p>
<p><img decoding="async" loading="eager" alt="title image reading &amp;quot;Bun overview: whats cooking&amp;quot; with the Bun logo" src="https://johnnyreilly.com/assets/images/title-image-139903f2eb6662dd8703dcd2844cf6ce.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-bun">What is Bun?<a href="https://johnnyreilly.com/bun-overview#what-is-bun" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Bun was created by Jarred Sumner with the intention that, if you currently use Node.js, you should easily be able to swap it out and replace it with Bun instead.</p>
<p>In other words, you should be able to quickly take advantage of Bun‚Äôs awesome features without having to deal with a steep learning curve. Generally, you can use the same frameworks, libraries, and conventions you‚Äôre used to, often without issue. Keep in mind there may be exceptions to this.</p>
<p>The Bun team released v1.0 on 8 September 2023. However, Bun was already widely known and used long before that. Jarred Sumner even <a href="https://open.spotify.com/episode/512NHtxknFNeipHSZHIRXP" target="_blank" rel="noopener noreferrer">appeared on PodRocket</a> on 5 August 2022 to discuss Bun, more than a year before the release of v1.0.</p>
<p>Part of the reason for Bun‚Äôs rise in popularity even before its stable release is its speed and ease of use.</p>
<p>While Node.js and Deno both use V8 ‚Äî the Chrome JavaScript engine ‚Äî Bun uses Apple‚Äôs JavaScriptCore. This choice of JavaScript engine supports the <a href="https://bun.sh/blog/bun-v1.0" target="_blank" rel="noopener noreferrer">Bun team‚Äôs self-described goal</a> of ‚Äúeliminating slowness and complexity without throwing away everything that's great about JavaScript.‚Äù</p>
<p>Additionally, Bun is written using Zig, a systems programming language that allows you to write extremely performant software ‚Äî exactly what Bun intends to enable you to do. Interestingly, while Bun has now hit 1.0, Zig, which has been around longer, has not!</p>
<p>In contrast, Node.js is written in C++, and Deno is written in Rust. Zig makes it possible to write code that is both fast and safe, contributing to Bun‚Äôs speed and performance.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="why-use-bun">Why use Bun?<a href="https://johnnyreilly.com/bun-overview#why-use-bun" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>JavaScript is a great language, and the npm ecosystem is vast. These combined have powered large numbers of systems and development experiences for years. Given that this is the case, why would you want to use Bun in particular? What are the benefits that make it such a great choice?</p>
<p>If I were to explain why I've been using Bun, it's because it is like using Node.js, but simply a better version of it. Bun is the Node.js I want to use. Let's go through some of the reasons why:</p>
<ul>
<li><strong>Performance/speed:</strong> Bun is fast. Really fast. That speed really makes a difference in terms of your efficiency when developing software</li>
<li><strong>TypeScript support:</strong> Bun has great TypeScript support. It's easy to use TypeScript with Bun. You don't need to do anything special to get it to work ‚Äî it just works</li>
<li><strong>Ease of use / DX:</strong> Bun is a joy to use. Because it targets Node.js compatibility, there isn't much to learn if you were using Node.js before; you just use Bun</li>
<li><strong>Community &amp; ecosystem:</strong> If you reach out to the Bun community with an issue, you're likely to get a response very quickly ‚Äî it has a great community and ecosystem, including a very responsive and helpful core team</li>
<li><strong>Documentation:</strong> The documentation for Bun is excellent. It's clear, concise, and easy to follow. It's also very comprehensive. If you're looking for something, you'll likely find it in the docs</li>
</ul>
<p>Bun also provides a built-in bundler, although it‚Äôs still in beta and may not be widely used. However, it‚Äôs fast, works as a bundler should, and was created by the Bun team, so it's likely to be supported on an ongoing basis.</p>
<p>Keep in mind that ‚Äî like any tool ‚Äî Bun isn‚Äôt perfect. Let‚Äôs take a look at some things you should keep in mind before or while using Bun.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="considerations-while-using-bun">Considerations while using Bun<a href="https://johnnyreilly.com/bun-overview#considerations-while-using-bun" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Whilst Bun is a fantastic tool with tremendous goals, it‚Äôs worth thinking about some of the friction and imperfections around Bun:</p>
<ul>
<li><strong>Limited continuous integration implementations:</strong> If you want to use Bun in GitHub Actions, an integration exists right now. This will download the desired version of Bun to the running machine, install it, and allow you to use Bun in the context of GitHub Actions. However, a similar standard mechanism for downloading and installing Bun may not yet exist if we want to use a different CI technology, like Azure Pipelines</li>
<li><strong>Binary <code>bun.lockb</code> lock file:</strong> One of Bun‚Äôs more unusual aspects is the lock file it employs. Lock files are well established in the Node.js ecosystem, allowing deterministic installs of packages ‚Äî like <code>yarn.lock</code> for Yarn or <code>package-lock.json</code> for npm. Bun has trodden a slightly different path with a binary lock file, <code>bun.lockb</code>. Using a binary lock file reduces the file size and improves efficiency in areas like parsing, processing, and version control. However, it also makes <a href="https://bun.sh/docs/install/lockfile" target="_blank" rel="noopener noreferrer">working out the difference between an old and a new lock file quite involved</a>. There‚Äôs some friction here both in terms of seeing the diff as well as plugging into third-party tools that manage dependency upgrades</li>
<li><strong>Not everything works:</strong> While many workflows work just as you would hope, some don‚Äôt. For instance, if you want to build a Docusaurus website, <a href="https://github.com/oven-sh/bun/issues/3426" target="_blank" rel="noopener noreferrer">right now you can‚Äôt</a>. This is a reflection of how young Bun is at present; as time passes, more and more workflows will be supported. But depending upon the nature of the work you do, you may want to hold off a little while, until more use cases are unblocked</li>
</ul>
<p>It‚Äôs worth noting that these are not particularly significant hindrances, and many are not necessarily long-term issues either. As time passes, they‚Äôll likely become even less problematic. However, as of now, they are worth taking into account before you go all-in on Bun.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="key-bun-features-to-know">Key Bun features to know<a href="https://johnnyreilly.com/bun-overview#key-bun-features-to-know" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>We‚Äôve touched on why Bun was created and looked at some high-level reasons why you should consider using it. Now, it‚Äôs time to dive deeper into what exactly Bun offers. Let's take a look at some of its features.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="nodejs-compatibility-and-npm-support">Node.js compatibility and npm support‚Äã<a href="https://johnnyreilly.com/bun-overview#nodejs-compatibility-and-npm-support" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>The aim is that Bun will entirely support Node.js APIs. Consequently, the majority of npm packages ‚Äî which were originally written for the browser and for Node.js ‚Äî should just work with Bun.</p>
<p>Bun also includes a package manager, <code>bun install</code>, which is compatible with npm as well as faster than npm, Yarn, and pnpm by some margin! You can use <code>bun install</code> to install packages from npm or from a Bun registry.</p>
<p>Notably, you still use <code>package.json</code> to manage your dependencies in Bun. This makes migrating from Node.js to Bun very easy and reduces the learning curve. If you just want to dip your feet in the water of Bun, you could just use it for installs and speed up your GitHub Actions!</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="speed">Speed!<a href="https://johnnyreilly.com/bun-overview#speed" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>‚Äã
Bun extends the JavaScriptCore engine ‚Äî the engine that hails from the Safari browser ‚Äî but with incredible performance, thanks to its Zig implementation. It's fast. Really fast. It's not only way faster than Node.js but also faster than Deno in most benchmarks.</p>
<p>You'll hear about speed in almost everything that Bun does. Speed is a feature. Bun runs fast. Bun starts fast. Bun installs fast. Bun hot reloads fast. Bun bundles fast. Bun runs tests fast. Bun is fast.</p>
<p>You‚Äôre likely now tired of reading the word ‚Äúfast‚Äù ‚Äî but hopefully, you get the point!</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="typescript-tsx-and-jsx-support">TypeScript, TSX, and JSX support‚Äã<a href="https://johnnyreilly.com/bun-overview#typescript-tsx-and-jsx-support" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>If you use <code>.ts</code> and <code>.tsx</code> files, Bun can make your life much easier. It can execute these files in the same way Node.js can execute JavaScript. No need to set up a build step or add ts-node ‚Äî it just works.</p>
<p>One exciting aspect of this feature is that you can write TypeScript directly and execute it in a Node.js style. If you had been relying upon a build step or on JSDoc for strong typing in JavaScript, now you can just use TypeScript!</p>
<p>Similarly, when it comes to React, Bun transpiles it into JavaScript internally ‚Äî you don‚Äôt have to worry about it.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="hot-reloading-and-watch-mode">Hot reloading and watch mode‚Äã<a href="https://johnnyreilly.com/bun-overview#hot-reloading-and-watch-mode" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Bun has great support for watch mode and hot reloading. These features help you automatically monitor your source files for changes and then update your running application accordingly.</p>
<p>You‚Äôre likely used to hot reloading taking some time; it‚Äôs usually not instant. But with Bun, it pretty much is. How, you ask? I‚Äôll paraphrase the docs:</p>
<p>Detects changes to files using OS native filesystem watcher APIs
Can scale to larger projects thanks to optimization techniques like setting a higher limit for file descriptors, statically allocating file path buffers, reusing file descriptors whenever possible, and more</p>
<p>In the Bun docs, you can also find a demonstration from the Bun team showing the performance of watch mode:</p>
<p><img decoding="async" loading="lazy" alt="incredibly fast hot reloading in VS Code" src="https://johnnyreilly.com/assets/images/vs-code-hot-reloading-e6755c364815701e7dea5912606e619e.gif" width="1447" height="802" class="img_ev3q"></p>
<p>That is fast.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="solves-pain-points-of-es-modules-and-commonjs">Solves pain points of ES modules and CommonJS‚Äã<a href="https://johnnyreilly.com/bun-overview#solves-pain-points-of-es-modules-and-commonjs" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>As part of the JavaScript world, you‚Äôre likely very aware that the long-standing but nonstandard CommonJS modules are starting to be displaced by standard ES modules.</p>
<p>TypeScript enforces its own set of rules around import extensions that aren't compatible with ESM. Different build tools support path re-mapping via disparate, non-compatible mechanisms. Node.js, for instance, has many ‚Äúgotchas‚Äù around ESM resolution, making it difficult to use in practice.</p>
<p>Bun aims to provide a consistent and predictable module resolution system that just works. It does this very well indeed. Code that Node.js might struggle with, Bun handles with ease.</p>
<p>This is a great example of Bun taking the pain out of using JavaScript. It‚Äôs a great example of how Bun saves time and increases happiness.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="support-for-web-standard-apis">Support for web standard APIs‚Äã<a href="https://johnnyreilly.com/bun-overview#support-for-web-standard-apis" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Some web APIs aren't relevant in the context of a server-first runtime like Bun ‚Äî for instance, the DOM API or History API. But many APIs are, and Bun embraces them. It doesn't reinvent the wheel; it leans into the ecosystem.</p>
<p>A great example is the Fetch API, an API that has been around for a long time in the browser but is relatively new to Node.js. Bun supports Fetch out of the box, along with providing partial or complete support for many other Web APIs.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="testing">Testing‚Äã<a href="https://johnnyreilly.com/bun-overview#testing" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Another built-in Bun feature is its ultra-fast test runner, which is compatible with the Jest testing framework. The Bun runtime itself executes the tests, contributing to a smooth DX and optimal performance.</p>
<p>Bun‚Äôs testing capabilities support features like the following:</p>
<ul>
<li><strong>TypeScript support:</strong> Write strongly typed tests in TypeScript without needing to transpile your code. This out-of-the-box support can also help you catch type-related errors early. No more adding ts-jest and ts-node into your project to get to the same goal!</li>
<li><strong>JSX support:</strong> Test your UI components as you build them ‚Äî no additional configuration needed</li>
<li><strong>Lifecycle hooks:</strong> Set up conditions before tests run, then clean up after them, making your tests more reliable and easier to maintain</li>
<li><strong>Snapshot testing:</strong> Snapshot tests are a fantastic way to cut down on the code you have to write for a test and get good coverage of the behavior of portions of your application. If you loved this testing feature with Yarn, Bun provides it too!</li>
<li><strong>UI &amp; DOM testing:</strong> If you want to test your DOM without the need for a browser, Bun has you covered</li>
<li><strong>Watch mode with <code>--watch</code>:</strong> You may prefer to have your tests running in the background and getting that feedback as files are updated. Bun tests give you just what you need with the speed you‚Äôve likely come to expect</li>
</ul>
<p>These comprehensive testing features are a compelling alternative to what‚Äôs out there already. But perhaps more significantly, if you have tests you‚Äôre already writing in another test framework ‚Äî which likely describes the majority of cases ‚Äî then you can still use them with Bun.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="debugging">Debugging‚Äã<a href="https://johnnyreilly.com/bun-overview#debugging" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>All platforms benefit from the ability to debug. Presently, Bun supports debugging in two ways:</p>
<ul>
<li><a href="https://bun.sh/guides/runtime/web-debugger" target="_blank" rel="noopener noreferrer">The web debugger</a></li>
<li><a href="https://bun.sh/guides/runtime/vscode-debugger" target="_blank" rel="noopener noreferrer">The VS Code debugger</a></li>
</ul>
<p>Of these two, the recommended approach at the time of this writing is to use the web debugger. The VS Code debugger is still in beta and has some bugs.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="additional-internal-bun-apis">Additional internal Bun APIs‚Äã<a href="https://johnnyreilly.com/bun-overview#additional-internal-bun-apis" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p><a href="https://bun.sh/docs/runtime/bun-apis" target="_blank" rel="noopener noreferrer">Bun implements a set of native APIs</a> on the Bun global object and through a number of built-in modules. You can use these APIs, but they generally amount to being aliases for the Node.js API equivalents.</p>
<p>If you‚Äôre concerned about vendor lock-in, or if you want your code to be more typical to readers, you may want to use the Node.js APIs over Bun‚Äôs.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="use-cases-for-bun">Use cases for Bun‚Äã<a href="https://johnnyreilly.com/bun-overview#use-cases-for-bun" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>So where would you use Bun? What are some of its ideal use cases?</p>
<p>There are many, but here are some of the use cases that I've used Bun for:</p>
<ul>
<li><strong>Installing npm packages:</strong> Because Bun is compatible with npm, you can use it to install npm packages faster than with Node.js. This gives you back the time you would otherwise waste sitting and looking at your console to install locally or waiting for your CI to install packages</li>
<li><strong>Running scripts:</strong> I've long used JavaScript and TypeScript to write command line scripts. Bun is a great way to run these, as it executes them much faster</li>
<li><strong>Local development:</strong> Being fast and easy to use makes Bun great for local development. In case I haven‚Äôt said it enough, let me say it again: Bun is fast!</li>
</ul>
<p>You can explore many of the other use cases for Bun in Bun's guides.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="bun-vs-nodejs-and-deno">Bun vs. Node.js and Deno‚Äã<a href="https://johnnyreilly.com/bun-overview#bun-vs-nodejs-and-deno" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Bun is a JavaScript runtime. So is Node.js, and so is Deno. So what's the difference between them? Why would you use Bun over Node.js or Deno?</p>
<p>It's possible to look at Bun as "Node.js - but better!". By this I mean it supports the same APIs as Node.js, but it's faster and often easier to use.</p>
<p>For example, you can write TypeScript with Node.js, but you will need to do some work to get it to work. With Bun, you can just write TypeScript. The speed of Bun is also a big selling point. Bun is much faster than Node.js ‚Äî not just a little bit faster, but a lot faster.</p>
<p>Deno is a very similar project to Bun: a fast JavaScript runtime that supports TypeScript. However, though Deno itself is very fast, Bun is faster in many benchmarks than Deno.</p>
<p>Additionally, Deno is a great project, but <a href="https://deno.com/blog/v1" target="_blank" rel="noopener noreferrer">at launch, it intentionally didn't support npm</a>. This lack of npm compatibility increased friction in the process of migrating a Node.js app to Deno.</p>
<p>Times have changed; Deno now supports npm, and that friction is lessened. But Bun has supported npm from the start and always intended to.</p>
<p>Here‚Äôs a comparison table you can use as a quick resource for comparing Node.js, Deno, and Bun:</p>
<table><thead><tr><th></th><th>Node.js</th><th>Deno</th><th>Bun</th></tr></thead><tbody><tr><td>JavaScript support</td><td>‚úÖ</td><td>‚úÖ</td><td>‚úÖ</td></tr><tr><td>TypeScript support</td><td>‚ùå</td><td>‚úÖ</td><td>‚úÖ</td></tr><tr><td>JSX / TSX support</td><td>‚ùå</td><td>‚úÖ</td><td>‚úÖ</td></tr><tr><td>Speed</td><td>Reasonable</td><td>Faster than Node.js</td><td>Faster than Node.js and Deno by many benchmarks</td></tr><tr><td>Node.js API compatible</td><td>‚úÖ</td><td>‚úÖ ‚Äî <a href="https://docs.deno.com/runtime/manual/node/migrate#runtime-permissions-in-deno" target="_blank" rel="noopener noreferrer">permissions will need to be granted at runtime</a></td><td>‚úÖ</td></tr><tr><td>Module support - CommonJS</td><td>‚úÖ</td><td>‚ùå</td><td>‚úÖ</td></tr><tr><td>Module support - ECMAScript</td><td>‚úÖ ‚Äî although not without friction</td><td>‚úÖ</td><td>‚úÖ</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion‚Äã<a href="https://johnnyreilly.com/bun-overview#conclusion" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>If you love writing JavaScript and TypeScript, then you'll love Bun. It's fast, easy to pick up, and a joy to use. Bun is a great project and I'm excited to see where it goes next.</p>
<p>Do take a look at the Bun website to see its documentation and developer guides. I hope this resource will be helpful as you consider a JavaScript runtime to use in your next project.</p>
<p><a href="https://blog.logrocket.com/bun-adoption-guide/" target="_blank" rel="noopener noreferrer">This post was originally published on LogRocket</a> and edited by <a href="https://www.linkedin.com/in/leemeganj/" target="_blank" rel="noopener noreferrer">Megan Lee</a>.</p>
]]></content:encoded>
            <category>bun</category>
        </item>
        <item>
            <title><![CDATA[How we fixed my SEO]]></title>
            <link>https://johnnyreilly.com/how-we-fixed-my-seo</link>
            <guid>https://johnnyreilly.com/how-we-fixed-my-seo</guid>
            <pubDate>Sun, 17 Dec 2023 11:47:43 GMT</pubDate>
            <description><![CDATA[In October 2022 traffic to my site tanked. Growtika collaborated with me to fix it. This is what we did. Read it if you're trying to improve your SEO.]]></description>
            <content:encoded><![CDATA[<p>We might also call this:</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="i-ruined-my-seo-and-a-stranger-from-hacker-news-help-me-fix-it">I ruined my SEO and a stranger from Hacker News help me fix it<a href="https://johnnyreilly.com/how-we-fixed-my-seo#i-ruined-my-seo-and-a-stranger-from-hacker-news-help-me-fix-it" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>This is a follow up to my <a href="https://johnnyreilly.com/how-i-ruined-my-seo">"How I ruined my SEO"</a> post. That was about how my site stopped ranking in Google's search results around October 2022. This post is about how <a href="https://growtika.com/" target="_blank" rel="noopener noreferrer">Growtika</a> and I worked together to fix it.</p>
<p>As we'll see, the art of SEO (Search Engine Optimisation) is a mysterious one. We made a number of changes that we believe helped. All told, my site spent about a year out in the cold - barely surfacing in search results. But in October 2023 it started ranking again. And it's been ranking ever since.</p>
<p>I put that down to the assistance rendered by Growtika. What was the nature of that assistance? I'll tell you. This post is a biggie; so buckle up!</p>
<p><img decoding="async" loading="eager" alt="title image reading &amp;quot;How we fixed my SEO&amp;quot; with images of graphs trending upwards in the background" src="https://johnnyreilly.com/assets/images/title-image-0c20a57cb29b05a6a5ebae9048331c25.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="growtika-steps-up">Growtika steps up!<a href="https://johnnyreilly.com/how-we-fixed-my-seo#growtika-steps-up" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>I wrote <a href="https://johnnyreilly.com/how-i-ruined-my-seo">"How I ruined my SEO"</a> almost as self therapy. I was frustrated that my site's traffic had dropped. I knew it didn't really matter; my motivation for writing my blog is, in large part, about creating a long term memory for myself. But I was still frustrated. I write things that I know people find useful, and so it was suboptimal that my posts were no longer being found.</p>
<p>I should include myself in that. When I'm trying to remember how to do something (and I know I once knew how to do it) I'll often Google it. Hoping to see a blog post I once wrote that answers my question. But, no more. My own site was no longer being found by me. I was missing me. Vanity.</p>
<p>I shared the post on Hacker News, not really expecting much to happen. But it ranked, and in amongst the conversation that followed, <a href="https://news.ycombinator.com/item?id=34389421#34390189" target="_blank" rel="noopener noreferrer">someone named Growtika offered to help</a>.</p>
<p><img decoding="async" loading="lazy" alt="screenshot of the Hacker News conversation with Growtika" src="https://johnnyreilly.com/assets/images/screenshot-hacker-news-growtika-45a8b0116e760013c58ae40fa16426b5.webp" width="1552" height="711" class="img_ev3q"></p>
<p>I hadn't heard of Growtika before; SEO is not my world. But it turned out that Growtika specialise in helping organisations with that. Out of the goodness of their hearts, they offered to assist me. Never one to look a gift horse in the mouth, I leapt at the offer.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-mysterious-seo-feedback-loop">The mysterious SEO feedback loop<a href="https://johnnyreilly.com/how-we-fixed-my-seo#the-mysterious-seo-feedback-loop" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>I spent some time with Growtika talking through my site. They made some suggestions around getting my site to align with best practices. They also schooled me on some of the basics of SEO. I was very much a novice in this area, and so I was grateful for the education.</p>
<p>Here's the thing: SEO is a mystery. Or at least, it's not fully understood. Like Coke haven't published their recipe, Google doesn't publish its (ever evolving) algorithm. They do publish <a href="https://developers.google.com/search/docs/fundamentals/seo-starter-guide" target="_blank" rel="noopener noreferrer">SEO guidelines</a>, but they are just that: guidelines. And so, whilst there are best practices, there is no guarantee that following them will result in success.</p>
<p>What's more, the feedback loop for changes is <strong>long</strong>. It's not like fixing a program with a bug, where you tweak the code, run the tests and see if it's fixed. It's more like making a change to a program, and then waiting weeks or months to see if it's fixed. And if it's not, you have to wait again to see if the next change you make fixes it.</p>
<p>Cause and effect are just not as obvious as you might like, when it comes to SEO. So whilst I'm going to share what we did, I can't say for sure what actually lead to the improvement in my site's SEO. I'm confident that they were all good things to do. But I cannot be certain which of them made the difference.</p>
<p>As an aside, Growtika think that it's pretty absurd that developers who write high quality technical articles (and for the sake of this point, let's say mine fit into this category sometimes), need to run the gauntlet of SEO best practices to get ranked. It really shouldn't be necessary. With one of the recent Google algorithm updates; <a href="https://developers.google.com/search/docs/appearance/helpful-content-system" target="_blank" rel="noopener noreferrer">the helpful content algorithm update</a>, it feels like Google are starting to understand that it and prioritize it in their search engine. But there's still a long way to go.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-changes-we-made">The changes we made<a href="https://johnnyreilly.com/how-we-fixed-my-seo#the-changes-we-made" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Over the time we worked together, Growtika made a number of suggestions. Changes we might make that could improve my SEO. I'm going to go through the suggestions over the rest of the post. I'll also share some of the rationale as I go along.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="e-e-a-t-all-you-can">E-E-A-T all you can!<a href="https://johnnyreilly.com/how-we-fixed-my-seo#e-e-a-t-all-you-can" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>There's a concept used by Google for ranking known as Experience, Expertise, Authoritativeness, and Trust (E-E-A-T). It's about how much Google trusts the content on your site. When evaluating an author's profile for a blog post, it's worth considering the following E-E-A-T aspects:</p>
<ul>
<li><strong>Experience</strong>: What is the author's practical experience in the topic area?</li>
<li><strong>Expertise</strong>: Does the author have specialized knowledge or educational background in the subject?</li>
<li><strong>Authoritativeness</strong>: How is the author recognized by peers or industry experts? Are there publications or professional achievements highlighting their authority?</li>
<li><strong>Trustworthiness</strong>: Can the reader rely on the author for accurate and ethical information? Consider their track record and any endorsements by credible sources.</li>
</ul>
<p>I didn't have much that addressed these points on my site.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-author-profile">1. Author profile<a href="https://johnnyreilly.com/how-we-fixed-my-seo#1-author-profile" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h4>
<p>On each blog post I had a profile picture. But it wasn't being all it could be; it looked like this:</p>
<p><img decoding="async" loading="lazy" alt="picture of the profile image of this blog&amp;#39;s author" src="https://johnnyreilly.com/assets/images/screenshot-profile-picture-before-1f29cd5f0861c90939a843438cf60fff.webp" width="204" height="74" class="img_ev3q"></p>
<p>It's my face and the text <em>"John Reilly"</em> which linked through to my Twitter (now X) profile page. Nice enough but not really demonstrating my expertise and authority on topics. I updated it to look like this:</p>
<p><img decoding="async" loading="lazy" alt="picture of the profile image of this blog&amp;#39;s author with a byline" src="https://johnnyreilly.com/assets/images/screenshot-profile-picture-after-b83094c478b5ef3f4b082b527179e912.webp" width="434" height="76" class="img_ev3q"></p>
<p>Alongside my picture and name I added a byline to demonstrate my expertise and authority on topics: <em>"OSS Engineer - TypeScript, Azure, React, Node.js, .NET"</em>. Alongside that, I switched the link to the about page on my site instead of Twitter.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-about-page">2. About page<a href="https://johnnyreilly.com/how-we-fixed-my-seo#2-about-page" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h4>
<p>Since the author profile at the top of each post didn't answer all the E-E-A-T points, enriching my about page was the way forward. I updated the <a href="https://johnnyreilly.com/about">about</a> page to include a richer bio and a list of places where my site has been featured:</p>
<p><img decoding="async" loading="lazy" alt="screenshot of the &amp;quot;where has this blog featured section&amp;quot;" src="https://johnnyreilly.com/assets/images/screenshot-where-has-this-blog-featured-86eaf8c6332d00177a8a5eb13e247377.webp" width="1184" height="709" class="img_ev3q"></p>
<p>This was to demonstrate my expertise and authority on topics. We even snuck in some structured data - more on that later!</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="duplicate-content">Duplicate content<a href="https://johnnyreilly.com/how-we-fixed-my-seo#duplicate-content" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>My site is built using <a href="https://docusaurus.io/" target="_blank" rel="noopener noreferrer">Docusaurus</a>. Now I love Docusaurus, but it's not perfect. One of the problems with it is that it generates a number of pages that are not helpful for SEO as they <strong>duplicate content</strong>. (This is a bad thing for SEO.) Consider this report:</p>
<p><img decoding="async" loading="lazy" alt="screenshot of duplicate content report" src="https://johnnyreilly.com/assets/images/screenshot-duplicate-content-c3f6e850faa4ec65d5aa36c716cb57bb.webp" width="870" height="338" class="img_ev3q"></p>
<p>The report suggests there was a good amount of duplicate content on my site. This was because Docusaurus generates "pagination" pages which allow you to navigate click by click through the whole history of a blog.</p>
<p><img decoding="async" loading="lazy" alt="screenshot of the Docusaurus pagination mechanism" src="https://johnnyreilly.com/assets/images/screenshot-docusaurus-pagination-79b9ab66f92fc1028c04886f1f2063ff.webp" width="1119" height="861" class="img_ev3q"></p>
<p>Also Docusaurus creates "tag" (or category) pages that reproduce blog posts under tags that have been used to categorise the posts:</p>
<p><img decoding="async" loading="lazy" alt="screenshot of the Docusaurus tags mechanism" src="https://johnnyreilly.com/assets/images/screenshot-docusaurus-tags-8f690ea3e6a3cf8787a4133f6aaabc85.webp" width="1120" height="575" class="img_ev3q"></p>
<p>In both cases, these pages duplicate content - which lead to the above report. Rather frustratingly, the pages also feature <code>canonical</code> link tags which rather suggest that they are the canonical source of the content:</p>
<p><img decoding="async" loading="lazy" alt="screenshot of a canonical tag which reads: link rel=&amp;quot;canonical&amp;quot; href=&amp;quot;https://johnnyreilly.com/page/2&amp;quot;" src="https://johnnyreilly.com/assets/images/screenshot-not-helpful-canonical-d047647d683a8a446cd17ce647f4285b.png" width="796" height="324" class="img_ev3q"></p>
<p>In my case, some of these pagination or tags pages were being prioritised over the original blog posts. This felt quite strange from a readers point of view. We took a number of steps to address this.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-remove-or-noindex-unnecessary-pages">1. Remove or <code>noindex</code> unnecessary pages<a href="https://johnnyreilly.com/how-we-fixed-my-seo#1-remove-or-noindex-unnecessary-pages" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h4>
<p>I wanted to remove or <code>noindex</code> the pagination and tags pages to provide a clear signal to search engines about which pages were the most important. I couldn't remove the pages without breaking the navigation on my site, so I chose instead to <code>noindex</code> them. My site is hosted on <a href="https://johnnyreilly.com/migrating-from-github-pages-to-azure-static-web-apps">Azure Static Web Apps</a> and so I was able to achieve this fairly easily by adding the following to my <a href="https://learn.microsoft.com/en-us/azure/static-web-apps/configuration" target="_blank" rel="noopener noreferrer"><code>staticwebapp.config.json</code></a> file:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockTitle_Ktv7">staticwebapp.config.json</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"route"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"/page/*"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"headers"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">"X-Robots-Tag"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"noindex"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"route"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"/tags/*"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"headers"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">"X-Robots-Tag"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"noindex"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This meant that the pagination and tags pages (which were served up under URLs beginning <code>/page/</code> and <code>/tags/</code> respectively) were still available, but search engines were encouraged <a href="https://developers.google.com/search/docs/crawling-indexing/robots-meta-tag#xrobotstag" target="_blank" rel="noopener noreferrer">not to index them by the <code>X-Robots-Tag: noindex</code> header</a> that these pages now served.</p>
<p>I might see if I could land a change like this in Docusaurus itself. I think it would be helpful for others. The mechanism would need to be slightly different, as Docusaurus doesn't have control over headers your site serves. But I think it would be possible to add a <code>noindex</code> meta tag to the pagination and tags pages HTML as is <a href="https://developers.google.com/search/docs/crawling-indexing/block-indexing#implementing-noindex" target="_blank" rel="noopener noreferrer">suggested here</a>:</p>
<div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag" style="color:rgb(255, 157, 0)">meta</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(255, 255, 255)">=</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag attr-value" style="color:rgb(255, 157, 0)">robots</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">content</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(255, 255, 255)">=</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag attr-value" style="color:rgb(255, 157, 0)">noindex</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag" style="color:rgb(255, 157, 0)"> </span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">/&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-docusaurus-truncate">2. Docusaurus truncate<a href="https://johnnyreilly.com/how-we-fixed-my-seo#2-docusaurus-truncate" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h4>
<p>As I've mentioned, we have pagination and tags pages that duplicate content. It's possible to make this slightly better by truncating the content on the pagination and tags pages. It amounts to adding a <code>truncate</code> marker early into the content of each blog post.</p>
<p>With this in place, the pagination and tags pages don't duplicate the content of the blog posts in full, but instead just feature a snippet of the content. There's documentation on how to do this in <a href="https://docusaurus.io/docs/blog#blog-list" target="_blank" rel="noopener noreferrer">Docusaurus here</a>.</p>
<p>I did this for every page on my blog. Given I have quite a lot of posts, doing it manually would have been tedious. So I scripted the insertion of a truncate marker after the first paragraph of each post, and it was done in a jiffy.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tags-review">Tags review<a href="https://johnnyreilly.com/how-we-fixed-my-seo#tags-review" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>I also performed something of a tag rationalisation. I had a lot of tags, and many of them were not used on more than one blog post. Also, many of them were not the greatest of tags, as this slightly embarrassing screenshot demonstrates:</p>
<p><img decoding="async" loading="lazy" alt="screenshot of the tags before my rationalisation" src="https://johnnyreilly.com/assets/images/screenshot-tags-before-cd940d4b05751675d6810e0bf3b5e5d7.png" width="762" height="856" class="img_ev3q"></p>
<p>As is probably apparent, I'd not really thought about tags much. I'd just added them as I'd written blog posts. I'd tagged first, asked questions later. I removed a lot of the (rather pointless) tags I had and also added a tags to blog posts that were missing them. This removed the "noise", so search engines understand the content of my blog posts, and readers also. Less is more.</p>
<p><img decoding="async" loading="lazy" alt="screenshot of the tags after my rationalisation" src="https://johnnyreilly.com/assets/images/screenshot-tags-after-e6f21a185490d7c20df28e1977283e50.png" width="779" height="661" class="img_ev3q"></p>
<p>Much better!</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sitemapxml-and-robotstxt"><code>sitemap.xml</code> and <code>robots.txt</code><a href="https://johnnyreilly.com/how-we-fixed-my-seo#sitemapxml-and-robotstxt" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Alongside <code>noindex</code>ing the pagination and tags pages, we took a look at my <code>sitemap.xml</code> - this is automatically generated by Docusaurus. I removed the pagination and tags pages from the <code>sitemap.xml</code> as it's a little confusing to <code>noindex</code> a page and then include it in the <code>sitemap.xml</code>.</p>
<p>Further to that, I write posts for other websites sometimes and cross post it on my own blog, with a canonical pointing to the original post. Having these posts in the <code>sitemap.xml</code> wasn't quite right as they are not the canonical source of the content. I removed them.</p>
<p>I've a number of post processing steps that run in my build step of my site, and I included this filtering in it. In the end it amounted to <a href="https://johnnyreilly.com/xml-read-and-write-with-node-js">filtering an XML file; which is pretty straightforward - I wrote about it to demonstrate</a>.</p>
<p>As well as filtering my <code>sitemap.xml</code>, I went a little further and added <code>lastmod</code> timestamps to the <code>sitemap.xml</code> based on the git commit date of the markdown file that the blog post was generated from. This was to help search engines understand how recent the content on my site is. <a href="https://johnnyreilly.com/adding-lastmod-to-sitemap-git-commit-date">I wrote about how I did this</a>. Google have subsequently announced that they use <a href="https://developers.google.com/search/blog/2023/06/sitemaps-lastmod-ping#the-lastmod-element" target="_blank" rel="noopener noreferrer"><code>lastmod</code> as a signal for scheduling re-crawling URLs</a> and so this turns out to have been a helpful change to make.</p>
<p>Alongside this, I added a <code>robots.txt</code> to my site. These are files that search engines use to understand the structure of a site and what they should and should not index. I didn't previously have one and the one I added was pretty rudimentary:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockTitle_Ktv7">robots.txt</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token plain">User-agent: *</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">Allow: /</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">Sitemap: https://johnnyreilly.com/sitemap.xml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>I don't know how much this helped, but it certainly didn't hurt.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="internal-linking--footer-links">Internal linking / footer links<a href="https://johnnyreilly.com/how-we-fixed-my-seo#internal-linking--footer-links" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>We next looked at our internal linking strategy. This is about how we link to other pages on our blog from within our blog posts. The idea is that we should link to other pages on our blog that are relevant to the topic of the blog post. This helps search engines understand the structure of our blog and the relationships between the pages.</p>
<p>This was something that I did a little, but I didn't really think about. I'm now much more intentional around internal linking. I'm very much an editor of my content, and as I'm editing my posts / writing new posts I'll take a look at whether I'm linking to other relevant posts on my blog and whether perhaps I should be.</p>
<p>You'll possibly have noticed a good number of internal links in this post! I'm careful about how I do this - I have internal links where they are relevant and where I think it adds value. I don't have internal links for the sake of it. Whilst I want to improve my SEO, the main readers of my blog are humans, and I want to make sure that I'm not making the experience worse for them.</p>
<p>Alongside upping my internal linking game, Growtika suggested that the footer of my site was a prime place to add links to notable posts on my site, and also to provide an indication of topics that this site seeks to cover.</p>
<p>A picture is worth a thousand words, so here's what the footer of my site used to look like:</p>
<p><img decoding="async" loading="lazy" alt="screenshot of the site with very few links or much at all in the footer" src="https://johnnyreilly.com/assets/images/screenshot-footer-before-2c5131d6d96f0c101b86f8ac14cea7f0.webp" width="1259" height="384" class="img_ev3q"></p>
<p>And here is what it looks like now:</p>
<p><img decoding="async" loading="lazy" alt="screenshot of the site with a good number of links in the footer" src="https://johnnyreilly.com/assets/images/screenshot-footer-after-c6037d490bd0116a8175761c42ed2f53.png" width="1259" height="758" class="img_ev3q"></p>
<p>As you can see, the difference is significant. With the new enhanced footer I can call out particular articles around themes that I cover, I can highlight popular articles, and I can also emphasise articles that I think are particularly important, or recently updated. This is both about helping search engines understand what I consider to be important in my site, it's also helpful for humans that might scroll that far down. And goshdarnit, I think it looks rather fine too!</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="pages-crawl-depth">Pages crawl depth<a href="https://johnnyreilly.com/how-we-fixed-my-seo#pages-crawl-depth" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>You likely know that a primary way that search engines find content on your site is by following links. They have <a href="https://developers.google.com/search/docs/crawling-indexing/overview-google-crawlers" target="_blank" rel="noopener noreferrer">crawlers</a> that do this. The more links that a crawler has to follow to get to a page, the more difficult it is for the crawler to find that page. This is known as the pages crawl depth.</p>
<p>My initial site structure was not great. I had a number of pages that were 4+ clicks away from the home page:</p>
<p><img decoding="async" loading="lazy" alt="screenshot of a pages depth report" src="https://johnnyreilly.com/assets/images/screenshot-pages-depth-24758a42e1782166bceaa28325bf81be.webp" width="617" height="215" class="img_ev3q"></p>
<p>A primary reason for my pages crawl depth this was the pagination and tags pages I mentioned earlier. We originally displayed a single full length (not truncated) blog post per page, and so the pagination pages were many. Likewise, we had a lot of tags, and so the tags pages were many. This meant that the pages crawl depth was high. You want to keep the pages crawl depth as low as possible. Less is more.</p>
<p>We increased the number of blog posts displayed per page from <strong>1</strong> to <strong>20</strong> which dramatically reduced the amount of work the crawlers had to do. So instead of having few hundred pagination pages we reduced it to 16. Much better.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="remove-date-from-urls">Remove date from urls<a href="https://johnnyreilly.com/how-we-fixed-my-seo#remove-date-from-urls" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>It used to be the case that the URLs for my blog posts always featured the date of publication. This was a hangover from when I used to use Blogger as my blogging platform. I'd <a href="https://johnnyreilly.com/definitive-guide-to-migrating-from-blogger-to-docusaurus">migrated from Blogger to Docusaurus</a>, and I'd kept the date in the URL. It so happens that Docusaurus has a similar behaviour too.</p>
<p>Growtika suggested that I remove the date from the URL. This was to make the URLs shorter and more readable. Search engines also have a preference both for shorter URLs and for pages that are recent, rather than pages that are old. So removing the date from the URL would help with both of those things. Or at least it would stop search engines that looked for the date in the URL from thinking that older content was irrelevant. (And with our <code>lastmod</code> timestamps in the <code>sitemap.xml</code> we were already helping search engines understand how recent the content on my site was.)</p>
<p>I must admit, I didn't really want to make this change. I rather liked having the date in the URL. But, in Growtika we trust. I did it.</p>
<p>Where you used to go to:</p>
<p><a href="https://johnnyreilly.com/2019/10/08/definitely-typed-movie" target="_blank" rel="noopener noreferrer">https://johnnyreilly.com/2019/10/08/definitely-typed-movie</a></p>
<p>You now go to:</p>
<p><a href="https://johnnyreilly.com/definitely-typed-the-movie" target="_blank" rel="noopener noreferrer">https://johnnyreilly.com/definitely-typed-the-movie</a></p>
<p>And of course, we made sure a redirect mechanism was in place to ensure that the old URLs still worked. More on that later - you can test the redirect if you like!</p>
<p><img decoding="async" loading="lazy" alt="screenshot of 301 redirect from the old url to the dateless one" src="https://johnnyreilly.com/assets/images/screenshot-301-redirect-3b90c16058c8c9207bdeb13f5c144e74.webp" width="766" height="451" class="img_ev3q"></p>
<p>To implement this we used the <a href="https://docusaurus.io/docs/api/plugins/@docusaurus/plugin-content-blog#slug" target="_blank" rel="noopener noreferrer">slug feature of Docusaurus</a>. If you want to see the mega PR that implemented this on nearly 300 blog posts <a href="https://github.com/johnnyreilly/blog.johnnyreilly.com/pull/423/files" target="_blank" rel="noopener noreferrer">it's here</a>. You won't be surprised to learn I scripted this change - life's too short to do boring things by hand.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="blog-archive-renamed-to-blog">Blog archive renamed to blog<a href="https://johnnyreilly.com/how-we-fixed-my-seo#blog-archive-renamed-to-blog" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>As I've said, Docusaurus is <em>great</em> but it historically has had some defaults that hurt SEO from a blogging perspective. One of these I identified when I was first planning to migrate from Blogger to Docusaurus. Docusaurus didn't ship with a blog archive. This is a page that allows you to browse through your historic blog posts. A place where you can see all that you've written and when. I find this very helpful. It's also helpful for search engines to understand the structure of your site.</p>
<p>I hand-rolled <a href="https://johnnyreilly.com/blog-archive-for-docusaurus">my own blog archive for Docusaurus</a> before I migrated. It looked like this:</p>
<p><img decoding="async" loading="lazy" alt="screenshot of the original blog archive functionality" src="https://johnnyreilly.com/assets/images/docusaurus-blog-archive-small-bd329602845b234668d34dd7fce47bb2.webp" width="1507" height="613" class="img_ev3q"></p>
<p>My implementation was later made part of Docusaurus itself by <a href="https://github.com/gabrielcsapo" target="_blank" rel="noopener noreferrer">Gabriel Csapo</a> in <a href="https://github.com/facebook/docusaurus/pull/5428" target="_blank" rel="noopener noreferrer">this PR</a>. So now by default, all Docusaurus sites have a blog archive that lives at <code>/archive</code> in the blog. This is great news for Docusaurus users!</p>
<p>In one if the more speculative changes we made, we changed the URL of the blog archive from <code>/archive</code> to <code>/blog</code> (and the associated navbar label).
It was a wild guess (and it may not have made any difference) but the thinking was that it might affect the CTA (call to action) of people who see my site on Google. If they saw old date in the URL and "archive" in the breadcrumbs, maybe they'd think the site is "not relevant for the search I have now"?</p>
<p>So our tweaked blog archive page now looked like this:</p>
<p><img decoding="async" loading="lazy" alt="screenshot of the blog archive functionality as it looks now" src="https://johnnyreilly.com/assets/images/screenshot-blog-archive-now-a1d8a655d412bcaacb875a49acd21da3.png" width="1165" height="849" class="img_ev3q"></p>
<p>We also added a <code>301</code> redirect from <code>/archive</code> to <code>/blog</code> to ensure that any links to the old URL would still work.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="structured-data">Structured data<a href="https://johnnyreilly.com/how-we-fixed-my-seo#structured-data" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>One of the most intriguing strategies we followed was to build on the structured data support in my site. Structured data is a way of providing metadata about a page in a machine readable format. It's a way of providing a clear signal to search engines about the content of a page; it makes their lives easier.</p>
<p>As it turned out, I already had some structured data support in my site; <a href="https://johnnyreilly.com/structured-data-seo-and-react">I'd written about how to add it previously</a>. But we were to go further!</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-faqs-with-structured-data">1. FAQs with Structured Data<a href="https://johnnyreilly.com/how-we-fixed-my-seo#1-faqs-with-structured-data" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h4>
<p>One of the experiments we ran was to add FAQs to a post, and with that, the equivalent FAQ Structured Data. The intent being to see if this would help with the SEO for that post. So, because I'm super meta, I wrote a <a href="https://johnnyreilly.com/docusaurus-structured-data-faqs-mdx">post about how to do that</a> which included FAQs and the equivalent structured data.</p>
<p>I also added FAQ structured data to another post and Growtika resubmitted it to Google for indexing. Then two things happened. Firstly, the page was indexed:</p>
<p><img decoding="async" loading="lazy" alt="screenshot showing the page featuring in search results" src="https://johnnyreilly.com/assets/images/screenshot-faqs-structured-data-indexed-4641360df4ff4e644a499221e4e21a85.webp" width="620" height="481" class="img_ev3q"></p>
<p>And then the page started featuring FAQs in the search results:</p>
<p><img decoding="async" loading="lazy" alt="screenshot showing the page featuring in search results and showing FAQs as well" src="https://johnnyreilly.com/assets/images/screenshot-faqs-structured-data-a8611a34cbf2eb5e8ca801fa6c59ff42.webp" width="625" height="390" class="img_ev3q"></p>
<p>I've included the reactions at the bottom of each screenshot above - we were quite excited!</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-site-wide-structured-data">2. Site wide structured data<a href="https://johnnyreilly.com/how-we-fixed-my-seo#2-site-wide-structured-data" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h4>
<p>Beyond adding individual structured data to each page and post, I added site wide structured data. This would proclaim from the rooftops about the nature of my site.</p>
<p>So I decided to add site wide structured data of the following types: (there are many types of structured data which you can read about at <a href="https://schema.org/" target="_blank" rel="noopener noreferrer">https://schema.org/</a> and in <a href="https://developers.google.com/search/docs/appearance/structured-data/search-gallery" target="_blank" rel="noopener noreferrer">this Google document on the topic</a>)</p>
<ul>
<li>Website</li>
<li>Organisation / Brand</li>
<li>Person</li>
</ul>
<p>You can see how the structured data is implemented in <a href="https://github.com/johnnyreilly/blog.johnnyreilly.com/pull/676" target="_blank" rel="noopener noreferrer">this PR</a>. We used the <a href="https://docusaurus.io/docs/api/docusaurus-config#headTags" target="_blank" rel="noopener noreferrer"><code>headTags</code> API in Docusaurus</a> to add site wide JSON-LD structured data. Funnily enough, <a href="https://github.com/facebook/docusaurus/pull/8151" target="_blank" rel="noopener noreferrer">I contributed the <code>headTags</code> API to Docusaurus</a> long before I thought I'd end up using it for this!</p>
<p>In this change we are <em>heavily</em> inspired by the full structured data graph work <a href="https://yoast.com/rich-results-schema-structured-data-story/" target="_blank" rel="noopener noreferrer">Yoast have done</a>. With site wide structured data in place, every page that search engines index on my site will have structured data that describes the site as a whole.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-breadcrumbs-with-structured-data">3. Breadcrumbs with Structured Data<a href="https://johnnyreilly.com/how-we-fixed-my-seo#3-breadcrumbs-with-structured-data" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h4>
<p>Finally I added breadcrumbs to my blog posts. Breadcrumbs are a way of indicating to search engines where a page sits in the hierarchy of a site. <a href="https://johnnyreilly.com/docusaurus-blogs-adding-breadcrumb-structured-data">I wrote about how I did this</a>. It's worth noting that the approach outlined in that post I've subsequently simplified. Originally I added a breadcrumb for the page structure and also one per tag on the post. I've since removed the tag breadcrumbs as they were not adding much value. Less is more.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="do-backlinks-better">Do backlinks better!<a href="https://johnnyreilly.com/how-we-fixed-my-seo#do-backlinks-better" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>I mentioned in <a href="https://johnnyreilly.com/how-i-ruined-my-seo">"How I ruined my SEO"</a> that I had a number of backlinks to my site. I also mentioned that I had broken a number of the backlinks by my carelessness. I planned to fix the broken backlinks and also do a better job of backlinks in general.</p>
<p>I'd already implemented support for dynamic redirects on my site. What this meant was, if someone linked through to a non-existent page on my site, rather than having just a 404 Not Found, I could do some fairly sophisticated work to redirect them to the correct URL. Thus protecting (and unbreaking previously broken) backlinks. By the way, using Azure Static Web Apps as my hosting mechanism really helped me out here as the dynamic redirect mechanism I had was super powerful - I wasn't limited to regexes. If you want see how I did that <a href="https://johnnyreilly.com/azure-static-web-apps-dynamic-redirects-azure-functions">have a read of this</a>.</p>
<p>What I had was good, but I could do better. I did the following:</p>
<ul>
<li>exhaustively fix all my broken backlinks; getting them all to redirect to the correct place. This meant logging broken backlinks and repairing them over time. Tedious, but worth it.</li>
<li>add a redirect from my old site domain to my new one (blog.johnnyreilly.com -&gt; johnnyreilly.com)</li>
<li>redirect <strong>only once</strong>. I had a number of redirects that were chained together. I had a 301 leading to 301 leading to 301 (yes!) and only then leading to a 200. Redirecting only once would be better. This would ensure that search engines didn't have to follow a chain of redirects to get to the content they were looking for. Search engines don't like that; you lose "link juice" the more redirects there are. Also, multi redirects make my website work harder than it needs to.</li>
</ul>
<p>Again, less is more. With these changes made, I had a much better backlink story.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="improving-site-performance">Improving site performance<a href="https://johnnyreilly.com/how-we-fixed-my-seo#improving-site-performance" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Another aspect which factors into SEO is performance. Google has a <a href="https://web.dev/articles/vitals" target="_blank" rel="noopener noreferrer">Core Web Vitals</a> measurement which is about evaluating the performance of websites. It covers how fast a website loads, how responsive it is / how quickly it becomes interactive.</p>
<p>The thing that was hurting my site's performance was images. The images on my site were generally not optimised at all. They were also not lazy loaded. This meant that the images were slowing down the loading of my site, and this reflected in my <a href="https://developer.chrome.com/docs/lighthouse/overview/" target="_blank" rel="noopener noreferrer">Lighthouse</a> scores.</p>
<p>I took a number of actions to improve the site image performance.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-improved-performance-using-tinypngs-image-optimisation-api">1. Improved performance using TinyPNG's image optimisation API<a href="https://johnnyreilly.com/how-we-fixed-my-seo#1-improved-performance-using-tinypngs-image-optimisation-api" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h4>
<p>The first, and most obvious, was to optimise the images on my site. There's many ways you can do this; I chose to use <a href="https://tinypng.com/developers" target="_blank" rel="noopener noreferrer">TinyPNG's API</a>. I wrote about <a href="https://johnnyreilly.com/image-optimisation-tinypng-api">how I did this</a>. Ultimately I wrote a script that optimised all the images on my site, and allowed me to run it on demand for the images of a particular post.</p>
<p>This shrunk the file size of images on my site served significantly, and improved the performance. Once again, less is more.</p>
<p>I also <a href="https://johnnyreilly.com/lighthouse-meet-github-actions">added Lighthouse to my site's build step</a>, so I could get some performance measurements surfaced into my pull requests. This made it easy to catch potential regressions, where I might accidentally add unoptimised images to my site.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-improved-performance-using-cloudinarys-on-demand-image-transformation-cdn">2. Improved performance using Cloudinary's on demand image transformation CDN<a href="https://johnnyreilly.com/how-we-fixed-my-seo#2-improved-performance-using-cloudinarys-on-demand-image-transformation-cdn" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h4>
<p>Having tackled the low hanging fruit of images not being optimal in the first place, I then went further. Cloudinary offer a <a href="https://cloudinary.com/documentation/image_transformations" target="_blank" rel="noopener noreferrer">CDN that can transform images on demand</a>. This means that you can serve the same image in different sizes, formats and qualities depending on the device that is requesting it. This is a great way to improve performance.</p>
<p>I was able to plug the Cloudinary CDN into my site using by building a the <a href="https://github.com/johnnyreilly/rehype-cloudinary-docusaurus" target="_blank" rel="noopener noreferrer"><code>rehype-cloudinary-docusaurus</code> plugin</a> which can be used to integrate Cloudinary into Docusaurus. You can <a href="https://johnnyreilly.com/docusaurus-image-cloudinary-rehype-plugin">read more about how it works here</a>.</p>
<p>Now when my site serves an image, it serves the optimal image for the device that is requesting it. This improves the performance of my site. (And you can do this too if you're using Docusaurus!)</p>
<p>In fact I went a little further and scripted the patching of my <a href="https://johnnyreilly.com/open-graph-sharing-previews-guide">Open Graph images</a> to make use of Cloudinary too. This meant that the images that were shared on social media were also optimised for the device that was requesting them. I don't think this helped with SEO, but I'd noticed that large and / or slow loading Open Graph images aren't always used by platforms that support the Open Graph protocol. With the Cloudinary image transformation CDN in place, this became much less of an issue.</p>
<p>Incidentally, Cloudinary got wind of this change and invited me onto their <a href="https://youtube.com/watch?v=G4WTEEwI6Qs" target="_blank" rel="noopener noreferrer">DevJams live stream to talk about it</a>. I was very flattered to be asked and it was a lot of fun!</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-improved-performance-using-fetchpriorityhigh-and-loadinglazy">3. Improved performance using <code>fetchpriority="high"</code> and <code>loading="lazy"</code><a href="https://johnnyreilly.com/how-we-fixed-my-seo#3-improved-performance-using-fetchpriorityhigh-and-loadinglazy" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h4>
<p>So far we'd handled the performance of images on my site by optimising them and serving them in an optimal way. But there was more we could do. We could also make sure that the images on my site were loaded in an optimal way.</p>
<p>We did this by adding <code>fetchpriority="high"</code> to the first image on each blog post; the "title" image if you will. This is a hint to the browser that the image is important and should be loaded as soon as possible. We also added <code>loading="lazy"</code> to all the other images on a given blog post. This is a hint to the browser that those images (the "below the fold" images) are not as important, and can be loaded later if and when they are required.</p>
<p>The effect of these two changes combined, is that when a browser lands on a blog post it loads the first image as soon as possible, and then it doesn't immediately load the rest images; it focuses on giving the user a usable page. The upshot of this is that the Largest Contentful Paint (LCP) is loaded as soon as possible and the browser remains more responsive. The remaining images may be loaded... Or they may not - it depends on whether people scroll down to them. This translates into improved perceived performance / user experience.</p>
<p>And again: less is more. <a href="https://johnnyreilly.com/docusaurus-improve-core-web-vitals-fetchpriority">I've written about how using <code>fetchpriority="high"</code> and <code>loading="lazy"</code> was implemented in depth here</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="be-careful-publishing-your-content-on-other-sites">Be careful publishing your content on other sites<a href="https://johnnyreilly.com/how-we-fixed-my-seo#be-careful-publishing-your-content-on-other-sites" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>One of the ideas I'd had as I attempted to fix my SEO was to publish my content on other sites. I'd seen other people do this, and I thought it might be a good idea. So I set up a mechanism that published my blog posts to <a href="https://dev.to/johnnyreilly" target="_blank" rel="noopener noreferrer">dev.to</a> with the canonical pointing back to my site. I was so pleased with my idea I even wrote about <a href="https://johnnyreilly.com/publishing-docusaurus-to-devto-with-devto-api">how I did it</a>.</p>
<p>Publishing content on other sites isn't inherently negative. However, in my case, it created confusion. I'd hoped that publishing my content on dev.to would help my SEO. It didn't. My content on dev.to ranked higher than the original content on my own website (most times my site didn't rank at all).</p>
<p>Growtika were keen to "cancel the noise", which would improve their understanding of my ranking situation. Since dev.to was ranking instead of my site, it was difficult to analyze how long it took for articles to rank on my site. Stopping the submission of content to external sites would help clarify the situation.</p>
<p>I turned the mechanism off. This helped them determine the time it took for my site to achieve a ranking.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="get-your-site-featured-in-relevant-places">Get your site featured in relevant places<a href="https://johnnyreilly.com/how-we-fixed-my-seo#get-your-site-featured-in-relevant-places" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Whilst actually publishing your content on other sites with a canonical turns out not to be the best idea, getting your site featured in relevant places is a good idea. This is about getting your site linked to from other sites. This is a signal to search engines that your site is relevant and important.</p>
<p>I already had a number of links to my site from other sites. For instance, I'd regularly show up in <a href="https://azureweekly.info/" target="_blank" rel="noopener noreferrer">Azure Weekly</a>, <a href="https://blog.cwa.me.uk/" target="_blank" rel="noopener noreferrer">The Morning Brew</a> and a number of other sites. Many of these use my RSS feed.</p>
<p>I also submitted my site to a number of other places. For instance, I submitted my site to <a href="https://daily.dev/" target="_blank" rel="noopener noreferrer">daily.dev</a>. A good rule of thumb here for picking places tended to be "where do you go to read about the topics you write about?". But crucially I didn't place my content on others sites, I just linked to my site from other sites.</p>
<p>As a side note, I rather wish that RSS still thrived. I support it - people still use it to read my blog. But it's not as popular as it once was.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="add-meta-description-to-blog-posts">Add meta description to blog posts<a href="https://johnnyreilly.com/how-we-fixed-my-seo#add-meta-description-to-blog-posts" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>The final tweak we're going to cover, is adding meta descriptions to my posts. This is a short description of the content of the blog post that is included in the HTML of the page:</p>
<div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token tag punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token tag" style="color:rgb(255, 157, 0)">meta</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">  </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(255, 255, 255)">=</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag attr-value" style="color:rgb(255, 157, 0)">description</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)">  </span><span class="token tag attr-name" style="color:rgb(255, 180, 84)">content</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(255, 255, 255)">=</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag attr-value" style="color:rgb(255, 157, 0)">In October 2022 traffic to my site tanked. Growtika collaborated with me to fix it. This is what we did. Read it if you're trying to improve your SEO.</span><span class="token tag attr-value punctuation" style="color:rgb(255, 255, 255)">"</span><span class="token tag" style="color:rgb(255, 157, 0)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token tag" style="color:rgb(255, 157, 0)"></span><span class="token tag punctuation" style="color:rgb(255, 255, 255)">/&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It's not visible to humans, but it is visible to search engines. And it's kind of visible to humans at one remove, in that it is often used as the description of the page in search results.</p>
<p>We followed these meta description guidelines:</p>
<ul>
<li>Keep it between 150-155 characters</li>
<li>Use an active voice and make it actionable / include a call to action</li>
<li>Use a focused keyphrase</li>
<li>Make sure it matches the content of the page</li>
<li>Make it unique.</li>
</ul>
<p>I'd previously not included meta descriptions on my blog posts. I found myself with the daunting task of writing meta descriptions for nearly 300 blog posts. I decided to script it. I wrote a script that would generate a meta description for each blog post based on the content of the blog post, powered by Azure Open AI. I then ran the script and added the meta descriptions to my blog posts. I wrote about <a href="https://johnnyreilly.com/azure-open-ai-generate-article-metadata-with-typescript">how I did this here</a>.</p>
<p>This left me with meta descriptions for all my blog posts. It was also rather fun to use AI for something that was not GPT or copilot related!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="drop-off-and-recovery-in-numbers-and-graphs">Drop off and recovery in numbers and graphs<a href="https://johnnyreilly.com/how-we-fixed-my-seo#drop-off-and-recovery-in-numbers-and-graphs" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>As I mentioned earlier, my SEO has now recovered. I'm ranking again in search results. I'm not ranking quite as highly as I was before; I think my site is possibly still in the throes of recovery. But without a doubt, it's definitely trending in the right direction. I want to show you some graphs and numbers to demonstrate this.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ahrefs">Ahrefs<a href="https://johnnyreilly.com/how-we-fixed-my-seo#ahrefs" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Here's a graph from Ahrefs showing my site's performance over the last two years:</p>
<p><img decoding="async" loading="lazy" alt="gif from ahrefs showing a massive drop off then recovery" src="https://johnnyreilly.com/assets/images/screenshot-ahrefs-two-years-7df86ac3269fb2d53f4625dae23d0479.gif" width="2155" height="1574" class="img_ev3q"></p>
<p>Notably, you can see the drop off happened around the time of a Google algorithm update. Likewise, it's really important to highlight that the traffic <strong>increased</strong> around the time Google made <em>another</em> algorithm update. It's impossible to know if the traffic would still have gone up if we had not made our changes. Perhaps it would, maybe to a lesser extent. We just don't know. It does demonstrate the power of Google's algorithm updates though. The graph alone tells a story, a phenomenal drop off in traffic followed by a recovery.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="google-search-console">Google Search Console<a href="https://johnnyreilly.com/how-we-fixed-my-seo#google-search-console" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>A couple of simpler graphs from Google Search Console tell a similar story. Here's a graph showing my site's performance over time:</p>
<p><img decoding="async" loading="lazy" alt="screenshot from Google Search Console showing performance over time" src="https://johnnyreilly.com/assets/images/screenshot-of-performance-18493275b3b00e779ce1894577884b40.webp" width="900" height="294" class="img_ev3q"></p>
<p>Observe the massive drop off in October 2022. And then the recovery in October / November 2023. It's a similar story to the ahrefs graph above. Further to that, here is the traffic for 28 days in February 2023 vs 28 days in October / November 2023:</p>
<p><img decoding="async" loading="lazy" alt="screenshot from Google Search Console showing few results in February 2023 vs lots of results in October / November 2023" src="https://johnnyreilly.com/assets/images/screenshot-google-search-console-af96833d6ddd48eca6d90e75d54083b1.webp" width="1392" height="576" class="img_ev3q"></p>
<p>If you're reading on a mobile device you may not even realise that there are two lines on the graph; the February 2023 line is so low and flat as to be almost invisible.</p>
<p>The difference is stark. I couldn't get arrested from a search perspective in February 2023; showing up a mere <strong>5,000</strong> times in search results. That sounds like a big number, but in search terms it's really not. But by October / November 2023 I was back in the game, showing up <strong>274,000</strong> times in search results. That's a <strong>55x</strong> increase!</p>
<p>An interesting aside, that I've excluded from the graph, is that my total clicks increased from <strong>1,160</strong> to <strong>5,470</strong> when comparing Februray to October / November. This is a mere factor of <strong>4</strong>. What does that mean? It means when my site was showing up very rarely in search results, it enjoyed a very healthy click through rate. People clicked on my search results when they saw them!</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="bing-webmaster-tools">Bing webmaster tools<a href="https://johnnyreilly.com/how-we-fixed-my-seo#bing-webmaster-tools" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>This post has mostly been driven by discussing how Google stopped ranking my site in their search results. What I haven't really mentioned is that other search engines <strong>did not</strong> stop ranking my site. I was still showing up in Bing and DuckDuckGo's search results. Here's a graph from Bing webmaster tools (Bing's equivalent to Google Search Console) showing my site's performance over the last six months:</p>
<p><img decoding="async" loading="lazy" alt="screenshot from Bing webmaster tools" src="https://johnnyreilly.com/assets/images/screenshot-bing-webmaster-tools-graph-2223f31d2a70d62d1fcc9c7a67e37589.webp" width="977" height="391" class="img_ev3q"></p>
<p>There's two things to take from the above graph:</p>
<ol>
<li>My site consistently ranked (and ranks) in Bing search results. There was no drop off in Bing as there was in Google.</li>
<li>The numbers from Bing are much lower than the numbers from Google. So whilst I was still ranking in Bing, it wasn't making up for the loss of traffic from Google. This is probably a reflection of the fact that Google is the dominant search engine.</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="google-analytics">Google Analytics<a href="https://johnnyreilly.com/how-we-fixed-my-seo#google-analytics" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>You might be curious as to what the actual impact of that is on my sites traffic. It's fairly significant; around 80% of my sites traffic comes from search engines. So when my Google SEO tanked, my traffic was significantly (but not terminally) impacted. Consider the graph below from Google Analytics:</p>
<p><img decoding="async" loading="lazy" alt="screenshot of Google Analytics graph showing higher traffic now as compared to earlier" src="https://johnnyreilly.com/assets/images/screenshot-google-analytics-32297924765de274119ee025e907933e.png" width="717" height="418" class="img_ev3q"></p>
<p>It covers a similar time frame to the Google Search Console and ahrefs graphs above. It shows that now, on a weekday (weekends are quieter) I get around <strong>350</strong> unique visitors to my site. Whereas for the comparison period it was more like <strong>100</strong> unique users per day. That's roughly a <strong>3.5x%</strong> increase in traffic; which is not to be sniffed at.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://johnnyreilly.com/how-we-fixed-my-seo#conclusion" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>This is not a post I'd expected to write. SEO used to be something I didn't think about much. But it turns out that a way to get my attention, is taking away my traffic! I'm actually rather grateful that all this happened as it got me to thinking and learning about SEO in a way that I quite enjoyed.</p>
<p>As I say, whilst I can't be certain which of the changes we made made the difference, I'm confident that my site now is better than my site a year ago. It loads faster, it's more performant, it's more structured, it's better linked, it's better optimised. It's better. It looks the part too. I'm really quite proud of it.</p>
<p>I'm also phenomenally grateful to Growtika for their help. I should say that a few others offered pointers and suggestions which I was thankful for. But it was Growtika who stuck by my side for the long haul. For nearly a year they worked with me; and for a long time saw no improvements in my sites traffic at all. They didn't give up. They were patient with me, and they were generous with their time and expertise. I'm very grateful to them for all their help.</p>
<p>If you're looking for help with SEO, I'd recommend you check out <a href="https://growtika.com/" target="_blank" rel="noopener noreferrer">Growtika</a>. They're fantastic folk!</p>]]></content:encoded>
            <category>seo</category>
            <category>docusaurus</category>
            <category>azure static web apps</category>
        </item>
        <item>
            <title><![CDATA[Migrating to v4 Azure Functions Node.js with TypeScript]]></title>
            <link>https://johnnyreilly.com/migrating-azure-functions-node-js-v4-typescript</link>
            <guid>https://johnnyreilly.com/migrating-azure-functions-node-js-v4-typescript</guid>
            <pubDate>Wed, 17 Jan 2024 09:23:27 GMT</pubDate>
            <description><![CDATA[Learn how to migrate a TypeScript Azure Functions app to the v4 Node.js programming model.]]></description>
            <content:encoded><![CDATA[<p>There's a new programming model available for Node.js Azure Functions known as v4. There's documentation out there for <a href="https://learn.microsoft.com/en-us/azure/azure-functions/functions-node-upgrade-v4?tabs=v4" target="_blank" rel="noopener noreferrer">how to migrate JavaScript Azure Functions from v3 to v4</a>, but at the time of writing, TypeScript wasn't covered.</p>
<p>This post fills in the gaps for a TypeScript Azure Function. It's probably worth mentioning that <a href="https://johnnyreilly.com/" target="_blank" rel="noopener noreferrer">my blog</a> is an <a href="https://learn.microsoft.com/en-us/azure/static-web-apps/overview" target="_blank" rel="noopener noreferrer">Azure Static Web App</a> with a TypeScript Node.js Azure Functions back end. So, this post is based on my experience migrating my blog to v4.</p>
<p><img decoding="async" loading="eager" alt="title image reading &amp;quot;Link Azure Application Insights to Static Web Apps with Bicep&amp;quot; with the Bicep and Azure Static Web App logos" src="https://johnnyreilly.com/assets/images/title-image-e16bb3c85ded7aa934b9ef8a41a2541a.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<p>I'm going to walk through the migration of my blog from v3 to v4. This takes place in <a href="https://github.com/johnnyreilly/blog.johnnyreilly.com/pull/728/files" target="_blank" rel="noopener noreferrer">this pull request</a>. I'll probably cover some of the ground of the offical JavaScript upgrade docs, but I'll also cover some of the TypeScript specific stuff.</p>
<p>There will be two main parts to this post:</p>
<ol>
<li>Changes to make to <code>package.json</code></li>
<li>Migrating a Function</li>
</ol>
<p>The second part will be the bulk of the post, but the first part is important too.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-changes-to-make-to-the-packagejson">1. Changes to make to the <code>package.json</code><a href="https://johnnyreilly.com/migrating-azure-functions-node-js-v4-typescript#1-changes-to-make-to-the-packagejson" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>So, starting with the first part, there are three changes to make to the <code>package.json</code>:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> "dependencies": {</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">    "@azure/functions": "^4.0.1",</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> },</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> "devDependencies": {</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token deleted-sign deleted prefix deleted" style="color:rgba(239, 83, 80, 0.56)">-</span><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)">    "@azure/functions": "^3.5.0",</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> },</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">  "main": "dist/src/functions/*/index.js"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol>
<li>Update the <code>@azure/functions</code> dependency to <code>^4.0.1</code> (or later)</li>
<li>The <code>@azure/functions</code> dev dependency becomes a regular dependency - this is because we'll be using the package at runtime now - previously we just used it to get the types at build time</li>
<li>Add a <code>main</code> property to the <code>package.json</code> with a glob that matches the functions in your project; in my case <code>dist/src/functions/*/index.js</code> - which will be our output from the TypeScript build</li>
</ol>
<p>As I took care of <strong>3.</strong>, I found myself changing the folder structure of my functions. Actually, this isn't mandatory, but it was tricky for me to come up with a glob for my current structure. So I moved things around - you may not need to. All that matters is that your glob matches the output of your build.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-migrating-a-function">2. Migrating a Function<a href="https://johnnyreilly.com/migrating-azure-functions-node-js-v4-typescript#2-migrating-a-function" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>In order that we can understand what migration looks like, we must first take a look at the v3 version of a function. Here's the <code>fallback</code> function from my blog:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">type</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> AzureFunction</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> Context</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> HttpRequest </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'@azure/functions'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> redirect </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'./redirect'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> saveToDatabase </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'./saveToDatabase'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> httpTrigger</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token function-variable function" style="color:rgb(250, 208, 0)">AzureFunction</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">function</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  context</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> Context</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  req</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> HttpRequest</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(250, 208, 0)">Promise</span><span class="token operator" style="color:rgb(255, 157, 0)">&lt;</span><span class="token keyword" style="color:rgb(255, 157, 0)">void</span><span class="token operator" style="color:rgb(255, 157, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> originalUrl </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> req</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">headers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'x-ms-original-url'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> status</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> location </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">redirect</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">originalUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">log</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">saveToDatabase</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">originalUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> status</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> location </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">log</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    context</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">res </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      status</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      headers</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        location</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">error</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    context</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">log</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">error</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token string" style="color:rgb(165, 255, 144)">'Problem with fallback'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      error</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      req</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">headers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'x-ms-original-url'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">export</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">default</span><span class="token plain"> httpTrigger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The above is the code I use to power <a href="https://johnnyreilly.com/azure-static-web-apps-dynamic-redirects-azure-functions">dynamic redirects in my Azure Static Web App with the Azure Function back-end</a>. It's a TypeScript Azure Function that takes a request, redirects to a new location and saves metadata about the redirect to a database.</p>
<p>Looking at the code now, I rather think I should have called the function <code>redirect</code> rather than <code>fallback</code>. I'll leave it as is for now, but I'll probably change it in the future.</p>
<p>What the <code>fallback</code> function does isn't significant for this post, but the structure is. Now let's look at the migrated version:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">type</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  HttpRequest</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  HttpResponseInit</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  InvocationContext</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'@azure/functions'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> app </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'@azure/functions'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> redirect </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'./redirect'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> saveToDatabase </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'./saveToDatabase'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">export</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">fallback</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  request</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> HttpRequest</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  context</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> InvocationContext</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(250, 208, 0)">Promise</span><span class="token operator" style="color:rgb(255, 157, 0)">&lt;</span><span class="token plain">HttpResponseInit</span><span class="token operator" style="color:rgb(255, 157, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> originalUrl </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> request</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">headers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">get</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">'x-ms-original-url'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">||</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">''</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> status</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> location </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">redirect</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">originalUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">saveToDatabase</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">originalUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> status</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> location </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      status</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      headers</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        location</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">error</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    context</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">error</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token string" style="color:rgb(165, 255, 144)">'Problem with fallback'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      error</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      request</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">headers</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">get</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">'x-ms-original-url'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      status</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">500</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      body</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'something went wrong'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">http</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">'fallback'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  methods</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'GET'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  handler</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> fallback</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As we can see, the logic looks pretty much the same. But a lot has changed. What's different? We'll go through the changes one by one.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="imports-used"><code>import</code>s used<a href="https://johnnyreilly.com/migrating-azure-functions-node-js-v4-typescript#imports-used" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Starting at the top, the <code>import</code>s we use are different:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted prefix deleted" style="color:rgba(239, 83, 80, 0.56)">-</span><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)">import type { AzureFunction, Context, HttpRequest } from '@azure/functions';</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">import type {</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">  HttpRequest,</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">  HttpResponseInit,</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">  InvocationContext,</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">} from '@azure/functions';</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">import { app } from '@azure/functions';</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We're no longer just importing types, we're importing the <code>app</code> function from <code>@azure/functions</code> also. The types that are being imported are different too. We're no longer importing <code>AzureFunction, Context, HttpRequest</code> - instead we're importing <code>HttpRequest, HttpResponseInit,  InvocationContext</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="hello-app-goodbye-functionjson">Hello <code>app</code>, goodbye <code>function.json</code><a href="https://johnnyreilly.com/migrating-azure-functions-node-js-v4-typescript#hello-app-goodbye-functionjson" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>As we saw, we're making use of the <code>app</code> function from <code>@azure/functions</code>. This is a new function that we use to register our Azure Functions. We no longer use <code>function.json</code>. Instead we use <code>app</code>. In the case of my <code>fallback</code> Azure Functions, we register it like this:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token plain">app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">http</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">'fallback'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  methods</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">'GET'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  handler</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> fallback</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We're registering an HTTP trigger called <code>fallback</code> that responds to <code>GET</code> requests. The <code>handler</code> is the function that will be called when the trigger is invoked. There's more options available, but this is the minimum we need to register our function.</p>
<p>This minimal TypeScript/JavaScript replaces the more verbose <code>function.json</code> that used to sit alongside:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"bindings"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"authLevel"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"anonymous"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"type"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"httpTrigger"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"direction"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"in"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"name"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"req"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"methods"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token string" style="color:rgb(165, 255, 144)">"get"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"post"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"type"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"http"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"direction"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"out"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"name"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"res"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"scriptFile"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"../dist/fallback/index.js"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>All of this is gone, replaced by the <code>app</code> function usage. There's one part of the <code>function.json</code> that isn't covered by the <code>app</code> function, and that's the <code>scriptFile</code> property. This is covered by the <code>main</code> property we added to the <code>package.json</code> earlier.</p>
<p>The rest of the <code>function.json</code> is covered by the <code>app.http</code> call. Much terser.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="signature-and-types-of-our-function">Signature and types of our <code>function</code><a href="https://johnnyreilly.com/migrating-azure-functions-node-js-v4-typescript#signature-and-types-of-our-function" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>The signature of our function has changed too:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted prefix deleted" style="color:rgba(239, 83, 80, 0.56)">-</span><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)">const httpTrigger: AzureFunction = async function (</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)"></span><span class="token deleted-sign deleted prefix deleted" style="color:rgba(239, 83, 80, 0.56)">-</span><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)">  context: Context,</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)"></span><span class="token deleted-sign deleted prefix deleted" style="color:rgba(239, 83, 80, 0.56)">-</span><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)">  req: HttpRequest</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)"></span><span class="token deleted-sign deleted prefix deleted" style="color:rgba(239, 83, 80, 0.56)">-</span><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)">): Promise&lt;void&gt; {</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">export async function fallback(</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">  request: HttpRequest,</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">  context: InvocationContext,</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">): Promise&lt;HttpResponseInit&gt; {</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You'll see here that we're using a function declaration rather than a function expression. Our new function takes our new types, the subtly different <code>HttpRequest</code> and <code>InvocationContext</code>, which are similar to, but different from, the previous <code>Context</code> and <code>HttpRequest</code> types. The order of these parameters has changed also.</p>
<p>The return type of the function is now <code>Promise&lt;HttpResponseInit&gt;</code> rather than <code>Promise&lt;void&gt;</code>. What this means is, we're going to return values from our function, which we didn't do previously. Let's look at the implications of this.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="from-contextres-to-promisehttpresponseinit">From <code>context.res</code> to <code>Promise&lt;HttpResponseInit&gt;</code><a href="https://johnnyreilly.com/migrating-azure-functions-node-js-v4-typescript#from-contextres-to-promisehttpresponseinit" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>With a v3 function, we'd set the <code>context.res</code> property to return values from our function. With a v4 function, we return values from our function directly. What does this look like?</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted prefix deleted" style="color:rgba(239, 83, 80, 0.56)">-</span><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)">    context.res = {</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)"></span><span class="token deleted-sign deleted prefix deleted" style="color:rgba(239, 83, 80, 0.56)">-</span><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)">      status,</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)"></span><span class="token deleted-sign deleted prefix deleted" style="color:rgba(239, 83, 80, 0.56)">-</span><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)">      headers: {</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)"></span><span class="token deleted-sign deleted prefix deleted" style="color:rgba(239, 83, 80, 0.56)">-</span><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)">        location,</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)"></span><span class="token deleted-sign deleted prefix deleted" style="color:rgba(239, 83, 80, 0.56)">-</span><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)">      },</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)"></span><span class="token deleted-sign deleted prefix deleted" style="color:rgba(239, 83, 80, 0.56)">-</span><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)">    };</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">    return {</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">      status,</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">      headers: {</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">        location,</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">      },</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">    };</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>I rather like this change. My reasoning is that, in the event that there is subsequent code that would otherwise run after <code>context.res</code> was set, we no longer need to remember to subsequently <code>return</code> to prevent that running. (And yes, I have made that mistake on multiple occasions.) All we need do is return the value we want to return from our function.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="body---jsonbody"><code>body -&gt; jsonBody</code><a href="https://johnnyreilly.com/migrating-azure-functions-node-js-v4-typescript#body---jsonbody" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Another difference is that we no longer set the <code>body</code> property of the <code>context.res</code>. Instead we return an object with a <code>jsonBody</code> property, assuming we're returning JSON from our API. (And that's the most common case, right?)</p>
<p>This wasn't illustrated in the <code>fallback</code> function above, but here's an example of migrating a function that returns JavaScript object literal named <code>redirectSummary</code>:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted prefix deleted" style="color:rgba(239, 83, 80, 0.56)">-</span><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)">    context.res = {</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)"></span><span class="token deleted-sign deleted prefix deleted" style="color:rgba(239, 83, 80, 0.56)">-</span><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)">      status: 200,</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)"></span><span class="token deleted-sign deleted prefix deleted" style="color:rgba(239, 83, 80, 0.56)">-</span><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)">      body: redirectSummary,</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)"></span><span class="token deleted-sign deleted prefix deleted" style="color:rgba(239, 83, 80, 0.56)">-</span><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)">    };</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">    return {</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">      status: 200,</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">      jsonBody: redirectSummary,</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">    };</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>body</code> property still exists, but it's for returning strings and other things, rather than JSON. If you're returning JSON, the easiest approach is to use the <code>jsonBody</code> property.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="runtime-apis">Runtime APIs<a href="https://johnnyreilly.com/migrating-azure-functions-node-js-v4-typescript#runtime-apis" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Finally, the APIs offered by the <code>request</code> and <code>context</code> objects are different. I shan't go into detail here as it's <a href="https://learn.microsoft.com/en-us/azure/azure-functions/functions-node-upgrade-v4?tabs=v4#review-your-usage-of-http-types" target="_blank" rel="noopener noreferrer">well covered in the official documentation</a>. But I will show you one of the changes I made to my <code>fallback</code> function:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted prefix deleted" style="color:rgba(239, 83, 80, 0.56)">-</span><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)">    const originalUrl = req.headers['x-ms-original-url'];</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">    const originalUrl = request.headers.get('x-ms-original-url') || '';</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Not too significant a tweak, but there's a number of slight changes like this to make. (Related to this, the logging API on the <code>context</code> object is also different - but not significantly.)</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-running-locally">3. Running locally<a href="https://johnnyreilly.com/migrating-azure-functions-node-js-v4-typescript#3-running-locally" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>If you're a fan of running locally then you may need to make this tweak to your <code>host.json</code>:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   "extensionBundle": {</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">       "id": "Microsoft.Azure.Functions.ExtensionBundle",</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token deleted-sign deleted prefix deleted" style="color:rgba(239, 83, 80, 0.56)">-</span><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)">        "version": "[3.*, 4.0.0)"</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">        "version": "[4.*, 5.0.0)"</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>A complete <code>host.json</code> might look like this:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">"version"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"2.0"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">"logging"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">"applicationInsights"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token property" style="color:rgb(255, 157, 0)">"samplingSettings"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token property" style="color:rgb(255, 157, 0)">"isEnabled"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token property" style="color:rgb(255, 157, 0)">"excludedTypes"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Request"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">"extensionBundle"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">"id"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Microsoft.Azure.Functions.ExtensionBundle"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">"version"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"[4.*, 5.0.0)"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As discussed with <a href="https://github.com/ejizba" target="_blank" rel="noopener noreferrer">Eric Jizba</a> on <a href="https://github.com/Azure/azure-functions-core-tools/issues/3508#issuecomment-1894356158" target="_blank" rel="noopener noreferrer">this GitHub issue</a>, updating the <code>host.json</code> may not actually be necessary.  For me it seemed to be the thing that turned a not working setup into a working setup; but it's possible I was mistaken. Certainly if I revert the change now I'm still able to run locally.  What I'm saying is: your mileage may vary.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://johnnyreilly.com/migrating-azure-functions-node-js-v4-typescript#conclusion" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Migrating an Azure Function from v3 to v4 with TypeScript is a little more involved than I'd expected. But I do like that this moves us to a code style that feels more "Node-y". <del>The official documentation is good, but it's not complete right now.</del> There's now a decent upgrade guide available: <a href="https://learn.microsoft.com/en-us/azure/azure-functions/functions-node-upgrade-v4?tabs=v4" target="_blank" rel="noopener noreferrer">https://learn.microsoft.com/en-us/azure/azure-functions/functions-node-upgrade-v4?tabs=v4</a></p>
<p>Hopefully this post will help you migrate your TypeScript Azure Functions to v4.</p>]]></content:encoded>
            <category>typescript</category>
            <category>azure</category>
            <category>azure functions</category>
            <category>azure static web apps</category>
        </item>
        <item>
            <title><![CDATA[Bicep: Link Azure Application Insights to Static Web Apps]]></title>
            <link>https://johnnyreilly.com/bicep-link-azure-application-insights-to-static-web-apps</link>
            <guid>https://johnnyreilly.com/bicep-link-azure-application-insights-to-static-web-apps</guid>
            <pubDate>Tue, 17 Oct 2023 19:35:54 GMT</pubDate>
            <description><![CDATA[Learn how to link Azure Application Insights to an Azure Static Web App using Bicep.]]></description>
            <content:encoded><![CDATA[<p>If you're looking into a Production issue with your Azure Static Web App, you'll want to be able to get to your logs as fast as possible. You can do this by linking your Static Web App to an Azure Application Insights instance. If you've used the Azure Portal to create your Static Web App, the setup phase will likely have done this for you already. But if you're using Bicep to create your Static Web App, you'll need to do this yourself.</p>
<p>This post will show you how to do that using Bicep.</p>
<p><img decoding="async" loading="eager" alt="title image reading &amp;quot;Link Azure Application Insights to Static Web Apps with Bicep&amp;quot; with the Bicep and Azure Static Web App logos" src="https://johnnyreilly.com/assets/images/title-image-bd6790656cd89e64fd25edbe986a6759.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="a-linked-azure-application-insights-instance">A linked Azure Application Insights instance<a href="https://johnnyreilly.com/bicep-link-azure-application-insights-to-static-web-apps#a-linked-azure-application-insights-instance" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>What we want to achieve can be summmed up by this screenshot:</p>
<p><img decoding="async" loading="lazy" alt="screenshot of the Azure Portal displaying the App Insights tab of a Static Web App, with a linked App Insights in view" src="https://johnnyreilly.com/assets/images/screenshot-azure-portal-open-in-application-insights-3bebf715a5d08241d7e350bb8915b347.png" width="919" height="464" class="img_ev3q"></p>
<p>Inside the Azure Portal, inside our Static Web App, we want to see the App Insights tab and we want to see a linked App Insights instance. We do. But how?</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="bicep-linking">Bicep linking<a href="https://johnnyreilly.com/bicep-link-azure-application-insights-to-static-web-apps#bicep-linking" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>The Bicep code to achieve this is pretty simple:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockTitle_Ktv7">static-web-app.bicep</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> tagsWithHiddenLinks </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">union</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">'hidden-link: /app-insights-resource-id'</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> appInsightsId</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">'hidden-link: /app-insights-instrumentation-key'</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> appInsightsInstrumentationKey</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">'hidden-link: /app-insights-conn-string'</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> appInsightsConnectionString</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> tags</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> staticWebApp </span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.Web/staticSites@2022-09-01'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> staticWebAppName</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">location</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">tags</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> tagsWithHiddenLinks </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// &lt;--- here</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">sku</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'Free'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">tier</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'Free'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">properties</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">repositoryUrl</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'https://github.com/johnnyreilly/blog.johnnyreilly.com'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">repositoryToken</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> repositoryToken</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">branch</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> branch</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">provider</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'GitHub'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">stagingEnvironmentPolicy</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'Enabled'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">allowConfigFileUpdates</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">buildProperties</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">skipGithubActionWorkflowGeneration</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Consider the code above; it's a fairly standard Bicep resource declaration for a Static Web App. The only difference is the <code>tags</code> property. We're using the <code>union</code> function to add three additional tags to the <code>tags</code> property that has been passed into the <code>static-web-app.bicep</code> module. These tags are the <code>hidden-link</code> tags that link the Static Web App to the App Insights instance.</p>
<p>Luke Murray has a great post on <a href="https://luke.geek.nz/azure/hidden-tags-in-azure/" target="_blank" rel="noopener noreferrer"><code>hidden-</code> tags in Azure</a> that I recommend you read if you want to know more about them. Essentially, hidden tags are tags that don't show up in the Azure Portal and have some metadata purpose. <code>hidden-link</code> tags are a subset of those that are used to link resources together.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="where-would-you-get-the-values-for-the-hidden-link-tags">Where would you get the values for the <code>hidden-link</code> tags?<a href="https://johnnyreilly.com/bicep-link-azure-application-insights-to-static-web-apps#where-would-you-get-the-values-for-the-hidden-link-tags" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>In the case of the <code>hidden-link</code> tags we're using here, we need to know the <code>id</code>, <code>InstrumentationKey</code> and <code>ConnectionString</code> of the App Insights instance we want to link to. We can get these values from the App Insights instance itself. Because of the way Bicep works, it's necessary to get those in a parent module to the Static Web App module. Here's an example:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> appInsightsResource </span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.Insights/components@2020-02-02'</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">existing</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> appInsightsName</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">module</span><span class="token plain"> staticWebApp </span><span class="token string" style="color:rgb(165, 255, 144)">'./static-web-app.bicep'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">'</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token interpolated-string interpolation expression function" style="color:rgb(250, 208, 0)">deployment</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolated-string interpolation expression">name</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolated-string string" style="color:rgb(165, 255, 144)">-staticWebApp'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">params</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">appInsightsId</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> appInsightsResource</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">id</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">appInsightsConnectionString</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> appInsightsResource</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">ConnectionString</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">appInsightsInstrumentationKey</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> appInsightsResource</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">InstrumentationKey</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="https://johnnyreilly.com/bicep-link-azure-application-insights-to-static-web-apps#summary" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>With this is place we have the linking we need to get to our logs quickly as we navigate around inside the Azure Portal. And we have it in place in a way that's repeatable and consistent. I hope you find this useful.</p>]]></content:encoded>
            <category>azure</category>
            <category>bicep</category>
            <category>azure static web apps</category>
        </item>
        <item>
            <title><![CDATA[Serialising ASP.NET method calls for later execution]]></title>
            <link>https://johnnyreilly.com/serialising-aspnet-method-calls-for-later-execution</link>
            <guid>https://johnnyreilly.com/serialising-aspnet-method-calls-for-later-execution</guid>
            <pubDate>Tue, 14 May 2024 07:35:48 GMT</pubDate>
            <description><![CDATA[How can we take a method call, serialise it, perhaps store it in a database, and then later rehydrate and execute?]]></description>
            <content:encoded><![CDATA[<p>Let's start with "why". Imagine you have an operation that you'd like to perform, but before that operation is performed, some other things need to take place first. Maybe it needs to be approved by someone, maybe you need an explicit record of what method is to be executed.</p>
<p>Now you could build a mechanism to manually cater for each scenario that triggered a method call. But that's a lot of boilerplate code for each implementation, and given we might want to cater for many scenarios, it wouldn't scale particularly well as an approach.</p>
<p>So how can we take a method call, serialise it, perhaps store it in a database, and then later rehydrate and execute?</p>
<p><img decoding="async" loading="eager" alt="title image reading &amp;quot;Serialising ASP.NET method calls for later execution&amp;quot; with the C# logo" src="https://johnnyreilly.com/assets/images/title-image-0c2344bb797a565a0d579f3ef0c011c3.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-does-serialising-our-method-call-require">What does serialising our method call require?<a href="https://johnnyreilly.com/serialising-aspnet-method-calls-for-later-execution#what-does-serialising-our-method-call-require" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>To serialise a method call, what do we need to store? Three things:</p>
<ol>
<li>The type of object that contains the method we want to subsequently invoke</li>
<li>The method on that object</li>
<li>The parameter values that will be passed to the method when it is called</li>
</ol>
<p>Pretty simple, right? It's worth highlighting that there is an underlying assumption for this approach:</p>
<p><strong>The method call does not depend on the object being in a specific state for the operation to succeed.</strong></p>
<p>So if, before calling a method on that object, you need to call another method called <code>OpenConnection</code> (for example) then this approach would not work. Likewise if subsequent cleanup is required after a method is called, this approach would not work.</p>
<p>The analogy may not be entirely accurate, but think of each method call as needing to be an atomic operation and you're probably heading in the right direction.</p>
<p>How then, can we serialise our method call?</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-do-we-serialise-our-method-call">How do we serialise our method call?<a href="https://johnnyreilly.com/serialising-aspnet-method-calls-for-later-execution#how-do-we-serialise-our-method-call" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>First of all, we need a data structure to store the information we need. We could use a <code>record</code> like this:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">record</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">MethodCall</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> ServiceName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> MethodName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">object</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> Parameters</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This record will store the name of the service, the name of the method, and the parameters that will be passed to the method when it is called.</p>
<p>Next we need an example service that we can call. For instance:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">interface</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">IOurService</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Task</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token return-type class-name keyword" style="color:rgb(255, 157, 0)">bool</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">DoAThing</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">decimal</span><span class="token plain"> amount</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">bool</span><span class="token plain"> isApproved</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>An implementation of this service would be registered with the DI container when the application starts up. We don't need to know anything about the implementation of the service, just that it exists and that we can call methods on it.</p>
<p>If we consider a call to this method, it might look like this:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token plain">IOurService</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">DoAThing</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"the name"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">100m</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The above can be represented as a <code>MethodCall</code> like this:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token class-name" style="color:rgb(250, 208, 0)">MethodCall</span><span class="token plain"> methodCall </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">ServiceName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">typeof</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token type-expression class-name" style="color:rgb(250, 208, 0)">IOurService</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">FullName </span><span class="token operator" style="color:rgb(255, 157, 0)">??</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">throw</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">InvalidOperationException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"Service name cannot be null"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">MethodName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">IOurService</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">DoAThing</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">Parameters</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"the name"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">100m</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>I'm not going to do so in this post, but the <code>MethodCall</code> could be stored in a database. This is powerful because it means that we can store the method call, and then later rehydrate it and execute it.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-do-we-deserialise-our-method-call-and-execute-it">How do we deserialise our method call and execute it?<a href="https://johnnyreilly.com/serialising-aspnet-method-calls-for-later-execution#how-do-we-deserialise-our-method-call-and-execute-it" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Now that we've looked at how to serialise a method call, let's look at how we can deserialise and execute it. We need a class that can take a <code>MethodCall</code> and execute it. Herewith the <code>MethodCallInvoker</code> class that does just that:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">MethodCallInvoker</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name" style="color:rgb(250, 208, 0)">IServiceProvider</span><span class="token plain"> serviceProvider</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name" style="color:rgb(250, 208, 0)">MethodCall</span><span class="token plain"> operation</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Task</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token return-type class-name keyword" style="color:rgb(255, 157, 0)">object</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">InvokeAsync</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">Type</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> serviceType </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> Type</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetType</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">ServiceName </span><span class="token operator" style="color:rgb(255, 157, 0)">??</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">throw</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">InvalidOperationException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"Service name cannot be null"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">object</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> service </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> serviceProvider</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetService</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">serviceType </span><span class="token operator" style="color:rgb(255, 157, 0)">??</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">throw</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">InvalidOperationException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"Service type cannot be null"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">MethodInfo</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> serviceMethod </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> serviceType</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetMethod</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">MethodName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">??</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">throw</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">InvalidOperationException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"Method info cannot be null"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">List</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">object</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> parameters </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">ParameterInfo</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> requiredParameters </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> serviceMethod</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetParameters</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">for</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">int</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">0</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(255, 157, 0)">&lt;</span><span class="token plain"> requiredParameters</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"> i</span><span class="token operator" style="color:rgb(255, 157, 0)">++</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token class-name" style="color:rgb(250, 208, 0)">ParameterInfo</span><span class="token plain"> requiredParameter </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> requiredParameters</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">object</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> suppliedParameter </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> operation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Parameters</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">bool</span><span class="token plain"> suppliedValueIsOfCorrectType </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> requiredParameter</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">ParameterType </span><span class="token operator" style="color:rgb(255, 157, 0)">==</span><span class="token plain"> suppliedParameter</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetType</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">suppliedValueIsOfCorrectType</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                parameters</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Add</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Parameters</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// Convert.ChangeType is used to convert the supplied parameter to the required type eg from double to decimal</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                parameters</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Add</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">Convert</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">ChangeType</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">suppliedParameter</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> requiredParameter</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">ParameterType</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> CultureInfo</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">InvariantCulture</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name" style="color:rgb(250, 208, 0)">Task</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> task </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">Task</span><span class="token punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain">serviceMethod</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Invoke</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">service</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token range operator" style="color:rgb(255, 157, 0)">..</span><span class="token plain">parameters</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">??</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">throw</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">InvalidOperationException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Method </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">operation</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">MethodName</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> did not return a task"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> task</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">object</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> result </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">task</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetType</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">IsGenericType </span><span class="token operator" style="color:rgb(255, 157, 0)">&amp;&amp;</span><span class="token plain"> task</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetType</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetGenericTypeDefinition</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">==</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">typeof</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token type-expression class-name" style="color:rgb(250, 208, 0)">Task</span><span class="token type-expression class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token type-expression class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// Get the result using reflection</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token class-name" style="color:rgb(250, 208, 0)">PropertyInfo</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> resultProperty </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> task</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetType</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetProperty</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"Result"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            result </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> resultProperty</span><span class="token punctuation" style="color:rgb(255, 255, 255)">?.</span><span class="token function" style="color:rgb(250, 208, 0)">GetValue</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">task</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> result</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>MethodCallInvoker</code> class takes an <code>IServiceProvider</code> and a <code>MethodCall</code> in its constructor. Remember that the <code>IServiceProvider</code> can be used to get a service that has been registered with the DI container. By giving the <code>MethodCallInvoker</code> the <code>IServiceProvider</code>, we can get the service that we need to call the method on. The <code>InvokeAsync</code> method uses reflection to get the service, and the method that needs to be called.</p>
<p>We then do some more reflection gymnastics to ensure that the parameters that are passed to the method are of the correct type. When it deserialises the parameters, the converter will make a best guess on the types of the parameters. If a parameter is not of the correct type, it uses <code>Convert.ChangeType</code> to convert the parameter to the correct type. The canonical example of this is converting a <code>double</code> to a <code>decimal</code>.</p>
<p>With all this done, the <code>MethodCallInvoker</code> is ready to call the method. Because it's likely that the method being invoked will be an <code>async</code> method, we expect them to return a <code>Task</code>. It's possible there may be a value returned as well, and if there is we unwrap it from the <code>Task</code> and return it.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-do-we-use-the-methodcallinvoker">How do we use the <code>MethodCallInvoker</code>?<a href="https://johnnyreilly.com/serialising-aspnet-method-calls-for-later-execution#how-do-we-use-the-methodcallinvoker" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Let's do an end to end demonstration of how to serialise a method call, deserialise it and execute it. Here's how you can do it:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token class-name" style="color:rgb(250, 208, 0)">MethodCall</span><span class="token plain"> methodCall </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">ServiceName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">typeof</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token type-expression class-name" style="color:rgb(250, 208, 0)">IOurService</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">FullName </span><span class="token operator" style="color:rgb(255, 157, 0)">??</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">throw</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">InvalidOperationException</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"Service name cannot be null"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">MethodName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">IOurService</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">DoAThing</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">Parameters</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"the name"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">100m</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> json </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> Newtonsoft</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Json</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">JsonConvert</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">SerializeObject</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">methodCall</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token class-name" style="color:rgb(250, 208, 0)">MethodCall</span><span class="token plain"> deserialized </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> Newtonsoft</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Json</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">JsonConvert</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token generic-method function" style="color:rgb(250, 208, 0)">DeserializeObject</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)">MethodCall</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">json</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">??</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">throw</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"Problem deserializing"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">object</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> result </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">MethodCallInvoker</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">_serviceProvider</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> deserialized</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">InvokeAsync</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The above code serialises the <code>MethodCall</code> to a JSON string, deserialises it back to a <code>MethodCall</code>, and then uses the <code>MethodCallInvoker</code> to execute the method.</p>
<p>Why are we using <code>Newtonsoft.Json</code> for our serialisation / deserialisation in this example? We don't have to, but let's say we're persisting this method call to a Cosmos DB, Cosmos uses JSON.NET for JSON handling. So this somewhat simulates what would happen during a potential persistence to a Cosmos container / subsequent loading from a Cosmos container. Otherwise I'd likely use <code>System.Text.Json</code>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://johnnyreilly.com/serialising-aspnet-method-calls-for-later-execution#conclusion" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>In this post, we've looked at how we can serialise a method call (which could be stored in a database), and then later rehydrate and execute it. We've seen how we can use reflection to get the service and method that we need to call, and how we can convert the parameters to the correct type.</p>]]></content:encoded>
            <category>azure</category>
            <category>c#</category>
        </item>
        <item>
            <title><![CDATA[Multiline strings in .env files]]></title>
            <link>https://johnnyreilly.com/multiline-strings-dot-env-files</link>
            <guid>https://johnnyreilly.com/multiline-strings-dot-env-files</guid>
            <pubDate>Tue, 12 Mar 2024 14:13:40 GMT</pubDate>
            <description><![CDATA[Learn how to use multiline strings in .env files.]]></description>
            <content:encoded><![CDATA[<p>I love using <code>.env</code> files to configure my applications. They're a great way to keep configuration in one place and to keep it out of the codebase. They're also a great way to keep secrets out of the codebase.</p>
<p>But what if you need to use a multiline string in a <code>.env</code> file? How do you do that? You just do it:</p>
<div class="language-env codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-env codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token plain">SINGLE_LINE="you know what..."</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">MULTI_LINE="you know what you did</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">LAST SUMMER"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>That's right, you just use a newline character. It's that simple. Oddly, searching for that on the internet didn't yield the answer I was looking for. So I'm writing it down here for posterity.</p>
<p>With your <code>.env</code> file in place, you can then consume it in your application using a package like <a href="https://www.npmjs.com/package/dotenv" target="_blank" rel="noopener noreferrer"><code>dotenv</code></a>. Or if you'd like to use a bash script to consume the <code>.env</code> file, you can do it like this:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token shebang important">#!/usr/bin/env bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(250, 208, 0)">set</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(255, 238, 128)">-a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(250, 208, 0)">source</span><span class="token plain"> test.env</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(250, 208, 0)">set</span><span class="token plain"> +a</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token function" style="color:rgb(250, 208, 0)">npm</span><span class="token plain"> run start </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># or whatever you need to do</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <category>node.js</category>
        </item>
        <item>
            <title><![CDATA[Azure Cosmos DB: container items and generics]]></title>
            <link>https://johnnyreilly.com/azure-cosmosdb-container-item-generics</link>
            <guid>https://johnnyreilly.com/azure-cosmosdb-container-item-generics</guid>
            <pubDate>Thu, 11 Apr 2024 14:31:06 GMT</pubDate>
            <description><![CDATA[Learn how to use generics to store and retrieve different types of object in an Azure Cosmos DB Container. And how to deserialize the data property into a C# object of a specific type.]]></description>
            <content:encoded><![CDATA[<p>Cosmos DB is a great database for storing objects. But what if you want to store subtly different types of object in the same container? This post demonstrates how you can use generics to store and retrieve different types of object in an Azure Cosmos DB Container using C#.</p>
<p><img decoding="async" loading="eager" alt="title image reading &amp;quot;Azure Cosmos DB: container items and generics&amp;quot; with the Cosmos DB logo" src="https://johnnyreilly.com/assets/images/title-image-41b07cf9d68421ae65ff7cc2350c46f2.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-problem">The problem<a href="https://johnnyreilly.com/azure-cosmosdb-container-item-generics#the-problem" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>The situation I have in mind isn't entirely different types of object. Rather, it's a standard type of object with a single property that can be of different types. Consider the following record:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"id"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"overview"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"itemName"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"vw-beetle"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"type"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"car"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"data"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">"Wheels"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">4</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">"Colour"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"blue"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"createdAt"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"2024-03-28T10:55:57.860484+00:00"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"createdBy"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"john.reilly"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"updatedAt"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"2024-03-28T14:31:37.9882095+00:00"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"updatedBy"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"john.reilly"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"_rid"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"NisFAIjrg3wFAAAAAAAAAA=="</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"_self"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"dbs/NisFAA==/colls/NisFAIjrg3w=/docs/NisFAIjrg3wFAAAAAAAAAA==/"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"_etag"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"\"bd005ad6-0000-0c00-0000-66057f4a0000\""</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"_attachments"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"attachments/"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"_ts"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">1711636298</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>data</code> property is a JSON object that can be of any shape. In this case, it's a car with four wheels and a blue colour. But it could just as easily be a house with a number of rooms and a garden. Or a person with a name and an age. Or a book with a title and an author. You get the idea.</p>
<p>How can we store and retrieve these objects in a Cosmos DB container with C#?</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="a-generic-solution">A generic solution<a href="https://johnnyreilly.com/azure-cosmosdb-container-item-generics#a-generic-solution" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>The answer is to use generics. Here's the <code>MyItem</code> record that we're using in the above code:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockTitle_Ktv7">MyItem.cs</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">namespace</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">ContainerApp</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Model</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Database</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token preprocessor property" style="color:rgb(255, 157, 0)">#</span><span class="token preprocessor property directive keyword" style="color:rgb(255, 157, 0)">pragma</span><span class="token preprocessor property" style="color:rgb(255, 157, 0)"> warning disable IDE1006</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">record</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">MyItem</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> id</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">/// &lt;summary&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">/// This is the partition key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">/// &lt;/summary&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> itemName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> type</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name" style="color:rgb(250, 208, 0)">DateTimeOffset</span><span class="token plain"> createdAt</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> createdBy</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name" style="color:rgb(250, 208, 0)">DateTimeOffset</span><span class="token plain"> updatedAt</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> updatedBy</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token generic-method function" style="color:rgb(250, 208, 0)">MyItem</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name keyword" style="color:rgb(255, 157, 0)">object</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">id</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> creditReviewPackName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> itemName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> type</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> createdAt</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> createdBy</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> updatedAt</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> updatedBy</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">record</span><span class="token plain"> </span><span class="token generic-method function" style="color:rgb(250, 208, 0)">MyItem</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)">TData</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> id</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">/// &lt;summary&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">/// This is the partition key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">/// &lt;/summary&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> itemName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> type</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name" style="color:rgb(250, 208, 0)">TData</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> data</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name" style="color:rgb(250, 208, 0)">DateTimeOffset</span><span class="token plain"> createdAt</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> createdBy</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name" style="color:rgb(250, 208, 0)">DateTimeOffset</span><span class="token plain"> updatedAt</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> updatedBy</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token preprocessor property" style="color:rgb(255, 157, 0)">#</span><span class="token preprocessor property directive keyword" style="color:rgb(255, 157, 0)">pragma</span><span class="token preprocessor property" style="color:rgb(255, 157, 0)"> warning restore IDE1006</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>MyItem</code> record is a generic record with a single type parameter <code>TData</code>. The first record is a convenience record that uses <code>object</code> as the type parameter. This is the record that we'll use when we're writing a record that does not have a <code>data</code> property, or when we're reading a record and we don't initially care about the <code>data</code> property.</p>
<p>The <code>type</code> field represents the type of <code>data</code>. This is a string that can be used to distinguish between different types of object. In the example above, the type is "car". In other examples, the type might be "house", "person", or "book". We can use this in future to filter the data by type and to deserialize the <code>data</code> property into the correct C# type; for instance <code>Car</code>. We just need to know how the <code>type</code> string maps to a particular C# type.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="writing-to-and-reading-from-the-cosmos-db-container">Writing to and reading from the Cosmos DB container<a href="https://johnnyreilly.com/azure-cosmosdb-container-item-generics#writing-to-and-reading-from-the-cosmos-db-container" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>In the <code>DatabaseMyItemService</code> class, we have methods to write to and read from the Cosmos DB container:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockTitle_Ktv7">DatabaseMyItemService.cs</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">System</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Net</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Microsoft</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Azure</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Cosmos</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">ContainerApp</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Model</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Database</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">ContainerApp</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Utilities</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">namespace</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">ContainerApp</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">DatabaseMyItemService</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token type-list class-name" style="color:rgb(250, 208, 0)">IDatabaseMyItemService</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> DatabaseName </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"my-database"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> ContainerNameMyItems </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"my-items"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">CosmosClient</span><span class="token plain"> _client</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">DatabaseMyItemService</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">DatabaseMyItemService</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">DatabaseMyItemService</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">AppSettings</span><span class="token plain"> appSettings</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _client </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">CosmosClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">connectionString</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> appSettings</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">CosmosConnectionString</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _logger </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Task</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">MyItem</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">TData</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> </span><span class="token generic-method function" style="color:rgb(250, 208, 0)">UpsertItem</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)">TData</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">MyItem</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">TData</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> myItem</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">try</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogInformation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Upserting </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">MyItem</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> with </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">myItem</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">itemName</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">: {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">myItem</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">itemName</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}}"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> myItem</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">itemName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> container </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> _client</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetDatabase</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">DatabaseName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetContainer</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">ContainerNameMyItems</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token class-name" style="color:rgb(250, 208, 0)">MyItem</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">TData</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> savedItem </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> container</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">UpsertItemAsync</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">myItem</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">PartitionKey</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">myItem</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">itemName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> savedItem</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">CosmosException</span><span class="token plain"> ex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogError</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">ex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Problem upserting </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">MyItem</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> with </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">myItem</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">itemName</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">: {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">myItem</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">itemName</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}}"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> myItem</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">itemName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">throw</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Problem upserting </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">MyItem</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> with </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">myItem</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">itemName</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">: </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">myItem</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token interpolation-string interpolation expression language-csharp">itemName</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> ex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Task</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">MyItem</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">TData</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> </span><span class="token generic-method function" style="color:rgb(250, 208, 0)">GetItem</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)">TData</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> itemName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">try</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogInformation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Looking up </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">MyItem</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)"> with </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">itemName</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">: {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">itemName</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}}"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> itemName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> container </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> _client</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetDatabase</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">DatabaseName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetContainer</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">ContainerNameMyItems</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// In this simplified example we're intentionally using id as partition key - https://stackoverflow.com/questions/54636852/implications-of-using-id-for-the-partition-key-in-cosmosdb</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token class-name" style="color:rgb(250, 208, 0)">MyItem</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">TData</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> myItem </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> container</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token generic-method function" style="color:rgb(250, 208, 0)">ReadItemAsync</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)">MyItem</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)">TData</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">itemName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">PartitionKey</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">itemName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> myItem</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">CosmosException</span><span class="token plain"> ex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">when</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">ex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">StatusCode </span><span class="token operator" style="color:rgb(255, 157, 0)">==</span><span class="token plain"> HttpStatusCode</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">NotFound</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Task</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">List</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">MyItem</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">GetItems</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> itemName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">try</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogInformation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Looking up </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">MyItem</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">s by </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">itemName</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">: {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">itemName</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}}"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> itemName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> container </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> _client</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetDatabase</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">DatabaseName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetContainer</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">ContainerNameMyItems</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token class-name" style="color:rgb(250, 208, 0)">List</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">MyItem</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> myItems </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> container</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token generic-method function" style="color:rgb(250, 208, 0)">GetItemQueryIterator</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)">MyItem</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">QueryDefinition</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                    </span><span class="token string" style="color:rgb(165, 255, 144)">"SELECT * FROM c WHERE c.itemName = @itemName"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">WithParameter</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"@itemName"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> itemName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">ReadAllToListAsync</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> myItems</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">CosmosException</span><span class="token plain"> ex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            _logger</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogError</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">ex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Problem getting </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">MyItem</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">s by </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">itemName</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">: {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">itemName</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}}"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> itemName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token keyword" style="color:rgb(255, 157, 0)">throw</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Problem getting </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">MyItem</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">s by </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">itemName</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">: </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">itemName</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> ex</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You'll note that the <code>UpsertItem</code> and <code>GetItem</code> methods are generic methods that take and return a <code>MyItem&lt;TData&gt;</code> record respectively. The <code>GetItems</code> method is not generic because it returns a list of <code>MyItem</code> records, which are the non-generic records; where <code>data</code> is of type <code>object?</code>.</p>
<p>Imagine, you might use the <code>GetItems</code> method to get all the items. If you wanted to load a particular item, in a strongly typed fashion, you might subsequently use the <code>GetItem</code> method to load a single item with a particular type, like so:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> myCar </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> _databaseMyItemService</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token generic-method function" style="color:rgb(250, 208, 0)">GetItem</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)">Car</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"the-car"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="deserializing-the-data-property-with-jsonnet">Deserializing the <code>data</code> property with <code>JSON.NET</code><a href="https://johnnyreilly.com/azure-cosmosdb-container-item-generics#deserializing-the-data-property-with-jsonnet" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>If you want to avoid requerying the database to get the object in strongly typed form, you'll need to convert the <code>data</code> property into a C# object of a specific type. If you've retrieved the non-generic <code>MyItem</code> from Cosmos, as far as C# is concerned, the <code>data</code> property is just an <code>object?</code> at this point. Well, that's not quite true. It's actually a <code>JObject</code> from the <code>Newtonsoft.Json</code> library. (This is because the Cosmos DB SDK uses <code>Newtonsoft.Json</code> internally.)</p>
<p>You can use <code>JObject.ToObject&lt;T&gt;()</code> to convert the <code>data</code> property into a C# object of a specific type. Here's an example of how you might do this:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> data </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> item</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">data </span><span class="token keyword" style="color:rgb(255, 157, 0)">is</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">not</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">Newtonsoft</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token class-name" style="color:rgb(250, 208, 0)">Json</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token class-name" style="color:rgb(250, 208, 0)">Linq</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token class-name" style="color:rgb(250, 208, 0)">JObject</span><span class="token plain"> dataJObject</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> dataJObject</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token generic-method function" style="color:rgb(250, 208, 0)">ToObject</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)">Car</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="deserializing-the-data-property-with-systemtextjson">Deserializing the <code>data</code> property with <code>System.Text.Json</code><a href="https://johnnyreilly.com/azure-cosmosdb-container-item-generics#deserializing-the-data-property-with-systemtextjson" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>You may well find yourself wanting to send a list of items to the front end. However, because the default serializer of ASP.NET is <code>System.Text.Json.JsonSerializer</code> you'll need a different approach to deal with the <code>JObject</code>, as you can't send a <code>JObject</code> to the front end. You need to deserialize it into a format that can be sent to the front end.</p>
<p>It's quite typical to have a method that converts a domain model to a view model; something like this:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">record</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">MyItemViewModel</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> ItemName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> Type</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">object</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> Data</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name" style="color:rgb(250, 208, 0)">DateTimeOffset</span><span class="token plain"> CreatedAt</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> CreatedBy</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name" style="color:rgb(250, 208, 0)">DateTimeOffset</span><span class="token plain"> UpdatedAt</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> UpdatedBy</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here's an example of how you might convert our domain model to our view model. It includes a mechanism that uses <code>System.Text.Json.JsonSerializer</code> to deserialize the <code>data</code> property into an <code>object?</code> that <strong>can</strong> be sent to the front end:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">static</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">MyItemViewModel</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">ItemToItemViewModel</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">MyItem</span><span class="token plain"> item</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> data </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> creditReviewPackItem</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">data </span><span class="token keyword" style="color:rgb(255, 157, 0)">switch</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Newtonsoft</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Json</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Linq</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">JObject</span><span class="token plain"> dataJObject </span><span class="token operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> System</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Text</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Json</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">JsonSerializer</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token generic-method function" style="color:rgb(250, 208, 0)">Deserialize</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name keyword" style="color:rgb(255, 157, 0)">object</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">dataJObject</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">ToString</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Newtonsoft</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Json</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Linq</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">JArray</span><span class="token plain"> dataJArray </span><span class="token operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> System</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Text</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Json</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">JsonSerializer</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token generic-method function" style="color:rgb(250, 208, 0)">Deserialize</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name keyword" style="color:rgb(255, 157, 0)">object</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">dataJArray</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">ToString</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _ </span><span class="token operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">ItemName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> item</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">itemName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">Type</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> item</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">type</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">Data</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> data</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">CreatedAt</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> item</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">createdAt</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">CreatedBy</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> item</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">createdBy</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">UpdatedAt</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> item</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">updatedAt</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">UpdatedBy</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> item</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">updatedBy</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://johnnyreilly.com/azure-cosmosdb-container-item-generics#conclusion" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>In this post, we've seen how you can use generics to store and retrieve different types of object in an Azure Cosmos DB Container using C#. We've seen how you can use a generic record to store objects with a single property that can be of different types. We've also seen how you can use <code>Newtonsoft.Json</code> to deserialize the <code>data</code> property into a C# object of a specific type. And we've seen how you can use <code>System.Text.Json</code> to deserialize the <code>data</code> property into an <code>object?</code> that can be sent to the front end.</p>]]></content:encoded>
            <category>azure</category>
            <category>c#</category>
        </item>
        <item>
            <title><![CDATA[Using Bun in Azure Pipelines]]></title>
            <link>https://johnnyreilly.com/using-bun-in-azure-pipelines</link>
            <guid>https://johnnyreilly.com/using-bun-in-azure-pipelines</guid>
            <pubDate>Sun, 11 Feb 2024 09:36:05 GMT</pubDate>
            <description><![CDATA[Bun is a fast JavaScript runtime which can be used to speed up the TypeScript / JavaScript you have. This post shows you how to use it in Azure Pipelines.]]></description>
            <content:encoded><![CDATA[<p>I'm a keen user of <a href="https://bun.sh/" target="_blank" rel="noopener noreferrer">Bun</a>. Bun is a fast TypeScript / JavaScript runtime which can be used to speed up the TypeScript / JavaScript you have. It's a drop-in replacement for Node.js, and it's compatible with the vast majority of the Node.js ecosystem. (There are still rough edges that have issues.) In this post we'll look at how to use it in Azure Pipelines.</p>
<p><img decoding="async" loading="eager" alt="title image reading &amp;quot;Using Bun in Azure Pipelines&amp;quot; with the Bun and Azure Pipelines logos" src="https://johnnyreilly.com/assets/images/title-image-f250426e35ebb5d60e203b601cae0039.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-install-bun">How to install Bun<a href="https://johnnyreilly.com/using-bun-in-azure-pipelines#how-to-install-bun" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>I use Azure Pipelines for much of my day to day work. However, my OSS work is (unsurprisingly) all GitHub oriented. Using Bun in GitHub Actions is straightforward; you just make use of the <a href="https://github.com/marketplace/actions/setup-bun" target="_blank" rel="noopener noreferrer">Setup Bun GitHub Action</a> to install Bun and you're off to the races. There isn't an equivalent for Azure Pipelines <strong>but that doesn't matter</strong>.</p>
<p>It turns out there's a great variety of <a href="https://bun.sh/docs/installation" target="_blank" rel="noopener noreferrer">ways to install Bun</a>. However the simplest of the lot is to install it via npm, like so:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token function" style="color:rgb(250, 208, 0)">npm</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">install</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(255, 238, 128)">-g</span><span class="token plain"> bun</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This installs the <code>bun</code> command globally from the <a href="https://www.npmjs.com/package/bun" target="_blank" rel="noopener noreferrer"><code>bun</code> package</a>. You can then use it to run your TypeScript / JavaScript. This is the approach we'll use in Azure Pipelines.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-bun-in-azure-pipelines">Using Bun in Azure Pipelines<a href="https://johnnyreilly.com/using-bun-in-azure-pipelines#using-bun-in-azure-pipelines" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Since there's already a <a href="https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/npm-v1?view=azure-pipelines" target="_blank" rel="noopener noreferrer">dedicated Azure Pipelines task for npm</a>, we can use that to install Bun. Here's an example of how to do that:</p>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Npm@1</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> setup bun</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">command</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'custom'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">customCommand</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'install -g bun'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">verbose</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 98, 140)">true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now we're able to use Bun in our Azure Pipelines. Here's an example of how to use it to install dependencies and run a build:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">bash</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> bun install</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'install'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">bash</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> bun run build</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'build'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="https://johnnyreilly.com/using-bun-in-azure-pipelines#summary" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>We're able to use Bun in Azure Pipelines by installing it via npm and then using it as we would Node.js. This is a great way to speed up your TypeScript / JavaScript builds. I hope you find it useful!</p>]]></content:encoded>
            <category>bun</category>
            <category>azure pipelines</category>
            <category>azure devops</category>
        </item>
        <item>
            <title><![CDATA[Configure Azure connection strings and keys in Azure Bicep]]></title>
            <link>https://johnnyreilly.com/configure-azure-connection-strings-keys-in-azure-bicep</link>
            <guid>https://johnnyreilly.com/configure-azure-connection-strings-keys-in-azure-bicep</guid>
            <pubDate>Sun, 10 Mar 2024 17:27:19 GMT</pubDate>
            <description><![CDATA[Learn how to configure Azure resources like Azure Static Web Apps and Azure Container Apps with connection strings and access keys in Azure with Bicep.]]></description>
            <content:encoded><![CDATA[<p>Imagine you're deploying a solution to Azure. It'll feature some resources like a database or a storage account. How do can you configure your application with access to these resources? One approach would be using Managed Identity. Another approach is configuring the connection strings and access keys in our application's configuration store as the Bicep templates are deployed. This is a common approach when working with Azure Functions, Azure Static Web Apps, Azure Container Apps and similar.</p>
<p><img decoding="async" loading="eager" alt="title image reading &amp;quot;Configure Azure connection strings and keys in Azure Bicep&amp;quot; with the Bicep and Azure logos" src="https://johnnyreilly.com/assets/images/title-image-abc46f74075588ff096aed6c166c7ccb.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<p>A wonderful aspect of this approach is that no human need ever get to see the connection strings / access keys. They'll be discovered and consumed by Azure during a deployment, and known to your application at runtime, but untrustworthy humans need never get to see them. This is secure, and therefore <em>good</em>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="configure-an-azure-static-web-app-with-a-connection-string-and-an-access-key">Configure an Azure Static Web App with a connection string and an access key<a href="https://johnnyreilly.com/configure-azure-connection-strings-keys-in-azure-bicep#configure-an-azure-static-web-app-with-a-connection-string-and-an-access-key" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>The blog you are reading this on is hosted on Azure Static Web Apps and deployed with Bicep. It also has an Azure Cosmos DB database and an Application Insights instance. The Azure Static Web App has access to the database via its access key and has access to the Application Insights instance through a connection string. The key and connection string are supplied to the configuration of the SWA during deployment.</p>
<p>Let's look at the Bicep configuration that deploys a database. Here's a snippet of the Bicep template:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> databaseAccount </span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.DocumentDB/databaseAccounts@2023-04-15'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> cosmosDbAccountName</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">kind</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'GlobalDocumentDB'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">location</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">tags</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> tags</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">properties</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">consistencyPolicy</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> defaultConsistencyLevel</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'Session'</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">locations</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> locations</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">enableAutomaticFailover</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">databaseAccountOfferType</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'Standard'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">publicNetworkAccess</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'Enabled'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">ipRules</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token keyword" style="color:rgb(255, 157, 0)">for</span><span class="token plain"> ipAddress </span><span class="token keyword" style="color:rgb(255, 157, 0)">in</span><span class="token plain"> ipAddresses</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">ipAddressOrRange</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> ipAddress</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">backupPolicy</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> type</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'Periodic'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> periodicModeProperties</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> backupIntervalInMinutes</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">240</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> backupRetentionIntervalInHours</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">720</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here's a snippet of the Bicep template that deploys the Application Insights instance:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> appInsights </span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.Insights/components@2020-02-02'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> appInsightsName</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">location</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">kind</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'other'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">properties</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">Application_Type</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'web'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">Flow_Type</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'Bluefield'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">WorkspaceResourceId</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> workspace</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">id</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">RetentionInDays</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">90</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">IngestionMode</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'LogAnalytics'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">publicNetworkAccessForIngestion</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'Enabled'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">publicNetworkAccessForQuery</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'Enabled'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Given that both of these resources are deployed, we can reference them subsequently and acquire connection strings / access keys.</p>
<p>So when we're getting ready to deploy the Azure Static Web App, we are able reference both the database and the Application Insights instance. Here's a snippet of the Bicep template that acquires the references:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> databaseAccount </span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.DocumentDB/databaseAccounts@2023-04-15'</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">existing</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> cosmosDbAccountName</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> appInsightsResource </span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.Insights/components@2020-02-02'</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">existing</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> appInsightsName</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With those references in hand, we can now configure the Azure Static Web App with the connection string and access key. Here's a snippet of the Bicep template that configures the Azure Static Web App with the connection string and access key:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// deploy the Azure Static Web App</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> staticWebApp </span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.Web/staticSites@2022-09-01'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> staticWebAppName</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">location</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">tags</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> tagsWithHiddenLinks</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">sku</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'Free'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">tier</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'Free'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">properties</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">repositoryUrl</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'https://github.com/johnnyreilly/blog.johnnyreilly.com'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">repositoryToken</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> repositoryToken</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">branch</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> branch</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">provider</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'GitHub'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">stagingEnvironmentPolicy</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'Enabled'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">allowConfigFileUpdates</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">buildProperties</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">skipGithubActionWorkflowGeneration</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// configure the Azure Static Web App with the connection string and access key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> staticWebAppAppSettings </span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.Web/staticSites/config@2022-09-01'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'appsettings'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">kind</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'config'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">parent</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> staticWebApp</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">properties</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">APPINSIGHTS_INSTRUMENTATIONKEY</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> appInsightsResource</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">InstrumentationKey</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">APPLICATIONINSIGHTS_CONNECTION_STRING</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> appInsightsResource</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">ConnectionString </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// &lt;-- connection string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">COSMOS_ENDPOINT</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> databaseAccount</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">documentEndpoint</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">COSMOS_KEY</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> databaseAccount</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">listKeys</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">primaryMasterKey </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// &lt;-- access key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>I've slightly tweaked the code to make it more readable, if you'd like to see the full configuration of the Azure Static Web App in the source of my blog, you can find it <a href="https://github.com/johnnyreilly/blog.johnnyreilly.com/blob/df2382e31dab82604e98d91f83967b8b559eb507/infra/static-web-app.bicep#L47C1-L57C2" target="_blank" rel="noopener noreferrer">here</a>.</p>
<p>You can see the effect of this configuration in the Azure Portal. Here's a screenshot of the configured environment variables of the Azure Static Web App:</p>
<p><img decoding="async" loading="lazy" alt="Screenshot of the Azure Static Web App in the Azure Portal" src="https://johnnyreilly.com/assets/images/screenshot-azure-portal-environment-variables-e3e899ec9559b64c65a276a82ef48ce4.png" width="583" height="316" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="configure-an-azure-container-app-with-a-connection-string-and-an-access-key">Configure an Azure Container App with a connection string and an access key<a href="https://johnnyreilly.com/configure-azure-connection-strings-keys-in-azure-bicep#configure-an-azure-container-app-with-a-connection-string-and-an-access-key" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>What's hopefully apparent from the previous section is that in the end this amounts to injecting a string to the appropriate place in the configuration of the resource. This is true for Azure Container Apps as well. Here's a snippet of the Bicep template that configures an Azure Container App with a connection string and access key:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> appInsightsInstrumentationRef </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'app-insights-instrumentation-key'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> appInsightsConnectionStringRef </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'app-insights-connection-string'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> cosmosKeyRef </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'cosmos-key'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">resource</span><span class="token plain"> webServiceContainerApp </span><span class="token string" style="color:rgb(165, 255, 144)">'Microsoft.App/containerApps@2023-05-01'</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> webServiceContainerAppName</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">tags</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> tags</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">location</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">properties</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">configuration</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">secrets</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> appInsightsInstrumentationRef</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> appInsightsResource</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">InstrumentationKey</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> appInsightsConnectionStringRef</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> appInsightsResource</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">ConnectionString </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// &lt;-- connection string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> cosmosKeyRef</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> databaseAccount</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">listKeys</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">primaryMasterKey </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// &lt;-- access key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">template</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">containers</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">env</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'APPINSIGHTS_INSTRUMENTATIONKEY'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">secretRef</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> appInsightsInstrumentationRef</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'APPLICATIONINSIGHTS_CONNECTION_STRING'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">secretRef</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> appInsightsConnectionStringRef</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'COSMOS_ENDPOINT'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">value</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> databaseAccount</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">documentEndpoint</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">name</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'COSMOS_KEY'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">              </span><span class="token property" style="color:rgb(255, 157, 0)">secretRef</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> cosmosKeyRef</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The mechanism is slightly different, as befits the different service being used, but the principle is the same. We're injecting the connection string and access key into the configuration of the resource.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://johnnyreilly.com/configure-azure-connection-strings-keys-in-azure-bicep#conclusion" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>In this post we've demonstrated how to deploy resources, acquire reference to them and safely configure Azure Static Web Apps and Azure Container Apps such that they can access the resources.</p>
<p>The pattern we've used here is generally applicable in the Azure world. The same technique can be used to configure Azure Functions, Azure KeyVault, and many other Azure resources. The key is to understand the configuration of the resource you're working with and to understand how to inject the relevant secrets into that configuration.</p>]]></content:encoded>
            <category>bicep</category>
            <category>azure</category>
            <category>azure container apps</category>
            <category>azure static web apps</category>
        </item>
        <item>
            <title><![CDATA[ESLint no-unused-vars: _ ignore prefix]]></title>
            <link>https://johnnyreilly.com/typescript-eslint-no-unused-vars</link>
            <guid>https://johnnyreilly.com/typescript-eslint-no-unused-vars</guid>
            <pubDate>Sun, 10 Mar 2024 17:27:19 GMT</pubDate>
            <description><![CDATA[ESLints no-unused-vars is more flexible than TypeScript noUnusedLocals and noUnusedParameters. Here is how to make respect the TypeScript default of ignoring variables prefixed with _]]></description>
            <content:encoded><![CDATA[<p>I'm a longtime user of TypeScripts <a href="https://www.typescriptlang.org/tsconfig#noUnusedLocals" target="_blank" rel="noopener noreferrer"><code>noUnusedLocals</code></a> and <a href="https://www.typescriptlang.org/tsconfig#noUnusedParameters" target="_blank" rel="noopener noreferrer"><code>noUnusedParameters</code></a> settings. I like to avoid leaving unused variables in my code; these compiler options help me do that.</p>
<p>I use ESLint alongside TypeScript. The <a href="https://eslint.org/docs/latest/rules/no-unused-vars" target="_blank" rel="noopener noreferrer"><code>no-unused-vars</code></a> rule provides similar functionality to TypeScripts <code>noUnusedLocals</code> and <code>noUnusedParameters</code> settings, but has more power and more flexibility. For instance, <code>no-unused-vars</code> can catch unused error variables; TypeScript's <code>noUnusedLocals</code> and <code>noUnusedParameters</code> cannot.</p>
<p>One thing that I missed when switching to the ESLint option is that, with <code>noUnusedLocals</code> and <code>noUnusedParameters</code>, you can simply ignore unused variables by prefixing a variable with the <code>_</code> character. That's right, sometimes I want to declare a variable that I know I'm not going to use, and I want to do that without getting shouted at by the linter.</p>
<p>It turns out you can get ESLint to respect the TypeScript default of ignoring variables prefixed with <code>_</code>; <a href="https://github.com/typescript-eslint/typescript-eslint/issues/8464#issuecomment-1943325441" target="_blank" rel="noopener noreferrer">it's just not the default configuration for <code>no-unused-vars</code></a>. But with a little configuration we can have it. This post is a quick guide to how to implement that configuration.</p>
<p><img decoding="async" loading="eager" alt="title image reading &amp;quot;From TypeScript noUnusedLocals and noUnusedParameters to ESLint no-unused-vars (with _ prefix)&amp;quot; with the ESLint and TypeScript logo" src="https://johnnyreilly.com/assets/images/title-image-84e07ec452e3456b556977d64d3c682e.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="when-would-you-want-to-ignore-unused-variables">When would you want to ignore unused variables?<a href="https://johnnyreilly.com/typescript-eslint-no-unused-vars#when-would-you-want-to-ignore-unused-variables" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>There are various scenarios when I want to ignore unused variables. Here are a few:</p>
<ul>
<li>I'm writing a function but I'm not using all of the parameters yet. I plan to use them later, but I want to declare them now so I don't forget about them.</li>
<li>An ignored variable can be a form of documentation. It can be a way to say "I know this is here, but I'm not using it intentionally".</li>
</ul>
<p>Not everyone will agree with these reasons, but they work for me in certain situations.</p>
<p>Just to offer the counterpoint, let me quote <a href="https://github.com/bradzacher" target="_blank" rel="noopener noreferrer">Brad Zacher</a> who works on TypeScript ESLint:</p>
<blockquote>
<p>On the one hand it is nice to have a short-hand to ignore things.</p>
<p>On the other hand it is terrible having a short-hand to ignore things - it's a single character that's easy to miss in code review - so it's easy to sneak into a commit.</p>
<p>For example I recently reviewed a PR where someone innocently did something like</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword module" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token imports"> promisify </span><span class="token imports punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'node:util'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword module" style="color:rgb(255, 157, 0)">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token imports"> exec </span><span class="token imports keyword module" style="color:rgb(255, 157, 0)">as</span><span class="token imports"> _exec </span><span class="token imports punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(255, 157, 0)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'node:child_process'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> exec </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">promisify</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">_exec</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And they didn't realise that doing this would define a variable that would never get flagged if it's unused! Really bad!</p>
</blockquote>
<p>Brad has a valid point, but let's say you've decided to <code>--ignore-pattern 'brad'</code>, and want to make use of the <code>_</code> prefix anyway. (Sorry Brad!) Here's how you can do it.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-typescript-settings">The TypeScript settings<a href="https://johnnyreilly.com/typescript-eslint-no-unused-vars#the-typescript-settings" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>I mentioned that I like to use the TypeScript <code>noUnusedLocals</code> and <code>noUnusedParameters</code> settings. Here's how they would be configured in a <code>tsconfig.json</code>:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"compilerOptions"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">"noUnusedLocals"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">"noUnusedParameters"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Given we're moving to ESLint so we'll explicitly turn these off in our <code>tsconfig.json</code> so we can use ESLint to do the same job:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"compilerOptions"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">"noUnusedLocals"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">false</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">"noUnusedParameters"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-eslint-settings">The ESLint settings<a href="https://johnnyreilly.com/typescript-eslint-no-unused-vars#the-eslint-settings" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>With those off in TypeScript, we can now configure ESLint to respect the <code>_</code> prefix. Here's how you can do that in your <code>.eslintrc.json</code>:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"rules"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">"@typescript-eslint/no-unused-vars"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token string" style="color:rgb(165, 255, 144)">"error"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">"args"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"all"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">"argsIgnorePattern"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"^_"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">"caughtErrors"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"all"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">"caughtErrorsIgnorePattern"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"^_"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">"destructuredArrayIgnorePattern"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"^_"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">"varsIgnorePattern"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"^_"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">"ignoreRestSiblings"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>argsIgnorePattern</code>, <code>caughtErrorsIgnorePattern</code>, <code>destructuredArrayIgnorePattern</code>, and <code>varsIgnorePattern</code> settings are the ones that respect the <code>_</code> prefix. You have to set them all to <code>^_</code> to make it work. <code>^_</code> is a regular expression that matches any string that starts with an underscore. So if you actually had a different convention for ignoring variables, you could change this to match your convention.</p>
<p>Incidentally, you have to explicitly set <code>args</code> to <code>"all"</code> and <code>caughtErrors</code> to <code>"all"</code> to make the <code>argsIgnorePattern</code>/<code>caughtErrorsIgnorePattern</code> settings work. If you don't, the settings are ignored.</p>
<p>There's an <code>ignoreRestSiblings</code> setting specified above that we'll get to in a minute. First of all, let's see how the linting we've activated works in practice. Here's some code that demonstrates the settings in action:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">export</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">demoTheProblems</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  unusedAndReportedArg</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(250, 208, 0)">boolean</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  _unusedButIgnoredArg</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(250, 208, 0)">boolean</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// argsIgnorePattern</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  someArray</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(250, 208, 0)">string</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> unusedAndReportedVar </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> _unusedAndButIgnoredVar </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">false</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// varsIgnorePattern</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      unusedAndReportedDestructuredArray</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      _unusedButIgnoredDestructuredArray</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// destructuredArrayIgnorePattern</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> someArray</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// caughtErrors</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">unusedAndReportedErr</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// caughtErrorsIgnorePattern</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">_unusedButIgnoredErr</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this code, the <code>unusedAndReportedArg</code>, <code>unusedAndReportedVar</code>, <code>unusedAndReportedDestructuredArray</code>, and <code>unusedAndReportedErr</code> variables are all reported as unused. ESLint considers them errors and shouts about them.</p>
<p>By contrast, the <code>_unusedButIgnoredArg</code>, <code>_unusedAndButIgnoredVar</code>, <code>_unusedButIgnoredDestructuredArray</code>, and <code>_unusedButIgnoredErr</code> variables are all ignored, because they are prefixed with an underscore. ESLint notices them but lets them past.</p>
<p>If we run ESLint on this code, we get the following output:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token plain">   </span><span class="token number" style="color:rgb(255, 98, 140)">2</span><span class="token plain">:3   error  </span><span class="token string" style="color:rgb(165, 255, 144)">'unusedAndReportedArg'</span><span class="token plain"> is defined but never used. Allowed unused args must match /^_/u                                                             @typescript-eslint/no-unused-vars</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">   </span><span class="token number" style="color:rgb(255, 98, 140)">7</span><span class="token plain">:11  error  </span><span class="token string" style="color:rgb(165, 255, 144)">'unusedAndReportedVar'</span><span class="token plain"> is assigned a value but never used. Allowed unused vars must match /^_/u                                                    @typescript-eslint/no-unused-vars</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token number" style="color:rgb(255, 98, 140)">11</span><span class="token plain">:7   error  </span><span class="token string" style="color:rgb(165, 255, 144)">'unusedAndReportedDestructuredArray'</span><span class="token plain"> is assigned a value but never used. Allowed unused elements of array destructuring patterns must match /^_/u  @typescript-eslint/no-unused-vars</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token number" style="color:rgb(255, 98, 140)">15</span><span class="token plain">:12  error  </span><span class="token string" style="color:rgb(165, 255, 144)">'unusedAndReportedErr'</span><span class="token plain"> is defined but never used. Allowed unused args must match /^_/u                                                             @typescript-eslint/no-unused-vars</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Perfect! This is exactly what we wanted. You can see this in action in the <a href="https://typescript-eslint.io/play/#ts=5.3.3&amp;fileType=.tsx&amp;code=KYDwDg9gTgLgBAMwK4DsDGMCWEVwCbAC2EAKgBbAAKUEARgDZEDOAFALABQccqSTweAIIo8AJWCRYAwVADmALji0IERgEMUAGk7cA%2Br354AQkhgBJWSmjS5i5auAbNcAPQu4auUwtWoVNTAwwFAoOnBMEITAMlBqAJ6KTDBQmCiyANoAupwAlHAA3mHJcQVh3Gg4STwofNIi4pJBeABqnnAAvHDJSMAA3GVwFShV%2BjWGwsamPtYtbZ0IavT8va7uAG6e3pbWlAFBIZwDQ1XpA9wGdWIS0E0AIsBJUEgYSH5CULFx2lzcv6O1k3M2ze90ezxgrxsn1W%2BAe3Rebxi8Wmfl2gWCoR%2B3EyHXCkWiH3i-Q4YQAvoMAmgyHAWBchPVrlI8ABRD55fIwtBqJCyMgwVk0KBMAZuOAAOglZKKUBKhR%2B5K5MCpNP%2BhhMQN8AgF7M53N5-I%2B0C2mrR%2B0xvxhErFUo4pM4QA&amp;eslintrc=N4KABGBEBOCuA2BTAzpAXGUEKQAIBcBPABxQGNoBLY-AWhXkoDt8B6Jge1tidmUQAmtAG4BDaKgwBtcNhyJo0DtEgAaWXKxzskcQHNJUUfHhqN23dAMBJPZ2iIACqPz4FTdFAB6AfTPadMlFYPQALfABRRWVDXRN-AKggkPCopQlbeycXN2gPDEhfBIDIARR8ODJ8WAcBAEFFUUJM5WzXd09Cv3VEqDEMu1bndrzOop7EyEpBhwAlcoBlSgAjRiYDTwrYRHMIAF9zAF1ZA72gA&amp;tsconfig=N4KABGBEDGD2C2AHAlgGwKYCcDyiAuysAdgM6QBcYoEEkRsAqkQK4noAmAMrNAIaplKAM35sANOBp1GLNuwAKvTL3jo8WQWBED0kgL4g9QA&amp;tokens=false" target="_blank" rel="noopener noreferrer">playground</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-ignorerestsiblings-setting">The <code>ignoreRestSiblings</code> setting<a href="https://johnnyreilly.com/typescript-eslint-no-unused-vars#the-ignorerestsiblings-setting" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>The <a href="https://eslint.org/docs/latest/rules/no-unused-vars#ignorerestsiblings" target="_blank" rel="noopener noreferrer"><code>ignoreRestSiblings</code></a> setting is also useful. You may find the need to use the rest operator in a destructuring assignment to omit properties from an object and hold onto the rest. Here's an example:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> formattedDate</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> date</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">...</span><span class="token plain">totals </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> payload</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this case I don't want to use <code>formattedDate</code> or <code>date</code> but I do want to use <code>totals</code>. I can use the <code>ignoreRestSiblings</code> setting to ignore the unused variables without even needing a <code>_</code> prefix or similar. So I do.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://johnnyreilly.com/typescript-eslint-no-unused-vars#conclusion" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>I hope this post has been helpful. I've shown you how to configure ESLint to respect the TypeScript default of ignoring variables prefixed with <code>_</code>.</p>
<p>Many thanks to Brad Zacher for his input on this post. You can read our discussion on the TypeScript ESLint GitHub repo <a href="https://github.com/typescript-eslint/typescript-eslint/issues/8464" target="_blank" rel="noopener noreferrer">here</a>.</p>]]></content:encoded>
            <category>typescript</category>
            <category>javascript</category>
            <category>eslint</category>
        </item>
        <item>
            <title><![CDATA[Overview of webpack, a JavaScript bundler]]></title>
            <link>https://johnnyreilly.com/webpack-overview</link>
            <guid>https://johnnyreilly.com/webpack-overview</guid>
            <pubDate>Sat, 06 Apr 2024 07:21:54 GMT</pubDate>
            <description><![CDATA[webpack is a JavaScript bundler that helps you bundle your code into a single file. It's a great tool for optimizing your code and improving performance.]]></description>
            <content:encoded><![CDATA[<p>If you're a JavaScript developer, you've probably heard of webpack. It's a JavaScript bundler that helps you bundle your code into a single file. It's a great tool for optimizing your code and improving performance. This article will give you an overview of webpack, its history and how it works.</p>
<p>It'll be a little different than your typical "what is webpack?" article, in that I write this as the maintainer of <a href="https://github.com/TypeStrong/ts-loader" target="_blank" rel="noopener noreferrer"><code>ts-loader</code></a>, a loader used for integrating TypeScript with webpack. I've worked in the webpack ecosystem for some years now and I'll share some of my experiences with you. I'll go through a little history around bundling, and try to understand why webpack came to be such a popular choice.</p>
<p><img decoding="async" loading="eager" alt="title image reading &amp;quot;Overview of webpack, a JavaScript bundler&amp;quot; with the webpack logo" src="https://johnnyreilly.com/assets/images/title-image-510ccb17fb0abf91a6a1fca2ba757f19.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="a-short-history-of-web-development">A short history of web development<a href="https://johnnyreilly.com/webpack-overview#a-short-history-of-web-development" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>To answer the question "what is webpack?", we need to understand what a bundler is. To grasp that, we first need a little history lesson.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-early-days-of-javascript">The early days of JavaScript<a href="https://johnnyreilly.com/webpack-overview#the-early-days-of-javascript" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>If you started web development after 2016, you might not realise that bundling is a relatively new concept.</p>
<p>Let's roll back the clock to the late 2000's. This was when JavaScript development started to go mainstream. Around that time, jQuery was becoming popular and the web was a very different place. We didn't have the same tools we have today. We didn't have npm, we didn't have webpack, we didn't have React, we didn't have TypeScript. We didn't even have ES2015. We were still writing JavaScript in ES5.</p>
<p>So what did building a front end application look like back then? Well, I was a web developer, and I can tell you that it was a lot of work. To make a simple app you would have to:</p>
<ul>
<li>Go to the websites of libraries you wanted to use, usually jQuery and jQuery UI.</li>
<li>Download the library files you needed (both <code>jquery-1.4.4.js</code> and the minified <code>jquery-1.4.4.min.js</code> because there weren't minification tools back then)</li>
<li>Include the library files in your HTML file using <code>script</code> tags, and significantly <strong>before</strong> other JavaScript files that would depend upon jQuery.</li>
<li>For bonus points, you would also download the jQuery UI CSS files and include them in your HTML file.</li>
<li>For extra bonus points, you would figure out a way to serve up non-minified versions of your JavaScript files in development, and minified versions in production.</li>
</ul>
<p>What I'm hoping you can see from this is that it was a lot of work. And it was very error prone. If you forgot to include a library, or included it in the wrong order, or included the wrong version, or forgot to minify your files, or forgot to include the CSS files, your app would break. And it would be very difficult to debug.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rise-of-the-task-runners">Rise of the task runners<a href="https://johnnyreilly.com/webpack-overview#rise-of-the-task-runners" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>As web development became more popular, people started to realise that there was a lot of repetition in the process. So they started to automate it. Around 2012 we started to see the birth of the task runner. There were two main task runners that became popular: <a href="https://gruntjs.com/" target="_blank" rel="noopener noreferrer">Grunt</a> and <a href="https://gulpjs.com/" target="_blank" rel="noopener noreferrer">Gulp</a>.</p>
<p>These task runners allowed you to automate the process of combining and minifying JavaScript and CSS files, and including them in your HTML file. They also allowed you to automate other tasks, like running tests, linting your code, and deploying your app. They did improve the web development experience, but they didn't solve all the problems.</p>
<p>It was still very easy to make mistakes. You could still forget to include a library, or include it in the wrong order, or get a path wrong, or forget to minify your files, or forget to include the CSS files. And it was still very difficult to debug.</p>
<p>But it was <strong>so much better</strong> than what we had before. So it became very popular.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-rise-of-the-module-bundler">The rise of the module bundler<a href="https://johnnyreilly.com/webpack-overview#the-rise-of-the-module-bundler" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Around 2014, a new tool started to become popular: the module bundler. But what is a module bundler? Well, it's a tool that allows you to write your code in modules, and then bundle those modules into a single file. It also allows you to use other tools, like TypeScript, and CSS preprocessors like Sass and Less.</p>
<p>That's a lot of words, let's unpack them a little. For some time, the defacto way of acquiring JavaScript libraries has been through npm. npm is a package manager for JavaScript. However, it's worth remembering its history. npm started out as the package manager for Node.js. It was originally used to house packages that were used to build Node.js applications. It was never intended to be used for front end development. In fact, for a while there was an alternative front end package manager called <a href="https://bower.io/" target="_blank" rel="noopener noreferrer">Bower</a>.</p>
<p>The thing is, there's a lot of commonality between Node.js and front end development. Both use JavaScript. You're unlikely to need to run a web server in the browser. However, whether running in a browser or on a server, you might want to order an array with lodash, or make use of TypeScript, or perform validation with Zod. So it makes sense to use the same package manager for both.</p>
<p>The first tool that tackled this was <a href="http://browserify.org/" target="_blank" rel="noopener noreferrer">Browserify</a>. As the name suggests, it was a tool that allowed you to use Node.js style modules in the browser. It did this by taking your code, and recursively walking through it, finding all the <code>require</code> calls, and bundling them into a single file.</p>
<p>By doing this, it performed two useful functions:</p>
<ol>
<li>It opened up the ecosystem of Node.js packages to front end developers.</li>
<li>It allowed you to write your code in modules, which made it easier to reason about.</li>
</ol>
<p>Both of these are tremendously significant. The first one is obvious; there's a rich ecosystem of modules which can be used to speed up the task of web development.</p>
<p>The value of modularity is less obvious, but it's very important. It's worth remembering that JavaScript didn't have modules until ES2015. But npm had its own module standard called CommonJS. Given that Browserify and webpack were both created before ES2015, they both used CommonJS modules in the context of the browser. This was a huge improvement over the previous way of doing things, which was to include a bunch of script tags in your HTML file, and writing all your code in a giant global object. The reason it's so wildly different is because the dependencies in your codebase moved from being <strong>implicit</strong> to being <strong>explicit</strong>. Instead of having to remember to include a bunch of script tags in your HTML file, you could just <code>require</code> the modules you needed. This made it much easier to reason about your codebase. What's more, you had a a <code>package.json</code> file that listed all your dependencies, so you could see at a glance what your dependencies were.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-webpack">What is webpack?<a href="https://johnnyreilly.com/webpack-overview#what-is-webpack" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Now we understand a little of the history, we come to webpack. By the way, it's definitely not "Webpack" or "WebPack". It's <a href="https://webpack.js.org/branding/" target="_blank" rel="noopener noreferrer">"webpack"</a>. The person initially behind webpack is <a href="https://github.com/sokra" target="_blank" rel="noopener noreferrer">Tobias Koppers</a>; an engineer from Germany. Many, many people have contributed to the project since then, but Tobias is the person who has done the most work on it.</p>
<p>I mentioned that I was a web developer whilst the web was evolving its developer tooling. In my case I was a longtime user of Gulp, and then Browserify. I moved to webpack in 2015. I can't remember exactly why I moved, but I think it was because I wanted to use TypeScript, and webpack had better TypeScript support than Browserify (more on this later). I also think I was attracted to webpack because it was a more holistic solution than Browserify. It had a plugin system, and it had loaders. I'll talk about those in a moment.</p>
<p>First and foremost, it's worth saying that webpack is a module bundler. It takes your code, and recursively walks through it, finding all the <code>require</code> or <code>import</code> calls, building up a dependency graph, performing preprocessing tasks and producing runnable output, in the form of HTML, CSS and JavaScript. It also allows you to use other tools, like TypeScript, and CSS preprocessors like Sass and Less.</p>
<p>One of the most surprising things about webpack has been both its popularity, and how it has lasted. The web development world is famous for having the attention span of a distracted toddler. Tools replace tools, libraries replace libraries, and frameworks replace frameworks. But webpack has been around for a long time, and it's still the most popular bundler. At the time of writing it still has <strong>110 million downloads a month</strong>. That's a lot! Why is that?</p>
<p>I think there are a few reasons.</p>
<p>Firstly, because of the richness of the ecosystem and the flexibility of the tool, it's possible to solve pretty much all web development problems with webpack. There are newer, shinier, faster tools (and as we'll see later, webpack is starting to be displaced by some of these) but as a reliable tool that can solve all your problems, webpack is hard to beat.</p>
<p>That doesn't mean it's the easiest tool to work with on all occasions. The internet is awash with people bitterly complaining about the scars they bear from configuring webpack. It's true that webpack can be difficult to configure. But it's also true that webpack is a very powerful tool. Once you have it working, you generally don't have to touch it again.</p>
<p>A second reason why webpack is so popular, is that it has become a "primitive". What I mean by that, is that it has become a library that other libraries depend upon. If you use Docusaurus, you're also using webpack as the underlying build tool. Many projects have a need of a build tool and have picked webpack to be that. This has led to a huge ecosystem of plugins and loaders. It's also led to a plethora of tutorials and blog posts. If you have a problem, it's likely that someone else has had the same problem and has written a blog post about it.</p>
<p>By way of example, a <a href="https://johnnyreilly.com/using-webpacks-defineplugin-with-typescript" target="_blank" rel="noopener noreferrer">blog post I wrote in 2016 about the webpack <code>DefinePlugin</code></a> still ranks highly in Google for "use webpack defineplugin with typescript" and is (to my surprise) one of my most popular blog posts. Here's a screenshot of it in the Google search results:</p>
<p><img decoding="async" loading="lazy" alt="screenshot of the blog post in Google search results" src="https://johnnyreilly.com/assets/images/screenshot-google-search-results-webpack-defineplugin-8ae6233274e2dc990b6ff6f98e7c30ea.webp" width="1858" height="652" class="img_ev3q"></p>
<p>This speaks to the level of popularity around all things webpack.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="getting-started">Getting started<a href="https://johnnyreilly.com/webpack-overview#getting-started" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>This article is intended to be an overview of webpack. The documentation, as you might expect from such a big project, is comprehensive and can be found here: <a href="https://webpack.js.org/" target="_blank" rel="noopener noreferrer">https://webpack.js.org</a></p>
<p>Whilst we won't go through every scenario and use case of webpack, we want to give you a sense of what working with webpack looks like. For the purposes of this article, let's get started with a simple example. We'll create a simple "Hello, webpack" app. And we'll enrich it as we go through the piece.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="creating-a-simple-app">Creating a simple app<a href="https://johnnyreilly.com/webpack-overview#creating-a-simple-app" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>First, let's make a folder, create a <code>package.json</code> file and install the webpack dependencies we need:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token function" style="color:rgb(250, 208, 0)">mkdir</span><span class="token plain"> hello-webpack</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(250, 208, 0)">cd</span><span class="token plain"> hello-webpack</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token function" style="color:rgb(250, 208, 0)">npm</span><span class="token plain"> init </span><span class="token parameter variable" style="color:rgb(255, 238, 128)">-y</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token function" style="color:rgb(250, 208, 0)">npm</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">install</span><span class="token plain"> webpack webpack-cli webpack-dev-server html-webpack-plugin --save-dev</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The dependencies we're installing are:</p>
<ul>
<li>webpack</li>
<li><a href="https://github.com/webpack/webpack-cli" target="_blank" rel="noopener noreferrer"><code>webpack-cli</code></a> - a command line interface for webpack</li>
<li><a href="https://webpack.js.org/configuration/dev-server/" target="_blank" rel="noopener noreferrer"><code>webpack-dev-server</code></a> - a development server that allows you to serve up your app in a browser</li>
<li><a href="https://github.com/jantimon/html-webpack-plugin/" target="_blank" rel="noopener noreferrer"><code>html-webpack-plugin</code></a> - a plugin that allows you to generate an HTML file that includes your bundled JavaScript file(s)</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configuration-with-webpackconfigjs">Configuration with <code>webpack.config.js</code><a href="https://johnnyreilly.com/webpack-overview#configuration-with-webpackconfigjs" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Whilst it is possible to use webpack without configuring it, it's more typical to have a configuration file. This file is often called <code>webpack.config.js</code>; where a single configuration file is being used. It's also comon to may have more than one configuration file; perhaps one for development and one for production. We'll create a single <code>webpack.config.js</code> to use with our example app:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> path </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">require</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">'path'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> </span><span class="token maybe-class-name">HtmlWebpackPlugin</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">require</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">'html-webpack-plugin'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">module</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token literal-property property" style="color:rgb(255, 157, 0)">mode</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'development'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// mode can be "development", "production" or "none" https://webpack.js.org/configuration/mode/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token literal-property property" style="color:rgb(255, 157, 0)">entry</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'./src/index.js'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// the entry point of our app https://webpack.js.org/concepts/entry-points/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token literal-property property" style="color:rgb(255, 157, 0)">devtool</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'inline-source-map'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// the type of sourcemap to generate for debugging https://webpack.js.org/configuration/devtool/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token literal-property property" style="color:rgb(255, 157, 0)">plugins</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">HtmlWebpackPlugin</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// a plugin to generate an HTML file https://github.com/jantimon/html-webpack-plugin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token literal-property property" style="color:rgb(255, 157, 0)">output</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// where to put the bundled output https://webpack.js.org/concepts/output/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token literal-property property" style="color:rgb(255, 157, 0)">filename</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'[name].[contenthash].js'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token literal-property property" style="color:rgb(255, 157, 0)">path</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> path</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token method function property-access" style="color:rgb(250, 208, 0)">resolve</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">__dirname</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'dist'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token literal-property property" style="color:rgb(255, 157, 0)">clean</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This may seem a little overwhelming, so we'll through this configuration file property by property in a moment.</p>
<p>The one thing that you might be puzzled by, is the absence of a <code>module</code> section to cover loaders. This is because webpack supports processing JavaScript by default. We'll add a <code>module</code> section later when we want to process other types of files.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="mode"><code>mode</code><a href="https://johnnyreilly.com/webpack-overview#mode" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h4>
<p>This is the mode that webpack will run in, and it essentially tells webpack to provide helpful defaults around how builds are performed. It can be <code>development</code>, <code>production</code> or <code>none</code>. We're using <code>development</code> because we're developing locally. If we were building for production, we'd use <code>production</code>.</p>
<p>Read more about modes here: <a href="https://webpack.js.org/configuration/mode/" target="_blank" rel="noopener noreferrer">https://webpack.js.org/configuration/mode/</a></p>
<p>Incidentally, we can override this on the command line with the <code>--mode</code> flag. And we will.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="entry"><code>entry</code><a href="https://johnnyreilly.com/webpack-overview#entry" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h4>
<p>This is the entry point of our app. It's the file that webpack will start with. In this case, it's <code>src/index.js</code>. It is possible to have multiple entry points, but we'll keep it simple for now.</p>
<p>Read more about entry points here: <a href="https://webpack.js.org/concepts/entry-points/" target="_blank" rel="noopener noreferrer">https://webpack.js.org/concepts/entry-points/</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="devtool"><code>devtool</code><a href="https://johnnyreilly.com/webpack-overview#devtool" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h4>
<p>This is the type of sourcemap that webpack will generate. We're using <code>inline-source-map</code> because we're developing locally and we'd like to be able to debug our source code in the browser. If we were building for production, we might make a different choice.</p>
<p>Read more about sourcemaps here: <a href="https://webpack.js.org/configuration/devtool/" target="_blank" rel="noopener noreferrer">https://webpack.js.org/configuration/devtool/</a> - there are many different types of sourcemap, and they all have different tradeoffs.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="plugins"><code>plugins</code><a href="https://johnnyreilly.com/webpack-overview#plugins" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h4>
<p>This is a list of plugins that we want to use. We're using the <code>HtmlWebpackPlugin</code> to generate an HTML file that includes our bundled JavaScript file(s).</p>
<p>Read more about plugins here: <a href="https://webpack.js.org/concepts/plugins/" target="_blank" rel="noopener noreferrer">https://webpack.js.org/concepts/plugins/</a> - we'll talk more about plugins later.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="output"><code>output</code><a href="https://johnnyreilly.com/webpack-overview#output" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h4>
<p>This is where we want webpack to put the bundled output. We're using <code>dist</code> as the folder name. We're also using a <code>[name].[contenthash].js</code> naming convention for our bundled JavaScript file. This means that webpack will generate a file called <code>main.[contenthash].js</code> in the <code>dist</code> folder. The <code>[contenthash]</code> part is a hash of the contents of the file. This is useful because it means that if the contents of the file change, the hash will change, and the filename will change. This helps because it means that we can cache the file for a long time, and if the contents change, the filename will change and the browser will download the new file.</p>
<p>We're also providing the <a href="https://webpack.js.org/guides/output-management/#cleaning-up-the-dist-folder" target="_blank" rel="noopener noreferrer"><code>clean: true</code></a> option which deletes the contents of our <code>dist</code> folder on each build.</p>
<p>Read more about output here: <a href="https://webpack.js.org/concepts/output/" target="_blank" rel="noopener noreferrer">https://webpack.js.org/concepts/output/</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="creating-a-simple-app-1">Creating a simple app<a href="https://johnnyreilly.com/webpack-overview#creating-a-simple-app-1" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>What we need now, is some code to bundle. Let's create a <code>src</code> folder, and a <code>src/index.js</code> file; our first JavaScript file:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> element </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token dom variable" style="color:rgb(255, 238, 128)">document</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token method function property-access" style="color:rgb(250, 208, 0)">createElement</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">'div'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  element</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">innerHTML</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'Hello, webpack'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> element</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token dom variable" style="color:rgb(255, 238, 128)">document</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token property-access">body</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token method function property-access" style="color:rgb(250, 208, 0)">appendChild</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token function" style="color:rgb(250, 208, 0)">app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="local-development-with-webpack-dev-server">Local development with <code>webpack-dev-server</code><a href="https://johnnyreilly.com/webpack-overview#local-development-with-webpack-dev-server" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Now we're going to add two scripts to our <code>package.json</code> file. One to build our app, and one to serve it up in a browser whilst we're developing it:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"scripts"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">"build"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"webpack build --mode production"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token property" style="color:rgb(255, 157, 0)">"start"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"webpack serve --open"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With this in place, we can develop locally with <code>npm start</code>. This will serve up our app in a browser at <code>http://localhost:8080/</code> using <code>webpack-dev-server</code>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token operator" style="color:rgb(255, 157, 0)">&gt;</span><span class="token plain"> hello-webpack@1.0.0 start</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token operator" style="color:rgb(255, 157, 0)">&gt;</span><span class="token plain"> webpack serve </span><span class="token parameter variable" style="color:rgb(255, 238, 128)">--open</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token operator" style="color:rgb(255, 157, 0)">&lt;</span><span class="token plain">i</span><span class="token operator" style="color:rgb(255, 157, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">webpack-dev-server</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> Project is running at:</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token operator" style="color:rgb(255, 157, 0)">&lt;</span><span class="token plain">i</span><span class="token operator" style="color:rgb(255, 157, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">webpack-dev-server</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> Loopback: http://localhost:8080/</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token operator" style="color:rgb(255, 157, 0)">&lt;</span><span class="token plain">i</span><span class="token operator" style="color:rgb(255, 157, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">webpack-dev-server</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> On Your Network </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">IPv4</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain">: http://172.30.170.28:8080/</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token operator" style="color:rgb(255, 157, 0)">&lt;</span><span class="token plain">i</span><span class="token operator" style="color:rgb(255, 157, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">webpack-dev-server</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> On Your Network </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">IPv6</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain">: http://</span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">fe80::1</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain">:8080/</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token operator" style="color:rgb(255, 157, 0)">&lt;</span><span class="token plain">i</span><span class="token operator" style="color:rgb(255, 157, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">webpack-dev-server</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> Content not from webpack is served from </span><span class="token string" style="color:rgb(165, 255, 144)">'/Users/jreilly/code/github.com/hello-webpack/public'</span><span class="token plain"> directory</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token operator" style="color:rgb(255, 157, 0)">&lt;</span><span class="token plain">i</span><span class="token operator" style="color:rgb(255, 157, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">webpack-dev-middleware</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">wait</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">until</span><span class="token plain"> bundle finished: /</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">asset main.4d4379bc3adfa037dc27.js </span><span class="token number" style="color:rgb(255, 98, 140)">621</span><span class="token plain"> KiB </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">emitted</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">immutable</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">name: main</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">asset index.html </span><span class="token number" style="color:rgb(255, 98, 140)">252</span><span class="token plain"> bytes </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">emitted</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">runtime modules </span><span class="token number" style="color:rgb(255, 98, 140)">27.3</span><span class="token plain"> KiB </span><span class="token number" style="color:rgb(255, 98, 140)">12</span><span class="token plain"> modules</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">modules by path ./node_modules/ </span><span class="token number" style="color:rgb(255, 98, 140)">178</span><span class="token plain"> KiB</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  modules by path ./node_modules/webpack-dev-server/client/ </span><span class="token number" style="color:rgb(255, 98, 140)">71.8</span><span class="token plain"> KiB </span><span class="token number" style="color:rgb(255, 98, 140)">16</span><span class="token plain"> modules</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  modules by path ./node_modules/webpack/hot/*.js </span><span class="token number" style="color:rgb(255, 98, 140)">5.3</span><span class="token plain"> KiB</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    ./node_modules/webpack/hot/dev-server.js </span><span class="token number" style="color:rgb(255, 98, 140)">1.94</span><span class="token plain"> KiB </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">built</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">code generated</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    ./node_modules/webpack/hot/log.js </span><span class="token number" style="color:rgb(255, 98, 140)">1.86</span><span class="token plain"> KiB </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">built</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">code generated</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    + </span><span class="token number" style="color:rgb(255, 98, 140)">2</span><span class="token plain"> modules</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  modules by path ./node_modules/html-entities/lib/*.js </span><span class="token number" style="color:rgb(255, 98, 140)">81.8</span><span class="token plain"> KiB</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    ./node_modules/html-entities/lib/index.js </span><span class="token number" style="color:rgb(255, 98, 140)">7.91</span><span class="token plain"> KiB </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">built</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">code generated</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    ./node_modules/html-entities/lib/named-references.js </span><span class="token number" style="color:rgb(255, 98, 140)">73</span><span class="token plain"> KiB </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">built</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">code generated</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    ./node_modules/html-entities/lib/numeric-unicode-map.js </span><span class="token number" style="color:rgb(255, 98, 140)">339</span><span class="token plain"> bytes </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">built</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">code generated</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    ./node_modules/html-entities/lib/surrogate-pairs.js </span><span class="token number" style="color:rgb(255, 98, 140)">537</span><span class="token plain"> bytes </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">built</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">code generated</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  ./node_modules/ansi-html-community/index.js </span><span class="token number" style="color:rgb(255, 98, 140)">4.16</span><span class="token plain"> KiB </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">built</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">code generated</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  ./node_modules/events/events.js </span><span class="token number" style="color:rgb(255, 98, 140)">14.5</span><span class="token plain"> KiB </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">built</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">code generated</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">./src/index.js </span><span class="token number" style="color:rgb(255, 98, 140)">163</span><span class="token plain"> bytes </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">built</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">code generated</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">webpack </span><span class="token number" style="color:rgb(255, 98, 140)">5.89</span><span class="token plain">.0 compiled successfully </span><span class="token keyword" style="color:rgb(255, 157, 0)">in</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">861</span><span class="token plain"> ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If we open the browser at <code>http://localhost:8080</code>, we'll see our "Hello, webpack" message.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="building-for-production">Building for production<a href="https://johnnyreilly.com/webpack-overview#building-for-production" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>We can build our app for production with <code>npm run build</code>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token function" style="color:rgb(250, 208, 0)">npm</span><span class="token plain"> run build</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token operator" style="color:rgb(255, 157, 0)">&gt;</span><span class="token plain"> hello-webpack@1.0.0 build</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token operator" style="color:rgb(255, 157, 0)">&gt;</span><span class="token plain"> webpack build </span><span class="token parameter variable" style="color:rgb(255, 238, 128)">--mode</span><span class="token plain"> production</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">asset main.82d3f64b186c8eec8e7c.js </span><span class="token number" style="color:rgb(255, 98, 140)">862</span><span class="token plain"> bytes </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">emitted</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">immutable</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">minimized</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">name: main</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">asset index.html </span><span class="token number" style="color:rgb(255, 98, 140)">235</span><span class="token plain"> bytes </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">emitted</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">./src/index.js </span><span class="token number" style="color:rgb(255, 98, 140)">163</span><span class="token plain"> bytes </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">built</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">code generated</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">webpack </span><span class="token number" style="color:rgb(255, 98, 140)">5.89</span><span class="token plain">.0 compiled successfully </span><span class="token keyword" style="color:rgb(255, 157, 0)">in</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">516</span><span class="token plain"> ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This has created a <code>dist</code> folder, and a <code>dist/index.html</code> file. Alongside that, it's created a <code>dist/main.82d3f64b186c8eec8e7c.js</code> file. If you open the <code>index.html</code> file in a browser, you'll see your "Hello, webpack" message.</p>
<p>At this point we have a simple app built with webpack. It's not doing much, but it's a start. And it'll give us a chance to talk about some concepts. Let's add some more features.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="integrating-with-plugins-and-loaders">Integrating with plugins and loaders<a href="https://johnnyreilly.com/webpack-overview#integrating-with-plugins-and-loaders" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>If you want to do anything more than the most basic of apps, you'll need to use plugins and loaders. Let's add some more features to our app, and we'll use plugins and loaders to do it.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="loaders">Loaders<a href="https://johnnyreilly.com/webpack-overview#loaders" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>The first thing we'll do is look at loaders. Loaders allow webpack to process other types of files (for example, TypeScript) and convert them into valid modules that can be consumed by your application and added to the dependency graph. An example of a loader is <a href="https://github.com/TypeStrong/ts-loader" target="_blank" rel="noopener noreferrer"><code>ts-loader</code></a> which allows you to use TypeScript with webpack.</p>
<p>I should not brush past this, I'm the primary maintainer of <code>ts-loader</code> and I'm very proud of it. It gets around 30 million downloads a month at the time of writing. That suggests that roughly a quarter of webpacks users are also <code>ts-loader</code> users. <code>ts-loader</code> is a great loader, and I'm very happy to have worked on it since 2016. There's actually a story behind how I came to work on it, <a href="https://johnnyreilly.com/but-you-cant-die-i-love-you-ts-loader" target="_blank" rel="noopener noreferrer">you can read it here</a>.</p>
<p>Let's install <code>ts-loader</code> and TypeScript, and create a <code>tsconfig.json</code> file:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token function" style="color:rgb(250, 208, 0)">npm</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">install</span><span class="token plain"> typescript ts-loader --save-dev</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">npx tsc </span><span class="token parameter variable" style="color:rgb(255, 238, 128)">--init</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now we need to configure webpack to use <code>ts-loader</code>. We do this by updating our entry point to be a TypeScript file and adding a <code>module</code> section to our <code>webpack.config.js</code> file:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token plain">const path = require('path');</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">const HtmlWebpackPlugin = require('html-webpack-plugin');</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">module.exports = {</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> mode: 'development', // mode can be "development", "production" or "none" https://webpack.js.org/configuration/mode/</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token deleted-sign deleted prefix deleted" style="color:rgba(239, 83, 80, 0.56)">-</span><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)">  entry: './src/index.js', // the entry point of our app https://webpack.js.org/concepts/entry-points/</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">  entry: './src/index.ts', // the entry point of our app https://webpack.js.org/concepts/entry-points/</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> devtool: 'inline-source-map', // the type of sourcemap to generate for debugging https://webpack.js.org/configuration/devtool/</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> plugins: [</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   new HtmlWebpackPlugin(), // a plugin to generate an HTML file https://github.com/jantimon/html-webpack-plugin</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> ],</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">  module: {</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">    rules: [</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">      {</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">        test: /\.([cm]?ts|tsx)$/,</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">        loader: 'ts-loader',</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">      },</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">    ],</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">  },</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> output: {</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   // where to put the bundled output https://webpack.js.org/concepts/output/</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   filename: '[name].[contenthash].js',</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   path: path.resolve(__dirname, 'dist'),</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   clean: true,</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> },</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>test</code> property is a regular expression that matches the files we want to process. In this case, we're matching <code>.ts</code>, <code>.tsx</code>, <code>.cts</code> and <code>.cts</code> files. The <code>loader</code> property is the name of the loader we want to use; <code>ts-loader</code>.</p>
<p>Let's rename our <code>src/index.js</code> file to <code>src/index.ts</code> and change the code to use TypeScript:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> HTMLDivElement </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// the only TypeScript change we made is to add a return type</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> element </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> document</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">createElement</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">'div'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  element</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">innerHTML </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'Hello, webpack'</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> element</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">document</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">body</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">appendChild</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token function" style="color:rgb(250, 208, 0)">app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And just like that, we can use TypeScript in our app!</p>
<p>What is <code>ts-loader</code> actually doing? Well, it's taking our TypeScript code, and converting it into JavaScript. For each TypeScript file, <code>ts-loader</code> is invoked. It takes the TypeScript code, and passes it to the TypeScript compiler. The TypeScript compiler converts the TypeScript code into JavaScript. <code>ts-loader</code> then takes the JavaScript code and passes it to webpack. webpack then takes the JavaScript code and bundles it.</p>
<p>This is what all loaders do; they take a file, process it, and pass it to webpack. There are many loaders available, and you can even write your own. They aren't restricted to languages that compile to JavaScript. You can find a list of loaders here: <a href="https://webpack.js.org/loaders/" target="_blank" rel="noopener noreferrer">https://webpack.js.org/loaders/</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="plugins-1">Plugins<a href="https://johnnyreilly.com/webpack-overview#plugins-1" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>We've covered loaders, now we'll cover plugins. Plugins allow you to do all kinds of things with webpack. The definition in the webpack documentation is delightfully broad:</p>
<blockquote>
<p>Plugins are the backbone of webpack. ... They serve the purpose of doing anything else that a loader cannot do.</p>
</blockquote>
<p>This is helpful when you remind yourself that a loader takes a file, processes it, and passes the output of that processing to webpack. It is single-file-oriented, if you like. A plugin is what you use when you want to do something that isn't single-file-oriented.</p>
<p>So maybe it's easier to give you some examples. We already have one plugin in our app, the <code>HtmlWebpackPlugin</code>. This plugin generates an HTML file that includes our bundled JavaScript file(s).</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="defineplugin"><code>DefinePlugin</code><a href="https://johnnyreilly.com/webpack-overview#defineplugin" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h4>
<p>Let's add another plugin to our app. We'll add the <a href="https://webpack.js.org/plugins/define-plugin/" target="_blank" rel="noopener noreferrer"><code>DefinePlugin</code></a>. This plugin allows you to define global constants that can be used in your code. Let's add it to our <code>webpack.config.js</code> file:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token plain">const path = require("path");</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">const webpack = require("webpack");</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token plain">const HtmlWebpackPlugin = require("html-webpack-plugin");</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">module.exports = {</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> mode: "development",</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> entry: './src/index.ts', // the entry point of our app https://webpack.js.org/concepts/entry-points/</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> devtool: "inline-source-map",</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> plugins: [</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     new HtmlWebpackPlugin(),</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">      new webpack.DefinePlugin({</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">        'MODE': JSON.stringify("PRODUCTION"),</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">      })</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> ],</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> module: {</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   rules: [</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     {</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">       test: /\.([cm]?ts|tsx)$/,</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">       loader: 'ts-loader',</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     },</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   ],</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> },</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> output: {</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   filename: "[name].[contenthash].js",</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   path: path.resolve(__dirname, "dist"),</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   clean: true,</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> },</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With the change above, we've added the <code>DefinePlugin</code> to our list of plugins. We've also defined a global constant called <code>MODE</code> that will be available in our code. We've set the value of <code>MODE</code> to be the value of the <code>NODE_ENV</code> environment variable. We'll use this in our code in a moment.</p>
<p>Let's update our <code>src/index.ts</code> file to use the <code>MODE</code> constant, and tell TypeScript about it:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">declare const MODE: string;</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">function app(): HTMLDivElement {</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> const element = document.createElement("div");</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token deleted-sign deleted prefix deleted" style="color:rgba(239, 83, 80, 0.56)">-</span><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)">  element.innerHTML = 'Hello, webpack';</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">  element.innerHTML = `Hello, webpack, we are in ${MODE} mode.`;</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> return element;</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token plain">}</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">document.body.appendChild(app());</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now if we build our app, we'll see that the <code>MODE</code> constant is available in our code, and we can use it. At runtime it will be replaced with the value we defined in our <code>webpack.config.js</code> file and our app will say:</p>
<blockquote>
<p>Hello, webpack, we are in PRODUCTION mode.</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="fork-ts-checker-webpack-plugin"><code>fork-ts-checker-webpack-plugin</code><a href="https://johnnyreilly.com/webpack-overview#fork-ts-checker-webpack-plugin" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h4>
<p>Before we move on, let's add one more plugin to our app. We're going to add the <a href="https://github.com/TypeStrong/fork-ts-checker-webpack-plugin" target="_blank" rel="noopener noreferrer"><code>fork-ts-checker-webpack-plugin</code></a>. This plugin allows you to run the TypeScript compiler in a separate process, and relieve <code>ts-loader</code> of the responsibility of handling type checking. This is useful because it means that webpack can run in parallel with the TypeScript compiler. This can significantly speed up your build times. I have worked on this plugin, as it has a sibling relationship with <code>ts-loader</code>. It's quite common to use both together; <code>ts-loader</code> to compile your code, and <code>fork-ts-checker-webpack-plugin</code> to type check it.</p>
<p>Let's install <code>fork-ts-checker-webpack-plugin</code>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token function" style="color:rgb(250, 208, 0)">npm</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">install</span><span class="token plain"> fork-ts-checker-webpack-plugin --save-dev</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And let's configure it in our <code>webpack.config.js</code> file:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token plain">const path = require("path");</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">const webpack = require("webpack");</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">const HtmlWebpackPlugin = require("html-webpack-plugin");</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">const ForkTsCheckerWebpackPlugin = require('fork-ts-checker-webpack-plugin');</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">module.exports = {</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> mode: "development",</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> entry: './src/index.ts', // the entry point of our app https://webpack.js.org/concepts/entry-points/</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> devtool: "inline-source-map",</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> plugins: [</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     new HtmlWebpackPlugin(),</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     new webpack.DefinePlugin({</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">       'MODE': JSON.stringify('PRODUCTION'),</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     }),</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">      new ForkTsCheckerWebpackPlugin()</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> ],</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> module: {</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   rules: [</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     {</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">       test: /\.([cm]?ts|tsx)$/,</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">       loader: 'ts-loader',</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">        // we only need to explicitly specify transpileOnly option if you use ts-loader &lt; 9.3.0</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">        options: {</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">          transpileOnly: true</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">        }</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     },</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   ],</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> },</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> output: {</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   filename: "[name].[contenthash].js",</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   path: path.resolve(__dirname, "dist"),</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   clean: true,</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> },</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We can see here that we're providing some configuration to <code>ts-loader</code>; setting it to <code>transpileOnly: true</code>. This means that <code>ts-loader</code> will only transpile our code, and not type check it. We're also adding the <code>ForkTsCheckerWebpackPlugin</code> to our list of plugins. This will run the TypeScript compiler in a separate process and perform type checking there.</p>
<p>It's worth noting that because of <a href="https://github.com/TypeStrong/ts-loader/pull/1451" target="_blank" rel="noopener noreferrer">this excellent PR</a> by the primary maintainer <a href="https://github.com/piotr-oles" target="_blank" rel="noopener noreferrer">Piotr Ole≈õ</a>, we don't need to explicitly specify <code>transpileOnly: true</code> anymore. It's the default behaviour of <code>ts-loader</code> when the <code>fork-ts-checker-webpack-plugin</code> is detected. I've left it in the example above to illustrate what configuring a loader looks like.</p>
<p>To test that this is working, let's add a type error to our <code>src/index.ts</code> file:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token plain">declare const MODE: string;</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">function app(): HTMLDivElement {</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> const element = document.createElement("div");</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> element.innerHTML = `Hello, webpack, we are in ${MODE} mode.`;</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token unchanged line"></span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token deleted-sign deleted prefix deleted" style="color:rgba(239, 83, 80, 0.56)">-</span><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)">  return element;</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">  return elemen;</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)"></span><span class="token plain">}</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">document.body.appendChild(app());</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And let's build our app:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token function" style="color:rgb(250, 208, 0)">npm</span><span class="token plain"> run build</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token operator" style="color:rgb(255, 157, 0)">&gt;</span><span class="token plain"> hello-webpack@1.0.0 build</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token operator" style="color:rgb(255, 157, 0)">&gt;</span><span class="token plain"> webpack build </span><span class="token parameter variable" style="color:rgb(255, 238, 128)">--mode</span><span class="token plain"> production</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">assets by status </span><span class="token number" style="color:rgb(255, 98, 140)">1.09</span><span class="token plain"> KiB </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">cached</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">2</span><span class="token plain"> assets</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">./src/index.ts </span><span class="token number" style="color:rgb(255, 98, 140)">204</span><span class="token plain"> bytes </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">built</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">code generated</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">ERROR </span><span class="token keyword" style="color:rgb(255, 157, 0)">in</span><span class="token plain"> ./src/index.ts:8:10</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">TS2552: Cannot </span><span class="token function" style="color:rgb(250, 208, 0)">find</span><span class="token plain"> name </span><span class="token string" style="color:rgb(165, 255, 144)">'elemen'</span><span class="token builtin class-name" style="color:rgb(250, 208, 0)">.</span><span class="token plain"> Did you mean </span><span class="token string" style="color:rgb(165, 255, 144)">'element'</span><span class="token plain">?</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">     </span><span class="token number" style="color:rgb(255, 98, 140)">6</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">|</span><span class="token plain">   element.innerHTML </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(255, 238, 128)">`</span><span class="token variable" style="color:rgb(255, 238, 128)">Hello, webpack, we are </span><span class="token variable keyword" style="color:rgb(255, 157, 0)">in</span><span class="token variable" style="color:rgb(255, 238, 128)"> $</span><span class="token variable punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token variable" style="color:rgb(255, 238, 128)">MODE</span><span class="token variable punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token variable" style="color:rgb(255, 238, 128)"> mode.</span><span class="token variable" style="color:rgb(255, 238, 128)">`</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">     </span><span class="token number" style="color:rgb(255, 98, 140)">7</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token operator" style="color:rgb(255, 157, 0)">&gt;</span><span class="token plain">  </span><span class="token number" style="color:rgb(255, 98, 140)">8</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">|</span><span class="token plain">   </span><span class="token builtin class-name" style="color:rgb(250, 208, 0)">return</span><span class="token plain"> elemen</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">       </span><span class="token operator" style="color:rgb(255, 157, 0)">|</span><span class="token plain">          ^^^^^^</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">     </span><span class="token number" style="color:rgb(255, 98, 140)">9</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">|</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token number" style="color:rgb(255, 98, 140)">10</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token number" style="color:rgb(255, 98, 140)">11</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">|</span><span class="token plain"> document.body.appendChild</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">))</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">webpack </span><span class="token number" style="color:rgb(255, 98, 140)">5.89</span><span class="token plain">.0 compiled with </span><span class="token number" style="color:rgb(255, 98, 140)">1</span><span class="token plain"> error </span><span class="token keyword" style="color:rgb(255, 157, 0)">in</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">1710</span><span class="token plain"> ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We can see that the TypeScript compiler has picked up our type error. If we remove the <code>fork-ts-checker-webpack-plugin</code> from our list of plugins, we'll see that the type error is no longer picked up:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token function" style="color:rgb(250, 208, 0)">npm</span><span class="token plain"> run build</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token operator" style="color:rgb(255, 157, 0)">&gt;</span><span class="token plain"> hello-webpack@1.0.0 build</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token operator" style="color:rgb(255, 157, 0)">&gt;</span><span class="token plain"> webpack build </span><span class="token parameter variable" style="color:rgb(255, 238, 128)">--mode</span><span class="token plain"> production</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">asset main.a1d11e49d0129cad93aa.js </span><span class="token number" style="color:rgb(255, 98, 140)">885</span><span class="token plain"> bytes </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">emitted</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">immutable</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">minimized</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">name: main</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">asset index.html </span><span class="token number" style="color:rgb(255, 98, 140)">235</span><span class="token plain"> bytes </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">emitted</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">compared </span><span class="token keyword" style="color:rgb(255, 157, 0)">for</span><span class="token plain"> emit</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">./src/index.ts </span><span class="token number" style="color:rgb(255, 98, 140)">204</span><span class="token plain"> bytes </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">built</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">code generated</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">webpack </span><span class="token number" style="color:rgb(255, 98, 140)">5.89</span><span class="token plain">.0 compiled successfully </span><span class="token keyword" style="color:rgb(255, 157, 0)">in</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">772</span><span class="token plain"> ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>So we can see that the <code>fork-ts-checker-webpack-plugin</code> is working.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="using-plugins-and-loaders---some-resources">Using plugins and loaders - some resources<a href="https://johnnyreilly.com/webpack-overview#using-plugins-and-loaders---some-resources" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>We've seen a number of examples of plugins. Almost all customisation of webpack is done through plugins and loaders. If you want to do something with webpack, it's likely that there's a plugin or loader that will help you do it. If you want to learn more about plugins and loaders, I recommend the following resources:</p>
<ul>
<li><a href="https://blog.logrocket.com/how-detect-dead-code-frontend-project/#using-webpack-for-dead-code-detection" target="_blank" rel="noopener noreferrer">How to detect dead code in a frontend project</a></li>
<li><a href="https://blog.logrocket.com/tree-shaking-json-files-webpack/" target="_blank" rel="noopener noreferrer">Tree shaking JSON files with webpack</a></li>
<li><a href="https://blog.logrocket.com/tree-shaking-and-code-splitting-in-webpack/" target="_blank" rel="noopener noreferrer">Tree shaking and code splitting in webpack</a></li>
<li><a href="https://blog.logrocket.com/building-micro-frontends-webpacks-module-federation/" target="_blank" rel="noopener noreferrer">Building micro-frontends with webpack‚Äôs Module Federation</a></li>
<li><a href="https://blog.logrocket.com/speed-up-your-webpack-build-with-the-dll-plugin/" target="_blank" rel="noopener noreferrer">Improve your webpack build with the DLL plugin</a></li>
<li><a href="https://blog.logrocket.com/slimming-down-your-bundle-size/" target="_blank" rel="noopener noreferrer">Slimming down your bundle size</a></li>
<li><a href="https://blog.logrocket.com/parsing-raw-text-inputs-in-web-applications-using-antlr/" target="_blank" rel="noopener noreferrer">Parsing raw text inputs in web applications using ANTLR</a></li>
<li><a href="https://blog.logrocket.com/guide-performance-optimization-webpack/" target="_blank" rel="noopener noreferrer">An in-depth guide to performance optimization with webpack</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="webpack-and-the-competition">webpack and the competition<a href="https://johnnyreilly.com/webpack-overview#webpack-and-the-competition" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>There has been a lot of competition in the bundler space. For a long time, webpack has been the most popular bundler. But it's not the only game in town, and never has been. It's beyond the scope of this article to do a full comparison of webpack and its competitors, but there's some excellent articles out there that do just that:</p>
<ul>
<li><a href="https://blog.logrocket.com/snowpack-vs-webpack-build-tool-comparison/" target="_blank" rel="noopener noreferrer">Snowpack vs. webpack: A build tool comparison</a></li>
<li><a href="https://blog.logrocket.com/migrating-swc-webpack-babel-overview/" target="_blank" rel="noopener noreferrer">Migrating to SWC: A brief overview</a></li>
<li><a href="https://blog.logrocket.com/webpack-or-esbuild-why-not-both/" target="_blank" rel="noopener noreferrer">webpack or esbuild: Why not both?</a></li>
<li><a href="https://blog.logrocket.com/switching-to-parcel-from-webpack/" target="_blank" rel="noopener noreferrer">Switching to Parcel from webpack</a></li>
<li><a href="https://blog.logrocket.com/migrate-rspack-webpack/" target="_blank" rel="noopener noreferrer">Why you should migrate to Rspack from webpack</a></li>
<li><a href="https://blog.logrocket.com/introducing-turbopack-rust-based-successor-webpack/" target="_blank" rel="noopener noreferrer">Introducing Turbopack: A Rust-based successor to webpack</a></li>
<li><a href="https://blog.logrocket.com/benchmarking-bundlers-2020-rollup-parcel-webpack/" target="_blank" rel="noopener noreferrer">Benchmarking bundlers 2020: Rollup vs. Parcel vs. webpack</a></li>
</ul>
<p>For the longest time, webpack has been the most popular bundler. Apparently incapable of being dislodged from that position. However, it looks like that might be changing. If we look at the npm download stats for webpack for the last five years, we can see that, for the first time, its popularity is starting to decrease. It's still the most popular bundler, but it's starting to decrease in popularity and competitors are starting to increase. This chart shows the npm download stats for webpack, esbuild, swc and vite over the last five years:</p>
<p><img decoding="async" loading="lazy" alt="screenshot of a chart comparing webpack, esbuild, swc and vite usage over the years 2018-2023" src="https://johnnyreilly.com/assets/images/screenshot-stats-webpack-vite-esbuild-swc-295249030dd5a3b6ff745b70530ab903.webp" width="2654" height="1070" class="img_ev3q"></p>
<p><a href="https://vitejs.dev/" target="_blank" rel="noopener noreferrer">Vite</a> is a bundler that came out of the Vue ecosystem. It's a very fast bundler that uses esbuild under the hood. <a href="https://esbuild.github.io/" target="_blank" rel="noopener noreferrer">esbuild</a> is a bundler that came out of the Go ecosystem. <a href="https://github.com/swc-project/swc" target="_blank" rel="noopener noreferrer">swc</a> is a super-fast TypeScript / JavaScript compiler written in Rust. All of these compete with webpack in some way.</p>
<p>The thing to note about all these competitors is that they are all faster than webpack. There's a reason for that. webpack is written in JavaScript. For most of the history of bundlers, JavaScript was what bundlers were implemented in. But the next generation of tools are written in other languages. esbuild is written in Go. swc is written in Rust. These languages have allowed massively improved performance. In terms of speed, webpack cannot compete with these tools. It's worth noting that even the creator of webpack, Tobias Koppers is now working on a <a href="https://turbo.build/pack" target="_blank" rel="noopener noreferrer">Rust-based successor to webpack named Turbopack</a>.</p>
<p>Next generation tools keep appearing. <a href="https://blog.logrocket.com/bun-adoption-guide/" target="_blank" rel="noopener noreferrer">Bun</a> is an alternative JavaScript runtime, implemented in Zig. It also ships with its own built in <a href="https://bun.sh/docs/bundler" target="_blank" rel="noopener noreferrer">Bun bundler</a> which is reportedly even faster than esbuild and Rspack! We're likely to see even more of these tools in the future.</p>
<p>Speed is a very attractive proposition, and as we can see, we're starting to see the community move away from webpack. It's not a mass exodus, when people are starting new projects now, they're more than likely to use one of the newer tools. When I've started a new project over the last year I've tended to use Vite. I've not used webpack for a new project for a long time. I'm not alone in this.</p>
<p>To be clear: webpack is not going anywhere. But it's fair to say that it is starting to be displaced by some of the newer tools. This trend is only going to continue.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://johnnyreilly.com/webpack-overview#conclusion" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>In this article we've looked at what webpack is, and why it's so popular. We've looked at its history, and how it came to be the most popular bundler. We've examined how to get started with webpack, some of the high level concepts such as plugins and loaders. We've also considered some of the competition, and how webpack is starting to be displaced by some of the newer tools.</p>
<p><a href="https://blog.logrocket.com/webpack-adoption-guide/" target="_blank" rel="noopener noreferrer">This post was originally published on LogRocket.</a></p>
]]></content:encoded>
            <category>webpack</category>
        </item>
        <item>
            <title><![CDATA[Large Language Models, Open API, View Models and the Backend for Frontend Pattern]]></title>
            <link>https://johnnyreilly.com/large-language-models-view-models-backend-for-frontend</link>
            <guid>https://johnnyreilly.com/large-language-models-view-models-backend-for-frontend</guid>
            <pubDate>Sat, 04 May 2024 16:42:12 GMT</pubDate>
            <description><![CDATA[To integrate LLMs with APIs, there is a need for the LLM equivalent of view models and the backend for frontend pattern. This discusses it in the context of Semantic Kernel.]]></description>
            <content:encoded><![CDATA[<p>Of late, I've been involved in work to integrate APIs into LLM interactions, using <a href="https://github.com/microsoft/semantic-kernel" target="_blank" rel="noopener noreferrer">Semantic Kernel</a>. This post is something of a brain dump on the topic. Given how fast this space is moving, I expect what is written here to be out of date, possibly even <em>before</em> I hit publish. But nevertheless, I hope it's useful.</p>
<p><img decoding="async" loading="eager" alt="title image reading &amp;quot;Large Language Models, Open API, View Models and the Backend for Frontend Pattern&amp;quot; with the Azure Open AI / Swagger logos" src="https://johnnyreilly.com/assets/images/title-image-bed363141bbcb8dfb82b1db42671f1d0.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="swagger--open-api-and-semantic-kernel">Swagger / Open API and Semantic Kernel<a href="https://johnnyreilly.com/large-language-models-view-models-backend-for-frontend#swagger--open-api-and-semantic-kernel" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>APIs are awesome. Imagine LLMs could interact with APIs to allow us to chat directly to our data. This is what <a href="https://platform.openai.com/docs/guides/function-calling" target="_blank" rel="noopener noreferrer">function calling</a> provides. It allows us to take some kind of API and integrate it with our LLM. This is a powerful concept, but it's not without its challenges.</p>
<p>APIs are often documented in Swagger / Open API. This is a great way to document APIs, but it's not always the best way to interact with them from an LLM point of view. We'll go into more detail on the problems it can present in a moment, but first let's look at how we can use Semantic Kernel to integrate with APIs.</p>
<p>It's completely possible to plug an LLM into an Open API / Swagger spec described API using Semantic Kernel. Here's an example of how we might do that from the <a href="https://github.com/microsoft/semantic-kernel/blob/9a4450622021ce003234863bcf4def9613ae1153/dotnet/samples/Concepts/Plugins/CreatePluginFromOpenApiSpec_Jira.cs#L69-L77" target="_blank" rel="noopener noreferrer">Semantic Kernel GitHub repository</a>:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> apiPluginRawFileURL </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Uri</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"https://raw.githubusercontent.com/microsoft/PowerPlatformConnectors/dev/certified-connectors/JIRA/apiDefinition.swagger.json"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">jiraFunctions </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> kernel</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">ImportPluginFromOpenApiAsync</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token string" style="color:rgb(165, 255, 144)">"jiraPlugin"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    apiPluginRawFileURL</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">OpenApiFunctionExecutionParameters</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        httpClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> tokenProvider</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">AuthenticateRequestAsync</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">serverUrlOverride</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">Uri</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">serverUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The code above is creating a Jira plugin from an Open API spec. Brilliant! We didn't have to do any work; Semantic Kernel has done the heavy lifting for us. It's created a plugin that we can use to interact with Jira. Are you ready for the but?</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-problem-with-swagger--open-api-and-llms">The problem with Swagger / Open API and LLMs<a href="https://johnnyreilly.com/large-language-models-view-models-backend-for-frontend#the-problem-with-swagger--open-api-and-llms" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>The example above illustrates the simplicity of integrating. But what it doesn't reveal is the unfortunate reality that <strong>LLMs are not great at ignoring information</strong>. They will mention information we explicitly tell them not to. Just to spite us.</p>
<p>Let's take the Jira plugin as an example. When using direct Swagger / Open API integration I have found myself writing prompts like this:</p>
<blockquote>
<p>Please tell me about stories that are assigned to me. Please never refer to the stories by their ids - use titles instead.</p>
</blockquote>
<p>Only to find that in the responses the LLM will <em>still</em> refer to the stories by their ids.</p>
<p>It's a bit like having a child who you've told not to do something, only to find they've done it anyway. The LLM may even cheekily say something like "I know you told me not too, but I included the id for reference". The scallywag.</p>
<p>Or perhaps, given the variety of endpoints that are available in an API, the LLM will call one that we didn't want it to. Or perhaps our Swagger / Open API spec is poorly documented, and the LLM doesn't think it has an endpoint it can call.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="view-models-and-the-bffs-to-the-rescue">View models and the BFFs to the rescue<a href="https://johnnyreilly.com/large-language-models-view-models-backend-for-frontend#view-models-and-the-bffs-to-the-rescue" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>A useful framing for this problem is remembering when ORMs started to automate access to databases. We could take our ORM, and host it in a web service and, hey presto, our database was now accessible over HTTP. So let's take our React app (or whatever) and have it talk directly to our database.</p>
<p>Except, of course, that's a terrible idea. We don't want our front end talking to our database. There's a number of reasons why:</p>
<ul>
<li>Too much information going backwards and forward between client and server (perhaps including information we'd never like clients to see).</li>
<li>Security; why are we exposing our database to updates directly from the internet? Is that wise?</li>
</ul>
<p>You get the picture. We tend not to integrate our databases directly with our front ends with good reason.</p>
<p>A common approach to tackle these issues is employing the <a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/backends-for-frontends" target="_blank" rel="noopener noreferrer">back end for front ends (BFF) pattern</a>; having something that sits between our front end and our database. One of the things the BFF does is to provide a view of the data that is appropriate for the client. So for example, exposing a <a href="https://en.wikipedia.org/wiki/View_model" target="_blank" rel="noopener noreferrer">view model</a> in the back end to serve the front end. It's a way to ensure that only the necessary information is exposed to the client.</p>
<p>We can take this idea and apply it to building integrations with APIs and LLMs. So rather than plugging a Swagger / Open API spec into Semantic Kernel, instead build a custom plugin that manages access to our API, and have it expose view models for providing data to LLMs.</p>
<p>That way we can ensure that only the necessary information is given to the LLM, and our answers do not contain data we would rather not see.</p>
<p>So rather than giving an LLM a data structure like this:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"stories"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"id"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">1</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"title"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Story 1"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"description"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"This is the first story"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//... MANY MORE FIELDS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"id"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">2</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"title"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Story 2"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"description"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"This is the second story"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">//... MANY MORE FIELDS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We give it the trimmed down equivalent:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"stories"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"title"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Story 1"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"description"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"This is the first story"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"title"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Story 2"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"description"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"This is the second story"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This has the combined benefit of reducing our token usage / cost (as we're sending less data to the LLM) and reducing the risk of exposing data we'd rather not.</p>
<p>It also has the advantage of allowing us to steer the LLM towards the functions we want it to call. If we only expose the functions we want the LLM to call, then we can ensure that it doesn't call functions we'd rather it didn't.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="but-integrating-with-apis-is-a-lot-of-work">"But integrating with APIs is a lot of work!"<a href="https://johnnyreilly.com/large-language-models-view-models-backend-for-frontend#but-integrating-with-apis-is-a-lot-of-work" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>A common, and quite reasonable, complaint is that integrating with an API involves a lot of work. We have to write some code to interact with the API, and then we have to write the types that we'll use to pass data around. Fortunately there are tools like NSwag that use the Swagger / Open API spec to <a href="https://johnnyreilly.com/generate-typescript-and-csharp-clients-with-nswag">automate creating a client with types to manage API interaction</a>. If we're autogenerating our API clients, then the work of integrating an LLM with an API is significantly reduced.</p>
<p>With Semantic Kernel it effectively is reduced to creating a plugin; and that's quite simple to do. <a href="https://learn.microsoft.com/en-us/semantic-kernel/agents/plugins/using-the-kernelfunction-decorator?tabs=Csharp" target="_blank" rel="noopener noreferrer">There is guidance on how to create a plugin here</a>. So to create a BFF plugin for an API, we'd need to create that plugin, exposing the functions we want to be called. Those functions will internally call into the APIs using the auto-generated Swagger clients and then map that to the view models which we want to expose to the LLM. Imagine something like this:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">record</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">JiraStory</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> Title</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> Description</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token attribute class-name" style="color:rgb(250, 208, 0)">KernelFunction</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token attribute class-name" style="color:rgb(250, 208, 0)">Description</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token attribute attribute-arguments string" style="color:rgb(165, 255, 144)">"Provides stories for a given user"</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token attribute target keyword" style="color:rgb(255, 157, 0)">return</span><span class="token attribute punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token attribute"> </span><span class="token attribute class-name" style="color:rgb(250, 208, 0)">Description</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token attribute attribute-arguments string" style="color:rgb(165, 255, 144)">"Jira user stories for the given user"</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">Task</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">JiraStory</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">GetUsersJiraStories</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token class-name" style="color:rgb(250, 208, 0)">Kernel</span><span class="token plain"> kernel</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token attribute class-name" style="color:rgb(250, 208, 0)">Description</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token attribute attribute-arguments string" style="color:rgb(165, 255, 144)">"Email of user to filter by"</span><span class="token attribute attribute-arguments punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> userEmail</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> stories </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">await</span><span class="token plain"> _jiraClient</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetStories</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">userEmail</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> stories</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Select</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">story </span><span class="token operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">JiraStory</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">title</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> story</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Title</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token named-parameter punctuation" style="color:rgb(255, 255, 255)">description</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> story</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Description</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">ToArray</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The code above exposes a well defined function to the LLM, which will return the stories for a given user. The function internally calls into the Jira API, and then maps the large amount of data returned from the API to a much slimmer view model that is appropriate for the LLM. As we can see, this was very little work indeed!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://johnnyreilly.com/large-language-models-view-models-backend-for-frontend#conclusion" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>The integrated support for consuming Open API / Swagger specs is definitely going to improve over time, both in Semantic Kernel and in the wider ecosystem. However, it's possible that there is fundamental issue that needs to be solved, and that BFFs for LLMs may solve it. It's a way to ensure that only the necessary information is exposed to LLMs, and that the answers they give are appropriate for the context in which they are being used.</p>
<p>I'm not aware of a specific name for this pattern as yet. My colleague, Ryan suggested "Frontend for Language Models" (FLM) which is less of a mouthful than "Backend for Frontends for Language Models". Naming things is hard.</p>
<p>Another colleague (Rick), suggested that perhaps the BFF for LLMs could be built directly into APIs. So rather than having to implement a custom plugin that manages the interaction with API, we could still perhaps use the Swagger / Open API approach and avoid the custom plugin implementation. This is an interesting idea.</p>
<p>Many thanks to <a href="https://github.com/drosevear" target="_blank" rel="noopener noreferrer">David Rosevear</a>, <a href="https://www.linkedin.com/in/george-karsas" target="_blank" rel="noopener noreferrer">George Karsas</a>, <a href="https://www.rickroche.com/" target="_blank" rel="noopener noreferrer">Rick Roch√©</a>, <a href="https://github.com/RyanMatCook" target="_blank" rel="noopener noreferrer">Ryan Cook</a> and <a href="https://uk.linkedin.com/in/alisomer" target="_blank" rel="noopener noreferrer">Ali Somer</a> whose thoughts, ideas and experimentation have fed into the thinking in this post.</p>]]></content:encoded>
            <category>azure</category>
            <category>c#</category>
            <category>ai</category>
        </item>
        <item>
            <title><![CDATA[Snapshot log tests in .NET]]></title>
            <link>https://johnnyreilly.com/snapshot-log-tests-dotnet</link>
            <guid>https://johnnyreilly.com/snapshot-log-tests-dotnet</guid>
            <pubDate>Wed, 03 Jan 2024 16:12:50 GMT</pubDate>
            <description><![CDATA[This post demonstrates how to write high quality and low effort log assertions using snapshot testing.]]></description>
            <content:encoded><![CDATA[<p>Writing tests is important. The easier it is to write tests, the more likely they'll be written. I've long loved snapshot testing for this reason. Snapshot testing takes away the need to manually write verification code in your tests. Instead, you write tests that compare the output of a call to your method with JSON serialised output you've generated on a previous occasion. This approach takes less time to write, less time to maintain, and the solid readability of JSON makes it more likely you'll pick up on bugs. It's so much easier to scan JSON than it is a list of assertions.</p>
<p>Loving snapshot testing as I do, I want to show you how to write high quality and low effort log assertions using snapshot testing. The behaviour of logging code is really important; it's this that we tend to rely upon when debugging production issues. But how do you test logging code? Well, you could write a bunch of assertions that check how your logger is used. But that's a lot of work, it's not super readable and it's not fun. (Always remember: if it's not fun, you're doing it wrong.)</p>
<p>Instead, we'll achieve this using snapshot testing.</p>
<p><img decoding="async" loading="eager" alt="title image reading &amp;quot;Snapshot log tests in .NET&amp;quot; with the .NET logo" src="https://johnnyreilly.com/assets/images/title-image-86eb28c76643a3ea99cad34ff1006d94.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<p>I've written previously about <a href="https://johnnyreilly.com/snapshot-testing-for-c">manually implementing snapshot testing with .NET</a>. That was great, but I subsequently moved to use the excellent <a href="https://github.com/SwissLife-OSS/snapshooter" target="_blank" rel="noopener noreferrer">Snapshooter</a> instead. In this post we'll use that. I'm using XUnit as my test framework; but Snapshooter also supports MSTest and NUnit if they are your preference.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-test-ilogger">How to test <code>ILogger</code>?<a href="https://johnnyreilly.com/snapshot-log-tests-dotnet#how-to-test-ilogger" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Before we get into the details of how to test logging code, let's first consider how we might test a method that uses <code>ILogger</code>. Here's a simple example:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Microsoft</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Extensions</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Logging</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">namespace</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">MyApp</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Tests</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">GreetingService</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">GreetingService</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> log</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">GreetingService</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> _log </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> log</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">GetGreeting</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _log</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">LogInformation</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Greeting {{</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:rgb(255, 157, 0)">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token interpolation-string interpolation expression language-csharp">name</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">}}"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> </span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">$"Hello, </span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token interpolation-string interpolation expression language-csharp">name</span><span class="token interpolation-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token interpolation-string string" style="color:rgb(165, 255, 144)">!"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If we look at the class above, we can see it has a dependency on <code>ILogger&lt;GreetingService&gt;</code>. This is a common pattern in .NET applications. The <code>ILogger</code> interface is used to write log messages. I wouldn't be surprised if it's the most commonly used interface in .NET applications.</p>
<p>If we execute the <code>GetGreeting</code> method above, we'll both get a greeting returned and a log message will be written. In order that we can test this method, we need to be able to verify that the log message was written correctly. We're going to do that by making use of a fake logger.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="fakelogger"><code>FakeLogger</code><a href="https://johnnyreilly.com/snapshot-log-tests-dotnet#fakelogger" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>As of .NET 8, there is a <code>FakeLogger</code> that ships as part of .NET. You can read more about that here: <a href="https://devblogs.microsoft.com/dotnet/fake-it-til-you-make-it-to-production/#logging-fake" target="_blank" rel="noopener noreferrer">https://devblogs.microsoft.com/dotnet/fake-it-til-you-make-it-to-production/#logging-fake</a></p>
<p>We're going to make use of the official <code>FakeLogger</code> in this post. However, I'm mindful that not everyone is on .NET 8 yet. So, I'm going to show you how to implement a fake logger yourself. So if you're on .NET 6 / .NET 7 then you can use this.</p>
<p>Whichever fake logger we use, it is a simple implementation of <code>ILogger&lt;T&gt;</code>. It's a fake because it doesn't actually write anything to a log. Instead, it records the log messages it's asked to write in a list of <code>FakeLogRecord</code>. We can then use this list to verify that the log messages were written correctly.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="fakelogger-for-net-8"><code>FakeLogger</code> for .NET 8+<a href="https://johnnyreilly.com/snapshot-log-tests-dotnet#fakelogger-for-net-8" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>If you're working with .NET 8 or later, you can use the <code>FakeLogger</code> that ships with .NET. To add this to your project, add the <a href="https://www.nuget.org/packages/Microsoft.Extensions.Logging.Testing" target="_blank" rel="noopener noreferrer"><code>Microsoft.Extensions.Logging.Testing</code></a> and <a href="https://www.nuget.org/packages/Microsoft.Extensions.TimeProvider.Testing" target="_blank" rel="noopener noreferrer"><code>Microsoft.Extensions.TimeProvider.Testing</code></a> packages to your test project:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token plain">dotnet </span><span class="token function" style="color:rgb(250, 208, 0)">add</span><span class="token plain"> package Microsoft.Extensions.Diagnostics.Testing</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">dotnet </span><span class="token function" style="color:rgb(250, 208, 0)">add</span><span class="token plain"> package Microsoft.Extensions.TimeProvider.Testing</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="fakelogger-for-earlier-net-versions"><code>FakeLogger</code> for earlier .NET versions<a href="https://johnnyreilly.com/snapshot-log-tests-dotnet#fakelogger-for-earlier-net-versions" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h4>
<p>If you're working with an earlier version of .NET, you can implement a fake logger yourself:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Microsoft</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Extensions</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Logging</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">namespace</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">MyApp</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Tests</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">TestUtilities</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">record</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">FakeLogRecord</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">LogLevel</span><span class="token plain"> Level</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token plain"> Message</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> Exception</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">FakeLogger</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">T</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token type-list class-name" style="color:rgb(250, 208, 0)">ILogger</span><span class="token type-list class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token type-list class-name" style="color:rgb(250, 208, 0)">T</span><span class="token type-list class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">IReadOnlyList</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">FakeLogRecord</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">GetSnapshot</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> _records</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">List</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">FakeLogRecord</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> _records </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">IDisposable</span><span class="token return-type class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> </span><span class="token generic-method function" style="color:rgb(250, 208, 0)">BeginScope</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)">TState</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">TState</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">where</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">TState</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token type-list keyword" style="color:rgb(255, 157, 0)">notnull</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> NullScope</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Instance</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:rgb(255, 157, 0)">bool</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">IsEnabled</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">LogLevel</span><span class="token plain"> logLevel</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:rgb(255, 157, 0)">void</span><span class="token plain"> </span><span class="token generic-method function" style="color:rgb(250, 208, 0)">Log</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token generic-method generic class-name" style="color:rgb(250, 208, 0)">TState</span><span class="token generic-method generic class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token class-name" style="color:rgb(250, 208, 0)">LogLevel</span><span class="token plain"> logLevel</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">EventId</span><span class="token plain"> eventId</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">TState</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">Exception</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token plain"> exception</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">Func</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token class-name" style="color:rgb(250, 208, 0)">TState</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token class-name" style="color:rgb(250, 208, 0)"> Exception</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">?</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token class-name" style="color:rgb(250, 208, 0)"> </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">string</span><span class="token class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token plain"> formatter</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        _records</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Add</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">FakeLogRecord</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">logLevel</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">formatter</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">state</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> exception</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> exception</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">/// &lt;summary&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">/// Reference: https://github.com/aspnet/Logging/blob/master/src/Microsoft.Extensions.Logging.Abstractions/Internal/NullScope.cs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">/// &lt;/summary&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">sealed</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">NullScope</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token type-list class-name" style="color:rgb(250, 208, 0)">IDisposable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">static</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(250, 208, 0)">NullScope</span><span class="token plain"> Instance </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">get</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">NullScope</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">private</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">NullScope</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:rgb(255, 157, 0)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">Dispose</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This implementation is inspired by both the .NET 8 <code>FakeLogger</code> implementation and <a href="https://pnguyen.io/posts/verify-ilogger-call-in-dotnet-core/" target="_blank" rel="noopener noreferrer">David Nguyen's post</a>. It's not identical to the official implementation, but it's close enough for our purposes.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="testing-ilogger-with-snapshooter">Testing <code>ILogger</code> with Snapshooter<a href="https://johnnyreilly.com/snapshot-log-tests-dotnet#testing-ilogger-with-snapshooter" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Now that we have a fake logger, we can use it to test the logging caused by calling our <code>GetGreeting</code> method.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="testing-ilogger-with-snapshooter-for-net-8">Testing <code>ILogger</code> with Snapshooter for .NET 8+<a href="https://johnnyreilly.com/snapshot-log-tests-dotnet#testing-ilogger-with-snapshooter-for-net-8" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Here's how we might do that with our .NET 8 <code>FakeLogger</code>:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Microsoft</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Extensions</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Logging</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Testing</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Microsoft</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Extensions</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Options</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Microsoft</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Extensions</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Time</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Testing</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Snapshooter</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Xunit</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">namespace</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">MyApp</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Tests</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">GreetingServiceTests</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token attribute class-name" style="color:rgb(250, 208, 0)">Fact</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:rgb(255, 157, 0)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">GetGreeting_greets_and_logs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// Arrange</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> fixedTimeLogCollector </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">FakeLogCollector</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">Options</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Create</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">FakeLogCollectorOptions</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            TimeProvider </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">FakeTimeProvider</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> log </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">FakeLogger</span><span class="token constructor-invocation class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">GreetingService</span><span class="token constructor-invocation class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">fixedTimeLogCollector</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> greetingService </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">GreetingService</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">log</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// Act</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> greeting </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> greetingService</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetGreeting</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"John"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// Assert</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        Snapshot</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Match</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> log </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> log</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token plain">Collector</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetSnapshot</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> greeting </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here, we create an instance of <code>FakeLogger&lt;GreetingService&gt;</code>. That <code>FakeLogger</code> is instantiated with an instance of <code>FakeLogCollector</code>. We're doing this because we want to stub out the time provider. If we don't do this, the log messages will contain the current time. That would will make our snapshot tests brittle. By stubbing out the time provider, we can ensure that the log messages will always contain the same time. This will make our snapshot tests more robust.</p>
<p>If you'd like to learn more about stubbing out the time provider, I recommend you read <a href="https://andrewlock.net/exploring-the-dotnet-8-preview-avoiding-flaky-tests-with-timeprovider-and-itimer/#testing-with-the-microsoft-extensions-timeprovider-testing-library" target="_blank" rel="noopener noreferrer">Andrew Lock's post on the subject</a>.</p>
<p>Our <code>FakeLogger</code> is passed into the <code>GreetingService</code> constructor, ready to be used. We call <code>GetGreeting</code>, and then we use Snapshooter to verify that the log messages were written correctly and that the greeting generated is what we expect. The log messages are acquired by calling the <code>GetSnapshot</code> method of the <code>FakeLogCollector</code>.</p>
<p>When the test is first run, a <code>GreetingServiceTests.GetGreeting_greets_and_logs.snap</code> snapshot is created. This snapshot contains the serialised <code>log</code> and <code>greeting</code> objects. Subsequent runs of the test will compare the current output with the snapshot. If the output matches the snapshot, the test passes. If it doesn't, the test fails. Here is what the contents of the snapshot should look like:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"log"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"Level"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Information"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"Id"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">"Id"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">0</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token property" style="color:rgb(255, 157, 0)">"Name"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token null keyword" style="color:rgb(255, 157, 0)">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"State"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">"Key"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"name"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">"Value"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"John"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">"Key"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"{OriginalFormat}"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">"Value"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Greeting {name}"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"StructuredState"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">"Key"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"name"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">"Value"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"John"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">"Key"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"{OriginalFormat}"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token property" style="color:rgb(255, 157, 0)">"Value"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Greeting {name}"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"Exception"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token null keyword" style="color:rgb(255, 157, 0)">null</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"Message"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Greeting John"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"Scopes"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"Category"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"MyApp.Tests.Services.GreetingService"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"LevelEnabled"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 98, 140)">true</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"Timestamp"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"2000-01-01T00:00:00+00:00"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"greeting"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Hello, John!"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And that's it, we're done! We've tested our logging code with minimal effort; the only assertion we wrote was <code>Snapshot.Match</code>. If we change behaviour of the <code>GetGreeting</code> method, the test will fail. To remedy we can then update the snapshot and we're good to go.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="testing-ilogger-with-snapshooter-for-earlier-net-versions">Testing <code>ILogger</code> with Snapshooter for earlier .NET versions<a href="https://johnnyreilly.com/snapshot-log-tests-dotnet#testing-ilogger-with-snapshooter-for-earlier-net-versions" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>If we were using our own <code>FakeLogger</code> implementation, we'd almost the same thing:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token keyword" style="color:rgb(255, 157, 0)">using</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">Snapshooter</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Xunit</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">namespace</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(255, 157, 0)">MyApp</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Tests</span><span class="token namespace punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token namespace" style="color:rgb(255, 157, 0)">Services</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(250, 208, 0)">GreetingServiceTests</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token attribute class-name" style="color:rgb(250, 208, 0)">Fact</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token keyword" style="color:rgb(255, 157, 0)">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:rgb(255, 157, 0)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">GetGreeting_greets_and_logs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// Arrange</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> log </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">FakeLogger</span><span class="token constructor-invocation class-name punctuation" style="color:rgb(255, 255, 255)">&lt;</span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">GreetingService</span><span class="token constructor-invocation class-name punctuation" style="color:rgb(255, 255, 255)">&gt;</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> greetingService </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:rgb(250, 208, 0)">GreetingService</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token plain">log</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// Act</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(255, 157, 0)">var</span><span class="token plain"> greeting </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> greetingService</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetGreeting</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token string" style="color:rgb(165, 255, 144)">"John"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// Assert</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        Snapshot</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">Match</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token keyword" style="color:rgb(255, 157, 0)">new</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> log </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> log</span><span class="token punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token function" style="color:rgb(250, 208, 0)">GetSnapshot</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> greeting </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You'll notice that actually less code is involved this time. That's because we don't need to stub out the time provider. Our simple implementation of <code>FakeLogger</code> doesn't bother with time. So we can just call <code>GetSnapshot</code> on the <code>FakeLogger</code> instance.</p>
<p>The snapshot generated by this test will look like this:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"log"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"Level"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Information"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"Message"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Greeting John"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token property" style="color:rgb(255, 157, 0)">"Exception"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token null keyword" style="color:rgb(255, 157, 0)">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token property" style="color:rgb(255, 157, 0)">"greeting"</span><span class="token operator" style="color:rgb(255, 157, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">"Hello, John!"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>There's a lot less information in this snapshot. That's because our simple implementation of <code>FakeLogger</code> doesn't bother with all of the things the official <code>FakeLogger</code> does. But for what we're doing here, it's enough.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://johnnyreilly.com/snapshot-log-tests-dotnet#conclusion" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>In this post we've seen how to use Snapshooter to test logging code.</p>
<p>This approach is easy to implement, easy to maintain and easy to read. Significantly: it involves very little work on our part. If you're not already using snapshot testing, I hope this post has inspired you to give it a try. If you are already using snapshot testing, I hope this post has inspired you to use it to test your logging code.</p>]]></content:encoded>
            <category>asp.net</category>
            <category>c#</category>
            <category>automated testing</category>
        </item>
        <item>
            <title><![CDATA[Schemar: a GitHub Action to validate structured data]]></title>
            <link>https://johnnyreilly.com/schemar-github-action-to-validate-structured-data</link>
            <guid>https://johnnyreilly.com/schemar-github-action-to-validate-structured-data</guid>
            <pubDate>Tue, 02 Jan 2024 12:08:29 GMT</pubDate>
            <description><![CDATA[This post demonstrates how to use Schemar to validate structured data using a GitHub Action.]]></description>
            <content:encoded><![CDATA[<p>Of late, I've found myself getting more and more into structured data. Structured data is a way of adding machine-readable information to web pages. To entertain myself, I liken it to static typing for websites. I've written about structured data before, but in this post I want to focus on how to validate structured data.</p>
<p>Specifically, how can we validate structured data in the context of a GitHub workflow? I've created a GitHub Action called <a href="https://github.com/marketplace/actions/schemar-ci-action" target="_blank" rel="noopener noreferrer">Schemar</a> that facilitates just that. In this post we'll see how to use it.</p>
<p><img decoding="async" loading="eager" alt="title image reading &amp;quot;Schemar: a GitHub Action to validate structured data&amp;quot; with the GitHub Action logo" src="https://johnnyreilly.com/assets/images/title-image-d26eb86d473a706da54606f51a9101b5.png" width="800" height="450" fetchpriority="high" class="img_ev3q"></p>
<p>If you'd like to read more about structured data, you might like to read these posts:</p>
<ul>
<li><a href="https://johnnyreilly.com/structured-data-seo-and-react">Structured data, SEO and React</a></li>
<li><a href="https://johnnyreilly.com/how-we-fixed-my-seo">How we fixed my SEO</a></li>
<li><a href="https://johnnyreilly.com/docusaurus-blogs-adding-breadcrumb-structured-data">Docusaurus blogs: adding breadcrumb structured data</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-schemar">What is Schemar?<a href="https://johnnyreilly.com/schemar-github-action-to-validate-structured-data#what-is-schemar" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Schemar is a GitHub Action that validates structured data. It's a wrapper around the <a href="https://validator.schema.org/" target="_blank" rel="noopener noreferrer">Schema Markup Validator</a> tool.</p>
<p>If you haven't heard of Schema.orgs validator; it originally started at Google as the Structured Data Testing Tool but was <a href="https://developers.google.com/search/blog/2020/12/structured-data-testing-tool-update" target="_blank" rel="noopener noreferrer">repurposed and gifted to the community</a>.</p>
<p>That tool is a website; Schemar is a wrapper around the tool that makes it easy to validate structured data in the context of a GitHub workflow. Let's imagine it's very important to you that your structured data is both present and valid. You could use Schemar to validate your structured data as part of your CI/CD pipeline.</p>
<p>Imagine Schemar to be the structured data equivalent of the <a href="https://github.com/treosh/lighthouse-ci-action" target="_blank" rel="noopener noreferrer"><code>lighthouse-ci-action</code></a> GitHub Action.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-schemar">Using Schemar<a href="https://johnnyreilly.com/schemar-github-action-to-validate-structured-data#using-schemar" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>I'm going to take my blog (that's what you're reading right now BTW) and use Schemar to validate the structured data on it. I already have a GitHub Action that builds and deploys my blog to a staging environment in Azure Static Web Apps and <a href="https://johnnyreilly.com/lighthouse-meet-github-actions">validates it with Lighthouse</a>. So I'm going to add Schemar to that.</p>
<p>But before we do that, let's look at simple usage of Schemar. If you were to add a <code>.github/workflows/schemar.yml</code> file to your repo with the following contents:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token key atrule">jobs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">release</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">runs-on</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> johnnyreilly/schemar@v0.1.1</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">          </span><span class="token key atrule">urls</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain">//johnnyreilly.com</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Validate structured data</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token key atrule">on</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">pull_request</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token null important">~</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">push</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token key atrule">branches</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> main</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then you'd have a GitHub workflow that would validate the structured data on <code>https://johnnyreilly.com</code> and fail if it wasn't valid.</p>
<p>The <code>urls</code> input of Schemar is a list of URLs to validate. In this case, we're just validating only one. The results look like this:</p>
<blockquote>
<p>Validating <a href="https://johnnyreilly.com/" target="_blank" rel="noopener noreferrer">https://johnnyreilly.com</a> for structured data...</p>
<p><a href="https://johnnyreilly.com/" target="_blank" rel="noopener noreferrer">https://johnnyreilly.com</a> has structured data of these types:</p>
<ul>
<li>Organization / Brand</li>
<li>WebSite</li>
<li>Blog</li>
</ul>
<p>For more details see <a href="https://validator.schema.org/#url=https%3A%2F%2Fjohnnyreilly.com" target="_blank" rel="noopener noreferrer">https://validator.schema.org/#url=https%3A%2F%2Fjohnnyreilly.com</a></p>
</blockquote>
<p>We can see that the home page of my blog has structured data of the types <code>Organization / Brand</code>, <code>WebSite</code> and <code>Blog</code>. And we can even click into the Schema Markup Validator to see the details.</p>
<p>If at some point I were to omit or break the structured data on my blog, then Schemar would fail the build. This is a great way to ensure that your structured data is always present and valid.</p>
<p>We're going to see what usage looks like in a minute, as we dive into a more sophisticated example.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="surfacing-schemar-results-in-your-pull-requests">Surfacing Schemar results in your pull requests<a href="https://johnnyreilly.com/schemar-github-action-to-validate-structured-data#surfacing-schemar-results-in-your-pull-requests" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>Now that we've seen a basic example, let's see what it looks like to use Schemar in a more sophisticated way. We're going to add Schemar to run against my blogs pull request previews, in the same way we're already running Lighthouse against them.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="adding-schemar-to-the-github-action">Adding Schemar to the GitHub Action<a href="https://johnnyreilly.com/schemar-github-action-to-validate-structured-data#adding-schemar-to-the-github-action" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>I won't reiterate the whole GitHub workflow that spins up a preview environment here, but I'll show the key parts. You can see the whole thing in the <a href="https://github.com/johnnyreilly/blog.johnnyreilly.com/blob/main/.github/workflows/build-and-deploy-static-web-app.yml" target="_blank" rel="noopener noreferrer"><code>build-and-deploy-static-web-app.yml</code> of the blog repo</a>. You'll note I'm using Azure Static Web Apps to host my blog - but any web platform will do.</p>
<p>Here is the key part of the GitHub workflow:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token key atrule">structured_data_report_job</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Structured data report üìù</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">needs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> build_and_deploy_swa_job</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> github.event_name == 'pull_request' </span><span class="token important">&amp;&amp;</span><span class="token plain"> github.event.action </span><span class="token tag" style="color:rgb(255, 157, 0)">!=</span><span class="token plain"> 'closed'</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">runs-on</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> actions/checkout@v4</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Wait for preview $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> needs.build_and_deploy_swa_job.outputs.preview</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">url </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> ‚åö</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> static_web_app_wait_for_preview</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> nev7n/wait_for_response@v1</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token key atrule">url</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'${{ needs.build_and_deploy_swa_job.outputs.preview-url }}'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token key atrule">responseCode</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token key atrule">timeout</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">600000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token key atrule">interval</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(255, 98, 140)">1000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Audit URLs for structured data üßê</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> structured_data_audit</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> johnnyreilly/schemar@v0.1.1</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token key atrule">urls</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token scalar string" style="color:rgb(165, 255, 144)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token scalar string" style="color:rgb(165, 255, 144)">          ${{ needs.build_and_deploy_swa_job.outputs.preview-url }}</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token scalar string" style="color:rgb(165, 255, 144)">          ${{ needs.build_and_deploy_swa_job.outputs.preview-url }}/about</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token scalar string" style="color:rgb(165, 255, 144)">          ${{ needs.build_and_deploy_swa_job.outputs.preview-url }}/blog</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token scalar string" style="color:rgb(165, 255, 144)">          ${{ needs.build_and_deploy_swa_job.outputs.preview-url }}/definitely-typed-the-movie</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Format structured data results</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> format_structured_data_results</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> always()</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> actions/github</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">script@v7</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token key atrule">script</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token scalar string" style="color:rgb(165, 255, 144)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token scalar string" style="color:rgb(165, 255, 144)">          const structuredDataCommentMaker = (await import('${{ github.workspace }}/.github/workflows/structuredDataCommentMaker.mjs')).default;</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token scalar string" style="color:rgb(165, 255, 144)">          const results = ${{ steps.structured_data_audit.outputs.results }};</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token scalar string" style="color:rgb(165, 255, 144)">          core.setOutput("comment", structuredDataCommentMaker('${{ needs.build_and_deploy_swa_job.outputs.preview-url }}', results));</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Add structured data results as comment ‚úçÔ∏è</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> structured_data_comment_to_pr</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> always()</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> marocchino/sticky</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">pull</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">request</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">comment@v2</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">      </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token key atrule">number</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> github.event.pull_request.number </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token key atrule">header</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> structured_data</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        </span><span class="token key atrule">message</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> steps.format_structured_data_results.outputs.comment </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Along with the following <code>structuredDataCommentMaker.mjs</code> script:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockTitle_Ktv7">structuredDataCommentMaker.mjs</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic">// @ts-check</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic">/**</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:rgb(255, 157, 0);font-style:italic">@typedef</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">{</span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic">Object</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">}</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> </span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic">Result</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:rgb(255, 157, 0);font-style:italic">@prop</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">{</span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic">string</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">}</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> url</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:rgb(255, 157, 0);font-style:italic">@prop</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">{</span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic">ProcessedValidationResult</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">}</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> processedValidationResult</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic">/**</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:rgb(255, 157, 0);font-style:italic">@typedef</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">{</span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic">Object</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">}</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> </span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic">ProcessedValidationResult</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:rgb(255, 157, 0);font-style:italic">@prop</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">{</span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic">boolean</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">}</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> success</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:rgb(255, 157, 0);font-style:italic">@prop</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">{</span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic">string</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">}</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> resultText</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic">/**</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:rgb(255, 157, 0);font-style:italic">@param</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">{</span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic">string</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">}</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> </span><span class="token doc-comment comment parameter" style="color:rgb(179, 98, 255);font-style:italic">baseUrl</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:rgb(255, 157, 0);font-style:italic">@param</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> </span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">{</span><span class="token doc-comment comment class-name" style="color:rgb(250, 208, 0);font-style:italic">Result</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">[</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">]</span><span class="token doc-comment comment class-name punctuation" style="color:rgb(255, 255, 255);font-style:italic">}</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> </span><span class="token doc-comment comment parameter" style="color:rgb(179, 98, 255);font-style:italic">results</span><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token doc-comment comment" style="color:rgb(179, 98, 255);font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword" style="color:rgb(255, 157, 0)">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(250, 208, 0)">createStructuredDataReport</span><span class="token punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token parameter">baseUrl</span><span class="token parameter punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token parameter"> results</span><span class="token punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword" style="color:rgb(255, 157, 0)">const</span><span class="token plain"> comment </span><span class="token operator" style="color:rgb(255, 157, 0)">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token template-string string" style="color:rgb(165, 255, 144)">### üìù Structured data report</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token template-string string" style="display:inline-block;color:rgb(165, 255, 144)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token template-string string" style="color:rgb(165, 255, 144)"></span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation">results</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token template-string interpolation">  </span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token template-string interpolation method function property-access" style="color:rgb(250, 208, 0)">map</span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token template-string interpolation parameter">result</span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation arrow operator" style="color:rgb(255, 157, 0)">=&gt;</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token template-string interpolation">    </span><span class="token template-string interpolation keyword" style="color:rgb(255, 157, 0)">const</span><span class="token template-string interpolation"> shortUrl </span><span class="token template-string interpolation operator" style="color:rgb(255, 157, 0)">=</span><span class="token template-string interpolation"> result</span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token template-string interpolation property-access">url</span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token template-string interpolation method function property-access" style="color:rgb(250, 208, 0)">replace</span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token template-string interpolation">baseUrl</span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation string" style="color:rgb(165, 255, 144)">''</span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:rgb(255, 157, 0)">||</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation string" style="color:rgb(165, 255, 144)">'/'</span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token template-string interpolation">    </span><span class="token template-string interpolation keyword control-flow" style="color:rgb(255, 157, 0)">return</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token template-string interpolation template-string string" style="color:rgb(165, 255, 144)">#### </span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation template-string interpolation"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token template-string interpolation template-string interpolation">      result</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token template-string interpolation template-string interpolation property-access">processedValidationResult</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token template-string interpolation template-string interpolation property-access">success</span><span class="token template-string interpolation template-string interpolation"> </span><span class="token template-string interpolation template-string interpolation operator" style="color:rgb(255, 157, 0)">?</span><span class="token template-string interpolation template-string interpolation"> </span><span class="token template-string interpolation template-string interpolation string" style="color:rgb(165, 255, 144)">'üü¢'</span><span class="token template-string interpolation template-string interpolation"> </span><span class="token template-string interpolation template-string interpolation operator" style="color:rgb(255, 157, 0)">:</span><span class="token template-string interpolation template-string interpolation"> </span><span class="token template-string interpolation template-string interpolation string" style="color:rgb(165, 255, 144)">'üî¥'</span><span class="token template-string interpolation template-string interpolation"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token template-string interpolation template-string interpolation">    </span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string interpolation template-string string" style="color:rgb(165, 255, 144)"> [</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation template-string interpolation">shortUrl</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string interpolation template-string string" style="color:rgb(165, 255, 144)">](</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation template-string interpolation">result</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token template-string interpolation template-string interpolation property-access">url</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string interpolation template-string string" style="color:rgb(165, 255, 144)">) </span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token template-string interpolation template-string string" style="color:rgb(165, 255, 144)"></span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">${</span><span class="token template-string interpolation template-string interpolation">result</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token template-string interpolation template-string interpolation property-access">processedValidationResult</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token template-string interpolation template-string interpolation property-access">resultText</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string interpolation template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token template-string interpolation">  </span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token template-string interpolation">  </span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">.</span><span class="token template-string interpolation method function property-access" style="color:rgb(250, 208, 0)">join</span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">(</span><span class="token template-string interpolation string" style="color:rgb(165, 255, 144)">'\n'</span><span class="token template-string interpolation punctuation" style="color:rgb(255, 255, 255)">)</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token template-string string" style="color:rgb(165, 255, 144)"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token template-string string" style="color:rgb(165, 255, 144)"></span><span class="token template-string template-punctuation string" style="color:rgb(165, 255, 144)">`</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(255, 157, 0)">return</span><span class="token plain"> comment</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain"></span><span class="token keyword module" style="color:rgb(255, 157, 0)">export</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(255, 157, 0)">default</span><span class="token plain"> createStructuredDataReport</span><span class="token punctuation" style="color:rgb(255, 255, 255)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Let's break this down:</p>
<ul>
<li>We're using the <a href="https://github.com/nev7n/wait_for_response" target="_blank" rel="noopener noreferrer"><code>nev7n/wait_for_response</code></a> GitHub Action to wait for the preview to be available. This is because the preview URL is not available immediately after the preview is created.</li>
<li>We're running Schemar against four URLs in our pull request preview. These pages should have structured data; and if any fail then it's likely a sign that something has gone wrong with my sites structured data story.</li>
<li>We then take the output of the Schemar run and format it into a comment that we can add to the pull request - to do that we use the <code>structuredDataCommentMaker.mjs</code> script.</li>
<li>Finally, we add the comment to the pull request using the <a href="https://github.com/marocchino/sticky-pull-request-comment" target="_blank" rel="noopener noreferrer"><code>marocchino/sticky-pull-request-comment</code></a> GitHub Action.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="testing-it-out">Testing it out<a href="https://johnnyreilly.com/schemar-github-action-to-validate-structured-data#testing-it-out" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h3>
<p>Let's see what this looks like in action. I've created a pull request that breaks the structured data from my blog. This is what the pull request looks like:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted prefix deleted" style="color:rgba(239, 83, 80, 0.56)">-</span><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)">'@type': 'Person',</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">'@type': 'Blarg', // let's break the schema!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The question is, what does the pull request look like after the GitHub Action has run? Here's the answer:</p>
<p><img decoding="async" loading="lazy" alt="screenshot of the GitHub Action failing" src="https://johnnyreilly.com/assets/images/screenshot-failed-github-action-fb3a10c6bdbb1bdeb4e1a91f79f7bb06.png" width="1579" height="713" class="img_ev3q"></p>
<p>It failed! And it put a comment on the PR that looks like this:</p>
<p><img decoding="async" loading="lazy" alt="screenshot of the GitHub Action comment on the PR" src="https://johnnyreilly.com/assets/images/screenshot-pull-request-failed-comment-6a8126dfd8bb299bfc7408294f6608cc.png" width="906" height="642" class="img_ev3q"></p>
<p>Let's unbreak the structured data and see what happens:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#9EFEFF;background-color:#2D2A55"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted prefix deleted" style="color:rgba(239, 83, 80, 0.56)">-</span><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)">'@type': 'Blarg', // let's break the schema!</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103)">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103)">'@type': 'Person',</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="screenshot of the GitHub Action failing" src="https://johnnyreilly.com/assets/images/screenshot-succeeded-github-action-7ff041dfd9da1cefddfb1e8d8b56c759.png" width="1575" height="777" class="img_ev3q"></p>
<p>It succeeded! And it put a comment on the PR that looks like this:</p>
<p><img decoding="async" loading="lazy" alt="screenshot of the GitHub Action comment on the PR" src="https://johnnyreilly.com/assets/images/screenshot-pull-request-succeeded-comment-c0bebef5c518e85255b4d7e09e850856.png" width="900" height="508" class="img_ev3q"></p>
<p>This is great! It means that I can be confident that my structured data is always present and valid. And if it isn't, then I'll know about it. I can even click through to the Schema Markup Validator to see the details.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://johnnyreilly.com/schemar-github-action-to-validate-structured-data#conclusion" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">‚Äã</a></h2>
<p>My hope is that Schemar can be used to increase the quality of structured data on the web. I'm using it to increase the quality of structured data on my blog. I hope you'll find it useful too.</p>
<p>I've also <a href="https://github.com/schemaorg/schemaorg/discussions/3432" target="_blank" rel="noopener noreferrer">shared this with the good folk of Schema.org</a> in the hope they'll find it useful too. The <a href="https://github.com/johnnyreilly/schemar" target="_blank" rel="noopener noreferrer">source code of Schemar can be found here</a>.</p>]]></content:encoded>
            <category>seo</category>
        </item>
    </channel>
</rss>