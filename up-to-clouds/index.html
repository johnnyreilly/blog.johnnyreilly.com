<!doctype html><html lang=en dir=ltr class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.7.0"><title data-rh=true>Up to the clouds! | johnnyreilly</title><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:image content=https://johnnyreilly.com/img/profile.jpg><meta data-rh=true name=twitter:image content=https://johnnyreilly.com/img/profile.jpg><meta data-rh=true property=og:url content=https://johnnyreilly.com/up-to-clouds><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docusaurus_tag content=default><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=docsearch:docusaurus_tag content=default><meta data-rh=true name=robots content=max-image-preview:large><meta data-rh=true name=monetization content=$ilp.uphold.com/LwQQhXdpwxeJ><meta data-rh=true property=og:title content="Up to the clouds! | johnnyreilly"><meta data-rh=true name=description content="Migrating ASP.NET Core app from on-prem to cloud with Kubernetes, Docker, Jenkins, Vault & Azure AD Single Sign-On for greater efficiency."><meta data-rh=true property=og:description content="Migrating ASP.NET Core app from on-prem to cloud with Kubernetes, Docker, Jenkins, Vault & Azure AD Single Sign-On for greater efficiency."><meta data-rh=true property=og:type content=article><meta data-rh=true property=article:published_time content=2020-04-04T00:00:00.000Z><meta data-rh=true property=article:author content=https://johnnyreilly.com/about><meta data-rh=true property=article:tag content=ASP.NET><link data-rh=true rel=icon href=/favicon.ico><link data-rh=true rel=canonical href=https://johnnyreilly.com/up-to-clouds><link data-rh=true rel=alternate href=https://johnnyreilly.com/up-to-clouds hreflang=en><link data-rh=true rel=alternate href=https://johnnyreilly.com/up-to-clouds hreflang=x-default><link data-rh=true rel=preconnect href=https://J3MYR1INLT-dsn.algolia.net crossorigin=anonymous><script data-rh=true type=application/ld+json>{"@context":"https://schema.org","@id":"https://johnnyreilly.com/up-to-clouds","@type":"BlogPosting","author":{"@type":"Person","description":"OSS Engineer - TypeScript, Azure, React, Node.js, .NET","image":"https://johnnyreilly.com/img/profile.jpg","name":"John Reilly","url":"https://johnnyreilly.com/about"},"datePublished":"2020-04-04T00:00:00.000Z","description":"Migrating ASP.NET Core app from on-prem to cloud with Kubernetes, Docker, Jenkins, Vault & Azure AD Single Sign-On for greater efficiency.","headline":"Up to the clouds!","isPartOf":{"@id":"https://johnnyreilly.com/","@type":"Blog","name":"I CAN MAKE THIS WORK"},"keywords":[],"mainEntityOfPage":"https://johnnyreilly.com/up-to-clouds","name":"Up to the clouds!","url":"https://johnnyreilly.com/up-to-clouds"}</script><link rel=alternate type=application/rss+xml href=/rss.xml title="I CAN MAKE THIS WORK RSS Feed"><link rel=alternate type=application/atom+xml href=/atom.xml title="I CAN MAKE THIS WORK Atom Feed"><link rel=search type=application/opensearchdescription+xml title=johnnyreilly href=/opensearch.xml><link rel=icon href=/img/profile-64x64.jpg><link rel=manifest href=/manifest.json><meta name=theme-color content=#3578e5><meta name=apple-mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-status-bar-style content=#000><link rel=apple-touch-icon href=/apple-touch-icon.png><link rel=preload href=https://johnnyreilly.com/fonts/Poppins-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=https://johnnyreilly.com/fonts/Poppins-Bold.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preconnect href=https://res.cloudinary.com><link rel=monetization href=https://ilp.uphold.com/LwQQhXdpwxeJ><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@id":"https://johnnyreilly.com","@type":"WebSite","copyrightHolder":{"@id":"https://johnnyreilly.com/about"},"description":"This is John Reilly's blog. John is an Open Source Software Engineer working on TypeScript, Azure, React, Node.js, .NET and more.","inLanguage":"en-UK","name":"johnnyreilly","potentialAction":{"@type":"SearchAction","query-input":"required name=search_term_string","target":{"@type":"EntryPoint","urlTemplate":"https://johnnyreilly.com/search?q={search_term_string}"}},"publisher":{"@id":"https://johnnyreilly.com/about"},"url":"https://johnnyreilly.com"},{"@id":"https://johnnyreilly.com/about","@type":"Person","address":{"@type":"PostalAddress","addressCountry":"United Kingdom","addressLocality":"London","streetAddress":"Twickenham"},"alternateName":"Johnny Reilly","birthPlace":"Bristol","description":"John is an Open Source Software Engineer working on TypeScript, Azure, React, Node.js, .NET and more. As well as writing code, John is a speaker at meetups, one of the founders of the TS Congress conference, and the author of the history of Definitely Typed, which he worked on in the early days of TypeScript.","email":"johnny_reilly@hotmail.com","image":{"@id":"https://johnnyreilly.com/about#image","@type":"ImageObject","caption":"John Reilly","contentUrl":"https://johnnyreilly.com/img/profile.jpg","height":200,"inLanguage":"en-UK","url":"https://johnnyreilly.com/img/profile.jpg","width":200},"name":"John Reilly","sameAs":["https://github.com/johnnyreilly","https://fosstodon.org/@johnny_reilly","https://twitter.com/johnny_reilly","https://bsky.app/profile/johnnyreilly.com","https://dev.to/johnnyreilly","https://app.daily.dev/johnnyreilly","https://stackoverflow.com/users/761388/john-reilly","https://blog.logrocket.com/author/johnreilly/","https://www.reddit.com/user/johnny_reilly","https://uk.linkedin.com/in/johnnyreilly"],"url":"https://johnnyreilly.com"},{"@id":"https://johnnyreilly.com/about#organization","@type":["Organization","Brand"],"description":"This is John Reilly's blog. John is an Open Source Software Engineer working on TypeScript, Azure, React, Node.js, .NET and more.","image":{"@id":"https://johnnyreilly.com/#logo"},"logo":{"@id":"https://johnnyreilly.com/#logo","@type":"ImageObject","caption":"John Reilly","contentUrl":"https://johnnyreilly.com/img/profile.jpg","height":200,"inLanguage":"en-UK","url":"https://johnnyreilly.com/img/profile.jpg","width":200},"name":"johnnyreilly","sameAs":["https://github.com/johnnyreilly","https://fosstodon.org/@johnny_reilly","https://twitter.com/johnny_reilly","https://bsky.app/profile/johnnyreilly.com","https://dev.to/johnnyreilly","https://app.daily.dev/johnnyreilly","https://stackoverflow.com/users/761388/john-reilly","https://blog.logrocket.com/author/johnreilly/","https://www.reddit.com/user/johnny_reilly","https://uk.linkedin.com/in/johnnyreilly"],"url":"https://johnnyreilly.com"}]}</script><link rel=webmention href=https://webmention.io/johnnyreilly.com/webmention><link rel=stylesheet href=/assets/css/styles.172d8ff3.css><script src=/assets/js/runtime~main.4036c4f4.js defer></script><script src=/assets/js/main.c4ee1d33.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><link rel=preload as=image href=/img/profile-64x64.jpg><link rel=preload as=image href=https://johnnyreilly.com/img/profile.jpg><script type=application/ld+json>[{"@context":"https://schema.org","@id":"/up-to-clouds#breadcrumb","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://johnnyreilly.com","name":"Home","position":1},{"@type":"ListItem","item":"https://johnnyreilly.com/blog","name":"Blog","position":2},{"@type":"ListItem","name":"Up to the clouds!","position":3}],"name":"Blog breadcrumb"}]</script><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><div class=navbar__logo><img src=/img/profile-64x64.jpg alt="Profile picture of John Reilly" class="themedComponent_mlkZ themedComponent--light_NVdE" height=32 width=32><img src=/img/profile-64x64.jpg alt="Profile picture of John Reilly" class="themedComponent_mlkZ themedComponent--dark_xIcU" height=32 width=32></div><b class="navbar__title text--truncate">John Reilly</b></a><a class="navbar__item navbar__link" href=/about>About</a><a class="navbar__item navbar__link" href=/blog>Blog</a><a class="navbar__item navbar__link" href=/talks>Talks</a></div><div class="navbar__items navbar__items--right"><a href=https://github.com/johnnyreilly target=_blank rel=me class="navbar__item navbar__link">GitHub<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><a href=https://bsky.app/profile/johnnyreilly.com target=_blank rel=me class="navbar__item navbar__link">Bluesky<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><a href=https://fosstodon.org/@johnny_reilly target=_blank rel=me class="navbar__item navbar__link">Mastodon<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><a href=https://twitter.com/johnny_reilly target=_blank rel=me class="navbar__item navbar__link">Twitter<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type=button disabled title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live=polite aria-pressed=false><svg viewBox="0 0 24 24" width=24 height=24 class=lightToggleIcon_pyhR><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 class=darkToggleIcon_wfgR><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg></button></div><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class=row><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role=group><h3 class=yearGroupHeading_rMGB>2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/typescript-go-pragmatic-choice>TypeScript is going Go: Why it’s the pragmatic choice</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/microsoft-graphclient-filter-endswith-consistencylevel-eventual-header>Microsoft Graph client: how to filter by endswith</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/list-pipelines-with-azure-devops-api>List Pipelines with the Azure DevOps API</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/static-web-apps-cli-local-auth-emulator-with-dotnet-authentication>Static Web Apps CLI: local authentication emulation with ASP.NET</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/nodejs-azure-appinsights-fastify>Node.js, Azure Application Insights, and Fastify</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/get-service-connections-with-azure-devops-api>Get Service Connections with the Azure DevOps API (REST and TypeScript)</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/slash-command-your-deployment-with-github-actions>Slash command your deployment with GitHub Actions</a></ul></div><div role=group><h3 class=yearGroupHeading_rMGB>2024</h3><ul class="sidebarItemList_Yudw clean-list"><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/smuggling-gitignore-npmrc-in-npm-packages>Smuggling .gitignore, .npmrc and friends in npm packages</a></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class=title_f1Hy>Up to the clouds!</h1><div class="container_mt6G margin-vert--md"><time datetime=2020-04-04T00:00:00.000Z>April 4, 2020</time> · <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href=https://johnnyreilly.com/about target=_blank rel="noopener noreferrer" class=avatar__photo-link><img class="avatar__photo authorImage_XqGP" src=https://johnnyreilly.com/img/profile.jpg alt="John Reilly"></a><div class="avatar__intro authorDetails_lV9A"><div class=avatar__name><a href=https://johnnyreilly.com/about target=_blank rel="noopener noreferrer"><span class=authorName_yefp>John Reilly</span></a></div><small class=authorTitle_nd0D title="OSS Engineer - TypeScript, Azure, React, Node.js, .NET">OSS Engineer - TypeScript, Azure, React, Node.js, .NET</small><div class=authorSocials_rSDt></div></div></div></div></div></header><div id=__blog-post-container class=markdown><p>This last four months has been quite the departure for me. Most typically I find myself building applications; for this last period of time I've been taking the platform that I work on, and been migrating it from running on our on premise servers to running in the cloud.</p>
<p>This turned out to be much more difficult than I'd expected and for reasons that often surprised me. We knew where we wanted to get to, but not all of what we'd need to do to get there. So many things you can only learn by doing. Whilst these experiences are still fresh in my mind I wanted to document some of the challenges we faced.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=the-mission>The mission<a href=#the-mission class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>At the start of January, the team decided to make a concerted effort to take our humble ASP.NET Core application and migrate it to the cloud. We sat down with some friends from the DevOps team who are part of our organisation. We're fortunate in that these marvellous people are very talented engineers indeed. It was going to be a collaboration between our two teams of budding cloudmongers that would make this happen.</p>
<p>Now our application is young. It is not much more than a year old. However it is growing <em>fast</em>. And as we did the migration from on premise to the cloud, that wasn't going to stop. Development of the application was to continue as is, shipping new versions daily. Without impeding that, we were to try and get the application migrated to the cloud.</p>
<p>I would liken it to boarding a speeding train, fighting your way to the front, taking the driver hostage and then diverting the train onto a different track. It was challenging. Really, really challenging.</p>
<p>So many things had to change for us to get from on premise servers to the cloud, all the while keeping our application a going (and shipping) concern. Let's go through them one by one.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=kubernetes-and-docker>Kubernetes and Docker<a href=#kubernetes-and-docker class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>Our application was built using ASP.NET Core. A technology that is entirely cloud friendly (that's one of the reasons we picked it). We were running on a collection of hand installed, hand configured Windows servers. That had to change. We wanted to move our application to run on Kubernetes; so we didn't have to manually configure servers. Rather k8s would manage the provisioning and deployment of containers running our application. Worth saying now: I knew <em>nothing</em> about Kubernetes. Or nearly nothing. I learned a bunch along the way, but, as I've said, this was a collaboration between our team and the mighty site reliability engineers of the DevOps team. They knew a <em>lot</em> about this k8s stuff and moreoften than not, our team stood back and let them work their magic.</p>
<p>In order that we could migrate to running in k8s, we first needed to containerise our application. We needed a <code>Dockerfile</code>. There followed a good amount of experimentation as we worked out how to build ourselves images. There's an art to building an optimal Docker image.</p>
<p>So that we can cover a lot of ground, this post will remain relatively high level. So here's a number of things that we encountered along the way that are worth considering:</p>
<ul>
<li>Multi-stage builds were an absolute necessity for us. We'd build the front end of our app (React / TypeScript) using one stage with a <a href=https://hub.docker.com/_/node target=_blank rel="noopener noreferrer">Node base image</a>. Then we'd build our app using a <a href=https://hub.docker.com/_/microsoft-dotnet-core-sdk/ target=_blank rel="noopener noreferrer">.NET Core SDK base image</a>. Finally, we'd use a <a href=https://hub.docker.com/_/microsoft-dotnet-core-aspnet target=_blank rel="noopener noreferrer">ASP.Net</a> image to run the app; copying in the output of previous stages.</li>
<li>Our application accesses various SQL Server databases. We struggled to get our application to connect to them. The issue related to the SSL configuration of our runner image. The fix was simple but frustrating; use a <code>-bionic</code> image as it has the configuration you need. We found that gem <a href=https://github.com/dotnet/SqlClient/issues/222#issuecomment-535802822 target=_blank rel="noopener noreferrer">here</a>.</li>
<li>Tests. Automated tests. We want to run them in our build; but how? Once more multi-stage builds to the rescue. We'd build our application, then in a separate stage we'd run the tests; copying in the app from the build stage. If the tests failed, the build failed. If they passed then the intermediate stage containing the tests would be discarded by Docker. No unnecessary bloat of the image; all that testing goodness still; now in containerised form!</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=jenkins>Jenkins<a href=#jenkins class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>Our on premise world used TeamCity for our continuous integration needs and Octopus for deployment. We liked these tools well enough; particularly Octopus. However, the DevOps team were very much of the mind that we should be use Jenkins instead. And <a href=https://jenkins.io/doc/book/pipeline/ target=_blank rel="noopener noreferrer">Pipeline</a>. It was here that we initially struggled. To quote the docs:</p>
<blockquote>
<p>Jenkins Pipeline (or simply "Pipeline" with a capital "P") is a suite of plugins which supports implementing and integrating continuous delivery pipelines into Jenkins.</p>
</blockquote>
<p>Whilst continuous delivery is super cool, and is something our team was interested in, we weren't ready for it yet. We didn't yet have the kind of automated testing in place that gave us the confidence that we'd need to move to it. One day, but not today. For now there was still some manual testing done on each release, prior to shipping. Octopus suited us very well here as it allowed us to deploy, on demand, a build of our choice to a given environment. So the question was: what to do? Fortunately the immensely talented Aby Egea came up with a mechanism that supported that very notion. A pipeline that would, optionally, deploy our build to a specified environment. So we were good!</p>
<p>One thing we got to really appreciate about Jenkins was that the build is scripted with a <a href=https://jenkins.io/doc/book/pipeline/jenkinsfile/ target=_blank rel="noopener noreferrer">Jenkinsfile</a>. This was in contrast to our TeamCity world where it was all manually configured. <a href=https://jenkins.io/projects/jcasc/ target=_blank rel="noopener noreferrer">Configuration as code</a> is truly a wonderful thing as your build pipeline becomes part of your codebase; open for everyone to see and understand. If anyone wants to change the build pipeline it has to get code reviewed like everything else. It was as code in our <code>Jenkinsfile</code> that the deployment mechanism lived.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=vault>Vault<a href=#vault class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>Another thing that we used Octopus for was secrets. Applications run on configuration; these are settings that drive the behaviour of your application. A subset of configuration is "secrets". Secrets are configuration that can't be stored in source code; they would represent a risk if they did. For instance a database connection string. We'd been merrily using Octopus for this; as Octopus deploys an application to a server it enriches the <code>appsettings.json</code> file with any required secrets.</p>
<p>Without Octopus in the mix, how were we to handle our secrets? The answer is with <a href=https://www.vaultproject.io/ target=_blank rel="noopener noreferrer">Hashicorp Vault</a>. We'd store our secrets in there and, thanks to clever work by <a href=https://uk.linkedin.com/in/robert-grzankowski-53618114 target=_blank rel="noopener noreferrer">Robski</a> of the DevOps team, when our container was brought up by Kubernetes, it would mount into the filesystem an <code>appsettings.Vault.json</code> file which we read thanks to our trusty friend <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-3.1#json-configuration-provider" target=_blank rel="noopener noreferrer"><code>.AddJsonFile</code></a> with <code>optional: true</code>. (As the file didn't exist in our development environment.)</p>
<p>Hey presto! Safe secrets in k8s.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=networking>Networking<a href=#networking class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>Our on premise servers sat on the company network. They could see <em>everything</em> that there was to see. All the other servers around them on the network, bleeping and blooping. The opposite was true in AWS. There was nothing to see. Nothing to access. As it should be. It's safer that way should a machine become compromised. For each database and each API our application depended upon, we needed to specifically allowlist access.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=kerberos>Kerberos<a href=#kerberos class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>There's always a fly in the ointment. A nasty surprise on a dark night. Ours was realising that our application depended upon an API that was secured using <a href=https://docs.microsoft.com/en-us/iis/configuration/system.webserver/security/authentication/windowsauthentication/ target=_blank rel="noopener noreferrer">Windows Authentication</a>. Our application was accessing it by running under a service account which had been permissioned to access it. However, in AWS, our application wasn't running as under a service account on the company network. Disappointingly, in the short term the API was not going to support an alternate authentication mechanism.</p>
<p>What to do? Honestly it wasn't looking good. We were considering proxying through one of our Windows servers just to get access to that API. I was tremendously disappointed. At this point our hero arrived; one <a href=https://twitter.com/foldr target=_blank rel="noopener noreferrer">JMac</a> hacked together a Kerberos sidecar approach one weekend. You can see a similar approach <a href=https://github.com/edseymour/kinit-sidecar target=_blank rel="noopener noreferrer">here</a>. This got us to a point that allowed us to access the API we needed to.</p>
<p>I'm kind of amazed that there isn't better documentation out there around have a Kerberos sidecar in a k8s setup. Tragically Windows Authentication is a widely used authentication mechanism. That being the case, having good docs to show how you can get a Kerberos sidecar in place would likely greatly advance the ability of enterprises to migrate to the cloud. The best docs I've found are <a href=https://blog.openshift.com/kerberos-sidecar-container/ target=_blank rel="noopener noreferrer">here</a>. It is super hard though. <em>So hard!</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=hangfire>Hangfire<a href=#hangfire class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>We were using <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/host/hosted-services?view=aspnetcore-3.1&tabs=visual-studio" target=_blank rel="noopener noreferrer">Hosted Services</a> to perform background task running in our app. The nature of our background tasks meant that it was important to only run a single instance of a background task at a time. Or bad things would happen. This was going to become a problem since we had ambitions to be able to horizontally scale our application; to add new pods as running our app as demand determined.</p>
<p>So we started to use <a href=https://www.hangfire.io/ target=_blank rel="noopener noreferrer">Hangfire</a> to perform task running in our app. With Hangfire, when a job is picked up it gets locked so other servers can't pick it up. That's what we need.</p>
<p>Hangfire is pretty awesome. However it turns out that there's quirks when you move to a containerised environment. We have a number of recurring jobs that are scheduled to run at certain dates and times. In order that Hangfire can ascertain what time it is, it needs a timezone. It turns out that timezones on Windows != timezones in Docker / Linux.</p>
<p>This was a problem because, as we limbered up for the great migration, we were trying to run our cloud implementation side by side with our on premise one. And Windows picked a fight with Linux over timezones. You can see others bumping into this condition <a href=https://github.com/HangfireIO/Hangfire/issues/1268 target=_blank rel="noopener noreferrer">here</a>. We learned this the hard way; jobs mysteriously stopping due to timezone related errors. Windows Hangfire not able to recognise Linux Hangfire timezones and vica versa.</p>
<p>The TL;DR is that we had to do a hard switch with Hangfire; it couldn't run side by side. Not the end of the world, but surprising.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=azure-active-directory-single-sign-on>Azure Active Directory Single Sign-On<a href=#azure-active-directory-single-sign-on class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>Historically our application had used two modes of authentication; Windows Authentication and cookies. Windows Authentication doesn't generally play nicely with Docker. It's doable, but it's not the hill you want to die on. So we didn't; we swapped out Windows Authentication for <a href=https://docs.microsoft.com/en-us/azure/active-directory/manage-apps/what-is-single-sign-on target=_blank rel="noopener noreferrer">Azure AD SSO</a> and didn't look back.</p>
<p>We also made some changes so our app would support cookies auth alongside Azure AD auth; <a href=/dual-boot-authentication-with-aspnetcore>I've written about this previously</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=do-the-right-thing-and-tell-people-about-it>Do the right thing and tell people about it<a href=#do-the-right-thing-and-tell-people-about-it class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>We're there now; we've made the move. It was a difficult journey but one worth making; it sets up our platform for where we want to take it in the future. Having infrastructure as code makes all kinds of approaches possible that weren't before. Here's some things we're hoping to get out of the move:</p>
<ul>
<li>blue green deployments - shipping without taking down our platform</li>
<li>provision environments on demand - currently we have a highly contended situation when it comes to test environments. With k8s and AWS we can look at spinning up environments as we need them and throwing them away also</li>
<li>autoscaling for need - we can start to look at spinning up new containers in times of high load and removing excessive containers in times of low load</li>
</ul>
<p>We've also become more efficient as a team. We are no longer maintaining servers, renewing certificates, installing software, RDPing onto boxes. All that time and effort we can plough back into making awesome experiences for our users.</p>
<p>There's a long list of other benefits and it's very exciting indeed! It's not enough for us to have done this though. It's important that we tell the story of what we've done and how and why we've done it. That way people have empathy for the work. Also they can start to think about how they could start to reap similar benefits themselves. By talking to others about the road we've travelled, we can save them time and help them to travel a similar road. This is good for them and it's good for us; it helps our relationships and it helps us all to move forwards together.</p>
<p>A rising tide lifts all boats. By telling others about our journey, we raise the water level. Up to the clouds!</div><footer class=docusaurus-mt-lg><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class=col><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class=tag_QGVx><a title="The web framework built by Microsoft." class="tag_zVej tagRegular_sFm0" href=/tags/asp-net>ASP.NET</a></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class=col><a href=https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2020-04-04-up-to-clouds/index.md target=_blank rel="noopener noreferrer" class=theme-edit-this-page><svg fill=currentColor height=20 width=20 viewBox="0 0 40 40" class=iconEdit_Z9Sw aria-hidden=true><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"/></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href=/from-react-window-to-react-virtual><div class=pagination-nav__sublabel>Newer Post</div><div class=pagination-nav__label>From react-window to react-virtual</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/offline-storage-in-pwa><div class=pagination-nav__sublabel>Older Post</div><div class=pagination-nav__label>Offline storage in a PWA</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#the-mission class="table-of-contents__link toc-highlight">The mission</a><li><a href=#kubernetes-and-docker class="table-of-contents__link toc-highlight">Kubernetes and Docker</a><li><a href=#jenkins class="table-of-contents__link toc-highlight">Jenkins</a><li><a href=#vault class="table-of-contents__link toc-highlight">Vault</a><li><a href=#networking class="table-of-contents__link toc-highlight">Networking</a><li><a href=#kerberos class="table-of-contents__link toc-highlight">Kerberos</a><li><a href=#hangfire class="table-of-contents__link toc-highlight">Hangfire</a><li><a href=#azure-active-directory-single-sign-on class="table-of-contents__link toc-highlight">Azure Active Directory Single Sign-On</a><li><a href=#do-the-right-thing-and-tell-people-about-it class="table-of-contents__link toc-highlight">Do the right thing and tell people about it</a></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class=footer__title></div><ul class="footer__items clean-list"><li class=footer__item><div class=footer__title><a href=/tags/typescript class=footer__link-item>TypeScript<img src=/img/ts-logo-128.svg alt="TypeScript icon" class=footer__icon></a></div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=/typescript-vs-jsdoc-javascript class=footer__link-item>TypeScript vs JSDoc JavaScript</a><li class=footer__item><a href=/type-annotations-strong-types-weakly-held class=footer__link-item>Type annotations proposal: strong types, weakly held</a></li>
</ul><div class=footer__title><a href=/tags/azure class=footer__link-item>Azure<img src=/img/azure-logo.svg alt="Azure icon" class=footer__icon></a></div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=/azure-container-apps-easy-auth-and-dotnet-authentication class=footer__link-item>Azure Container Apps: Easy Auth and .NET</a><li class=footer__item><a href=/introducing-azdo-npm-auth class=footer__link-item>Introducing azdo-npm-auth (Azure DevOps npm auth)</a><li class=footer__item><a href=/npx-and-azure-artifacts-the-secret-cli-delivery-mechanism class=footer__link-item>npx and Azure Artifacts: the secret CLI delivery mechanism</a><li class=footer__item><a href=/azure-static-web-apps-dynamic-redirects-azure-functions class=footer__link-item>Azure Static Web Apps: dynamic redirects with Azure Functions</a></li>
</ul><div class=footer__title><a href=/tags/asp-net class=footer__link-item>ASP.NET<img src=/img/dotnet-logo.svg alt="ASP.NET icon" class=footer__icon></a></div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=/eslint-your-csharp-in-vs-code-with-roslyn-analyzers class=footer__link-item>ESLint your C# with Roslyn Analyzers</a><li class=footer__item><a href=/aspnet-serilog-and-application-insights class=footer__link-item>ASP.NET, Serilog and Application Insights</a></li>
</ul><div class=footer__title><a href=/tags/react class=footer__link-item>React<img src=/img/react-logo.svg alt="React icon" class=footer__icon></a></div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=/structured-data-seo-and-react class=footer__link-item>Structured data and React</a><li class=footer__item><a href=/react-usesearchparamsstate class=footer__link-item>React: storing state in URL with URLSearchParams</a></li>
</ul></ul></div><div class="col footer__col"><div class=footer__title></div><ul class="footer__items clean-list"><li class=footer__item><div class=footer__title>Notable articles</div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=/definitely-typed-the-movie class=footer__link-item>The history of Definitely Typed<img src=/img/definitely-typed-logo.png alt="The history of Definitely Typed icon" class=footer__icon></a><li class=footer__item><a href=/typescript-documentary class=footer__link-item>TypeScript: the documentary<img src=/img/ts-logo-128.svg alt="TypeScript: the documentary icon" class=footer__icon></a><li class=footer__item><a href=/how-we-fixed-my-seo class=footer__link-item>How we fixed my SEO</a></li>
</ul><div class=footer__title>Popular articles</div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=/aspnet-serilog-and-application-insights class=footer__link-item>ASP.NET, Serilog and Application Insights</a><li class=footer__item><a href=/eslint-your-csharp-in-vs-code-with-roslyn-analyzers class=footer__link-item>ESLint your C# with Roslyn Analyzers</a><li class=footer__item><a href=/prettier-your-csharp-with-dotnet-format-and-lint-staged class=footer__link-item>dotnet-format: Prettier your C# with lint-staged & husky</a></li>
</ul><div class=footer__title>Recently updated</div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=definitive-guide-to-migrating-from-blogger-to-docusaurus class=footer__link-item>The definitive guide to migrating from Blogger to Docusaurus</a><li class=footer__item><a href=azure-container-apps-bicep-managed-certificates-custom-domains class=footer__link-item>Azure Container Apps, Bicep, managed certificates and custom domains</a><li class=footer__item><a href=typescript-go-pragmatic-choice class=footer__link-item>TypeScript is going Go: Why it’s the pragmatic choice</a></li>
</ul></ul></div><div class="col footer__col"><div class=footer__title>Learn more / support me</div><ul class="footer__items clean-list"><li class=footer__item><a class=footer__link-item href=/about>About me</a><li class=footer__item><a href=https://github.com/johnnyreilly/blog.johnnyreilly.com target=_blank rel="noopener noreferrer" class=footer__link-item>Blog source code on GitHub<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a class=footer__link-item href=/tags>Blog categories</a><li class=footer__item><a href=https://johnnyreilly.com/rss.xml target=_blank rel="noopener noreferrer" class=footer__link-item>RSS feed<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://johnnyreilly.com/atom.xml target=_blank rel="noopener noreferrer" class=footer__link-item>Atom feed<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a class=footer__link-item href=/privacy-policy>Privacy Policy</a><li class=footer__item><iframe src=https://github.com/sponsors/johnnyreilly/card title="Sponsor johnnyreilly" style="margin-top: 20px; border: 0; border-radius: 10px; background-color: white; min-height: 400px;"></iframe><li class=footer__item><a href=https://www.buymeacoffee.com/qUBm0Wh rel=noopener target=_blank><img src=https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png loading=lazy alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></ul></div></div><div class="footer__bottom text--center"><div class=footer__copyright>Copyright © 2012 - 2025 John Reilly. Built with Docusaurus.</div></div></div></footer></div>