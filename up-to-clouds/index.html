<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">Up to the clouds! | johnnyreilly</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://res.cloudinary.com/priou/image/fetch/f_auto,q_auto,w_auto,dpr_auto/https://johnnyreilly.com/img/profile.jpg"><meta data-rh="true" name="twitter:image" content="https://res.cloudinary.com/priou/image/fetch/f_auto,q_auto,w_auto,dpr_auto/https://johnnyreilly.com/img/profile.jpg"><meta data-rh="true" property="og:url" content="https://johnnyreilly.com/up-to-clouds"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="robots" content="max-image-preview:large"><meta data-rh="true" name="monetization" content="$ilp.uphold.com/LwQQhXdpwxeJ"><meta data-rh="true" property="og:title" content="Up to the clouds! | johnnyreilly"><meta data-rh="true" name="description" content="This last four months has been quite the departure for me. Most typically I find myself building applications; for this last period of time I&#x27;ve been taking the platform that I work on, and been migrating it from running on our on premise servers to running in the cloud."><meta data-rh="true" property="og:description" content="This last four months has been quite the departure for me. Most typically I find myself building applications; for this last period of time I&#x27;ve been taking the platform that I work on, and been migrating it from running on our on premise servers to running in the cloud."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2020-04-04T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://johnnyreilly.com/about"><meta data-rh="true" property="article:tag" content="docker,kubernetes,asp net core"><link data-rh="true" rel="icon" href="/favicon.ico"><link data-rh="true" rel="canonical" href="https://johnnyreilly.com/up-to-clouds"><link data-rh="true" rel="alternate" href="https://johnnyreilly.com/up-to-clouds" hreflang="en"><link data-rh="true" rel="alternate" href="https://johnnyreilly.com/up-to-clouds" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://J3MYR1INLT-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3N85G0SL3K"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-3N85G0SL3K",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="johnnyreilly" href="/opensearch.xml">

<link rel="icon" href="/img/profile-64x64.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#3578e5">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="preload" href="https://johnnyreilly.com/fonts/Poppins-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://johnnyreilly.com/fonts/Poppins-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preconnect" href="https://res.cloudinary.com">
<link rel="monetization" href="https://ilp.uphold.com/LwQQhXdpwxeJ"><link rel="stylesheet" href="/assets/css/styles.23d42ac8.css">
<link rel="preload" href="/assets/js/runtime~main.b9a6b235.js" as="script">
<link rel="preload" href="/assets/js/main.b1929bf0.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<script type="application/ld+json">[{&quot;@context&quot;:&quot;https://schema.org&quot;,&quot;@type&quot;:&quot;BreadcrumbList&quot;,&quot;name&quot;:&quot;Archive breadcrumb&quot;,&quot;itemListElement&quot;:[{&quot;@type&quot;:&quot;ListItem&quot;,&quot;position&quot;:1,&quot;name&quot;:&quot;Home&quot;,&quot;item&quot;:&quot;https://johnnyreilly.com&quot;},{&quot;@type&quot;:&quot;ListItem&quot;,&quot;position&quot;:2,&quot;name&quot;:&quot;Archive&quot;,&quot;item&quot;:&quot;https://johnnyreilly.com/archive&quot;},{&quot;@type&quot;:&quot;ListItem&quot;,&quot;position&quot;:3,&quot;name&quot;:&quot;Up to the clouds!&quot;}]},{&quot;@context&quot;:&quot;https://schema.org&quot;,&quot;@type&quot;:&quot;BreadcrumbList&quot;,&quot;name&quot;:&quot;Tags docker breadcrumb&quot;,&quot;itemListElement&quot;:[{&quot;@type&quot;:&quot;ListItem&quot;,&quot;position&quot;:1,&quot;name&quot;:&quot;Home&quot;,&quot;item&quot;:&quot;https://johnnyreilly.com&quot;},{&quot;@type&quot;:&quot;ListItem&quot;,&quot;position&quot;:2,&quot;name&quot;:&quot;Tags&quot;,&quot;item&quot;:&quot;https://johnnyreilly.com/tags&quot;},{&quot;@type&quot;:&quot;ListItem&quot;,&quot;position&quot;:3,&quot;name&quot;:&quot;docker&quot;,&quot;item&quot;:&quot;https://johnnyreilly.com/tags/docker&quot;},{&quot;@type&quot;:&quot;ListItem&quot;,&quot;position&quot;:4,&quot;name&quot;:&quot;Up to the clouds!&quot;}]},{&quot;@context&quot;:&quot;https://schema.org&quot;,&quot;@type&quot;:&quot;BreadcrumbList&quot;,&quot;name&quot;:&quot;Tags kubernetes breadcrumb&quot;,&quot;itemListElement&quot;:[{&quot;@type&quot;:&quot;ListItem&quot;,&quot;position&quot;:1,&quot;name&quot;:&quot;Home&quot;,&quot;item&quot;:&quot;https://johnnyreilly.com&quot;},{&quot;@type&quot;:&quot;ListItem&quot;,&quot;position&quot;:2,&quot;name&quot;:&quot;Tags&quot;,&quot;item&quot;:&quot;https://johnnyreilly.com/tags&quot;},{&quot;@type&quot;:&quot;ListItem&quot;,&quot;position&quot;:3,&quot;name&quot;:&quot;kubernetes&quot;,&quot;item&quot;:&quot;https://johnnyreilly.com/tags/kubernetes&quot;},{&quot;@type&quot;:&quot;ListItem&quot;,&quot;position&quot;:4,&quot;name&quot;:&quot;Up to the clouds!&quot;}]},{&quot;@context&quot;:&quot;https://schema.org&quot;,&quot;@type&quot;:&quot;BreadcrumbList&quot;,&quot;name&quot;:&quot;Tags asp net core breadcrumb&quot;,&quot;itemListElement&quot;:[{&quot;@type&quot;:&quot;ListItem&quot;,&quot;position&quot;:1,&quot;name&quot;:&quot;Home&quot;,&quot;item&quot;:&quot;https://johnnyreilly.com&quot;},{&quot;@type&quot;:&quot;ListItem&quot;,&quot;position&quot;:2,&quot;name&quot;:&quot;Tags&quot;,&quot;item&quot;:&quot;https://johnnyreilly.com/tags&quot;},{&quot;@type&quot;:&quot;ListItem&quot;,&quot;position&quot;:3,&quot;name&quot;:&quot;asp net core&quot;,&quot;item&quot;:&quot;https://johnnyreilly.com/tags/asp-net-core&quot;},{&quot;@type&quot;:&quot;ListItem&quot;,&quot;position&quot;:4,&quot;name&quot;:&quot;Up to the clouds!&quot;}]}]</script><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile-64x64.jpg" alt="Profile picture of John Reilly" class="themedImage_ToTc themedImage--light_HNdA" height="32" width="32"><img src="/img/profile-64x64.jpg" alt="Profile picture of John Reilly" class="themedImage_ToTc themedImage--dark_i4oU" height="32" width="32"></div><b class="navbar__title text--truncate">John Reilly</b></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/archive">Blog Archive</a><a class="navbar__item navbar__link" href="/talks">Talks</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://fosstodon.org/@johnny_reilly" target="_blank" rel="me" class="navbar__item navbar__link">Mastodon<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docusaurus-structured-data-faqs-mdx">Docusaurus: Structured Data FAQs with MDX</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/bicep-user-defined-types-and-bash-single-item-arrays">Bicep user defined types and Bash single item arrays</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/playwright-github-actions-and-azure-static-web-apps-staging-environments">Playwright, GitHub Actions and Azure Static Web Apps staging environments</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/migrating-from-ts-node-to-bun">Migrating from ts-node to Bun</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/node-18-axios-and-unsafe-legacy-renegotiation-disabled">Node.js 18, Axios and unsafe legacy renegotiation disabled</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/in-defence-of-pull-requests">In defence of pull requests</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docusaurus-blogs-adding-breadcrumb-structured-data">Docusaurus blogs: adding breadcrumb Structured Data</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/migrating-from-github-pages-to-azure-static-web-apps">Migrating from GitHub Pages to Azure Static Web Apps</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">Up to the clouds!</h1><div class="container_mt6G margin-vert--md"><time datetime="2020-04-04T00:00:00.000Z" itemprop="datePublished">April 4, 2020</time> · <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://johnnyreilly.com/about" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://johnnyreilly.com/about" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div><small class="avatar__subtitle" itemprop="description">OSS Engineer - TypeScript, Azure, React, Node.js, .NET</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>This last four months has been quite the departure for me. Most typically I find myself building applications; for this last period of time I&#x27;ve been taking the platform that I work on, and been migrating it from running on our on premise servers to running in the cloud.</p><p>This turned out to be much more difficult than I&#x27;d expected and for reasons that often surprised me. We knew where we wanted to get to, but not all of what we&#x27;d need to do to get there. So many things you can only learn by doing. Whilst these experiences are still fresh in my mind I wanted to document some of the challenges we faced.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-mission">The mission<a href="#the-mission" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p>At the start of January, the team decided to make a concerted effort to take our humble ASP.NET Core application and migrate it to the cloud. We sat down with some friends from the DevOps team who are part of our organisation. We&#x27;re fortunate in that these marvellous people are very talented engineers indeed. It was going to be a collaboration between our two teams of budding cloudmongers that would make this happen.</p><p>Now our application is young. It is not much more than a year old. However it is growing <em>fast</em>. And as we did the migration from on premise to the cloud, that wasn&#x27;t going to stop. Development of the application was to continue as is, shipping new versions daily. Without impeding that, we were to try and get the application migrated to the cloud.</p><p>I would liken it to boarding a speeding train, fighting your way to the front, taking the driver hostage and then diverting the train onto a different track. It was challenging. Really, really challenging.</p><p>So many things had to change for us to get from on premise servers to the cloud, all the while keeping our application a going (and shipping) concern. Let&#x27;s go through them one by one.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="kubernetes-and-docker">Kubernetes and Docker<a href="#kubernetes-and-docker" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p>Our application was built using ASP.NET Core. A technology that is entirely cloud friendly (that&#x27;s one of the reasons we picked it). We were running on a collection of hand installed, hand configured Windows servers. That had to change. We wanted to move our application to run on Kubernetes; so we didn&#x27;t have to manually configure servers. Rather k8s would manage the provisioning and deployment of containers running our application. Worth saying now: I knew <em>nothing</em> about Kubernetes. Or nearly nothing. I learned a bunch along the way, but, as I&#x27;ve said, this was a collaboration between our team and the mighty site reliability engineers of the DevOps team. They knew a <em>lot</em> about this k8s stuff and moreoften than not, our team stood back and let them work their magic.</p><p>In order that we could migrate to running in k8s, we first needed to containerise our application. We needed a <code>Dockerfile</code>. There followed a good amount of experimentation as we worked out how to build ourselves images. There&#x27;s an art to building an optimal Docker image.</p><p>So that we can cover a lot of ground, this post will remain relatively high level. So here&#x27;s a number of things that we encountered along the way that are worth considering:</p><ul><li>Multi-stage builds were an absolute necessity for us. We&#x27;d build the front end of our app (React / TypeScript) using one stage with a <a href="https://hub.docker.com/_/node" target="_blank" rel="noopener noreferrer">Node base image</a>. Then we&#x27;d build our app using a <a href="https://hub.docker.com/_/microsoft-dotnet-core-sdk/" target="_blank" rel="noopener noreferrer">.NET Core SDK base image</a>. Finally, we&#x27;d use a <a href="https://hub.docker.com/_/microsoft-dotnet-core-aspnet" target="_blank" rel="noopener noreferrer">ASP.Net</a> image to run the app; copying in the output of previous stages.</li><li>Our application accesses various SQL Server databases. We struggled to get our application to connect to them. The issue related to the SSL configuration of our runner image. The fix was simple but frustrating; use a <code>-bionic</code> image as it has the configuration you need. We found that gem <a href="https://github.com/dotnet/SqlClient/issues/222#issuecomment-535802822" target="_blank" rel="noopener noreferrer">here</a>.</li><li>Tests. Automated tests. We want to run them in our build; but how? Once more multi-stage builds to the rescue. We&#x27;d build our application, then in a separate stage we&#x27;d run the tests; copying in the app from the build stage. If the tests failed, the build failed. If they passed then the intermediate stage containing the tests would be discarded by Docker. No unnecessary bloat of the image; all that testing goodness still; now in containerised form!</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="jenkins">Jenkins<a href="#jenkins" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p>Our on premise world used TeamCity for our continuous integration needs and Octopus for deployment. We liked these tools well enough; particularly Octopus. However, the DevOps team were very much of the mind that we should be use Jenkins instead. And <a href="https://jenkins.io/doc/book/pipeline/" target="_blank" rel="noopener noreferrer">Pipeline</a>. It was here that we initially struggled. To quote the docs:</p><blockquote><p>Jenkins Pipeline (or simply &quot;Pipeline&quot; with a capital &quot;P&quot;) is a suite of plugins which supports implementing and integrating continuous delivery pipelines into Jenkins.</p></blockquote><p>Whilst continuous delivery is super cool, and is something our team was interested in, we weren&#x27;t ready for it yet. We didn&#x27;t yet have the kind of automated testing in place that gave us the confidence that we&#x27;d need to move to it. One day, but not today. For now there was still some manual testing done on each release, prior to shipping. Octopus suited us very well here as it allowed us to deploy, on demand, a build of our choice to a given environment. So the question was: what to do? Fortunately the immensely talented Aby Egea came up with a mechanism that supported that very notion. A pipeline that would, optionally, deploy our build to a specified environment. So we were good!</p><p>One thing we got to really appreciate about Jenkins was that the build is scripted with a <a href="https://jenkins.io/doc/book/pipeline/jenkinsfile/" target="_blank" rel="noopener noreferrer">Jenkinsfile</a>. This was in contrast to our TeamCity world where it was all manually configured. <a href="https://jenkins.io/projects/jcasc/" target="_blank" rel="noopener noreferrer">Configuration as code</a> is truly a wonderful thing as your build pipeline becomes part of your codebase; open for everyone to see and understand. If anyone wants to change the build pipeline it has to get code reviewed like everything else. It was as code in our <code>Jenkinsfile</code> that the deployment mechanism lived.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="vault">Vault<a href="#vault" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p>Another thing that we used Octopus for was secrets. Applications run on configuration; these are settings that drive the behaviour of your application. A subset of configuration is &quot;secrets&quot;. Secrets are configuration that can&#x27;t be stored in source code; they would represent a risk if they did. For instance a database connection string. We&#x27;d been merrily using Octopus for this; as Octopus deploys an application to a server it enriches the <code>appsettings.json</code> file with any required secrets.</p><p>Without Octopus in the mix, how were we to handle our secrets? The answer is with <a href="https://www.vaultproject.io/" target="_blank" rel="noopener noreferrer">Hashicorp Vault</a>. We&#x27;d store our secrets in there and, thanks to clever work by <a href="https://uk.linkedin.com/in/robert-grzankowski-53618114" target="_blank" rel="noopener noreferrer">Robski</a> of the DevOps team, when our container was brought up by Kubernetes, it would mount into the filesystem an <code>appsettings.Vault.json</code> file which we read thanks to our trusty friend <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-3.1#json-configuration-provider" target="_blank" rel="noopener noreferrer"><code>.AddJsonFile</code></a> with <code>optional: true</code>. (As the file didn&#x27;t exist in our development environment.)</p><p>Hey presto! Safe secrets in k8s.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="networking">Networking<a href="#networking" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p>Our on premise servers sat on the company network. They could see <em>everything</em> that there was to see. All the other servers around them on the network, bleeping and blooping. The opposite was true in AWS. There was nothing to see. Nothing to access. As it should be. It&#x27;s safer that way should a machine become compromised. For each database and each API our application depended upon, we needed to specifically allowlist access.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="kerberos">Kerberos<a href="#kerberos" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p>There&#x27;s always a fly in the ointment. A nasty surprise on a dark night. Ours was realising that our application depended upon an API that was secured using <a href="https://docs.microsoft.com/en-us/iis/configuration/system.webserver/security/authentication/windowsauthentication/" target="_blank" rel="noopener noreferrer">Windows Authentication</a>. Our application was accessing it by running under a service account which had been permissioned to access it. However, in AWS, our application wasn&#x27;t running as under a service account on the company network. Disappointingly, in the short term the API was not going to support an alternate authentication mechanism.</p><p>What to do? Honestly it wasn&#x27;t looking good. We were considering proxying through one of our Windows servers just to get access to that API. I was tremendously disappointed. At this point our hero arrived; one <a href="https://twitter.com/foldr" target="_blank" rel="noopener noreferrer">JMac</a> hacked together a Kerberos sidecar approach one weekend. You can see a similar approach <a href="https://github.com/edseymour/kinit-sidecar" target="_blank" rel="noopener noreferrer">here</a>. This got us to a point that allowed us to access the API we needed to.</p><p>I&#x27;m kind of amazed that there isn&#x27;t better documentation out there around have a Kerberos sidecar in a k8s setup. Tragically Windows Authentication is a widely used authentication mechanism. That being the case, having good docs to show how you can get a Kerberos sidecar in place would likely greatly advance the ability of enterprises to migrate to the cloud. The best docs I&#x27;ve found are <a href="https://blog.openshift.com/kerberos-sidecar-container/" target="_blank" rel="noopener noreferrer">here</a>. It is super hard though. <em>So hard!</em></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="hangfire">Hangfire<a href="#hangfire" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p>We were using <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/host/hosted-services?view=aspnetcore-3.1&amp;tabs=visual-studio" target="_blank" rel="noopener noreferrer">Hosted Services</a> to perform background task running in our app. The nature of our background tasks meant that it was important to only run a single instance of a background task at a time. Or bad things would happen. This was going to become a problem since we had ambitions to be able to horizontally scale our application; to add new pods as running our app as demand determined.</p><p>So we started to use <a href="https://www.hangfire.io/" target="_blank" rel="noopener noreferrer">Hangfire</a> to perform task running in our app. With Hangfire, when a job is picked up it gets locked so other servers can&#x27;t pick it up. That&#x27;s what we need.</p><p>Hangfire is pretty awesome. However it turns out that there&#x27;s quirks when you move to a containerised environment. We have a number of recurring jobs that are scheduled to run at certain dates and times. In order that Hangfire can ascertain what time it is, it needs a timezone. It turns out that timezones on Windows != timezones in Docker / Linux.</p><p>This was a problem because, as we limbered up for the great migration, we were trying to run our cloud implementation side by side with our on premise one. And Windows picked a fight with Linux over timezones. You can see others bumping into this condition <a href="https://github.com/HangfireIO/Hangfire/issues/1268" target="_blank" rel="noopener noreferrer">here</a>. We learned this the hard way; jobs mysteriously stopping due to timezone related errors. Windows Hangfire not able to recognise Linux Hangfire timezones and vica versa.</p><p>The TL;DR is that we had to do a hard switch with Hangfire; it couldn&#x27;t run side by side. Not the end of the world, but surprising.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="azure-active-directory-single-sign-on">Azure Active Directory Single Sign-On<a href="#azure-active-directory-single-sign-on" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p>Historically our application had used two modes of authentication; Windows Authentication and cookies. Windows Authentication doesn&#x27;t generally play nicely with Docker. It&#x27;s doable, but it&#x27;s not the hill you want to die on. So we didn&#x27;t; we swapped out Windows Authentication for <a href="https://docs.microsoft.com/en-us/azure/active-directory/manage-apps/what-is-single-sign-on" target="_blank" rel="noopener noreferrer">Azure AD SSO</a> and didn&#x27;t look back.</p><p>We also made some changes so our app would support cookies auth alongside Azure AD auth; <a href="/dual-boot-authentication-with-aspnetcore">I&#x27;ve written about this previously</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="do-the-right-thing-and-tell-people-about-it">Do the right thing and tell people about it<a href="#do-the-right-thing-and-tell-people-about-it" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p>We&#x27;re there now; we&#x27;ve made the move. It was a difficult journey but one worth making; it sets up our platform for where we want to take it in the future. Having infrastructure as code makes all kinds of approaches possible that weren&#x27;t before. Here&#x27;s some things we&#x27;re hoping to get out of the move:</p><ul><li>blue green deployments - shipping without taking down our platform</li><li>provision environments on demand - currently we have a highly contended situation when it comes to test environments. With k8s and AWS we can look at spinning up environments as we need them and throwing them away also</li><li>autoscaling for need - we can start to look at spinning up new containers in times of high load and removing excessive containers in times of low load</li></ul><p>We&#x27;ve also become more efficient as a team. We are no longer maintaining servers, renewing certificates, installing software, RDPing onto boxes. All that time and effort we can plough back into making awesome experiences for our users.</p><p>There&#x27;s a long list of other benefits and it&#x27;s very exciting indeed! It&#x27;s not enough for us to have done this though. It&#x27;s important that we tell the story of what we&#x27;ve done and how and why we&#x27;ve done it. That way people have empathy for the work. Also they can start to think about how they could start to reap similar benefits themselves. By talking to others about the road we&#x27;ve travelled, we can save them time and help them to travel a similar road. This is good for them and it&#x27;s good for us; it helps our relationships and it helps us all to move forwards together.</p><p>A rising tide lifts all boats. By telling others about our journey, we raise the water level. Up to the clouds!</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/docker">docker</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/kubernetes">kubernetes</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/asp-net-core">asp net core</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2020-04-04-up-to-clouds/index.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/from-react-window-to-react-virtual"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">From react-window to react-virtual</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/offline-storage-in-pwa"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Offline storage in a PWA</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#the-mission" class="table-of-contents__link toc-highlight">The mission</a></li><li><a href="#kubernetes-and-docker" class="table-of-contents__link toc-highlight">Kubernetes and Docker</a></li><li><a href="#jenkins" class="table-of-contents__link toc-highlight">Jenkins</a></li><li><a href="#vault" class="table-of-contents__link toc-highlight">Vault</a></li><li><a href="#networking" class="table-of-contents__link toc-highlight">Networking</a></li><li><a href="#kerberos" class="table-of-contents__link toc-highlight">Kerberos</a></li><li><a href="#hangfire" class="table-of-contents__link toc-highlight">Hangfire</a></li><li><a href="#azure-active-directory-single-sign-on" class="table-of-contents__link toc-highlight">Azure Active Directory Single Sign-On</a></li><li><a href="#do-the-right-thing-and-tell-people-about-it" class="table-of-contents__link toc-highlight">Do the right thing and tell people about it</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Support me</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" rel="noopener" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" loading="lazy" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li><li class="footer__item"><iframe src="https://github.com/sponsors/johnnyreilly/card" title="Sponsor johnnyreilly" style="border: 0; border-radius: 10px; background-color: white; min-height: 400px;"></iframe></li></ul></div><div class="col footer__col"><div class="footer__title">Misc</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/johnnyreilly/blog.johnnyreilly.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog source code on GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/tags">Blog tags / categories</a></li><li class="footer__item"><a href="https://johnnyreilly.com/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item">RSS feed<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://johnnyreilly.com/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item">Atom feed<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/privacy-policy">Privacy Policy</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2012 - 2023 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.b9a6b235.js"></script>
<script src="/assets/js/main.b1929bf0.js"></script>
</body>
</html>