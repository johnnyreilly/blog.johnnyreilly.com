---
title: "ts-loader v9"
author: John Reilly
author_url: https://github.com/johnnyreilly
author_image_url: https://blog.johnnyreilly.com/img/profile.jpg
tags: [webpack, ts-loader]
# image: blog/2021-04-20-ts-loader-v9/hello-world-bicep.png
hide_table_of_contents: false
---
`ts-loader` has just released v9.0.0. This post goes through what this release is all about, and what it took to ship this version. It's also includes a brief foray into my mental health along the way. Some upgrades go smoothly - this one did not. But we'll get into that.

## One big pull request

As of v8, `ts-loader` supported webpack 4 and webpack 5. However the webpack 5 support wasn't enforced by any kind of automated test pack. `ts-loader` has two test packs:

1. A [comparison test pack](https://github.com/TypeStrong/ts-loader/tree/main/test/comparison-tests#readme) that compares transpilation and webpack compilation output with known outputs.
2. An [execution test pack](https://github.com/TypeStrong/ts-loader/tree/main/test/execution-tests#readme) that executes Karma test packs written in TypeScript using `ts-loader`.

The test packs were tightly coupled to webpack 4 (and in the case of the comparison test pack, that's unavoidable). The mission was to port `ts-loader` to be built against (and have an automated test pack that ran against) webpack 5. 

This ended up being a [very big pull request](https://github.com/TypeStrong/ts-loader/pull/1251). Work on it started back in February 2021 and we're shipping now in April of 2021. I'd initially expected it would take a couple of days at most. I had underestimated.

A number of people collaborated on this PR, either with code, feedback, testing or even just responding to questions.  So I'd like to say thank you to:
- [John Wallsten](https://github.com/JonWallsten) - who did a lot of the work swapping `ts-loader` over to webpack 5 APIs  
- [Nick Excell](https://github.com/appzuka)
- [Andrew Branch](https://github.com/andrewbranch)
- [Alexander Akait](https://github.com/alexander-akait) - who provided webpack 5 expertise and ideas
- [Tobias Koppers](https://github.com/sokra) - who got me out of a hole - more on that later

## What's changed

Let's go through the changes in v9. There's two breaking changes:

- The minimum webpack version supported is now webpack 5. This simplifies the codebase, which previously had to if/else the various API registrations based on the version of webpack being used.
- The minimum node version supported is now node 12. [Node 10 reaches end of life status at the end of April 2021.](https://nodejs.org/en/about/releases/)

An interesting aspect of migrating to building against webpack 5 was dropping the dependency upon [`@types/webpack`](https://www.npmjs.com/package/@types/webpack) in favour of the types that now ship with webpack 5 itself. This was a mostly great experience; however we discovered some missing pieces. 

Most notably, the [LoaderContext](https://github.com/TypeStrong/ts-loader/pull/1251/files#diff-2ee8da4ec0f3c043c7e097851af07383ae3ce13022973c8727312e06bf2b89b3R287) type [wasn't strongly typed](https://github.com/webpack/webpack/blob/03961f33912ab6735d470b870eacff678735a9ed/lib/NormalModule.js#L424) and so a definition had to be added directly to `ts-loader` for usage. [I've asked if this is something that could change.](https://github.com/webpack/webpack/issues/13162) However, it turns out, [it's complicated - with the type being effectively created across two packages](https://github.com/webpack/webpack/pull/13164#issuecomment-821410359). (The type is initially created and then augmented later prior to being supplied to loaders.) For now we've stuck with keeping [an interface in `ts-loader`](https://github.com/TypeStrong/ts-loader/pull/1251/commits/acbc71feed91fe14ec065dd9d31081af7a492f47) that models what arrives in the loader when executed.

Alongside these changes, a [number of dependencies were upgraded](https://github.com/TypeStrong/ts-loader/pull/1251/files#diff-7ae45ad102eab3b6d7e7896acd08c427a9b25b346470d7bc6507b6481575d519).

## The hole

By the 19th of February most of the work was done.  However, [we were experiencing different behaviour between Linux and Windows in our comparison test pack](https://github.com/TypeStrong/ts-loader/pull/1251#issuecomment-781967959). 

As far as I was aware, we were doing all the appropriate work to ensure our test packs worked cross platform.  But we were still experiencing problems whenever we ran the test pack on Windows. I'd done no end of tweaking but nothing worked.  I couldn't explain it. I couldn't fix it.  I was finding that tough to deal with.  At this point I was fairly tired and pretty fed up.  So I took a break.

Time passed. In March [Alexander Akait](https://github.com/alexander-akait) checked in to see how things were going and volunteered to help. He also [suggested what turned out to be the fix](https://github.com/TypeStrong/ts-loader/pull/1251#issuecomment-799531375); namely replacing usage of `'\'` with  `'/'` in the assets supplied back to webpack. But crucially I implemented this wrong. Observe [this commit](https://github.com/TypeStrong/ts-loader/pull/1251/commits/4bcc5c9623acfd7ffbaf028781a8353b37243804):

```ts
  const assetPath = path
    .relative(compilation.compiler.outputPath, outputFile.name)
    // According to @alexander-akait we should always '/' https://github.com/TypeStrong/ts-loader/pull/1251#issuecomment-799606985
    .replace(/\//g, '/');
```

If you look closely at the `replace` you'll see that I'm globally replacing `'/'` with  `'/'` *rather* than globally replacing `'\'` with  `'/'`. I could weep.

I really want to be transparent about the warts and all aspect of open source software development.  At this point I was really quite unhappy. Things weren't working code-wise and I was at a loss to say why. This is not something that I dig.

I also wasn't sleeping amazingly at this point. We'd been in lockdown in the UK for three months by then. I love my family dearly, but having my children homeschooling whilst I attempted to work was very hard indeed. It was very stressful.  I was feeling at a low ebb. And I wasn't sure what to do next.

It was at this point that [Tobias kindly volunteered to help](https://github.com/TypeStrong/ts-loader/pull/1251#issuecomment-805143890). This much I've learned from a career developing software: if a talented sort offers their assistance, grab it with both hands!

I'd been trying be as descriptive as possible about the issues I was facing on the pull request. The idea being, to surface the problems in a public forum where others can read and advise.  And also to attempt a textual kind of [rubber duck debugging](https://en.wikipedia.org/wiki/Rubber_duck_debugging).  

When Tobias pitched in, I wanted to make it as easy as possible for him to help. So I wrote up [a full description of what had changed](https://github.com/TypeStrong/ts-loader/pull/1251#issuecomment-805181069). What the divergent behaviour in test packs looked like. I shared my speculation for what might be causing the issue (I was wrong by the way). Finally I provided a simple way to get up and running with the broken code. The easier I could make it for others to collaborate on this, I figured, the greater the likelihood of an answer.

> The problem is introduced due to some normalization logic in the test case: see [#1273](https://github.com/TypeStrong/ts-loader/pull/1273)
>
> While the PR fixes the problem, I think the paths should be normalized earlier in the pipeline to make this normalization code unnecessary. Note that asset names should have only `/` as they are filenames and not paths. Only absolute paths have `\`.

Tobias had introduced a workaround which resolved things in the test pack which was great. Crucially, he also identified that the issue lay in `ts-loader` itself; this pointed me back to my `replace` bug. [Which I now realised was a bug](https://github.com/TypeStrong/ts-loader/pull/1251#issuecomment-805907212), and [fixed](https://github.com/TypeStrong/ts-loader/pull/1251/commits/427714e43519289bb5745ca078133d1ace8fc2c1)!




Now there's a number of differences in behaviour between Linux style systems and Windows around path delimiters (`'\'` vs `'/'`) and line endings (`'\r\n'` vs `'\n'`). Our comparison test pack contains a wealth of normalisation hacks to accomodate this.