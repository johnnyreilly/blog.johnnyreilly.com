<!doctype html><html lang=en dir=ltr class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.7.0"><title data-rh=true>Slash command your deployment with GitHub Actions | johnnyreilly</title><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://johnnyreilly.com/slash-command-your-deployment-with-github-actions><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docusaurus_tag content=default><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=docsearch:docusaurus_tag content=default><meta data-rh=true name=robots content=max-image-preview:large><meta data-rh=true name=monetization content=$ilp.uphold.com/LwQQhXdpwxeJ><meta data-rh=true property=og:title content="Slash command your deployment with GitHub Actions | johnnyreilly"><meta data-rh=true name=description content="Slash commands are a great way to interact with your GitHub issues. In this post, we look at how to implement a `/deploy` slash command to deploy an Azure Container Apps service with GitHub Actions."><meta data-rh=true property=og:description content="Slash commands are a great way to interact with your GitHub issues. In this post, we look at how to implement a `/deploy` slash command to deploy an Azure Container Apps service with GitHub Actions."><meta data-rh=true property=og:image content=https://johnnyreilly.com/assets/images/title-image-5c895b855a4bb9606fc2019f57811c42.png><meta data-rh=true name=twitter:image content=https://johnnyreilly.com/assets/images/title-image-5c895b855a4bb9606fc2019f57811c42.png><meta data-rh=true property=og:type content=article><meta data-rh=true property=article:published_time content=2025-01-02T00:00:00.000Z><meta data-rh=true property=article:author content=https://johnnyreilly.com/about><meta data-rh=true property=article:tag content="GitHub Actions,Azure Container Apps"><link data-rh=true rel=icon href=/favicon.ico><link data-rh=true rel=canonical href=https://johnnyreilly.com/slash-command-your-deployment-with-github-actions><link data-rh=true rel=alternate href=https://johnnyreilly.com/slash-command-your-deployment-with-github-actions hreflang=en><link data-rh=true rel=alternate href=https://johnnyreilly.com/slash-command-your-deployment-with-github-actions hreflang=x-default><link data-rh=true rel=preconnect href=https://J3MYR1INLT-dsn.algolia.net crossorigin=anonymous><script data-rh=true type=application/ld+json>{"@context":"https://schema.org","@id":"https://johnnyreilly.com/slash-command-your-deployment-with-github-actions","@type":"BlogPosting","author":{"@type":"Person","description":"OSS Engineer - TypeScript, Azure, React, Node.js, .NET","image":"https://johnnyreilly.com/img/profile.jpg","name":"John Reilly","url":"https://johnnyreilly.com/about"},"datePublished":"2025-01-02T00:00:00.000Z","description":"Slash commands are a great way to interact with your GitHub issues. In this post, we look at how to implement a `/deploy` slash command to deploy an Azure Container Apps service with GitHub Actions.","headline":"Slash command your deployment with GitHub Actions","image":{"@id":"https://johnnyreilly.com/assets/images/title-image-5c895b855a4bb9606fc2019f57811c42.png","@type":"ImageObject","caption":"title image for the blog post: Slash command your deployment with GitHub Actions","contentUrl":"https://johnnyreilly.com/assets/images/title-image-5c895b855a4bb9606fc2019f57811c42.png","url":"https://johnnyreilly.com/assets/images/title-image-5c895b855a4bb9606fc2019f57811c42.png"},"isPartOf":{"@id":"https://johnnyreilly.com/","@type":"Blog","name":"I CAN MAKE THIS WORK"},"keywords":[],"mainEntityOfPage":"https://johnnyreilly.com/slash-command-your-deployment-with-github-actions","name":"Slash command your deployment with GitHub Actions","url":"https://johnnyreilly.com/slash-command-your-deployment-with-github-actions"}</script><link rel=alternate type=application/rss+xml href=/rss.xml title="I CAN MAKE THIS WORK RSS Feed"><link rel=alternate type=application/atom+xml href=/atom.xml title="I CAN MAKE THIS WORK Atom Feed"><link rel=search type=application/opensearchdescription+xml title=johnnyreilly href=/opensearch.xml><link rel=icon href=/img/profile-64x64.jpg><link rel=manifest href=/manifest.json><meta name=theme-color content=#3578e5><meta name=apple-mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-status-bar-style content=#000><link rel=apple-touch-icon href=/apple-touch-icon.png><link rel=preload href=https://johnnyreilly.com/fonts/Poppins-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=https://johnnyreilly.com/fonts/Poppins-Bold.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preconnect href=https://res.cloudinary.com><link rel=monetization href=https://ilp.uphold.com/LwQQhXdpwxeJ><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@id":"https://johnnyreilly.com","@type":"WebSite","copyrightHolder":{"@id":"https://johnnyreilly.com/about"},"description":"This is John Reilly's blog. John is an Open Source Software Engineer working on TypeScript, Azure, React, Node.js, .NET and more.","inLanguage":"en-UK","name":"johnnyreilly","potentialAction":{"@type":"SearchAction","query-input":"required name=search_term_string","target":{"@type":"EntryPoint","urlTemplate":"https://johnnyreilly.com/search?q={search_term_string}"}},"publisher":{"@id":"https://johnnyreilly.com/about"},"url":"https://johnnyreilly.com"},{"@id":"https://johnnyreilly.com/about","@type":"Person","address":{"@type":"PostalAddress","addressCountry":"United Kingdom","addressLocality":"London","streetAddress":"Twickenham"},"alternateName":"Johnny Reilly","birthPlace":"Bristol","description":"John is an Open Source Software Engineer working on TypeScript, Azure, React, Node.js, .NET and more. As well as writing code, John is a speaker at meetups, one of the founders of the TS Congress conference, and the author of the history of Definitely Typed, which he worked on in the early days of TypeScript.","email":"johnny_reilly@hotmail.com","image":{"@id":"https://johnnyreilly.com/about#image","@type":"ImageObject","caption":"John Reilly","contentUrl":"https://johnnyreilly.com/img/profile.jpg","height":200,"inLanguage":"en-UK","url":"https://johnnyreilly.com/img/profile.jpg","width":200},"name":"John Reilly","sameAs":["https://github.com/johnnyreilly","https://fosstodon.org/@johnny_reilly","https://twitter.com/johnny_reilly","https://bsky.app/profile/johnnyreilly.com","https://dev.to/johnnyreilly","https://app.daily.dev/johnnyreilly","https://stackoverflow.com/users/761388/john-reilly","https://blog.logrocket.com/author/johnreilly/","https://www.reddit.com/user/johnny_reilly","https://uk.linkedin.com/in/johnnyreilly"],"url":"https://johnnyreilly.com"},{"@id":"https://johnnyreilly.com/about#organization","@type":["Organization","Brand"],"description":"This is John Reilly's blog. John is an Open Source Software Engineer working on TypeScript, Azure, React, Node.js, .NET and more.","image":{"@id":"https://johnnyreilly.com/#logo"},"logo":{"@id":"https://johnnyreilly.com/#logo","@type":"ImageObject","caption":"John Reilly","contentUrl":"https://johnnyreilly.com/img/profile.jpg","height":200,"inLanguage":"en-UK","url":"https://johnnyreilly.com/img/profile.jpg","width":200},"name":"johnnyreilly","sameAs":["https://github.com/johnnyreilly","https://fosstodon.org/@johnny_reilly","https://twitter.com/johnny_reilly","https://bsky.app/profile/johnnyreilly.com","https://dev.to/johnnyreilly","https://app.daily.dev/johnnyreilly","https://stackoverflow.com/users/761388/john-reilly","https://blog.logrocket.com/author/johnreilly/","https://www.reddit.com/user/johnny_reilly","https://uk.linkedin.com/in/johnnyreilly"],"url":"https://johnnyreilly.com"}]}</script><link rel=webmention href=https://webmention.io/johnnyreilly.com/webmention><link rel=stylesheet href=/assets/css/styles.172d8ff3.css><script src=/assets/js/runtime~main.eafdfa39.js defer></script><script src=/assets/js/main.3fb8d0de.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><link rel=preload as=image href=/img/profile-64x64.jpg><link rel=preload as=image href=https://johnnyreilly.com/img/profile.jpg><link rel=preload as=image href=/assets/images/title-image-5c895b855a4bb9606fc2019f57811c42.png><script type=application/ld+json>[{"@context":"https://schema.org","@id":"/slash-command-your-deployment-with-github-actions#breadcrumb","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://johnnyreilly.com","name":"Home","position":1},{"@type":"ListItem","item":"https://johnnyreilly.com/blog","name":"Blog","position":2},{"@type":"ListItem","name":"Slash command your deployment with GitHub Actions","position":3}],"name":"Blog breadcrumb"}]</script><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><div class=navbar__logo><img src=/img/profile-64x64.jpg alt="Profile picture of John Reilly" class="themedComponent_mlkZ themedComponent--light_NVdE" height=32 width=32><img src=/img/profile-64x64.jpg alt="Profile picture of John Reilly" class="themedComponent_mlkZ themedComponent--dark_xIcU" height=32 width=32></div><b class="navbar__title text--truncate">John Reilly</b></a><a class="navbar__item navbar__link" href=/about>About</a><a class="navbar__item navbar__link" href=/blog>Blog</a><a class="navbar__item navbar__link" href=/talks>Talks</a></div><div class="navbar__items navbar__items--right"><a href=https://github.com/johnnyreilly target=_blank rel=me class="navbar__item navbar__link">GitHub<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><a href=https://bsky.app/profile/johnnyreilly.com target=_blank rel=me class="navbar__item navbar__link">Bluesky<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><a href=https://fosstodon.org/@johnny_reilly target=_blank rel=me class="navbar__item navbar__link">Mastodon<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><a href=https://twitter.com/johnny_reilly target=_blank rel=me class="navbar__item navbar__link">Twitter<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type=button disabled title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live=polite aria-pressed=false><svg viewBox="0 0 24 24" width=24 height=24 class=lightToggleIcon_pyhR><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 class=darkToggleIcon_wfgR><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg></button></div><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class=row><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role=group><h3 class=yearGroupHeading_rMGB>2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/list-pipelines-with-azure-devops-api>List Pipelines with the Azure DevOps API</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/static-web-apps-cli-local-auth-emulator-with-dotnet-authentication>Static Web Apps CLI: local authentication emulation with ASP.NET</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/nodejs-azure-appinsights-fastify>Node.js, Azure Application Insights, and Fastify</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/get-service-connections-with-azure-devops-api>Get Service Connections with the Azure DevOps API (REST and TypeScript)</a><li class=sidebarItem__DBe><a aria-current=page class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href=/slash-command-your-deployment-with-github-actions>Slash command your deployment with GitHub Actions</a></ul></div><div role=group><h3 class=yearGroupHeading_rMGB>2024</h3><ul class="sidebarItemList_Yudw clean-list"><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/smuggling-gitignore-npmrc-in-npm-packages>Smuggling .gitignore, .npmrc and friends in npm packages</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/npx-and-azure-artifacts-the-secret-cli-delivery-mechanism>npx and Azure Artifacts: the secret CLI delivery mechanism</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/azure-artifacts-publish-private-npm-package-with-azure-devops>Azure Artifacts: Publish a private npm package with Azure DevOps</a></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class=title_f1Hy>Slash command your deployment with GitHub Actions</h1><div class="container_mt6G margin-vert--md"><time datetime=2025-01-02T00:00:00.000Z>January 2, 2025</time> · <!-- -->12 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href=https://johnnyreilly.com/about target=_blank rel="noopener noreferrer" class=avatar__photo-link><img class="avatar__photo authorImage_XqGP" src=https://johnnyreilly.com/img/profile.jpg alt="John Reilly"></a><div class="avatar__intro authorDetails_lV9A"><div class=avatar__name><a href=https://johnnyreilly.com/about target=_blank rel="noopener noreferrer"><span class=authorName_yefp>John Reilly</span></a></div><small class=authorTitle_nd0D title="OSS Engineer - TypeScript, Azure, React, Node.js, .NET">OSS Engineer - TypeScript, Azure, React, Node.js, .NET</small><div class=authorSocials_rSDt></div></div></div></div></div></header><div id=__blog-post-container class=markdown><p>In the world of computing, slash commands have a proud and noble history. They are a way to interact with a system by typing a command into a chat or terminal, usually with a <code>/</code> preceding the command; hence the name "slash commands". <a href=https://docs.github.com/en/issues/tracking-your-work-with-issues/using-issues/about-slash-commands target=_blank rel="noopener noreferrer">GitHub has its own slash commands</a> that you can use in issues and pull requests to add code blocks and tables etc. The slash commands are, in truth, quite limited.</p>
<p>However, through clever use of the GitHub Actions platform, it's possible to build something quite powerful which is "slash-command-shaped". In this post, we'll look at how to implement a <code>/deploy</code> slash command which, when invoked in a pull request, will deploy an Azure Container App with GitHub Actions.</p>
<p><img decoding=async loading=eager alt="title image reading &amp;quot;Slash command your deployment with GitHub Actions&amp;quot; with the GitHub Actions logo" src=/assets/images/title-image-5c895b855a4bb9606fc2019f57811c42.png width=800 height=450 fetchpriority=high class=img_ev3q></p>
<p>The technique we'll use is covering a deployment usecase, as we'll see, it could be adapted to many other scenarios.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=first-a-bit-about-nuns>First a bit about nuns<a href=#first-a-bit-about-nuns class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>I have an aunt that is a Poor Clare nun, and I've been <a href=/the-convent-with-continuous-delivery>over-engineering her convent's website for years</a>. Most of the time the site moulders away, but every now and then I get a flurry of requests for minor changes. Once I've made the changes, they go live thanks to the magic of continuous deployment. But there's only ever been a single environment; production or "main".</p>
<p>Sometimes I'd like to eyeball a change before I've shipped it. Not always, sometimes. A particular case where this is useful, is when <a href=https://www.mend.io/renovate/ target=_blank rel="noopener noreferrer">Renovate</a> has submitted a dependency upgrade PR, and I'd like to see the impact without having to install and run it locally somewhere. Because, unless I instead hit "merge" with crossed fingers, that's what I'll need to do. (I have done this and it doesn't always end well.)</p>
<p>So I decided it was time that the "Convent with Continuous Delivery™️" had a staging environment. And I decided that I'd like to be able to deploy to it by entering the slash command <code>/deploy</code> in a pull request comment. Like this:</p>
<p><img decoding=async loading=lazy alt="screenshot of pull request comments" src=/assets/images/screenshot-pull-request-comments-39dd71778a3039bc342d6349667fd81c.webp width=440 height=501 class=img_ev3q></p>
<p>As we can see, I entered <code>/deploy</code> in a comment. In response, a GitHub Actions workflow then kicked off and deployed the staging environment. How did I do this? Let's find out.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=the-github-actions-workflow>The GitHub Actions workflow<a href=#the-github-actions-workflow class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>The secret sauce that makes implementing slash commands in GitHub Actions possible is the <a href=https://docs.github.com/en/actions/writing-workflows/choosing-when-your-workflow-runs/events-that-trigger-workflows#issue_comment target=_blank rel="noopener noreferrer"><code>issue_comment</code> event</a>. This event is triggered when an issue or pull request comment is created, edited, or deleted. We're interested in the situation where a pull request comment is created, and it contains the <code>/deploy</code> command.</p>
<p>Based upon the <a href=https://docs.github.com/en/actions/writing-workflows/choosing-when-your-workflow-runs/events-that-trigger-workflows#issue_comment-on-issues-only-or-pull-requests-only target=_blank rel="noopener noreferrer">example here</a> it's possible to create a workflow that is triggered by the <code>issue_comment</code> event, but only when the comment is on a pull request, and that comment contains the text <code>/deploy</code>.</p>
<p>Here's the workflow:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token key atrule">on</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">issue_comment</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">types</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">created</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token key atrule">jobs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">run-for-pr-comment-with-deploy-command</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># check if the comment comes from a pull request and contains the command `/deploy`</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> github.event.issue.pull_request </span><span class="token important">&&</span><span class="token plain"> contains(github.event.comment.body</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> '/deploy')</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># ...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>The <code>if</code> statement is the key to this workflow. It checks if the comment comes from a pull request and contains the command <code>/deploy</code>. If both conditions are met, the workflow continues. We're in business!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=avoiding-duplication-with-a-reusable-workflow>Avoiding duplication with a reusable workflow<a href=#avoiding-duplication-with-a-reusable-workflow class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>I already have a GitHub Actions workflow that deploys the main environment. I don't want to duplicate this logic in the new workflow. Instead, I want to reuse the existing workflow and just pass in a different environment name. This is where <a href=https://docs.github.com/en/actions/learn-github-actions/reusing-workflows target=_blank rel="noopener noreferrer">reusable workflows</a> come in.</p>
<p>I think of these as functions that can be called from other workflows. They have inputs and outputs, and can be parameterised.</p>
<p>I migrated the deployment logic to a reusable workflow called <code>util-build-and-deploy.yaml</code>. I pondered the best way to share this information with you, and I've finally opted to include the entire workflow here. It's a bit long, but I think it's the best way to show you how it all fits together:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Build and deploy</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token key atrule">on</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">workflow_call</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">deploy</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">required</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 98, 140)">true</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> boolean</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">branchName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">required</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 98, 140)">true</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> string</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">outputs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">containerAppUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">description</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'The URL of the deployed container app'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> jobs.deploy.outputs.containerAppUrl </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">RESOURCE_GROUP</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> rg</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">my</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">convent</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">REGISTRY</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> ghcr.io</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token key atrule">jobs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">build</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">runs-on</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">latest</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">permissions</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">contents</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> read</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">packages</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> write</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">outputs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">image-name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> steps.vars.outputs.image_name </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">sha-short</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> steps.vars.outputs.sha_short </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">built-at</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> steps.vars.outputs.built_at </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Checkout repository</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> actions/checkout@v4</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">ref</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> inputs.branchName </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Set sha</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">short and image</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">name environment variables</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> vars</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">run</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token scalar string" style="color:rgb(165, 255, 144)"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">          image_name=$(echo "${{ env.REGISTRY }}/${{ github.repository }}/node-service" | tr '[:upper:]' '[:lower:]')</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">          echo "image_name=$image_name" >> $GITHUB_OUTPUT</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">          sha_short=$(echo "$(git rev-parse --short HEAD)" | tr '[:upper:]' '[:lower:]')</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">          echo "sha_short=$sha_short" >> $GITHUB_OUTPUT</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">          echo "built_at=$(date +'%Y-%m-%dT%H:%M:%S')" >> $GITHUB_OUTPUT</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># Login against a Docker registry</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># https://github.com/docker/login-action</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Log into registry $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> env.REGISTRY </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> docker/login</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">action@v3</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">registry</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> env.REGISTRY </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">username</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> github.actor </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">password</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> secrets.GITHUB_TOKEN </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># Extract metadata (tags, labels) for Docker</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># https://github.com/docker/metadata-action</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Extract Docker metadata</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> meta</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> docker/metadata</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">action@v5</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">images</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> steps.vars.outputs.image_name </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">context</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> git </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># so it uses the git branch that is checked out</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">tags</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token scalar string" style="color:rgb(165, 255, 144)"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            type=semver,pattern={{version}}</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            type=semver,pattern={{major}}.{{minor}}</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            type=semver,pattern={{major}}</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            type=ref,event=branch</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            type=ref,event=pr</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            type=sha</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># Build and push Docker image with Buildx (don't push if deploy is false)</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># https://github.com/docker/build-push-action</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Build and push Docker image</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> docker/build</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">push</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">action@v6</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">context</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> ./</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">push</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> inputs.deploy </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">tags</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> steps.meta.outputs.tags </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> steps.meta.outputs.labels </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">build-args</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token scalar string" style="color:rgb(165, 255, 144)"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            VITE_BRANCH_NAME=${{ inputs.branchName }}</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            VITE_GIT_SHA=${{ steps.vars.outputs.sha_short }}</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            VITE_BUILT_AT=${{ steps.vars.outputs.built_at }}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">deploy</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">runs-on</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">latest</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> inputs.deploy == true</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">needs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> build</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">outputs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">containerAppUrl</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> steps.deploy.outputs.CONTAINER_APP_URL </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">permissions</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">id-token</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> write</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">contents</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> read</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">packages</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> write</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Checkout repository</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> actions/checkout@v4</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">ref</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> inputs.branchName </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Azure login</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> azure/login@v2</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">client-id</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> secrets.AZURE_CLIENT_ID </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">tenant-id</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> secrets.AZURE_TENANT_ID </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">subscription-id</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> secrets.AZURE_SUBSCRIPTION_ID </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Deploy to Azure</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> deploy</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> azure/CLI@v2</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token scalar string" style="color:rgb(165, 255, 144)"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            RESOURCE_GROUP="${{ env.RESOURCE_GROUP }}"</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            BUILT_AT="${{ needs.build.outputs.built-at }}"</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            BRANCH_NAME="${{ inputs.branchName }}"</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            SHA_SHORT="${{ needs.build.outputs.sha-short }}"</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            REF_SHA="${{ inputs.branchName }}.${{ needs.build.outputs.sha-short }}"</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            DEPLOYMENT_NAME="${REF_SHA////-}"</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">            echo "DEPLOYMENT_NAME=$DEPLOYMENT_NAME"</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            webServiceImage="$</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> needs.build.outputs.image</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">name </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain">sha</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">$SHA_SHORT"</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            echo "webServiceImage=$webServiceImage"</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            if </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain"> "$BRANCH_NAME" == "main" </span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain">; then</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              webServiceContainerAppName="main</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">web"</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            else</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              webServiceContainerAppName="preview</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">web"</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            fi</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            echo "webServiceContainerAppName=$webServiceContainerAppName"</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            TAGS='</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain">"owner"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token string" style="color:rgb(165, 255, 144)">"johnnyreilly"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> "email"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token string" style="color:rgb(165, 255, 144)">"johnny_reilly@hotmail.com"</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain">'</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            az deployment group create \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">resource</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">group $RESOURCE_GROUP \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">name "$DEPLOYMENT_NAME" \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">template</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">file ./infra/main.bicep \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">parameters \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                  webServiceImage="$webServiceImage" \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                  containerRegistry=$</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> env.REGISTRY </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                  containerRegistryUsername=$</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> github.actor </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                  containerRegistryPassword=$</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> secrets.PACKAGES_TOKEN </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"> \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                  branchName="$BRANCH_NAME" \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                  gitSha="$SHA_SHORT" \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                  builtAt="$BUILT_AT" \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                  workspaceName='shared</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">log</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">analytics' \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                  appInsightsName='shared</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">app</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">insights' \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                  managedEnvironmentName='shared</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">env' \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                  webServiceContainerAppName="$webServiceContainerAppName" \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                  tags="$TAGS" \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                  APPSETTINGS_API_KEY="$</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> secrets.APPSETTINGS_API_KEY </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain">" \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                  APPSETTINGS_DOMAIN="$</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> vars.APPSETTINGS_DOMAIN </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain">" \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                  APPSETTINGS_PRAYER_REQUEST_FROM_EMAIL="$</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> vars.APPSETTINGS_PRAYER_REQUEST_FROM_EMAIL </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain">" \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">                  APPSETTINGS_PRAYER_REQUEST_RECIPIENT_EMAIL="$</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> vars.APPSETTINGS_PRAYER_REQUEST_RECIPIENT_EMAIL </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain">"</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            CONTAINER_APP_URL=$(az containerapp show \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">resource</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">group "$RESOURCE_GROUP" \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">name "$webServiceContainerAppName" \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">query properties.configuration.ingress.fqdn \</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">              </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">output tsv)</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            echo "CONTAINER_APP_URL=$CONTAINER_APP_URL"</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">            echo "CONTAINER_APP_URL=$CONTAINER_APP_URL" </span><span class="token punctuation" style="color:rgb(255, 255, 255)">></span><span class="token punctuation" style="color:rgb(255, 255, 255)">></span><span class="token plain"> $GITHUB_OUTPUT</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Let's talk through what this workflow does:</p>
<ul>
<li>It's triggered by a <code>workflow_call</code> event, which is how reusable workflows are triggered.</li>
<li>It has two jobs: <code>build</code> and <code>deploy</code> and the <code>deploy</code> job is only run if the <code>deploy</code> input is <code>true</code>. (This allows us to call the workflow with <code>deploy: false</code> to only build the image)</li>
<li>The <code>build</code> job checks out the code, sets some environment variables, logs into the Docker registry, extracts metadata for Docker, builds and pushes the Docker image.</li>
<li>The <code>deploy</code> job checks out the code, logs into Azure, and deploys the container app to Azure Container Apps. It then outputs the URL of the deployed container app in order that we can display it to the user.</li>
</ul>
<p>Now most of this workflow is the same as the one I was originally using to deploy to the main environment. The key difference is it is now parameterised with the <code>branchName</code> input. This is important for two reasons:</p>
<ol>
<li>It allows us to deploy to different environments based on the branch name. In our case we'll deploy to the <code>preview-web</code> container app if the branch name is not <code>main</code>. Otherwise we'll deploy to <code>main-web</code>.</li>
<li>(and this is more subtle) We need to checkout the relevant branch of the repository in our workflow, so that we're building and deploying the correct thing. So you'll see us use the <code>branchName</code> input in the <code>actions/checkout</code> steps and you'll see us use <code>context: git</code> in the <code>docker/metadata-action</code> step.</li>
</ol>
<p>You might be thinking at this point, "fine - but I don't have a containerised application and I don't have an Azure Container Apps service to deploy to". That's great! You can adapt this workflow to build any type of app you would like and deploy to any type of service. The crucial part is that you must build and deploy the code for the correct branch. This is why we pass the <code>branchName</code> input to the workflow.</p>
<p>And now some bad news: the <code>issue_comment</code> event <strong>doesn't</strong> know the branch that the pull request is for. We're going to need to build <em>another</em> reusable workflow that we will use to determine the branch name of the pull request.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=getting-the-branch-name-of-the-pull-request>Getting the branch name of the pull request<a href=#getting-the-branch-name-of-the-pull-request class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>Now we're old hands at creating reusable workflows, we're going to create another one that will determine the branch name of the pull request. We'll call this workflow <code>util-get-pr-branch-name.yaml</code>:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Get PR branch name</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token key atrule">on</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">workflow_call</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">pullRequestNumber</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">required</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 98, 140)">true</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> number</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">outputs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">branchName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">description</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(165, 255, 144)">'The source branch name for the pull request'</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> jobs.get</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">pr</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">branch</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">name.outputs.branchName </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token key atrule">jobs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">get-pr-branch-name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">runs-on</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">latest</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">outputs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">branchName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> steps.get</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">pr</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">branch</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">name.outputs.branchName </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> get</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">pr</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">branch</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">name</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">run</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token scalar string" style="color:rgb(165, 255, 144)"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">          branchName=$(gh pr view ${{ inputs.pullRequestNumber }} --json "headRefName" --jq ".headRefName" --repo ${{ github.repository }})</span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">          echo "branchName=$branchName" >> $GITHUB_OUTPUT</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">GH_TOKEN</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> github.token </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>This is fairly self explanatory. The workflow takes a <code>pullRequestNumber</code> input and outputs the <code>branchName</code> of the pull request. It uses the <code>gh</code> CLI to get the branch name of the pull request using the <code>headRefName</code> property of a pull request. (Incidentally, the <code>env: GH_TOKEN: ${{ github.token }}</code> line is important as it allows the workflow to authenticate with GitHub.)</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=putting-it-all-together>Putting it all together<a href=#putting-it-all-together class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>Now we have our two reusable workflows, we can put them together in a workflow that is triggered by the <code>issue_comment</code> event. This workflow will call the <code>util-get-pr-branch-name.yaml</code> workflow to get the branch name of the pull request, and then call the <code>util-build-and-deploy.yaml</code> workflow to build and deploy the code for that branch. Here's the <code>pull-request-commands.yaml</code> workflow:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9EFEFF;--prism-background-color:#2D2A55><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#9EFEFF;background-color:#2D2A55><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9EFEFF><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> Pull request commands</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token key atrule">on</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">issue_comment</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">types</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">created</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain"></span><span class="token key atrule">jobs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">get-pr-branch-name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> ./.github/workflows/util</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">pr</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">branch</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">name.yaml</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">pullRequestNumber</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> github.event.issue.number </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">pre-deploy</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># check if the comment comes from a pull request and contains the command `/deploy`</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> github.event.issue.pull_request </span><span class="token important">&&</span><span class="token plain"> contains(github.event.comment.body</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> '/deploy')</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">runs-on</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">latest</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">run</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token scalar string" style="color:rgb(165, 255, 144)"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">          gh issue comment ${{ github.event.issue.number }} --body "Preview environment [deploying](https://github.com/johnnyreilly/poorclaresarundel-aca/actions/runs/${{ github.run_id }})..." --repo ${{ github.repository }}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">GH_TOKEN</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> secrets.GITHUB_TOKEN </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">deploy</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token comment" style="color:rgb(179, 98, 255);font-style:italic"># check if the comment comes from a pull request and contains the command `/deploy`</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> github.event.issue.pull_request </span><span class="token important">&&</span><span class="token plain"> contains(github.event.comment.body</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> '/deploy')</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">needs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">[</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">pr</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">branch</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(255, 255, 255)">,</span><span class="token plain"> pre</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">deploy</span><span class="token punctuation" style="color:rgb(255, 255, 255)">]</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> ./.github/workflows/util</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">build</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">and</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">deploy.yaml</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">deploy</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 98, 140)">true</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token key atrule">branchName</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> needs.get</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">pr</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">branch</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">name.outputs.branchName </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">secrets</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> inherit</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">  </span><span class="token key atrule">post-deploy</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">runs-on</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain">latest</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">needs</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> deploy</span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">      </span><span class="token punctuation" style="color:rgb(255, 255, 255)">-</span><span class="token plain"> </span><span class="token key atrule">run</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(255, 255, 255)">|</span><span class="token scalar string" style="color:rgb(165, 255, 144)"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token scalar string" style="color:rgb(165, 255, 144)">          gh issue comment ${{ github.event.issue.number }} --body "Preview environment deployed: https://${{ needs.deploy.outputs.containerAppUrl }}" --repo ${{ github.repository }}</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">        </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#9EFEFF><span class="token plain">          </span><span class="token key atrule">GH_TOKEN</span><span class="token punctuation" style="color:rgb(255, 255, 255)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token punctuation" style="color:rgb(255, 255, 255)">{</span><span class="token plain"> secrets.GITHUB_TOKEN </span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><span class="token punctuation" style="color:rgb(255, 255, 255)">}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>What you're hopefully gleaning from the above is that we have 4 jobs in this workflow:</p>
<ul>
<li><code>get-pr-branch-name</code> - this job calls the <code>util-get-pr-branch-name.yaml</code> workflow to get the branch name of the pull request. Note that we pass the <code>github.event.issue.number</code> as the <code>pullRequestNumber</code> input.</li>
<li><code>pre-deploy</code> - this job runs immediately to post a comment in the pull request to let the user know that the preview environment is being deployed. (Again using the GitHub CLI.) The comment gives the user feedback that the command has been received and is being actioned. Based upon my experience, this response will show up in the pull request 5-10 seconds after the <code>/deploy</code> command is entered. Not as fast as I'd like, but reasonable. For bonus points, I've chosen to include a link to the GitHub Actions run that is deploying the preview environment. This is useful as it allows the user to see the progress of the deployment.</li>
<li><code>deploy</code> - this job calls the <code>util-build-and-deploy.yaml</code> workflow to build and deploy the code for the branch. Note that we pass the <code>branchName</code> input to the workflow using the <code>get-pr-branch-name.outputs.branchName</code> output. Note also that we're passing <code>deploy: true</code> to the workflow to ensure that the code is deployed, and that we're inheriting the secrets from the parent workflow. This is important as it allows the child workflow to access the secrets it needs to deploy the code.</li>
<li><code>post-deploy</code> - this job posts a comment in the pull request to let the user know that the preview environment has been deployed and where they can find it.</li>
</ul>
<p>Or maybe I should have said it better as a screenshot:</p>
<p><img decoding=async loading=lazy alt="screenshot of pull request comments" src=/assets/images/screenshot-pull-request-comments-39dd71778a3039bc342d6349667fd81c.webp width=440 height=501 class=img_ev3q></p>
<p>Yup! That's the same screenshot as before. I'm just showing it again to remind you that this is what we've built.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=writing-other-slash-commands>Writing other slash commands<a href=#writing-other-slash-commands class=hash-link aria-label="Direct link to heading" title="Direct link to heading">​</a></h2>
<p>We've written a slash command for deployment in this post, but you could write a slash command for anything you like. The key is to use the <code>issue_comment</code> event to trigger the workflow, and to check the comment body for the command you're interested in. You could pass more information in the comment body than just the slash command. For example, you could pass the name of the environment you want to deploy to, or the version of the app you want to deploy. You could even pass multiple commands in a single comment. The world is your oyster!</p>
<p>You can then call other workflows to do the heavy lifting for you, remembering to pass in any inputs that are needed.</p>
<p>If you would like to see the repo where this was implemented, <a href=https://github.com/johnnyreilly/poorclaresarundel-aca/tree/f052dd2f5d55bcec8547624e928bbf90432f3872 target=_blank rel="noopener noreferrer">look here</a>.</div><footer class=docusaurus-mt-lg><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class=col><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class=tag_QGVx><a title="The GitHub Actions CI / CD service." class="tag_zVej tagRegular_sFm0" href=/tags/github-actions>GitHub Actions</a><li class=tag_QGVx><a title="The Azure Container Apps service. Effectively a managed Kubernetes service." class="tag_zVej tagRegular_sFm0" href=/tags/azure-container-apps>Azure Container Apps</a></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class=col><a href=https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2025-01-02-slash-command-your-deployment-with-github-actions/index.md target=_blank rel="noopener noreferrer" class=theme-edit-this-page><svg fill=currentColor height=20 width=20 viewBox="0 0 40 40" class=iconEdit_Z9Sw aria-hidden=true><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"/></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href=/get-service-connections-with-azure-devops-api><div class=pagination-nav__sublabel>Newer Post</div><div class=pagination-nav__label>Get Service Connections with the Azure DevOps API (REST and TypeScript)</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/smuggling-gitignore-npmrc-in-npm-packages><div class=pagination-nav__sublabel>Older Post</div><div class=pagination-nav__label>Smuggling .gitignore, .npmrc and friends in npm packages</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#first-a-bit-about-nuns class="table-of-contents__link toc-highlight">First a bit about nuns</a><li><a href=#the-github-actions-workflow class="table-of-contents__link toc-highlight">The GitHub Actions workflow</a><li><a href=#avoiding-duplication-with-a-reusable-workflow class="table-of-contents__link toc-highlight">Avoiding duplication with a reusable workflow</a><li><a href=#getting-the-branch-name-of-the-pull-request class="table-of-contents__link toc-highlight">Getting the branch name of the pull request</a><li><a href=#putting-it-all-together class="table-of-contents__link toc-highlight">Putting it all together</a><li><a href=#writing-other-slash-commands class="table-of-contents__link toc-highlight">Writing other slash commands</a></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class=footer__title></div><ul class="footer__items clean-list"><li class=footer__item><div class=footer__title><a href=/tags/typescript class=footer__link-item>TypeScript<img src=/img/ts-logo-128.svg alt="TypeScript icon" class=footer__icon></a></div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=/typescript-vs-jsdoc-javascript class=footer__link-item>TypeScript vs JSDoc JavaScript</a><li class=footer__item><a href=/type-annotations-strong-types-weakly-held class=footer__link-item>Type annotations proposal: strong types, weakly held</a></li>
</ul><div class=footer__title><a href=/tags/azure class=footer__link-item>Azure<img src=/img/azure-logo.svg alt="Azure icon" class=footer__icon></a></div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=/azure-container-apps-easy-auth-and-dotnet-authentication class=footer__link-item>Azure Container Apps: Easy Auth and .NET</a><li class=footer__item><a href=/introducing-azdo-npm-auth class=footer__link-item>Introducing azdo-npm-auth (Azure DevOps npm auth)</a><li class=footer__item><a href=/npx-and-azure-artifacts-the-secret-cli-delivery-mechanism class=footer__link-item>npx and Azure Artifacts: the secret CLI delivery mechanism</a><li class=footer__item><a href=/azure-static-web-apps-dynamic-redirects-azure-functions class=footer__link-item>Azure Static Web Apps: dynamic redirects with Azure Functions</a></li>
</ul><div class=footer__title><a href=/tags/asp-net class=footer__link-item>ASP.NET<img src=/img/dotnet-logo.svg alt="ASP.NET icon" class=footer__icon></a></div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=/eslint-your-csharp-in-vs-code-with-roslyn-analyzers class=footer__link-item>ESLint your C# with Roslyn Analyzers</a><li class=footer__item><a href=/aspnet-serilog-and-application-insights class=footer__link-item>ASP.NET, Serilog and Application Insights</a></li>
</ul><div class=footer__title><a href=/tags/react class=footer__link-item>React<img src=/img/react-logo.svg alt="React icon" class=footer__icon></a></div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=/structured-data-seo-and-react class=footer__link-item>Structured data and React</a><li class=footer__item><a href=/react-usesearchparamsstate class=footer__link-item>React: storing state in URL with URLSearchParams</a></li>
</ul></ul></div><div class="col footer__col"><div class=footer__title></div><ul class="footer__items clean-list"><li class=footer__item><div class=footer__title>Notable articles</div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=/definitely-typed-the-movie class=footer__link-item>The history of Definitely Typed<img src=/img/definitely-typed-logo.png alt="The history of Definitely Typed icon" class=footer__icon></a><li class=footer__item><a href=/typescript-documentary class=footer__link-item>TypeScript: the documentary<img src=/img/ts-logo-128.svg alt="TypeScript: the documentary icon" class=footer__icon></a><li class=footer__item><a href=/how-we-fixed-my-seo class=footer__link-item>How we fixed my SEO</a></li>
</ul><div class=footer__title>Popular articles</div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=/aspnet-serilog-and-application-insights class=footer__link-item>ASP.NET, Serilog and Application Insights</a><li class=footer__item><a href=/eslint-your-csharp-in-vs-code-with-roslyn-analyzers class=footer__link-item>ESLint your C# with Roslyn Analyzers</a><li class=footer__item><a href=/prettier-your-csharp-with-dotnet-format-and-lint-staged class=footer__link-item>dotnet-format: Prettier your C# with lint-staged & husky</a></li>
</ul><div class=footer__title>Recently updated</div>
<ul class="footer__items clean-list">
  <li class=footer__item><a href=azure-container-apps-easy-auth-and-dotnet-authentication class=footer__link-item>Azure Container Apps, Easy Auth and .NET authentication</a><li class=footer__item><a href=list-pipelines-with-azure-devops-api class=footer__link-item>List Pipelines with the Azure DevOps API</a><li class=footer__item><a href=create-pipeline-with-azure-devops-api class=footer__link-item>Create a Pipeline with the Azure DevOps API</a></li>
</ul></ul></div><div class="col footer__col"><div class=footer__title>Learn more / support me</div><ul class="footer__items clean-list"><li class=footer__item><a class=footer__link-item href=/about>About me</a><li class=footer__item><a href=https://github.com/johnnyreilly/blog.johnnyreilly.com target=_blank rel="noopener noreferrer" class=footer__link-item>Blog source code on GitHub<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a class=footer__link-item href=/tags>Blog categories</a><li class=footer__item><a href=https://johnnyreilly.com/rss.xml target=_blank rel="noopener noreferrer" class=footer__link-item>RSS feed<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://johnnyreilly.com/atom.xml target=_blank rel="noopener noreferrer" class=footer__link-item>Atom feed<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a class=footer__link-item href=/privacy-policy>Privacy Policy</a><li class=footer__item><iframe src=https://github.com/sponsors/johnnyreilly/card title="Sponsor johnnyreilly" style="margin-top: 20px; border: 0; border-radius: 10px; background-color: white; min-height: 400px;"></iframe><li class=footer__item><a href=https://www.buymeacoffee.com/qUBm0Wh rel=noopener target=_blank><img src=https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png loading=lazy alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></ul></div></div><div class="footer__bottom text--center"><div class=footer__copyright>Copyright © 2012 - 2025 John Reilly. Built with Docusaurus.</div></div></div></footer></div>